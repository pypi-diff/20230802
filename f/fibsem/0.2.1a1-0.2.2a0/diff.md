# Comparing `tmp/fibsem-0.2.1a1-py3-none-any.whl.zip` & `tmp/fibsem-0.2.2a0-py3-none-any.whl.zip`

## zipinfo {}

```diff
@@ -1,125 +1,137 @@
-Zip file size: 8341439 bytes, number of entries: 123
+Zip file size: 8371165 bytes, number of entries: 135
 -rw-rw-r--  2.0 unx      152 b- defN 23-Jul-12 07:29 fibsem/__init__.py
 -rw-rw-r--  2.0 unx      215 b- defN 23-Jul-11 07:50 fibsem/_version.py
--rw-rw-r--  2.0 unx    10798 b- defN 23-Jul-12 07:29 fibsem/acquire.py
--rw-rw-r--  2.0 unx    14403 b- defN 23-Jul-12 07:29 fibsem/alignment.py
+-rw-rw-r--  2.0 unx    11260 b- defN 23-Aug-02 08:01 fibsem/acquire.py
+-rw-rw-r--  2.0 unx    16474 b- defN 23-Aug-02 08:01 fibsem/alignment.py
+-rw-rw-r--  2.0 unx    15034 b- defN 23-Aug-02 08:01 fibsem/alignment2.py
 -rw-rw-r--  2.0 unx     8460 b- defN 23-Jul-12 07:29 fibsem/calibration.py
--rw-rw-r--  2.0 unx     2499 b- defN 23-Jul-12 07:29 fibsem/config.py
+-rw-rw-r--  2.0 unx     3102 b- defN 23-Aug-02 08:01 fibsem/config.py
 -rw-rw-r--  2.0 unx      532 b- defN 23-May-18 06:20 fibsem/constants.py
 -rw-rw-r--  2.0 unx     4745 b- defN 23-Jul-12 07:29 fibsem/conversions.py
--rw-rw-r--  2.0 unx     1758 b- defN 23-Jul-12 07:29 fibsem/gis.py
--rw-rw-r--  2.0 unx   206417 b- defN 23-Jul-12 07:29 fibsem/microscope.py
+-rw-rw-r--  2.0 unx     7376 b- defN 23-Aug-02 08:01 fibsem/funky tescan error when reading beam current.txt
+-rw-rw-r--  2.0 unx     2303 b- defN 23-Aug-02 08:01 fibsem/gis.py
+-rw-rw-r--  2.0 unx   218023 b- defN 23-Aug-02 08:01 fibsem/microscope.py
 -rw-rw-r--  2.0 unx    20788 b- defN 23-Jul-12 07:29 fibsem/milling.py
--rw-rw-r--  2.0 unx     6371 b- defN 23-May-18 06:20 fibsem/movement.py
+-rw-rw-r--  2.0 unx     2327 b- defN 23-Aug-02 08:01 fibsem/movement.py
 -rw-rw-r--  2.0 unx      251 b- defN 23-Jul-12 07:38 fibsem/napari.yaml
--rw-rw-r--  2.0 unx    30440 b- defN 23-Jul-12 07:29 fibsem/patterning.py
--rw-rw-r--  2.0 unx    81645 b- defN 23-Jul-12 07:29 fibsem/structures.py
--rw-rw-r--  2.0 unx     2165 b- defN 23-Jul-12 07:29 fibsem/testing.ipynb
--rw-rw-r--  2.0 unx    10790 b- defN 23-Jul-12 07:29 fibsem/utils.py
+-rw-rw-r--  2.0 unx    31600 b- defN 23-Aug-02 08:01 fibsem/patterning.py
+-rw-rw-r--  2.0 unx    81745 b- defN 23-Aug-02 08:01 fibsem/structures.py
+-rw-rw-r--  2.0 unx     5278 b- defN 23-Aug-02 08:01 fibsem/testing.ipynb
+-rw-rw-r--  2.0 unx     9865 b- defN 23-Aug-02 08:01 fibsem/utils.py
 -rw-rw-r--  2.0 unx    10545 b- defN 23-May-18 06:20 fibsem/validation.py
 -rw-rw-r--  2.0 unx       51 b- defN 23-Jul-12 07:29 fibsem/chat/.gitignore
 -rw-rw-r--  2.0 unx     1498 b- defN 23-Jul-12 07:29 fibsem/chat/main.py
 -rw-rw-r--  2.0 unx       75 b- defN 23-Jul-12 07:29 fibsem/chat/requirements.txt
 -rw-rw-r--  2.0 unx      693 b- defN 23-Jul-12 07:29 fibsem/config/deposition.dbp
--rw-rw-r--  2.0 unx      625 b- defN 23-Jul-12 07:29 fibsem/config/model.yaml
--rw-rw-r--  2.0 unx     1759 b- defN 23-Jul-12 07:29 fibsem/config/protocol.yaml
--rw-rw-r--  2.0 unx     1060 b- defN 23-Jul-12 07:29 fibsem/config/system.yaml
+-rw-rw-r--  2.0 unx      627 b- defN 23-Aug-02 08:01 fibsem/config/model.yaml
+-rw-rw-r--  2.0 unx      768 b- defN 23-Aug-02 08:01 fibsem/config/positions.yaml
+-rw-rw-r--  2.0 unx     2011 b- defN 23-Aug-02 08:01 fibsem/config/protocol.yaml
+-rw-rw-r--  2.0 unx     1887 b- defN 23-Aug-02 08:01 fibsem/config/system.yaml
 -rw-rw-r--  2.0 unx        0 b- defN 22-Oct-17 09:21 fibsem/detection/__init__.py
 -rw-rw-r--  2.0 unx     3466 b- defN 23-May-18 06:20 fibsem/detection/app.py
 -rw-rw-r--  2.0 unx     3599 b- defN 23-Jul-12 07:29 fibsem/detection/app2.py
--rw-rw-r--  2.0 unx    19410 b- defN 23-Jul-12 07:29 fibsem/detection/detection.py
+-rw-rw-r--  2.0 unx    21444 b- defN 23-Aug-02 08:01 fibsem/detection/detection.py
 -rw-rw-r--  2.0 unx     2842 b- defN 23-Jul-12 07:29 fibsem/detection/evaluation.py
 -rw-rw-r--  2.0 unx    32318 b- defN 23-Jul-12 07:29 fibsem/detection/evalulation.ipynb
 -rw-rw-r--  2.0 unx     2811 b- defN 23-May-18 06:20 fibsem/detection/grid_plot_summary.py
 -rw-rw-r--  2.0 unx     6846 b- defN 23-Jul-12 07:29 fibsem/detection/model_evaluation.py
 -rw-rw-r--  2.0 unx     9103 b- defN 23-Jul-12 07:29 fibsem/detection/notebook.ipynb
 -rw-rw-r--  2.0 unx  1573120 b- defN 23-May-18 06:20 fibsem/detection/test_image.tif
--rw-rw-r--  2.0 unx     7934 b- defN 23-Jul-12 07:29 fibsem/detection/utils.py
+-rw-rw-r--  2.0 unx     8015 b- defN 23-Aug-02 08:01 fibsem/detection/utils.py
 -rw-rw-r--  2.0 unx        0 b- defN 22-Oct-03 06:10 fibsem/imaging/.gitkeep
 -rw-rw-r--  2.0 unx        0 b- defN 22-Oct-03 06:10 fibsem/imaging/__init__.py
--rw-rw-r--  2.0 unx     6409 b- defN 23-May-18 06:20 fibsem/imaging/masks.py
+-rw-rw-r--  2.0 unx     8890 b- defN 23-Aug-02 08:01 fibsem/imaging/_tile.py
+-rw-rw-r--  2.0 unx     6991 b- defN 23-Aug-02 08:01 fibsem/imaging/masks.py
 -rw-rw-r--  2.0 unx     1865 b- defN 23-May-18 06:20 fibsem/imaging/utils.py
 -rw-rw-r--  2.0 unx      242 b- defN 23-Jul-12 07:29 fibsem/log/positions.yaml
 -rw-rw-r--  2.0 unx     7471 b- defN 22-Oct-27 03:53 fibsem/segmentation/README.md
 -rw-rw-r--  2.0 unx        0 b- defN 23-Jul-12 07:29 fibsem/segmentation/__init__.py
 -rw-rw-r--  2.0 unx      739 b- defN 23-Jul-12 07:29 fibsem/segmentation/config.py
--rw-rw-r--  2.0 unx      827 b- defN 23-Jul-12 07:29 fibsem/segmentation/config.yml
+-rw-rw-r--  2.0 unx      827 b- defN 23-Aug-02 08:01 fibsem/segmentation/config.yml
 -rw-rw-r--  2.0 unx     5149 b- defN 23-Jul-12 07:29 fibsem/segmentation/dataset.py
 -rw-rw-r--  2.0 unx    80125 b- defN 23-Jul-12 02:18 fibsem/segmentation/example.ipynb
 -rw-rw-r--  2.0 unx     3499 b- defN 22-Oct-27 03:27 fibsem/segmentation/inference.py
--rw-rw-r--  2.0 unx     3342 b- defN 23-Jul-12 07:29 fibsem/segmentation/model.py
+-rw-rw-r--  2.0 unx     3465 b- defN 23-Aug-02 08:01 fibsem/segmentation/model.py
+-rw-rw-r--  2.0 unx      137 b- defN 23-Aug-02 08:01 fibsem/segmentation/requirements.txt
 -rw-rw-r--  2.0 unx  1407827 b- defN 22-Oct-26 08:53 fibsem/segmentation/test_image.tif
--rw-rw-r--  2.0 unx     8647 b- defN 23-Jul-12 07:29 fibsem/segmentation/train.py
+-rw-rw-r--  2.0 unx     8647 b- defN 23-Jul-31 11:26 fibsem/segmentation/train.py
 -rw-rw-r--  2.0 unx    12984 b- defN 23-Jul-12 07:29 fibsem/segmentation/utils.py
 -rw-rw-r--  2.0 unx  2954372 b- defN 23-Jul-12 06:12 fibsem/segmentation/docs/example_napari.png
 -rw-rw-r--  2.0 unx  1270161 b- defN 23-Jul-12 06:12 fibsem/segmentation/docs/imgs/combined/combined.jpg
 -rw-rw-r--  2.0 unx  1572986 b- defN 23-Jul-12 06:12 fibsem/segmentation/docs/imgs/labelled/label.tif
 -rw-rw-r--  2.0 unx  1393274 b- defN 23-Jul-12 06:12 fibsem/segmentation/docs/imgs/raw/image.tif
 -rw-rw-r--  2.0 unx        0 b- defN 23-Jul-12 07:29 fibsem/segmentation/models/.gitkeep
 -rw-rw-r--  2.0 unx        0 b- defN 22-Oct-03 06:10 fibsem/ui/.gitkeep
 -rw-rw-r--  2.0 unx     7668 b- defN 23-Jul-12 07:29 fibsem/ui/FibsemAlignmentWidget.py
+-rw-rw-r--  2.0 unx     2393 b- defN 23-Aug-02 08:01 fibsem/ui/FibsemCryoSputterWidget.py
 -rw-rw-r--  2.0 unx     8935 b- defN 23-Jul-12 07:29 fibsem/ui/FibsemDetectionUI.py
 -rw-rw-r--  2.0 unx    18869 b- defN 23-Jul-12 07:29 fibsem/ui/FibsemDetectionWidget.py
--rw-rw-r--  2.0 unx     9723 b- defN 23-Jul-12 07:29 fibsem/ui/FibsemEmbeddedDetectionWidget.py
+-rw-rw-r--  2.0 unx     9019 b- defN 23-Aug-02 08:01 fibsem/ui/FibsemEmbeddedDetectionWidget.py
 -rw-rw-r--  2.0 unx    11085 b- defN 23-Jul-12 07:29 fibsem/ui/FibsemGISWidget.py
--rw-rw-r--  2.0 unx    22194 b- defN 23-Jul-12 07:29 fibsem/ui/FibsemImageSettingsWidget.py
+-rw-rw-r--  2.0 unx    22379 b- defN 23-Aug-02 08:01 fibsem/ui/FibsemImageSettingsWidget.py
 -rw-rw-r--  2.0 unx    16723 b- defN 23-Jul-12 07:29 fibsem/ui/FibsemLabellingUI.py
--rw-rw-r--  2.0 unx    12661 b- defN 23-Jul-12 07:29 fibsem/ui/FibsemManipulatorWidget.py
--rw-rw-r--  2.0 unx    27469 b- defN 23-Jul-12 07:29 fibsem/ui/FibsemMillingWidget.py
+-rw-rw-r--  2.0 unx    10012 b- defN 23-Aug-02 08:01 fibsem/ui/FibsemManipulatorWidget.py
+-rw-rw-r--  2.0 unx    30352 b- defN 23-Aug-02 08:01 fibsem/ui/FibsemMillingWidget.py
+-rw-rw-r--  2.0 unx    18658 b- defN 23-Aug-02 08:01 fibsem/ui/FibsemMinimapWidget.py
 -rw-rw-r--  2.0 unx     6498 b- defN 23-Jul-12 07:29 fibsem/ui/FibsemModelTrainingWidget.py
--rw-rw-r--  2.0 unx    12456 b- defN 23-Jul-12 07:29 fibsem/ui/FibsemMovementWidget.py
+-rw-rw-r--  2.0 unx    12941 b- defN 23-Aug-02 08:01 fibsem/ui/FibsemMovementWidget.py
 -rw-rw-r--  2.0 unx     2966 b- defN 23-May-18 06:20 fibsem/ui/FibsemMultiChemWidget.py
--rw-rw-r--  2.0 unx     6687 b- defN 23-Jul-12 07:29 fibsem/ui/FibsemPositionsWidget.py
+-rw-rw-r--  2.0 unx     6655 b- defN 23-Aug-02 08:01 fibsem/ui/FibsemPositionsWidget.py
 -rw-rw-r--  2.0 unx     4740 b- defN 23-Jul-12 07:29 fibsem/ui/FibsemSegmentationModelWidget.py
--rw-rw-r--  2.0 unx    16538 b- defN 23-Jul-12 07:29 fibsem/ui/FibsemSystemSetupWidget.py
--rw-rw-r--  2.0 unx     7354 b- defN 23-Jul-12 07:29 fibsem/ui/FibsemUI.py
+-rw-rw-r--  2.0 unx    22184 b- defN 23-Aug-02 08:01 fibsem/ui/FibsemSystemSetupWidget.py
+-rw-rw-r--  2.0 unx    12402 b- defN 23-Aug-02 08:01 fibsem/ui/FibsemUI.py
 -rw-rw-r--  2.0 unx        0 b- defN 22-Oct-03 06:10 fibsem/ui/__init__.py
--rw-rw-r--  2.0 unx    23860 b- defN 23-Jul-12 07:29 fibsem/ui/utils.py
+-rw-rw-r--  2.0 unx    24590 b- defN 23-Aug-02 08:01 fibsem/ui/utils.py
 -rw-rw-r--  2.0 unx     5557 b- defN 23-Jul-12 07:29 fibsem/ui/windows.py
 -rw-rw-r--  2.0 unx     3662 b- defN 23-Jul-12 07:29 fibsem/ui/qtdesigner_files/CurrentAlignmentWidget.py
 -rw-rw-r--  2.0 unx     2754 b- defN 23-Jul-12 07:29 fibsem/ui/qtdesigner_files/CurrentAlignmentWidget.ui
+-rw-rw-r--  2.0 unx     6533 b- defN 23-Aug-02 08:01 fibsem/ui/qtdesigner_files/FibsemCryoSputterWidget.py
+-rw-rw-r--  2.0 unx     4445 b- defN 23-Aug-02 08:01 fibsem/ui/qtdesigner_files/FibsemCryoSputterWidget.ui
 -rw-rw-r--  2.0 unx     9828 b- defN 23-May-18 06:20 fibsem/ui/qtdesigner_files/FibsemDetectionWidget.py
 -rw-rw-r--  2.0 unx     7395 b- defN 23-May-18 06:20 fibsem/ui/qtdesigner_files/FibsemDetectionWidget.ui
 -rw-rw-r--  2.0 unx     2456 b- defN 23-Jul-12 07:29 fibsem/ui/qtdesigner_files/FibsemEmbeddedDetectionWidget.py
 -rw-rw-r--  2.0 unx     2059 b- defN 23-Jul-12 07:29 fibsem/ui/qtdesigner_files/FibsemEmbeddedDetectionWidget.ui
 -rw-rw-r--  2.0 unx     6894 b- defN 23-Jul-12 07:29 fibsem/ui/qtdesigner_files/FibsemGISWidget.py
 -rw-rw-r--  2.0 unx     4994 b- defN 23-Jul-12 07:29 fibsem/ui/qtdesigner_files/FibsemGISWidget.ui
 -rw-rw-r--  2.0 unx     7609 b- defN 23-Jul-12 07:29 fibsem/ui/qtdesigner_files/FibsemLabellingUI.py
 -rw-rw-r--  2.0 unx     6324 b- defN 23-Jul-12 07:29 fibsem/ui/qtdesigner_files/FibsemLabellingUI.ui
 -rw-rw-r--  2.0 unx     6614 b- defN 23-Jul-12 07:29 fibsem/ui/qtdesigner_files/FibsemManipulatorWidget.py
 -rw-rw-r--  2.0 unx     5199 b- defN 23-Jul-12 07:29 fibsem/ui/qtdesigner_files/FibsemManipulatorWidget.ui
--rw-rw-r--  2.0 unx    12839 b- defN 23-Jul-12 07:29 fibsem/ui/qtdesigner_files/FibsemMillingWidget.py
--rw-rw-r--  2.0 unx    10675 b- defN 23-Jul-12 07:29 fibsem/ui/qtdesigner_files/FibsemMillingWidgetui.ui
+-rw-rw-r--  2.0 unx    13038 b- defN 23-Aug-02 08:01 fibsem/ui/qtdesigner_files/FibsemMillingWidget.py
+-rw-rw-r--  2.0 unx    11041 b- defN 23-Aug-02 08:01 fibsem/ui/qtdesigner_files/FibsemMillingWidget.ui
+-rw-rw-r--  2.0 unx    11723 b- defN 23-Aug-02 08:01 fibsem/ui/qtdesigner_files/FibsemMillingWidgetui.ui
+-rw-rw-r--  2.0 unx    17053 b- defN 23-Aug-02 08:01 fibsem/ui/qtdesigner_files/FibsemMinimapWidget.py
+-rw-rw-r--  2.0 unx    13488 b- defN 23-Aug-02 08:01 fibsem/ui/qtdesigner_files/FibsemMinimapWidget.ui
 -rw-rw-r--  2.0 unx     2735 b- defN 23-Jul-12 07:29 fibsem/ui/qtdesigner_files/FibsemModelTrainingWidge.ui
 -rw-rw-r--  2.0 unx    10117 b- defN 23-Jul-12 07:29 fibsem/ui/qtdesigner_files/FibsemModelTrainingWidget.py
 -rw-rw-r--  2.0 unx     7724 b- defN 23-Jul-12 07:29 fibsem/ui/qtdesigner_files/FibsemModelTrainingWidget.ui
--rw-rw-r--  2.0 unx    14652 b- defN 23-Jul-12 07:29 fibsem/ui/qtdesigner_files/FibsemMovementWidget.py
--rw-rw-r--  2.0 unx    11959 b- defN 23-Jul-12 07:29 fibsem/ui/qtdesigner_files/FibsemMovementWidget.ui
+-rw-rw-r--  2.0 unx    14356 b- defN 23-Aug-02 08:01 fibsem/ui/qtdesigner_files/FibsemMovementWidget.py
+-rw-rw-r--  2.0 unx    11562 b- defN 23-Aug-02 08:01 fibsem/ui/qtdesigner_files/FibsemMovementWidget.ui
 -rw-rw-r--  2.0 unx     4643 b- defN 23-May-18 06:20 fibsem/ui/qtdesigner_files/FibsemMultiChemWidget.py
 -rw-rw-r--  2.0 unx     3106 b- defN 23-May-18 06:20 fibsem/ui/qtdesigner_files/FibsemMultiChemWidget.ui
 -rw-rw-r--  2.0 unx     4112 b- defN 23-Jul-12 07:29 fibsem/ui/qtdesigner_files/FibsemPositionsWidget.py
 -rw-rw-r--  2.0 unx     2864 b- defN 23-Jul-12 07:29 fibsem/ui/qtdesigner_files/FibsemPositionsWidget.ui
 -rw-rw-r--  2.0 unx     3786 b- defN 23-Jul-12 07:29 fibsem/ui/qtdesigner_files/FibsemSegmentationModelWidget.py
 -rw-rw-r--  2.0 unx     2607 b- defN 23-Jul-12 07:29 fibsem/ui/qtdesigner_files/FibsemSegmentationModelWidget.ui
 -rw-rw-r--  2.0 unx    19849 b- defN 23-May-18 06:20 fibsem/ui/qtdesigner_files/FibsemSettingUI.py
 -rw-rw-r--  2.0 unx    20812 b- defN 22-Oct-24 08:22 fibsem/ui/qtdesigner_files/FibsemSettings.py
 -rw-rw-r--  2.0 unx    14089 b- defN 23-May-18 06:20 fibsem/ui/qtdesigner_files/FibsemSettingsUI.ui
--rw-rw-r--  2.0 unx    36924 b- defN 23-Jul-12 07:29 fibsem/ui/qtdesigner_files/FibsemSystemSetupWidget.py
--rw-rw-r--  2.0 unx    35560 b- defN 23-Jul-12 07:29 fibsem/ui/qtdesigner_files/FibsemSystemSetupWidget.ui
--rw-rw-r--  2.0 unx     3278 b- defN 23-Jul-12 07:29 fibsem/ui/qtdesigner_files/FibsemUI.py
--rw-rw-r--  2.0 unx     2449 b- defN 23-Jul-12 07:29 fibsem/ui/qtdesigner_files/FibsemUI.ui
--rw-rw-r--  2.0 unx    15548 b- defN 23-Jul-12 07:29 fibsem/ui/qtdesigner_files/ImageSettingsWidget.py
--rw-rw-r--  2.0 unx    12405 b- defN 23-Jul-12 07:29 fibsem/ui/qtdesigner_files/ImageSettingsWidget.ui
+-rw-rw-r--  2.0 unx    34942 b- defN 23-Aug-02 08:01 fibsem/ui/qtdesigner_files/FibsemSystemSetupWidget.py
+-rw-rw-r--  2.0 unx    33243 b- defN 23-Aug-02 08:01 fibsem/ui/qtdesigner_files/FibsemSystemSetupWidget.ui
+-rw-rw-r--  2.0 unx     3735 b- defN 23-Aug-02 08:01 fibsem/ui/qtdesigner_files/FibsemUI.py
+-rw-rw-r--  2.0 unx     2726 b- defN 23-Aug-02 08:01 fibsem/ui/qtdesigner_files/FibsemUI.ui
+-rw-rw-r--  2.0 unx    15602 b- defN 23-Aug-02 08:01 fibsem/ui/qtdesigner_files/ImageSettingsWidget.py
+-rw-rw-r--  2.0 unx    12482 b- defN 23-Aug-02 08:01 fibsem/ui/qtdesigner_files/ImageSettingsWidget.ui
 -rw-rw-r--  2.0 unx     5162 b- defN 22-Oct-17 09:21 fibsem/ui/qtdesigner_files/detection_dialog.py
 -rw-rw-r--  2.0 unx     5386 b- defN 22-Oct-17 09:21 fibsem/ui/qtdesigner_files/detection_dialog.ui
 -rw-rw-r--  2.0 unx     1059 b- defN 23-Jul-12 07:29 fibsem/ui/qtdesigner_files/needle_popup.py
 -rw-rw-r--  2.0 unx      615 b- defN 23-Jul-12 07:29 fibsem/ui/qtdesigner_files/needle_popup.ui
 -rw-rw-r--  2.0 unx     2058 b- defN 22-Oct-24 09:10 fibsem/ui/qtdesigner_files/user_dialog.py
 -rw-rw-r--  2.0 unx     2173 b- defN 22-Oct-24 09:09 fibsem/ui/qtdesigner_files/user_dialog.ui
--rw-rw-r--  2.0 unx     1067 b- defN 23-Jul-12 08:29 fibsem-0.2.1a1.dist-info/LICENSE
--rw-rw-r--  2.0 unx     8537 b- defN 23-Jul-12 08:29 fibsem-0.2.1a1.dist-info/METADATA
--rw-rw-r--  2.0 unx       92 b- defN 23-Jul-12 08:29 fibsem-0.2.1a1.dist-info/WHEEL
--rw-rw-r--  2.0 unx      156 b- defN 23-Jul-12 08:29 fibsem-0.2.1a1.dist-info/entry_points.txt
--rw-rw-r--  2.0 unx        7 b- defN 23-Jul-12 08:29 fibsem-0.2.1a1.dist-info/top_level.txt
--rw-rw-r--  2.0 unx    11268 b- defN 23-Jul-12 08:29 fibsem-0.2.1a1.dist-info/RECORD
-123 files, 11388187 bytes uncompressed, 8323469 bytes compressed:  26.9%
+-rw-rw-r--  2.0 unx     1067 b- defN 23-Aug-02 08:03 fibsem-0.2.2a0.dist-info/LICENSE
+-rw-rw-r--  2.0 unx     8537 b- defN 23-Aug-02 08:03 fibsem-0.2.2a0.dist-info/METADATA
+-rw-rw-r--  2.0 unx       92 b- defN 23-Aug-02 08:03 fibsem-0.2.2a0.dist-info/WHEEL
+-rw-rw-r--  2.0 unx      156 b- defN 23-Aug-02 08:03 fibsem-0.2.2a0.dist-info/entry_points.txt
+-rw-rw-r--  2.0 unx        7 b- defN 23-Aug-02 08:03 fibsem-0.2.2a0.dist-info/top_level.txt
+-rw-rw-r--  2.0 unx    12438 b- defN 23-Aug-02 08:03 fibsem-0.2.2a0.dist-info/RECORD
+135 files, 11522477 bytes uncompressed, 8351317 bytes compressed:  27.5%
```

## zipnote {}

```diff
@@ -6,26 +6,32 @@
 
 Filename: fibsem/acquire.py
 Comment: 
 
 Filename: fibsem/alignment.py
 Comment: 
 
+Filename: fibsem/alignment2.py
+Comment: 
+
 Filename: fibsem/calibration.py
 Comment: 
 
 Filename: fibsem/config.py
 Comment: 
 
 Filename: fibsem/constants.py
 Comment: 
 
 Filename: fibsem/conversions.py
 Comment: 
 
+Filename: fibsem/funky tescan error when reading beam current.txt
+Comment: 
+
 Filename: fibsem/gis.py
 Comment: 
 
 Filename: fibsem/microscope.py
 Comment: 
 
 Filename: fibsem/milling.py
@@ -63,14 +69,17 @@
 
 Filename: fibsem/config/deposition.dbp
 Comment: 
 
 Filename: fibsem/config/model.yaml
 Comment: 
 
+Filename: fibsem/config/positions.yaml
+Comment: 
+
 Filename: fibsem/config/protocol.yaml
 Comment: 
 
 Filename: fibsem/config/system.yaml
 Comment: 
 
 Filename: fibsem/detection/__init__.py
@@ -108,14 +117,17 @@
 
 Filename: fibsem/imaging/.gitkeep
 Comment: 
 
 Filename: fibsem/imaging/__init__.py
 Comment: 
 
+Filename: fibsem/imaging/_tile.py
+Comment: 
+
 Filename: fibsem/imaging/masks.py
 Comment: 
 
 Filename: fibsem/imaging/utils.py
 Comment: 
 
 Filename: fibsem/log/positions.yaml
@@ -141,14 +153,17 @@
 
 Filename: fibsem/segmentation/inference.py
 Comment: 
 
 Filename: fibsem/segmentation/model.py
 Comment: 
 
+Filename: fibsem/segmentation/requirements.txt
+Comment: 
+
 Filename: fibsem/segmentation/test_image.tif
 Comment: 
 
 Filename: fibsem/segmentation/train.py
 Comment: 
 
 Filename: fibsem/segmentation/utils.py
@@ -171,14 +186,17 @@
 
 Filename: fibsem/ui/.gitkeep
 Comment: 
 
 Filename: fibsem/ui/FibsemAlignmentWidget.py
 Comment: 
 
+Filename: fibsem/ui/FibsemCryoSputterWidget.py
+Comment: 
+
 Filename: fibsem/ui/FibsemDetectionUI.py
 Comment: 
 
 Filename: fibsem/ui/FibsemDetectionWidget.py
 Comment: 
 
 Filename: fibsem/ui/FibsemEmbeddedDetectionWidget.py
@@ -195,14 +213,17 @@
 
 Filename: fibsem/ui/FibsemManipulatorWidget.py
 Comment: 
 
 Filename: fibsem/ui/FibsemMillingWidget.py
 Comment: 
 
+Filename: fibsem/ui/FibsemMinimapWidget.py
+Comment: 
+
 Filename: fibsem/ui/FibsemModelTrainingWidget.py
 Comment: 
 
 Filename: fibsem/ui/FibsemMovementWidget.py
 Comment: 
 
 Filename: fibsem/ui/FibsemMultiChemWidget.py
@@ -231,14 +252,20 @@
 
 Filename: fibsem/ui/qtdesigner_files/CurrentAlignmentWidget.py
 Comment: 
 
 Filename: fibsem/ui/qtdesigner_files/CurrentAlignmentWidget.ui
 Comment: 
 
+Filename: fibsem/ui/qtdesigner_files/FibsemCryoSputterWidget.py
+Comment: 
+
+Filename: fibsem/ui/qtdesigner_files/FibsemCryoSputterWidget.ui
+Comment: 
+
 Filename: fibsem/ui/qtdesigner_files/FibsemDetectionWidget.py
 Comment: 
 
 Filename: fibsem/ui/qtdesigner_files/FibsemDetectionWidget.ui
 Comment: 
 
 Filename: fibsem/ui/qtdesigner_files/FibsemEmbeddedDetectionWidget.py
@@ -264,17 +291,26 @@
 
 Filename: fibsem/ui/qtdesigner_files/FibsemManipulatorWidget.ui
 Comment: 
 
 Filename: fibsem/ui/qtdesigner_files/FibsemMillingWidget.py
 Comment: 
 
+Filename: fibsem/ui/qtdesigner_files/FibsemMillingWidget.ui
+Comment: 
+
 Filename: fibsem/ui/qtdesigner_files/FibsemMillingWidgetui.ui
 Comment: 
 
+Filename: fibsem/ui/qtdesigner_files/FibsemMinimapWidget.py
+Comment: 
+
+Filename: fibsem/ui/qtdesigner_files/FibsemMinimapWidget.ui
+Comment: 
+
 Filename: fibsem/ui/qtdesigner_files/FibsemModelTrainingWidge.ui
 Comment: 
 
 Filename: fibsem/ui/qtdesigner_files/FibsemModelTrainingWidget.py
 Comment: 
 
 Filename: fibsem/ui/qtdesigner_files/FibsemModelTrainingWidget.ui
@@ -345,26 +381,26 @@
 
 Filename: fibsem/ui/qtdesigner_files/user_dialog.py
 Comment: 
 
 Filename: fibsem/ui/qtdesigner_files/user_dialog.ui
 Comment: 
 
-Filename: fibsem-0.2.1a1.dist-info/LICENSE
+Filename: fibsem-0.2.2a0.dist-info/LICENSE
 Comment: 
 
-Filename: fibsem-0.2.1a1.dist-info/METADATA
+Filename: fibsem-0.2.2a0.dist-info/METADATA
 Comment: 
 
-Filename: fibsem-0.2.1a1.dist-info/WHEEL
+Filename: fibsem-0.2.2a0.dist-info/WHEEL
 Comment: 
 
-Filename: fibsem-0.2.1a1.dist-info/entry_points.txt
+Filename: fibsem-0.2.2a0.dist-info/entry_points.txt
 Comment: 
 
-Filename: fibsem-0.2.1a1.dist-info/top_level.txt
+Filename: fibsem-0.2.2a0.dist-info/top_level.txt
 Comment: 
 
-Filename: fibsem-0.2.1a1.dist-info/RECORD
+Filename: fibsem-0.2.2a0.dist-info/RECORD
 Comment: 
 
 Zip file comment:
```

## fibsem/acquire.py

```diff
@@ -34,18 +34,22 @@
     Notes:
         - This function temporarily changes the `image_settings.beam_type` to `BeamType.ELECTRON`
           and then `BeamType.ION` to acquire the electron and ion reference images, respectively.
           It resets the `image_settings.beam_type` to the original value after acquiring the images.
         - The `FibsemImage` objects in the returned tuple contain the image data as numpy arrays,
           as well as other image metadata.
     """
+    import time 
+    from fibsem.microscope import TescanMicroscope
     tmp_beam_type = image_settings.beam_type
     image_settings.beam_type = BeamType.ELECTRON
     eb_image = new_image(microscope, image_settings)
     image_settings.beam_type = BeamType.ION
+    if isinstance(microscope, TescanMicroscope):
+        time.sleep(3)
     ib_image = new_image(microscope, image_settings)
     image_settings.beam_type = tmp_beam_type  # reset to original beam type
 
     return eb_image, ib_image
    
 
 
@@ -84,14 +88,23 @@
 
     image_settings.hfw = hfws[1]
     image_settings.label = f"{label}_high_res"
     high_eb, high_ib = take_reference_images(microscope, image_settings)
 
     reference_images = ReferenceImages(low_eb, high_eb, low_ib, high_ib)
 
+
+    # more flexible version
+    # reference_images = []
+    # for i, hfw in enumerate(hfws):
+    #     image_settings.hfw = hfw
+    #     image_settings.label = f"{label}_res_{i:02d}"
+    #     eb_image, ib_image = take_reference_images(microscope, image_settings)
+    #     reference_images.append([eb_image, ib_image])
+
     return reference_images
 
 
 def auto_gamma(
     image: FibsemImage,
     min_gamma: float = 0.15,
     max_gamma: float = 1.8,
```

## fibsem/alignment.py

```diff
@@ -12,15 +12,15 @@
     ImageSettings,
     MicroscopeSettings,
     ReferenceImages,
     FibsemImage,
     FibsemRectangle,
 )
 from fibsem.microscope import FibsemMicroscope
-from typing import Union
+from typing import Union, Optional
 
 
 def auto_eucentric_correction(
     microscope: FibsemMicroscope,
     settings: MicroscopeSettings,
     image_settings: ImageSettings,
     tilt_degrees: int = 25,
@@ -47,15 +47,15 @@
         )
 
 
 def beam_shift_alignment(
     microscope: FibsemMicroscope,
     image_settings: ImageSettings,
     ref_image: FibsemImage,
-    reduced_area: FibsemRectangle = None,
+    reduced_area: Optional[FibsemRectangle] = None,
 ):
     """Aligns the images by adjusting the beam shift instead of moving the stage.
 
     This method uses cross-correlation between the reference image and a new image to calculate the
     optimal beam shift for alignment. This approach offers increased precision, but a lower range
     compared to stage movement.
 
@@ -67,14 +67,16 @@
         ref_image (FibsemImage): The reference image to align to.
         reduced_area (FibseRectangle): The reduced area to image with.
 
     Raises:
         ValueError: If `image_settings.beam_type` is not set to `BeamType.ION`.
 
     """
+    image_settings = ImageSettings.fromFibsemImage(ref_image)
+    image_settings.beam_type = BeamType.ION
     image_settings.reduced_area = reduced_area
     new_image = acquire.new_image(
         microscope, settings=image_settings
     )
     dx, dy, _ = shift_from_crosscorrelation(
         ref_image, new_image, lowpass=50, highpass=4, sigma=5, use_rect_mask=True
     )
@@ -85,18 +87,18 @@
 
 def correct_stage_drift(
     microscope: FibsemMicroscope,
     settings: MicroscopeSettings,
     reference_images: ReferenceImages,
     alignment: tuple[BeamType, BeamType] = (BeamType.ELECTRON, BeamType.ELECTRON),
     rotate: bool = False,
-    use_ref_mask: bool = False,
-    mask_scale: int = 4,
+    ref_mask_rad: int = 512,
     xcorr_limit: Union[tuple[int, int], None] = None,
     constrain_vertical: bool = False,
+    use_beam_shift: bool = False,
 ) -> bool:
     """Corrects the stage drift by aligning low- and high-resolution reference images
     using cross-correlation.
 
     Args:
         microscope (FibsemMicroscope): The microscope used for image acquisition.
         settings (MicroscopeSettings): The settings used for image acquisition.
@@ -104,18 +106,15 @@
             reference images.
         alignment (tuple[BeamType, BeamType], optional): A tuple of two `BeamType`
             objects, specifying the beam types used for the alignment of low- and
             high-resolution images, respectively. Defaults to (BeamType.ELECTRON,
             BeamType.ELECTRON).
         rotate (bool, optional): Whether to rotate the reference images before
             alignment. Defaults to False.
-        use_ref_mask (bool, optional): Whether to apply a mask to the reference images
-            before alignment. Defaults to False.
-        mask_scale (int, optional): The scale factor used for creating the mask. Defaults
-            to 4.
+        ref_mask_rad (int, optional): The radius of the circular mask used for reference
         xcorr_limit (tuple[int, int] | None, optional): A tuple of two integers that
             represent the minimum and maximum cross-correlation values allowed for the
             alignment. If not specified, the values are set to (None, None), which means
             there are no limits. Defaults to None.
         constrain_vertical (bool, optional): Whether to constrain the alignment to the
             vertical axis. Defaults to False.
 
@@ -142,42 +141,32 @@
     if rotate:
         ref_lowres = image_utils.rotate_image(ref_lowres)
         ref_highres = image_utils.rotate_image(ref_highres)
 
     # align lowres, then highres
     for i, ref_image in enumerate([ref_lowres, ref_highres]):
 
-        if use_ref_mask:
-            ref_mask = masks.create_lamella_mask(
-                ref_image,
-                settings.protocol["lamella"],
-                scale=mask_scale,
-                use_trench_height=True,
-            )  # TODO: refactor, liftout specific
-        else:
-            ref_mask = None
+        ref_mask = masks.create_circle_mask(ref_image.data.shape, ref_mask_rad)
 
         # take new images
         # set new image settings (same as reference)
-        # settings.image = utils.match_image_settings(
-        #     ref_image, settings.image, beam_type=alignment[1]
-        # )
         settings.image = ImageSettings.fromFibsemImage(ref_image)
         settings.image.beam_type = alignment[1]
         new_image = acquire.new_image(microscope, settings.image)
 
         # crosscorrelation alignment
         ret = align_using_reference_images(
             microscope,
             settings,
             ref_image,
             new_image,
             ref_mask=ref_mask,
             xcorr_limit=xcorr_limit[i],
             constrain_vertical=constrain_vertical,
+            use_beam_shift=use_beam_shift,
         )
 
         if ret is False:
             break  # cross correlation has failed...
 
     return ret
 
@@ -186,14 +175,15 @@
     microscope: FibsemMicroscope,
     settings: MicroscopeSettings,
     ref_image: FibsemImage,
     new_image: FibsemImage,
     ref_mask: np.ndarray = None,
     xcorr_limit: int = None,
     constrain_vertical: bool = False,
+    use_beam_shift: bool = False,
 ) -> bool:
     """
     Uses cross-correlation to align a new image to a reference image.
 
     Args:
         microscope: A FibsemMicroscope instance representing the microscope being used.
         settings: A MicroscopeSettings instance representing the settings for the imaging session.
@@ -241,21 +231,25 @@
 
         # vertical constraint = eucentric movement
         if constrain_vertical:
             microscope.eucentric_move(
                 settings=settings, dy=-dy
             )  # FLAG_TEST
         else:
-            # move the stage
-            microscope.stable_move(
-                settings=settings,
-                dx=dx,
-                dy=-dy,
-                beam_type=new_beam_type,
-            )
+            if use_beam_shift:
+                # move the beam shift
+                microscope.beam_shift(dx=-dx, dy=dy, beam_type=new_beam_type)
+            else:
+                # move the stage
+                microscope.stable_move(
+                    settings=settings,
+                    dx=dx,
+                    dy=-dy,
+                    beam_type=new_beam_type,
+                )
 
     return shift_within_tolerance
 
 
 def shift_from_crosscorrelation(
     ref_image: FibsemImage,
     new_image: FibsemImage,
@@ -322,25 +316,43 @@
 
     # calculate maximum crosscorrelation
     maxX, maxY = np.unravel_index(np.argmax(xcorr), xcorr.shape)  # TODO: backwards
     cen = np.asarray(xcorr.shape) / 2
     err = np.array(cen - [maxX, maxY], int)
 
     # calculate shift in metres
-    x_shift = err[1] * pixelsize_x
-    y_shift = err[0] * pixelsize_y  # this could be the issue?
+    dx = err[1] * pixelsize_x
+    dy = err[0] * pixelsize_y  # this could be the issue?
 
     logging.debug(f"cross-correlation:")
     logging.debug(f"pixelsize: x: {pixelsize_x:.2e}, y: {pixelsize_y:.2e}")
     logging.debug(f"maxX: {maxX}, {maxY}, centre: {cen}")
     logging.debug(f"x: {err[1]}px, y: {err[0]}px")
-    logging.debug(f"x: {x_shift:.2e}m, y: {y_shift:.2e} meters")
+    logging.debug(f"x: {dx:.2e}m, y: {dy:.2e} meters")
+
+    # save data
+    _save_alignment_data(
+        ref_image=ref_image,
+        new_image=new_image,
+        bandpass=bandpass,
+        xcorr=xcorr,
+        use_rect_mask=use_rect_mask,
+        ref_mask=ref_mask,
+        xcorr_limit=xcorr_limit,
+        lowpass=lowpass,
+        highpass=highpass,
+        sigma=sigma,
+        dx=dx,
+        dy=dy,
+        pixelsize_x=pixelsize_x,
+        pixelsize_y=pixelsize_y,
+    )
 
     # metres
-    return x_shift, y_shift, xcorr
+    return dx, dy, xcorr
 
 
 def crosscorrelation_v2(
     img1: np.ndarray, img2: np.ndarray, bandpass: np.ndarray = None
 ) -> np.ndarray:
     """
     Cross-correlate two images using Fourier convolution matching.
@@ -384,7 +396,63 @@
     # plt.title("Power Spectra")
     # plt.imshow(np.log(np.abs(np.fft.fftshift(np.fft.fft2(img1)))))
     # plt.show()
 
     xcorr = np.real(np.fft.fftshift(np.fft.ifft2(img1ft * np.conj(img2ft))))
 
     return xcorr
+
+def _save_alignment_data(
+    ref_image: FibsemImage,
+    new_image: FibsemImage,
+    bandpass: np.ndarray,
+    xcorr: np.ndarray,
+    ref_mask: np.ndarray = None,
+    lowpass: float = None,
+    highpass: float = None,
+    sigma: float = None,
+    xcorr_limit: float = None,
+    use_rect_mask: bool = False,
+    dx: float = None,
+    dy: float = None,
+    pixelsize_x: float = None,
+    pixelsize_y: float = None,
+    
+
+):
+    """Save alignment data to disk."""
+    
+    import pandas as pd
+    import os
+    from fibsem import config as cfg
+    import tifffile as tff
+
+    ts = utils.current_timestamp_v2()
+    fname = os.path.join(cfg.DATA_CC_PATH, str(ts))
+
+    # save fibsem images
+    ref_image.save(fname + "_ref.tif")
+    new_image.save(fname + "_new.tif")
+
+    # convert to tiff , save
+    tff.imwrite(fname + "_xcorr.tif", xcorr)
+    tff.imwrite(fname + "_bandpass.tif", bandpass)
+    if ref_mask is not None:
+        tff.imwrite(fname + "_ref_mask.tif", ref_mask)
+
+    info = {
+        # "ref_image": ref_image, "new_image": new_image, "bandpass": bandpass, "xcorr": xcorr, "ref_mask": ref_mask,
+        "lowpass": lowpass, "highpass": highpass, "sigma": sigma,
+        "pixelsize_x": pixelsize_x, "pixelsize_y": pixelsize_y, 
+        "use_rect_mask": use_rect_mask, "xcorr_limit": xcorr_limit, "ref_mask": ref_mask is not None,
+        "dx": dx, "dy": dy, "fname": fname, "timestamp": ts }
+
+
+    df = pd.DataFrame.from_dict(info, orient='index').T
+    
+    # save the dataframe to a csv file, append if the file already exists
+    DATAFRAME_PATH = os.path.join(cfg.DATA_CC_PATH, "data.csv")
+    if os.path.exists(DATAFRAME_PATH):
+        df_tmp = pd.read_csv(DATAFRAME_PATH)
+        df = pd.concat([df_tmp, df], axis=0, ignore_index=True)
+    
+    df.to_csv(DATAFRAME_PATH, index=False)
```

## fibsem/config.py

```diff
@@ -37,19 +37,29 @@
 
 
 import os
 import fibsem
 
 BASE_PATH = os.path.dirname(fibsem.__path__[0]) # TODO: figure out a more stable way to do this
 CONFIG_PATH = os.path.join(BASE_PATH, "fibsem", "config")
+SYSTEM_PATH = os.path.join(CONFIG_PATH, "system.yaml")
 PROTOCOL_PATH = os.path.join(CONFIG_PATH, "protocol.yaml")
 LOG_PATH = os.path.join(BASE_PATH, "fibsem", "log")
-DATA_PATH = os.path.join(BASE_PATH, "fibsem", "log", "data") 
+DATA_PATH = os.path.join(BASE_PATH, "fibsem", "log", "data")
+DATA_ML_PATH:str = os.path.join(BASE_PATH, "fibsem", "log", "data", "ml")
+DATA_CC_PATH:str = os.path.join(BASE_PATH, "fibsem", "log", "data", "crosscorrelation")
+DATA_TILE_PATH:str = os.path.join(DATA_PATH, "tile")
+POSITION_PATH = os.path.join(CONFIG_PATH, "positions.yaml")   
+MODELS_PATH = os.path.join(BASE_PATH, "fibsem", "segmentation", "models")
 
+os.makedirs(LOG_PATH, exist_ok=True)
 os.makedirs(DATA_PATH, exist_ok=True)
+os.makedirs(DATA_ML_PATH, exist_ok=True)
+os.makedirs(DATA_CC_PATH, exist_ok=True)
+os.makedirs(DATA_TILE_PATH, exist_ok=True)
 
 import yaml
 
 
 def load_yaml(fname):
     """
     Load a YAML file and return its contents as a dictionary.
@@ -95,8 +105,9 @@
     settings = load_yaml(os.path.join(config_path, "system.yaml"))
     manufacturer = settings["system"]["manufacturer"]
 
     return manufacturer
 
 
 __SUPPORTED_MANUFACTURERS__ = ["Thermo", "Tescan", "Demo"]
-__DEFAULT_IP_ADDRESS__ = "localhost"
+__DEFAULT_MANUFACTURER__ = "Thermo"
+__DEFAULT_IP_ADDRESS__ = "10.0.0.1"
```

## fibsem/gis.py

```diff
@@ -14,51 +14,70 @@
     "time": 30.0,
 }
 
 def sputter_platinum(
     microscope: FibsemMicroscope,
     protocol: dict = None,
     default_application_file: str = "Si",
-    whole_grid: bool = False,
 ):
     """Sputter platinum over the sample.
 
     Args:
         microscope (SdbMicroscopeClient): autoscript microscope instance
         protocol (dict): platinum protcol dictionary
-        whole_grid (bool, optional): sputtering protocol. Defaults to False.
-
+        default_application_file (str): application file to use if none is specified
     Returns:
         None
 
     Raises:
         RuntimeError: Error Sputtering
     """
 
     if protocol is None:
         protocol = gis_protocol
-        hfw = protocol["hfw"]
-        line_pattern_length = protocol["length"]
-        sputter_time = protocol["time"]
-
-    elif whole_grid:
-        hfw = protocol["whole_grid"]["hfw"]
-        line_pattern_length = protocol["whole_grid"]["length"]
-        sputter_time = protocol["whole_grid"]["time"]
-    else:
-        hfw = protocol["weld"]["hfw"]
-        line_pattern_length = protocol["weld"]["length"]
-        sputter_time = protocol["weld"]["time"]
-        
+
+    hfw = protocol["hfw"]
+    line_pattern_length = protocol["length"]
+    sputter_time = protocol["time"]
+            
 
     # Setup
     microscope.setup_sputter(protocol=protocol)
 
     # Create sputtering pattern
     sputter_pattern = microscope.draw_sputter_pattern(hfw=hfw, line_pattern_length=line_pattern_length, sputter_time=sputter_time)
 
     # Run sputtering
     microscope.run_sputter(sputter_time=sputter_time, sputter_pattern=sputter_pattern)
 
     # Cleanup
     microscope.finish_sputter(application_file=default_application_file)
-    
+
+
+def cryo_sputter(microscope: FibsemMicroscope, protocol: dict = None, name: str = None):
+
+    # get current position
+    position = microscope.get_current_microscope_state().absolute_position
+
+    # move to sputter position
+    if name is not None:
+        
+        # move to position
+        from fibsem import utils
+        sputter_position = utils._get_position(name)
+        
+        if sputter_position is None:
+            raise RuntimeError(f"Position {name} requested but not found")
+        
+        logging.info(f"Moving to sputter position: {name}")
+        microscope._safe_absolute_stage_movement(sputter_position)
+
+
+    # move down
+    from fibsem.structures import FibsemStagePosition
+    microscope.move_stage_relative(FibsemStagePosition(z=-1e-3))
+
+    # sputter
+    sputter_platinum(microscope, protocol)
+
+    # return to previous position
+    microscope._safe_absolute_stage_movement(position)
```

## fibsem/microscope.py

```diff
@@ -156,12747 +156,13472 @@
 000009b0: 5365 7474 696e 6773 2c20 4d69 6372 6f73  Settings, Micros
 000009c0: 636f 7065 5365 7474 696e 6773 2c20 4669  copeSettings, Fi
 000009d0: 6273 656d 4861 7264 7761 7265 2c0a 2020  bsemHardware,.  
 000009e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000009f0: 2020 2020 2020 2020 2020 2020 204d 6963               Mic
 00000a00: 726f 7363 6f70 6553 7461 7465 2c20 506f  roscopeState, Po
 00000a10: 696e 742c 2046 6962 7365 6d44 6574 6563  int, FibsemDetec
-00000a20: 746f 7253 6574 7469 6e67 732c 5468 6572  torSettings,Ther
-00000a30: 6d6f 4749 534c 696e 652c 5468 6572 6d6f  moGISLine,Thermo
-00000a40: 4d75 6c74 6943 6865 6d4c 696e 6529 0a0a  MultiChemLine)..
-00000a50: 0a63 6c61 7373 2046 6962 7365 6d4d 6963  .class FibsemMic
-00000a60: 726f 7363 6f70 6528 4142 4329 3a0a 2020  roscope(ABC):.  
-00000a70: 2020 2222 2241 6273 7472 6163 7420 636c    """Abstract cl
-00000a80: 6173 7320 636f 6e74 6169 6e69 6e67 2061  ass containing a
-00000a90: 6c6c 2074 6865 2063 6f72 6520 6d69 6372  ll the core micr
-00000aa0: 6f73 636f 7065 2066 756e 6374 696f 6e61  oscope functiona
-00000ab0: 6c69 7469 6573 2222 220a 0a20 2020 2040  lities"""..    @
-00000ac0: 6162 7374 7261 6374 6d65 7468 6f64 0a20  abstractmethod. 
-00000ad0: 2020 2064 6566 2063 6f6e 6e65 6374 5f74     def connect_t
-00000ae0: 6f5f 6d69 6372 6f73 636f 7065 2873 656c  o_microscope(sel
-00000af0: 662c 2069 705f 6164 6472 6573 733a 2073  f, ip_address: s
-00000b00: 7472 2c20 706f 7274 3a20 696e 7429 202d  tr, port: int) -
-00000b10: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
-00000b20: 7061 7373 0a0a 2020 2020 4061 6273 7472  pass..    @abstr
-00000b30: 6163 746d 6574 686f 640a 2020 2020 6465  actmethod.    de
-00000b40: 6620 6469 7363 6f6e 6e65 6374 2873 656c  f disconnect(sel
-00000b50: 6629 3a0a 2020 2020 2020 2020 7061 7373  f):.        pass
-00000b60: 0a0a 2020 2020 4061 6273 7472 6163 746d  ..    @abstractm
-00000b70: 6574 686f 640a 2020 2020 6465 6620 6163  ethod.    def ac
-00000b80: 7175 6972 655f 696d 6167 6528 7365 6c66  quire_image(self
-00000b90: 2c20 696d 6167 655f 7365 7474 696e 6773  , image_settings
-00000ba0: 3a49 6d61 6765 5365 7474 696e 6773 2920  :ImageSettings) 
-00000bb0: 2d3e 2046 6962 7365 6d49 6d61 6765 3a0a  -> FibsemImage:.
-00000bc0: 2020 2020 2020 2020 7061 7373 0a0a 2020          pass..  
-00000bd0: 2020 4061 6273 7472 6163 746d 6574 686f    @abstractmetho
-00000be0: 640a 2020 2020 6465 6620 6c61 7374 5f69  d.    def last_i
-00000bf0: 6d61 6765 2873 656c 662c 2062 6561 6d5f  mage(self, beam_
-00000c00: 7479 7065 3a20 4265 616d 5479 7065 2920  type: BeamType) 
-00000c10: 2d3e 2046 6962 7365 6d49 6d61 6765 3a0a  -> FibsemImage:.
-00000c20: 2020 2020 2020 2020 7061 7373 0a0a 2020          pass..  
-00000c30: 2020 4061 6273 7472 6163 746d 6574 686f    @abstractmetho
-00000c40: 640a 2020 2020 6465 6620 6175 746f 636f  d.    def autoco
-00000c50: 6e74 7261 7374 2873 656c 662c 2062 6561  ntrast(self, bea
-00000c60: 6d5f 7479 7065 3a20 4265 616d 5479 7065  m_type: BeamType
-00000c70: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
-00000c80: 2020 2070 6173 730a 0a20 2020 2040 6162     pass..    @ab
-00000c90: 7374 7261 6374 6d65 7468 6f64 0a20 2020  stractmethod.   
-00000ca0: 2064 6566 2061 7574 6f5f 666f 6375 7328   def auto_focus(
-00000cb0: 7365 6c66 2c20 6265 616d 5f74 7970 653a  self, beam_type:
-00000cc0: 2042 6561 6d54 7970 6529 202d 3e20 4e6f   BeamType) -> No
-00000cd0: 6e65 3a0a 2020 2020 2020 2020 7061 7373  ne:.        pass
-00000ce0: 0a0a 2020 2020 4061 6273 7472 6163 746d  ..    @abstractm
-00000cf0: 6574 686f 640a 2020 2020 6465 6620 7265  ethod.    def re
-00000d00: 7365 745f 6265 616d 5f73 6869 6674 7328  set_beam_shifts(
-00000d10: 7365 6c66 2920 2d3e 204e 6f6e 653a 0a20  self) -> None:. 
-00000d20: 2020 2020 2020 2070 6173 730a 0a20 2020         pass..   
-00000d30: 2040 6162 7374 7261 6374 6d65 7468 6f64   @abstractmethod
-00000d40: 0a20 2020 2064 6566 2062 6561 6d5f 7368  .    def beam_sh
-00000d50: 6966 7428 7365 6c66 2c20 6478 3a20 666c  ift(self, dx: fl
-00000d60: 6f61 742c 2064 793a 2066 6c6f 6174 2c20  oat, dy: float, 
-00000d70: 6265 616d 5f74 7970 653a 2042 6561 6d54  beam_type: BeamT
-00000d80: 7970 6529 202d 3e20 4e6f 6e65 3a0a 2020  ype) -> None:.  
-00000d90: 2020 2020 2020 7061 7373 0a0a 2020 2020        pass..    
-00000da0: 4061 6273 7472 6163 746d 6574 686f 640a  @abstractmethod.
-00000db0: 2020 2020 6465 6620 6765 745f 7374 6167      def get_stag
-00000dc0: 655f 706f 7369 7469 6f6e 2873 656c 6629  e_position(self)
-00000dd0: 202d 3e20 4669 6273 656d 5374 6167 6550   -> FibsemStageP
-00000de0: 6f73 6974 696f 6e3a 0a20 2020 2020 2020  osition:.       
-00000df0: 2070 6173 730a 0a20 2020 2040 6162 7374   pass..    @abst
-00000e00: 7261 6374 6d65 7468 6f64 0a20 2020 2064  ractmethod.    d
-00000e10: 6566 2067 6574 5f63 7572 7265 6e74 5f6d  ef get_current_m
-00000e20: 6963 726f 7363 6f70 655f 7374 6174 6528  icroscope_state(
-00000e30: 7365 6c66 2920 2d3e 204d 6963 726f 7363  self) -> Microsc
-00000e40: 6f70 6553 7461 7465 3a0a 2020 2020 2020  opeState:.      
-00000e50: 2020 7061 7373 0a0a 2020 2020 4061 6273    pass..    @abs
-00000e60: 7472 6163 746d 6574 686f 640a 2020 2020  tractmethod.    
-00000e70: 6465 6620 6d6f 7665 5f73 7461 6765 5f61  def move_stage_a
-00000e80: 6273 6f6c 7574 6528 7365 6c66 2c20 706f  bsolute(self, po
-00000e90: 7369 7469 6f6e 3a20 4669 6273 656d 5374  sition: FibsemSt
-00000ea0: 6167 6550 6f73 6974 696f 6e29 202d 3e20  agePosition) -> 
-00000eb0: 4e6f 6e65 3a0a 2020 2020 2020 2020 7061  None:.        pa
-00000ec0: 7373 0a0a 2020 2020 4061 6273 7472 6163  ss..    @abstrac
-00000ed0: 746d 6574 686f 640a 2020 2020 6465 6620  tmethod.    def 
-00000ee0: 6d6f 7665 5f73 7461 6765 5f72 656c 6174  move_stage_relat
-00000ef0: 6976 6528 7365 6c66 2c20 706f 7369 7469  ive(self, positi
-00000f00: 6f6e 3a20 4669 6273 656d 5374 6167 6550  on: FibsemStageP
-00000f10: 6f73 6974 696f 6e29 202d 3e20 4e6f 6e65  osition) -> None
-00000f20: 3a0a 2020 2020 2020 2020 7061 7373 0a0a  :.        pass..
-00000f30: 2020 2020 4061 6273 7472 6163 746d 6574      @abstractmet
-00000f40: 686f 640a 2020 2020 6465 6620 7374 6162  hod.    def stab
-00000f50: 6c65 5f6d 6f76 6528 7365 6c66 2c0a 2020  le_move(self,.  
-00000f60: 2020 2020 2020 7365 7474 696e 6773 3a20        settings: 
-00000f70: 4d69 6372 6f73 636f 7065 5365 7474 696e  MicroscopeSettin
-00000f80: 6773 2c0a 2020 2020 2020 2020 6478 3a20  gs,.        dx: 
-00000f90: 666c 6f61 742c 0a20 2020 2020 2020 2064  float,.        d
-00000fa0: 793a 2066 6c6f 6174 2c0a 2020 2020 2020  y: float,.      
-00000fb0: 2020 6265 616d 5f74 7970 653a 2042 6561    beam_type: Bea
-00000fc0: 6d54 7970 652c 0a20 2020 2029 202d 3e20  mType,.    ) -> 
-00000fd0: 4669 6273 656d 5374 6167 6550 6f73 6974  FibsemStagePosit
-00000fe0: 696f 6e3a 0a20 2020 2020 2020 2070 6173  ion:.        pas
-00000ff0: 730a 0a20 2020 2040 6162 7374 7261 6374  s..    @abstract
-00001000: 6d65 7468 6f64 0a20 2020 2064 6566 2065  method.    def e
-00001010: 7563 656e 7472 6963 5f6d 6f76 6528 7365  ucentric_move(se
-00001020: 6c66 2c0a 2020 2020 2020 2020 7365 7474  lf,.        sett
-00001030: 696e 6773 3a20 4d69 6372 6f73 636f 7065  ings: Microscope
-00001040: 5365 7474 696e 6773 2c0a 2020 2020 2020  Settings,.      
-00001050: 2020 6479 3a20 666c 6f61 742c 0a20 2020    dy: float,.   
-00001060: 2020 2020 2073 7461 7469 635f 7764 3a20       static_wd: 
-00001070: 626f 6f6c 203d 2054 7275 652c 0a20 2020  bool = True,.   
-00001080: 2029 202d 3e20 4e6f 6e65 3a0a 2020 2020   ) -> None:.    
-00001090: 2020 2020 7061 7373 0a0a 2020 2020 4061      pass..    @a
-000010a0: 6273 7472 6163 746d 6574 686f 640a 2020  bstractmethod.  
-000010b0: 2020 6465 6620 6d6f 7665 5f66 6c61 745f    def move_flat_
-000010c0: 746f 5f62 6561 6d28 7365 6c66 2c20 7365  to_beam(self, se
-000010d0: 7474 696e 6773 3a20 4d69 6372 6f73 636f  ttings: Microsco
-000010e0: 7065 5365 7474 696e 6773 2c20 6265 616d  peSettings, beam
-000010f0: 5f74 7970 653a 2042 6561 6d54 7970 6529  _type: BeamType)
-00001100: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
-00001110: 2020 7061 7373 0a0a 2020 2020 4061 6273    pass..    @abs
-00001120: 7472 6163 746d 6574 686f 640a 2020 2020  tractmethod.    
-00001130: 6465 6620 6765 745f 6d61 6e69 7075 6c61  def get_manipula
-00001140: 746f 725f 706f 7369 7469 6f6e 2873 656c  tor_position(sel
-00001150: 6629 202d 3e20 4669 6273 656d 4d61 6e69  f) -> FibsemMani
-00001160: 7075 6c61 746f 7250 6f73 6974 696f 6e3a  pulatorPosition:
-00001170: 0a20 2020 2020 2020 2070 6173 730a 0a20  .        pass.. 
-00001180: 2020 2040 6162 7374 7261 6374 6d65 7468     @abstractmeth
-00001190: 6f64 0a20 2020 2064 6566 2069 6e73 6572  od.    def inser
-000011a0: 745f 6d61 6e69 7075 6c61 746f 7228 7365  t_manipulator(se
-000011b0: 6c66 2c20 6e61 6d65 3a20 7374 7229 202d  lf, name: str) -
-000011c0: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
-000011d0: 7061 7373 0a0a 2020 2020 4061 6273 7472  pass..    @abstr
-000011e0: 6163 746d 6574 686f 640a 2020 2020 6465  actmethod.    de
-000011f0: 6620 7265 7472 6163 745f 6d61 6e69 7075  f retract_manipu
-00001200: 6c61 746f 7228 7365 6c66 293a 0a20 2020  lator(self):.   
-00001210: 2020 2020 2070 6173 730a 0a20 2020 2040       pass..    @
-00001220: 6162 7374 7261 6374 6d65 7468 6f64 0a20  abstractmethod. 
-00001230: 2020 2064 6566 206d 6f76 655f 6d61 6e69     def move_mani
-00001240: 7075 6c61 746f 725f 7265 6c61 7469 7665  pulator_relative
-00001250: 2873 656c 662c 2070 6f73 6974 696f 6e3a  (self, position:
-00001260: 2046 6962 7365 6d4d 616e 6970 756c 6174   FibsemManipulat
-00001270: 6f72 506f 7369 7469 6f6e 2920 2d3e 204e  orPosition) -> N
-00001280: 6f6e 653a 0a20 2020 2020 2020 2070 6173  one:.        pas
-00001290: 730a 0a20 2020 2040 6162 7374 7261 6374  s..    @abstract
-000012a0: 6d65 7468 6f64 0a20 2020 2064 6566 206d  method.    def m
-000012b0: 6f76 655f 6d61 6e69 7075 6c61 746f 725f  ove_manipulator_
-000012c0: 6162 736f 6c75 7465 2873 656c 662c 2070  absolute(self, p
-000012d0: 6f73 6974 696f 6e3a 2046 6962 7365 6d4d  osition: FibsemM
-000012e0: 616e 6970 756c 6174 6f72 506f 7369 7469  anipulatorPositi
-000012f0: 6f6e 2920 2d3e 204e 6f6e 653a 0a20 2020  on) -> None:.   
-00001300: 2020 2020 2070 6173 730a 2020 2020 0a20       pass.    . 
-00001310: 2020 2040 6162 7374 7261 6374 6d65 7468     @abstractmeth
-00001320: 6f64 0a20 2020 2064 6566 206d 6f76 655f  od.    def move_
-00001330: 6d61 6e69 7075 6c61 746f 725f 636f 7272  manipulator_corr
-00001340: 6563 7465 6428 7365 6c66 2c20 6478 3a20  ected(self, dx: 
-00001350: 666c 6f61 742c 2064 793a 2066 6c6f 6174  float, dy: float
-00001360: 2c20 6265 616d 5f74 7970 653a 2042 6561  , beam_type: Bea
-00001370: 6d54 7970 6529 202d 3e20 4e6f 6e65 3a0a  mType) -> None:.
-00001380: 2020 2020 2020 2020 7061 7373 0a0a 2020          pass..  
-00001390: 2020 4061 6273 7472 6163 746d 6574 686f    @abstractmetho
-000013a0: 640a 2020 2020 6465 6620 6d6f 7665 5f6d  d.    def move_m
-000013b0: 616e 6970 756c 6174 6f72 5f74 6f5f 706f  anipulator_to_po
-000013c0: 7369 7469 6f6e 5f6f 6666 7365 7428 7365  sition_offset(se
-000013d0: 6c66 2c20 6f66 6673 6574 3a20 4669 6273  lf, offset: Fibs
-000013e0: 656d 4d61 6e69 7075 6c61 746f 7250 6f73  emManipulatorPos
-000013f0: 6974 696f 6e2c 206e 616d 653a 2073 7472  ition, name: str
-00001400: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
-00001410: 2020 2070 6173 730a 0a20 2020 2040 6162     pass..    @ab
-00001420: 7374 7261 6374 6d65 7468 6f64 0a20 2020  stractmethod.   
-00001430: 2064 6566 205f 6765 745f 7361 7665 645f   def _get_saved_
-00001440: 6d61 6e69 7075 6c61 746f 725f 706f 7369  manipulator_posi
-00001450: 7469 6f6e 2873 656c 662c 206e 616d 653a  tion(self, name:
-00001460: 2073 7472 2920 2d3e 2046 6962 7365 6d4d   str) -> FibsemM
-00001470: 616e 6970 756c 6174 6f72 506f 7369 7469  anipulatorPositi
-00001480: 6f6e 3a0a 2020 2020 2020 2020 7061 7373  on:.        pass
-00001490: 0a0a 2020 2020 4061 6273 7472 6163 746d  ..    @abstractm
-000014a0: 6574 686f 640a 2020 2020 6465 6620 7365  ethod.    def se
-000014b0: 7475 705f 6d69 6c6c 696e 6728 7365 6c66  tup_milling(self
-000014c0: 2c20 6d69 6c6c 5f73 6574 7469 6e67 733a  , mill_settings:
-000014d0: 2046 6962 7365 6d4d 696c 6c69 6e67 5365   FibsemMillingSe
-000014e0: 7474 696e 6773 2920 2d3e 204e 6f6e 653a  ttings) -> None:
-000014f0: 0a20 2020 2020 2020 2070 6173 730a 0a20  .        pass.. 
-00001500: 2020 2040 6162 7374 7261 6374 6d65 7468     @abstractmeth
-00001510: 6f64 0a20 2020 2064 6566 2072 756e 5f6d  od.    def run_m
-00001520: 696c 6c69 6e67 2873 656c 662c 206d 696c  illing(self, mil
-00001530: 6c69 6e67 5f63 7572 7265 6e74 3a20 666c  ling_current: fl
-00001540: 6f61 742c 2061 7379 6e63 683a 2062 6f6f  oat, asynch: boo
-00001550: 6c29 202d 3e20 4e6f 6e65 3a0a 2020 2020  l) -> None:.    
-00001560: 2020 2020 7061 7373 0a20 2020 200a 2020      pass.    .  
-00001570: 2020 4061 6273 7472 6163 746d 6574 686f    @abstractmetho
-00001580: 640a 2020 2020 6465 6620 7275 6e5f 6d69  d.    def run_mi
-00001590: 6c6c 696e 675f 6472 6966 745f 636f 7272  lling_drift_corr
-000015a0: 6563 7465 6428 7365 6c66 2c20 6d69 6c6c  ected(self, mill
-000015b0: 696e 675f 6375 7272 656e 743a 2066 6c6f  ing_current: flo
-000015c0: 6174 2c20 200a 2020 2020 2020 2020 696d  at,  .        im
-000015d0: 6167 655f 7365 7474 696e 6773 3a20 496d  age_settings: Im
-000015e0: 6167 6553 6574 7469 6e67 732c 200a 2020  ageSettings, .  
-000015f0: 2020 2020 2020 7265 665f 696d 6167 653a        ref_image:
-00001600: 2046 6962 7365 6d49 6d61 6765 2c20 0a20   FibsemImage, . 
-00001610: 2020 2020 2020 2072 6564 7563 6564 5f61         reduced_a
-00001620: 7265 613a 2046 6962 7365 6d52 6563 7461  rea: FibsemRecta
-00001630: 6e67 6c65 203d 204e 6f6e 652c 0a20 2020  ngle = None,.   
-00001640: 2020 2020 2061 7379 6e63 683a 2062 6f6f       asynch: boo
-00001650: 6c20 3d20 4661 6c73 650a 2020 2020 2020  l = False.      
-00001660: 2020 293a 0a20 2020 2020 2020 2070 6173    ):.        pas
-00001670: 730a 0a20 2020 2040 6162 7374 7261 6374  s..    @abstract
-00001680: 6d65 7468 6f64 0a20 2020 2064 6566 2066  method.    def f
-00001690: 696e 6973 685f 6d69 6c6c 696e 6728 7365  inish_milling(se
-000016a0: 6c66 2c20 696d 6167 696e 675f 6375 7272  lf, imaging_curr
-000016b0: 656e 743a 2066 6c6f 6174 2920 2d3e 204e  ent: float) -> N
-000016c0: 6f6e 653a 0a20 2020 2020 2020 2070 6173  one:.        pas
-000016d0: 730a 0a20 2020 2040 6162 7374 7261 6374  s..    @abstract
-000016e0: 6d65 7468 6f64 0a20 2020 2064 6566 2064  method.    def d
-000016f0: 7261 775f 7265 6374 616e 676c 6528 7365  raw_rectangle(se
-00001700: 6c66 2c20 7061 7474 6572 6e5f 7365 7474  lf, pattern_sett
-00001710: 696e 6773 3a20 4669 6273 656d 5061 7474  ings: FibsemPatt
-00001720: 6572 6e53 6574 7469 6e67 7329 3a0a 2020  ernSettings):.  
-00001730: 2020 2020 2020 7061 7373 0a0a 2020 2020        pass..    
-00001740: 4061 6273 7472 6163 746d 6574 686f 640a  @abstractmethod.
-00001750: 2020 2020 6465 6620 6472 6177 5f6c 696e      def draw_lin
-00001760: 6528 7365 6c66 2c20 7061 7474 6572 6e5f  e(self, pattern_
-00001770: 7365 7474 696e 6773 3a20 4669 6273 656d  settings: Fibsem
-00001780: 5061 7474 6572 6e53 6574 7469 6e67 7329  PatternSettings)
-00001790: 3a0a 2020 2020 2020 2020 7061 7373 0a0a  :.        pass..
-000017a0: 2020 2020 4061 6273 7472 6163 746d 6574      @abstractmet
-000017b0: 686f 640a 2020 2020 6465 6620 6472 6177  hod.    def draw
-000017c0: 5f63 6972 636c 6528 7365 6c66 2c20 7061  _circle(self, pa
-000017d0: 7474 6572 6e5f 7365 7474 696e 6773 3a20  ttern_settings: 
-000017e0: 4669 6273 656d 5061 7474 6572 6e53 6574  FibsemPatternSet
-000017f0: 7469 6e67 7329 3a0a 2020 2020 2020 2020  tings):.        
-00001800: 7061 7373 0a0a 2020 2020 4061 6273 7472  pass..    @abstr
-00001810: 6163 746d 6574 686f 640a 2020 2020 6465  actmethod.    de
-00001820: 6620 6472 6177 5f62 6974 6d61 705f 7061  f draw_bitmap_pa
-00001830: 7474 6572 6e28 0a20 2020 2020 2020 2073  ttern(.        s
-00001840: 656c 662c 0a20 2020 2020 2020 2070 6174  elf,.        pat
-00001850: 7465 726e 5f73 6574 7469 6e67 733a 2046  tern_settings: F
-00001860: 6962 7365 6d50 6174 7465 726e 5365 7474  ibsemPatternSett
-00001870: 696e 6773 2c0a 2020 2020 2020 2020 7061  ings,.        pa
-00001880: 7468 3a20 7374 722c 0a20 2020 2029 3a0a  th: str,.    ):.
-00001890: 2020 2020 2020 2020 7061 7373 0a0a 2020          pass..  
-000018a0: 2020 4061 6273 7472 6163 746d 6574 686f    @abstractmetho
-000018b0: 640a 2020 2020 6465 6620 6765 745f 7363  d.    def get_sc
-000018c0: 616e 5f64 6972 6563 7469 6f6e 7328 7365  an_directions(se
-000018d0: 6c66 2920 2d3e 206c 6973 743a 0a20 2020  lf) -> list:.   
-000018e0: 2020 2020 2070 6173 730a 0a20 2020 2040       pass..    @
-000018f0: 6162 7374 7261 6374 6d65 7468 6f64 0a20  abstractmethod. 
-00001900: 2020 2064 6566 2073 6574 7570 5f73 7075     def setup_spu
-00001910: 7474 6572 2873 656c 662c 202a 6172 6773  tter(self, *args
-00001920: 2c20 2a2a 6b77 6172 6773 293a 0a20 2020  , **kwargs):.   
-00001930: 2020 2020 2070 6173 730a 0a20 2020 2040       pass..    @
-00001940: 6162 7374 7261 6374 6d65 7468 6f64 0a20  abstractmethod. 
-00001950: 2020 2064 6566 2064 7261 775f 7370 7574     def draw_sput
-00001960: 7465 725f 7061 7474 6572 6e28 7365 6c66  ter_pattern(self
-00001970: 2c20 2a61 7267 732c 202a 2a6b 7761 7267  , *args, **kwarg
-00001980: 7329 202d 3e20 4e6f 6e65 3a0a 2020 2020  s) -> None:.    
-00001990: 2020 2020 7061 7373 0a0a 2020 2020 4061      pass..    @a
-000019a0: 6273 7472 6163 746d 6574 686f 640a 2020  bstractmethod.  
-000019b0: 2020 6465 6620 7275 6e5f 7370 7574 7465    def run_sputte
-000019c0: 7228 7365 6c66 2c20 2a61 7267 732c 202a  r(self, *args, *
-000019d0: 2a6b 7761 7267 7329 3a0a 2020 2020 2020  *kwargs):.      
-000019e0: 2020 7061 7373 0a0a 2020 2020 4061 6273    pass..    @abs
-000019f0: 7472 6163 746d 6574 686f 640a 2020 2020  tractmethod.    
-00001a00: 6465 6620 6669 6e69 7368 5f73 7075 7474  def finish_sputt
-00001a10: 6572 2873 656c 6629 3a0a 2020 2020 2020  er(self):.      
-00001a20: 2020 7061 7373 0a0a 2020 2020 4061 6273    pass..    @abs
-00001a30: 7472 6163 746d 6574 686f 640a 2020 2020  tractmethod.    
-00001a40: 6465 6620 7365 745f 6d69 6372 6f73 636f  def set_microsco
-00001a50: 7065 5f73 7461 7465 2873 656c 662c 2073  pe_state(self, s
-00001a60: 7461 7465 3a20 4d69 6372 6f73 636f 7065  tate: Microscope
-00001a70: 5374 6174 6529 202d 3e20 4e6f 6e65 3a0a  State) -> None:.
-00001a80: 2020 2020 2020 2020 7061 7373 0a20 2020          pass.   
-00001a90: 200a 2020 2020 4061 6273 7472 6163 746d   .    @abstractm
-00001aa0: 6574 686f 640a 2020 2020 6465 6620 6765  ethod.    def ge
-00001ab0: 745f 6176 6169 6c61 626c 655f 7661 6c75  t_available_valu
-00001ac0: 6573 2873 656c 662c 206b 6579 3a73 7472  es(self, key:str
-00001ad0: 2c20 6265 616d 5f74 7970 653a 2042 6561  , beam_type: Bea
-00001ae0: 6d54 7970 6520 3d20 4e6f 6e65 2920 2d3e  mType = None) ->
-00001af0: 206c 6973 743a 0a20 2020 2020 2020 2070   list:.        p
-00001b00: 6173 730a 0a20 2020 2040 6162 7374 7261  ass..    @abstra
-00001b10: 6374 6d65 7468 6f64 0a20 2020 2064 6566  ctmethod.    def
-00001b20: 2067 6574 2873 656c 662c 206b 6579 3a73   get(self, key:s
-00001b30: 7472 2c20 6265 616d 5f74 7970 653a 2042  tr, beam_type: B
-00001b40: 6561 6d54 7970 6520 3d20 4e6f 6e65 293a  eamType = None):
-00001b50: 0a20 2020 2020 2020 2070 6173 730a 2020  .        pass.  
-00001b60: 2020 0a20 2020 2040 6162 7374 7261 6374    .    @abstract
-00001b70: 6d65 7468 6f64 0a20 2020 2064 6566 2067  method.    def g
-00001b80: 6574 5f62 6561 6d5f 7365 7474 696e 6773  et_beam_settings
-00001b90: 2873 656c 662c 2062 6561 6d5f 7479 7065  (self, beam_type
-00001ba0: 3a20 4265 616d 5479 7065 203d 204e 6f6e  : BeamType = Non
-00001bb0: 6529 202d 3e20 4265 616d 5365 7474 696e  e) -> BeamSettin
-00001bc0: 6773 3a0a 2020 2020 2020 2020 7061 7373  gs:.        pass
-00001bd0: 0a0a 2020 2020 4061 6273 7472 6163 746d  ..    @abstractm
-00001be0: 6574 686f 640a 2020 2020 6465 6620 6765  ethod.    def ge
-00001bf0: 745f 6465 7465 6374 6f72 5f73 6574 7469  t_detector_setti
-00001c00: 6e67 7328 7365 6c66 2c20 6265 616d 5f74  ngs(self, beam_t
-00001c10: 7970 653a 2042 6561 6d54 7970 6520 3d20  ype: BeamType = 
-00001c20: 4e6f 6e65 2920 2d3e 2046 6962 7365 6d44  None) -> FibsemD
-00001c30: 6574 6563 746f 7253 6574 7469 6e67 733a  etectorSettings:
-00001c40: 0a20 2020 2020 2020 2070 6173 730a 0a20  .        pass.. 
-00001c50: 2020 2040 6162 7374 7261 6374 6d65 7468     @abstractmeth
-00001c60: 6f64 0a20 2020 2064 6566 2073 6574 2873  od.    def set(s
-00001c70: 656c 662c 206b 6579 3a20 7374 722c 2076  elf, key: str, v
-00001c80: 616c 7565 2c20 6265 616d 5f74 7970 653a  alue, beam_type:
-00001c90: 2042 6561 6d54 7970 6520 3d20 4e6f 6e65   BeamType = None
-00001ca0: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
-00001cb0: 2020 2070 6173 730a 0a20 2020 2040 6162     pass..    @ab
-00001cc0: 7374 7261 6374 6d65 7468 6f64 0a0a 2020  stractmethod..  
-00001cd0: 2020 6465 6620 6368 6563 6b5f 6176 6169    def check_avai
-00001ce0: 6c61 626c 655f 7661 6c75 6573 2873 656c  lable_values(sel
-00001cf0: 662c 206b 6579 3a73 7472 2c20 7661 6c75  f, key:str, valu
-00001d00: 6573 2c20 6265 616d 5f74 7970 653a 2042  es, beam_type: B
-00001d10: 6561 6d54 7970 6520 3d20 4e6f 6e65 2920  eamType = None) 
-00001d20: 2d3e 2062 6f6f 6c3a 0a20 2020 2020 2020  -> bool:.       
-00001d30: 2070 6173 730a 0a20 2020 2040 6162 7374   pass..    @abst
-00001d40: 7261 6374 6d65 7468 6f64 0a20 2020 2064  ractmethod.    d
-00001d50: 6566 2067 6574 5f6d 616e 6970 756c 6174  ef get_manipulat
-00001d60: 6f72 5f73 7461 7465 2873 656c 662c 2073  or_state(self, s
-00001d70: 6574 7469 6e67 733a 204d 6963 726f 7363  ettings: Microsc
-00001d80: 6f70 6553 6574 7469 6e67 7329 202d 3e20  opeSettings) -> 
-00001d90: 626f 6f6c 3a0a 2020 2020 2020 2020 7061  bool:.        pa
-00001da0: 7373 0a0a 2020 2020 4061 6273 7472 6163  ss..    @abstrac
-00001db0: 746d 6574 686f 640a 2020 2020 6465 6620  tmethod.    def 
-00001dc0: 686f 6d65 2873 656c 6629 3a0a 2020 2020  home(self):.    
-00001dd0: 2020 2020 7061 7373 0a0a 636c 6173 7320      pass..class 
-00001de0: 5468 6572 6d6f 4d69 6372 6f73 636f 7065  ThermoMicroscope
-00001df0: 2846 6962 7365 6d4d 6963 726f 7363 6f70  (FibsemMicroscop
-00001e00: 6529 3a0a 2020 2020 2222 220a 2020 2020  e):.    """.    
-00001e10: 4120 636c 6173 7320 7265 7072 6573 656e  A class represen
-00001e20: 7469 6e67 2061 2054 6865 726d 6f20 4669  ting a Thermo Fi
-00001e30: 7368 6572 2046 4942 2d53 454d 206d 6963  sher FIB-SEM mic
-00001e40: 726f 7363 6f70 652e 0a0a 2020 2020 5468  roscope...    Th
-00001e50: 6973 2063 6c61 7373 2069 6e68 6572 6974  is class inherit
-00001e60: 7320 6672 6f6d 2074 6865 2061 6273 7472  s from the abstr
-00001e70: 6163 7420 6261 7365 2063 6c61 7373 2060  act base class `
-00001e80: 4669 6273 656d 4d69 6372 6f73 636f 7065  FibsemMicroscope
-00001e90: 602c 2077 6869 6368 2064 6566 696e 6573  `, which defines
-00001ea0: 2074 6865 2063 6f72 6520 6675 6e63 7469   the core functi
-00001eb0: 6f6e 616c 6974 7920 6f66 2061 0a20 2020  onality of a.   
-00001ec0: 206d 6963 726f 7363 6f70 652e 2049 6e20   microscope. In 
-00001ed0: 6164 6469 7469 6f6e 2074 6f20 7468 6520  addition to the 
-00001ee0: 6d65 7468 6f64 7320 6465 6669 6e65 6420  methods defined 
-00001ef0: 696e 2074 6865 2062 6173 6520 636c 6173  in the base clas
-00001f00: 732c 2074 6869 7320 636c 6173 7320 7072  s, this class pr
-00001f10: 6f76 6964 6573 2061 6464 6974 696f 6e61  ovides additiona
-00001f20: 6c20 6d65 7468 6f64 7320 7370 6563 6966  l methods specif
-00001f30: 6963 0a20 2020 2074 6f20 7468 6520 5468  ic.    to the Th
-00001f40: 6572 6d6f 2046 6973 6865 7220 4649 422d  ermo Fisher FIB-
-00001f50: 5345 4d20 6d69 6372 6f73 636f 7065 2e0a  SEM microscope..
-00001f60: 0a20 2020 2041 7474 7269 6275 7465 733a  .    Attributes:
-00001f70: 0a20 2020 2020 2020 2063 6f6e 6e65 6374  .        connect
-00001f80: 696f 6e20 2853 6462 4d69 6372 6f73 636f  ion (SdbMicrosco
-00001f90: 7065 436c 6965 6e74 293a 2054 6865 206d  peClient): The m
-00001fa0: 6963 726f 7363 6f70 6520 636c 6965 6e74  icroscope client
-00001fb0: 2063 6f6e 6e65 6374 696f 6e2e 0a0a 2020   connection...  
-00001fc0: 2020 496e 6865 7269 7465 6420 4d65 7468    Inherited Meth
-00001fd0: 6f64 733a 0a20 2020 2020 2020 2063 6f6e  ods:.        con
-00001fe0: 6e65 6374 5f74 6f5f 6d69 6372 6f73 636f  nect_to_microsco
-00001ff0: 7065 2873 656c 662c 2069 705f 6164 6472  pe(self, ip_addr
-00002000: 6573 733a 2073 7472 2c20 706f 7274 3a20  ess: str, port: 
-00002010: 696e 7420 3d20 3735 3230 2920 2d3e 204e  int = 7520) -> N
-00002020: 6f6e 653a 200a 2020 2020 2020 2020 2020  one: .          
-00002030: 2020 436f 6e6e 6563 7420 746f 2061 2054    Connect to a T
-00002040: 6865 726d 6f20 4669 7368 6572 206d 6963  hermo Fisher mic
-00002050: 726f 7363 6f70 6520 6174 2074 6865 2073  roscope at the s
-00002060: 7065 6369 6669 6564 2049 5020 6164 6472  pecified IP addr
-00002070: 6573 7320 616e 6420 706f 7274 2e0a 0a20  ess and port... 
-00002080: 2020 2020 2020 2064 6973 636f 6e6e 6563         disconnec
-00002090: 7428 7365 6c66 2920 2d3e 204e 6f6e 653a  t(self) -> None:
-000020a0: 200a 2020 2020 2020 2020 2020 2020 4469   .            Di
-000020b0: 7363 6f6e 6e65 6374 7320 7468 6520 6d69  sconnects the mi
-000020c0: 6372 6f73 636f 7065 2063 6c69 656e 7420  croscope client 
-000020d0: 636f 6e6e 6563 7469 6f6e 2e0a 0a20 2020  connection...   
-000020e0: 2020 2020 2061 6371 7569 7265 5f69 6d61       acquire_ima
-000020f0: 6765 2873 656c 662c 2069 6d61 6765 5f73  ge(self, image_s
-00002100: 6574 7469 6e67 733a 2049 6d61 6765 5365  ettings: ImageSe
-00002110: 7474 696e 6773 2920 2d3e 2046 6962 7365  ttings) -> Fibse
-00002120: 6d49 6d61 6765 3a20 0a20 2020 2020 2020  mImage: .       
-00002130: 2020 2020 2041 6371 7569 7265 2061 206e       Acquire a n
-00002140: 6577 2069 6d61 6765 2077 6974 6820 7468  ew image with th
-00002150: 6520 7370 6563 6966 6965 6420 7365 7474  e specified sett
-00002160: 696e 6773 2e0a 0a20 2020 2020 2020 206c  ings...        l
-00002170: 6173 745f 696d 6167 6528 7365 6c66 2c20  ast_image(self, 
-00002180: 6265 616d 5f74 7970 653a 2042 6561 6d54  beam_type: BeamT
-00002190: 7970 6520 3d20 4265 616d 5479 7065 2e45  ype = BeamType.E
-000021a0: 4c45 4354 524f 4e29 202d 3e20 4669 6273  LECTRON) -> Fibs
-000021b0: 656d 496d 6167 653a 200a 2020 2020 2020  emImage: .      
-000021c0: 2020 2020 2020 4765 7420 7468 6520 6c61        Get the la
-000021d0: 7374 2070 7265 7669 6f75 736c 7920 6163  st previously ac
-000021e0: 7175 6972 6564 2069 6d61 6765 2e0a 0a20  quired image... 
-000021f0: 2020 2020 2020 2061 7574 6f63 6f6e 7472         autocontr
-00002200: 6173 7428 7365 6c66 2c20 6265 616d 5f74  ast(self, beam_t
-00002210: 7970 653d 4265 616d 5479 7065 2e45 4c45  ype=BeamType.ELE
-00002220: 4354 524f 4e29 202d 3e20 4e6f 6e65 3a20  CTRON) -> None: 
-00002230: 0a20 2020 2020 2020 2020 2020 2041 7574  .            Aut
-00002240: 6f6d 6174 6963 616c 6c79 2061 646a 7573  omatically adjus
-00002250: 7420 7468 6520 6d69 6372 6f73 636f 7065  t the microscope
-00002260: 2069 6d61 6765 2063 6f6e 7472 6173 7420   image contrast 
-00002270: 666f 7220 7468 6520 7370 6563 6966 6965  for the specifie
-00002280: 6420 6265 616d 2074 7970 652e 0a0a 2020  d beam type...  
-00002290: 2020 2020 2020 6175 746f 5f66 6f63 7573        auto_focus
-000022a0: 2873 656c 662c 2062 6561 6d5f 7479 7065  (self, beam_type
-000022b0: 3a20 4265 616d 5479 7065 2920 2d3e 204e  : BeamType) -> N
-000022c0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-000022d0: 2041 7574 6f6d 6174 6963 616c 6c79 2061   Automatically a
-000022e0: 646a 7573 7420 7468 6520 6d69 6372 6f73  djust the micros
-000022f0: 636f 7065 2066 6f63 7573 2066 6f72 2074  cope focus for t
-00002300: 6865 2073 7065 6369 6669 6564 2062 6561  he specified bea
-00002310: 6d20 7479 7065 2e0a 0a20 2020 2020 2020  m type...       
-00002320: 2072 6573 6574 5f62 6561 6d5f 7368 6966   reset_beam_shif
-00002330: 7473 2873 656c 6629 202d 3e20 4e6f 6e65  ts(self) -> None
-00002340: 3a0a 2020 2020 2020 2020 2020 2020 5365  :.            Se
-00002350: 7420 7468 6520 6265 616d 2073 6869 6674  t the beam shift
-00002360: 2074 6f20 7a65 726f 2066 6f72 2074 6865   to zero for the
-00002370: 2065 6c65 6374 726f 6e20 616e 6420 696f   electron and io
-00002380: 6e20 6265 616d 732e 0a20 2020 2020 2020  n beams..       
-00002390: 200a 2020 2020 2020 2020 6265 616d 5f73   .        beam_s
-000023a0: 6869 6674 2873 656c 662c 2064 783a 2066  hift(self, dx: f
-000023b0: 6c6f 6174 2c20 6479 3a20 666c 6f61 742c  loat, dy: float,
-000023c0: 2020 6265 616d 5f74 7970 653a 2042 6561    beam_type: Bea
-000023d0: 6d54 7970 6529 202d 3e20 4e6f 6e65 3a0a  mType) -> None:.
-000023e0: 2020 2020 2020 2020 2020 2020 4164 6a75              Adju
-000023f0: 7374 7320 7468 6520 6265 616d 2073 6869  sts the beam shi
-00002400: 6674 206f 6620 6769 7665 6e20 6265 616d  ft of given beam
-00002410: 2062 6173 6564 206f 6e20 7265 6c61 7469   based on relati
-00002420: 7665 2076 616c 7565 7320 7468 6174 2061  ve values that a
-00002430: 7265 2070 726f 7669 6465 642e 0a0a 2020  re provided...  
-00002440: 2020 2020 2020 6765 745f 7374 6167 655f        get_stage_
-00002450: 706f 7369 7469 6f6e 2873 656c 6629 202d  position(self) -
-00002460: 3e20 4669 6273 656d 5374 6167 6550 6f73  > FibsemStagePos
-00002470: 6974 696f 6e3a 0a20 2020 2020 2020 2020  ition:.         
-00002480: 2020 2047 6574 2074 6865 2063 7572 7265     Get the curre
-00002490: 6e74 2073 7461 6765 2070 6f73 6974 696f  nt stage positio
-000024a0: 6e2e 0a0a 2020 2020 2020 2020 6765 745f  n...        get_
-000024b0: 6375 7272 656e 745f 6d69 6372 6f73 636f  current_microsco
-000024c0: 7065 5f73 7461 7465 2873 656c 6629 202d  pe_state(self) -
-000024d0: 3e20 4d69 6372 6f73 636f 7065 5374 6174  > MicroscopeStat
-000024e0: 653a 0a20 2020 2020 2020 2020 2020 2047  e:.            G
-000024f0: 6574 2074 6865 2063 7572 7265 6e74 206d  et the current m
-00002500: 6963 726f 7363 6f70 6520 7374 6174 650a  icroscope state.
-00002510: 0a20 2020 2020 2020 206d 6f76 655f 7374  .        move_st
-00002520: 6167 655f 6162 736f 6c75 7465 2873 656c  age_absolute(sel
-00002530: 662c 2070 6f73 6974 696f 6e3a 2046 6962  f, position: Fib
-00002540: 7365 6d53 7461 6765 506f 7369 7469 6f6e  semStagePosition
-00002550: 293a 0a20 2020 2020 2020 2020 2020 204d  ):.            M
-00002560: 6f76 6520 7468 6520 7374 6167 6520 746f  ove the stage to
-00002570: 2074 6865 2073 7065 6369 6669 6564 2063   the specified c
-00002580: 6f6f 7264 696e 6174 6573 2e0a 0a20 2020  oordinates...   
-00002590: 2020 2020 206d 6f76 655f 7374 6167 655f       move_stage_
-000025a0: 7265 6c61 7469 7665 2873 656c 662c 2070  relative(self, p
-000025b0: 6f73 6974 696f 6e3a 2046 6962 7365 6d53  osition: FibsemS
-000025c0: 7461 6765 506f 7369 7469 6f6e 293a 0a20  tagePosition):. 
-000025d0: 2020 2020 2020 2020 2020 204d 6f76 6520             Move 
-000025e0: 7468 6520 7374 6167 6520 6279 2074 6865  the stage by the
-000025f0: 2073 7065 6369 6669 6564 2072 656c 6174   specified relat
-00002600: 6976 6520 6d6f 7665 2e0a 0a20 2020 2020  ive move...     
-00002610: 2020 2073 7461 626c 655f 6d6f 7665 2873     stable_move(s
-00002620: 656c 662c 2073 6574 7469 6e67 733a 204d  elf, settings: M
-00002630: 6963 726f 7363 6f70 6553 6574 7469 6e67  icroscopeSetting
-00002640: 732c 2064 783a 2066 6c6f 6174 2c20 6479  s, dx: float, dy
-00002650: 3a20 666c 6f61 742c 2062 6561 6d5f 7479  : float, beam_ty
-00002660: 7065 3a20 4265 616d 5479 7065 2c29 202d  pe: BeamType,) -
-00002670: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
-00002680: 2020 2020 4361 6c63 756c 6174 6520 7468      Calculate th
-00002690: 6520 636f 7272 6563 7465 6420 7374 6167  e corrected stag
-000026a0: 6520 6d6f 7665 6d65 6e74 7320 6261 7365  e movements base
-000026b0: 6420 6f6e 2074 6865 2062 6561 6d5f 7479  d on the beam_ty
-000026c0: 7065 2c20 616e 6420 7468 656e 206d 6f76  pe, and then mov
-000026d0: 6520 7468 6520 7374 6167 6520 7265 6c61  e the stage rela
-000026e0: 7469 7665 6c79 2e0a 0a20 2020 2020 2020  tively...       
-000026f0: 2065 7563 656e 7472 6963 5f6d 6f76 6528   eucentric_move(
-00002700: 7365 6c66 2c20 7365 7474 696e 6773 3a20  self, settings: 
-00002710: 4d69 6372 6f73 636f 7065 5365 7474 696e  MicroscopeSettin
-00002720: 6773 2c20 6479 3a20 666c 6f61 742c 2073  gs, dy: float, s
-00002730: 7461 7469 635f 7764 3a20 626f 6f6c 203d  tatic_wd: bool =
-00002740: 2054 7275 6529 202d 3e20 4e6f 6e65 3a0a   True) -> None:.
-00002750: 2020 2020 2020 2020 2020 2020 4d6f 7665              Move
-00002760: 2074 6865 2073 7461 6765 2076 6572 7469   the stage verti
-00002770: 6361 6c6c 7920 746f 2063 6f72 7265 6374  cally to correct
-00002780: 2065 7563 656e 7472 6963 2070 6f69 6e74   eucentric point
-00002790: 0a20 2020 2020 2020 200a 2020 2020 2020  .        .      
-000027a0: 2020 6d6f 7665 5f66 6c61 745f 746f 5f62    move_flat_to_b
-000027b0: 6561 6d28 7365 6c66 2c20 7365 7474 696e  eam(self, settin
-000027c0: 6773 3a20 4d69 6372 6f73 636f 7065 5365  gs: MicroscopeSe
-000027d0: 7474 696e 6773 2c20 6265 616d 5f74 7970  ttings, beam_typ
-000027e0: 653a 2042 6561 6d54 7970 6520 3d20 4265  e: BeamType = Be
-000027f0: 616d 5479 7065 2e45 4c45 4354 524f 4e29  amType.ELECTRON)
-00002800: 3a0a 2020 2020 2020 2020 2020 2020 4d61  :.            Ma
-00002810: 6b65 2074 6865 2073 616d 706c 6520 7375  ke the sample su
-00002820: 7266 6163 6520 666c 6174 2074 6f20 7468  rface flat to th
-00002830: 6520 656c 6563 7472 6f6e 206f 7220 696f  e electron or io
-00002840: 6e20 6265 616d 2e0a 0a20 2020 2020 2020  n beam...       
-00002850: 2067 6574 5f6d 616e 6970 756c 6174 6f72   get_manipulator
-00002860: 5f70 6f73 6974 696f 6e28 7365 6c66 2920  _position(self) 
-00002870: 2d3e 2046 6962 7365 6d4d 616e 6970 756c  -> FibsemManipul
-00002880: 6174 6f72 506f 7369 7469 6f6e 3a0a 2020  atorPosition:.  
-00002890: 2020 2020 2020 2020 2020 4765 7420 7468            Get th
-000028a0: 6520 6375 7272 656e 7420 6d61 6e69 7075  e current manipu
-000028b0: 6c61 746f 7220 706f 7369 7469 6f6e 2e0a  lator position..
-000028c0: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
-000028d0: 2069 6e73 6572 745f 6d61 6e69 7075 6c61   insert_manipula
-000028e0: 746f 7228 7365 6c66 2c20 6e61 6d65 3a20  tor(self, name: 
-000028f0: 7374 7229 202d 3e20 4e6f 6e65 3a0a 2020  str) -> None:.  
-00002900: 2020 2020 2020 2020 2020 496e 7365 7274            Insert
-00002910: 2074 6865 206d 616e 6970 756c 6174 6f72   the manipulator
-00002920: 2069 6e74 6f20 7468 6520 7361 6d70 6c65   into the sample
-00002930: 2e0a 2020 2020 2020 2020 0a20 2020 2020  ..        .     
-00002940: 2020 2072 6574 7261 6374 5f6d 616e 6970     retract_manip
-00002950: 756c 6174 6f72 2873 656c 6629 202d 3e20  ulator(self) -> 
-00002960: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-00002970: 2020 5265 7472 6163 7420 7468 6520 6d61    Retract the ma
-00002980: 6e69 7075 6c61 746f 7220 6672 6f6d 2074  nipulator from t
-00002990: 6865 2073 616d 706c 652e 0a0a 2020 2020  he sample...    
-000029a0: 2020 2020 6d6f 7665 5f6d 616e 6970 756c      move_manipul
-000029b0: 6174 6f72 5f72 656c 6174 6976 6528 7365  ator_relative(se
-000029c0: 6c66 2c20 706f 7369 7469 6f6e 3a20 4669  lf, position: Fi
-000029d0: 6273 656d 4d61 6e69 7075 6c61 746f 7250  bsemManipulatorP
-000029e0: 6f73 6974 696f 6e29 202d 3e20 4e6f 6e65  osition) -> None
-000029f0: 3a0a 2020 2020 2020 2020 2020 2020 4d6f  :.            Mo
-00002a00: 7665 2074 6865 206d 616e 6970 756c 6174  ve the manipulat
-00002a10: 6f72 2062 7920 7468 6520 7370 6563 6966  or by the specif
-00002a20: 6965 6420 7265 6c61 7469 7665 206d 6f76  ied relative mov
-00002a30: 652e 0a20 2020 2020 2020 200a 2020 2020  e..        .    
-00002a40: 2020 2020 6d6f 7665 5f6d 616e 6970 756c      move_manipul
-00002a50: 6174 6f72 5f61 6273 6f6c 7574 6528 7365  ator_absolute(se
-00002a60: 6c66 2c20 706f 7369 7469 6f6e 3a20 4669  lf, position: Fi
-00002a70: 6273 656d 4d61 6e69 7075 6c61 746f 7250  bsemManipulatorP
-00002a80: 6f73 6974 696f 6e29 202d 3e20 4e6f 6e65  osition) -> None
-00002a90: 3a0a 2020 2020 2020 2020 2020 2020 4d6f  :.            Mo
-00002aa0: 7665 2074 6865 206d 616e 6970 756c 6174  ve the manipulat
-00002ab0: 6f72 2074 6f20 7468 6520 7370 6563 6966  or to the specif
-00002ac0: 6965 6420 636f 6f72 6469 6e61 7465 732e  ied coordinates.
-00002ad0: 0a0a 2020 2020 2020 2020 6d6f 7665 5f6d  ..        move_m
-00002ae0: 616e 6970 756c 6174 6f72 5f63 6f72 7265  anipulator_corre
-00002af0: 6374 6564 2873 656c 662c 2064 783a 2066  cted(self, dx: f
-00002b00: 6c6f 6174 2c20 6479 3a20 666c 6f61 742c  loat, dy: float,
-00002b10: 2062 6561 6d5f 7479 7065 3a20 4265 616d   beam_type: Beam
-00002b20: 5479 7065 2920 2d3e 204e 6f6e 653a 0a20  Type) -> None:. 
-00002b30: 2020 2020 2020 2020 2020 204d 6f76 6520             Move 
-00002b40: 7468 6520 6d61 6e69 7075 6c61 746f 7220  the manipulator 
-00002b50: 6279 2074 6865 2073 7065 6369 6669 6564  by the specified
-00002b60: 2072 656c 6174 6976 6520 6d6f 7665 2c20   relative move, 
-00002b70: 636f 7272 6563 7469 6e67 2066 6f72 2074  correcting for t
-00002b80: 6865 2062 6561 6d20 7479 7065 2e20 2020  he beam type.   
-00002b90: 2020 200a 0a20 2020 2020 2020 206d 6f76     ..        mov
-00002ba0: 655f 6d61 6e69 7075 6c61 746f 725f 746f  e_manipulator_to
-00002bb0: 5f70 6f73 6974 696f 6e5f 6f66 6673 6574  _position_offset
-00002bc0: 2873 656c 662c 206f 6666 7365 743a 2046  (self, offset: F
-00002bd0: 6962 7365 6d4d 616e 6970 756c 6174 6f72  ibsemManipulator
-00002be0: 506f 7369 7469 6f6e 2c20 6e61 6d65 3a20  Position, name: 
-00002bf0: 7374 7229 202d 3e20 4e6f 6e65 3a0a 2020  str) -> None:.  
-00002c00: 2020 2020 2020 2020 2020 4d6f 7665 2074            Move t
-00002c10: 6865 206d 616e 6970 756c 6174 6f72 2074  he manipulator t
-00002c20: 6f20 7468 6520 7370 6563 6966 6965 6420  o the specified 
-00002c30: 706f 7369 7469 6f6e 206f 6666 7365 742e  position offset.
-00002c40: 0a0a 2020 2020 2020 2020 5f67 6574 5f73  ..        _get_s
-00002c50: 6176 6564 5f6d 616e 6970 756c 6174 6f72  aved_manipulator
-00002c60: 5f70 6f73 6974 696f 6e28 7365 6c66 2c20  _position(self, 
-00002c70: 6e61 6d65 3a20 7374 7229 202d 3e20 4669  name: str) -> Fi
-00002c80: 6273 656d 4d61 6e69 7075 6c61 746f 7250  bsemManipulatorP
-00002c90: 6f73 6974 696f 6e3a 0a20 2020 2020 2020  osition:.       
-00002ca0: 2020 2020 2047 6574 2074 6865 2073 6176       Get the sav
-00002cb0: 6564 206d 616e 6970 756c 6174 6f72 2070  ed manipulator p
-00002cc0: 6f73 6974 696f 6e20 7769 7468 2074 6865  osition with the
-00002cd0: 2073 7065 6369 6669 6564 206e 616d 652e   specified name.
-00002ce0: 0a0a 2020 2020 2020 2020 7365 7475 705f  ..        setup_
-00002cf0: 6d69 6c6c 696e 6728 7365 6c66 2c20 6d69  milling(self, mi
-00002d00: 6c6c 5f73 6574 7469 6e67 733a 2046 6962  ll_settings: Fib
-00002d10: 7365 6d4d 696c 6c69 6e67 5365 7474 696e  semMillingSettin
-00002d20: 6773 293a 0a20 2020 2020 2020 2020 2020  gs):.           
-00002d30: 2043 6f6e 6669 6775 7265 2074 6865 206d   Configure the m
-00002d40: 6963 726f 7363 6f70 6520 666f 7220 6d69  icroscope for mi
-00002d50: 6c6c 696e 6720 7573 696e 6720 7468 6520  lling using the 
-00002d60: 696f 6e20 6265 616d 2e0a 0a20 2020 2020  ion beam...     
-00002d70: 2020 2072 756e 5f6d 696c 6c69 6e67 2873     run_milling(s
-00002d80: 656c 662c 206d 696c 6c69 6e67 5f63 7572  elf, milling_cur
-00002d90: 7265 6e74 3a20 666c 6f61 742c 2061 7379  rent: float, asy
-00002da0: 6e63 683a 2062 6f6f 6c20 3d20 4661 6c73  nch: bool = Fals
-00002db0: 6529 3a0a 2020 2020 2020 2020 2020 2020  e):.            
-00002dc0: 5275 6e20 696f 6e20 6265 616d 206d 696c  Run ion beam mil
-00002dd0: 6c69 6e67 2075 7369 6e67 2074 6865 2073  ling using the s
-00002de0: 7065 6369 6669 6564 206d 696c 6c69 6e67  pecified milling
-00002df0: 2063 7572 7265 6e74 2e0a 0a20 2020 2020   current...     
-00002e00: 2020 2064 6566 2072 756e 5f6d 696c 6c69     def run_milli
-00002e10: 6e67 5f64 7269 6674 5f63 6f72 7265 6374  ng_drift_correct
-00002e20: 6564 2873 656c 662c 206d 696c 6c69 6e67  ed(self, milling
-00002e30: 5f63 7572 7265 6e74 3a20 666c 6f61 742c  _current: float,
-00002e40: 2069 6d61 6765 5f73 6574 7469 6e67 733a   image_settings:
-00002e50: 2049 6d61 6765 5365 7474 696e 6773 2c20   ImageSettings, 
-00002e60: 7265 665f 696d 6167 653a 2046 6962 7365  ref_image: Fibse
-00002e70: 6d49 6d61 6765 2c20 7265 6475 6365 645f  mImage, reduced_
-00002e80: 6172 6561 3a20 4669 6273 656d 5265 6374  area: FibsemRect
-00002e90: 616e 676c 6520 3d20 4e6f 6e65 2c20 6173  angle = None, as
-00002ea0: 796e 6368 3a20 626f 6f6c 203d 2046 616c  ynch: bool = Fal
-00002eb0: 7365 293a 0a20 2020 2020 2020 2020 2020  se):.           
-00002ec0: 2052 756e 2069 6f6e 2062 6561 6d20 6d69   Run ion beam mi
-00002ed0: 6c6c 696e 6720 7573 696e 6720 7468 6520  lling using the 
-00002ee0: 7370 6563 6966 6965 6420 6d69 6c6c 696e  specified millin
-00002ef0: 6720 6375 7272 656e 742c 2061 6e64 2063  g current, and c
-00002f00: 6f72 7265 6374 2066 6f72 2064 7269 6674  orrect for drift
-00002f10: 2075 7369 6e67 2074 6865 2070 726f 7669   using the provi
-00002f20: 6465 6420 7265 6665 7265 6e63 6520 696d  ded reference im
-00002f30: 6167 652e 0a20 2020 2020 2020 200a 2020  age..        .  
-00002f40: 2020 2020 2020 6669 6e69 7368 5f6d 696c        finish_mil
-00002f50: 6c69 6e67 2873 656c 662c 2069 6d61 6769  ling(self, imagi
-00002f60: 6e67 5f63 7572 7265 6e74 3a20 666c 6f61  ng_current: floa
-00002f70: 7429 3a0a 2020 2020 2020 2020 2020 2020  t):.            
-00002f80: 4669 6e61 6c69 7365 7320 7468 6520 6d69  Finalises the mi
-00002f90: 6c6c 696e 6720 7072 6f63 6573 7320 6279  lling process by
-00002fa0: 2063 6c65 6172 696e 6720 7468 6520 6d69   clearing the mi
-00002fb0: 6372 6f73 636f 7065 206f 6620 616e 7920  croscope of any 
-00002fc0: 7061 7474 6572 6e73 2061 6e64 2072 6574  patterns and ret
-00002fd0: 7572 6e69 6e67 2074 6865 2063 7572 7265  urning the curre
-00002fe0: 6e74 2074 6f20 7468 6520 696d 6167 696e  nt to the imagin
-00002ff0: 6720 6375 7272 656e 742e 0a0a 2020 2020  g current...    
-00003000: 2020 2020 6472 6177 5f72 6563 7461 6e67      draw_rectang
-00003010: 6c65 2873 656c 662c 2070 6174 7465 726e  le(self, pattern
-00003020: 5f73 6574 7469 6e67 733a 2046 6962 7365  _settings: Fibse
-00003030: 6d50 6174 7465 726e 5365 7474 696e 6773  mPatternSettings
-00003040: 293a 0a20 2020 2020 2020 2020 2020 2044  ):.            D
-00003050: 7261 7773 2061 2072 6563 7461 6e67 6c65  raws a rectangle
-00003060: 2070 6174 7465 726e 2075 7369 6e67 2074   pattern using t
-00003070: 6865 2063 7572 7265 6e74 2069 6f6e 2062  he current ion b
-00003080: 6561 6d2e 0a0a 2020 2020 2020 2020 6472  eam...        dr
-00003090: 6177 5f6c 696e 6528 7365 6c66 2c20 7061  aw_line(self, pa
-000030a0: 7474 6572 6e5f 7365 7474 696e 6773 3a20  ttern_settings: 
-000030b0: 4669 6273 656d 5061 7474 6572 6e53 6574  FibsemPatternSet
-000030c0: 7469 6e67 7329 3a0a 2020 2020 2020 2020  tings):.        
-000030d0: 2020 2020 4472 6177 7320 6120 6c69 6e65      Draws a line
-000030e0: 2070 6174 7465 726e 206f 6e20 7468 6520   pattern on the 
-000030f0: 6375 7272 656e 7420 696d 6167 696e 6720  current imaging 
-00003100: 7669 6577 206f 6620 7468 6520 6d69 6372  view of the micr
-00003110: 6f73 636f 7065 2e0a 0a20 2020 2020 2020  oscope...       
-00003120: 2064 7261 775f 6369 7263 6c65 2873 656c   draw_circle(sel
-00003130: 662c 2070 6174 7465 726e 5f73 6574 7469  f, pattern_setti
-00003140: 6e67 733a 2046 6962 7365 6d50 6174 7465  ngs: FibsemPatte
-00003150: 726e 5365 7474 696e 6773 293a 0a20 2020  rnSettings):.   
-00003160: 2020 2020 2020 2020 2044 7261 7773 2061           Draws a
-00003170: 2063 6972 6375 6c61 7220 7061 7474 6572   circular patter
-00003180: 6e20 6f6e 2074 6865 2063 7572 7265 6e74  n on the current
-00003190: 2069 6d61 6769 6e67 2076 6965 7720 6f66   imaging view of
-000031a0: 2074 6865 206d 6963 726f 7363 6f70 652e   the microscope.
-000031b0: 0a20 2020 2020 2020 200a 2020 2020 2020  .        .      
-000031c0: 2020 6472 6177 5f62 6974 6d61 705f 7061    draw_bitmap_pa
-000031d0: 7474 6572 6e28 7365 6c66 2c20 7061 7474  ttern(self, patt
-000031e0: 6572 6e5f 7365 7474 696e 6773 3a20 4669  ern_settings: Fi
-000031f0: 6273 656d 5061 7474 6572 6e53 6574 7469  bsemPatternSetti
-00003200: 6e67 732c 2070 6174 683a 2073 7472 293a  ngs, path: str):
-00003210: 0a20 2020 2020 2020 2020 2020 2044 7261  .            Dra
-00003220: 7773 2061 2062 6974 6d61 7020 7061 7474  ws a bitmap patt
-00003230: 6572 6e20 7573 696e 6720 7468 6520 7072  ern using the pr
-00003240: 6f76 6964 6564 2069 6d61 6765 2066 696c  ovided image fil
-00003250: 652e 200a 0a20 2020 2020 2020 2067 6574  e. ..        get
-00003260: 5f73 6361 6e5f 6469 7265 6374 696f 6e73  _scan_directions
-00003270: 2873 656c 6629 202d 3e20 6c69 7374 3a0a  (self) -> list:.
-00003280: 2020 2020 2020 2020 2020 2020 4765 7420              Get 
-00003290: 7468 6520 6176 6169 6c61 626c 6520 7363  the available sc
-000032a0: 616e 2064 6972 6563 7469 6f6e 7320 666f  an directions fo
-000032b0: 7220 6d69 6c6c 696e 672e 0a0a 2020 2020  r milling...    
-000032c0: 2020 2020 7365 7475 705f 7370 7574 7465      setup_sputte
-000032d0: 7228 7365 6c66 2c20 7072 6f74 6f63 6f6c  r(self, protocol
-000032e0: 3a20 6469 6374 293a 0a20 2020 2020 2020  : dict):.       
-000032f0: 2020 2020 2053 6574 2075 7020 7468 6520       Set up the 
-00003300: 7370 7574 7465 7220 636f 6174 696e 6720  sputter coating 
-00003310: 7072 6f63 6573 7320 6f6e 2074 6865 206d  process on the m
-00003320: 6963 726f 7363 6f70 652e 0a0a 2020 2020  icroscope...    
-00003330: 2020 2020 6472 6177 5f73 7075 7474 6572      draw_sputter
-00003340: 5f70 6174 7465 726e 2873 656c 662c 2068  _pattern(self, h
-00003350: 6677 3a20 666c 6f61 742c 206c 696e 655f  fw: float, line_
-00003360: 7061 7474 6572 6e5f 6c65 6e67 7468 3a20  pattern_length: 
-00003370: 666c 6f61 742c 2073 7075 7474 6572 5f74  float, sputter_t
-00003380: 696d 653a 2066 6c6f 6174 293a 0a20 2020  ime: float):.   
-00003390: 2020 2020 2020 2020 2044 7261 7773 2061           Draws a
-000033a0: 206c 696e 6520 7061 7474 6572 6e20 666f   line pattern fo
-000033b0: 7220 7370 7574 7465 7269 6e67 2077 6974  r sputtering wit
-000033c0: 6820 7468 6520 6769 7665 6e20 7061 7261  h the given para
-000033d0: 6d65 7465 7273 2e0a 0a20 2020 2020 2020  meters...       
-000033e0: 2072 756e 5f73 7075 7474 6572 2873 656c   run_sputter(sel
-000033f0: 662c 202a 2a6b 7761 7267 7329 3a0a 2020  f, **kwargs):.  
-00003400: 2020 2020 2020 2020 2020 5275 6e73 2074            Runs t
-00003410: 6865 2047 4953 2050 6c61 7469 6e75 6d20  he GIS Platinum 
-00003420: 5370 7574 7465 722e 0a0a 2020 2020 2020  Sputter...      
-00003430: 2020 6669 6e69 7368 5f73 7075 7474 6572    finish_sputter
-00003440: 2873 656c 662c 2061 7070 6c69 6361 7469  (self, applicati
-00003450: 6f6e 5f66 696c 653a 2073 7472 2920 2d3e  on_file: str) ->
-00003460: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-00003470: 2020 2046 696e 6973 6820 7468 6520 7370     Finish the sp
-00003480: 7574 7465 7220 7072 6f63 6573 7320 6279  utter process by
-00003490: 2063 6c65 6172 696e 6720 7061 7474 6572   clearing patter
-000034a0: 6e73 2061 6e64 2072 6573 6574 7469 6e67  ns and resetting
-000034b0: 2062 6561 6d20 616e 6420 696d 6167 696e   beam and imagin
-000034c0: 6720 7365 7474 696e 6773 2e0a 0a20 2020  g settings...   
-000034d0: 2020 2020 2073 6574 5f6d 6963 726f 7363       set_microsc
-000034e0: 6f70 655f 7374 6174 6528 7365 6c66 2c20  ope_state(self, 
-000034f0: 6d69 6372 6f73 636f 7065 5f73 7461 7465  microscope_state
-00003500: 3a20 4d69 6372 6f73 636f 7065 5374 6174  : MicroscopeStat
-00003510: 6529 202d 3e20 4e6f 6e65 3a0a 2020 2020  e) -> None:.    
-00003520: 2020 2020 2020 2020 5265 7365 7420 7468          Reset th
-00003530: 6520 6d69 6372 6f73 636f 7065 2073 7461  e microscope sta
-00003540: 7465 2074 6f20 7468 6520 7072 6f76 6964  te to the provid
-00003550: 6564 2073 7461 7465 2e0a 2020 2020 2020  ed state..      
-00003560: 2020 0a20 2020 2020 2020 2067 6574 2873    .        get(s
-00003570: 656c 662c 206b 6579 3a73 7472 2c20 6265  elf, key:str, be
-00003580: 616d 5f74 7970 653a 2042 6561 6d54 7970  am_type: BeamTyp
-00003590: 6520 3d20 4e6f 6e65 293a 0a20 2020 2020  e = None):.     
-000035a0: 2020 2020 2020 2052 6574 7572 6e73 2074         Returns t
-000035b0: 6865 2076 616c 7565 206f 6620 7468 6520  he value of the 
-000035c0: 7370 6563 6966 6965 6420 6b65 792e 0a0a  specified key...
-000035d0: 2020 2020 2020 2020 7365 7428 7365 6c66          set(self
-000035e0: 2c20 6b65 793a 2073 7472 2c20 7661 6c75  , key: str, valu
-000035f0: 652c 2062 6561 6d5f 7479 7065 3a20 4265  e, beam_type: Be
-00003600: 616d 5479 7065 203d 204e 6f6e 6529 202d  amType = None) -
-00003610: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
-00003620: 2020 2020 5365 7473 2074 6865 2076 616c      Sets the val
-00003630: 7565 206f 6620 7468 6520 7370 6563 6966  ue of the specif
-00003640: 6965 6420 6b65 792e 0a0a 2020 2020 4e65  ied key...    Ne
-00003650: 7720 6d65 7468 6f64 733a 0a20 2020 2020  w methods:.     
-00003660: 2020 205f 5f69 6e69 745f 5f28 7365 6c66     __init__(self
-00003670: 293a 200a 2020 2020 2020 2020 2020 2020  ): .            
-00003680: 496e 6974 6961 6c69 7a65 7320 6120 6e65  Initializes a ne
-00003690: 7720 696e 7374 616e 6365 206f 6620 7468  w instance of th
-000036a0: 6520 636c 6173 732e 0a0a 2020 2020 2020  e class...      
-000036b0: 2020 5f79 5f63 6f72 7265 6374 6564 5f73    _y_corrected_s
-000036c0: 7461 6765 5f6d 6f76 656d 656e 7428 7365  tage_movement(se
-000036d0: 6c66 2c20 7365 7474 696e 6773 3a20 4d69  lf, settings: Mi
-000036e0: 6372 6f73 636f 7065 5365 7474 696e 6773  croscopeSettings
-000036f0: 2c20 6578 7065 6374 6564 5f79 3a20 666c  , expected_y: fl
-00003700: 6f61 742c 2062 6561 6d5f 7479 7065 3a20  oat, beam_type: 
-00003710: 4265 616d 5479 7065 203d 2042 6561 6d54  BeamType = BeamT
-00003720: 7970 652e 454c 4543 5452 4f4e 2920 2d3e  ype.ELECTRON) ->
-00003730: 2046 6962 7365 6d53 7461 6765 506f 7369   FibsemStagePosi
-00003740: 7469 6f6e 3a0a 2020 2020 2020 2020 2020  tion:.          
-00003750: 2020 4361 6c63 756c 6174 6520 7468 6520    Calculate the 
-00003760: 7920 636f 7272 6563 7465 6420 7374 6167  y corrected stag
-00003770: 6520 6d6f 7665 6d65 6e74 2c20 636f 7272  e movement, corr
-00003780: 6563 7465 6420 666f 7220 7468 6520 6164  ected for the ad
-00003790: 6469 7469 6f6e 616c 2074 696c 7420 6f66  ditional tilt of
-000037a0: 2074 6865 2073 616d 706c 6520 686f 6c64   the sample hold
-000037b0: 6572 2028 7072 652d 7469 6c74 2061 6e67  er (pre-tilt ang
-000037c0: 6c65 292e 0a20 2020 2022 2222 0a0a 2020  le)..    """..  
-000037d0: 2020 6465 6620 5f5f 696e 6974 5f5f 2873    def __init__(s
-000037e0: 656c 6629 3a0a 2020 2020 2020 2020 7365  elf):.        se
-000037f0: 6c66 2e63 6f6e 6e65 6374 696f 6e20 3d20  lf.connection = 
-00003800: 5364 624d 6963 726f 7363 6f70 6543 6c69  SdbMicroscopeCli
-00003810: 656e 7428 290a 2020 2020 2020 2020 696d  ent().        im
-00003820: 706f 7274 2066 6962 7365 6d0a 2020 2020  port fibsem.    
-00003830: 2020 2020 6672 6f6d 2066 6962 7365 6d2e      from fibsem.
-00003840: 7574 696c 7320 696d 706f 7274 206c 6f61  utils import loa
-00003850: 645f 7072 6f74 6f63 6f6c 0a20 2020 2020  d_protocol.     
-00003860: 2020 2062 6173 655f 7061 7468 203d 206f     base_path = o
-00003870: 732e 7061 7468 2e64 6972 6e61 6d65 2866  s.path.dirname(f
-00003880: 6962 7365 6d2e 5f5f 7061 7468 5f5f 5b30  ibsem.__path__[0
-00003890: 5d29 0a20 2020 2020 2020 2073 656c 662e  ]).        self.
-000038a0: 6861 7264 7761 7265 5f73 6574 7469 6e67  hardware_setting
-000038b0: 7320 3d20 4669 6273 656d 4861 7264 7761  s = FibsemHardwa
-000038c0: 7265 2e5f 5f66 726f 6d5f 6469 6374 5f5f  re.__from_dict__
-000038d0: 286c 6f61 645f 7072 6f74 6f63 6f6c 286f  (load_protocol(o
-000038e0: 732e 7061 7468 2e6a 6f69 6e28 6261 7365  s.path.join(base
-000038f0: 5f70 6174 682c 2022 6669 6273 656d 222c  _path, "fibsem",
-00003900: 2022 636f 6e66 6967 222c 2022 6d6f 6465   "config", "mode
-00003910: 6c2e 7961 6d6c 2229 2929 0a0a 2020 2020  l.yaml")))..    
-00003920: 6465 6620 6469 7363 6f6e 6e65 6374 2873  def disconnect(s
-00003930: 656c 6629 3a0a 2020 2020 2020 2020 7365  elf):.        se
-00003940: 6c66 2e63 6f6e 6e65 6374 696f 6e2e 6469  lf.connection.di
-00003950: 7363 6f6e 6e65 6374 2829 0a20 2020 2020  sconnect().     
-00003960: 2020 2064 656c 2073 656c 662e 636f 6e6e     del self.conn
-00003970: 6563 7469 6f6e 0a20 2020 2020 2020 2073  ection.        s
-00003980: 656c 662e 636f 6e6e 6563 7469 6f6e 203d  elf.connection =
-00003990: 204e 6f6e 650a 2020 2020 2020 2020 6465   None.        de
-000039a0: 6c20 7365 6c66 2e63 6f6e 6e65 6374 696f  l self.connectio
-000039b0: 6e0a 2020 2020 2020 2020 7365 6c66 2e63  n.        self.c
-000039c0: 6f6e 6e65 6374 696f 6e20 3d20 4e6f 6e65  onnection = None
-000039d0: 0a0a 2020 2020 2320 4063 6c61 7373 6d65  ..    # @classme
-000039e0: 7468 6f64 0a20 2020 2064 6566 2063 6f6e  thod.    def con
-000039f0: 6e65 6374 5f74 6f5f 6d69 6372 6f73 636f  nect_to_microsco
-00003a00: 7065 2873 656c 662c 2069 705f 6164 6472  pe(self, ip_addr
-00003a10: 6573 733a 2073 7472 2c20 706f 7274 3a20  ess: str, port: 
-00003a20: 696e 7420 3d20 3735 3230 2920 2d3e 204e  int = 7520) -> N
-00003a30: 6f6e 653a 0a20 2020 2020 2020 2022 2222  one:.        """
-00003a40: 0a20 2020 2020 2020 2043 6f6e 6e65 6374  .        Connect
-00003a50: 2074 6f20 6120 5468 6572 6d6f 2046 6973   to a Thermo Fis
-00003a60: 6865 7220 6d69 6372 6f73 636f 7065 2061  her microscope a
-00003a70: 7420 7468 6520 7370 6563 6966 6965 6420  t the specified 
-00003a80: 4950 2061 6464 7265 7373 2061 6e64 2070  IP address and p
-00003a90: 6f72 742e 0a0a 2020 2020 2020 2020 4172  ort...        Ar
-00003aa0: 6773 3a0a 2020 2020 2020 2020 2020 2020  gs:.            
-00003ab0: 6970 5f61 6464 7265 7373 2028 7374 7229  ip_address (str)
-00003ac0: 3a20 5468 6520 4950 2061 6464 7265 7373  : The IP address
-00003ad0: 206f 6620 7468 6520 6d69 6372 6f73 636f   of the microsco
-00003ae0: 7065 2074 6f20 636f 6e6e 6563 7420 746f  pe to connect to
-00003af0: 2e0a 2020 2020 2020 2020 2020 2020 706f  ..            po
-00003b00: 7274 2028 696e 7429 3a20 5468 6520 706f  rt (int): The po
-00003b10: 7274 206e 756d 6265 7220 6f66 2074 6865  rt number of the
-00003b20: 206d 6963 726f 7363 6f70 6520 2864 6566   microscope (def
-00003b30: 6175 6c74 3a20 3735 3230 292e 0a0a 2020  ault: 7520)...  
-00003b40: 2020 2020 2020 5265 7475 726e 733a 0a20        Returns:. 
-00003b50: 2020 2020 2020 2020 2020 204e 6f6e 653a             None:
-00003b60: 2054 6869 7320 6675 6e63 7469 6f6e 2064   This function d
-00003b70: 6f65 736e 2774 2072 6574 7572 6e20 616e  oesn't return an
-00003b80: 7974 6869 6e67 2e0a 0a20 2020 2020 2020  ything...       
-00003b90: 2052 6169 7365 733a 0a20 2020 2020 2020   Raises:.       
-00003ba0: 2020 2020 2045 7863 6570 7469 6f6e 3a20       Exception: 
-00003bb0: 4966 2074 6865 7265 2773 2061 6e20 6572  If there's an er
-00003bc0: 726f 7220 7768 696c 6520 636f 6e6e 6563  ror while connec
-00003bd0: 7469 6e67 2074 6f20 7468 6520 6d69 6372  ting to the micr
-00003be0: 6f73 636f 7065 2e0a 0a20 2020 2020 2020  oscope...       
-00003bf0: 2045 7861 6d70 6c65 3a0a 2020 2020 2020   Example:.      
-00003c00: 2020 2020 2020 546f 2063 6f6e 6e65 6374        To connect
-00003c10: 2074 6f20 6120 6d69 6372 6f73 636f 7065   to a microscope
-00003c20: 2077 6974 6820 4950 2061 6464 7265 7373   with IP address
-00003c30: 2031 3932 2e31 3638 2e30 2e31 3020 616e   192.168.0.10 an
-00003c40: 6420 706f 7274 2037 3532 303a 0a0a 2020  d port 7520:..  
-00003c50: 2020 2020 2020 2020 2020 3e3e 3e20 6d69            >>> mi
-00003c60: 6372 6f73 636f 7065 203d 2054 6865 726d  croscope = Therm
-00003c70: 6f4d 6963 726f 7363 6f70 6528 290a 2020  oMicroscope().  
-00003c80: 2020 2020 2020 2020 2020 3e3e 3e20 6d69            >>> mi
-00003c90: 6372 6f73 636f 7065 2e63 6f6e 6e65 6374  croscope.connect
-00003ca0: 5f74 6f5f 6d69 6372 6f73 636f 7065 2822  _to_microscope("
-00003cb0: 3139 322e 3136 382e 302e 3130 222c 2037  192.168.0.10", 7
-00003cc0: 3532 3029 0a0a 2020 2020 2020 2020 2222  520)..        ""
-00003cd0: 220a 2020 2020 2020 2020 2320 544f 444f  ".        # TODO
-00003ce0: 3a20 6765 7420 7468 6520 706f 7274 0a20  : get the port. 
-00003cf0: 2020 2020 2020 206c 6f67 6769 6e67 2e69         logging.i
-00003d00: 6e66 6f28 6622 4d69 6372 6f73 636f 7065  nfo(f"Microscope
-00003d10: 2063 6c69 656e 7420 636f 6e6e 6563 7469   client connecti
-00003d20: 6e67 2074 6f20 5b7b 6970 5f61 6464 7265  ng to [{ip_addre
-00003d30: 7373 7d3a 7b70 6f72 747d 5d22 290a 2020  ss}:{port}]").  
-00003d40: 2020 2020 2020 7365 6c66 2e63 6f6e 6e65        self.conne
-00003d50: 6374 696f 6e2e 636f 6e6e 6563 7428 686f  ction.connect(ho
-00003d60: 7374 3d69 705f 6164 6472 6573 732c 2070  st=ip_address, p
-00003d70: 6f72 743d 706f 7274 290a 2020 2020 2020  ort=port).      
-00003d80: 2020 6c6f 6767 696e 672e 696e 666f 2866    logging.info(f
-00003d90: 224d 6963 726f 7363 6f70 6520 636c 6965  "Microscope clie
-00003da0: 6e74 2063 6f6e 6e65 6374 6564 2074 6f20  nt connected to 
-00003db0: 5b7b 6970 5f61 6464 7265 7373 7d3a 7b70  [{ip_address}:{p
-00003dc0: 6f72 747d 5d22 290a 2020 2020 2020 2020  ort}]").        
-00003dd0: 7365 6c66 2e73 6572 6961 6c5f 6e75 6d62  self.serial_numb
-00003de0: 6572 203d 2073 656c 662e 636f 6e6e 6563  er = self.connec
-00003df0: 7469 6f6e 2e73 6572 7669 6365 2e73 7973  tion.service.sys
-00003e00: 7465 6d2e 7365 7269 616c 5f6e 756d 6265  tem.serial_numbe
-00003e10: 720a 2020 2020 2020 2020 7365 6c66 2e6d  r.        self.m
-00003e20: 6f64 656c 203d 2073 656c 662e 636f 6e6e  odel = self.conn
-00003e30: 6563 7469 6f6e 2e73 6572 7669 6365 2e73  ection.service.s
-00003e40: 7973 7465 6d2e 6e61 6d65 0a20 2020 2020  ystem.name.     
-00003e50: 2020 2073 656c 662e 736f 6674 7761 7265     self.software
-00003e60: 5f76 6572 7369 6f6e 203d 2073 656c 662e  _version = self.
-00003e70: 636f 6e6e 6563 7469 6f6e 2e73 6572 7669  connection.servi
-00003e80: 6365 2e73 7973 7465 6d2e 7665 7273 696f  ce.system.versio
-00003e90: 6e0a 2020 2020 2020 2020 6c6f 6767 696e  n.        loggin
-00003ea0: 672e 696e 666f 2866 224d 6963 726f 7363  g.info(f"Microsc
-00003eb0: 6f70 6520 636c 6965 6e74 2063 6f6e 6e65  ope client conne
-00003ec0: 6374 6564 2074 6f20 6d6f 6465 6c20 7b73  cted to model {s
-00003ed0: 656c 662e 6d6f 6465 6c7d 2077 6974 6820  elf.model} with 
-00003ee0: 7365 7269 616c 206e 756d 6265 7220 7b73  serial number {s
-00003ef0: 656c 662e 7365 7269 616c 5f6e 756d 6265  elf.serial_numbe
-00003f00: 727d 2061 6e64 2073 6f66 7477 6172 6520  r} and software 
-00003f10: 7665 7273 696f 6e20 7b73 656c 662e 736f  version {self.so
-00003f20: 6674 7761 7265 5f76 6572 7369 6f6e 7d2e  ftware_version}.
-00003f30: 2229 0a0a 2020 2020 6465 6620 6163 7175  ")..    def acqu
-00003f40: 6972 655f 696d 6167 6528 7365 6c66 2c20  ire_image(self, 
-00003f50: 696d 6167 655f 7365 7474 696e 6773 3a49  image_settings:I
-00003f60: 6d61 6765 5365 7474 696e 6773 2920 2d3e  mageSettings) ->
-00003f70: 2046 6962 7365 6d49 6d61 6765 3a0a 2020   FibsemImage:.  
-00003f80: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-00003f90: 2020 4163 7175 6972 6520 6120 6e65 7720    Acquire a new 
-00003fa0: 696d 6167 6520 7769 7468 2074 6865 2073  image with the s
-00003fb0: 7065 6369 6669 6564 2073 6574 7469 6e67  pecified setting
-00003fc0: 732e 0a0a 2020 2020 2020 2020 2020 2020  s...            
-00003fd0: 4172 6773 3a0a 2020 2020 2020 2020 2020  Args:.          
-00003fe0: 2020 696d 6167 655f 7365 7474 696e 6773    image_settings
-00003ff0: 2028 496d 6167 6553 6574 7469 6e67 7329   (ImageSettings)
-00004000: 3a20 5468 6520 7365 7474 696e 6773 2066  : The settings f
-00004010: 6f72 2074 6865 206e 6577 2069 6d61 6765  or the new image
-00004020: 2e0a 0a20 2020 2020 2020 2052 6574 7572  ...        Retur
-00004030: 6e73 3a0a 2020 2020 2020 2020 2020 2020  ns:.            
-00004040: 4669 6273 656d 496d 6167 653a 2041 206e  FibsemImage: A n
-00004050: 6577 2046 6962 7365 6d49 6d61 6765 206f  ew FibsemImage o
-00004060: 626a 6563 7420 7265 7072 6573 656e 7469  bject representi
-00004070: 6e67 2074 6865 2061 6371 7569 7265 6420  ng the acquired 
-00004080: 696d 6167 652e 0a20 2020 2020 2020 2022  image..        "
-00004090: 2222 0a20 2020 2020 2020 205f 6368 6563  "".        _chec
-000040a0: 6b5f 6265 616d 2862 6561 6d5f 7479 7065  k_beam(beam_type
-000040b0: 203d 2069 6d61 6765 5f73 6574 7469 6e67   = image_setting
-000040c0: 732e 6265 616d 5f74 7970 652c 2068 6172  s.beam_type, har
-000040d0: 6477 6172 655f 7365 7474 696e 6773 203d  dware_settings =
-000040e0: 2073 656c 662e 6861 7264 7761 7265 5f73   self.hardware_s
-000040f0: 6574 7469 6e67 7329 0a20 2020 2020 2020  ettings).       
-00004100: 2023 2073 6574 2066 7261 6d65 2073 6574   # set frame set
-00004110: 7469 6e67 730a 2020 2020 2020 2020 6966  tings.        if
-00004120: 2069 6d61 6765 5f73 6574 7469 6e67 732e   image_settings.
-00004130: 7265 6475 6365 645f 6172 6561 2069 7320  reduced_area is 
-00004140: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
-00004150: 2020 2020 2020 7265 6475 6365 645f 6172        reduced_ar
-00004160: 6561 203d 2069 6d61 6765 5f73 6574 7469  ea = image_setti
-00004170: 6e67 732e 7265 6475 6365 645f 6172 6561  ngs.reduced_area
-00004180: 2e5f 5f74 6f5f 4645 495f 5f28 290a 2020  .__to_FEI__().  
-00004190: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-000041a0: 2020 2020 2020 2020 7265 6475 6365 645f          reduced_
-000041b0: 6172 6561 203d 204e 6f6e 650a 2020 2020  area = None.    
-000041c0: 2020 2020 2020 2020 6966 2069 6d61 6765          if image
-000041d0: 5f73 6574 7469 6e67 732e 6265 616d 5f74  _settings.beam_t
-000041e0: 7970 6520 3d3d 2042 6561 6d54 7970 652e  ype == BeamType.
-000041f0: 454c 4543 5452 4f4e 3a0a 2020 2020 2020  ELECTRON:.      
-00004200: 2020 2020 2020 2020 2020 7365 6c66 2e63            self.c
-00004210: 6f6e 6e65 6374 696f 6e2e 6265 616d 732e  onnection.beams.
-00004220: 656c 6563 7472 6f6e 5f62 6561 6d2e 7363  electron_beam.sc
-00004230: 616e 6e69 6e67 2e6d 6f64 652e 7365 745f  anning.mode.set_
-00004240: 6675 6c6c 5f66 7261 6d65 2829 0a20 2020  full_frame().   
-00004250: 2020 2020 2020 2020 2069 6620 696d 6167           if imag
-00004260: 655f 7365 7474 696e 6773 2e62 6561 6d5f  e_settings.beam_
-00004270: 7479 7065 203d 3d20 4265 616d 5479 7065  type == BeamType
-00004280: 2e49 4f4e 203a 0a20 2020 2020 2020 2020  .ION :.         
-00004290: 2020 2020 2020 2073 656c 662e 636f 6e6e         self.conn
-000042a0: 6563 7469 6f6e 2e62 6561 6d73 2e69 6f6e  ection.beams.ion
-000042b0: 5f62 6561 6d2e 7363 616e 6e69 6e67 2e6d  _beam.scanning.m
-000042c0: 6f64 652e 7365 745f 6675 6c6c 5f66 7261  ode.set_full_fra
-000042d0: 6d65 2829 0a20 2020 2020 2020 200a 2020  me().        .  
-000042e0: 2020 2020 2020 6672 616d 655f 7365 7474        frame_sett
-000042f0: 696e 6773 203d 2047 7261 6246 7261 6d65  ings = GrabFrame
-00004300: 5365 7474 696e 6773 280a 2020 2020 2020  Settings(.      
-00004310: 2020 2020 2020 7265 736f 6c75 7469 6f6e        resolution
-00004320: 3d66 227b 696d 6167 655f 7365 7474 696e  =f"{image_settin
-00004330: 6773 2e72 6573 6f6c 7574 696f 6e5b 305d  gs.resolution[0]
-00004340: 7d78 7b69 6d61 6765 5f73 6574 7469 6e67  }x{image_setting
-00004350: 732e 7265 736f 6c75 7469 6f6e 5b31 5d7d  s.resolution[1]}
-00004360: 222c 0a20 2020 2020 2020 2020 2020 2064  ",.            d
-00004370: 7765 6c6c 5f74 696d 653d 696d 6167 655f  well_time=image_
-00004380: 7365 7474 696e 6773 2e64 7765 6c6c 5f74  settings.dwell_t
-00004390: 696d 652c 0a20 2020 2020 2020 2020 2020  ime,.           
-000043a0: 2072 6564 7563 6564 5f61 7265 613d 7265   reduced_area=re
-000043b0: 6475 6365 645f 6172 6561 2c0a 2020 2020  duced_area,.    
-000043c0: 2020 2020 290a 0a20 2020 2020 2020 2069      )..        i
-000043d0: 6620 696d 6167 655f 7365 7474 696e 6773  f image_settings
-000043e0: 2e62 6561 6d5f 7479 7065 203d 3d20 4265  .beam_type == Be
-000043f0: 616d 5479 7065 2e45 4c45 4354 524f 4e3a  amType.ELECTRON:
-00004400: 0a20 2020 2020 2020 2020 2020 2068 6677  .            hfw
-00004410: 5f6c 696d 6974 7320 3d20 280a 2020 2020  _limits = (.    
-00004420: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00004430: 2e63 6f6e 6e65 6374 696f 6e2e 6265 616d  .connection.beam
-00004440: 732e 656c 6563 7472 6f6e 5f62 6561 6d2e  s.electron_beam.
-00004450: 686f 7269 7a6f 6e74 616c 5f66 6965 6c64  horizontal_field
-00004460: 5f77 6964 7468 2e6c 696d 6974 730a 2020  _width.limits.  
-00004470: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-00004480: 2020 2020 2020 2020 696d 6167 655f 7365          image_se
-00004490: 7474 696e 6773 2e68 6677 203d 206e 702e  ttings.hfw = np.
-000044a0: 636c 6970 280a 2020 2020 2020 2020 2020  clip(.          
-000044b0: 2020 2020 2020 696d 6167 655f 7365 7474        image_sett
-000044c0: 696e 6773 2e68 6677 2c20 6866 775f 6c69  ings.hfw, hfw_li
-000044d0: 6d69 7473 2e6d 696e 2c20 6866 775f 6c69  mits.min, hfw_li
-000044e0: 6d69 7473 2e6d 6178 0a20 2020 2020 2020  mits.max.       
-000044f0: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
-00004500: 2020 2073 656c 662e 636f 6e6e 6563 7469     self.connecti
-00004510: 6f6e 2e62 6561 6d73 2e65 6c65 6374 726f  on.beams.electro
-00004520: 6e5f 6265 616d 2e68 6f72 697a 6f6e 7461  n_beam.horizonta
-00004530: 6c5f 6669 656c 645f 7769 6474 682e 7661  l_field_width.va
-00004540: 6c75 6520 3d20 280a 2020 2020 2020 2020  lue = (.        
-00004550: 2020 2020 2020 2020 696d 6167 655f 7365          image_se
-00004560: 7474 696e 6773 2e68 6677 0a20 2020 2020  ttings.hfw.     
-00004570: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
-00004580: 2020 6966 2069 6d61 6765 5f73 6574 7469    if image_setti
-00004590: 6e67 732e 6265 616d 5f74 7970 6520 3d3d  ngs.beam_type ==
-000045a0: 2042 6561 6d54 7970 652e 494f 4e3a 0a20   BeamType.ION:. 
-000045b0: 2020 2020 2020 2020 2020 2068 6677 5f6c             hfw_l
-000045c0: 696d 6974 7320 3d20 7365 6c66 2e63 6f6e  imits = self.con
-000045d0: 6e65 6374 696f 6e2e 6265 616d 732e 696f  nection.beams.io
-000045e0: 6e5f 6265 616d 2e68 6f72 697a 6f6e 7461  n_beam.horizonta
-000045f0: 6c5f 6669 656c 645f 7769 6474 682e 6c69  l_field_width.li
-00004600: 6d69 7473 0a20 2020 2020 2020 2020 2020  mits.           
-00004610: 2069 6d61 6765 5f73 6574 7469 6e67 732e   image_settings.
-00004620: 6866 7720 3d20 6e70 2e63 6c69 7028 0a20  hfw = np.clip(. 
-00004630: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00004640: 6d61 6765 5f73 6574 7469 6e67 732e 6866  mage_settings.hf
-00004650: 772c 2068 6677 5f6c 696d 6974 732e 6d69  w, hfw_limits.mi
-00004660: 6e2c 2068 6677 5f6c 696d 6974 732e 6d61  n, hfw_limits.ma
-00004670: 780a 2020 2020 2020 2020 2020 2020 290a  x.            ).
-00004680: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00004690: 2e63 6f6e 6e65 6374 696f 6e2e 6265 616d  .connection.beam
-000046a0: 732e 696f 6e5f 6265 616d 2e68 6f72 697a  s.ion_beam.horiz
-000046b0: 6f6e 7461 6c5f 6669 656c 645f 7769 6474  ontal_field_widt
-000046c0: 682e 7661 6c75 6520 3d20 280a 2020 2020  h.value = (.    
-000046d0: 2020 2020 2020 2020 2020 2020 696d 6167              imag
-000046e0: 655f 7365 7474 696e 6773 2e68 6677 0a20  e_settings.hfw. 
-000046f0: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
-00004700: 2020 2020 2020 6c6f 6767 696e 672e 696e        logging.in
-00004710: 666f 2866 2261 6371 7569 7269 6e67 206e  fo(f"acquiring n
-00004720: 6577 207b 696d 6167 655f 7365 7474 696e  ew {image_settin
-00004730: 6773 2e62 6561 6d5f 7479 7065 2e6e 616d  gs.beam_type.nam
-00004740: 657d 2069 6d61 6765 2e22 290a 2020 2020  e} image.").    
-00004750: 2020 2020 7365 6c66 2e63 6f6e 6e65 6374      self.connect
-00004760: 696f 6e2e 696d 6167 696e 672e 7365 745f  ion.imaging.set_
-00004770: 6163 7469 7665 5f76 6965 7728 696d 6167  active_view(imag
-00004780: 655f 7365 7474 696e 6773 2e62 6561 6d5f  e_settings.beam_
-00004790: 7479 7065 2e76 616c 7565 290a 2020 2020  type.value).    
-000047a0: 2020 2020 7365 6c66 2e63 6f6e 6e65 6374      self.connect
-000047b0: 696f 6e2e 696d 6167 696e 672e 7365 745f  ion.imaging.set_
-000047c0: 6163 7469 7665 5f64 6576 6963 6528 696d  active_device(im
-000047d0: 6167 655f 7365 7474 696e 6773 2e62 6561  age_settings.bea
-000047e0: 6d5f 7479 7065 2e76 616c 7565 290a 2020  m_type.value).  
-000047f0: 2020 2020 2020 696d 6167 6520 3d20 7365        image = se
-00004800: 6c66 2e63 6f6e 6e65 6374 696f 6e2e 696d  lf.connection.im
-00004810: 6167 696e 672e 6772 6162 5f66 7261 6d65  aging.grab_frame
-00004820: 2866 7261 6d65 5f73 6574 7469 6e67 7329  (frame_settings)
-00004830: 0a0a 2020 2020 2020 2020 6966 2069 6d61  ..        if ima
-00004840: 6765 5f73 6574 7469 6e67 732e 7265 6475  ge_settings.redu
-00004850: 6365 645f 6172 6561 2069 7320 6e6f 7420  ced_area is not 
-00004860: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-00004870: 2020 6966 2069 6d61 6765 5f73 6574 7469    if image_setti
-00004880: 6e67 732e 6265 616d 5f74 7970 6520 3d3d  ngs.beam_type ==
-00004890: 2042 6561 6d54 7970 652e 454c 4543 5452   BeamType.ELECTR
-000048a0: 4f4e 3a0a 2020 2020 2020 2020 2020 2020  ON:.            
-000048b0: 2020 2020 7365 6c66 2e63 6f6e 6e65 6374      self.connect
-000048c0: 696f 6e2e 6265 616d 732e 656c 6563 7472  ion.beams.electr
-000048d0: 6f6e 5f62 6561 6d2e 7363 616e 6e69 6e67  on_beam.scanning
-000048e0: 2e6d 6f64 652e 7365 745f 6675 6c6c 5f66  .mode.set_full_f
-000048f0: 7261 6d65 2829 0a20 2020 2020 2020 2020  rame().         
-00004900: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00004910: 2020 2020 2020 2020 2073 656c 662e 636f           self.co
-00004920: 6e6e 6563 7469 6f6e 2e62 6561 6d73 2e69  nnection.beams.i
-00004930: 6f6e 5f62 6561 6d2e 7363 616e 6e69 6e67  on_beam.scanning
-00004940: 2e6d 6f64 652e 7365 745f 6675 6c6c 5f66  .mode.set_full_f
-00004950: 7261 6d65 2829 0a0a 2020 2020 2020 2020  rame()..        
-00004960: 7374 6174 6520 3d20 7365 6c66 2e67 6574  state = self.get
-00004970: 5f63 7572 7265 6e74 5f6d 6963 726f 7363  _current_microsc
-00004980: 6f70 655f 7374 6174 6528 290a 0a20 2020  ope_state()..   
-00004990: 2020 2020 2064 6574 6563 746f 7220 3d20       detector = 
-000049a0: 4669 6273 656d 4465 7465 6374 6f72 5365  FibsemDetectorSe
-000049b0: 7474 696e 6773 280a 2020 2020 2020 2020  ttings(.        
-000049c0: 2020 2020 2020 2020 7479 7065 203d 2073          type = s
-000049d0: 656c 662e 6765 7428 2264 6574 6563 746f  elf.get("detecto
-000049e0: 725f 7479 7065 222c 2069 6d61 6765 5f73  r_type", image_s
-000049f0: 6574 7469 6e67 732e 6265 616d 5f74 7970  ettings.beam_typ
-00004a00: 6529 2c0a 2020 2020 2020 2020 2020 2020  e),.            
-00004a10: 2020 2020 6d6f 6465 203d 2073 656c 662e      mode = self.
-00004a20: 6765 7428 2264 6574 6563 746f 725f 6d6f  get("detector_mo
-00004a30: 6465 222c 2069 6d61 6765 5f73 6574 7469  de", image_setti
-00004a40: 6e67 732e 6265 616d 5f74 7970 6529 2c0a  ngs.beam_type),.
-00004a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004a60: 636f 6e74 7261 7374 203d 2073 656c 662e  contrast = self.
-00004a70: 6765 7428 2264 6574 6563 746f 725f 636f  get("detector_co
-00004a80: 6e74 7261 7374 222c 2069 6d61 6765 5f73  ntrast", image_s
-00004a90: 6574 7469 6e67 732e 6265 616d 5f74 7970  ettings.beam_typ
-00004aa0: 6529 2c0a 2020 2020 2020 2020 2020 2020  e),.            
-00004ab0: 2020 2020 6272 6967 6874 6e65 7373 3d20      brightness= 
-00004ac0: 7365 6c66 2e67 6574 2822 6465 7465 6374  self.get("detect
-00004ad0: 6f72 5f62 7269 6768 746e 6573 7322 2c20  or_brightness", 
-00004ae0: 696d 6167 655f 7365 7474 696e 6773 2e62  image_settings.b
-00004af0: 6561 6d5f 7479 7065 292c 0a0a 2020 2020  eam_type),..    
-00004b00: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
-00004b10: 2020 2066 6962 7365 6d5f 696d 6167 6520     fibsem_image 
-00004b20: 3d20 4669 6273 656d 496d 6167 652e 6672  = FibsemImage.fr
-00004b30: 6f6d 4164 6f72 6e65 6449 6d61 6765 280a  omAdornedImage(.
-00004b40: 2020 2020 2020 2020 2020 2020 636f 7079              copy
-00004b50: 2e64 6565 7063 6f70 7928 696d 6167 6529  .deepcopy(image)
-00004b60: 2c20 636f 7079 2e64 6565 7063 6f70 7928  , copy.deepcopy(
-00004b70: 696d 6167 655f 7365 7474 696e 6773 292c  image_settings),
-00004b80: 2063 6f70 792e 6465 6570 636f 7079 2873   copy.deepcopy(s
-00004b90: 7461 7465 292c 2064 6574 6563 746f 7220  tate), detector 
-00004ba0: 3d20 6465 7465 6374 6f72 0a20 2020 2020  = detector.     
-00004bb0: 2020 2029 0a0a 2020 2020 2020 2020 7265     )..        re
-00004bc0: 7475 726e 2066 6962 7365 6d5f 696d 6167  turn fibsem_imag
-00004bd0: 650a 0a20 2020 2064 6566 206c 6173 745f  e..    def last_
-00004be0: 696d 6167 6528 7365 6c66 2c20 6265 616d  image(self, beam
-00004bf0: 5f74 7970 653a 2042 6561 6d54 7970 6520  _type: BeamType 
-00004c00: 3d20 4265 616d 5479 7065 2e45 4c45 4354  = BeamType.ELECT
-00004c10: 524f 4e29 202d 3e20 4669 6273 656d 496d  RON) -> FibsemIm
-00004c20: 6167 653a 0a20 2020 2020 2020 2022 2222  age:.        """
-00004c30: 0a20 2020 2020 2020 2047 6574 2074 6865  .        Get the
-00004c40: 206c 6173 7420 7072 6576 696f 7573 6c79   last previously
-00004c50: 2061 6371 7569 7265 6420 696d 6167 652e   acquired image.
-00004c60: 0a0a 2020 2020 2020 2020 4172 6773 3a0a  ..        Args:.
-00004c70: 2020 2020 2020 2020 2020 2020 6265 616d              beam
-00004c80: 5f74 7970 6520 2842 6561 6d54 7970 652c  _type (BeamType,
-00004c90: 206f 7074 696f 6e61 6c29 3a20 5468 6520   optional): The 
-00004ca0: 696d 6167 696e 6720 6265 616d 2074 7970  imaging beam typ
-00004cb0: 6520 6f66 2074 6865 206c 6173 7420 696d  e of the last im
-00004cc0: 6167 652e 0a20 2020 2020 2020 2020 2020  age..           
-00004cd0: 2020 2020 2044 6566 6175 6c74 7320 746f       Defaults to
-00004ce0: 2042 6561 6d54 7970 652e 454c 4543 5452   BeamType.ELECTR
-00004cf0: 4f4e 2e0a 0a20 2020 2020 2020 2052 6574  ON...        Ret
-00004d00: 7572 6e73 3a0a 2020 2020 2020 2020 2020  urns:.          
-00004d10: 2020 4669 6273 656d 496d 6167 653a 2041    FibsemImage: A
-00004d20: 206e 6577 2046 6962 7365 6d49 6d61 6765   new FibsemImage
-00004d30: 206f 626a 6563 7420 7265 7072 6573 656e   object represen
-00004d40: 7469 6e67 2074 6865 206c 6173 7420 6163  ting the last ac
-00004d50: 7175 6972 6564 2069 6d61 6765 2e0a 0a20  quired image... 
-00004d60: 2020 2020 2020 2052 6169 7365 733a 0a20         Raises:. 
-00004d70: 2020 2020 2020 2020 2020 2045 7863 6570             Excep
-00004d80: 7469 6f6e 3a20 4966 2074 6865 7265 2773  tion: If there's
-00004d90: 2061 6e20 6572 726f 7220 7768 696c 6520   an error while 
-00004da0: 6765 7474 696e 6720 7468 6520 6c61 7374  getting the last
-00004db0: 2069 6d61 6765 2e0a 2020 2020 2020 2020   image..        
-00004dc0: 2222 220a 2020 2020 2020 2020 5f63 6865  """.        _che
-00004dd0: 636b 5f62 6561 6d28 6265 616d 5f74 7970  ck_beam(beam_typ
-00004de0: 6520 3d20 6265 616d 5f74 7970 652c 2068  e = beam_type, h
-00004df0: 6172 6477 6172 655f 7365 7474 696e 6773  ardware_settings
-00004e00: 203d 2073 656c 662e 6861 7264 7761 7265   = self.hardware
-00004e10: 5f73 6574 7469 6e67 7329 2020 2020 2020  _settings)      
-00004e20: 2020 0a20 2020 2020 2020 2073 656c 662e    .        self.
-00004e30: 636f 6e6e 6563 7469 6f6e 2e69 6d61 6769  connection.imagi
-00004e40: 6e67 2e73 6574 5f61 6374 6976 655f 7669  ng.set_active_vi
-00004e50: 6577 2862 6561 6d5f 7479 7065 2e76 616c  ew(beam_type.val
-00004e60: 7565 290a 2020 2020 2020 2020 7365 6c66  ue).        self
-00004e70: 2e63 6f6e 6e65 6374 696f 6e2e 696d 6167  .connection.imag
-00004e80: 696e 672e 7365 745f 6163 7469 7665 5f64  ing.set_active_d
-00004e90: 6576 6963 6528 6265 616d 5f74 7970 652e  evice(beam_type.
-00004ea0: 7661 6c75 6529 0a20 2020 2020 2020 2069  value).        i
-00004eb0: 6d61 6765 203d 2073 656c 662e 636f 6e6e  mage = self.conn
-00004ec0: 6563 7469 6f6e 2e69 6d61 6769 6e67 2e67  ection.imaging.g
-00004ed0: 6574 5f69 6d61 6765 2829 0a0a 2020 2020  et_image()..    
-00004ee0: 2020 2020 7374 6174 6520 3d20 7365 6c66      state = self
-00004ef0: 2e67 6574 5f63 7572 7265 6e74 5f6d 6963  .get_current_mic
-00004f00: 726f 7363 6f70 655f 7374 6174 6528 290a  roscope_state().
-00004f10: 0a20 2020 2020 2020 2069 6d61 6765 5f73  .        image_s
-00004f20: 6574 7469 6e67 7320 3d20 4669 6273 656d  ettings = Fibsem
-00004f30: 496d 6167 654d 6574 6164 6174 612e 696d  ImageMetadata.im
-00004f40: 6167 655f 7365 7474 696e 6773 5f66 726f  age_settings_fro
-00004f50: 6d5f 6164 6f72 6e65 6428 0a20 2020 2020  m_adorned(.     
-00004f60: 2020 2020 2020 2069 6d61 6765 2c20 6265         image, be
-00004f70: 616d 5f74 7970 650a 2020 2020 2020 2020  am_type.        
-00004f80: 290a 0a20 2020 2020 2020 2064 6574 6563  )..        detec
-00004f90: 746f 7220 3d20 4669 6273 656d 4465 7465  tor = FibsemDete
-00004fa0: 6374 6f72 5365 7474 696e 6773 280a 2020  ctorSettings(.  
-00004fb0: 2020 2020 2020 2020 2020 2020 2020 7479                ty
-00004fc0: 7065 203d 2073 656c 662e 6765 7428 2264  pe = self.get("d
-00004fd0: 6574 6563 746f 725f 7479 7065 222c 2062  etector_type", b
-00004fe0: 6561 6d5f 7479 7065 292c 0a20 2020 2020  eam_type),.     
-00004ff0: 2020 2020 2020 2020 2020 206d 6f64 6520             mode 
-00005000: 3d20 7365 6c66 2e67 6574 2822 6465 7465  = self.get("dete
-00005010: 6374 6f72 5f6d 6f64 6522 2c20 6265 616d  ctor_mode", beam
-00005020: 5f74 7970 6529 2c0a 2020 2020 2020 2020  _type),.        
-00005030: 2020 2020 2020 2020 636f 6e74 7261 7374          contrast
-00005040: 203d 2073 656c 662e 6765 7428 2264 6574   = self.get("det
-00005050: 6563 746f 725f 636f 6e74 7261 7374 222c  ector_contrast",
-00005060: 2062 6561 6d5f 7479 7065 292c 0a20 2020   beam_type),.   
-00005070: 2020 2020 2020 2020 2020 2020 2062 7269               bri
-00005080: 6768 746e 6573 733d 2073 656c 662e 6765  ghtness= self.ge
-00005090: 7428 2264 6574 6563 746f 725f 6272 6967  t("detector_brig
-000050a0: 6874 6e65 7373 222c 2062 6561 6d5f 7479  htness", beam_ty
-000050b0: 7065 292c 0a0a 2020 2020 2020 2020 2020  pe),..          
-000050c0: 2020 290a 0a20 2020 2020 2020 2066 6962    )..        fib
-000050d0: 7365 6d5f 696d 6167 6520 3d20 4669 6273  sem_image = Fibs
-000050e0: 656d 496d 6167 652e 6672 6f6d 4164 6f72  emImage.fromAdor
-000050f0: 6e65 6449 6d61 6765 2869 6d61 6765 2c20  nedImage(image, 
-00005100: 696d 6167 655f 7365 7474 696e 6773 2c20  image_settings, 
-00005110: 7374 6174 652c 2064 6574 6563 746f 7220  state, detector 
-00005120: 3d20 6465 7465 6374 6f72 2920 0a0a 2020  = detector) ..  
-00005130: 2020 2020 2020 7265 7475 726e 2066 6962        return fib
-00005140: 7365 6d5f 696d 6167 650a 0a20 2020 2064  sem_image..    d
-00005150: 6566 2061 7574 6f63 6f6e 7472 6173 7428  ef autocontrast(
-00005160: 7365 6c66 2c20 6265 616d 5f74 7970 653d  self, beam_type=
-00005170: 4265 616d 5479 7065 2e45 4c45 4354 524f  BeamType.ELECTRO
-00005180: 4e29 202d 3e20 4e6f 6e65 3a0a 2020 2020  N) -> None:.    
-00005190: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-000051a0: 4175 746f 6d61 7469 6361 6c6c 7920 6164  Automatically ad
-000051b0: 6a75 7374 2074 6865 206d 6963 726f 7363  just the microsc
-000051c0: 6f70 6520 696d 6167 6520 636f 6e74 7261  ope image contra
-000051d0: 7374 2066 6f72 2074 6865 2073 7065 6369  st for the speci
-000051e0: 6669 6564 2062 6561 6d20 7479 7065 2e0a  fied beam type..
-000051f0: 0a20 2020 2020 2020 2041 7267 733a 0a20  .        Args:. 
-00005200: 2020 2020 2020 2020 2020 2062 6561 6d5f             beam_
-00005210: 7479 7065 2028 4265 616d 5479 7065 2c20  type (BeamType, 
-00005220: 6f70 7469 6f6e 616c 293a 2054 6865 2069  optional): The i
-00005230: 6d61 6769 6e67 2062 6561 6d20 7479 7065  maging beam type
-00005240: 2066 6f72 2077 6869 6368 2074 6f20 6164   for which to ad
-00005250: 6a75 7374 2074 6865 2063 6f6e 7472 6173  just the contras
-00005260: 742e 0a20 2020 2020 2020 2020 2020 2020  t..             
-00005270: 2020 2044 6566 6175 6c74 7320 746f 2042     Defaults to B
-00005280: 6561 6d54 7970 652e 454c 4543 5452 4f4e  eamType.ELECTRON
-00005290: 2e0a 0a20 2020 2020 2020 2052 6574 7572  ...        Retur
-000052a0: 6e73 3a0a 2020 2020 2020 2020 2020 2020  ns:.            
-000052b0: 4e6f 6e65 0a0a 2020 2020 2020 2020 4578  None..        Ex
-000052c0: 616d 706c 653a 0a20 2020 2020 2020 2020  ample:.         
-000052d0: 2020 2054 6f20 6175 746f 6d61 7469 6361     To automatica
-000052e0: 6c6c 7920 6164 6a75 7374 2074 6865 2069  lly adjust the i
-000052f0: 6d61 6765 2063 6f6e 7472 6173 7420 666f  mage contrast fo
-00005300: 7220 616e 2069 6f6e 2062 6561 6d20 7479  r an ion beam ty
-00005310: 7065 3a0a 0a20 2020 2020 2020 2020 2020  pe:..           
-00005320: 203e 3e3e 206d 6963 726f 7363 6f70 6520   >>> microscope 
-00005330: 3d20 5468 6572 6d6f 4d69 6372 6f73 636f  = ThermoMicrosco
-00005340: 7065 2829 0a20 2020 2020 2020 2020 2020  pe().           
-00005350: 203e 3e3e 206d 6963 726f 7363 6f70 652e   >>> microscope.
-00005360: 636f 6e6e 6563 745f 746f 5f6d 6963 726f  connect_to_micro
-00005370: 7363 6f70 6528 290a 2020 2020 2020 2020  scope().        
-00005380: 2020 2020 3e3e 3e20 6d69 6372 6f73 636f      >>> microsco
-00005390: 7065 2e61 7574 6f63 6f6e 7472 6173 7428  pe.autocontrast(
-000053a0: 6265 616d 5f74 7970 653d 4265 616d 5479  beam_type=BeamTy
-000053b0: 7065 2e49 4f4e 290a 0a20 2020 2020 2020  pe.ION)..       
-000053c0: 2022 2222 0a20 2020 2020 2020 205f 6368   """.        _ch
-000053d0: 6563 6b5f 6265 616d 2862 6561 6d5f 7479  eck_beam(beam_ty
-000053e0: 7065 203d 2062 6561 6d5f 7479 7065 2c20  pe = beam_type, 
-000053f0: 6861 7264 7761 7265 5f73 6574 7469 6e67  hardware_setting
-00005400: 7320 3d20 7365 6c66 2e68 6172 6477 6172  s = self.hardwar
-00005410: 655f 7365 7474 696e 6773 290a 2020 2020  e_settings).    
-00005420: 2020 2020 6c6f 6767 696e 672e 696e 666f      logging.info
-00005430: 2866 2252 756e 6e69 6e67 2061 7574 6f63  (f"Running autoc
-00005440: 6f6e 7472 6173 7420 6f6e 207b 6265 616d  ontrast on {beam
-00005450: 5f74 7970 652e 6e61 6d65 7d2e 2229 0a20  _type.name}."). 
-00005460: 2020 2020 2020 2073 656c 662e 636f 6e6e         self.conn
-00005470: 6563 7469 6f6e 2e69 6d61 6769 6e67 2e73  ection.imaging.s
-00005480: 6574 5f61 6374 6976 655f 7669 6577 2862  et_active_view(b
-00005490: 6561 6d5f 7479 7065 2e76 616c 7565 290a  eam_type.value).
-000054a0: 2020 2020 2020 2020 7365 6c66 2e63 6f6e          self.con
-000054b0: 6e65 6374 696f 6e2e 696d 6167 696e 672e  nection.imaging.
-000054c0: 7365 745f 6163 7469 7665 5f64 6576 6963  set_active_devic
-000054d0: 6528 6265 616d 5f74 7970 652e 7661 6c75  e(beam_type.valu
-000054e0: 6529 0a20 2020 2020 2020 2073 656c 662e  e).        self.
-000054f0: 636f 6e6e 6563 7469 6f6e 2e61 7574 6f5f  connection.auto_
-00005500: 6675 6e63 7469 6f6e 732e 7275 6e5f 6175  functions.run_au
-00005510: 746f 5f63 6228 290a 0a20 2020 2064 6566  to_cb()..    def
-00005520: 2061 7574 6f5f 666f 6375 7328 7365 6c66   auto_focus(self
-00005530: 2c20 6265 616d 5f74 7970 653a 2042 6561  , beam_type: Bea
-00005540: 6d54 7970 6529 202d 3e20 4e6f 6e65 3a0a  mType) -> None:.
-00005550: 2020 2020 2020 2020 2222 2241 7574 6f6d          """Autom
-00005560: 6174 6963 616c 6c79 2066 6f63 7573 2074  atically focus t
-00005570: 6865 2073 7065 6369 6669 6564 2062 6561  he specified bea
-00005580: 6d20 7479 7065 2e0a 0a20 2020 2020 2020  m type...       
-00005590: 2041 7267 733a 0a20 2020 2020 2020 2020   Args:.         
-000055a0: 2020 2062 6561 6d5f 7479 7065 2028 4265     beam_type (Be
-000055b0: 616d 5479 7065 293a 2054 6865 2069 6d61  amType): The ima
-000055c0: 6769 6e67 2062 6561 6d20 7479 7065 2066  ging beam type f
-000055d0: 6f72 2077 6869 6368 2074 6f20 666f 6375  or which to focu
-000055e0: 732e 0a20 2020 2020 2020 2022 2222 0a20  s..        """. 
-000055f0: 2020 2020 2020 205f 6368 6563 6b5f 6265         _check_be
-00005600: 616d 2862 6561 6d5f 7479 7065 203d 2062  am(beam_type = b
-00005610: 6561 6d5f 7479 7065 2c20 6861 7264 7761  eam_type, hardwa
-00005620: 7265 5f73 6574 7469 6e67 7320 3d20 7365  re_settings = se
-00005630: 6c66 2e68 6172 6477 6172 655f 7365 7474  lf.hardware_sett
-00005640: 696e 6773 290a 2020 2020 2020 2020 6c6f  ings).        lo
-00005650: 6767 696e 672e 696e 666f 2866 2252 756e  gging.info(f"Run
-00005660: 6e69 6e67 2061 7574 6f2d 666f 6375 7320  ning auto-focus 
-00005670: 6f6e 207b 6265 616d 5f74 7970 652e 6e61  on {beam_type.na
-00005680: 6d65 7d2e 2229 0a20 2020 2020 2020 2073  me}.").        s
-00005690: 656c 662e 636f 6e6e 6563 7469 6f6e 2e69  elf.connection.i
-000056a0: 6d61 6769 6e67 2e73 6574 5f61 6374 6976  maging.set_activ
-000056b0: 655f 7669 6577 2862 6561 6d5f 7479 7065  e_view(beam_type
-000056c0: 2e76 616c 7565 2920 200a 2020 2020 2020  .value)  .      
-000056d0: 2020 7365 6c66 2e63 6f6e 6e65 6374 696f    self.connectio
-000056e0: 6e2e 696d 6167 696e 672e 7365 745f 6163  n.imaging.set_ac
-000056f0: 7469 7665 5f64 6576 6963 6528 6265 616d  tive_device(beam
-00005700: 5f74 7970 652e 7661 6c75 6529 0a20 2020  _type.value).   
-00005710: 2020 2020 2073 656c 662e 636f 6e6e 6563       self.connec
-00005720: 7469 6f6e 2e61 7574 6f5f 6675 6e63 7469  tion.auto_functi
-00005730: 6f6e 732e 7275 6e5f 6175 746f 5f66 6f63  ons.run_auto_foc
-00005740: 7573 2829 0a0a 2020 2020 6465 6620 7265  us()..    def re
-00005750: 7365 745f 6265 616d 5f73 6869 6674 7328  set_beam_shifts(
-00005760: 7365 6c66 2920 2d3e 204e 6f6e 653a 0a20  self) -> None:. 
-00005770: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-00005780: 2020 2053 6574 2074 6865 2062 6561 6d20     Set the beam 
-00005790: 7368 6966 7420 746f 207a 6572 6f20 666f  shift to zero fo
-000057a0: 7220 7468 6520 656c 6563 7472 6f6e 2061  r the electron a
-000057b0: 6e64 2069 6f6e 2062 6561 6d73 2e0a 0a20  nd ion beams... 
-000057c0: 2020 2020 2020 2052 6573 6574 7320 7468         Resets th
-000057d0: 6520 6265 616d 2073 6869 6674 2066 6f72  e beam shift for
-000057e0: 2062 6f74 6820 7468 6520 656c 6563 7472   both the electr
-000057f0: 6f6e 2061 6e64 2069 6f6e 2062 6561 6d73  on and ion beams
-00005800: 2074 6f20 2830 2c30 292c 2065 6666 6563   to (0,0), effec
-00005810: 7469 7665 6c79 2063 656e 7465 7269 6e67  tively centering
-00005820: 2074 6865 2062 6561 6d73 206f 6e20 7468   the beams on th
-00005830: 6520 7361 6d70 6c65 2e0a 0a20 2020 2020  e sample...     
-00005840: 2020 2041 7267 733a 0a20 2020 2020 2020     Args:.       
-00005850: 2020 2020 2073 656c 6620 2846 6962 7365       self (Fibse
-00005860: 6d4d 6963 726f 7363 6f70 6529 3a20 696e  mMicroscope): in
-00005870: 7374 616e 6365 206f 6620 7468 6520 4669  stance of the Fi
-00005880: 6273 656d 4d69 6372 6f73 636f 7065 206f  bsemMicroscope o
-00005890: 626a 6563 740a 2020 2020 2020 2020 2222  bject.        ""
-000058a0: 220a 2020 2020 2020 2020 6672 6f6d 2061  ".        from a
-000058b0: 7574 6f73 6372 6970 745f 7364 625f 6d69  utoscript_sdb_mi
-000058c0: 6372 6f73 636f 7065 5f63 6c69 656e 742e  croscope_client.
-000058d0: 7374 7275 6374 7572 6573 2069 6d70 6f72  structures impor
-000058e0: 7420 506f 696e 740a 2020 2020 2020 2020  t Point.        
-000058f0: 5f63 6865 636b 5f62 6561 6d28 6265 616d  _check_beam(beam
-00005900: 5f74 7970 6520 3d20 4265 616d 5479 7065  _type = BeamType
-00005910: 2e45 4c45 4354 524f 4e2c 2068 6172 6477  .ELECTRON, hardw
-00005920: 6172 655f 7365 7474 696e 6773 203d 2073  are_settings = s
-00005930: 656c 662e 6861 7264 7761 7265 5f73 6574  elf.hardware_set
-00005940: 7469 6e67 7329 0a20 2020 2020 2020 2023  tings).        #
-00005950: 2072 6573 6574 207a 6572 6f20 6265 616d   reset zero beam
-00005960: 7368 6966 740a 2020 2020 2020 2020 6c6f  shift.        lo
-00005970: 6767 696e 672e 6465 6275 6728 0a20 2020  gging.debug(.   
-00005980: 2020 2020 2020 2020 2066 2272 6573 6574           f"reset
-00005990: 696e 6720 6562 6561 6d20 7368 6966 7420  ing ebeam shift 
-000059a0: 746f 2028 302c 2030 2920 6672 6f6d 3a20  to (0, 0) from: 
-000059b0: 7b73 656c 662e 636f 6e6e 6563 7469 6f6e  {self.connection
-000059c0: 2e62 6561 6d73 2e65 6c65 6374 726f 6e5f  .beams.electron_
-000059d0: 6265 616d 2e62 6561 6d5f 7368 6966 742e  beam.beam_shift.
-000059e0: 7661 6c75 657d 220a 2020 2020 2020 2020  value}".        
-000059f0: 290a 2020 2020 2020 2020 7365 6c66 2e63  ).        self.c
-00005a00: 6f6e 6e65 6374 696f 6e2e 6265 616d 732e  onnection.beams.
-00005a10: 656c 6563 7472 6f6e 5f62 6561 6d2e 6265  electron_beam.be
-00005a20: 616d 5f73 6869 6674 2e76 616c 7565 203d  am_shift.value =
-00005a30: 2050 6f69 6e74 2830 2c20 3029 0a20 2020   Point(0, 0).   
-00005a40: 2020 2020 205f 6368 6563 6b5f 6265 616d       _check_beam
-00005a50: 2862 6561 6d5f 7479 7065 203d 2042 6561  (beam_type = Bea
-00005a60: 6d54 7970 652e 494f 4e2c 2068 6172 6477  mType.ION, hardw
-00005a70: 6172 655f 7365 7474 696e 6773 203d 2073  are_settings = s
-00005a80: 656c 662e 6861 7264 7761 7265 5f73 6574  elf.hardware_set
-00005a90: 7469 6e67 7329 0a20 2020 2020 2020 206c  tings).        l
-00005aa0: 6f67 6769 6e67 2e64 6562 7567 280a 2020  ogging.debug(.  
-00005ab0: 2020 2020 2020 2020 2020 6622 7265 7365            f"rese
-00005ac0: 7469 6e67 2069 6265 616d 2073 6869 6674  ting ibeam shift
-00005ad0: 2074 6f20 2830 2c20 3029 2066 726f 6d3a   to (0, 0) from:
-00005ae0: 207b 7365 6c66 2e63 6f6e 6e65 6374 696f   {self.connectio
-00005af0: 6e2e 6265 616d 732e 656c 6563 7472 6f6e  n.beams.electron
-00005b00: 5f62 6561 6d2e 6265 616d 5f73 6869 6674  _beam.beam_shift
-00005b10: 2e76 616c 7565 7d22 0a20 2020 2020 2020  .value}".       
-00005b20: 2029 0a20 2020 2020 2020 2073 656c 662e   ).        self.
-00005b30: 636f 6e6e 6563 7469 6f6e 2e62 6561 6d73  connection.beams
-00005b40: 2e69 6f6e 5f62 6561 6d2e 6265 616d 5f73  .ion_beam.beam_s
-00005b50: 6869 6674 2e76 616c 7565 203d 2050 6f69  hift.value = Poi
-00005b60: 6e74 2830 2c20 3029 0a20 2020 2020 2020  nt(0, 0).       
-00005b70: 206c 6f67 6769 6e67 2e64 6562 7567 2866   logging.debug(f
-00005b80: 2272 6573 6574 2062 6561 6d20 7368 6966  "reset beam shif
-00005b90: 7473 2074 6f20 7a65 726f 2063 6f6d 706c  ts to zero compl
-00005ba0: 6574 6522 290a 0a20 2020 2064 6566 2062  ete")..    def b
-00005bb0: 6561 6d5f 7368 6966 7428 7365 6c66 2c20  eam_shift(self, 
-00005bc0: 6478 3a20 666c 6f61 742c 2064 793a 2066  dx: float, dy: f
-00005bd0: 6c6f 6174 2c20 6265 616d 5f74 7970 653a  loat, beam_type:
-00005be0: 2042 6561 6d54 7970 6520 3d20 4265 616d   BeamType = Beam
-00005bf0: 5479 7065 2e49 4f4e 2920 2d3e 204e 6f6e  Type.ION) -> Non
-00005c00: 653a 0a20 2020 2020 2020 2022 2222 0a20  e:.        """. 
-00005c10: 2020 2020 2020 2041 646a 7573 7473 2074         Adjusts t
-00005c20: 6865 2062 6561 6d20 7368 6966 7420 6261  he beam shift ba
-00005c30: 7365 6420 6f6e 2072 656c 6174 6976 6520  sed on relative 
-00005c40: 7661 6c75 6573 2074 6861 7420 6172 6520  values that are 
-00005c50: 7072 6f76 6964 6564 2e0a 2020 2020 2020  provided..      
-00005c60: 2020 0a20 2020 2020 2020 2041 7267 733a    .        Args:
-00005c70: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00005c80: 6620 2846 6962 7365 6d4d 6963 726f 7363  f (FibsemMicrosc
-00005c90: 6f70 6529 3a20 4669 6273 656d 206d 6963  ope): Fibsem mic
-00005ca0: 726f 7363 6f70 6520 6f62 6a65 6374 0a20  roscope object. 
-00005cb0: 2020 2020 2020 2020 2020 2064 7820 2866             dx (f
-00005cc0: 6c6f 6174 293a 2074 6865 2072 656c 6174  loat): the relat
-00005cd0: 6976 6520 7820 7465 726d 0a20 2020 2020  ive x term.     
-00005ce0: 2020 2020 2020 2064 7920 2866 6c6f 6174         dy (float
-00005cf0: 293a 2074 6865 2072 656c 6174 6976 6520  ): the relative 
-00005d00: 7920 7465 726d 0a20 2020 2020 2020 2022  y term.        "
-00005d10: 2222 0a20 2020 2020 2020 205f 6368 6563  "".        _chec
-00005d20: 6b5f 6265 616d 2862 6561 6d5f 7479 7065  k_beam(beam_type
-00005d30: 203d 2062 6561 6d5f 7479 7065 2c20 6861   = beam_type, ha
-00005d40: 7264 7761 7265 5f73 6574 7469 6e67 7320  rdware_settings 
-00005d50: 3d20 7365 6c66 2e68 6172 6477 6172 655f  = self.hardware_
-00005d60: 7365 7474 696e 6773 290a 2020 2020 2020  settings).      
-00005d70: 2020 6c6f 6767 696e 672e 696e 666f 2866    logging.info(f
-00005d80: 227b 6265 616d 5f74 7970 652e 6e61 6d65  "{beam_type.name
-00005d90: 7d20 7368 6966 7469 6e67 2062 7920 287b  } shifting by ({
-00005da0: 6478 7d2c 207b 6479 7d29 2229 0a20 2020  dx}, {dy})").   
-00005db0: 2020 2020 206c 6f67 6769 6e67 2e64 6562       logging.deb
-00005dc0: 7567 2866 227b 6265 616d 5f74 7970 652e  ug(f"{beam_type.
-00005dd0: 6e61 6d65 7d20 7c20 7b64 787d 7c7b 6479  name} | {dx}|{dy
-00005de0: 7d22 2920 0a20 2020 2020 2020 2069 6620  }") .        if 
-00005df0: 6265 616d 5f74 7970 6520 3d3d 2042 6561  beam_type == Bea
-00005e00: 6d54 7970 652e 454c 4543 5452 4f4e 3a0a  mType.ELECTRON:.
-00005e10: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00005e20: 2e63 6f6e 6e65 6374 696f 6e2e 6265 616d  .connection.beam
-00005e30: 732e 656c 6563 7472 6f6e 5f62 6561 6d2e  s.electron_beam.
-00005e40: 6265 616d 5f73 6869 6674 2e76 616c 7565  beam_shift.value
-00005e50: 202b 3d20 282d 6478 2c20 6479 290a 2020   += (-dx, dy).  
-00005e60: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00005e70: 2020 2020 2020 2020 7365 6c66 2e63 6f6e          self.con
-00005e80: 6e65 6374 696f 6e2e 6265 616d 732e 696f  nection.beams.io
-00005e90: 6e5f 6265 616d 2e62 6561 6d5f 7368 6966  n_beam.beam_shif
-00005ea0: 742e 7661 6c75 6520 2b3d 2028 2d64 782c  t.value += (-dx,
-00005eb0: 2064 7929 0a0a 2020 2020 6465 6620 6765   dy)..    def ge
-00005ec0: 745f 7374 6167 655f 706f 7369 7469 6f6e  t_stage_position
-00005ed0: 2873 656c 6629 202d 3e20 4669 6273 656d  (self) -> Fibsem
-00005ee0: 5374 6167 6550 6f73 6974 696f 6e3a 0a20  StagePosition:. 
-00005ef0: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-00005f00: 2020 2047 6574 2074 6865 2063 7572 7265     Get the curre
-00005f10: 6e74 2073 7461 6765 2070 6f73 6974 696f  nt stage positio
-00005f20: 6e2e 0a0a 2020 2020 2020 2020 5468 6973  n...        This
-00005f30: 206d 6574 686f 6420 7265 7472 6965 7665   method retrieve
-00005f40: 7320 7468 6520 6375 7272 656e 7420 7374  s the current st
-00005f50: 6167 6520 706f 7369 7469 6f6e 2066 726f  age position fro
-00005f60: 6d20 7468 6520 6d69 6372 6f73 636f 7065  m the microscope
-00005f70: 2061 6e64 2072 6574 7572 6e73 2069 7420   and returns it 
-00005f80: 6173 0a20 2020 2020 2020 2061 2046 6962  as.        a Fib
-00005f90: 7365 6d53 7461 6765 506f 7369 7469 6f6e  semStagePosition
-00005fa0: 206f 626a 6563 742e 0a0a 2020 2020 2020   object...      
-00005fb0: 2020 5265 7475 726e 733a 0a20 2020 2020    Returns:.     
-00005fc0: 2020 2020 2020 2046 6962 7365 6d53 7461         FibsemSta
-00005fd0: 6765 506f 7369 7469 6f6e 3a20 5468 6520  gePosition: The 
-00005fe0: 6375 7272 656e 7420 7374 6167 6520 706f  current stage po
-00005ff0: 7369 7469 6f6e 2e0a 2020 2020 2020 2020  sition..        
-00006000: 2222 220a 2020 2020 2020 2020 6966 2073  """.        if s
-00006010: 656c 662e 6861 7264 7761 7265 5f73 6574  elf.hardware_set
-00006020: 7469 6e67 732e 7374 6167 655f 656e 6162  tings.stage_enab
-00006030: 6c65 6420 6973 2046 616c 7365 3a0a 2020  led is False:.  
-00006040: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-00006050: 4e6f 7449 6d70 6c65 6d65 6e74 6564 4572  NotImplementedEr
-00006060: 726f 7228 2254 6865 206d 6963 726f 7363  ror("The microsc
-00006070: 6f70 6520 646f 6573 206e 6f74 2068 6176  ope does not hav
-00006080: 6520 6120 6d6f 7669 6e67 2073 7461 6765  e a moving stage
-00006090: 2e22 290a 2020 2020 2020 2020 7365 6c66  .").        self
-000060a0: 2e63 6f6e 6e65 6374 696f 6e2e 7370 6563  .connection.spec
-000060b0: 696d 656e 2e73 7461 6765 2e73 6574 5f64  imen.stage.set_d
-000060c0: 6566 6175 6c74 5f63 6f6f 7264 696e 6174  efault_coordinat
-000060d0: 655f 7379 7374 656d 280a 2020 2020 2020  e_system(.      
-000060e0: 2020 2020 2020 436f 6f72 6469 6e61 7465        Coordinate
-000060f0: 5379 7374 656d 2e52 4157 0a20 2020 2020  System.RAW.     
-00006100: 2020 2029 0a20 2020 2020 2020 2073 7461     ).        sta
-00006110: 6765 5f70 6f73 6974 696f 6e20 3d20 7365  ge_position = se
-00006120: 6c66 2e63 6f6e 6e65 6374 696f 6e2e 7370  lf.connection.sp
-00006130: 6563 696d 656e 2e73 7461 6765 2e63 7572  ecimen.stage.cur
-00006140: 7265 6e74 5f70 6f73 6974 696f 6e0a 2020  rent_position.  
-00006150: 2020 2020 2020 7365 6c66 2e63 6f6e 6e65        self.conne
-00006160: 6374 696f 6e2e 7370 6563 696d 656e 2e73  ction.specimen.s
-00006170: 7461 6765 2e73 6574 5f64 6566 6175 6c74  tage.set_default
-00006180: 5f63 6f6f 7264 696e 6174 655f 7379 7374  _coordinate_syst
-00006190: 656d 280a 2020 2020 2020 2020 2020 2020  em(.            
-000061a0: 436f 6f72 6469 6e61 7465 5379 7374 656d  CoordinateSystem
-000061b0: 2e53 5045 4349 4d45 4e0a 2020 2020 2020  .SPECIMEN.      
-000061c0: 2020 290a 2020 2020 2020 2020 7265 7475    ).        retu
-000061d0: 726e 2046 6962 7365 6d53 7461 6765 506f  rn FibsemStagePo
-000061e0: 7369 7469 6f6e 2e66 726f 6d5f 6175 746f  sition.from_auto
-000061f0: 7363 7269 7074 5f70 6f73 6974 696f 6e28  script_position(
-00006200: 7374 6167 655f 706f 7369 7469 6f6e 290a  stage_position).
-00006210: 0a20 2020 2064 6566 2067 6574 5f63 7572  .    def get_cur
-00006220: 7265 6e74 5f6d 6963 726f 7363 6f70 655f  rent_microscope_
-00006230: 7374 6174 6528 7365 6c66 2920 2d3e 204d  state(self) -> M
-00006240: 6963 726f 7363 6f70 6553 7461 7465 3a0a  icroscopeState:.
-00006250: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-00006260: 2020 2020 4765 7420 7468 6520 6375 7272      Get the curr
-00006270: 656e 7420 6d69 6372 6f73 636f 7065 2073  ent microscope s
-00006280: 7461 7465 0a0a 2020 2020 2020 2020 5468  tate..        Th
-00006290: 6973 206d 6574 686f 6420 7265 7472 6965  is method retrie
-000062a0: 7665 7320 7468 6520 6375 7272 656e 7420  ves the current 
-000062b0: 6d69 6372 6f73 636f 7065 2073 7461 7465  microscope state
-000062c0: 2066 726f 6d20 7468 6520 6d69 6372 6f73   from the micros
-000062d0: 636f 7065 2061 6e64 2072 6574 7572 6e73  cope and returns
-000062e0: 2069 7420 6173 0a20 2020 2020 2020 2061   it as.        a
-000062f0: 204d 6963 726f 7363 6f70 6553 7461 7465   MicroscopeState
-00006300: 206f 626a 6563 742e 0a0a 2020 2020 2020   object...      
-00006310: 2020 5265 7475 726e 733a 0a20 2020 2020    Returns:.     
-00006320: 2020 2020 2020 204d 6963 726f 7363 6f70         Microscop
-00006330: 6553 7461 7465 3a20 6375 7272 656e 7420  eState: current 
-00006340: 6d69 6372 6f73 636f 7065 2073 7461 7465  microscope state
-00006350: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-00006360: 2020 2020 2072 6573 6f6c 7574 696f 6e5f       resolution_
-00006370: 6562 203d 2073 656c 662e 636f 6e6e 6563  eb = self.connec
-00006380: 7469 6f6e 2e62 6561 6d73 2e65 6c65 6374  tion.beams.elect
-00006390: 726f 6e5f 6265 616d 2e73 6361 6e6e 696e  ron_beam.scannin
-000063a0: 672e 7265 736f 6c75 7469 6f6e 2e76 616c  g.resolution.val
-000063b0: 7565 0a20 2020 2020 2020 2077 6964 7468  ue.        width
-000063c0: 5f65 6220 3d20 696e 7428 7265 736f 6c75  _eb = int(resolu
-000063d0: 7469 6f6e 5f65 622e 7370 6c69 7428 2278  tion_eb.split("x
-000063e0: 2229 5b30 5d29 0a20 2020 2020 2020 2068  ")[0]).        h
-000063f0: 6569 6768 745f 6562 203d 2069 6e74 2872  eight_eb = int(r
-00006400: 6573 6f6c 7574 696f 6e5f 6562 2e73 706c  esolution_eb.spl
-00006410: 6974 2822 7822 295b 2d31 5d29 0a20 2020  it("x")[-1]).   
-00006420: 2020 2020 2072 6573 6f6c 7574 696f 6e5f       resolution_
-00006430: 5f69 6220 3d20 7365 6c66 2e63 6f6e 6e65  _ib = self.conne
-00006440: 6374 696f 6e2e 6265 616d 732e 696f 6e5f  ction.beams.ion_
-00006450: 6265 616d 2e73 6361 6e6e 696e 672e 7265  beam.scanning.re
-00006460: 736f 6c75 7469 6f6e 2e76 616c 7565 0a20  solution.value. 
-00006470: 2020 2020 2020 2077 6964 7468 5f69 6220         width_ib 
-00006480: 3d20 696e 7428 7265 736f 6c75 7469 6f6e  = int(resolution
-00006490: 5f5f 6962 2e73 706c 6974 2822 7822 295b  __ib.split("x")[
-000064a0: 305d 290a 2020 2020 2020 2020 6865 6967  0]).        heig
-000064b0: 6874 5f69 6220 3d20 696e 7428 7265 736f  ht_ib = int(reso
-000064c0: 6c75 7469 6f6e 5f5f 6962 2e73 706c 6974  lution__ib.split
-000064d0: 2822 7822 295b 2d31 5d29 0a0a 0a20 2020  ("x")[-1])...   
-000064e0: 2020 2020 2069 6620 7365 6c66 2e68 6172       if self.har
-000064f0: 6477 6172 655f 7365 7474 696e 6773 2e65  dware_settings.e
-00006500: 6c65 6374 726f 6e5f 6265 616d 2069 7320  lectron_beam is 
-00006510: 5472 7565 3a0a 2020 2020 2020 2020 2020  True:.          
-00006520: 2020 6562 5f73 6574 7469 6e67 733d 4265    eb_settings=Be
-00006530: 616d 5365 7474 696e 6773 280a 2020 2020  amSettings(.    
-00006540: 2020 2020 2020 2020 2020 2020 6265 616d              beam
-00006550: 5f74 7970 653d 4265 616d 5479 7065 2e45  _type=BeamType.E
-00006560: 4c45 4354 524f 4e2c 0a20 2020 2020 2020  LECTRON,.       
-00006570: 2020 2020 2020 2020 2077 6f72 6b69 6e67           working
-00006580: 5f64 6973 7461 6e63 653d 7365 6c66 2e63  _distance=self.c
-00006590: 6f6e 6e65 6374 696f 6e2e 6265 616d 732e  onnection.beams.
-000065a0: 656c 6563 7472 6f6e 5f62 6561 6d2e 776f  electron_beam.wo
-000065b0: 726b 696e 675f 6469 7374 616e 6365 2e76  rking_distance.v
-000065c0: 616c 7565 2c0a 2020 2020 2020 2020 2020  alue,.          
-000065d0: 2020 2020 2020 6265 616d 5f63 7572 7265        beam_curre
-000065e0: 6e74 3d73 656c 662e 636f 6e6e 6563 7469  nt=self.connecti
-000065f0: 6f6e 2e62 6561 6d73 2e65 6c65 6374 726f  on.beams.electro
-00006600: 6e5f 6265 616d 2e62 6561 6d5f 6375 7272  n_beam.beam_curr
-00006610: 656e 742e 7661 6c75 652c 0a20 2020 2020  ent.value,.     
-00006620: 2020 2020 2020 2020 2020 2068 6677 3d73             hfw=s
-00006630: 656c 662e 636f 6e6e 6563 7469 6f6e 2e62  elf.connection.b
-00006640: 6561 6d73 2e65 6c65 6374 726f 6e5f 6265  eams.electron_be
-00006650: 616d 2e68 6f72 697a 6f6e 7461 6c5f 6669  am.horizontal_fi
-00006660: 656c 645f 7769 6474 682e 7661 6c75 652c  eld_width.value,
-00006670: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00006680: 2072 6573 6f6c 7574 696f 6e3d 5b77 6964   resolution=[wid
-00006690: 7468 5f65 622c 2068 6569 6768 745f 6562  th_eb, height_eb
-000066a0: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
-000066b0: 2020 2064 7765 6c6c 5f74 696d 653d 7365     dwell_time=se
-000066c0: 6c66 2e63 6f6e 6e65 6374 696f 6e2e 6265  lf.connection.be
-000066d0: 616d 732e 656c 6563 7472 6f6e 5f62 6561  ams.electron_bea
-000066e0: 6d2e 7363 616e 6e69 6e67 2e64 7765 6c6c  m.scanning.dwell
-000066f0: 5f74 696d 652e 7661 6c75 652c 0a20 2020  _time.value,.   
-00006700: 2020 2020 2020 2020 2020 2020 2073 6361               sca
-00006710: 6e5f 726f 7461 7469 6f6e 3d73 656c 662e  n_rotation=self.
-00006720: 636f 6e6e 6563 7469 6f6e 2e62 6561 6d73  connection.beams
-00006730: 2e65 6c65 6374 726f 6e5f 6265 616d 2e73  .electron_beam.s
-00006740: 6361 6e6e 696e 672e 726f 7461 7469 6f6e  canning.rotation
-00006750: 2e76 616c 7565 2c0a 2020 2020 2020 2020  .value,.        
-00006760: 2020 2020 290a 2020 2020 2020 2020 656c      ).        el
-00006770: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00006780: 6562 5f73 6574 7469 6e67 733d 4e6f 6e65  eb_settings=None
-00006790: 0a20 2020 2020 2020 200a 2020 2020 2020  .        .      
-000067a0: 2020 6966 2073 656c 662e 6861 7264 7761    if self.hardwa
-000067b0: 7265 5f73 6574 7469 6e67 732e 696f 6e5f  re_settings.ion_
-000067c0: 6265 616d 2069 7320 5472 7565 3a0a 2020  beam is True:.  
-000067d0: 2020 2020 2020 2020 2020 6962 5f73 6574            ib_set
-000067e0: 7469 6e67 733d 4265 616d 5365 7474 696e  tings=BeamSettin
-000067f0: 6773 280a 2020 2020 2020 2020 2020 2020  gs(.            
-00006800: 2020 2020 6265 616d 5f74 7970 653d 4265      beam_type=Be
-00006810: 616d 5479 7065 2e49 4f4e 2c0a 2020 2020  amType.ION,.    
-00006820: 2020 2020 2020 2020 2020 2020 776f 726b              work
-00006830: 696e 675f 6469 7374 616e 6365 3d73 656c  ing_distance=sel
-00006840: 662e 636f 6e6e 6563 7469 6f6e 2e62 6561  f.connection.bea
-00006850: 6d73 2e69 6f6e 5f62 6561 6d2e 776f 726b  ms.ion_beam.work
-00006860: 696e 675f 6469 7374 616e 6365 2e76 616c  ing_distance.val
-00006870: 7565 2c0a 2020 2020 2020 2020 2020 2020  ue,.            
-00006880: 2020 2020 6265 616d 5f63 7572 7265 6e74      beam_current
-00006890: 3d73 656c 662e 636f 6e6e 6563 7469 6f6e  =self.connection
-000068a0: 2e62 6561 6d73 2e69 6f6e 5f62 6561 6d2e  .beams.ion_beam.
-000068b0: 6265 616d 5f63 7572 7265 6e74 2e76 616c  beam_current.val
-000068c0: 7565 2c0a 2020 2020 2020 2020 2020 2020  ue,.            
-000068d0: 2020 2020 6866 773d 7365 6c66 2e63 6f6e      hfw=self.con
-000068e0: 6e65 6374 696f 6e2e 6265 616d 732e 696f  nection.beams.io
-000068f0: 6e5f 6265 616d 2e68 6f72 697a 6f6e 7461  n_beam.horizonta
-00006900: 6c5f 6669 656c 645f 7769 6474 682e 7661  l_field_width.va
-00006910: 6c75 652c 0a20 2020 2020 2020 2020 2020  lue,.           
-00006920: 2020 2020 2072 6573 6f6c 7574 696f 6e3d       resolution=
-00006930: 5b77 6964 7468 5f69 622c 2068 6569 6768  [width_ib, heigh
-00006940: 745f 6962 5d2c 0a20 2020 2020 2020 2020  t_ib],.         
-00006950: 2020 2020 2020 2064 7765 6c6c 5f74 696d         dwell_tim
-00006960: 653d 7365 6c66 2e63 6f6e 6e65 6374 696f  e=self.connectio
-00006970: 6e2e 6265 616d 732e 696f 6e5f 6265 616d  n.beams.ion_beam
-00006980: 2e73 6361 6e6e 696e 672e 6477 656c 6c5f  .scanning.dwell_
-00006990: 7469 6d65 2e76 616c 7565 2c0a 2020 2020  time.value,.    
-000069a0: 2020 2020 2020 2020 2020 2020 7363 616e              scan
-000069b0: 5f72 6f74 6174 696f 6e3d 7365 6c66 2e63  _rotation=self.c
-000069c0: 6f6e 6e65 6374 696f 6e2e 6265 616d 732e  onnection.beams.
-000069d0: 696f 6e5f 6265 616d 2e73 6361 6e6e 696e  ion_beam.scannin
-000069e0: 672e 726f 7461 7469 6f6e 2e76 616c 7565  g.rotation.value
-000069f0: 2c0a 2020 2020 2020 2020 2020 2020 290a  ,.            ).
-00006a00: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00006a10: 2020 2020 2020 2020 2020 6962 5f73 6574            ib_set
-00006a20: 7469 6e67 733d 4e6f 6e65 0a0a 2020 2020  tings=None..    
-00006a30: 2020 2020 6375 7272 656e 745f 6d69 6372      current_micr
-00006a40: 6f73 636f 7065 5f73 7461 7465 203d 204d  oscope_state = M
-00006a50: 6963 726f 7363 6f70 6553 7461 7465 280a  icroscopeState(.
-00006a60: 2020 2020 2020 2020 2020 2020 7469 6d65              time
-00006a70: 7374 616d 703d 6461 7465 7469 6d65 2e64  stamp=datetime.d
-00006a80: 6174 6574 696d 652e 7469 6d65 7374 616d  atetime.timestam
-00006a90: 7028 6461 7465 7469 6d65 2e64 6174 6574  p(datetime.datet
-00006aa0: 696d 652e 6e6f 7728 2929 2c0a 2020 2020  ime.now()),.    
-00006ab0: 2020 2020 2020 2020 2320 6765 7420 6162          # get ab
-00006ac0: 736f 6c75 7465 2073 7461 6765 2063 6f6f  solute stage coo
-00006ad0: 7264 696e 6174 6573 2028 5241 5729 0a20  rdinates (RAW). 
-00006ae0: 2020 2020 2020 2020 2020 2061 6273 6f6c             absol
-00006af0: 7574 655f 706f 7369 7469 6f6e 3d73 656c  ute_position=sel
-00006b00: 662e 6765 745f 7374 6167 655f 706f 7369  f.get_stage_posi
-00006b10: 7469 6f6e 2829 2c0a 2020 2020 2020 2020  tion(),.        
-00006b20: 2020 2020 2320 656c 6563 7472 6f6e 2062      # electron b
-00006b30: 6561 6d20 7365 7474 696e 6773 0a20 2020  eam settings.   
-00006b40: 2020 2020 2020 2020 2065 625f 7365 7474           eb_sett
-00006b50: 696e 6773 3d65 625f 7365 7474 696e 6773  ings=eb_settings
-00006b60: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
-00006b70: 696f 6e20 6265 616d 2073 6574 7469 6e67  ion beam setting
-00006b80: 730a 2020 2020 2020 2020 2020 2020 6962  s.            ib
-00006b90: 5f73 6574 7469 6e67 733d 6962 5f73 6574  _settings=ib_set
-00006ba0: 7469 6e67 732c 0a20 2020 2020 2020 2029  tings,.        )
-00006bb0: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
-00006bc0: 2063 7572 7265 6e74 5f6d 6963 726f 7363   current_microsc
-00006bd0: 6f70 655f 7374 6174 650a 0a20 2020 2064  ope_state..    d
-00006be0: 6566 206d 6f76 655f 7374 6167 655f 6162  ef move_stage_ab
-00006bf0: 736f 6c75 7465 2873 656c 662c 2070 6f73  solute(self, pos
-00006c00: 6974 696f 6e3a 2046 6962 7365 6d53 7461  ition: FibsemSta
-00006c10: 6765 506f 7369 7469 6f6e 293a 0a20 2020  gePosition):.   
-00006c20: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-00006c30: 204d 6f76 6520 7468 6520 7374 6167 6520   Move the stage 
-00006c40: 746f 2074 6865 2073 7065 6369 6669 6564  to the specified
-00006c50: 2063 6f6f 7264 696e 6174 6573 2e0a 0a20   coordinates... 
-00006c60: 2020 2020 2020 2041 7267 733a 0a20 2020         Args:.   
-00006c70: 2020 2020 2020 2020 2078 2028 666c 6f61           x (floa
-00006c80: 7429 3a20 5468 6520 782d 636f 6f72 6469  t): The x-coordi
-00006c90: 6e61 7465 2074 6f20 6d6f 7665 2074 6f20  nate to move to 
-00006ca0: 2869 6e20 6d65 7465 7273 292e 0a20 2020  (in meters)..   
-00006cb0: 2020 2020 2020 2020 2079 2028 666c 6f61           y (floa
-00006cc0: 7429 3a20 5468 6520 792d 636f 6f72 6469  t): The y-coordi
-00006cd0: 6e61 7465 2074 6f20 6d6f 7665 2074 6f20  nate to move to 
-00006ce0: 2869 6e20 6d65 7465 7273 292e 0a20 2020  (in meters)..   
-00006cf0: 2020 2020 2020 2020 207a 2028 666c 6f61           z (floa
-00006d00: 7429 3a20 5468 6520 7a2d 636f 6f72 6469  t): The z-coordi
-00006d10: 6e61 7465 2074 6f20 6d6f 7665 2074 6f20  nate to move to 
-00006d20: 2869 6e20 6d65 7465 7273 292e 0a20 2020  (in meters)..   
-00006d30: 2020 2020 2020 2020 2072 2028 666c 6f61           r (floa
-00006d40: 7429 3a20 5468 6520 726f 7461 7469 6f6e  t): The rotation
-00006d50: 2074 6f20 6170 706c 7920 2869 6e20 7261   to apply (in ra
-00006d60: 6469 616e 7329 2e0a 2020 2020 2020 2020  dians)..        
-00006d70: 2020 2020 7478 2028 666c 6f61 7429 3a20      tx (float): 
-00006d80: 5468 6520 782d 6178 6973 2074 696c 7420  The x-axis tilt 
-00006d90: 746f 2061 7070 6c79 2028 696e 2072 6164  to apply (in rad
-00006da0: 6961 6e73 292e 0a0a 2020 2020 2020 2020  ians)...        
-00006db0: 5265 7475 726e 733a 0a20 2020 2020 2020  Returns:.       
-00006dc0: 2020 2020 204e 6f6e 650a 2020 2020 2020       None.      
-00006dd0: 2020 2222 220a 2020 2020 2020 2020 6966    """.        if
-00006de0: 2070 6f73 6974 696f 6e2e 7220 6973 206e   position.r is n
-00006df0: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
-00006e00: 2020 2020 2072 6f74 6174 696f 6e20 3d20       rotation = 
-00006e10: 5472 7565 0a20 2020 2020 2020 2065 6c73  True.        els
-00006e20: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
-00006e30: 6f74 6174 696f 6e20 3d20 4661 6c73 650a  otation = False.
-00006e40: 2020 2020 2020 2020 6966 2070 6f73 6974          if posit
-00006e50: 696f 6e2e 7420 6973 206e 6f74 204e 6f6e  ion.t is not Non
-00006e60: 653a 0a20 2020 2020 2020 2020 2020 2074  e:.            t
-00006e70: 696c 7420 3d20 5472 7565 0a20 2020 2020  ilt = True.     
-00006e80: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00006e90: 2020 2020 2074 696c 7420 3d20 4661 6c73       tilt = Fals
-00006ea0: 650a 2020 2020 2020 2020 5f63 6865 636b  e.        _check
-00006eb0: 5f73 7461 6765 2873 656c 662e 6861 7264  _stage(self.hard
-00006ec0: 7761 7265 5f73 6574 7469 6e67 732c 2072  ware_settings, r
-00006ed0: 6f74 6174 696f 6e3d 726f 7461 7469 6f6e  otation=rotation
-00006ee0: 2c20 7469 6c74 3d74 696c 7429 0a20 2020  , tilt=tilt).   
-00006ef0: 2020 2020 206c 6f67 6769 6e67 2e69 6e66       logging.inf
-00006f00: 6f28 6622 4d6f 7669 6e67 2073 7461 6765  o(f"Moving stage
-00006f10: 2074 6f20 7b70 6f73 6974 696f 6e7d 2e22   to {position}."
-00006f20: 290a 2020 2020 2020 2020 7374 6167 6520  ).        stage 
-00006f30: 3d20 7365 6c66 2e63 6f6e 6e65 6374 696f  = self.connectio
-00006f40: 6e2e 7370 6563 696d 656e 2e73 7461 6765  n.specimen.stage
-00006f50: 0a20 2020 2020 2020 2074 6865 726d 6f5f  .        thermo_
-00006f60: 706f 7369 7469 6f6e 203d 2070 6f73 6974  position = posit
-00006f70: 696f 6e2e 746f 5f61 7574 6f73 6372 6970  ion.to_autoscrip
-00006f80: 745f 706f 7369 7469 6f6e 2829 0a20 2020  t_position().   
-00006f90: 2020 2020 2074 6865 726d 6f5f 706f 7369       thermo_posi
-00006fa0: 7469 6f6e 2e63 6f6f 7264 696e 6174 655f  tion.coordinate_
-00006fb0: 7379 7374 656d 203d 2043 6f6f 7264 696e  system = Coordin
-00006fc0: 6174 6553 7973 7465 6d2e 5241 570a 2020  ateSystem.RAW.  
-00006fd0: 2020 2020 2020 7374 6167 652e 6162 736f        stage.abso
-00006fe0: 6c75 7465 5f6d 6f76 6528 7468 6572 6d6f  lute_move(thermo
-00006ff0: 5f70 6f73 6974 696f 6e29 2023 2054 4f44  _position) # TOD
-00007000: 4f3a 2054 6869 7320 6e65 6564 7320 6174  O: This needs at
-00007010: 206c 6561 7374 2061 6e20 6f70 7469 6f6e   least an option
-00007020: 616c 2073 6166 6520 6d6f 7665 2074 6f20  al safe move to 
-00007030: 7072 6576 656e 7420 636f 6c6c 6973 696f  prevent collisio
-00007040: 6e3f 0a0a 2020 2020 6465 6620 6d6f 7665  n?..    def move
-00007050: 5f73 7461 6765 5f72 656c 6174 6976 6528  _stage_relative(
-00007060: 7365 6c66 2c20 706f 7369 7469 6f6e 3a20  self, position: 
-00007070: 4669 6273 656d 5374 6167 6550 6f73 6974  FibsemStagePosit
-00007080: 696f 6e29 3a0a 2020 2020 2020 2020 2222  ion):.        ""
-00007090: 220a 2020 2020 2020 2020 4d6f 7665 2074  ".        Move t
-000070a0: 6865 2073 7461 6765 2062 7920 7468 6520  he stage by the 
-000070b0: 7370 6563 6966 6965 6420 7265 6c61 7469  specified relati
-000070c0: 7665 206d 6f76 652e 0a0a 2020 2020 2020  ve move...      
-000070d0: 2020 4172 6773 3a0a 2020 2020 2020 2020    Args:.        
-000070e0: 2020 2020 7820 2866 6c6f 6174 293a 2054      x (float): T
-000070f0: 6865 2078 2d63 6f6f 7264 696e 6174 6520  he x-coordinate 
-00007100: 746f 206d 6f76 6520 746f 2028 696e 206d  to move to (in m
-00007110: 6574 6572 7329 2e0a 2020 2020 2020 2020  eters)..        
-00007120: 2020 2020 7920 2866 6c6f 6174 293a 2054      y (float): T
-00007130: 6865 2079 2d63 6f6f 7264 696e 6174 6520  he y-coordinate 
-00007140: 746f 206d 6f76 6520 746f 2028 696e 206d  to move to (in m
-00007150: 6574 6572 7329 2e0a 2020 2020 2020 2020  eters)..        
-00007160: 2020 2020 7a20 2866 6c6f 6174 293a 2054      z (float): T
-00007170: 6865 207a 2d63 6f6f 7264 696e 6174 6520  he z-coordinate 
-00007180: 746f 206d 6f76 6520 746f 2028 696e 206d  to move to (in m
-00007190: 6574 6572 7329 2e0a 2020 2020 2020 2020  eters)..        
-000071a0: 2020 2020 7220 2866 6c6f 6174 293a 2054      r (float): T
-000071b0: 6865 2072 6f74 6174 696f 6e20 746f 2061  he rotation to a
-000071c0: 7070 6c79 2028 696e 2072 6164 6961 6e73  pply (in radians
-000071d0: 292e 0a20 2020 2020 2020 2020 2020 2074  )..            t
-000071e0: 7820 2866 6c6f 6174 293a 2054 6865 2078  x (float): The x
-000071f0: 2d61 7869 7320 7469 6c74 2074 6f20 6170  -axis tilt to ap
-00007200: 706c 7920 2869 6e20 7261 6469 616e 7329  ply (in radians)
-00007210: 2e0a 0a20 2020 2020 2020 2052 6574 7572  ...        Retur
-00007220: 6e73 3a0a 2020 2020 2020 2020 2020 2020  ns:.            
-00007230: 4e6f 6e65 0a20 2020 2020 2020 2022 2222  None.        """
-00007240: 0a20 2020 2020 2020 2069 6620 706f 7369  .        if posi
-00007250: 7469 6f6e 2e72 2069 7320 6e6f 7420 4e6f  tion.r is not No
-00007260: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-00007270: 726f 7461 7469 6f6e 203d 2054 7275 650a  rotation = True.
-00007280: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00007290: 2020 2020 2020 2020 2020 726f 7461 7469            rotati
-000072a0: 6f6e 203d 2046 616c 7365 0a20 2020 2020  on = False.     
-000072b0: 2020 2069 6620 706f 7369 7469 6f6e 2e74     if position.t
-000072c0: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
-000072d0: 2020 2020 2020 2020 2020 7469 6c74 203d            tilt =
-000072e0: 2054 7275 650a 2020 2020 2020 2020 656c   True.        el
-000072f0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00007300: 7469 6c74 203d 2046 616c 7365 0a20 2020  tilt = False.   
-00007310: 2020 2020 205f 6368 6563 6b5f 7374 6167       _check_stag
-00007320: 6528 7365 6c66 2e68 6172 6477 6172 655f  e(self.hardware_
-00007330: 7365 7474 696e 6773 2c20 726f 7461 7469  settings, rotati
-00007340: 6f6e 3d72 6f74 6174 696f 6e2c 2074 696c  on=rotation, til
-00007350: 743d 7469 6c74 290a 2020 2020 2020 2020  t=tilt).        
-00007360: 6c6f 6767 696e 672e 696e 666f 2866 224d  logging.info(f"M
-00007370: 6f76 696e 6720 7374 6167 6520 6279 207b  oving stage by {
-00007380: 706f 7369 7469 6f6e 7d2e 2229 0a20 2020  position}.").   
-00007390: 2020 2020 2073 7461 6765 203d 2073 656c       stage = sel
-000073a0: 662e 636f 6e6e 6563 7469 6f6e 2e73 7065  f.connection.spe
-000073b0: 6369 6d65 6e2e 7374 6167 650a 2020 2020  cimen.stage.    
-000073c0: 2020 2020 7468 6572 6d6f 5f70 6f73 6974      thermo_posit
-000073d0: 696f 6e20 3d20 706f 7369 7469 6f6e 2e74  ion = position.t
-000073e0: 6f5f 6175 746f 7363 7269 7074 5f70 6f73  o_autoscript_pos
-000073f0: 6974 696f 6e28 290a 2020 2020 2020 2020  ition().        
-00007400: 7468 6572 6d6f 5f70 6f73 6974 696f 6e2e  thermo_position.
-00007410: 636f 6f72 6469 6e61 7465 5f73 7973 7465  coordinate_syste
-00007420: 6d20 3d20 436f 6f72 6469 6e61 7465 5379  m = CoordinateSy
-00007430: 7374 656d 2e52 4157 0a20 2020 2020 2020  stem.RAW.       
-00007440: 2073 7461 6765 2e72 656c 6174 6976 655f   stage.relative_
-00007450: 6d6f 7665 2874 6865 726d 6f5f 706f 7369  move(thermo_posi
-00007460: 7469 6f6e 290a 0a20 2020 2064 6566 2073  tion)..    def s
-00007470: 7461 626c 655f 6d6f 7665 280a 2020 2020  table_move(.    
-00007480: 2020 2020 7365 6c66 2c0a 2020 2020 2020      self,.      
-00007490: 2020 7365 7474 696e 6773 3a20 4d69 6372    settings: Micr
-000074a0: 6f73 636f 7065 5365 7474 696e 6773 2c0a  oscopeSettings,.
-000074b0: 2020 2020 2020 2020 6478 3a20 666c 6f61          dx: floa
-000074c0: 742c 0a20 2020 2020 2020 2064 793a 2066  t,.        dy: f
-000074d0: 6c6f 6174 2c0a 2020 2020 2020 2020 6265  loat,.        be
-000074e0: 616d 5f74 7970 653a 2042 6561 6d54 7970  am_type: BeamTyp
-000074f0: 652c 0a20 2020 2029 202d 3e20 4e6f 6e65  e,.    ) -> None
-00007500: 3a0a 2020 2020 2020 2020 2222 220a 2020  :.        """.  
-00007510: 2020 2020 2020 4361 6c63 756c 6174 6520        Calculate 
-00007520: 7468 6520 636f 7272 6563 7465 6420 7374  the corrected st
-00007530: 6167 6520 6d6f 7665 6d65 6e74 7320 6261  age movements ba
-00007540: 7365 6420 6f6e 2074 6865 2062 6561 6d5f  sed on the beam_
-00007550: 7479 7065 2c20 616e 6420 7468 656e 206d  type, and then m
-00007560: 6f76 6520 7468 6520 7374 6167 6520 7265  ove the stage re
-00007570: 6c61 7469 7665 6c79 2e0a 0a20 2020 2020  latively...     
-00007580: 2020 2041 7267 733a 0a20 2020 2020 2020     Args:.       
-00007590: 2020 2020 2073 6574 7469 6e67 7320 284d       settings (M
-000075a0: 6963 726f 7363 6f70 6553 6574 7469 6e67  icroscopeSetting
-000075b0: 7329 3a20 6d69 6372 6f73 636f 7065 2073  s): microscope s
-000075c0: 6574 7469 6e67 730a 2020 2020 2020 2020  ettings.        
-000075d0: 2020 2020 6478 2028 666c 6f61 7429 3a20      dx (float): 
-000075e0: 6469 7374 616e 6365 2061 6c6f 6e67 2074  distance along t
-000075f0: 6865 2078 2d61 7869 7320 2869 6d61 6765  he x-axis (image
-00007600: 2063 6f6f 7264 696e 6174 6573 290a 2020   coordinates).  
-00007610: 2020 2020 2020 2020 2020 6479 2028 666c            dy (fl
-00007620: 6f61 7429 3a20 6469 7374 616e 6365 2061  oat): distance a
-00007630: 6c6f 6e67 2074 6865 2079 2d61 7869 7320  long the y-axis 
-00007640: 2869 6d61 6765 2063 6f6f 7264 696e 6174  (image coordinat
-00007650: 6573 290a 2020 2020 2020 2020 2020 2020  es).            
-00007660: 6265 616d 5f74 7970 6520 2842 6561 6d54  beam_type (BeamT
-00007670: 7970 6529 3a20 6265 616d 2074 7970 6520  ype): beam type 
-00007680: 746f 206d 6f76 6520 696e 0a20 2020 2020  to move in.     
-00007690: 2020 2022 2222 0a20 2020 2020 2020 205f     """.        _
-000076a0: 6368 6563 6b5f 7374 6167 6528 7365 6c66  check_stage(self
-000076b0: 2e68 6172 6477 6172 655f 7365 7474 696e  .hardware_settin
-000076c0: 6773 290a 2020 2020 2020 2020 7764 203d  gs).        wd =
-000076d0: 2073 656c 662e 636f 6e6e 6563 7469 6f6e   self.connection
-000076e0: 2e62 6561 6d73 2e65 6c65 6374 726f 6e5f  .beams.electron_
-000076f0: 6265 616d 2e77 6f72 6b69 6e67 5f64 6973  beam.working_dis
-00007700: 7461 6e63 652e 7661 6c75 650a 0a20 2020  tance.value..   
-00007710: 2020 2020 2069 6620 6265 616d 5f74 7970       if beam_typ
-00007720: 6520 3d3d 2042 6561 6d54 7970 652e 454c  e == BeamType.EL
-00007730: 4543 5452 4f4e 3a0a 2020 2020 2020 2020  ECTRON:.        
-00007740: 2020 2020 696d 6167 655f 726f 7461 7469      image_rotati
-00007750: 6f6e 203d 2073 656c 662e 636f 6e6e 6563  on = self.connec
-00007760: 7469 6f6e 2e62 6561 6d73 2e65 6c65 6374  tion.beams.elect
-00007770: 726f 6e5f 6265 616d 2e73 6361 6e6e 696e  ron_beam.scannin
-00007780: 672e 726f 7461 7469 6f6e 2e76 616c 7565  g.rotation.value
-00007790: 0a20 2020 2020 2020 2065 6c69 6620 6265  .        elif be
-000077a0: 616d 5f74 7970 6520 3d3d 2042 6561 6d54  am_type == BeamT
-000077b0: 7970 652e 494f 4e3a 0a20 2020 2020 2020  ype.ION:.       
-000077c0: 2020 2020 2069 6d61 6765 5f72 6f74 6174       image_rotat
-000077d0: 696f 6e20 3d20 7365 6c66 2e63 6f6e 6e65  ion = self.conne
-000077e0: 6374 696f 6e2e 6265 616d 732e 696f 6e5f  ction.beams.ion_
-000077f0: 6265 616d 2e73 6361 6e6e 696e 672e 726f  beam.scanning.ro
-00007800: 7461 7469 6f6e 2e76 616c 7565 0a0a 2020  tation.value..  
-00007810: 2020 2020 2020 6966 206e 702e 6973 636c        if np.iscl
-00007820: 6f73 6528 696d 6167 655f 726f 7461 7469  ose(image_rotati
-00007830: 6f6e 2c20 302e 3029 3a0a 2020 2020 2020  on, 0.0):.      
-00007840: 2020 2020 2020 6478 203d 2064 780a 2020        dx = dx.  
-00007850: 2020 2020 2020 2020 2020 6479 203d 2064            dy = d
-00007860: 790a 2020 2020 2020 2020 656c 6966 206e  y.        elif n
-00007870: 702e 6973 636c 6f73 6528 696d 6167 655f  p.isclose(image_
-00007880: 726f 7461 7469 6f6e 2c20 6e70 2e70 6929  rotation, np.pi)
-00007890: 3a0a 2020 2020 2020 2020 2020 2020 6478  :.            dx
-000078a0: 202a 3d20 2d31 2e30 0a20 2020 2020 2020   *= -1.0.       
-000078b0: 2020 2020 2064 7920 2a3d 202d 312e 300a       dy *= -1.0.
-000078c0: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
-000078d0: 2023 2063 616c 6375 6c61 7465 2073 7461   # calculate sta
-000078e0: 6765 206d 6f76 656d 656e 740a 2020 2020  ge movement.    
-000078f0: 2020 2020 785f 6d6f 7665 203d 2046 6962      x_move = Fib
-00007900: 7365 6d53 7461 6765 506f 7369 7469 6f6e  semStagePosition
-00007910: 2878 3d64 782c 2079 3d30 2c20 7a3d 3029  (x=dx, y=0, z=0)
-00007920: 0a20 2020 2020 2020 2079 7a5f 6d6f 7665  .        yz_move
-00007930: 203d 2073 656c 662e 5f79 5f63 6f72 7265   = self._y_corre
-00007940: 6374 6564 5f73 7461 6765 5f6d 6f76 656d  cted_stage_movem
-00007950: 656e 7428 0a20 2020 2020 2020 2020 2020  ent(.           
-00007960: 2073 6574 7469 6e67 733d 7365 7474 696e   settings=settin
-00007970: 6773 2c0a 2020 2020 2020 2020 2020 2020  gs,.            
-00007980: 6578 7065 6374 6564 5f79 3d64 792c 0a20  expected_y=dy,. 
-00007990: 2020 2020 2020 2020 2020 2062 6561 6d5f             beam_
-000079a0: 7479 7065 3d62 6561 6d5f 7479 7065 2c0a  type=beam_type,.
-000079b0: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
-000079c0: 2020 2023 206d 6f76 6520 7374 6167 650a     # move stage.
-000079d0: 2020 2020 2020 2020 7374 6167 655f 706f          stage_po
-000079e0: 7369 7469 6f6e 203d 2046 6962 7365 6d53  sition = FibsemS
-000079f0: 7461 6765 506f 7369 7469 6f6e 280a 2020  tagePosition(.  
-00007a00: 2020 2020 2020 2020 2020 783d 785f 6d6f            x=x_mo
-00007a10: 7665 2e78 2c0a 2020 2020 2020 2020 2020  ve.x,.          
-00007a20: 2020 793d 797a 5f6d 6f76 652e 792c 0a20    y=yz_move.y,. 
-00007a30: 2020 2020 2020 2020 2020 207a 3d79 7a5f             z=yz_
-00007a40: 6d6f 7665 2e7a 2c0a 2020 2020 2020 2020  move.z,.        
-00007a50: 2020 2020 723d 302c 0a20 2020 2020 2020      r=0,.       
-00007a60: 2020 2020 2074 3d30 2c0a 2020 2020 2020       t=0,.      
-00007a70: 2020 2020 2020 636f 6f72 6469 6e61 7465        coordinate
-00007a80: 5f73 7973 7465 6d3d 2252 4157 222c 0a20  _system="RAW",. 
-00007a90: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00007aa0: 206c 6f67 6769 6e67 2e69 6e66 6f28 6622   logging.info(f"
-00007ab0: 6d6f 7669 6e67 2073 7461 6765 2028 7b62  moving stage ({b
-00007ac0: 6561 6d5f 7479 7065 2e6e 616d 657d 293a  eam_type.name}):
-00007ad0: 207b 7374 6167 655f 706f 7369 7469 6f6e   {stage_position
-00007ae0: 7d22 290a 2020 2020 2020 2020 7365 6c66  }").        self
-00007af0: 2e6d 6f76 655f 7374 6167 655f 7265 6c61  .move_stage_rela
-00007b00: 7469 7665 2873 7461 6765 5f70 6f73 6974  tive(stage_posit
-00007b10: 696f 6e29 0a0a 2020 2020 2020 2020 2320  ion)..        # 
-00007b20: 6164 6a75 7374 2077 6f72 6b69 6e67 2064  adjust working d
-00007b30: 6973 7461 6e63 6520 746f 2063 6f6d 7065  istance to compe
-00007b40: 6e73 6174 6520 666f 7220 7374 6167 6520  nsate for stage 
-00007b50: 6d6f 7665 6d65 6e74 0a20 2020 2020 2020  movement.       
-00007b60: 2073 656c 662e 636f 6e6e 6563 7469 6f6e   self.connection
-00007b70: 2e62 6561 6d73 2e65 6c65 6374 726f 6e5f  .beams.electron_
-00007b80: 6265 616d 2e77 6f72 6b69 6e67 5f64 6973  beam.working_dis
-00007b90: 7461 6e63 652e 7661 6c75 6520 3d20 7764  tance.value = wd
-00007ba0: 0a20 2020 2020 2020 2073 656c 662e 636f  .        self.co
-00007bb0: 6e6e 6563 7469 6f6e 2e73 7065 6369 6d65  nnection.specime
-00007bc0: 6e2e 7374 6167 652e 6c69 6e6b 2829 0a0a  n.stage.link()..
-00007bd0: 2020 2020 2020 2020 7265 7475 726e 2073          return s
-00007be0: 7461 6765 5f70 6f73 6974 696f 6e0a 0a20  tage_position.. 
-00007bf0: 2020 2064 6566 2065 7563 656e 7472 6963     def eucentric
-00007c00: 5f6d 6f76 6528 0a20 2020 2020 2020 2073  _move(.        s
-00007c10: 656c 662c 0a20 2020 2020 2020 2073 6574  elf,.        set
-00007c20: 7469 6e67 733a 204d 6963 726f 7363 6f70  tings: Microscop
-00007c30: 6553 6574 7469 6e67 732c 0a20 2020 2020  eSettings,.     
-00007c40: 2020 2064 793a 2066 6c6f 6174 2c0a 2020     dy: float,.  
-00007c50: 2020 2020 2020 7374 6174 6963 5f77 643a        static_wd:
-00007c60: 2062 6f6f 6c20 3d20 5472 7565 2c0a 2020   bool = True,.  
-00007c70: 2020 2920 2d3e 204e 6f6e 653a 0a20 2020    ) -> None:.   
-00007c80: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-00007c90: 204d 6f76 6520 7468 6520 7374 6167 6520   Move the stage 
-00007ca0: 7665 7274 6963 616c 6c79 2074 6f20 636f  vertically to co
-00007cb0: 7272 6563 7420 6575 6365 6e74 7269 6320  rrect eucentric 
-00007cc0: 706f 696e 740a 0a20 2020 2020 2020 2041  point..        A
-00007cd0: 7267 733a 0a20 2020 2020 2020 2020 2020  rgs:.           
-00007ce0: 2073 6574 7469 6e67 7320 284d 6963 726f   settings (Micro
-00007cf0: 7363 6f70 6553 6574 7469 6e67 7329 3a20  scopeSettings): 
-00007d00: 6d69 6372 6f73 636f 7065 2073 6574 7469  microscope setti
-00007d10: 6e67 730a 2020 2020 2020 2020 2020 2020  ngs.            
-00007d20: 6479 2028 666c 6f61 7429 3a20 6469 7374  dy (float): dist
-00007d30: 616e 6365 2069 6e20 792d 6178 6973 2028  ance in y-axis (
-00007d40: 696d 6167 6520 636f 6f72 6469 6e61 7465  image coordinate
-00007d50: 7329 0a20 2020 2020 2020 2022 2222 0a20  s).        """. 
-00007d60: 2020 2020 2020 205f 6368 6563 6b5f 7374         _check_st
-00007d70: 6167 6528 7365 6c66 2e68 6172 6477 6172  age(self.hardwar
-00007d80: 655f 7365 7474 696e 6773 290a 2020 2020  e_settings).    
-00007d90: 2020 2020 7764 203d 2073 656c 662e 636f      wd = self.co
-00007da0: 6e6e 6563 7469 6f6e 2e62 6561 6d73 2e65  nnection.beams.e
-00007db0: 6c65 6374 726f 6e5f 6265 616d 2e77 6f72  lectron_beam.wor
-00007dc0: 6b69 6e67 5f64 6973 7461 6e63 652e 7661  king_distance.va
-00007dd0: 6c75 650a 2020 2020 2020 2020 696d 6167  lue.        imag
-00007de0: 655f 726f 7461 7469 6f6e 203d 2073 656c  e_rotation = sel
-00007df0: 662e 636f 6e6e 6563 7469 6f6e 2e62 6561  f.connection.bea
-00007e00: 6d73 2e69 6f6e 5f62 6561 6d2e 7363 616e  ms.ion_beam.scan
-00007e10: 6e69 6e67 2e72 6f74 6174 696f 6e2e 7661  ning.rotation.va
-00007e20: 6c75 650a 2020 2020 2020 2020 6966 206e  lue.        if n
-00007e30: 702e 6973 636c 6f73 6528 696d 6167 655f  p.isclose(image_
-00007e40: 726f 7461 7469 6f6e 2c20 302e 3029 3a0a  rotation, 0.0):.
-00007e50: 2020 2020 2020 2020 2020 2020 6479 203d              dy =
-00007e60: 2064 790a 2020 2020 2020 2020 656c 6966   dy.        elif
-00007e70: 206e 702e 6973 636c 6f73 6528 696d 6167   np.isclose(imag
-00007e80: 655f 726f 7461 7469 6f6e 2c20 6e70 2e70  e_rotation, np.p
-00007e90: 6929 3a0a 2020 2020 2020 2020 2020 2020  i):.            
-00007ea0: 6479 203d 202d 6479 0a20 2020 2020 2020  dy = -dy.       
-00007eb0: 2023 2054 4f44 4f3a 2064 6f65 7320 7468   # TODO: does th
-00007ec0: 6973 206e 6565 6420 7468 6520 7065 7273  is need the pers
-00007ed0: 7065 6374 6976 6520 636f 7272 6563 7469  pective correcti
-00007ee0: 6f6e 2074 6f6f 3f0a 0a20 2020 2020 2020  on too?..       
-00007ef0: 207a 5f6d 6f76 6520 3d20 6479 202f 206e   z_move = dy / n
-00007f00: 702e 636f 7328 6e70 2e64 6567 3272 6164  p.cos(np.deg2rad
-00007f10: 2839 3020 2d20 7365 7474 696e 6773 2e73  (90 - settings.s
-00007f20: 7973 7465 6d2e 7374 6167 652e 7469 6c74  ystem.stage.tilt
-00007f30: 5f66 6c61 745f 746f 5f69 6f6e 2929 2020  _flat_to_ion))  
-00007f40: 2320 544f 444f 3a20 4d41 4749 4320 4e55  # TODO: MAGIC NU
-00007f50: 4d42 4552 2c20 3930 202d 2066 6962 2074  MBER, 90 - fib t
-00007f60: 696c 740a 0a20 2020 2020 2020 206d 6f76  ilt..        mov
-00007f70: 655f 7365 7474 696e 6773 203d 204d 6f76  e_settings = Mov
-00007f80: 6553 6574 7469 6e67 7328 6c69 6e6b 5f7a  eSettings(link_z
-00007f90: 5f79 3d54 7275 6529 0a20 2020 2020 2020  _y=True).       
-00007fa0: 207a 5f6d 6f76 6520 3d20 4669 6273 656d   z_move = Fibsem
-00007fb0: 5374 6167 6550 6f73 6974 696f 6e28 0a20  StagePosition(. 
-00007fc0: 2020 2020 2020 2020 2020 207a 3d7a 5f6d             z=z_m
-00007fd0: 6f76 652c 2063 6f6f 7264 696e 6174 655f  ove, coordinate_
-00007fe0: 7379 7374 656d 3d22 5370 6563 696d 656e  system="Specimen
-00007ff0: 220a 2020 2020 2020 2020 292e 746f 5f61  ".        ).to_a
-00008000: 7574 6f73 6372 6970 745f 706f 7369 7469  utoscript_positi
-00008010: 6f6e 2829 0a20 2020 2020 2020 2073 656c  on().        sel
-00008020: 662e 636f 6e6e 6563 7469 6f6e 2e73 7065  f.connection.spe
-00008030: 6369 6d65 6e2e 7374 6167 652e 7265 6c61  cimen.stage.rela
-00008040: 7469 7665 5f6d 6f76 6528 7a5f 6d6f 7665  tive_move(z_move
-00008050: 2c20 6d6f 7665 5f73 6574 7469 6e67 7329  , move_settings)
-00008060: 0a20 2020 2020 2020 206c 6f67 6769 6e67  .        logging
-00008070: 2e69 6e66 6f28 6622 6575 6365 6e74 7269  .info(f"eucentri
-00008080: 6320 6d6f 7665 6d65 6e74 3a20 7b7a 5f6d  c movement: {z_m
-00008090: 6f76 657d 2229 0a0a 2020 2020 2020 2020  ove}")..        
-000080a0: 6966 2073 7461 7469 635f 7764 3a0a 2020  if static_wd:.  
-000080b0: 2020 2020 2020 2020 2020 7365 6c66 2e63            self.c
-000080c0: 6f6e 6e65 6374 696f 6e2e 6265 616d 732e  onnection.beams.
-000080d0: 656c 6563 7472 6f6e 5f62 6561 6d2e 776f  electron_beam.wo
-000080e0: 726b 696e 675f 6469 7374 616e 6365 2e76  rking_distance.v
-000080f0: 616c 7565 203d 2028 0a20 2020 2020 2020  alue = (.       
-00008100: 2020 2020 2020 2020 2073 6574 7469 6e67           setting
-00008110: 732e 7379 7374 656d 2e65 6c65 6374 726f  s.system.electro
-00008120: 6e2e 6575 6365 6e74 7269 635f 6865 6967  n.eucentric_heig
-00008130: 6874 0a20 2020 2020 2020 2020 2020 2029  ht.            )
-00008140: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00008150: 662e 636f 6e6e 6563 7469 6f6e 2e62 6561  f.connection.bea
-00008160: 6d73 2e69 6f6e 5f62 6561 6d2e 776f 726b  ms.ion_beam.work
-00008170: 696e 675f 6469 7374 616e 6365 2e76 616c  ing_distance.val
-00008180: 7565 203d 2028 0a20 2020 2020 2020 2020  ue = (.         
-00008190: 2020 2020 2020 2073 6574 7469 6e67 732e         settings.
-000081a0: 7379 7374 656d 2e69 6f6e 2e65 7563 656e  system.ion.eucen
-000081b0: 7472 6963 5f68 6569 6768 740a 2020 2020  tric_height.    
-000081c0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-000081d0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-000081e0: 2020 2020 7365 6c66 2e63 6f6e 6e65 6374      self.connect
-000081f0: 696f 6e2e 6265 616d 732e 656c 6563 7472  ion.beams.electr
-00008200: 6f6e 5f62 6561 6d2e 776f 726b 696e 675f  on_beam.working_
-00008210: 6469 7374 616e 6365 2e76 616c 7565 203d  distance.value =
-00008220: 2077 640a 2020 2020 2020 2020 7365 6c66   wd.        self
-00008230: 2e63 6f6e 6e65 6374 696f 6e2e 7370 6563  .connection.spec
-00008240: 696d 656e 2e73 7461 6765 2e6c 696e 6b28  imen.stage.link(
-00008250: 290a 0a20 2020 2064 6566 205f 795f 636f  )..    def _y_co
-00008260: 7272 6563 7465 645f 7374 6167 655f 6d6f  rrected_stage_mo
-00008270: 7665 6d65 6e74 280a 2020 2020 2020 2020  vement(.        
-00008280: 7365 6c66 2c0a 2020 2020 2020 2020 7365  self,.        se
-00008290: 7474 696e 6773 3a20 4d69 6372 6f73 636f  ttings: Microsco
-000082a0: 7065 5365 7474 696e 6773 2c0a 2020 2020  peSettings,.    
-000082b0: 2020 2020 6578 7065 6374 6564 5f79 3a20      expected_y: 
-000082c0: 666c 6f61 742c 0a20 2020 2020 2020 2062  float,.        b
-000082d0: 6561 6d5f 7479 7065 3a20 4265 616d 5479  eam_type: BeamTy
-000082e0: 7065 203d 2042 6561 6d54 7970 652e 454c  pe = BeamType.EL
-000082f0: 4543 5452 4f4e 2c0a 2020 2020 2920 2d3e  ECTRON,.    ) ->
-00008300: 2046 6962 7365 6d53 7461 6765 506f 7369   FibsemStagePosi
-00008310: 7469 6f6e 3a0a 2020 2020 2020 2020 2222  tion:.        ""
-00008320: 220a 2020 2020 2020 2020 4361 6c63 756c  ".        Calcul
-00008330: 6174 6520 7468 6520 7920 636f 7272 6563  ate the y correc
-00008340: 7465 6420 7374 6167 6520 6d6f 7665 6d65  ted stage moveme
-00008350: 6e74 2c20 636f 7272 6563 7465 6420 666f  nt, corrected fo
-00008360: 7220 7468 6520 6164 6469 7469 6f6e 616c  r the additional
-00008370: 2074 696c 7420 6f66 2074 6865 2073 616d   tilt of the sam
-00008380: 706c 6520 686f 6c64 6572 2028 7072 652d  ple holder (pre-
-00008390: 7469 6c74 2061 6e67 6c65 292e 0a0a 2020  tilt angle)...  
-000083a0: 2020 2020 2020 4172 6773 3a0a 2020 2020        Args:.    
-000083b0: 2020 2020 2020 2020 7365 7474 696e 6773          settings
-000083c0: 2028 4d69 6372 6f73 636f 7065 5365 7474   (MicroscopeSett
-000083d0: 696e 6773 293a 206d 6963 726f 7363 6f70  ings): microscop
-000083e0: 6520 7365 7474 696e 6773 0a20 2020 2020  e settings.     
-000083f0: 2020 2020 2020 2065 7870 6563 7465 645f         expected_
-00008400: 7920 2866 6c6f 6174 2c20 6f70 7469 6f6e  y (float, option
-00008410: 616c 293a 2064 6973 7461 6e63 6520 616c  al): distance al
-00008420: 6f6e 6720 792d 6178 6973 2e0a 2020 2020  ong y-axis..    
-00008430: 2020 2020 2020 2020 6265 616d 5f74 7970          beam_typ
-00008440: 6520 2842 6561 6d54 7970 652c 206f 7074  e (BeamType, opt
-00008450: 696f 6e61 6c29 3a20 6265 616d 5f74 7970  ional): beam_typ
-00008460: 6520 746f 206d 6f76 6520 696e 2e20 4465  e to move in. De
-00008470: 6661 756c 7473 2074 6f20 4265 616d 5479  faults to BeamTy
-00008480: 7065 2e45 4c45 4354 524f 4e2e 0a0a 2020  pe.ELECTRON...  
-00008490: 2020 2020 2020 5265 7475 726e 733a 0a20        Returns:. 
-000084a0: 2020 2020 2020 2020 2020 2053 7461 6765             Stage
-000084b0: 506f 7369 7469 6f6e 3a20 7920 636f 7272  Position: y corr
-000084c0: 6563 7465 6420 7374 6167 6520 6d6f 7665  ected stage move
-000084d0: 6d65 6e74 2028 7265 6c61 7469 7665 2070  ment (relative p
-000084e0: 6f73 6974 696f 6e29 0a20 2020 2020 2020  osition).       
-000084f0: 2022 2222 0a0a 2020 2020 2020 2020 2320   """..        # 
-00008500: 544f 444f 3a20 7265 706c 6163 6520 7769  TODO: replace wi
-00008510: 7468 2063 616d 6572 6120 6d61 7472 6978  th camera matrix
-00008520: 202a 2069 6e76 6572 7365 206b 696e 656d   * inverse kinem
-00008530: 6174 6963 730a 2020 2020 2020 2020 2320  atics.        # 
-00008540: 544f 444f 3a20 7265 706c 6163 6520 7374  TODO: replace st
-00008550: 6167 655f 7469 6c74 5f66 6c61 745f 746f  age_tilt_flat_to
-00008560: 5f65 6c65 6374 726f 6e20 7769 7468 2070  _electron with p
-00008570: 7265 2d74 696c 740a 0a20 2020 2020 2020  re-tilt..       
-00008580: 2023 2061 6c6c 2061 6e67 6c65 7320 696e   # all angles in
-00008590: 2072 6164 6961 6e73 0a20 2020 2020 2020   radians.       
-000085a0: 2073 7461 6765 5f74 696c 745f 666c 6174   stage_tilt_flat
-000085b0: 5f74 6f5f 656c 6563 7472 6f6e 203d 206e  _to_electron = n
-000085c0: 702e 6465 6732 7261 6428 0a20 2020 2020  p.deg2rad(.     
-000085d0: 2020 2020 2020 2073 6574 7469 6e67 732e         settings.
-000085e0: 7379 7374 656d 2e73 7461 6765 2e74 696c  system.stage.til
-000085f0: 745f 666c 6174 5f74 6f5f 656c 6563 7472  t_flat_to_electr
-00008600: 6f6e 0a20 2020 2020 2020 2029 0a20 2020  on.        ).   
-00008610: 2020 2020 2073 7461 6765 5f74 696c 745f       stage_tilt_
-00008620: 666c 6174 5f74 6f5f 696f 6e20 3d20 6e70  flat_to_ion = np
-00008630: 2e64 6567 3272 6164 2873 6574 7469 6e67  .deg2rad(setting
-00008640: 732e 7379 7374 656d 2e73 7461 6765 2e74  s.system.stage.t
-00008650: 696c 745f 666c 6174 5f74 6f5f 696f 6e29  ilt_flat_to_ion)
-00008660: 0a0a 2020 2020 2020 2020 7374 6167 655f  ..        stage_
-00008670: 7072 6574 696c 7420 3d20 6e70 2e64 6567  pretilt = np.deg
-00008680: 3272 6164 2873 6574 7469 6e67 732e 7379  2rad(settings.sy
-00008690: 7374 656d 2e73 7461 6765 2e70 7265 5f74  stem.stage.pre_t
-000086a0: 696c 7429 0a0a 2020 2020 2020 2020 7374  ilt)..        st
-000086b0: 6167 655f 726f 7461 7469 6f6e 5f66 6c61  age_rotation_fla
-000086c0: 745f 746f 5f65 6220 3d20 6e70 2e64 6567  t_to_eb = np.deg
-000086d0: 3272 6164 280a 2020 2020 2020 2020 2020  2rad(.          
-000086e0: 2020 7365 7474 696e 6773 2e73 7973 7465    settings.syste
-000086f0: 6d2e 7374 6167 652e 726f 7461 7469 6f6e  m.stage.rotation
-00008700: 5f66 6c61 745f 746f 5f65 6c65 6374 726f  _flat_to_electro
-00008710: 6e0a 2020 2020 2020 2020 2920 2520 2832  n.        ) % (2
-00008720: 202a 206e 702e 7069 290a 2020 2020 2020   * np.pi).      
-00008730: 2020 7374 6167 655f 726f 7461 7469 6f6e    stage_rotation
-00008740: 5f66 6c61 745f 746f 5f69 6f6e 203d 206e  _flat_to_ion = n
-00008750: 702e 6465 6732 7261 6428 0a20 2020 2020  p.deg2rad(.     
-00008760: 2020 2020 2020 2073 6574 7469 6e67 732e         settings.
-00008770: 7379 7374 656d 2e73 7461 6765 2e72 6f74  system.stage.rot
-00008780: 6174 696f 6e5f 666c 6174 5f74 6f5f 696f  ation_flat_to_io
-00008790: 6e0a 2020 2020 2020 2020 2920 2520 2832  n.        ) % (2
-000087a0: 202a 206e 702e 7069 290a 0a20 2020 2020   * np.pi)..     
-000087b0: 2020 2023 2063 7572 7265 6e74 2073 7461     # current sta
-000087c0: 6765 2070 6f73 6974 696f 6e0a 2020 2020  ge position.    
-000087d0: 2020 2020 6375 7272 656e 745f 7374 6167      current_stag
-000087e0: 655f 706f 7369 7469 6f6e 203d 2073 656c  e_position = sel
-000087f0: 662e 6765 745f 7374 6167 655f 706f 7369  f.get_stage_posi
-00008800: 7469 6f6e 2829 0a20 2020 2020 2020 2073  tion().        s
-00008810: 7461 6765 5f72 6f74 6174 696f 6e20 3d20  tage_rotation = 
-00008820: 6375 7272 656e 745f 7374 6167 655f 706f  current_stage_po
-00008830: 7369 7469 6f6e 2e72 2025 2028 3220 2a20  sition.r % (2 * 
-00008840: 6e70 2e70 6929 0a20 2020 2020 2020 2073  np.pi).        s
-00008850: 7461 6765 5f74 696c 7420 3d20 6375 7272  tage_tilt = curr
-00008860: 656e 745f 7374 6167 655f 706f 7369 7469  ent_stage_positi
-00008870: 6f6e 2e74 0a0a 2020 2020 2020 2020 5052  on.t..        PR
-00008880: 4554 494c 545f 5349 474e 203d 2031 2e30  ETILT_SIGN = 1.0
-00008890: 0a20 2020 2020 2020 2023 2070 7265 7469  .        # preti
-000088a0: 6c74 2061 6e67 6c65 2064 6570 656e 6473  lt angle depends
-000088b0: 206f 6e20 726f 7461 7469 6f6e 0a20 2020   on rotation.   
-000088c0: 2020 2020 2066 726f 6d20 6669 6273 656d       from fibsem
-000088d0: 2069 6d70 6f72 7420 6d6f 7665 6d65 6e74   import movement
-000088e0: 0a20 2020 2020 2020 2069 6620 6d6f 7665  .        if move
-000088f0: 6d65 6e74 2e72 6f74 6174 696f 6e5f 616e  ment.rotation_an
-00008900: 676c 655f 6973 5f73 6d61 6c6c 6572 2873  gle_is_smaller(s
-00008910: 7461 6765 5f72 6f74 6174 696f 6e2c 2073  tage_rotation, s
-00008920: 7461 6765 5f72 6f74 6174 696f 6e5f 666c  tage_rotation_fl
-00008930: 6174 5f74 6f5f 6562 2c20 6174 6f6c 3d35  at_to_eb, atol=5
-00008940: 293a 0a20 2020 2020 2020 2020 2020 2050  ):.            P
-00008950: 5245 5449 4c54 5f53 4947 4e20 3d20 312e  RETILT_SIGN = 1.
-00008960: 300a 2020 2020 2020 2020 6966 206d 6f76  0.        if mov
-00008970: 656d 656e 742e 726f 7461 7469 6f6e 5f61  ement.rotation_a
-00008980: 6e67 6c65 5f69 735f 736d 616c 6c65 7228  ngle_is_smaller(
-00008990: 0a20 2020 2020 2020 2020 2020 2073 7461  .            sta
-000089a0: 6765 5f72 6f74 6174 696f 6e2c 2073 7461  ge_rotation, sta
-000089b0: 6765 5f72 6f74 6174 696f 6e5f 666c 6174  ge_rotation_flat
-000089c0: 5f74 6f5f 696f 6e2c 2061 746f 6c3d 350a  _to_ion, atol=5.
-000089d0: 2020 2020 2020 2020 293a 0a20 2020 2020          ):.     
-000089e0: 2020 2020 2020 2050 5245 5449 4c54 5f53         PRETILT_S
-000089f0: 4947 4e20 3d20 2d31 2e30 0a0a 2020 2020  IGN = -1.0..    
-00008a00: 2020 2020 2320 636f 7272 6563 7465 645f      # corrected_
-00008a10: 7072 6574 696c 745f 616e 676c 6520 3d20  pretilt_angle = 
-00008a20: 5052 4554 494c 545f 5349 474e 202a 2073  PRETILT_SIGN * s
-00008a30: 7461 6765 5f74 696c 745f 666c 6174 5f74  tage_tilt_flat_t
-00008a40: 6f5f 656c 6563 7472 6f6e 0a20 2020 2020  o_electron.     
-00008a50: 2020 2063 6f72 7265 6374 6564 5f70 7265     corrected_pre
-00008a60: 7469 6c74 5f61 6e67 6c65 203d 2050 5245  tilt_angle = PRE
-00008a70: 5449 4c54 5f53 4947 4e20 2a20 2873 7461  TILT_SIGN * (sta
-00008a80: 6765 5f70 7265 7469 6c74 202b 2073 7461  ge_pretilt + sta
-00008a90: 6765 5f74 696c 745f 666c 6174 5f74 6f5f  ge_tilt_flat_to_
-00008aa0: 656c 6563 7472 6f6e 2920 2320 656c 6563  electron) # elec
-00008ab0: 7472 6f6e 2061 6e67 6c65 203d 2030 2c20  tron angle = 0, 
-00008ac0: 696f 6e20 3d20 3532 0a0a 2020 2020 2020  ion = 52..      
-00008ad0: 2020 2320 7065 7273 7065 6374 6976 6520    # perspective 
-00008ae0: 7469 6c74 2061 646a 7573 746d 656e 7420  tilt adjustment 
-00008af0: 2864 6966 6665 7265 6e63 6520 6265 7477  (difference betw
-00008b00: 6565 6e20 7065 7273 7065 6374 6976 6520  een perspective 
-00008b10: 7669 6577 2061 6e64 2073 616d 706c 6520  view and sample 
-00008b20: 636f 6f72 6469 6e61 7465 2073 7973 7465  coordinate syste
-00008b30: 6d29 0a20 2020 2020 2020 2069 6620 6265  m).        if be
-00008b40: 616d 5f74 7970 6520 3d3d 2042 6561 6d54  am_type == BeamT
-00008b50: 7970 652e 454c 4543 5452 4f4e 3a0a 2020  ype.ELECTRON:.  
-00008b60: 2020 2020 2020 2020 2020 7065 7273 7065            perspe
-00008b70: 6374 6976 655f 7469 6c74 5f61 646a 7573  ctive_tilt_adjus
-00008b80: 746d 656e 7420 3d20 2d63 6f72 7265 6374  tment = -correct
-00008b90: 6564 5f70 7265 7469 6c74 5f61 6e67 6c65  ed_pretilt_angle
-00008ba0: 0a20 2020 2020 2020 2020 2020 2053 4341  .            SCA
-00008bb0: 4c45 5f46 4143 544f 5220 3d20 312e 3020  LE_FACTOR = 1.0 
-00008bc0: 2023 2030 2e37 3833 3432 2020 2320 7061   # 0.78342  # pa
-00008bd0: 7465 6e74 6564 2074 6563 686e 6f6c 6f67  tented technolog
-00008be0: 790a 2020 2020 2020 2020 656c 6966 2062  y.        elif b
-00008bf0: 6561 6d5f 7479 7065 203d 3d20 4265 616d  eam_type == Beam
-00008c00: 5479 7065 2e49 4f4e 3a0a 2020 2020 2020  Type.ION:.      
-00008c10: 2020 2020 2020 7065 7273 7065 6374 6976        perspectiv
-00008c20: 655f 7469 6c74 5f61 646a 7573 746d 656e  e_tilt_adjustmen
-00008c30: 7420 3d20 280a 2020 2020 2020 2020 2020  t = (.          
-00008c40: 2020 2020 2020 2d63 6f72 7265 6374 6564        -corrected
-00008c50: 5f70 7265 7469 6c74 5f61 6e67 6c65 202d  _pretilt_angle -
-00008c60: 2073 7461 6765 5f74 696c 745f 666c 6174   stage_tilt_flat
-00008c70: 5f74 6f5f 696f 6e0a 2020 2020 2020 2020  _to_ion.        
-00008c80: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-00008c90: 2020 5343 414c 455f 4641 4354 4f52 203d    SCALE_FACTOR =
-00008ca0: 2031 2e30 0a0a 2020 2020 2020 2020 2320   1.0..        # 
-00008cb0: 7468 6520 616d 6f75 6e74 2074 6865 2073  the amount the s
-00008cc0: 616d 706c 6520 6861 7320 746f 206d 6f76  ample has to mov
-00008cd0: 6520 696e 2074 6865 2079 2d61 7869 730a  e in the y-axis.
-00008ce0: 2020 2020 2020 2020 795f 7361 6d70 6c65          y_sample
-00008cf0: 5f6d 6f76 6520 3d20 2865 7870 6563 7465  _move = (expecte
-00008d00: 645f 7920 2a20 5343 414c 455f 4641 4354  d_y * SCALE_FACT
-00008d10: 4f52 2920 2f20 6e70 2e63 6f73 280a 2020  OR) / np.cos(.  
-00008d20: 2020 2020 2020 2020 2020 7374 6167 655f            stage_
-00008d30: 7469 6c74 202b 2070 6572 7370 6563 7469  tilt + perspecti
-00008d40: 7665 5f74 696c 745f 6164 6a75 7374 6d65  ve_tilt_adjustme
-00008d50: 6e74 0a20 2020 2020 2020 2029 0a0a 2020  nt.        )..  
-00008d60: 2020 2020 2020 2320 616e 676c 6520 666f        # angle fo
-00008d70: 7220 6164 6a75 7374 656d 656e 7420 0a20  r adjustement . 
-00008d80: 2020 2020 2020 2023 2061 6e67 6c65 203d         # angle =
-00008d90: 2063 6f72 7265 6374 6564 5f70 7265 7469   corrected_preti
-00008da0: 6c74 5f61 6e67 6c65 202b 2073 7461 6765  lt_angle + stage
-00008db0: 5f74 696c 7420 2b20 7065 7273 7065 6374  _tilt + perspect
-00008dc0: 6976 655f 7469 6c74 5f61 646a 7573 746d  ive_tilt_adjustm
-00008dd0: 656e 740a 2020 2020 2020 2020 2320 795f  ent.        # y_
-00008de0: 7361 6d70 6c65 5f6d 6f76 6520 3d20 2865  sample_move = (e
-00008df0: 7870 6563 7465 645f 7920 2a20 5343 414c  xpected_y * SCAL
-00008e00: 455f 4641 4354 4f52 2920 2f20 6e70 2e63  E_FACTOR) / np.c
-00008e10: 6f73 2861 6e67 6c65 290a 0a20 2020 2020  os(angle)..     
-00008e20: 2020 2023 2074 6865 2061 6d6f 756e 7420     # the amount 
-00008e30: 7468 6520 7374 6167 6520 6861 7320 746f  the stage has to
-00008e40: 206d 6f76 6520 696e 2065 6163 6820 6178   move in each ax
-00008e50: 6973 0a20 2020 2020 2020 200a 2020 2020  is.        .    
-00008e60: 2020 2020 795f 6d6f 7665 203d 2079 5f73      y_move = y_s
-00008e70: 616d 706c 655f 6d6f 7665 202a 206e 702e  ample_move * np.
-00008e80: 636f 7328 636f 7272 6563 7465 645f 7072  cos(corrected_pr
-00008e90: 6574 696c 745f 616e 676c 6529 0a20 2020  etilt_angle).   
-00008ea0: 2020 2020 207a 5f6d 6f76 6520 3d20 2d79       z_move = -y
-00008eb0: 5f73 616d 706c 655f 6d6f 7665 202a 206e  _sample_move * n
-00008ec0: 702e 7369 6e28 636f 7272 6563 7465 645f  p.sin(corrected_
-00008ed0: 7072 6574 696c 745f 616e 676c 6529 2023  pretilt_angle) #
-00008ee0: 544f 444f 3a20 696e 7665 7374 6967 6174  TODO: investigat
-00008ef0: 6520 7468 6973 0a0a 2020 2020 2020 2020  e this..        
-00008f00: 7265 7475 726e 2046 6962 7365 6d53 7461  return FibsemSta
-00008f10: 6765 506f 7369 7469 6f6e 2878 3d30 2c20  gePosition(x=0, 
-00008f20: 793d 795f 6d6f 7665 2c20 7a3d 7a5f 6d6f  y=y_move, z=z_mo
-00008f30: 7665 290a 0a20 2020 2064 6566 206d 6f76  ve)..    def mov
-00008f40: 655f 666c 6174 5f74 6f5f 6265 616d 280a  e_flat_to_beam(.
-00008f50: 2020 2020 2020 2020 7365 6c66 2c20 7365          self, se
-00008f60: 7474 696e 6773 3a20 4d69 6372 6f73 636f  ttings: Microsco
-00008f70: 7065 5365 7474 696e 6773 2c20 6265 616d  peSettings, beam
-00008f80: 5f74 7970 653a 2042 6561 6d54 7970 6520  _type: BeamType 
-00008f90: 3d20 4265 616d 5479 7065 2e45 4c45 4354  = BeamType.ELECT
-00008fa0: 524f 4e0a 2020 2020 2920 2d3e 204e 6f6e  RON.    ) -> Non
-00008fb0: 653a 0a20 2020 2020 2020 2022 2222 0a20  e:.        """. 
-00008fc0: 2020 2020 2020 204d 6f76 6573 2074 6865         Moves the
-00008fd0: 206d 6963 726f 7363 6f70 6520 7374 6167   microscope stag
-00008fe0: 6520 746f 2074 6865 2074 696c 7420 616e  e to the tilt an
-00008ff0: 676c 6520 636f 7272 6573 706f 6e64 696e  gle correspondin
-00009000: 6720 746f 2074 6865 2067 6976 656e 2062  g to the given b
-00009010: 6561 6d20 7479 7065 2c0a 2020 2020 2020  eam type,.      
-00009020: 2020 736f 2074 6861 7420 7468 6520 7374    so that the st
-00009030: 6167 6520 6973 2066 6c61 7420 7769 7468  age is flat with
-00009040: 2072 6573 7065 6374 2074 6f20 7468 6520   respect to the 
-00009050: 6265 616d 2e0a 0a20 2020 2020 2020 2041  beam...        A
-00009060: 7267 733a 0a20 2020 2020 2020 2020 2020  rgs:.           
-00009070: 2073 6574 7469 6e67 7320 284d 6963 726f   settings (Micro
-00009080: 7363 6f70 6553 6574 7469 6e67 7329 3a20  scopeSettings): 
-00009090: 5468 6520 6375 7272 656e 7420 6d69 6372  The current micr
-000090a0: 6f73 636f 7065 2073 6574 7469 6e67 732e  oscope settings.
-000090b0: 0a20 2020 2020 2020 2020 2020 2062 6561  .            bea
-000090c0: 6d5f 7479 7065 2028 4265 616d 5479 7065  m_type (BeamType
-000090d0: 293a 2054 6865 2074 7970 6520 6f66 2062  ): The type of b
-000090e0: 6561 6d20 746f 2077 6869 6368 2074 6865  eam to which the
-000090f0: 2073 7461 6765 2073 686f 756c 6420 6265   stage should be
-00009100: 206d 6164 6520 666c 6174 2e0a 2020 2020   made flat..    
-00009110: 2020 2020 2020 2020 2020 2020 4d75 7374              Must
-00009120: 2062 6520 6f6e 6520 6f66 2042 6561 6d54   be one of BeamT
-00009130: 7970 652e 454c 4543 5452 4f4e 206f 7220  ype.ELECTRON or 
-00009140: 4265 616d 5479 7065 2e49 4f4e 2e0a 0a20  BeamType.ION... 
-00009150: 2020 2020 2020 2052 6574 7572 6e73 3a0a         Returns:.
-00009160: 2020 2020 2020 2020 2020 2020 4e6f 6e65              None
-00009170: 2e0a 2020 2020 2020 2020 2222 220a 2020  ..        """.  
-00009180: 2020 2020 2020 5f63 6865 636b 5f73 7461        _check_sta
-00009190: 6765 2873 656c 662e 6861 7264 7761 7265  ge(self.hardware
-000091a0: 5f73 6574 7469 6e67 732c 2074 696c 743d  _settings, tilt=
-000091b0: 5472 7565 290a 2020 2020 2020 2020 7374  True).        st
-000091c0: 6167 655f 7365 7474 696e 6773 203d 2073  age_settings = s
-000091d0: 6574 7469 6e67 732e 7379 7374 656d 2e73  ettings.system.s
-000091e0: 7461 6765 0a0a 2020 2020 2020 2020 6966  tage..        if
-000091f0: 2062 6561 6d5f 7479 7065 2069 7320 4265   beam_type is Be
-00009200: 616d 5479 7065 2e45 4c45 4354 524f 4e3a  amType.ELECTRON:
-00009210: 0a20 2020 2020 2020 2020 2020 2072 6f74  .            rot
-00009220: 6174 696f 6e20 3d20 6e70 2e64 6567 3272  ation = np.deg2r
-00009230: 6164 2873 7461 6765 5f73 6574 7469 6e67  ad(stage_setting
-00009240: 732e 726f 7461 7469 6f6e 5f66 6c61 745f  s.rotation_flat_
-00009250: 746f 5f65 6c65 6374 726f 6e29 0a20 2020  to_electron).   
-00009260: 2020 2020 2020 2020 2074 696c 7420 3d20           tilt = 
-00009270: 6e70 2e64 6567 3272 6164 2873 7461 6765  np.deg2rad(stage
-00009280: 5f73 6574 7469 6e67 732e 7072 655f 7469  _settings.pre_ti
-00009290: 6c74 290a 0a20 2020 2020 2020 2069 6620  lt)..        if 
-000092a0: 6265 616d 5f74 7970 6520 6973 2042 6561  beam_type is Bea
-000092b0: 6d54 7970 652e 494f 4e3a 0a20 2020 2020  mType.ION:.     
-000092c0: 2020 2020 2020 2072 6f74 6174 696f 6e20         rotation 
-000092d0: 3d20 6e70 2e64 6567 3272 6164 2873 7461  = np.deg2rad(sta
-000092e0: 6765 5f73 6574 7469 6e67 732e 726f 7461  ge_settings.rota
-000092f0: 7469 6f6e 5f66 6c61 745f 746f 5f69 6f6e  tion_flat_to_ion
-00009300: 290a 2020 2020 2020 2020 2020 2020 7469  ).            ti
-00009310: 6c74 203d 206e 702e 6465 6732 7261 6428  lt = np.deg2rad(
-00009320: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00009330: 2073 7461 6765 5f73 6574 7469 6e67 732e   stage_settings.
-00009340: 7469 6c74 5f66 6c61 745f 746f 5f69 6f6e  tilt_flat_to_ion
-00009350: 202d 2073 7461 6765 5f73 6574 7469 6e67   - stage_setting
-00009360: 732e 7072 655f 7469 6c74 0a20 2020 2020  s.pre_tilt.     
-00009370: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
-00009380: 2020 706f 7369 7469 6f6e 203d 2073 656c    position = sel
-00009390: 662e 6765 745f 7374 6167 655f 706f 7369  f.get_stage_posi
-000093a0: 7469 6f6e 2829 0a0a 2020 2020 2020 2020  tion()..        
-000093b0: 2320 7570 6461 7465 6420 7361 6665 2072  # updated safe r
-000093c0: 6f74 6174 696f 6e20 6d6f 7665 0a20 2020  otation move.   
-000093d0: 2020 2020 206c 6f67 6769 6e67 2e69 6e66       logging.inf
-000093e0: 6f28 6622 6d6f 7669 6e67 2066 6c61 7420  o(f"moving flat 
-000093f0: 746f 207b 6265 616d 5f74 7970 652e 6e61  to {beam_type.na
-00009400: 6d65 7d22 290a 2020 2020 2020 2020 7374  me}").        st
-00009410: 6167 655f 706f 7369 7469 6f6e 203d 2046  age_position = F
-00009420: 6962 7365 6d53 7461 6765 506f 7369 7469  ibsemStagePositi
-00009430: 6f6e 2878 203d 2070 6f73 6974 696f 6e2e  on(x = position.
-00009440: 782c 2079 203d 2070 6f73 6974 696f 6e2e  x, y = position.
-00009450: 792c 207a 3d70 6f73 6974 696f 6e2e 7a2c  y, z=position.z,
-00009460: 2072 3d72 6f74 6174 696f 6e2c 2074 3d74   r=rotation, t=t
-00009470: 696c 7429 0a20 2020 2020 2020 2073 656c  ilt).        sel
-00009480: 662e 6d6f 7665 5f73 7461 6765 5f61 6273  f.move_stage_abs
-00009490: 6f6c 7574 6528 7374 6167 655f 706f 7369  olute(stage_posi
-000094a0: 7469 6f6e 290a 0a20 2020 2064 6566 2067  tion)..    def g
-000094b0: 6574 5f6d 616e 6970 756c 6174 6f72 5f73  et_manipulator_s
-000094c0: 7461 7465 2873 656c 662c 7365 7474 696e  tate(self,settin
-000094d0: 6773 3a4d 6963 726f 7363 6f70 6553 6574  gs:MicroscopeSet
-000094e0: 7469 6e67 733d 4e6f 6e65 293a 0a0a 2020  tings=None):..  
-000094f0: 2020 2020 2020 7374 6174 6520 3d20 7365        state = se
-00009500: 6c66 2e63 6f6e 6e65 6374 696f 6e2e 7370  lf.connection.sp
-00009510: 6563 696d 656e 2e6d 616e 6970 756c 6174  ecimen.manipulat
-00009520: 6f72 2e73 7461 7465 0a0a 2020 2020 2020  or.state..      
-00009530: 2020 7265 7475 726e 2054 7275 6520 6966    return True if
-00009540: 2073 7461 7465 203d 3d20 4d61 6e69 7075   state == Manipu
-00009550: 6c61 746f 7253 7461 7465 2e49 4e53 4552  latorState.INSER
-00009560: 5445 4420 656c 7365 2046 616c 7365 0a0a  TED else False..
-00009570: 2020 2020 6465 6620 6765 745f 6d61 6e69      def get_mani
-00009580: 7075 6c61 746f 725f 706f 7369 7469 6f6e  pulator_position
-00009590: 2873 656c 6629 202d 3e20 4669 6273 656d  (self) -> Fibsem
-000095a0: 4d61 6e69 7075 6c61 746f 7250 6f73 6974  ManipulatorPosit
-000095b0: 696f 6e3a 0a20 2020 2020 2020 2069 6620  ion:.        if 
-000095c0: 7365 6c66 2e68 6172 6477 6172 655f 7365  self.hardware_se
-000095d0: 7474 696e 6773 2e6d 616e 6970 756c 6174  ttings.manipulat
-000095e0: 6f72 5f65 6e61 626c 6564 2069 7320 4661  or_enabled is Fa
-000095f0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00009600: 2072 6169 7365 204e 6f74 496d 706c 656d   raise NotImplem
-00009610: 656e 7465 6445 7272 6f72 2822 4d61 6e69  entedError("Mani
-00009620: 7075 6c61 746f 7220 6e6f 7420 656e 6162  pulator not enab
-00009630: 6c65 642e 2229 0a20 2020 2020 2020 2070  led.").        p
-00009640: 6f73 6974 696f 6e20 3d20 7365 6c66 2e63  osition = self.c
-00009650: 6f6e 6e65 6374 696f 6e2e 7370 6563 696d  onnection.specim
-00009660: 656e 2e6d 616e 6970 756c 6174 6f72 2e63  en.manipulator.c
-00009670: 7572 7265 6e74 5f70 6f73 6974 696f 6e0a  urrent_position.
-00009680: 2020 2020 2020 2020 7265 7475 726e 2046          return F
-00009690: 6962 7365 6d4d 616e 6970 756c 6174 6f72  ibsemManipulator
-000096a0: 506f 7369 7469 6f6e 2e66 726f 6d5f 6175  Position.from_au
-000096b0: 746f 7363 7269 7074 5f70 6f73 6974 696f  toscript_positio
-000096c0: 6e28 706f 7369 7469 6f6e 290a 2020 2020  n(position).    
-000096d0: 0a20 2020 2064 6566 2069 6e73 6572 745f  .    def insert_
-000096e0: 6d61 6e69 7075 6c61 746f 7228 7365 6c66  manipulator(self
-000096f0: 2c20 6e61 6d65 3a20 7374 7220 3d20 2250  , name: str = "P
-00009700: 4152 4b22 293a 0a20 2020 2020 2020 2069  ARK"):.        i
-00009710: 6620 7365 6c66 2e68 6172 6477 6172 655f  f self.hardware_
-00009720: 7365 7474 696e 6773 2e6d 616e 6970 756c  settings.manipul
-00009730: 6174 6f72 5f65 6e61 626c 6564 2069 7320  ator_enabled is 
-00009740: 4661 6c73 653a 0a20 2020 2020 2020 2020  False:.         
-00009750: 2020 2072 6169 7365 204e 6f74 496d 706c     raise NotImpl
-00009760: 656d 656e 7465 6445 7272 6f72 2822 4d61  ementedError("Ma
-00009770: 6e69 7075 6c61 746f 7220 6e6f 7420 656e  nipulator not en
-00009780: 6162 6c65 642e 2229 0a20 2020 2020 2020  abled.").       
-00009790: 2020 0a20 2020 2020 2020 2069 6620 6e61    .        if na
-000097a0: 6d65 206e 6f74 2069 6e20 5b22 5041 524b  me not in ["PARK
-000097b0: 222c 2022 4555 4345 4e54 5249 4322 5d3a  ", "EUCENTRIC"]:
-000097c0: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
-000097d0: 7365 2056 616c 7565 4572 726f 7228 6622  se ValueError(f"
-000097e0: 696e 7365 7274 2070 6f73 6974 696f 6e20  insert position 
-000097f0: 7b6e 616d 657d 206e 6f74 2073 7570 706f  {name} not suppo
-00009800: 7274 6564 2e22 290a 0a20 2020 2020 2020  rted.")..       
-00009810: 2069 6e73 6572 745f 706f 7369 7469 6f6e   insert_position
-00009820: 203d 204d 616e 6970 756c 6174 6f72 5361   = ManipulatorSa
-00009830: 7665 6450 6f73 6974 696f 6e2e 5041 524b  vedPosition.PARK
-00009840: 2069 6620 6e61 6d65 203d 3d20 2250 4152   if name == "PAR
-00009850: 4b22 2065 6c73 6520 4d61 6e69 7075 6c61  K" else Manipula
-00009860: 746f 7253 6176 6564 506f 7369 7469 6f6e  torSavedPosition
-00009870: 2e45 5543 454e 5452 4943 0a20 2020 2020  .EUCENTRIC.     
-00009880: 2020 206e 6565 646c 6520 3d20 7365 6c66     needle = self
-00009890: 2e63 6f6e 6e65 6374 696f 6e2e 7370 6563  .connection.spec
-000098a0: 696d 656e 2e6d 616e 6970 756c 6174 6f72  imen.manipulator
-000098b0: 0a20 2020 2020 2020 2069 6e73 6572 745f  .        insert_
-000098c0: 706f 7369 7469 6f6e 203d 206e 6565 646c  position = needl
-000098d0: 652e 6765 745f 7361 7665 645f 706f 7369  e.get_saved_posi
-000098e0: 7469 6f6e 280a 2020 2020 2020 2020 2020  tion(.          
-000098f0: 2020 696e 7365 7274 5f70 6f73 6974 696f    insert_positio
-00009900: 6e2c 204d 616e 6970 756c 6174 6f72 436f  n, ManipulatorCo
-00009910: 6f72 6469 6e61 7465 5379 7374 656d 2e52  ordinateSystem.R
-00009920: 4157 0a20 2020 2020 2020 2029 0a20 2020  AW.        ).   
-00009930: 2020 2020 206e 6565 646c 652e 696e 7365       needle.inse
-00009940: 7274 2869 6e73 6572 745f 706f 7369 7469  rt(insert_positi
-00009950: 6f6e 290a 2020 2020 2020 2020 6c6f 6767  on).        logg
-00009960: 696e 672e 696e 666f 2866 2269 6e73 6572  ing.info(f"inser
-00009970: 7465 6420 6e65 6564 6c65 2074 6f20 7b69  ted needle to {i
-00009980: 6e73 6572 745f 706f 7369 7469 6f6e 7d2e  nsert_position}.
-00009990: 2229 0a0a 2020 2020 0a20 2020 2064 6566  ")..    .    def
-000099a0: 2072 6574 7261 6374 5f6d 616e 6970 756c   retract_manipul
-000099b0: 6174 6f72 2873 656c 6629 3a0a 2020 2020  ator(self):.    
-000099c0: 2020 2020 0a20 2020 2020 2020 2023 2072      .        # r
-000099d0: 6574 7261 6374 206d 756c 7469 6368 656d  etract multichem
-000099e0: 0a20 2020 2020 2020 2023 2072 6574 7261  .        # retra
-000099f0: 6374 5f6d 756c 7469 6368 656d 286d 6963  ct_multichem(mic
-00009a00: 726f 7363 6f70 6529 2023 2054 4f44 4f3a  roscope) # TODO:
-00009a10: 3f0a 2020 2020 2020 2020 6966 2073 656c  ?.        if sel
-00009a20: 662e 6861 7264 7761 7265 5f73 6574 7469  f.hardware_setti
-00009a30: 6e67 732e 6d61 6e69 7075 6c61 746f 725f  ngs.manipulator_
-00009a40: 656e 6162 6c65 6420 6973 2046 616c 7365  enabled is False
-00009a50: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
-00009a60: 6973 6520 4e6f 7449 6d70 6c65 6d65 6e74  ise NotImplement
-00009a70: 6564 4572 726f 7228 224d 616e 6970 756c  edError("Manipul
-00009a80: 6174 6f72 206e 6f74 2065 6e61 626c 6564  ator not enabled
-00009a90: 2e22 290a 2020 2020 2020 2020 2320 5265  .").        # Re
-00009aa0: 7472 6163 7420 7468 6520 6e65 6564 6c65  tract the needle
-00009ab0: 2c20 7072 6573 6572 7669 6e67 2074 6865  , preserving the
-00009ac0: 2063 6f72 7265 6374 2070 6172 6b69 6e67   correct parking
-00009ad0: 2070 6f73 7469 696f 6e0a 2020 2020 2020   postiion.      
-00009ae0: 2020 6e65 6564 6c65 203d 2073 656c 662e    needle = self.
-00009af0: 636f 6e6e 6563 7469 6f6e 2e73 7065 6369  connection.speci
-00009b00: 6d65 6e2e 6d61 6e69 7075 6c61 746f 720a  men.manipulator.
-00009b10: 2020 2020 2020 2020 7061 726b 5f70 6f73          park_pos
-00009b20: 6974 696f 6e20 3d20 6e65 6564 6c65 2e67  ition = needle.g
-00009b30: 6574 5f73 6176 6564 5f70 6f73 6974 696f  et_saved_positio
-00009b40: 6e28 0a20 2020 2020 2020 2020 2020 204d  n(.            M
-00009b50: 616e 6970 756c 6174 6f72 5361 7665 6450  anipulatorSavedP
-00009b60: 6f73 6974 696f 6e2e 5041 524b 2c20 4d61  osition.PARK, Ma
-00009b70: 6e69 7075 6c61 746f 7243 6f6f 7264 696e  nipulatorCoordin
-00009b80: 6174 6553 7973 7465 6d2e 5241 570a 2020  ateSystem.RAW.  
-00009b90: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
-00009ba0: 206c 6f67 6769 6e67 2e69 6e66 6f28 6622   logging.info(f"
-00009bb0: 7265 7472 6163 7469 6e67 206e 6565 646c  retracting needl
-00009bc0: 6520 746f 207b 7061 726b 5f70 6f73 6974  e to {park_posit
-00009bd0: 696f 6e7d 2229 0a20 2020 2020 2020 206e  ion}").        n
-00009be0: 6565 646c 652e 6162 736f 6c75 7465 5f6d  eedle.absolute_m
-00009bf0: 6f76 6528 7061 726b 5f70 6f73 6974 696f  ove(park_positio
-00009c00: 6e29 0a20 2020 2020 2020 2074 696d 652e  n).        time.
-00009c10: 736c 6565 7028 3129 2020 2320 4175 746f  sleep(1)  # Auto
-00009c20: 5363 7269 7074 2073 6f6d 6574 696d 6573  Script sometimes
-00009c30: 2074 6872 6f77 7320 6572 726f 7273 2069   throws errors i
-00009c40: 6620 796f 7520 7265 7472 6163 7420 746f  f you retract to
-00009c50: 6f20 7175 6963 6b3f 0a20 2020 2020 2020  o quick?.       
-00009c60: 206c 6f67 6769 6e67 2e69 6e66 6f28 6622   logging.info(f"
-00009c70: 7265 7472 6163 7469 6e67 206e 6565 646c  retracting needl
-00009c80: 652e 2e2e 2229 0a20 2020 2020 2020 206e  e...").        n
-00009c90: 6565 646c 652e 7265 7472 6163 7428 290a  eedle.retract().
-00009ca0: 2020 2020 2020 2020 6c6f 6767 696e 672e          logging.
-00009cb0: 696e 666f 2866 2272 6574 7261 6374 206e  info(f"retract n
-00009cc0: 6565 646c 6520 636f 6d70 6c65 7465 2229  eedle complete")
-00009cd0: 0a20 2020 200a 2020 2020 6465 6620 6d6f  .    .    def mo
-00009ce0: 7665 5f6d 616e 6970 756c 6174 6f72 5f72  ve_manipulator_r
-00009cf0: 656c 6174 6976 6528 7365 6c66 2c20 706f  elative(self, po
-00009d00: 7369 7469 6f6e 3a20 4669 6273 656d 4d61  sition: FibsemMa
-00009d10: 6e69 7075 6c61 746f 7250 6f73 6974 696f  nipulatorPositio
-00009d20: 6e29 3a0a 2020 2020 2020 2020 6966 206e  n):.        if n
-00009d30: 6f74 206e 702e 6973 636c 6f73 6528 706f  ot np.isclose(po
-00009d40: 7369 7469 6f6e 2e72 2c20 302e 3029 3a0a  sition.r, 0.0):.
-00009d50: 2020 2020 2020 2020 2020 2020 726f 7461              rota
-00009d60: 7469 6f6e 203d 2054 7275 650a 2020 2020  tion = True.    
-00009d70: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00009d80: 2020 2020 2020 726f 7461 7469 6f6e 203d        rotation =
-00009d90: 2046 616c 7365 0a20 2020 2020 2020 2069   False.        i
-00009da0: 6620 6e6f 7420 6e70 2e69 7363 6c6f 7365  f not np.isclose
-00009db0: 2870 6f73 6974 696f 6e2e 742c 2030 2e30  (position.t, 0.0
-00009dc0: 293a 0a20 2020 2020 2020 2020 2020 2074  ):.            t
-00009dd0: 696c 7420 3d20 5472 7565 0a20 2020 2020  ilt = True.     
-00009de0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00009df0: 2020 2020 2074 696c 7420 3d20 4661 6c73       tilt = Fals
-00009e00: 650a 2020 2020 2020 2020 5f63 6865 636b  e.        _check
-00009e10: 5f6e 6565 646c 6528 7365 6c66 2e68 6172  _needle(self.har
-00009e20: 6477 6172 655f 7365 7474 696e 6773 2c20  dware_settings, 
-00009e30: 726f 7461 7469 6f6e 2c20 7469 6c74 290a  rotation, tilt).
-00009e40: 2020 2020 2020 2020 6e65 6564 6c65 203d          needle =
-00009e50: 2073 656c 662e 636f 6e6e 6563 7469 6f6e   self.connection
-00009e60: 2e73 7065 6369 6d65 6e2e 6d61 6e69 7075  .specimen.manipu
-00009e70: 6c61 746f 720a 2020 2020 2020 2020 706f  lator.        po
-00009e80: 7369 7469 6f6e 203d 2070 6f73 6974 696f  sition = positio
-00009e90: 6e2e 746f 5f61 7574 6f73 6372 6970 745f  n.to_autoscript_
-00009ea0: 706f 7369 7469 6f6e 2829 0a20 2020 2020  position().     
-00009eb0: 2020 206c 6f67 6769 6e67 2e69 6e66 6f28     logging.info(
-00009ec0: 6622 6d6f 7669 6e67 206d 616e 6970 756c  f"moving manipul
-00009ed0: 6174 6f72 2062 7920 7b70 6f73 6974 696f  ator by {positio
-00009ee0: 6e7d 2229 0a20 2020 2020 2020 206e 6565  n}").        nee
-00009ef0: 646c 652e 7265 6c61 7469 7665 5f6d 6f76  dle.relative_mov
-00009f00: 6528 706f 7369 7469 6f6e 290a 2020 2020  e(position).    
-00009f10: 0a20 2020 2064 6566 206d 6f76 655f 6d61  .    def move_ma
-00009f20: 6e69 7075 6c61 746f 725f 6162 736f 6c75  nipulator_absolu
-00009f30: 7465 2873 656c 662c 2070 6f73 6974 696f  te(self, positio
-00009f40: 6e3a 2046 6962 7365 6d4d 616e 6970 756c  n: FibsemManipul
-00009f50: 6174 6f72 506f 7369 7469 6f6e 293a 0a20  atorPosition):. 
-00009f60: 2020 2020 2020 2069 6620 6e6f 7420 6e70         if not np
-00009f70: 2e69 7363 6c6f 7365 2870 6f73 6974 696f  .isclose(positio
-00009f80: 6e2e 722c 2030 2e30 293a 0a20 2020 2020  n.r, 0.0):.     
-00009f90: 2020 2020 2020 2072 6f74 6174 696f 6e20         rotation 
-00009fa0: 3d20 5472 7565 0a20 2020 2020 2020 2065  = True.        e
-00009fb0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00009fc0: 2072 6f74 6174 696f 6e20 3d20 4661 6c73   rotation = Fals
-00009fd0: 650a 2020 2020 2020 2020 6966 206e 6f74  e.        if not
-00009fe0: 206e 702e 6973 636c 6f73 6528 706f 7369   np.isclose(posi
-00009ff0: 7469 6f6e 2e74 2c20 302e 3029 3a0a 2020  tion.t, 0.0):.  
-0000a000: 2020 2020 2020 2020 2020 7469 6c74 203d            tilt =
-0000a010: 2054 7275 650a 2020 2020 2020 2020 656c   True.        el
-0000a020: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-0000a030: 7469 6c74 203d 2046 616c 7365 0a20 2020  tilt = False.   
-0000a040: 2020 2020 205f 6368 6563 6b5f 6e65 6564       _check_need
-0000a050: 6c65 2873 656c 662e 6861 7264 7761 7265  le(self.hardware
-0000a060: 5f73 6574 7469 6e67 732c 2072 6f74 6174  _settings, rotat
-0000a070: 696f 6e2c 2074 696c 7429 0a20 2020 2020  ion, tilt).     
-0000a080: 2020 206e 6565 646c 6520 3d20 7365 6c66     needle = self
-0000a090: 2e63 6f6e 6e65 6374 696f 6e2e 7370 6563  .connection.spec
-0000a0a0: 696d 656e 2e6d 616e 6970 756c 6174 6f72  imen.manipulator
-0000a0b0: 0a20 2020 2020 2020 2070 6f73 6974 696f  .        positio
-0000a0c0: 6e20 3d20 706f 7369 7469 6f6e 2e74 6f5f  n = position.to_
-0000a0d0: 6175 746f 7363 7269 7074 5f70 6f73 6974  autoscript_posit
-0000a0e0: 696f 6e28 290a 2020 2020 2020 2020 6c6f  ion().        lo
-0000a0f0: 6767 696e 672e 696e 666f 2866 226d 6f76  gging.info(f"mov
-0000a100: 696e 6720 6d61 6e69 7075 6c61 746f 7220  ing manipulator 
-0000a110: 746f 207b 706f 7369 7469 6f6e 7d22 290a  to {position}").
-0000a120: 2020 2020 2020 2020 6e65 6564 6c65 2e61          needle.a
-0000a130: 6273 6f6c 7574 655f 6d6f 7665 2870 6f73  bsolute_move(pos
-0000a140: 6974 696f 6e29 0a20 2020 2020 2020 200a  ition).        .
-0000a150: 0a20 2020 2064 6566 205f 785f 636f 7272  .    def _x_corr
-0000a160: 6563 7465 645f 6e65 6564 6c65 5f6d 6f76  ected_needle_mov
-0000a170: 656d 656e 7428 7365 6c66 2c20 6578 7065  ement(self, expe
-0000a180: 6374 6564 5f78 3a20 666c 6f61 7429 202d  cted_x: float) -
-0000a190: 3e20 4669 6273 656d 4d61 6e69 7075 6c61  > FibsemManipula
-0000a1a0: 746f 7250 6f73 6974 696f 6e3a 0a20 2020  torPosition:.   
-0000a1b0: 2020 2020 2022 2222 4361 6c63 756c 6174       """Calculat
-0000a1c0: 6520 7468 6520 636f 7272 6563 7465 6420  e the corrected 
-0000a1d0: 6e65 6564 6c65 206d 6f76 656d 656e 7420  needle movement 
-0000a1e0: 746f 206d 6f76 6520 696e 2074 6865 2078  to move in the x
-0000a1f0: 2d61 7869 732e 0a0a 2020 2020 2020 2020  -axis...        
-0000a200: 4172 6773 3a0a 2020 2020 2020 2020 2020  Args:.          
-0000a210: 2020 6578 7065 6374 6564 5f78 2028 666c    expected_x (fl
-0000a220: 6f61 7429 3a20 6469 7374 616e 6365 2061  oat): distance a
-0000a230: 6c6f 6e67 2074 6865 2078 2d61 7869 7320  long the x-axis 
-0000a240: 2869 6d61 6765 2063 6f6f 7264 696e 6174  (image coordinat
-0000a250: 6573 290a 2020 2020 2020 2020 5265 7475  es).        Retu
-0000a260: 726e 733a 0a20 2020 2020 2020 2020 2020  rns:.           
-0000a270: 2046 6962 7365 6d4d 616e 6970 756c 6174   FibsemManipulat
-0000a280: 6f72 506f 7369 7469 6f6e 3a20 782d 636f  orPosition: x-co
-0000a290: 7272 6563 7465 6420 6e65 6564 6c65 206d  rrected needle m
-0000a2a0: 6f76 656d 656e 7420 2872 656c 6174 6976  ovement (relativ
-0000a2b0: 6520 706f 7369 7469 6f6e 290a 2020 2020  e position).    
-0000a2c0: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-0000a2d0: 7265 7475 726e 2046 6962 7365 6d4d 616e  return FibsemMan
-0000a2e0: 6970 756c 6174 6f72 506f 7369 7469 6f6e  ipulatorPosition
-0000a2f0: 2878 3d65 7870 6563 7465 645f 782c 2079  (x=expected_x, y
-0000a300: 3d30 2c20 7a3d 3029 2020 2320 6e6f 2061  =0, z=0)  # no a
-0000a310: 646a 7573 746d 656e 7420 6e65 6564 6564  djustment needed
-0000a320: 0a0a 0a20 2020 2064 6566 205f 795f 636f  ...    def _y_co
-0000a330: 7272 6563 7465 645f 6e65 6564 6c65 5f6d  rrected_needle_m
-0000a340: 6f76 656d 656e 7428 7365 6c66 2c20 0a20  ovement(self, . 
-0000a350: 2020 2020 2020 2065 7870 6563 7465 645f         expected_
-0000a360: 793a 2066 6c6f 6174 2c20 7374 6167 655f  y: float, stage_
-0000a370: 7469 6c74 3a20 666c 6f61 740a 2020 2020  tilt: float.    
-0000a380: 2920 2d3e 2046 6962 7365 6d4d 616e 6970  ) -> FibsemManip
-0000a390: 756c 6174 6f72 506f 7369 7469 6f6e 3a0a  ulatorPosition:.
-0000a3a0: 2020 2020 2020 2020 2222 2243 616c 6375          """Calcu
-0000a3b0: 6c61 7465 2074 6865 2063 6f72 7265 6374  late the correct
-0000a3c0: 6564 206e 6565 646c 6520 6d6f 7665 6d65  ed needle moveme
-0000a3d0: 6e74 2074 6f20 6d6f 7665 2069 6e20 7468  nt to move in th
-0000a3e0: 6520 792d 6178 6973 2e0a 0a20 2020 2020  e y-axis...     
-0000a3f0: 2020 2041 7267 733a 0a20 2020 2020 2020     Args:.       
-0000a400: 2020 2020 2065 7870 6563 7465 645f 7920       expected_y 
-0000a410: 2866 6c6f 6174 293a 2064 6973 7461 6e63  (float): distanc
-0000a420: 6520 616c 6f6e 6720 7468 6520 792d 6178  e along the y-ax
-0000a430: 6973 2028 696d 6167 6520 636f 6f72 6469  is (image coordi
-0000a440: 6e61 7465 7329 0a20 2020 2020 2020 2020  nates).         
-0000a450: 2020 2073 7461 6765 5f74 696c 7420 2866     stage_tilt (f
-0000a460: 6c6f 6174 2c20 6f70 7469 6f6e 616c 293a  loat, optional):
-0000a470: 2073 7461 6765 2074 696c 742e 0a0a 2020   stage tilt...  
-0000a480: 2020 2020 2020 5265 7475 726e 733a 0a20        Returns:. 
-0000a490: 2020 2020 2020 2020 2020 2046 6962 7365             Fibse
-0000a4a0: 6d4d 616e 6970 756c 6174 6f72 506f 7369  mManipulatorPosi
-0000a4b0: 7469 6f6e 3a20 792d 636f 7272 6563 7465  tion: y-correcte
-0000a4c0: 6420 6e65 6564 6c65 206d 6f76 656d 656e  d needle movemen
-0000a4d0: 7420 2872 656c 6174 6976 6520 706f 7369  t (relative posi
-0000a4e0: 7469 6f6e 290a 2020 2020 2020 2020 2222  tion).        ""
-0000a4f0: 220a 2020 2020 2020 2020 795f 6d6f 7665  ".        y_move
-0000a500: 203d 202b 6e70 2e63 6f73 2873 7461 6765   = +np.cos(stage
-0000a510: 5f74 696c 7429 202a 2065 7870 6563 7465  _tilt) * expecte
-0000a520: 645f 790a 2020 2020 2020 2020 7a5f 6d6f  d_y.        z_mo
-0000a530: 7665 203d 202b 6e70 2e73 696e 2873 7461  ve = +np.sin(sta
-0000a540: 6765 5f74 696c 7429 202a 2065 7870 6563  ge_tilt) * expec
-0000a550: 7465 645f 790a 2020 2020 2020 2020 7265  ted_y.        re
-0000a560: 7475 726e 2046 6962 7365 6d4d 616e 6970  turn FibsemManip
-0000a570: 756c 6174 6f72 506f 7369 7469 6f6e 2878  ulatorPosition(x
-0000a580: 3d30 2c20 793d 795f 6d6f 7665 2c20 7a3d  =0, y=y_move, z=
-0000a590: 7a5f 6d6f 7665 290a 0a0a 2020 2020 6465  z_move)...    de
-0000a5a0: 6620 5f7a 5f63 6f72 7265 6374 6564 5f6e  f _z_corrected_n
-0000a5b0: 6565 646c 655f 6d6f 7665 6d65 6e74 2873  eedle_movement(s
-0000a5c0: 656c 662c 200a 2020 2020 2020 2020 6578  elf, .        ex
-0000a5d0: 7065 6374 6564 5f7a 3a20 666c 6f61 742c  pected_z: float,
-0000a5e0: 2073 7461 6765 5f74 696c 743a 2066 6c6f   stage_tilt: flo
-0000a5f0: 6174 0a20 2020 2029 202d 3e20 4669 6273  at.    ) -> Fibs
-0000a600: 656d 4d61 6e69 7075 6c61 746f 7250 6f73  emManipulatorPos
-0000a610: 6974 696f 6e3a 0a20 2020 2020 2020 2022  ition:.        "
-0000a620: 2222 4361 6c63 756c 6174 6520 7468 6520  ""Calculate the 
-0000a630: 636f 7272 6563 7465 6420 6e65 6564 6c65  corrected needle
-0000a640: 206d 6f76 656d 656e 7420 746f 206d 6f76   movement to mov
-0000a650: 6520 696e 2074 6865 207a 2d61 7869 732e  e in the z-axis.
-0000a660: 0a0a 2020 2020 2020 2020 4172 6773 3a0a  ..        Args:.
-0000a670: 2020 2020 2020 2020 2020 2020 6578 7065              expe
-0000a680: 6374 6564 5f7a 2028 666c 6f61 7429 3a20  cted_z (float): 
-0000a690: 6469 7374 616e 6365 2061 6c6f 6e67 2074  distance along t
-0000a6a0: 6865 207a 2d61 7869 7320 2869 6d61 6765  he z-axis (image
-0000a6b0: 2063 6f6f 7264 696e 6174 6573 290a 2020   coordinates).  
-0000a6c0: 2020 2020 2020 2020 2020 7374 6167 655f            stage_
-0000a6d0: 7469 6c74 2028 666c 6f61 742c 206f 7074  tilt (float, opt
-0000a6e0: 696f 6e61 6c29 3a20 7374 6167 6520 7469  ional): stage ti
-0000a6f0: 6c74 2e0a 0a20 2020 2020 2020 2052 6574  lt...        Ret
-0000a700: 7572 6e73 3a0a 2020 2020 2020 2020 2020  urns:.          
-0000a710: 2020 4669 6273 656d 4d61 6e69 7075 6c61    FibsemManipula
-0000a720: 746f 7250 6f73 6974 696f 6e3a 207a 2d63  torPosition: z-c
-0000a730: 6f72 7265 6374 6564 206e 6565 646c 6520  orrected needle 
-0000a740: 6d6f 7665 6d65 6e74 2028 7265 6c61 7469  movement (relati
-0000a750: 7665 2070 6f73 6974 696f 6e29 0a20 2020  ve position).   
-0000a760: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-0000a770: 2079 5f6d 6f76 6520 3d20 2d6e 702e 7369   y_move = -np.si
-0000a780: 6e28 7374 6167 655f 7469 6c74 2920 2a20  n(stage_tilt) * 
-0000a790: 6578 7065 6374 6564 5f7a 0a20 2020 2020  expected_z.     
-0000a7a0: 2020 207a 5f6d 6f76 6520 3d20 2b6e 702e     z_move = +np.
-0000a7b0: 636f 7328 7374 6167 655f 7469 6c74 2920  cos(stage_tilt) 
-0000a7c0: 2a20 6578 7065 6374 6564 5f7a 0a20 2020  * expected_z.   
-0000a7d0: 2020 2020 2072 6574 7572 6e20 4669 6273       return Fibs
-0000a7e0: 656d 4d61 6e69 7075 6c61 746f 7250 6f73  emManipulatorPos
-0000a7f0: 6974 696f 6e28 783d 302c 2079 3d79 5f6d  ition(x=0, y=y_m
-0000a800: 6f76 652c 207a 3d7a 5f6d 6f76 6529 0a0a  ove, z=z_move)..
-0000a810: 2020 2020 6465 6620 6d6f 7665 5f6d 616e      def move_man
-0000a820: 6970 756c 6174 6f72 5f63 6f72 7265 6374  ipulator_correct
-0000a830: 6564 2873 656c 662c 200a 2020 2020 2020  ed(self, .      
-0000a840: 2020 6478 3a20 666c 6f61 7420 3d20 302c    dx: float = 0,
-0000a850: 0a20 2020 2020 2020 2064 793a 2066 6c6f  .        dy: flo
-0000a860: 6174 203d 2030 2c0a 2020 2020 2020 2020  at = 0,.        
-0000a870: 6265 616d 5f74 7970 653a 2042 6561 6d54  beam_type: BeamT
-0000a880: 7970 6520 3d20 4265 616d 5479 7065 2e45  ype = BeamType.E
-0000a890: 4c45 4354 524f 4e2c 0a20 2020 2029 202d  LECTRON,.    ) -
-0000a8a0: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
-0000a8b0: 2222 2243 616c 6375 6c61 7465 2074 6865  """Calculate the
-0000a8c0: 2072 6571 7569 7265 6420 636f 7272 6563   required correc
-0000a8d0: 7465 6420 6e65 6564 6c65 206d 6f76 656d  ted needle movem
-0000a8e0: 656e 7473 2062 6173 6564 206f 6e20 7468  ents based on th
-0000a8f0: 6520 4265 616d 5479 7065 2074 6f20 6d6f  e BeamType to mo
-0000a900: 7665 2069 6e20 7468 6520 6465 7369 7265  ve in the desire
-0000a910: 6420 696d 6167 6520 636f 6f72 6469 6e61  d image coordina
-0000a920: 7465 732e 0a20 2020 2020 2020 2054 6865  tes..        The
-0000a930: 6e20 6d6f 7665 2074 6865 206e 6565 646c  n move the needl
-0000a940: 6520 7265 6c61 7469 7665 6c79 2e0a 0a20  e relatively... 
-0000a950: 2020 2020 2020 2042 6561 6d54 7970 652e         BeamType.
-0000a960: 454c 4543 5452 4f4e 3a20 206d 6f76 6520  ELECTRON:  move 
-0000a970: 696e 2078 2c20 7920 2872 6177 2063 6f6f  in x, y (raw coo
-0000a980: 7264 696e 6174 6573 290a 2020 2020 2020  rdinates).      
-0000a990: 2020 4265 616d 5479 7065 2e49 4f4e 3a20    BeamType.ION: 
-0000a9a0: 2020 2020 2020 6d6f 7665 2069 6e20 782c        move in x,
-0000a9b0: 207a 2028 7261 7720 636f 6f72 6469 6e61   z (raw coordina
-0000a9c0: 7465 7329 0a0a 2020 2020 2020 2020 4172  tes)..        Ar
-0000a9d0: 6773 3a0a 2020 2020 2020 2020 2020 2020  gs:.            
-0000a9e0: 6d69 6372 6f73 636f 7065 2028 5364 624d  microscope (SdbM
-0000a9f0: 6963 726f 7363 6f70 6543 6c69 656e 7429  icroscopeClient)
-0000aa00: 3a20 6175 746f 5363 7269 7074 206d 6963  : autoScript mic
-0000aa10: 726f 7363 6f70 6520 696e 7374 616e 6365  roscope instance
-0000aa20: 0a20 2020 2020 2020 2020 2020 2064 7820  .            dx 
-0000aa30: 2866 6c6f 6174 293a 2064 6973 7461 6e63  (float): distanc
-0000aa40: 6520 616c 6f6e 6720 7468 6520 782d 6178  e along the x-ax
-0000aa50: 6973 2028 696d 6167 6520 636f 6f72 6469  is (image coordi
-0000aa60: 6e61 7465 7329 0a20 2020 2020 2020 2020  nates).         
-0000aa70: 2020 2064 7920 2866 6c6f 6174 293a 2064     dy (float): d
-0000aa80: 6973 7461 6e63 6520 616c 6f6e 6720 7468  istance along th
-0000aa90: 6520 792d 6178 6973 2028 696d 6167 6520  e y-axis (image 
-0000aaa0: 636f 726f 6469 6e61 7465 7329 0a20 2020  corodinates).   
-0000aab0: 2020 2020 2020 2020 2062 6561 6d5f 7479           beam_ty
-0000aac0: 7065 2028 4265 616d 5479 7065 2c20 6f70  pe (BeamType, op
-0000aad0: 7469 6f6e 616c 293a 2074 6865 2062 6561  tional): the bea
-0000aae0: 6d20 7479 7065 2074 6f20 6d6f 7665 2069  m type to move i
-0000aaf0: 6e2e 2044 6566 6175 6c74 7320 746f 2042  n. Defaults to B
-0000ab00: 6561 6d54 7970 652e 454c 4543 5452 4f4e  eamType.ELECTRON
-0000ab10: 2e0a 2020 2020 2020 2020 2222 220a 2020  ..        """.  
-0000ab20: 2020 2020 2020 5f63 6865 636b 5f6e 6565        _check_nee
-0000ab30: 646c 6528 7365 6c66 2e68 6172 6477 6172  dle(self.hardwar
-0000ab40: 655f 7365 7474 696e 6773 290a 2020 2020  e_settings).    
-0000ab50: 2020 2020 6e65 6564 6c65 203d 2073 656c      needle = sel
-0000ab60: 662e 636f 6e6e 6563 7469 6f6e 2e73 7065  f.connection.spe
-0000ab70: 6369 6d65 6e2e 6d61 6e69 7075 6c61 746f  cimen.manipulato
-0000ab80: 720a 2020 2020 2020 2020 7374 6167 655f  r.        stage_
-0000ab90: 7469 6c74 203d 2073 656c 662e 636f 6e6e  tilt = self.conn
-0000aba0: 6563 7469 6f6e 2e73 7065 6369 6d65 6e2e  ection.specimen.
-0000abb0: 7374 6167 652e 6375 7272 656e 745f 706f  stage.current_po
-0000abc0: 7369 7469 6f6e 2e74 0a0a 2020 2020 2020  sition.t..      
-0000abd0: 2020 2320 7879 0a20 2020 2020 2020 2069    # xy.        i
-0000abe0: 6620 6265 616d 5f74 7970 6520 6973 2042  f beam_type is B
-0000abf0: 6561 6d54 7970 652e 454c 4543 5452 4f4e  eamType.ELECTRON
-0000ac00: 3a0a 2020 2020 2020 2020 2020 2020 785f  :.            x_
-0000ac10: 6d6f 7665 203d 2073 656c 662e 5f78 5f63  move = self._x_c
-0000ac20: 6f72 7265 6374 6564 5f6e 6565 646c 655f  orrected_needle_
-0000ac30: 6d6f 7665 6d65 6e74 2865 7870 6563 7465  movement(expecte
-0000ac40: 645f 783d 6478 290a 2020 2020 2020 2020  d_x=dx).        
-0000ac50: 2020 2020 797a 5f6d 6f76 6520 3d20 7365      yz_move = se
-0000ac60: 6c66 2e5f 795f 636f 7272 6563 7465 645f  lf._y_corrected_
-0000ac70: 6e65 6564 6c65 5f6d 6f76 656d 656e 7428  needle_movement(
-0000ac80: 6479 2c20 7374 6167 655f 7469 6c74 3d73  dy, stage_tilt=s
-0000ac90: 7461 6765 5f74 696c 7429 0a0a 2020 2020  tage_tilt)..    
-0000aca0: 2020 2020 2320 787a 2c0a 2020 2020 2020      # xz,.      
-0000acb0: 2020 6966 2062 6561 6d5f 7479 7065 2069    if beam_type i
-0000acc0: 7320 4265 616d 5479 7065 2e49 4f4e 3a0a  s BeamType.ION:.
-0000acd0: 0a20 2020 2020 2020 2020 2020 2078 5f6d  .            x_m
-0000ace0: 6f76 6520 3d20 7365 6c66 2e5f 785f 636f  ove = self._x_co
-0000acf0: 7272 6563 7465 645f 6e65 6564 6c65 5f6d  rrected_needle_m
-0000ad00: 6f76 656d 656e 7428 6578 7065 6374 6564  ovement(expected
-0000ad10: 5f78 3d64 7829 0a20 2020 2020 2020 2020  _x=dx).         
-0000ad20: 2020 2079 7a5f 6d6f 7665 203d 2073 656c     yz_move = sel
-0000ad30: 662e 5f7a 5f63 6f72 7265 6374 6564 5f6e  f._z_corrected_n
-0000ad40: 6565 646c 655f 6d6f 7665 6d65 6e74 2865  eedle_movement(e
-0000ad50: 7870 6563 7465 645f 7a3d 6479 2c20 7374  xpected_z=dy, st
-0000ad60: 6167 655f 7469 6c74 3d73 7461 6765 5f74  age_tilt=stage_t
-0000ad70: 696c 7429 0a0a 2020 2020 2020 2020 2320  ilt)..        # 
-0000ad80: 6d6f 7665 206e 6565 646c 6520 2872 656c  move needle (rel
-0000ad90: 6174 6976 6529 0a20 2020 2020 2020 206e  ative).        n
-0000ada0: 6565 646c 655f 706f 7369 7469 6f6e 203d  eedle_position =
-0000adb0: 204d 616e 6970 756c 6174 6f72 506f 7369   ManipulatorPosi
-0000adc0: 7469 6f6e 2878 3d78 5f6d 6f76 652e 782c  tion(x=x_move.x,
-0000add0: 2079 3d79 7a5f 6d6f 7665 2e79 2c20 7a3d   y=yz_move.y, z=
-0000ade0: 797a 5f6d 6f76 652e 7a2c 2072 203d 204e  yz_move.z, r = N
-0000adf0: 6f6e 6520 2c63 6f6f 7264 696e 6174 655f  one ,coordinate_
-0000ae00: 7379 7374 656d 3d4d 616e 6970 756c 6174  system=Manipulat
-0000ae10: 6f72 436f 6f72 6469 6e61 7465 5379 7374  orCoordinateSyst
-0000ae20: 656d 2e52 4157 290a 2020 2020 2020 2020  em.RAW).        
-0000ae30: 6c6f 6767 696e 672e 696e 666f 2866 224d  logging.info(f"M
-0000ae40: 6f76 696e 6720 6d61 6e69 7075 6c61 746f  oving manipulato
-0000ae50: 723a 207b 6e65 6564 6c65 5f70 6f73 6974  r: {needle_posit
-0000ae60: 696f 6e7d 2e22 290a 2020 2020 2020 2020  ion}.").        
-0000ae70: 6e65 6564 6c65 2e72 656c 6174 6976 655f  needle.relative_
-0000ae80: 6d6f 7665 286e 6565 646c 655f 706f 7369  move(needle_posi
-0000ae90: 7469 6f6e 290a 0a20 2020 2020 2020 2072  tion)..        r
-0000aea0: 6574 7572 6e0a 2020 2020 0a20 2020 2064  eturn.    .    d
-0000aeb0: 6566 206d 6f76 655f 6d61 6e69 7075 6c61  ef move_manipula
-0000aec0: 746f 725f 746f 5f70 6f73 6974 696f 6e5f  tor_to_position_
-0000aed0: 6f66 6673 6574 2873 656c 662c 206f 6666  offset(self, off
-0000aee0: 7365 743a 2046 6962 7365 6d4d 616e 6970  set: FibsemManip
-0000aef0: 756c 6174 6f72 506f 7369 7469 6f6e 2c20  ulatorPosition, 
-0000af00: 6e61 6d65 3a20 7374 7220 3d20 4e6f 6e65  name: str = None
-0000af10: 2920 2d3e 204e 6f6e 653a 0a0a 2020 2020  ) -> None:..    
-0000af20: 2020 2020 2320 544f 444f 3a20 7265 736f      # TODO: reso
-0000af30: 6c76 6520 4669 6273 656d 2050 6f73 6974  lve Fibsem Posit
-0000af40: 696f 6e73 2061 6e64 2054 6865 726d 6f20  ions and Thermo 
-0000af50: 506f 7369 7469 6f6e 730a 2020 2020 2020  Positions.      
-0000af60: 2020 6966 206e 6f74 206e 702e 6973 636c    if not np.iscl
-0000af70: 6f73 6528 6f66 6673 6574 2e72 2c20 302e  ose(offset.r, 0.
-0000af80: 3029 3a0a 2020 2020 2020 2020 2020 2020  0):.            
-0000af90: 726f 7461 7469 6f6e 203d 2054 7275 650a  rotation = True.
-0000afa0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-0000afb0: 2020 2020 2020 2020 2020 726f 7461 7469            rotati
-0000afc0: 6f6e 203d 2046 616c 7365 0a20 2020 2020  on = False.     
-0000afd0: 2020 2069 6620 6e6f 7420 6e70 2e69 7363     if not np.isc
-0000afe0: 6c6f 7365 286f 6666 7365 742e 742c 2030  lose(offset.t, 0
-0000aff0: 2e30 293a 0a20 2020 2020 2020 2020 2020  .0):.           
-0000b000: 2074 696c 7420 3d20 5472 7565 0a20 2020   tilt = True.   
-0000b010: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-0000b020: 2020 2020 2020 2074 696c 7420 3d20 4661         tilt = Fa
-0000b030: 6c73 650a 2020 2020 2020 2020 5f63 6865  lse.        _che
-0000b040: 636b 5f6e 6565 646c 6528 7365 6c66 2e68  ck_needle(self.h
-0000b050: 6172 6477 6172 655f 7365 7474 696e 6773  ardware_settings
-0000b060: 2c20 726f 7461 7469 6f6e 2c20 7469 6c74  , rotation, tilt
-0000b070: 290a 2020 2020 2020 2020 706f 7369 7469  ).        positi
-0000b080: 6f6e 203d 2073 656c 662e 5f67 6574 5f73  on = self._get_s
-0000b090: 6176 6564 5f6d 616e 6970 756c 6174 6f72  aved_manipulator
-0000b0a0: 5f70 6f73 6974 696f 6e28 6e61 6d65 290a  _position(name).
-0000b0b0: 0a20 2020 2020 2020 2023 206d 6f76 6520  .        # move 
-0000b0c0: 746f 2072 656c 6174 6976 6520 746f 2074  to relative to t
-0000b0d0: 6865 2065 7563 656e 7472 6963 2070 6f69  he eucentric poi
-0000b0e0: 6e74 0a20 2020 2020 2020 2079 7a5f 6d6f  nt.        yz_mo
-0000b0f0: 7665 203d 2073 656c 662e 5f7a 5f63 6f72  ve = self._z_cor
-0000b100: 7265 6374 6564 5f6e 6565 646c 655f 6d6f  rected_needle_mo
-0000b110: 7665 6d65 6e74 280a 2020 2020 2020 2020  vement(.        
-0000b120: 2020 2020 6f66 6673 6574 2e7a 2c20 7365      offset.z, se
-0000b130: 6c66 2e63 6f6e 6e65 6374 696f 6e2e 7370  lf.connection.sp
-0000b140: 6563 696d 656e 2e73 7461 6765 2e63 7572  ecimen.stage.cur
-0000b150: 7265 6e74 5f70 6f73 6974 696f 6e2e 740a  rent_position.t.
-0000b160: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-0000b170: 2020 706f 7369 7469 6f6e 2e78 202b 3d20    position.x += 
-0000b180: 6f66 6673 6574 2e78 0a20 2020 2020 2020  offset.x.       
-0000b190: 2070 6f73 6974 696f 6e2e 7920 2b3d 2079   position.y += y
-0000b1a0: 7a5f 6d6f 7665 2e79 202b 206f 6666 7365  z_move.y + offse
-0000b1b0: 742e 790a 2020 2020 2020 2020 706f 7369  t.y.        posi
-0000b1c0: 7469 6f6e 2e7a 202b 3d20 797a 5f6d 6f76  tion.z += yz_mov
-0000b1d0: 652e 7a20 2023 2052 4157 2c20 7570 203d  e.z  # RAW, up =
-0000b1e0: 206e 6567 6174 6976 652c 2053 5441 4745   negative, STAGE
-0000b1f0: 3a20 646f 776e 203d 206e 6567 6174 6976  : down = negativ
-0000b200: 650a 2020 2020 2020 2020 706f 7369 7469  e.        positi
-0000b210: 6f6e 2e72 203d 204e 6f6e 6520 2023 2072  on.r = None  # r
-0000b220: 6f74 6174 696f 6e20 6973 206e 6f74 2073  otation is not s
-0000b230: 7570 706f 7274 6564 0a20 2020 2020 2020  upported.       
-0000b240: 2074 6865 726d 6f5f 706f 7369 7469 6f6e   thermo_position
-0000b250: 203d 2070 6f73 6974 696f 6e2e 746f 5f61   = position.to_a
-0000b260: 7574 6f73 6372 6970 745f 706f 7369 7469  utoscript_positi
-0000b270: 6f6e 2829 0a20 2020 2020 2020 2073 656c  on().        sel
-0000b280: 662e 636f 6e6e 6563 7469 6f6e 2e73 7065  f.connection.spe
-0000b290: 6369 6d65 6e2e 6d61 6e69 7075 6c61 746f  cimen.manipulato
-0000b2a0: 722e 6162 736f 6c75 7465 5f6d 6f76 6528  r.absolute_move(
-0000b2b0: 7468 6572 6d6f 5f70 6f73 6974 696f 6e29  thermo_position)
-0000b2c0: 0a0a 2020 2020 6465 6620 5f67 6574 5f73  ..    def _get_s
-0000b2d0: 6176 6564 5f6d 616e 6970 756c 6174 6f72  aved_manipulator
-0000b2e0: 5f70 6f73 6974 696f 6e28 7365 6c66 2c20  _position(self, 
-0000b2f0: 6e61 6d65 3a20 7374 7220 3d20 2250 4152  name: str = "PAR
-0000b300: 4b22 293a 0a20 2020 2020 2020 200a 2020  K"):.        .  
-0000b310: 2020 2020 2020 6966 206e 616d 6520 6e6f        if name no
-0000b320: 7420 696e 205b 2250 4152 4b22 2c20 2245  t in ["PARK", "E
-0000b330: 5543 454e 5452 4943 225d 3a0a 2020 2020  UCENTRIC"]:.    
-0000b340: 2020 2020 2020 2020 7261 6973 6520 5661          raise Va
-0000b350: 6c75 6545 7272 6f72 2866 2269 6e73 6572  lueError(f"inser
-0000b360: 7420 706f 7369 7469 6f6e 207b 6e61 6d65  t position {name
-0000b370: 7d20 6e6f 7420 7375 7070 6f72 7465 642e  } not supported.
-0000b380: 2229 0a20 2020 2020 2020 200a 2020 2020  ").        .    
-0000b390: 2020 2020 6e61 6d65 645f 706f 7369 7469      named_positi
-0000b3a0: 6f6e 203d 204d 616e 6970 756c 6174 6f72  on = Manipulator
-0000b3b0: 5361 7665 6450 6f73 6974 696f 6e2e 5041  SavedPosition.PA
-0000b3c0: 524b 2069 6620 6e61 6d65 203d 3d20 2250  RK if name == "P
-0000b3d0: 4152 4b22 2065 6c73 6520 4d61 6e69 7075  ARK" else Manipu
-0000b3e0: 6c61 746f 7253 6176 6564 506f 7369 7469  latorSavedPositi
-0000b3f0: 6f6e 2e45 5543 454e 5452 4943 0a20 2020  on.EUCENTRIC.   
-0000b400: 2020 2020 2070 6f73 6974 696f 6e20 3d20       position = 
-0000b410: 7365 6c66 2e63 6f6e 6e65 6374 696f 6e2e  self.connection.
-0000b420: 7370 6563 696d 656e 2e6d 616e 6970 756c  specimen.manipul
-0000b430: 6174 6f72 2e67 6574 5f73 6176 6564 5f70  ator.get_saved_p
-0000b440: 6f73 6974 696f 6e28 0a20 2020 2020 2020  osition(.       
-0000b450: 2020 2020 2020 2020 206e 616d 6564 5f70           named_p
-0000b460: 6f73 6974 696f 6e2c 204d 616e 6970 756c  osition, Manipul
-0000b470: 6174 6f72 436f 6f72 6469 6e61 7465 5379  atorCoordinateSy
-0000b480: 7374 656d 2e53 5441 4745 0a20 2020 2020  stem.STAGE.     
-0000b490: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-0000b4a0: 2020 2020 2020 2020 200a 2020 2020 2020           .      
-0000b4b0: 2020 7265 7475 726e 2046 6962 7365 6d4d    return FibsemM
-0000b4c0: 616e 6970 756c 6174 6f72 506f 7369 7469  anipulatorPositi
-0000b4d0: 6f6e 2e66 726f 6d5f 6175 746f 7363 7269  on.from_autoscri
-0000b4e0: 7074 5f70 6f73 6974 696f 6e28 706f 7369  pt_position(posi
-0000b4f0: 7469 6f6e 290a 0a20 2020 2064 6566 2073  tion)..    def s
-0000b500: 6574 7570 5f6d 696c 6c69 6e67 280a 2020  etup_milling(.  
-0000b510: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
-0000b520: 2020 2020 6d69 6c6c 5f73 6574 7469 6e67      mill_setting
-0000b530: 733a 2046 6962 7365 6d4d 696c 6c69 6e67  s: FibsemMilling
-0000b540: 5365 7474 696e 6773 2c0a 2020 2020 293a  Settings,.    ):
-0000b550: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-0000b560: 2020 2020 2043 6f6e 6669 6775 7265 2074       Configure t
-0000b570: 6865 206d 6963 726f 7363 6f70 6520 666f  he microscope fo
-0000b580: 7220 6d69 6c6c 696e 6720 7573 696e 6720  r milling using 
-0000b590: 7468 6520 696f 6e20 6265 616d 2e0a 0a20  the ion beam... 
-0000b5a0: 2020 2020 2020 2041 7267 733a 0a20 2020         Args:.   
-0000b5b0: 2020 2020 2020 2020 2061 7070 6c69 6361           applica
-0000b5c0: 7469 6f6e 5f66 696c 6520 2873 7472 293a  tion_file (str):
-0000b5d0: 2050 6174 6820 746f 2074 6865 206d 696c   Path to the mil
-0000b5e0: 6c69 6e67 2061 7070 6c69 6361 7469 6f6e  ling application
-0000b5f0: 2066 696c 652e 0a20 2020 2020 2020 2020   file..         
-0000b600: 2020 2070 6174 7465 726e 696e 675f 6d6f     patterning_mo
-0000b610: 6465 2028 7374 7229 3a20 5061 7474 6572  de (str): Patter
-0000b620: 6e69 6e67 206d 6f64 6520 746f 2075 7365  ning mode to use
-0000b630: 2e0a 2020 2020 2020 2020 2020 2020 6866  ..            hf
-0000b640: 7720 2866 6c6f 6174 293a 2044 6573 6972  w (float): Desir
-0000b650: 6564 2068 6f72 697a 6f6e 7461 6c20 6669  ed horizontal fi
-0000b660: 656c 6420 7769 6474 6820 696e 206d 6574  eld width in met
-0000b670: 6572 732e 0a20 2020 2020 2020 2020 2020  ers..           
-0000b680: 206d 696c 6c5f 7365 7474 696e 6773 2028   mill_settings (
-0000b690: 4669 6273 656d 4d69 6c6c 696e 6753 6574  FibsemMillingSet
-0000b6a0: 7469 6e67 7329 3a20 4d69 6c6c 696e 6720  tings): Milling 
-0000b6b0: 7365 7474 696e 6773 2e0a 0a20 2020 2020  settings...     
-0000b6c0: 2020 2052 6574 7572 6e73 3a0a 2020 2020     Returns:.    
-0000b6d0: 2020 2020 2020 2020 4e6f 6e65 2e0a 0a20          None... 
-0000b6e0: 2020 2020 2020 2052 6169 7365 733a 0a20         Raises:. 
-0000b6f0: 2020 2020 2020 2020 2020 204e 6f74 496d             NotIm
-0000b700: 706c 656d 656e 7465 6445 7272 6f72 3a20  plementedError: 
-0000b710: 4966 2074 6865 2073 7065 6369 6669 6564  If the specified
-0000b720: 2070 6174 7465 726e 696e 6720 6d6f 6465   patterning mode
-0000b730: 2069 7320 6e6f 7420 7375 7070 6f72 7465   is not supporte
-0000b740: 642e 0a0a 2020 2020 2020 2020 4e6f 7465  d...        Note
-0000b750: 3a0a 2020 2020 2020 2020 2020 2020 5468  :.            Th
-0000b760: 6973 206d 6574 686f 6420 7365 7473 2075  is method sets u
-0000b770: 7020 7468 6520 6d69 6372 6f73 636f 7065  p the microscope
-0000b780: 2069 6d61 6769 6e67 2061 6e64 2070 6174   imaging and pat
-0000b790: 7465 726e 696e 6720 666f 7220 6d69 6c6c  terning for mill
-0000b7a0: 696e 6720 7573 696e 6720 7468 6520 696f  ing using the io
-0000b7b0: 6e20 6265 616d 2e0a 2020 2020 2020 2020  n beam..        
-0000b7c0: 2020 2020 4974 2073 6574 7320 7468 6520      It sets the 
-0000b7d0: 6163 7469 7665 2076 6965 7720 616e 6420  active view and 
-0000b7e0: 6465 7669 6365 2074 6f20 7468 6520 696f  device to the io
-0000b7f0: 6e20 6265 616d 2c20 7468 6520 6465 6661  n beam, the defa
-0000b800: 756c 7420 6265 616d 2074 7970 6520 746f  ult beam type to
-0000b810: 2074 6865 2069 6f6e 2062 6561 6d2c 0a20   the ion beam,. 
-0000b820: 2020 2020 2020 2020 2020 2074 6865 2073             the s
-0000b830: 7065 6369 6669 6564 2061 7070 6c69 6361  pecified applica
-0000b840: 7469 6f6e 2066 696c 652c 2061 6e64 2074  tion file, and t
-0000b850: 6865 2073 7065 6369 6669 6564 2070 6174  he specified pat
-0000b860: 7465 726e 696e 6720 6d6f 6465 2e0a 2020  terning mode..  
-0000b870: 2020 2020 2020 2020 2020 4974 2061 6c73            It als
-0000b880: 6f20 636c 6561 7273 2061 6e79 2065 7869  o clears any exi
-0000b890: 7374 696e 6720 7061 7474 6572 6e73 2061  sting patterns a
-0000b8a0: 6e64 2073 6574 7320 7468 6520 686f 7269  nd sets the hori
-0000b8b0: 7a6f 6e74 616c 2066 6965 6c64 2077 6964  zontal field wid
-0000b8c0: 7468 2074 6f20 7468 6520 6465 7369 7265  th to the desire
-0000b8d0: 6420 7661 6c75 652e 0a20 2020 2020 2020  d value..       
-0000b8e0: 2020 2020 2054 6865 206d 6574 686f 6420       The method 
-0000b8f0: 646f 6573 206e 6f74 2073 7461 7274 2074  does not start t
-0000b900: 6865 206d 696c 6c69 6e67 2070 726f 6365  he milling proce
-0000b910: 7373 2e0a 2020 2020 2020 2020 2222 220a  ss..        """.
-0000b920: 2020 2020 2020 2020 5f63 6865 636b 5f62          _check_b
-0000b930: 6561 6d28 4265 616d 5479 7065 2e49 4f4e  eam(BeamType.ION
-0000b940: 2c20 7365 6c66 2e68 6172 6477 6172 655f  , self.hardware_
-0000b950: 7365 7474 696e 6773 290a 2020 2020 2020  settings).      
-0000b960: 2020 7365 6c66 2e63 6f6e 6e65 6374 696f    self.connectio
-0000b970: 6e2e 696d 6167 696e 672e 7365 745f 6163  n.imaging.set_ac
-0000b980: 7469 7665 5f76 6965 7728 4265 616d 5479  tive_view(BeamTy
-0000b990: 7065 2e49 4f4e 2e76 616c 7565 2920 2023  pe.ION.value)  #
-0000b9a0: 2074 6865 2069 6f6e 2062 6561 6d20 7669   the ion beam vi
-0000b9b0: 6577 0a20 2020 2020 2020 2073 656c 662e  ew.        self.
-0000b9c0: 636f 6e6e 6563 7469 6f6e 2e69 6d61 6769  connection.imagi
-0000b9d0: 6e67 2e73 6574 5f61 6374 6976 655f 6465  ng.set_active_de
-0000b9e0: 7669 6365 2842 6561 6d54 7970 652e 494f  vice(BeamType.IO
-0000b9f0: 4e2e 7661 6c75 6529 0a20 2020 2020 2020  N.value).       
-0000ba00: 2073 656c 662e 636f 6e6e 6563 7469 6f6e   self.connection
-0000ba10: 2e70 6174 7465 726e 696e 672e 7365 745f  .patterning.set_
-0000ba20: 6465 6661 756c 745f 6265 616d 5f74 7970  default_beam_typ
-0000ba30: 6528 0a20 2020 2020 2020 2020 2020 2042  e(.            B
-0000ba40: 6561 6d54 7970 652e 494f 4e2e 7661 6c75  eamType.ION.valu
-0000ba50: 650a 2020 2020 2020 2020 2920 2023 2069  e.        )  # i
-0000ba60: 6f6e 2062 6561 6d20 6465 6661 756c 740a  on beam default.
-0000ba70: 2020 2020 2020 2020 7365 6c66 2e63 6f6e          self.con
-0000ba80: 6e65 6374 696f 6e2e 7061 7474 6572 6e69  nection.patterni
-0000ba90: 6e67 2e73 6574 5f64 6566 6175 6c74 5f61  ng.set_default_a
-0000baa0: 7070 6c69 6361 7469 6f6e 5f66 696c 6528  pplication_file(
-0000bab0: 6d69 6c6c 5f73 6574 7469 6e67 732e 6170  mill_settings.ap
-0000bac0: 706c 6963 6174 696f 6e5f 6669 6c65 290a  plication_file).
-0000bad0: 2020 2020 2020 2020 7365 6c66 2e63 6f6e          self.con
-0000bae0: 6e65 6374 696f 6e2e 7061 7474 6572 6e69  nection.patterni
-0000baf0: 6e67 2e6d 6f64 6520 3d20 6d69 6c6c 5f73  ng.mode = mill_s
-0000bb00: 6574 7469 6e67 732e 7061 7474 6572 6e69  ettings.patterni
-0000bb10: 6e67 5f6d 6f64 650a 2020 2020 2020 2020  ng_mode.        
-0000bb20: 7365 6c66 2e63 6f6e 6e65 6374 696f 6e2e  self.connection.
-0000bb30: 7061 7474 6572 6e69 6e67 2e63 6c65 6172  patterning.clear
-0000bb40: 5f70 6174 7465 726e 7328 2920 2023 2063  _patterns()  # c
-0000bb50: 6c65 6172 2061 6e79 2065 7869 7374 696e  lear any existin
-0000bb60: 6720 7061 7474 6572 6e73 0a20 2020 2020  g patterns.     
-0000bb70: 2020 2073 656c 662e 636f 6e6e 6563 7469     self.connecti
-0000bb80: 6f6e 2e62 6561 6d73 2e69 6f6e 5f62 6561  on.beams.ion_bea
-0000bb90: 6d2e 686f 7269 7a6f 6e74 616c 5f66 6965  m.horizontal_fie
-0000bba0: 6c64 5f77 6964 7468 2e76 616c 7565 203d  ld_width.value =
-0000bbb0: 206d 696c 6c5f 7365 7474 696e 6773 2e68   mill_settings.h
-0000bbc0: 6677 0a0a 2020 2020 6465 6620 7275 6e5f  fw..    def run_
-0000bbd0: 6d69 6c6c 696e 6728 7365 6c66 2c20 6d69  milling(self, mi
-0000bbe0: 6c6c 696e 675f 6375 7272 656e 743a 2066  lling_current: f
-0000bbf0: 6c6f 6174 2c20 6173 796e 6368 3a20 626f  loat, asynch: bo
-0000bc00: 6f6c 203d 2046 616c 7365 293a 0a20 2020  ol = False):.   
-0000bc10: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-0000bc20: 2052 756e 2069 6f6e 2062 6561 6d20 6d69   Run ion beam mi
-0000bc30: 6c6c 696e 6720 7573 696e 6720 7468 6520  lling using the 
-0000bc40: 7370 6563 6966 6965 6420 6d69 6c6c 696e  specified millin
-0000bc50: 6720 6375 7272 656e 742e 0a0a 2020 2020  g current...    
-0000bc60: 2020 2020 4172 6773 3a0a 2020 2020 2020      Args:.      
-0000bc70: 2020 2020 2020 6d69 6c6c 696e 675f 6375        milling_cu
-0000bc80: 7272 656e 7420 2866 6c6f 6174 293a 2054  rrent (float): T
-0000bc90: 6865 2063 7572 7265 6e74 2074 6f20 7573  he current to us
-0000bca0: 6520 666f 7220 6d69 6c6c 696e 6720 696e  e for milling in
-0000bcb0: 2061 6d70 732e 0a20 2020 2020 2020 2020   amps..         
-0000bcc0: 2020 2061 7379 6e63 6820 2862 6f6f 6c2c     asynch (bool,
-0000bcd0: 206f 7074 696f 6e61 6c29 3a20 4966 2054   optional): If T
-0000bce0: 7275 652c 2074 6865 206d 696c 6c69 6e67  rue, the milling
-0000bcf0: 2077 696c 6c20 6265 2072 756e 2061 7379   will be run asy
-0000bd00: 6e63 6872 6f6e 6f75 736c 792e 200a 2020  nchronously. .  
-0000bd10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bd20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bd30: 2020 2044 6566 6175 6c74 7320 746f 2046     Defaults to F
-0000bd40: 616c 7365 2c20 696e 2077 6869 6368 2063  alse, in which c
-0000bd50: 6173 6520 6974 2077 696c 6c20 7275 6e20  ase it will run 
-0000bd60: 7379 6e63 6872 6f6e 6f75 736c 792e 0a0a  synchronously...
-0000bd70: 2020 2020 2020 2020 5265 7475 726e 733a          Returns:
-0000bd80: 0a20 2020 2020 2020 2020 2020 204e 6f6e  .            Non
-0000bd90: 650a 0a20 2020 2020 2020 2052 6169 7365  e..        Raise
-0000bda0: 733a 0a20 2020 2020 2020 2020 2020 204e  s:.            N
-0000bdb0: 6f6e 650a 2020 2020 2020 2020 2222 220a  one.        """.
-0000bdc0: 2020 2020 2020 2020 5f63 6865 636b 5f62          _check_b
-0000bdd0: 6561 6d28 4265 616d 5479 7065 2e49 4f4e  eam(BeamType.ION
-0000bde0: 2c20 7365 6c66 2e68 6172 6477 6172 655f  , self.hardware_
-0000bdf0: 7365 7474 696e 6773 290a 2020 2020 2020  settings).      
-0000be00: 2020 2320 6368 616e 6765 2074 6f20 6d69    # change to mi
-0000be10: 6c6c 696e 6720 6375 7272 656e 740a 2020  lling current.  
-0000be20: 2020 2020 2020 7365 6c66 2e63 6f6e 6e65        self.conne
-0000be30: 6374 696f 6e2e 696d 6167 696e 672e 7365  ction.imaging.se
-0000be40: 745f 6163 7469 7665 5f76 6965 7728 4265  t_active_view(Be
-0000be50: 616d 5479 7065 2e49 4f4e 2e76 616c 7565  amType.ION.value
-0000be60: 2920 2023 2074 6865 2069 6f6e 2062 6561  )  # the ion bea
-0000be70: 6d20 7669 6577 0a20 2020 2020 2020 2069  m view.        i
-0000be80: 6620 7365 6c66 2e63 6f6e 6e65 6374 696f  f self.connectio
-0000be90: 6e2e 6265 616d 732e 696f 6e5f 6265 616d  n.beams.ion_beam
-0000bea0: 2e62 6561 6d5f 6375 7272 656e 742e 7661  .beam_current.va
-0000beb0: 6c75 6520 213d 206d 696c 6c69 6e67 5f63  lue != milling_c
-0000bec0: 7572 7265 6e74 3a0a 2020 2020 2020 2020  urrent:.        
-0000bed0: 2020 2020 6c6f 6767 696e 672e 696e 666f      logging.info
-0000bee0: 2866 2263 6861 6e67 696e 6720 746f 206d  (f"changing to m
-0000bef0: 696c 6c69 6e67 2063 7572 7265 6e74 3a20  illing current: 
-0000bf00: 7b6d 696c 6c69 6e67 5f63 7572 7265 6e74  {milling_current
-0000bf10: 3a2e 3265 7d22 290a 2020 2020 2020 2020  :.2e}").        
-0000bf20: 2020 2020 7365 6c66 2e63 6f6e 6e65 6374      self.connect
-0000bf30: 696f 6e2e 6265 616d 732e 696f 6e5f 6265  ion.beams.ion_be
-0000bf40: 616d 2e62 6561 6d5f 6375 7272 656e 742e  am.beam_current.
-0000bf50: 7661 6c75 6520 3d20 6d69 6c6c 696e 675f  value = milling_
-0000bf60: 6375 7272 656e 740a 0a20 2020 2020 2020  current..       
-0000bf70: 2023 2072 756e 206d 696c 6c69 6e67 2028   # run milling (
-0000bf80: 6173 796e 6368 726f 6e6f 7573 6c79 290a  asynchronously).
-0000bf90: 2020 2020 2020 2020 6c6f 6767 696e 672e          logging.
-0000bfa0: 696e 666f 2866 2272 756e 6e69 6e67 2069  info(f"running i
-0000bfb0: 6f6e 2062 6561 6d20 6d69 6c6c 696e 6720  on beam milling 
-0000bfc0: 6e6f 772e 2e2e 2061 7379 6e63 6872 6f6e  now... asynchron
-0000bfd0: 6f75 733d 7b61 7379 6e63 687d 2229 0a20  ous={asynch}"). 
-0000bfe0: 2020 2020 2020 2069 6620 6173 796e 6368         if asynch
-0000bff0: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-0000c000: 6c66 2e63 6f6e 6e65 6374 696f 6e2e 7061  lf.connection.pa
-0000c010: 7474 6572 6e69 6e67 2e73 7461 7274 2829  tterning.start()
-0000c020: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
-0000c030: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-0000c040: 636f 6e6e 6563 7469 6f6e 2e70 6174 7465  connection.patte
-0000c050: 726e 696e 672e 7275 6e28 290a 2020 2020  rning.run().    
-0000c060: 2020 2020 2020 2020 7365 6c66 2e63 6f6e          self.con
-0000c070: 6e65 6374 696f 6e2e 7061 7474 6572 6e69  nection.patterni
-0000c080: 6e67 2e63 6c65 6172 5f70 6174 7465 726e  ng.clear_pattern
-0000c090: 7328 290a 2020 2020 2020 2020 2320 4e4f  s().        # NO
-0000c0a0: 5445 3a20 4d61 6b65 2074 6573 6361 6e20  TE: Make tescan 
-0000c0b0: 6c6f 6773 2074 6865 2073 616d 653f 3f0a  logs the same??.
-0000c0c0: 0a20 2020 2064 6566 2072 756e 5f6d 696c  .    def run_mil
-0000c0d0: 6c69 6e67 5f64 7269 6674 5f63 6f72 7265  ling_drift_corre
-0000c0e0: 6374 6564 2873 656c 662c 206d 696c 6c69  cted(self, milli
-0000c0f0: 6e67 5f63 7572 7265 6e74 3a20 666c 6f61  ng_current: floa
-0000c100: 742c 2020 0a20 2020 2020 2020 2069 6d61  t,  .        ima
-0000c110: 6765 5f73 6574 7469 6e67 733a 2049 6d61  ge_settings: Ima
-0000c120: 6765 5365 7474 696e 6773 2c20 0a20 2020  geSettings, .   
-0000c130: 2020 2020 2072 6566 5f69 6d61 6765 3a20       ref_image: 
-0000c140: 4669 6273 656d 496d 6167 652c 200a 2020  FibsemImage, .  
-0000c150: 2020 2020 2020 7265 6475 6365 645f 6172        reduced_ar
-0000c160: 6561 3a20 4669 6273 656d 5265 6374 616e  ea: FibsemRectan
-0000c170: 676c 6520 3d20 4e6f 6e65 2c0a 2020 2020  gle = None,.    
-0000c180: 2020 2020 293a 0a20 2020 2020 2020 2022      ):.        "
-0000c190: 2222 0a20 2020 2020 2020 2052 756e 2069  "".        Run i
-0000c1a0: 6f6e 2062 6561 6d20 6d69 6c6c 696e 6720  on beam milling 
-0000c1b0: 7573 696e 6720 7468 6520 7370 6563 6966  using the specif
-0000c1c0: 6965 6420 6d69 6c6c 696e 6720 6375 7272  ied milling curr
-0000c1d0: 656e 742e 0a0a 2020 2020 2020 2020 4172  ent...        Ar
-0000c1e0: 6773 3a0a 2020 2020 2020 2020 2020 2020  gs:.            
-0000c1f0: 6d69 6c6c 696e 675f 6375 7272 656e 7420  milling_current 
-0000c200: 2866 6c6f 6174 293a 2054 6865 2063 7572  (float): The cur
-0000c210: 7265 6e74 2074 6f20 7573 6520 666f 7220  rent to use for 
-0000c220: 6d69 6c6c 696e 6720 696e 2061 6d70 732e  milling in amps.
-0000c230: 0a20 2020 2020 2020 2020 2020 2061 7379  .            asy
-0000c240: 6e63 6820 2862 6f6f 6c2c 206f 7074 696f  nch (bool, optio
-0000c250: 6e61 6c29 3a20 4966 2054 7275 652c 2074  nal): If True, t
-0000c260: 6865 206d 696c 6c69 6e67 2077 696c 6c20  he milling will 
-0000c270: 6265 2072 756e 2061 7379 6e63 6872 6f6e  be run asynchron
-0000c280: 6f75 736c 792e 200a 2020 2020 2020 2020  ously. .        
-0000c290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c2a0: 2020 2020 2020 2020 2020 2020 2044 6566               Def
-0000c2b0: 6175 6c74 7320 746f 2046 616c 7365 2c20  aults to False, 
-0000c2c0: 696e 2077 6869 6368 2063 6173 6520 6974  in which case it
-0000c2d0: 2077 696c 6c20 7275 6e20 7379 6e63 6872   will run synchr
-0000c2e0: 6f6e 6f75 736c 792e 0a0a 2020 2020 2020  onously...      
-0000c2f0: 2020 5265 7475 726e 733a 0a20 2020 2020    Returns:.     
-0000c300: 2020 2020 2020 204e 6f6e 650a 0a20 2020         None..   
-0000c310: 2020 2020 2052 6169 7365 733a 0a20 2020       Raises:.   
-0000c320: 2020 2020 2020 2020 204e 6f6e 650a 2020           None.  
-0000c330: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-0000c340: 2020 5f63 6865 636b 5f62 6561 6d28 4265    _check_beam(Be
-0000c350: 616d 5479 7065 2e49 4f4e 2c20 7365 6c66  amType.ION, self
-0000c360: 2e68 6172 6477 6172 655f 7365 7474 696e  .hardware_settin
-0000c370: 6773 290a 2020 2020 2020 2020 2320 6368  gs).        # ch
-0000c380: 616e 6765 2074 6f20 6d69 6c6c 696e 6720  ange to milling 
-0000c390: 6375 7272 656e 740a 2020 2020 2020 2020  current.        
-0000c3a0: 7365 6c66 2e63 6f6e 6e65 6374 696f 6e2e  self.connection.
-0000c3b0: 696d 6167 696e 672e 7365 745f 6163 7469  imaging.set_acti
-0000c3c0: 7665 5f76 6965 7728 4265 616d 5479 7065  ve_view(BeamType
-0000c3d0: 2e49 4f4e 2e76 616c 7565 2920 2023 2074  .ION.value)  # t
-0000c3e0: 6865 2069 6f6e 2062 6561 6d20 7669 6577  he ion beam view
-0000c3f0: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
-0000c400: 2e63 6f6e 6e65 6374 696f 6e2e 6265 616d  .connection.beam
-0000c410: 732e 696f 6e5f 6265 616d 2e62 6561 6d5f  s.ion_beam.beam_
-0000c420: 6375 7272 656e 742e 7661 6c75 6520 213d  current.value !=
-0000c430: 206d 696c 6c69 6e67 5f63 7572 7265 6e74   milling_current
-0000c440: 3a0a 2020 2020 2020 2020 2020 2020 6c6f  :.            lo
-0000c450: 6767 696e 672e 696e 666f 2866 2263 6861  gging.info(f"cha
-0000c460: 6e67 696e 6720 746f 206d 696c 6c69 6e67  nging to milling
-0000c470: 2063 7572 7265 6e74 3a20 7b6d 696c 6c69   current: {milli
-0000c480: 6e67 5f63 7572 7265 6e74 3a2e 3265 7d22  ng_current:.2e}"
-0000c490: 290a 2020 2020 2020 2020 2020 2020 7365  ).            se
-0000c4a0: 6c66 2e63 6f6e 6e65 6374 696f 6e2e 6265  lf.connection.be
-0000c4b0: 616d 732e 696f 6e5f 6265 616d 2e62 6561  ams.ion_beam.bea
-0000c4c0: 6d5f 6375 7272 656e 742e 7661 6c75 6520  m_current.value 
-0000c4d0: 3d20 6d69 6c6c 696e 675f 6375 7272 656e  = milling_curren
-0000c4e0: 740a 0a20 2020 2020 2020 2023 2072 756e  t..        # run
-0000c4f0: 206d 696c 6c69 6e67 2028 6173 796e 6368   milling (asynch
-0000c500: 726f 6e6f 7573 6c79 290a 2020 2020 2020  ronously).      
-0000c510: 2020 6c6f 6767 696e 672e 696e 666f 2866    logging.info(f
-0000c520: 2272 756e 6e69 6e67 2069 6f6e 2062 6561  "running ion bea
-0000c530: 6d20 6d69 6c6c 696e 6720 6e6f 772e 2229  m milling now.")
-0000c540: 0a0a 2020 2020 2020 2020 7365 6c66 2e63  ..        self.c
-0000c550: 6f6e 6e65 6374 696f 6e2e 7061 7474 6572  onnection.patter
-0000c560: 6e69 6e67 2e73 7461 7274 2829 0a20 2020  ning.start().   
-0000c570: 2020 2020 2023 204e 4f54 453a 204d 616b       # NOTE: Mak
-0000c580: 6520 7465 7363 616e 206c 6f67 7320 7468  e tescan logs th
-0000c590: 6520 7361 6d65 3f3f 0a20 2020 2020 2020  e same??.       
-0000c5a0: 2066 726f 6d20 6669 6273 656d 2069 6d70   from fibsem imp
-0000c5b0: 6f72 7420 616c 6967 6e6d 656e 740a 2020  ort alignment.  
-0000c5c0: 2020 2020 2020 7768 696c 6520 7365 6c66        while self
-0000c5d0: 2e63 6f6e 6e65 6374 696f 6e2e 7061 7474  .connection.patt
-0000c5e0: 6572 6e69 6e67 2e73 7461 7465 203d 3d20  erning.state == 
-0000c5f0: 5061 7474 6572 6e69 6e67 5374 6174 652e  PatterningState.
-0000c600: 4944 4c45 3a20 2320 6769 7669 6e67 2074  IDLE: # giving t
-0000c610: 696d 6520 746f 2073 7461 7274 200a 2020  ime to start .  
-0000c620: 2020 2020 2020 2020 2020 7469 6d65 2e73            time.s
-0000c630: 6c65 6570 2830 2e35 290a 2020 2020 2020  leep(0.5).      
-0000c640: 2020 7768 696c 6520 7365 6c66 2e63 6f6e    while self.con
-0000c650: 6e65 6374 696f 6e2e 7061 7474 6572 6e69  nection.patterni
-0000c660: 6e67 2e73 7461 7465 203d 3d20 5061 7474  ng.state == Patt
-0000c670: 6572 6e69 6e67 5374 6174 652e 5255 4e4e  erningState.RUNN
-0000c680: 494e 473a 0a0a 2020 2020 2020 2020 2020  ING:..          
-0000c690: 2020 7365 6c66 2e63 6f6e 6e65 6374 696f    self.connectio
-0000c6a0: 6e2e 7061 7474 6572 6e69 6e67 2e70 6175  n.patterning.pau
-0000c6b0: 7365 2829 0a20 2020 2020 2020 2020 2020  se().           
-0000c6c0: 206c 6f67 6769 6e67 2e69 6e66 6f28 2244   logging.info("D
-0000c6d0: 7269 6674 2063 6f72 7265 6374 696f 6e22  rift correction"
-0000c6e0: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
-0000c6f0: 2072 6564 7563 6564 5f61 7265 6120 6973   reduced_area is
-0000c700: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
-0000c710: 2020 2020 2020 2020 2020 2072 6564 7563             reduc
-0000c720: 6564 5f61 7265 6120 3d20 7265 6475 6365  ed_area = reduce
-0000c730: 645f 6172 6561 2e5f 5f74 6f5f 4645 495f  d_area.__to_FEI_
-0000c740: 5f28 290a 2020 2020 2020 2020 2020 2020  _().            
-0000c750: 696d 6167 655f 7365 7474 696e 6773 2e62  image_settings.b
-0000c760: 6561 6d5f 7479 7065 203d 2042 6561 6d54  eam_type = BeamT
-0000c770: 7970 652e 494f 4e0a 2020 2020 2020 2020  ype.ION.        
-0000c780: 2020 2020 616c 6967 6e6d 656e 742e 6265      alignment.be
-0000c790: 616d 5f73 6869 6674 5f61 6c69 676e 6d65  am_shift_alignme
-0000c7a0: 6e74 286d 6963 726f 7363 6f70 6520 3d20  nt(microscope = 
-0000c7b0: 7365 6c66 2c20 696d 6167 655f 7365 7474  self, image_sett
-0000c7c0: 696e 6773 3d20 696d 6167 655f 7365 7474  ings= image_sett
-0000c7d0: 696e 6773 2c20 7265 665f 696d 6167 653d  ings, ref_image=
-0000c7e0: 7265 665f 696d 6167 652c 2072 6564 7563  ref_image, reduc
-0000c7f0: 6564 5f61 7265 613d 7265 6475 6365 645f  ed_area=reduced_
-0000c800: 6172 6561 290a 2020 2020 2020 2020 2020  area).          
-0000c810: 2020 7469 6d65 2e73 6c65 6570 2831 2920    time.sleep(1) 
-0000c820: 2320 6e65 6564 2064 656c 6179 2074 6f20  # need delay to 
-0000c830: 7377 6974 6368 2062 6163 6b20 746f 2070  switch back to p
-0000c840: 6174 7465 726e 696e 6720 6d6f 6465 200a  atterning mode .
-0000c850: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-0000c860: 2e63 6f6e 6e65 6374 696f 6e2e 696d 6167  .connection.imag
-0000c870: 696e 672e 7365 745f 6163 7469 7665 5f76  ing.set_active_v
-0000c880: 6965 7728 4265 616d 5479 7065 2e49 4f4e  iew(BeamType.ION
-0000c890: 2e76 616c 7565 290a 2020 2020 2020 2020  .value).        
-0000c8a0: 2020 2020 6966 2073 656c 662e 636f 6e6e      if self.conn
-0000c8b0: 6563 7469 6f6e 2e70 6174 7465 726e 696e  ection.patternin
-0000c8c0: 672e 7374 6174 6520 3d3d 2050 6174 7465  g.state == Patte
-0000c8d0: 726e 696e 6753 7461 7465 2e50 4155 5345  rningState.PAUSE
-0000c8e0: 443a 2023 2063 6865 636b 2069 6620 6669  D: # check if fi
-0000c8f0: 6e69 7368 6564 200a 2020 2020 2020 2020  nished .        
-0000c900: 2020 2020 2020 2020 7365 6c66 2e63 6f6e          self.con
-0000c910: 6e65 6374 696f 6e2e 7061 7474 6572 6e69  nection.patterni
-0000c920: 6e67 2e72 6573 756d 6528 290a 2020 2020  ng.resume().    
-0000c930: 2020 2020 2020 2020 2020 2020 7469 6d65              time
-0000c940: 2e73 6c65 6570 2835 290a 2020 2020 2020  .sleep(5).      
-0000c950: 2020 2020 2020 7072 696e 7428 7365 6c66        print(self
-0000c960: 2e63 6f6e 6e65 6374 696f 6e2e 7061 7474  .connection.patt
-0000c970: 6572 6e69 6e67 2e73 7461 7465 290a 0a0a  erning.state)...
-0000c980: 2020 2020 6465 6620 6669 6e69 7368 5f6d      def finish_m
-0000c990: 696c 6c69 6e67 2873 656c 662c 2069 6d61  illing(self, ima
-0000c9a0: 6769 6e67 5f63 7572 7265 6e74 3a20 666c  ging_current: fl
-0000c9b0: 6f61 7429 3a0a 2020 2020 2020 2020 2222  oat):.        ""
-0000c9c0: 220a 2020 2020 2020 2020 4669 6e61 6c69  ".        Finali
-0000c9d0: 7365 7320 7468 6520 6d69 6c6c 696e 6720  ses the milling 
-0000c9e0: 7072 6f63 6573 7320 6279 2063 6c65 6172  process by clear
-0000c9f0: 696e 6720 7468 6520 6d69 6372 6f73 636f  ing the microsco
-0000ca00: 7065 206f 6620 616e 7920 7061 7474 6572  pe of any patter
-0000ca10: 6e73 2061 6e64 2072 6574 7572 6e69 6e67  ns and returning
-0000ca20: 2074 6865 2063 7572 7265 6e74 2074 6f20   the current to 
-0000ca30: 7468 6520 696d 6167 696e 6720 6375 7272  the imaging curr
-0000ca40: 656e 742e 0a0a 2020 2020 2020 2020 4172  ent...        Ar
-0000ca50: 6773 3a0a 2020 2020 2020 2020 2020 2020  gs:.            
-0000ca60: 696d 6167 696e 675f 6375 7272 656e 7420  imaging_current 
-0000ca70: 2866 6c6f 6174 293a 2054 6865 2063 7572  (float): The cur
-0000ca80: 7265 6e74 2074 6f20 7573 6520 666f 7220  rent to use for 
-0000ca90: 696d 6167 696e 6720 696e 2061 6d70 732e  imaging in amps.
-0000caa0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-0000cab0: 2020 2020 205f 6368 6563 6b5f 6265 616d       _check_beam
-0000cac0: 2842 6561 6d54 7970 652e 494f 4e2c 2073  (BeamType.ION, s
-0000cad0: 656c 662e 6861 7264 7761 7265 5f73 6574  elf.hardware_set
-0000cae0: 7469 6e67 7329 0a20 2020 2020 2020 2073  tings).        s
-0000caf0: 656c 662e 636f 6e6e 6563 7469 6f6e 2e70  elf.connection.p
-0000cb00: 6174 7465 726e 696e 672e 636c 6561 725f  atterning.clear_
-0000cb10: 7061 7474 6572 6e73 2829 0a20 2020 2020  patterns().     
-0000cb20: 2020 2073 656c 662e 636f 6e6e 6563 7469     self.connecti
-0000cb30: 6f6e 2e62 6561 6d73 2e69 6f6e 5f62 6561  on.beams.ion_bea
-0000cb40: 6d2e 6265 616d 5f63 7572 7265 6e74 2e76  m.beam_current.v
-0000cb50: 616c 7565 203d 2069 6d61 6769 6e67 5f63  alue = imaging_c
-0000cb60: 7572 7265 6e74 0a20 2020 2020 2020 2073  urrent.        s
-0000cb70: 656c 662e 636f 6e6e 6563 7469 6f6e 2e70  elf.connection.p
-0000cb80: 6174 7465 726e 696e 672e 6d6f 6465 203d  atterning.mode =
-0000cb90: 2022 5365 7269 616c 220a 0a20 2020 2064   "Serial"..    d
-0000cba0: 6566 2064 7261 775f 7265 6374 616e 676c  ef draw_rectangl
-0000cbb0: 6528 0a20 2020 2020 2020 2073 656c 662c  e(.        self,
-0000cbc0: 0a20 2020 2020 2020 2070 6174 7465 726e  .        pattern
-0000cbd0: 5f73 6574 7469 6e67 733a 2046 6962 7365  _settings: Fibse
-0000cbe0: 6d50 6174 7465 726e 5365 7474 696e 6773  mPatternSettings
-0000cbf0: 2c0a 2020 2020 293a 0a20 2020 2020 2020  ,.    ):.       
-0000cc00: 2022 2222 0a20 2020 2020 2020 2044 7261   """.        Dra
-0000cc10: 7773 2061 2072 6563 7461 6e67 6c65 2070  ws a rectangle p
-0000cc20: 6174 7465 726e 2075 7369 6e67 2074 6865  attern using the
-0000cc30: 2063 7572 7265 6e74 2069 6f6e 2062 6561   current ion bea
-0000cc40: 6d2e 0a0a 2020 2020 2020 2020 4172 6773  m...        Args
-0000cc50: 3a0a 2020 2020 2020 2020 2020 2020 7061  :.            pa
-0000cc60: 7474 6572 6e5f 7365 7474 696e 6773 2028  ttern_settings (
-0000cc70: 4669 6273 656d 5061 7474 6572 6e53 6574  FibsemPatternSet
-0000cc80: 7469 6e67 7329 3a20 7468 6520 7365 7474  tings): the sett
-0000cc90: 696e 6773 2066 6f72 2074 6865 2070 6174  ings for the pat
-0000cca0: 7465 726e 2074 6f20 6472 6177 2e0a 0a20  tern to draw... 
-0000ccb0: 2020 2020 2020 2052 6574 7572 6e73 3a0a         Returns:.
-0000ccc0: 2020 2020 2020 2020 2020 2020 5061 7474              Patt
-0000ccd0: 6572 6e3a 2074 6865 2063 7265 6174 6564  ern: the created
-0000cce0: 2070 6174 7465 726e 2e0a 0a20 2020 2020   pattern...     
-0000ccf0: 2020 2052 6169 7365 733a 0a20 2020 2020     Raises:.     
-0000cd00: 2020 2020 2020 2041 7574 6f73 6372 6970         Autoscrip
-0000cd10: 7445 7272 6f72 3a20 6966 2061 6e20 6572  tError: if an er
-0000cd20: 726f 7220 6f63 6375 7273 2077 6869 6c65  ror occurs while
-0000cd30: 2063 7265 6174 696e 6720 7468 6520 7061   creating the pa
-0000cd40: 7474 6572 6e2e 0a0a 2020 2020 2020 2020  ttern...        
-0000cd50: 4e6f 7465 733a 0a20 2020 2020 2020 2020  Notes:.         
-0000cd60: 2020 2054 6865 2072 6563 7461 6e67 6c65     The rectangle
-0000cd70: 2070 6174 7465 726e 2077 696c 6c20 6265   pattern will be
-0000cd80: 2063 656e 7465 7265 6420 6174 2074 6865   centered at the
-0000cd90: 2073 7065 6369 6669 6564 2063 6f6f 7264   specified coord
-0000cda0: 696e 6174 6573 2028 6365 6e74 7265 5f78  inates (centre_x
-0000cdb0: 2c20 6365 6e74 7265 5f79 2920 7769 7468  , centre_y) with
-0000cdc0: 2074 6865 2073 7065 6369 6669 6564 0a20   the specified. 
-0000cdd0: 2020 2020 2020 2020 2020 2077 6964 7468             width
-0000cde0: 2c20 6865 6967 6874 2061 6e64 2064 6570  , height and dep
-0000cdf0: 7468 2028 696e 206e 6d29 2e20 4966 2074  th (in nm). If t
-0000ce00: 6865 2063 6c65 616e 696e 675f 6372 6f73  he cleaning_cros
-0000ce10: 735f 7365 6374 696f 6e20 6174 7472 6962  s_section attrib
-0000ce20: 7574 6520 6f66 2070 6174 7465 726e 5f73  ute of pattern_s
-0000ce30: 6574 7469 6e67 7320 6973 2054 7275 652c  ettings is True,
-0000ce40: 2061 0a20 2020 2020 2020 2020 2020 2063   a.            c
-0000ce50: 6c65 616e 696e 6720 6372 6f73 7320 7365  leaning cross se
-0000ce60: 6374 696f 6e20 7061 7474 6572 6e20 7769  ction pattern wi
-0000ce70: 6c6c 2062 6520 6372 6561 7465 6420 696e  ll be created in
-0000ce80: 7374 6561 6420 6f66 2061 2072 6563 7461  stead of a recta
-0000ce90: 6e67 6c65 2070 6174 7465 726e 2e0a 0a20  ngle pattern... 
-0000cea0: 2020 2020 2020 2020 2020 2054 6865 2070             The p
-0000ceb0: 6174 7465 726e 2077 696c 6c20 6265 2072  attern will be r
-0000cec0: 6f74 6174 6564 2062 7920 7468 6520 616e  otated by the an
-0000ced0: 676c 6520 7370 6563 6966 6965 6420 696e  gle specified in
-0000cee0: 2074 6865 2072 6f74 6174 696f 6e20 6174   the rotation at
-0000cef0: 7472 6962 7574 6520 6f66 2070 6174 7465  tribute of patte
-0000cf00: 726e 5f73 6574 7469 6e67 7320 2869 6e20  rn_settings (in 
-0000cf10: 6465 6772 6565 7329 0a20 2020 2020 2020  degrees).       
-0000cf20: 2020 2020 2061 6e64 2073 6361 6e6e 6564       and scanned
-0000cf30: 2069 6e20 7468 6520 6469 7265 6374 696f   in the directio
-0000cf40: 6e20 7370 6563 6966 6965 6420 696e 2074  n specified in t
-0000cf50: 6865 2073 6361 6e5f 6469 7265 6374 696f  he scan_directio
-0000cf60: 6e20 6174 7472 6962 7574 6520 6f66 2070  n attribute of p
-0000cf70: 6174 7465 726e 5f73 6574 7469 6e67 7320  attern_settings 
-0000cf80: 2827 686f 7269 7a6f 6e74 616c 2720 6f72  ('horizontal' or
-0000cf90: 0a20 2020 2020 2020 2020 2020 2027 7665  .            've
-0000cfa0: 7274 6963 616c 2729 2e0a 0a20 2020 2020  rtical')...     
-0000cfb0: 2020 2020 2020 2054 6865 2063 7265 6174         The creat
-0000cfc0: 6564 2070 6174 7465 726e 2063 616e 2062  ed pattern can b
-0000cfd0: 6520 6164 6465 6420 746f 2074 6865 2070  e added to the p
-0000cfe0: 6174 7465 726e 696e 6720 7175 6575 6520  atterning queue 
-0000cff0: 616e 6420 6578 6563 7574 6564 2075 7369  and executed usi
-0000d000: 6e67 2074 6865 206d 6574 686f 6473 2069  ng the methods i
-0000d010: 6e20 7468 6520 5061 7474 6572 6e69 6e67  n the Patterning
-0000d020: 5175 6575 650a 2020 2020 2020 2020 2020  Queue.          
-0000d030: 2020 636c 6173 7320 6f66 2074 6865 2061    class of the a
-0000d040: 7574 6f73 6372 6970 745f 7364 625f 6d69  utoscript_sdb_mi
-0000d050: 6372 6f73 636f 7065 5f63 6c69 656e 7420  croscope_client 
-0000d060: 7061 636b 6167 652e 0a20 2020 2020 2020  package..       
-0000d070: 2022 2222 0a20 2020 2020 2020 2069 6620   """.        if 
-0000d080: 7061 7474 6572 6e5f 7365 7474 696e 6773  pattern_settings
-0000d090: 2e63 6c65 616e 696e 675f 6372 6f73 735f  .cleaning_cross_
-0000d0a0: 7365 6374 696f 6e3a 0a20 2020 2020 2020  section:.       
-0000d0b0: 2020 2020 2070 6174 7465 726e 203d 2073       pattern = s
-0000d0c0: 656c 662e 636f 6e6e 6563 7469 6f6e 2e70  elf.connection.p
-0000d0d0: 6174 7465 726e 696e 672e 6372 6561 7465  atterning.create
-0000d0e0: 5f63 6c65 616e 696e 675f 6372 6f73 735f  _cleaning_cross_
-0000d0f0: 7365 6374 696f 6e28 0a20 2020 2020 2020  section(.       
-0000d100: 2020 2020 2020 2020 2063 656e 7465 725f           center_
-0000d110: 783d 7061 7474 6572 6e5f 7365 7474 696e  x=pattern_settin
-0000d120: 6773 2e63 656e 7472 655f 782c 0a20 2020  gs.centre_x,.   
-0000d130: 2020 2020 2020 2020 2020 2020 2063 656e               cen
-0000d140: 7465 725f 793d 7061 7474 6572 6e5f 7365  ter_y=pattern_se
-0000d150: 7474 696e 6773 2e63 656e 7472 655f 792c  ttings.centre_y,
-0000d160: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000d170: 2077 6964 7468 3d70 6174 7465 726e 5f73   width=pattern_s
-0000d180: 6574 7469 6e67 732e 7769 6474 682c 0a20  ettings.width,. 
-0000d190: 2020 2020 2020 2020 2020 2020 2020 2068                 h
-0000d1a0: 6569 6768 743d 7061 7474 6572 6e5f 7365  eight=pattern_se
-0000d1b0: 7474 696e 6773 2e68 6569 6768 742c 0a20  ttings.height,. 
-0000d1c0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-0000d1d0: 6570 7468 3d70 6174 7465 726e 5f73 6574  epth=pattern_set
-0000d1e0: 7469 6e67 732e 6465 7074 682c 0a20 2020  tings.depth,.   
-0000d1f0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-0000d200: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0000d210: 2020 2020 2070 6174 7465 726e 203d 2073       pattern = s
-0000d220: 656c 662e 636f 6e6e 6563 7469 6f6e 2e70  elf.connection.p
-0000d230: 6174 7465 726e 696e 672e 6372 6561 7465  atterning.create
-0000d240: 5f72 6563 7461 6e67 6c65 280a 2020 2020  _rectangle(.    
-0000d250: 2020 2020 2020 2020 2020 2020 6365 6e74              cent
-0000d260: 6572 5f78 3d70 6174 7465 726e 5f73 6574  er_x=pattern_set
-0000d270: 7469 6e67 732e 6365 6e74 7265 5f78 2c0a  tings.centre_x,.
-0000d280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d290: 6365 6e74 6572 5f79 3d70 6174 7465 726e  center_y=pattern
-0000d2a0: 5f73 6574 7469 6e67 732e 6365 6e74 7265  _settings.centre
-0000d2b0: 5f79 2c0a 2020 2020 2020 2020 2020 2020  _y,.            
-0000d2c0: 2020 2020 7769 6474 683d 7061 7474 6572      width=patter
-0000d2d0: 6e5f 7365 7474 696e 6773 2e77 6964 7468  n_settings.width
-0000d2e0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000d2f0: 2020 6865 6967 6874 3d70 6174 7465 726e    height=pattern
-0000d300: 5f73 6574 7469 6e67 732e 6865 6967 6874  _settings.height
-0000d310: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000d320: 2020 6465 7074 683d 7061 7474 6572 6e5f    depth=pattern_
-0000d330: 7365 7474 696e 6773 2e64 6570 7468 2c0a  settings.depth,.
-0000d340: 2020 2020 2020 2020 2020 2020 290a 0a20              ).. 
-0000d350: 2020 2020 2020 2070 6174 7465 726e 2e72         pattern.r
-0000d360: 6f74 6174 696f 6e20 3d20 7061 7474 6572  otation = patter
-0000d370: 6e5f 7365 7474 696e 6773 2e72 6f74 6174  n_settings.rotat
-0000d380: 696f 6e0a 2020 2020 2020 2020 7061 7468  ion.        path
-0000d390: 7320 3d20 7365 6c66 2e67 6574 5f73 6361  s = self.get_sca
-0000d3a0: 6e5f 6469 7265 6374 696f 6e73 2829 0a20  n_directions(). 
-0000d3b0: 2020 2020 2020 2069 6620 7061 7474 6572         if patter
-0000d3c0: 6e5f 7365 7474 696e 6773 2e73 6361 6e5f  n_settings.scan_
-0000d3d0: 6469 7265 6374 696f 6e20 696e 2070 6174  direction in pat
-0000d3e0: 6873 3a0a 2020 2020 2020 2020 2020 2020  hs:.            
-0000d3f0: 7061 7474 6572 6e2e 7363 616e 5f64 6972  pattern.scan_dir
-0000d400: 6563 7469 6f6e 203d 2070 6174 7465 726e  ection = pattern
-0000d410: 5f73 6574 7469 6e67 732e 7363 616e 5f64  _settings.scan_d
-0000d420: 6972 6563 7469 6f6e 0a20 2020 2020 2020  irection.       
-0000d430: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-0000d440: 2020 2070 6174 7465 726e 2e73 6361 6e5f     pattern.scan_
-0000d450: 6469 7265 6374 696f 6e20 3d20 2254 6f70  direction = "Top
-0000d460: 546f 426f 7474 6f6d 220a 2020 2020 2020  ToBottom".      
-0000d470: 2020 2020 2020 6c6f 6767 696e 672e 696e        logging.in
-0000d480: 666f 2866 2253 6361 6e20 6469 7265 6374  fo(f"Scan direct
-0000d490: 696f 6e20 7b70 6174 7465 726e 5f73 6574  ion {pattern_set
-0000d4a0: 7469 6e67 732e 7363 616e 5f64 6972 6563  tings.scan_direc
-0000d4b0: 7469 6f6e 7d20 6e6f 7420 7375 7070 6f72  tion} not suppor
-0000d4c0: 7465 642e 2055 7369 6e67 2054 6f70 546f  ted. Using TopTo
-0000d4d0: 426f 7474 6f6d 2069 6e73 7465 6164 2e22  Bottom instead."
-0000d4e0: 290a 2020 2020 2020 2020 2020 2020 6c6f  ).            lo
-0000d4f0: 6767 696e 672e 696e 666f 2866 2253 7570  gging.info(f"Sup
-0000d500: 706f 7274 6564 2073 6361 6e20 6469 7265  ported scan dire
-0000d510: 6374 696f 6e73 2061 7265 3a20 426f 7474  ctions are: Bott
-0000d520: 6f6d 546f 546f 702c 2044 796e 616d 6963  omToTop, Dynamic
-0000d530: 416c 6c44 6972 6563 7469 6f6e 732c 2044  AllDirections, D
-0000d540: 796e 616d 6963 496e 6e65 7254 6f4f 7574  ynamicInnerToOut
-0000d550: 6572 2c20 4479 6e61 6d69 634c 6566 7454  er, DynamicLeftT
-0000d560: 6f52 6967 6874 2c20 4479 6e61 6d69 6354  oRight, DynamicT
-0000d570: 6f70 546f 426f 7474 6f6d 2c20 496e 6e65  opToBottom, Inne
-0000d580: 7254 6f4f 7574 6572 2c20 4c65 6674 546f  rToOuter, LeftTo
-0000d590: 5269 6768 742c 204f 7574 6572 546f 496e  Right, OuterToIn
-0000d5a0: 6e65 722c 2052 6967 6874 546f 4c65 6674  ner, RightToLeft
-0000d5b0: 2c20 546f 7054 6f42 6f74 746f 6d22 2920  , TopToBottom") 
-0000d5c0: 2020 2020 2020 200a 0a20 2020 2020 2020         ..       
-0000d5d0: 2072 6574 7572 6e20 7061 7474 6572 6e0a   return pattern.
-0000d5e0: 0a20 2020 2064 6566 2064 7261 775f 6c69  .    def draw_li
-0000d5f0: 6e65 2873 656c 662c 2070 6174 7465 726e  ne(self, pattern
-0000d600: 5f73 6574 7469 6e67 733a 2046 6962 7365  _settings: Fibse
-0000d610: 6d50 6174 7465 726e 5365 7474 696e 6773  mPatternSettings
-0000d620: 293a 0a20 2020 2020 2020 2022 2222 0a20  ):.        """. 
-0000d630: 2020 2020 2020 2044 7261 7773 2061 206c         Draws a l
-0000d640: 696e 6520 7061 7474 6572 6e20 6f6e 2074  ine pattern on t
-0000d650: 6865 2063 7572 7265 6e74 2069 6d61 6769  he current imagi
-0000d660: 6e67 2076 6965 7720 6f66 2074 6865 206d  ng view of the m
-0000d670: 6963 726f 7363 6f70 652e 0a0a 2020 2020  icroscope...    
-0000d680: 2020 2020 4172 6773 3a0a 2020 2020 2020      Args:.      
-0000d690: 2020 2020 2020 7061 7474 6572 6e5f 7365        pattern_se
-0000d6a0: 7474 696e 6773 2028 4669 6273 656d 5061  ttings (FibsemPa
-0000d6b0: 7474 6572 6e53 6574 7469 6e67 7329 3a20  tternSettings): 
-0000d6c0: 4120 6461 7461 2063 6c61 7373 206f 626a  A data class obj
-0000d6d0: 6563 7420 7370 6563 6966 7969 6e67 2074  ect specifying t
-0000d6e0: 6865 2070 6174 7465 726e 2070 6172 616d  he pattern param
-0000d6f0: 6574 6572 732c 0a20 2020 2020 2020 2020  eters,.         
-0000d700: 2020 2020 2020 2069 6e63 6c75 6469 6e67         including
-0000d710: 2074 6865 2073 7461 7274 2061 6e64 2065   the start and e
-0000d720: 6e64 2070 6f69 6e74 732c 2061 6e64 2074  nd points, and t
-0000d730: 6865 2064 6570 7468 206f 6620 7468 6520  he depth of the 
-0000d740: 7061 7474 6572 6e2e 0a0a 2020 2020 2020  pattern...      
-0000d750: 2020 5265 7475 726e 733a 0a20 2020 2020    Returns:.     
-0000d760: 2020 2020 2020 204c 696e 6550 6174 7465         LinePatte
-0000d770: 726e 3a20 4120 6c69 6e65 2070 6174 7465  rn: A line patte
-0000d780: 726e 206f 626a 6563 742c 2077 6869 6368  rn object, which
-0000d790: 2063 616e 2062 6520 7573 6564 2074 6f20   can be used to 
-0000d7a0: 636f 6e66 6967 7572 6520 6675 7274 6865  configure furthe
-0000d7b0: 7220 7072 6f70 6572 7469 6573 206f 7220  r properties or 
-0000d7c0: 746f 2061 6464 2074 6865 0a20 2020 2020  to add the.     
-0000d7d0: 2020 2020 2020 2020 2020 2070 6174 7465             patte
-0000d7e0: 726e 2074 6f20 7468 6520 6d69 6c6c 696e  rn to the millin
-0000d7f0: 6720 6c69 7374 2e0a 0a20 2020 2020 2020  g list...       
-0000d800: 2052 6169 7365 733a 0a20 2020 2020 2020   Raises:.       
-0000d810: 2020 2020 2061 7574 6f73 6372 6970 742e       autoscript.
-0000d820: 6578 6365 7074 696f 6e73 2e49 6e76 616c  exceptions.Inval
-0000d830: 6964 4172 6775 6d65 6e74 4578 6365 7074  idArgumentExcept
-0000d840: 696f 6e3a 2069 6620 616e 7920 6f66 2074  ion: if any of t
-0000d850: 6865 2070 6174 7465 726e 2070 6172 616d  he pattern param
-0000d860: 6574 6572 7320 6172 6520 696e 7661 6c69  eters are invali
-0000d870: 642e 0a20 2020 2020 2020 2022 2222 0a20  d..        """. 
-0000d880: 2020 2020 2020 2070 6174 7465 726e 203d         pattern =
-0000d890: 2073 656c 662e 636f 6e6e 6563 7469 6f6e   self.connection
-0000d8a0: 2e70 6174 7465 726e 696e 672e 6372 6561  .patterning.crea
-0000d8b0: 7465 5f6c 696e 6528 0a20 2020 2020 2020  te_line(.       
-0000d8c0: 2020 2020 2073 7461 7274 5f78 3d70 6174       start_x=pat
-0000d8d0: 7465 726e 5f73 6574 7469 6e67 732e 7374  tern_settings.st
-0000d8e0: 6172 745f 782c 0a20 2020 2020 2020 2020  art_x,.         
-0000d8f0: 2020 2073 7461 7274 5f79 3d70 6174 7465     start_y=patte
-0000d900: 726e 5f73 6574 7469 6e67 732e 7374 6172  rn_settings.star
-0000d910: 745f 792c 0a20 2020 2020 2020 2020 2020  t_y,.           
-0000d920: 2065 6e64 5f78 3d70 6174 7465 726e 5f73   end_x=pattern_s
-0000d930: 6574 7469 6e67 732e 656e 645f 782c 0a20  ettings.end_x,. 
-0000d940: 2020 2020 2020 2020 2020 2065 6e64 5f79             end_y
-0000d950: 3d70 6174 7465 726e 5f73 6574 7469 6e67  =pattern_setting
-0000d960: 732e 656e 645f 792c 0a20 2020 2020 2020  s.end_y,.       
-0000d970: 2020 2020 2064 6570 7468 3d70 6174 7465       depth=patte
-0000d980: 726e 5f73 6574 7469 6e67 732e 6465 7074  rn_settings.dept
-0000d990: 682c 0a20 2020 2020 2020 2029 0a0a 2020  h,.        )..  
-0000d9a0: 2020 2020 2020 7265 7475 726e 2070 6174        return pat
-0000d9b0: 7465 726e 0a20 2020 200a 2020 2020 6465  tern.    .    de
-0000d9c0: 6620 6472 6177 5f63 6972 636c 6528 7365  f draw_circle(se
-0000d9d0: 6c66 2c20 7061 7474 6572 6e5f 7365 7474  lf, pattern_sett
-0000d9e0: 696e 6773 3a20 4669 6273 656d 5061 7474  ings: FibsemPatt
-0000d9f0: 6572 6e53 6574 7469 6e67 7329 3a0a 2020  ernSettings):.  
-0000da00: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-0000da10: 2020 4472 6177 7320 6120 6369 7263 6c65    Draws a circle
-0000da20: 2070 6174 7465 726e 206f 6e20 7468 6520   pattern on the 
-0000da30: 6375 7272 656e 7420 696d 6167 696e 6720  current imaging 
-0000da40: 7669 6577 206f 6620 7468 6520 6d69 6372  view of the micr
-0000da50: 6f73 636f 7065 2e0a 0a20 2020 2020 2020  oscope...       
-0000da60: 2041 7267 733a 0a20 2020 2020 2020 2020   Args:.         
-0000da70: 2020 2070 6174 7465 726e 5f73 6574 7469     pattern_setti
-0000da80: 6e67 7320 2846 6962 7365 6d50 6174 7465  ngs (FibsemPatte
-0000da90: 726e 5365 7474 696e 6773 293a 2041 2064  rnSettings): A d
-0000daa0: 6174 6120 636c 6173 7320 6f62 6a65 6374  ata class object
-0000dab0: 2073 7065 6369 6679 696e 6720 7468 6520   specifying the 
-0000dac0: 7061 7474 6572 6e20 7061 7261 6d65 7465  pattern paramete
-0000dad0: 7273 2c0a 2020 2020 2020 2020 2020 2020  rs,.            
-0000dae0: 2020 2020 696e 636c 7564 696e 6720 7468      including th
-0000daf0: 6520 6365 6e74 7265 2070 6f69 6e74 2c20  e centre point, 
-0000db00: 7261 6469 7573 2061 6e64 2064 6570 7468  radius and depth
-0000db10: 206f 6620 7468 6520 7061 7474 6572 6e2e   of the pattern.
-0000db20: 0a0a 2020 2020 2020 2020 5265 7475 726e  ..        Return
-0000db30: 733a 0a20 2020 2020 2020 2020 2020 2043  s:.            C
-0000db40: 6972 636c 6550 6174 7465 726e 3a20 4120  irclePattern: A 
-0000db50: 6369 7263 6c65 2070 6174 7465 726e 206f  circle pattern o
-0000db60: 626a 6563 742c 2077 6869 6368 2063 616e  bject, which can
-0000db70: 2062 6520 7573 6564 2074 6f20 636f 6e66   be used to conf
-0000db80: 6967 7572 6520 6675 7274 6865 7220 7072  igure further pr
-0000db90: 6f70 6572 7469 6573 206f 7220 746f 2061  operties or to a
-0000dba0: 6464 2074 6865 0a20 2020 2020 2020 2020  dd the.         
-0000dbb0: 2020 2020 2020 2070 6174 7465 726e 2074         pattern t
-0000dbc0: 6f20 7468 6520 6d69 6c6c 696e 6720 6c69  o the milling li
-0000dbd0: 7374 2e0a 0a20 2020 2020 2020 2052 6169  st...        Rai
-0000dbe0: 7365 733a 0a20 2020 2020 2020 2020 2020  ses:.           
-0000dbf0: 2061 7574 6f73 6372 6970 742e 6578 6365   autoscript.exce
-0000dc00: 7074 696f 6e73 2e49 6e76 616c 6964 4172  ptions.InvalidAr
-0000dc10: 6775 6d65 6e74 4578 6365 7074 696f 6e3a  gumentException:
-0000dc20: 2069 6620 616e 7920 6f66 2074 6865 2070   if any of the p
-0000dc30: 6174 7465 726e 2070 6172 616d 6574 6572  attern parameter
-0000dc40: 7320 6172 6520 696e 7661 6c69 642e 0a20  s are invalid.. 
-0000dc50: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-0000dc60: 2020 2070 6174 7465 726e 203d 2073 656c     pattern = sel
-0000dc70: 662e 636f 6e6e 6563 7469 6f6e 2e70 6174  f.connection.pat
-0000dc80: 7465 726e 696e 672e 6372 6561 7465 5f63  terning.create_c
-0000dc90: 6972 636c 6528 0a20 2020 2020 2020 2020  ircle(.         
-0000dca0: 2020 2063 656e 7465 725f 783d 7061 7474     center_x=patt
-0000dcb0: 6572 6e5f 7365 7474 696e 6773 2e63 656e  ern_settings.cen
-0000dcc0: 7472 655f 782c 0a20 2020 2020 2020 2020  tre_x,.         
-0000dcd0: 2020 2063 656e 7465 725f 793d 7061 7474     center_y=patt
-0000dce0: 6572 6e5f 7365 7474 696e 6773 2e63 656e  ern_settings.cen
-0000dcf0: 7472 655f 792c 0a20 2020 2020 2020 2020  tre_y,.         
-0000dd00: 2020 206f 7574 6572 5f64 6961 6d65 7465     outer_diamete
-0000dd10: 723d 322a 7061 7474 6572 6e5f 7365 7474  r=2*pattern_sett
-0000dd20: 696e 6773 2e72 6164 6975 732c 0a20 2020  ings.radius,.   
-0000dd30: 2020 2020 2020 2020 2069 6e6e 6572 5f64           inner_d
-0000dd40: 6961 6d65 7465 7220 3d20 302c 0a20 2020  iameter = 0,.   
-0000dd50: 2020 2020 2020 2020 2064 6570 7468 3d70           depth=p
-0000dd60: 6174 7465 726e 5f73 6574 7469 6e67 732e  attern_settings.
-0000dd70: 6465 7074 682c 0a20 2020 2020 2020 2029  depth,.        )
-0000dd80: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
-0000dd90: 2070 6174 7465 726e 0a0a 2020 2020 6465   pattern..    de
-0000dda0: 6620 6472 6177 5f61 6e6e 756c 7573 2873  f draw_annulus(s
-0000ddb0: 656c 662c 2070 6174 7465 726e 5f73 6574  elf, pattern_set
-0000ddc0: 7469 6e67 733a 2046 6962 7365 6d50 6174  tings: FibsemPat
-0000ddd0: 7465 726e 5365 7474 696e 6773 293a 0a0a  ternSettings):..
-0000dde0: 2020 2020 2020 2020 6f75 7465 725f 6469          outer_di
-0000ddf0: 616d 6574 6572 203d 2032 2a70 6174 7465  ameter = 2*patte
-0000de00: 726e 5f73 6574 7469 6e67 732e 7261 6469  rn_settings.radi
-0000de10: 7573 0a20 2020 2020 2020 2069 6e6e 6572  us.        inner
-0000de20: 5f64 6961 6d65 7465 7220 3d20 6f75 7465  _diameter = oute
-0000de30: 725f 6469 616d 6574 6572 202d 2032 2a70  r_diameter - 2*p
-0000de40: 6174 7465 726e 5f73 6574 7469 6e67 732e  attern_settings.
-0000de50: 7468 6963 6b6e 6573 730a 0a20 2020 2020  thickness..     
-0000de60: 2020 2070 6174 7465 726e 203d 2073 656c     pattern = sel
-0000de70: 662e 636f 6e6e 6563 7469 6f6e 2e70 6174  f.connection.pat
-0000de80: 7465 726e 696e 672e 6372 6561 7465 5f63  terning.create_c
-0000de90: 6972 636c 6528 0a20 2020 2020 2020 2020  ircle(.         
-0000dea0: 2020 2063 656e 7465 725f 783d 7061 7474     center_x=patt
-0000deb0: 6572 6e5f 7365 7474 696e 6773 2e63 656e  ern_settings.cen
-0000dec0: 7472 655f 782c 0a20 2020 2020 2020 2020  tre_x,.         
-0000ded0: 2020 2063 656e 7465 725f 793d 7061 7474     center_y=patt
-0000dee0: 6572 6e5f 7365 7474 696e 6773 2e63 656e  ern_settings.cen
-0000def0: 7472 655f 792c 0a20 2020 2020 2020 2020  tre_y,.         
-0000df00: 2020 206f 7574 6572 5f64 6961 6d65 7465     outer_diamete
-0000df10: 723d 6f75 7465 725f 6469 616d 6574 6572  r=outer_diameter
-0000df20: 2c0a 2020 2020 2020 2020 2020 2020 696e  ,.            in
-0000df30: 6e65 725f 6469 616d 6574 6572 203d 2069  ner_diameter = i
-0000df40: 6e6e 6572 5f64 6961 6d65 7465 722c 0a20  nner_diameter,. 
-0000df50: 2020 2020 2020 2020 2020 2064 6570 7468             depth
-0000df60: 3d70 6174 7465 726e 5f73 6574 7469 6e67  =pattern_setting
-0000df70: 732e 6465 7074 682c 0a20 2020 2020 2020  s.depth,.       
-0000df80: 2029 0a0a 2020 2020 2020 2020 7265 7475   )..        retu
-0000df90: 726e 2070 6174 7465 726e 0a20 2020 200a  rn pattern.    .
-0000dfa0: 2020 2020 0a20 2020 2064 6566 2064 7261      .    def dra
-0000dfb0: 775f 6269 746d 6170 5f70 6174 7465 726e  w_bitmap_pattern
-0000dfc0: 280a 2020 2020 2020 2020 7365 6c66 2c0a  (.        self,.
-0000dfd0: 2020 2020 2020 2020 7061 7474 6572 6e5f          pattern_
-0000dfe0: 7365 7474 696e 6773 3a20 4669 6273 656d  settings: Fibsem
-0000dff0: 5061 7474 6572 6e53 6574 7469 6e67 732c  PatternSettings,
-0000e000: 0a20 2020 2020 2020 2070 6174 683a 2073  .        path: s
-0000e010: 7472 2c0a 2020 2020 293a 0a0a 2020 2020  tr,.    ):..    
-0000e020: 2020 2020 6269 746d 6170 5f70 6174 7465      bitmap_patte
-0000e030: 726e 203d 2042 6974 6d61 7050 6174 7465  rn = BitmapPatte
-0000e040: 726e 4465 6669 6e69 7469 6f6e 2e6c 6f61  rnDefinition.loa
-0000e050: 6428 7061 7468 290a 0a20 2020 2020 2020  d(path)..       
-0000e060: 2070 6174 7465 726e 203d 2073 656c 662e   pattern = self.
-0000e070: 636f 6e6e 6563 7469 6f6e 2e70 6174 7465  connection.patte
-0000e080: 726e 696e 672e 6372 6561 7465 5f62 6974  rning.create_bit
-0000e090: 6d61 7028 0a20 2020 2020 2020 2020 2020  map(.           
-0000e0a0: 2063 656e 7465 725f 783d 7061 7474 6572   center_x=patter
-0000e0b0: 6e5f 7365 7474 696e 6773 2e63 656e 7472  n_settings.centr
-0000e0c0: 655f 782c 0a20 2020 2020 2020 2020 2020  e_x,.           
-0000e0d0: 2063 656e 7465 725f 793d 7061 7474 6572   center_y=patter
-0000e0e0: 6e5f 7365 7474 696e 6773 2e63 656e 7472  n_settings.centr
-0000e0f0: 655f 792c 0a20 2020 2020 2020 2020 2020  e_y,.           
-0000e100: 2077 6964 7468 3d70 6174 7465 726e 5f73   width=pattern_s
-0000e110: 6574 7469 6e67 732e 7769 6474 682c 0a20  ettings.width,. 
-0000e120: 2020 2020 2020 2020 2020 2068 6569 6768             heigh
-0000e130: 743d 7061 7474 6572 6e5f 7365 7474 696e  t=pattern_settin
-0000e140: 6773 2e68 6569 6768 742c 0a20 2020 2020  gs.height,.     
-0000e150: 2020 2020 2020 2064 6570 7468 3d70 6174         depth=pat
-0000e160: 7465 726e 5f73 6574 7469 6e67 732e 6465  tern_settings.de
-0000e170: 7074 682c 0a20 2020 2020 2020 2020 2020  pth,.           
-0000e180: 2062 6974 6d61 705f 7061 7474 6572 6e5f   bitmap_pattern_
-0000e190: 6465 6669 6e69 7469 6f6e 3d62 6974 6d61  definition=bitma
-0000e1a0: 705f 7061 7474 6572 6e2c 0a20 2020 2020  p_pattern,.     
-0000e1b0: 2020 2029 0a0a 2020 2020 2020 2020 7265     )..        re
-0000e1c0: 7475 726e 2070 6174 7465 726e 0a0a 2020  turn pattern..  
-0000e1d0: 2020 6465 6620 6765 745f 7363 616e 5f64    def get_scan_d
-0000e1e0: 6972 6563 7469 6f6e 7328 7365 6c66 2920  irections(self) 
-0000e1f0: 2d3e 206c 6973 743a 0a20 2020 2020 2020  -> list:.       
-0000e200: 2022 2222 0a20 2020 2020 2020 2052 6574   """.        Ret
-0000e210: 7572 6e73 2074 6865 2061 7661 696c 6162  urns the availab
-0000e220: 6c65 2073 6361 6e20 6469 7265 6374 696f  le scan directio
-0000e230: 6e73 206f 6620 7468 6520 6d69 6372 6f73  ns of the micros
-0000e240: 636f 7065 2e0a 0a20 2020 2020 2020 2052  cope...        R
-0000e250: 6574 7572 6e73 3a0a 2020 2020 2020 2020  eturns:.        
-0000e260: 2020 2020 6c69 7374 3a20 5468 6520 7363      list: The sc
-0000e270: 616e 2064 6972 6563 7469 6f6e 206f 6620  an direction of 
-0000e280: 7468 6520 6d69 6372 6f73 636f 7065 2e0a  the microscope..
-0000e290: 0a20 2020 2020 2020 2052 6169 7365 733a  .        Raises:
-0000e2a0: 0a20 2020 2020 2020 2020 2020 204e 6f6e  .            Non
-0000e2b0: 650a 2020 2020 2020 2020 2222 220a 2020  e.        """.  
-0000e2c0: 2020 2020 2020 6c69 7374 203d 205b 2242        list = ["B
-0000e2d0: 6f74 746f 6d54 6f54 6f70 222c 200a 2020  ottomToTop", .  
-0000e2e0: 2020 2020 2020 2020 2020 2020 2020 2244                "D
-0000e2f0: 796e 616d 6963 416c 6c44 6972 6563 7469  ynamicAllDirecti
-0000e300: 6f6e 7322 2c20 0a20 2020 2020 2020 2020  ons", .         
-0000e310: 2020 2020 2020 2022 4479 6e61 6d69 6349         "DynamicI
-0000e320: 6e6e 6572 546f 4f75 7465 7222 2c20 0a20  nnerToOuter", . 
-0000e330: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-0000e340: 4479 6e61 6d69 634c 6566 7454 6f52 6967  DynamicLeftToRig
-0000e350: 6874 222c 200a 2020 2020 2020 2020 2020  ht", .          
-0000e360: 2020 2020 2020 2244 796e 616d 6963 546f        "DynamicTo
-0000e370: 7054 6f42 6f74 746f 6d22 2c20 0a20 2020  pToBottom", .   
-0000e380: 2020 2020 2020 2020 2020 2020 2022 496e               "In
-0000e390: 6e65 7254 6f4f 7574 6572 222c 2009 0a20  nerToOuter", .. 
-0000e3a0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-0000e3b0: 4c65 6674 546f 5269 6768 7422 2c20 090a  LeftToRight", ..
-0000e3c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e3d0: 224f 7574 6572 546f 496e 6e65 7222 2c20  "OuterToInner", 
-0000e3e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000e3f0: 2022 5269 6768 7454 6f4c 6566 7422 2c20   "RightToLeft", 
-0000e400: 090a 2020 2020 2020 2020 2020 2020 2020  ..              
-0000e410: 2020 2254 6f70 546f 426f 7474 6f6d 225d    "TopToBottom"]
-0000e420: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-0000e430: 6c69 7374 200a 0a0a 2020 2020 6465 6620  list ...    def 
-0000e440: 7365 7475 705f 7370 7574 7465 7228 7365  setup_sputter(se
-0000e450: 6c66 2c20 7072 6f74 6f63 6f6c 3a20 6469  lf, protocol: di
-0000e460: 6374 293a 0a20 2020 2020 2020 2022 2222  ct):.        """
-0000e470: 0a20 2020 2020 2020 2053 6574 2075 7020  .        Set up 
-0000e480: 7468 6520 7370 7574 7465 7220 636f 6174  the sputter coat
-0000e490: 696e 6720 7072 6f63 6573 7320 6f6e 2074  ing process on t
-0000e4a0: 6865 206d 6963 726f 7363 6f70 652e 0a0a  he microscope...
-0000e4b0: 2020 2020 2020 2020 4172 6773 3a0a 2020          Args:.  
-0000e4c0: 2020 2020 2020 2020 2020 7072 6f74 6f63            protoc
-0000e4d0: 6f6c 2028 6469 6374 293a 2044 6963 7469  ol (dict): Dicti
-0000e4e0: 6f6e 6172 7920 636f 6e74 6169 6e69 6e67  onary containing
-0000e4f0: 2074 6865 2070 726f 746f 636f 6c20 6465   the protocol de
-0000e500: 7461 696c 7320 666f 7220 7370 7574 7465  tails for sputte
-0000e510: 7220 636f 6174 696e 672e 0a0a 2020 2020  r coating...    
-0000e520: 2020 2020 5265 7475 726e 733a 0a20 2020      Returns:.   
-0000e530: 2020 2020 2020 2020 204e 6f6e 650a 0a20           None.. 
-0000e540: 2020 2020 2020 2052 6169 7365 733a 0a20         Raises:. 
-0000e550: 2020 2020 2020 2020 2020 204e 6f6e 650a             None.
-0000e560: 0a20 2020 2020 2020 204e 6f74 6573 3a0a  .        Notes:.
-0000e570: 2020 2020 2020 2020 2020 2020 5468 6973              This
-0000e580: 2066 756e 6374 696f 6e20 7365 7473 2075   function sets u
-0000e590: 7020 7468 6520 7370 7574 7465 7220 636f  p the sputter co
-0000e5a0: 6174 696e 6720 7072 6f63 6573 7320 6f6e  ating process on
-0000e5b0: 2074 6865 206d 6963 726f 7363 6f70 652e   the microscope.
-0000e5c0: 200a 2020 2020 2020 2020 2020 2020 4974   .            It
-0000e5d0: 2073 6574 7320 7468 6520 6163 7469 7665   sets the active
-0000e5e0: 2076 6965 7720 746f 2074 6865 2065 6c65   view to the ele
-0000e5f0: 6374 726f 6e20 6265 616d 2c20 636c 6561  ctron beam, clea
-0000e600: 7273 2061 6e79 2065 7869 7374 696e 6720  rs any existing 
-0000e610: 7061 7474 6572 6e73 2c20 616e 6420 7365  patterns, and se
-0000e620: 7473 2074 6865 2064 6566 6175 6c74 2062  ts the default b
-0000e630: 6561 6d20 7479 7065 2074 6f20 7468 6520  eam type to the 
-0000e640: 656c 6563 7472 6f6e 2062 6561 6d2e 200a  electron beam. .
-0000e650: 2020 2020 2020 2020 2020 2020 4974 2074              It t
-0000e660: 6865 6e20 696e 7365 7274 7320 7468 6520  hen inserts the 
-0000e670: 6d75 6c74 6963 6865 6d20 616e 6420 7475  multichem and tu
-0000e680: 726e 7320 6f6e 2074 6865 2068 6561 7465  rns on the heate
-0000e690: 7220 666f 7220 7468 6520 7370 6563 6966  r for the specif
-0000e6a0: 6965 6420 6761 7320 6163 636f 7264 696e  ied gas accordin
-0000e6b0: 6720 746f 2074 6865 2067 6976 656e 2070  g to the given p
-0000e6c0: 726f 746f 636f 6c2e 200a 2020 2020 2020  rotocol. .      
-0000e6d0: 2020 2020 2020 5468 6973 2066 756e 6374        This funct
-0000e6e0: 696f 6e20 616c 736f 2077 6169 7473 2066  ion also waits f
-0000e6f0: 6f72 2033 2073 6563 6f6e 6473 2074 6f20  or 3 seconds to 
-0000e700: 616c 6c6f 7720 7468 6520 6865 6174 6572  allow the heater
-0000e710: 2074 6f20 7761 726d 2075 702e 0a20 2020   to warm up..   
-0000e720: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-0000e730: 205f 6368 6563 6b5f 7370 7574 7465 7228   _check_sputter(
-0000e740: 7365 6c66 2e68 6172 6477 6172 655f 7365  self.hardware_se
-0000e750: 7474 696e 6773 290a 2020 2020 2020 2020  ttings).        
-0000e760: 7365 6c66 2e6f 7269 6769 6e61 6c5f 6163  self.original_ac
-0000e770: 7469 7665 5f76 6965 7720 3d20 7365 6c66  tive_view = self
-0000e780: 2e63 6f6e 6e65 6374 696f 6e2e 696d 6167  .connection.imag
-0000e790: 696e 672e 6765 745f 6163 7469 7665 5f76  ing.get_active_v
-0000e7a0: 6965 7728 290a 2020 2020 2020 2020 7365  iew().        se
-0000e7b0: 6c66 2e63 6f6e 6e65 6374 696f 6e2e 696d  lf.connection.im
-0000e7c0: 6167 696e 672e 7365 745f 6163 7469 7665  aging.set_active
-0000e7d0: 5f76 6965 7728 4265 616d 5479 7065 2e45  _view(BeamType.E
-0000e7e0: 4c45 4354 524f 4e2e 7661 6c75 6529 0a20  LECTRON.value). 
-0000e7f0: 2020 2020 2020 2073 656c 662e 636f 6e6e         self.conn
-0000e800: 6563 7469 6f6e 2e70 6174 7465 726e 696e  ection.patternin
-0000e810: 672e 636c 6561 725f 7061 7474 6572 6e73  g.clear_patterns
-0000e820: 2829 0a20 2020 2020 2020 2073 656c 662e  ().        self.
-0000e830: 636f 6e6e 6563 7469 6f6e 2e70 6174 7465  connection.patte
-0000e840: 726e 696e 672e 7365 745f 6465 6661 756c  rning.set_defaul
-0000e850: 745f 6170 706c 6963 6174 696f 6e5f 6669  t_application_fi
-0000e860: 6c65 2870 726f 746f 636f 6c5b 2261 7070  le(protocol["app
-0000e870: 6c69 6361 7469 6f6e 5f66 696c 6522 5d29  lication_file"])
-0000e880: 0a20 2020 2020 2020 2073 656c 662e 636f  .        self.co
-0000e890: 6e6e 6563 7469 6f6e 2e70 6174 7465 726e  nnection.pattern
-0000e8a0: 696e 672e 7365 745f 6465 6661 756c 745f  ing.set_default_
-0000e8b0: 6265 616d 5f74 7970 6528 4265 616d 5479  beam_type(BeamTy
-0000e8c0: 7065 2e45 4c45 4354 524f 4e2e 7661 6c75  pe.ELECTRON.valu
-0000e8d0: 6529 0a20 2020 2020 2020 2073 656c 662e  e).        self.
-0000e8e0: 6d75 6c74 6963 6865 6d20 3d20 7365 6c66  multichem = self
-0000e8f0: 2e63 6f6e 6e65 6374 696f 6e2e 6761 732e  .connection.gas.
-0000e900: 6765 745f 6d75 6c74 6963 6865 6d28 290a  get_multichem().
-0000e910: 2020 2020 2020 2020 7365 6c66 2e6d 756c          self.mul
-0000e920: 7469 6368 656d 2e69 6e73 6572 7428 7072  tichem.insert(pr
-0000e930: 6f74 6f63 6f6c 5b22 706f 7369 7469 6f6e  otocol["position
-0000e940: 225d 290a 2020 2020 2020 2020 7365 6c66  "]).        self
-0000e950: 2e6d 756c 7469 6368 656d 2e74 7572 6e5f  .multichem.turn_
-0000e960: 6865 6174 6572 5f6f 6e28 7072 6f74 6f63  heater_on(protoc
-0000e970: 6f6c 5b22 6761 7322 5d29 2020 2320 2250  ol["gas"])  # "P
-0000e980: 7420 6372 796f 2229 0a20 2020 2020 2020  t cryo").       
-0000e990: 2074 696d 652e 736c 6565 7028 3329 0a0a   time.sleep(3)..
-0000e9a0: 2020 2020 6465 6620 6472 6177 5f73 7075      def draw_spu
-0000e9b0: 7474 6572 5f70 6174 7465 726e 2873 656c  tter_pattern(sel
-0000e9c0: 662c 2068 6677 3a20 666c 6f61 742c 206c  f, hfw: float, l
-0000e9d0: 696e 655f 7061 7474 6572 6e5f 6c65 6e67  ine_pattern_leng
-0000e9e0: 7468 3a20 666c 6f61 742c 2073 7075 7474  th: float, sputt
-0000e9f0: 6572 5f74 696d 653a 2066 6c6f 6174 293a  er_time: float):
-0000ea00: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-0000ea10: 2020 2020 2044 7261 7773 2061 206c 696e       Draws a lin
-0000ea20: 6520 7061 7474 6572 6e20 666f 7220 7370  e pattern for sp
-0000ea30: 7574 7465 7269 6e67 2077 6974 6820 7468  uttering with th
-0000ea40: 6520 6769 7665 6e20 7061 7261 6d65 7465  e given paramete
-0000ea50: 7273 2e0a 0a20 2020 2020 2020 2041 7267  rs...        Arg
-0000ea60: 733a 0a20 2020 2020 2020 2020 2020 2068  s:.            h
-0000ea70: 6677 2028 666c 6f61 7429 3a20 5468 6520  fw (float): The 
-0000ea80: 686f 7269 7a6f 6e74 616c 2066 6965 6c64  horizontal field
-0000ea90: 2077 6964 7468 206f 6620 7468 6520 656c   width of the el
-0000eaa0: 6563 7472 6f6e 2062 6561 6d2e 0a20 2020  ectron beam..   
-0000eab0: 2020 2020 2020 2020 206c 696e 655f 7061           line_pa
-0000eac0: 7474 6572 6e5f 6c65 6e67 7468 2028 666c  ttern_length (fl
-0000ead0: 6f61 7429 3a20 5468 6520 6c65 6e67 7468  oat): The length
-0000eae0: 206f 6620 7468 6520 6c69 6e65 2070 6174   of the line pat
-0000eaf0: 7465 726e 2074 6f20 6472 6177 2e0a 2020  tern to draw..  
-0000eb00: 2020 2020 2020 2020 2020 7370 7574 7465            sputte
-0000eb10: 725f 7469 6d65 2028 666c 6f61 7429 3a20  r_time (float): 
-0000eb20: 5468 6520 7469 6d65 2074 6f20 7370 7574  The time to sput
-0000eb30: 7465 7220 7468 6520 6c69 6e65 2070 6174  ter the line pat
-0000eb40: 7465 726e 2e0a 0a20 2020 2020 2020 2052  tern...        R
-0000eb50: 6574 7572 6e73 3a0a 2020 2020 2020 2020  eturns:.        
-0000eb60: 2020 2020 4e6f 6e65 0a0a 2020 2020 2020      None..      
-0000eb70: 2020 4e6f 7465 733a 0a20 2020 2020 2020    Notes:.       
-0000eb80: 2020 2020 2053 6574 7320 7468 6520 686f       Sets the ho
-0000eb90: 7269 7a6f 6e74 616c 2066 6965 6c64 2077  rizontal field w
-0000eba0: 6964 7468 206f 6620 7468 6520 656c 6563  idth of the elec
-0000ebb0: 7472 6f6e 2062 6561 6d20 746f 2074 6865  tron beam to the
-0000ebc0: 2067 6976 656e 2076 616c 7565 2e0a 2020   given value..  
-0000ebd0: 2020 2020 2020 2020 2020 4472 6177 7320            Draws 
-0000ebe0: 6120 6c69 6e65 2070 6174 7465 726e 2066  a line pattern f
-0000ebf0: 6f72 2073 7075 7474 6572 696e 6720 7769  or sputtering wi
-0000ec00: 7468 2074 6865 2067 6976 656e 206c 656e  th the given len
-0000ec10: 6774 6820 616e 6420 6d69 6c6c 696e 6720  gth and milling 
-0000ec20: 6465 7074 682e 0a20 2020 2020 2020 2020  depth..         
-0000ec30: 2020 2053 6574 7320 7468 6520 7370 7574     Sets the sput
-0000ec40: 7465 7220 7469 6d65 206f 6620 7468 6520  ter time of the 
-0000ec50: 6c69 6e65 2070 6174 7465 726e 2074 6f20  line pattern to 
-0000ec60: 7468 6520 6769 7665 6e20 7661 6c75 652e  the given value.
-0000ec70: 0a0a 2020 2020 2020 2020 2222 220a 2020  ..        """.  
-0000ec80: 2020 2020 2020 7365 6c66 2e63 6f6e 6e65        self.conne
-0000ec90: 6374 696f 6e2e 6265 616d 732e 656c 6563  ction.beams.elec
-0000eca0: 7472 6f6e 5f62 6561 6d2e 686f 7269 7a6f  tron_beam.horizo
-0000ecb0: 6e74 616c 5f66 6965 6c64 5f77 6964 7468  ntal_field_width
-0000ecc0: 2e76 616c 7565 203d 2068 6677 0a20 2020  .value = hfw.   
-0000ecd0: 2020 2020 2070 6174 7465 726e 203d 2073       pattern = s
-0000ece0: 656c 662e 636f 6e6e 6563 7469 6f6e 2e70  elf.connection.p
-0000ecf0: 6174 7465 726e 696e 672e 6372 6561 7465  atterning.create
-0000ed00: 5f6c 696e 6528 0a20 2020 2020 2020 2020  _line(.         
-0000ed10: 2020 202d 6c69 6e65 5f70 6174 7465 726e     -line_pattern
-0000ed20: 5f6c 656e 6774 6820 2f20 322c 2020 2320  _length / 2,  # 
-0000ed30: 785f 7374 6172 740a 2020 2020 2020 2020  x_start.        
-0000ed40: 2020 2020 2b6c 696e 655f 7061 7474 6572      +line_patter
-0000ed50: 6e5f 6c65 6e67 7468 2c20 2023 2079 5f73  n_length,  # y_s
-0000ed60: 7461 7274 0a20 2020 2020 2020 2020 2020  tart.           
-0000ed70: 202b 6c69 6e65 5f70 6174 7465 726e 5f6c   +line_pattern_l
-0000ed80: 656e 6774 6820 2f20 322c 2020 2320 785f  ength / 2,  # x_
-0000ed90: 656e 640a 2020 2020 2020 2020 2020 2020  end.            
-0000eda0: 2b6c 696e 655f 7061 7474 6572 6e5f 6c65  +line_pattern_le
-0000edb0: 6e67 7468 2c20 2023 2079 5f65 6e64 0a20  ngth,  # y_end. 
-0000edc0: 2020 2020 2020 2020 2020 2032 652d 362c             2e-6,
-0000edd0: 0a20 2020 2020 2020 2029 2020 2320 6d69  .        )  # mi
-0000ede0: 6c6c 696e 6720 6465 7074 680a 2020 2020  lling depth.    
-0000edf0: 2020 2020 7061 7474 6572 6e2e 7469 6d65      pattern.time
-0000ee00: 203d 2073 7075 7474 6572 5f74 696d 6520   = sputter_time 
-0000ee10: 2b20 302e 310a 0a20 2020 2064 6566 2072  + 0.1..    def r
-0000ee20: 756e 5f73 7075 7474 6572 2873 656c 662c  un_sputter(self,
-0000ee30: 202a 2a6b 7761 7267 7329 3a0a 2020 2020   **kwargs):.    
-0000ee40: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-0000ee50: 5275 6e73 2074 6865 2047 4953 2050 6c61  Runs the GIS Pla
-0000ee60: 7469 6e75 6d20 5370 7574 7465 722e 0a0a  tinum Sputter...
-0000ee70: 2020 2020 2020 2020 4172 6773 3a0a 2020          Args:.  
-0000ee80: 2020 2020 2020 2020 2020 2a2a 6b77 6172            **kwar
-0000ee90: 6773 3a20 4f70 7469 6f6e 616c 206b 6579  gs: Optional key
-0000eea0: 776f 7264 2061 7267 756d 656e 7473 2066  word arguments f
-0000eeb0: 6f72 2074 6865 2073 7075 7474 6572 2066  or the sputter f
-0000eec0: 756e 6374 696f 6e2e 2054 6865 2072 6571  unction. The req
-0000eed0: 7569 7265 6420 6172 6775 6d65 6e74 2066  uired argument f
-0000eee0: 6f72 0a20 2020 2020 2020 2074 6865 2054  or.        the T
-0000eef0: 6865 726d 6f20 7665 7273 696f 6e20 6973  hermo version is
-0000ef00: 2022 7370 7574 7465 725f 7469 6d65 2220   "sputter_time" 
-0000ef10: 2869 6e74 292c 2077 6869 6368 2073 7065  (int), which spe
-0000ef20: 6369 6669 6573 2074 6865 2074 696d 6520  cifies the time 
-0000ef30: 746f 2073 7075 7474 6572 2069 6e20 7365  to sputter in se
-0000ef40: 636f 6e64 732e 200a 0a20 2020 2020 2020  conds. ..       
-0000ef50: 2052 6574 7572 6e73 3a0a 2020 2020 2020   Returns:.      
-0000ef60: 2020 2020 2020 4e6f 6e65 0a0a 2020 2020        None..    
-0000ef70: 2020 2020 4e6f 7465 733a 0a20 2020 2020      Notes:.     
-0000ef80: 2020 202d 2042 6c61 6e6b 7320 7468 6520     - Blanks the 
-0000ef90: 656c 6563 7472 6f6e 2062 6561 6d2e 0a20  electron beam.. 
-0000efa0: 2020 2020 2020 202d 2053 7461 7274 7320         - Starts 
-0000efb0: 7370 7574 7465 7269 6e67 2077 6974 6820  sputtering with 
-0000efc0: 706c 6174 696e 756d 2066 6f72 2074 6865  platinum for the
-0000efd0: 2073 7065 6369 6669 6564 2073 7075 7474   specified sputt
-0000efe0: 6572 2074 696d 652c 2061 6e64 2077 6169  er time, and wai
-0000eff0: 7473 2075 6e74 696c 2074 6865 2073 7075  ts until the spu
-0000f000: 7474 6572 696e 670a 2020 2020 2020 2020  ttering.        
-0000f010: 6973 2063 6f6d 706c 6574 6520 6265 666f  is complete befo
-0000f020: 7265 2063 6f6e 7469 6e75 696e 672e 0a20  re continuing.. 
-0000f030: 2020 2020 2020 202d 2049 6620 7468 6520         - If the 
-0000f040: 7061 7474 6572 6e69 6e67 2073 7461 7465  patterning state
-0000f050: 2069 7320 6e6f 7420 7265 6164 792c 2072   is not ready, r
-0000f060: 6169 7365 7320 6120 5275 6e74 696d 6545  aises a RuntimeE
-0000f070: 7272 6f72 2e0a 2020 2020 2020 2020 2d20  rror..        - 
-0000f080: 4966 2074 6865 2070 6174 7465 726e 696e  If the patternin
-0000f090: 6720 7374 6174 6520 6973 2072 756e 6e69  g state is runni
-0000f0a0: 6e67 2c20 7374 6f70 7320 7468 6520 7061  ng, stops the pa
-0000f0b0: 7474 6572 6e69 6e67 2e0a 2020 2020 2020  tterning..      
-0000f0c0: 2020 2d20 4966 2074 6865 2070 6174 7465    - If the patte
-0000f0d0: 726e 696e 6720 7374 6174 6520 6973 2069  rning state is i
-0000f0e0: 646c 652c 206c 6f67 7320 6120 7761 726e  dle, logs a warn
-0000f0f0: 696e 6720 6d65 7373 6167 6520 7375 6767  ing message sugg
-0000f100: 6573 7469 6e67 2074 6f20 6164 6a75 7374  esting to adjust
-0000f110: 2074 6865 2070 6174 7465 726e 696e 670a   the patterning.
-0000f120: 2020 2020 2020 2020 6c69 6e65 2064 6570          line dep
-0000f130: 7468 2e0a 2020 2020 2020 2020 2222 220a  th..        """.
-0000f140: 2020 2020 2020 2020 5f63 6865 636b 5f73          _check_s
-0000f150: 7075 7474 6572 2873 656c 662e 6861 7264  putter(self.hard
-0000f160: 7761 7265 5f73 6574 7469 6e67 7329 0a20  ware_settings). 
-0000f170: 2020 2020 2020 2073 7075 7474 6572 5f74         sputter_t
-0000f180: 696d 6520 3d20 6b77 6172 6773 5b22 7370  ime = kwargs["sp
-0000f190: 7574 7465 725f 7469 6d65 225d 0a0a 2020  utter_time"]..  
-0000f1a0: 2020 2020 2020 7365 6c66 2e63 6f6e 6e65        self.conne
-0000f1b0: 6374 696f 6e2e 6265 616d 732e 656c 6563  ction.beams.elec
-0000f1c0: 7472 6f6e 5f62 6561 6d2e 626c 616e 6b28  tron_beam.blank(
-0000f1d0: 290a 2020 2020 2020 2020 6966 2073 656c  ).        if sel
-0000f1e0: 662e 636f 6e6e 6563 7469 6f6e 2e70 6174  f.connection.pat
-0000f1f0: 7465 726e 696e 672e 7374 6174 6520 3d3d  terning.state ==
-0000f200: 2022 4964 6c65 223a 0a20 2020 2020 2020   "Idle":.       
-0000f210: 2020 2020 206c 6f67 6769 6e67 2e69 6e66       logging.inf
-0000f220: 6f28 2253 7075 7474 6572 696e 6720 7769  o("Sputtering wi
-0000f230: 7468 2070 6c61 7469 6e75 6d20 666f 7220  th platinum for 
-0000f240: 7b7d 2073 6563 6f6e 6473 2e2e 2e22 2e66  {} seconds...".f
-0000f250: 6f72 6d61 7428 7370 7574 7465 725f 7469  ormat(sputter_ti
-0000f260: 6d65 2929 0a20 2020 2020 2020 2020 2020  me)).           
-0000f270: 2073 656c 662e 636f 6e6e 6563 7469 6f6e   self.connection
-0000f280: 2e70 6174 7465 726e 696e 672e 7374 6172  .patterning.star
-0000f290: 7428 2920 2023 2061 7379 6e63 6872 6f6e  t()  # asynchron
-0000f2a0: 6f75 7320 7061 7474 6572 6e69 6e67 0a20  ous patterning. 
-0000f2b0: 2020 2020 2020 2020 2020 2074 696d 652e             time.
-0000f2c0: 736c 6565 7028 7370 7574 7465 725f 7469  sleep(sputter_ti
-0000f2d0: 6d65 202b 2035 290a 2020 2020 2020 2020  me + 5).        
-0000f2e0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-0000f2f0: 2020 7261 6973 6520 5275 6e74 696d 6545    raise RuntimeE
-0000f300: 7272 6f72 2822 4361 6e27 7420 7370 7574  rror("Can't sput
-0000f310: 7465 7220 706c 6174 696e 756d 2c20 7061  ter platinum, pa
-0000f320: 7474 6572 6e69 6e67 2073 7461 7465 2069  tterning state i
-0000f330: 7320 6e6f 7420 7265 6164 792e 2229 0a20  s not ready."). 
-0000f340: 2020 2020 2020 2069 6620 7365 6c66 2e63         if self.c
-0000f350: 6f6e 6e65 6374 696f 6e2e 7061 7474 6572  onnection.patter
-0000f360: 6e69 6e67 2e73 7461 7465 203d 3d20 2252  ning.state == "R
-0000f370: 756e 6e69 6e67 223a 0a20 2020 2020 2020  unning":.       
-0000f380: 2020 2020 2073 656c 662e 636f 6e6e 6563       self.connec
-0000f390: 7469 6f6e 2e70 6174 7465 726e 696e 672e  tion.patterning.
-0000f3a0: 7374 6f70 2829 0a20 2020 2020 2020 2065  stop().        e
-0000f3b0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-0000f3c0: 206c 6f67 6769 6e67 2e77 6172 6e69 6e67   logging.warning
-0000f3d0: 2822 5061 7474 6572 6e69 6e67 2073 7461  ("Patterning sta
-0000f3e0: 7465 2069 7320 7b7d 222e 666f 726d 6174  te is {}".format
-0000f3f0: 2873 656c 662e 636f 6e6e 6563 7469 6f6e  (self.connection
-0000f400: 2e70 6174 7465 726e 696e 672e 7374 6174  .patterning.stat
-0000f410: 6529 290a 2020 2020 2020 2020 2020 2020  e)).            
-0000f420: 6c6f 6767 696e 672e 7761 726e 696e 6728  logging.warning(
-0000f430: 2243 6f6e 7369 6465 7220 6164 6a75 7374  "Consider adjust
-0000f440: 696e 6720 7468 6520 7061 7474 6572 6e69  ing the patterni
-0000f450: 6e67 206c 696e 6520 6465 7074 682e 2229  ng line depth.")
-0000f460: 0a0a 2020 2020 6465 6620 6669 6e69 7368  ..    def finish
-0000f470: 5f73 7075 7474 6572 2873 656c 662c 2061  _sputter(self, a
-0000f480: 7070 6c69 6361 7469 6f6e 5f66 696c 653a  pplication_file:
-0000f490: 2073 7472 2920 2d3e 204e 6f6e 653a 0a20   str) -> None:. 
-0000f4a0: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-0000f4b0: 2020 2046 696e 6973 6820 7468 6520 7370     Finish the sp
-0000f4c0: 7574 7465 7220 7072 6f63 6573 7320 6279  utter process by
-0000f4d0: 2063 6c65 6172 696e 6720 7061 7474 6572   clearing patter
-0000f4e0: 6e73 2061 6e64 2072 6573 6574 7469 6e67  ns and resetting
-0000f4f0: 2062 6561 6d20 616e 6420 696d 6167 696e   beam and imagin
-0000f500: 6720 7365 7474 696e 6773 2e0a 0a20 2020  g settings...   
-0000f510: 2020 2020 2041 7267 733a 0a20 2020 2020       Args:.     
-0000f520: 2020 2020 2020 2061 7070 6c69 6361 7469         applicati
-0000f530: 6f6e 5f66 696c 6520 2873 7472 293a 2054  on_file (str): T
-0000f540: 6865 2070 6174 6820 746f 2074 6865 2064  he path to the d
-0000f550: 6566 6175 6c74 2061 7070 6c69 6361 7469  efault applicati
-0000f560: 6f6e 2066 696c 6520 746f 2075 7365 2e0a  on file to use..
-0000f570: 0a20 2020 2020 2020 2052 6574 7572 6e73  .        Returns
-0000f580: 3a0a 2020 2020 2020 2020 2020 2020 4e6f  :.            No
-0000f590: 6e65 0a0a 2020 2020 2020 2020 5261 6973  ne..        Rais
-0000f5a0: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
-0000f5b0: 4e6f 6e65 0a0a 2020 2020 2020 2020 4e6f  None..        No
-0000f5c0: 7465 733a 0a20 2020 2020 2020 2020 2020  tes:.           
-0000f5d0: 2054 6869 7320 6675 6e63 7469 6f6e 2066   This function f
-0000f5e0: 696e 6973 6865 7320 7468 6520 7370 7574  inishes the sput
-0000f5f0: 7465 7220 7072 6f63 6573 7320 6279 2063  ter process by c
-0000f600: 6c65 6172 696e 6720 616e 7920 7265 6d61  learing any rema
-0000f610: 696e 696e 6720 7061 7474 6572 6e73 2061  ining patterns a
-0000f620: 6e64 2072 6573 746f 7269 6e67 2074 6865  nd restoring the
-0000f630: 2062 6561 6d20 616e 6420 696d 6167 696e   beam and imagin
-0000f640: 6720 7365 7474 696e 6773 2074 6f20 7468  g settings to th
-0000f650: 6569 720a 2020 2020 2020 2020 2020 2020  eir.            
-0000f660: 6f72 6967 696e 616c 2073 7461 7465 2e20  original state. 
-0000f670: 4974 2073 6574 7320 7468 6520 6265 616d  It sets the beam
-0000f680: 2063 7572 7265 6e74 2062 6163 6b20 746f   current back to
-0000f690: 2069 6d61 6769 6e67 2063 7572 7265 6e74   imaging current
-0000f6a0: 2061 6e64 2073 6574 7320 7468 6520 6465   and sets the de
-0000f6b0: 6661 756c 7420 6265 616d 2074 7970 6520  fault beam type 
-0000f6c0: 746f 2069 6f6e 2062 6561 6d2e 0a20 2020  to ion beam..   
-0000f6d0: 2020 2020 2020 2020 2049 7420 616c 736f           It also
-0000f6e0: 2072 6574 7261 6374 7320 7468 6520 6d75   retracts the mu
-0000f6f0: 6c74 6963 6865 6d20 616e 6420 6c6f 6773  ltichem and logs
-0000f700: 2074 6861 7420 7468 6520 7370 7574 7465   that the sputte
-0000f710: 7269 6e67 2070 726f 6365 7373 2068 6173  ring process has
-0000f720: 2066 696e 6973 6865 642e 0a20 2020 2020   finished..     
-0000f730: 2020 2022 2222 0a20 2020 2020 2020 205f     """.        _
-0000f740: 6368 6563 6b5f 7370 7574 7465 7228 7365  check_sputter(se
-0000f750: 6c66 2e68 6172 6477 6172 655f 7365 7474  lf.hardware_sett
-0000f760: 696e 6773 290a 2020 2020 2020 2020 2320  ings).        # 
-0000f770: 436c 6561 7220 616e 7920 7265 6d61 696e  Clear any remain
-0000f780: 696e 6720 7061 7474 6572 6e73 0a20 2020  ing patterns.   
-0000f790: 2020 2020 2073 656c 662e 636f 6e6e 6563       self.connec
-0000f7a0: 7469 6f6e 2e70 6174 7465 726e 696e 672e  tion.patterning.
-0000f7b0: 636c 6561 725f 7061 7474 6572 6e73 2829  clear_patterns()
-0000f7c0: 0a0a 2020 2020 2020 2020 2320 5265 7374  ..        # Rest
-0000f7d0: 6f72 6520 6265 616d 2061 6e64 2069 6d61  ore beam and ima
-0000f7e0: 6769 6e67 2073 6574 7469 6e67 7320 746f  ging settings to
-0000f7f0: 2074 6865 6972 206f 7269 6769 6e61 6c20   their original 
-0000f800: 7374 6174 650a 2020 2020 2020 2020 7365  state.        se
-0000f810: 6c66 2e63 6f6e 6e65 6374 696f 6e2e 6265  lf.connection.be
-0000f820: 616d 732e 656c 6563 7472 6f6e 5f62 6561  ams.electron_bea
-0000f830: 6d2e 756e 626c 616e 6b28 290a 2020 2020  m.unblank().    
-0000f840: 2020 2020 7365 6c66 2e63 6f6e 6e65 6374      self.connect
-0000f850: 696f 6e2e 7061 7474 6572 6e69 6e67 2e73  ion.patterning.s
-0000f860: 6574 5f64 6566 6175 6c74 5f61 7070 6c69  et_default_appli
-0000f870: 6361 7469 6f6e 5f66 696c 6528 6170 706c  cation_file(appl
-0000f880: 6963 6174 696f 6e5f 6669 6c65 290a 2020  ication_file).  
-0000f890: 2020 2020 2020 7365 6c66 2e63 6f6e 6e65        self.conne
-0000f8a0: 6374 696f 6e2e 696d 6167 696e 672e 7365  ction.imaging.se
-0000f8b0: 745f 6163 7469 7665 5f76 6965 7728 7365  t_active_view(se
-0000f8c0: 6c66 2e6f 7269 6769 6e61 6c5f 6163 7469  lf.original_acti
-0000f8d0: 7665 5f76 6965 7729 0a20 2020 2020 2020  ve_view).       
-0000f8e0: 2073 656c 662e 636f 6e6e 6563 7469 6f6e   self.connection
-0000f8f0: 2e70 6174 7465 726e 696e 672e 7365 745f  .patterning.set_
-0000f900: 6465 6661 756c 745f 6265 616d 5f74 7970  default_beam_typ
-0000f910: 6528 4265 616d 5479 7065 2e49 4f4e 2e76  e(BeamType.ION.v
-0000f920: 616c 7565 2920 2023 2073 6574 2069 6f6e  alue)  # set ion
-0000f930: 2062 6561 6d0a 2020 2020 2020 2020 7365   beam.        se
-0000f940: 6c66 2e6d 756c 7469 6368 656d 2e72 6574  lf.multichem.ret
-0000f950: 7261 6374 2829 0a0a 2020 2020 2020 2020  ract()..        
-0000f960: 2320 4c6f 6720 7468 6174 2074 6865 2073  # Log that the s
-0000f970: 7075 7474 6572 696e 6720 7072 6f63 6573  puttering proces
-0000f980: 7320 6861 7320 6669 6e69 7368 6564 0a20  s has finished. 
-0000f990: 2020 2020 2020 206c 6f67 6769 6e67 2e69         logging.i
-0000f9a0: 6e66 6f28 2250 6c61 7469 6e75 6d20 7370  nfo("Platinum sp
-0000f9b0: 7574 7465 7269 6e67 2070 726f 6365 7373  uttering process
-0000f9c0: 2063 6f6d 706c 6574 6564 2e22 290a 0a20   completed.").. 
-0000f9d0: 2020 2064 6566 2073 6574 7570 5f47 4953     def setup_GIS
-0000f9e0: 2873 656c 662c 7072 6f74 6f63 6f6c 293a  (self,protocol):
-0000f9f0: 0a0a 2020 2020 2020 2020 6265 616d 7479  ..        beamty
-0000fa00: 7065 5f76 616c 7565 203d 2042 6561 6d54  pe_value = BeamT
-0000fa10: 7970 652e 454c 4543 5452 4f4e 2e76 616c  ype.ELECTRON.val
-0000fa20: 7565 2069 6620 7072 6f74 6f63 6f6c 5b22  ue if protocol["
-0000fa30: 6265 616d 5f74 7970 6522 5d20 3d3d 2022  beam_type"] == "
-0000fa40: 656c 6563 7472 6f6e 2220 656c 7365 2042  electron" else B
-0000fa50: 6561 6d54 7970 652e 494f 4e2e 7661 6c75  eamType.ION.valu
-0000fa60: 650a 0a20 2020 2020 2020 205f 6368 6563  e..        _chec
-0000fa70: 6b5f 7370 7574 7465 7228 7365 6c66 2e68  k_sputter(self.h
-0000fa80: 6172 6477 6172 655f 7365 7474 696e 6773  ardware_settings
-0000fa90: 290a 2020 2020 2020 2020 7365 6c66 2e6f  ).        self.o
-0000faa0: 7269 6769 6e61 6c5f 6163 7469 7665 5f76  riginal_active_v
-0000fab0: 6965 7720 3d20 7365 6c66 2e63 6f6e 6e65  iew = self.conne
-0000fac0: 6374 696f 6e2e 696d 6167 696e 672e 6765  ction.imaging.ge
-0000fad0: 745f 6163 7469 7665 5f76 6965 7728 290a  t_active_view().
-0000fae0: 2020 2020 2020 2020 7365 6c66 2e63 6f6e          self.con
-0000faf0: 6e65 6374 696f 6e2e 696d 6167 696e 672e  nection.imaging.
-0000fb00: 7365 745f 6163 7469 7665 5f76 6965 7728  set_active_view(
-0000fb10: 6265 616d 7479 7065 5f76 616c 7565 290a  beamtype_value).
-0000fb20: 2020 2020 2020 2020 7365 6c66 2e63 6f6e          self.con
-0000fb30: 6e65 6374 696f 6e2e 7061 7474 6572 6e69  nection.patterni
-0000fb40: 6e67 2e63 6c65 6172 5f70 6174 7465 726e  ng.clear_pattern
-0000fb50: 7328 290a 2020 2020 2020 2020 7365 6c66  s().        self
-0000fb60: 2e63 6f6e 6e65 6374 696f 6e2e 7061 7474  .connection.patt
-0000fb70: 6572 6e69 6e67 2e73 6574 5f64 6566 6175  erning.set_defau
-0000fb80: 6c74 5f61 7070 6c69 6361 7469 6f6e 5f66  lt_application_f
-0000fb90: 696c 6528 7072 6f74 6f63 6f6c 5b22 6170  ile(protocol["ap
-0000fba0: 706c 6963 6174 696f 6e5f 6669 6c65 225d  plication_file"]
-0000fbb0: 290a 2020 2020 2020 2020 7365 6c66 2e63  ).        self.c
-0000fbc0: 6f6e 6e65 6374 696f 6e2e 7061 7474 6572  onnection.patter
-0000fbd0: 6e69 6e67 2e73 6574 5f64 6566 6175 6c74  ning.set_default
-0000fbe0: 5f62 6561 6d5f 7479 7065 2862 6561 6d74  _beam_type(beamt
-0000fbf0: 7970 655f 7661 6c75 6529 0a0a 2020 2020  ype_value)..    
-0000fc00: 2020 2020 6769 735f 6c69 6e65 203d 2070      gis_line = p
-0000fc10: 726f 746f 636f 6c5b 2267 6173 225d 0a20  rotocol["gas"]. 
-0000fc20: 2020 2020 2020 2070 6f72 7420 3d20 7365         port = se
-0000fc30: 6c66 2e67 6973 5f6c 696e 6573 5b67 6973  lf.gis_lines[gis
-0000fc40: 5f6c 696e 655d 0a20 2020 2020 2020 2069  _line].        i
-0000fc50: 6620 7365 6c66 2e47 4953 5f70 6f73 6974  f self.GIS_posit
-0000fc60: 696f 6e28 6769 735f 6c69 6e65 2920 3d3d  ion(gis_line) ==
-0000fc70: 2022 5265 7472 6163 7465 6422 3a0a 2020   "Retracted":.  
-0000fc80: 2020 2020 2020 2020 2020 706f 7274 2e69            port.i
-0000fc90: 6e73 6572 7428 290a 0a20 2020 2020 2020  nsert()..       
-0000fca0: 2069 6620 7365 6c66 2e47 4953 5f74 656d   if self.GIS_tem
-0000fcb0: 705f 7265 6164 7928 6769 735f 6c69 6e65  p_ready(gis_line
-0000fcc0: 2920 3d3d 2046 616c 7365 3a0a 2020 2020  ) == False:.    
-0000fcd0: 2020 2020 2020 2020 7365 6c66 2e47 4953          self.GIS
-0000fce0: 5f68 6561 745f 7570 2867 6973 5f6c 696e  _heat_up(gis_lin
-0000fcf0: 6529 0a0a 0a20 2020 2064 6566 2073 6574  e)...    def set
-0000fd00: 7570 5f47 4953 5f70 6174 7465 726e 2873  up_GIS_pattern(s
-0000fd10: 656c 662c 7072 6f74 6f63 6f6c 293a 0a0a  elf,protocol):..
-0000fd20: 2020 2020 2020 2020 6866 7720 3d20 7072          hfw = pr
-0000fd30: 6f74 6f63 6f6c 5b22 6866 7722 5d0a 2020  otocol["hfw"].  
-0000fd40: 2020 2020 2020 6c69 6e65 5f70 6174 7465        line_patte
-0000fd50: 726e 5f6c 656e 6774 6820 3d20 7072 6f74  rn_length = prot
-0000fd60: 6f63 6f6c 5b22 6c65 6e67 7468 225d 0a20  ocol["length"]. 
-0000fd70: 2020 2020 2020 2073 7075 7474 6572 5f74         sputter_t
-0000fd80: 696d 6520 3d20 7072 6f74 6f63 6f6c 5b22  ime = protocol["
-0000fd90: 7370 7574 7465 725f 7469 6d65 225d 0a0a  sputter_time"]..
-0000fda0: 2020 2020 2020 2020 7365 6c66 2e63 6f6e          self.con
-0000fdb0: 6e65 6374 696f 6e2e 6265 616d 732e 656c  nection.beams.el
-0000fdc0: 6563 7472 6f6e 5f62 6561 6d2e 686f 7269  ectron_beam.hori
-0000fdd0: 7a6f 6e74 616c 5f66 6965 6c64 5f77 6964  zontal_field_wid
-0000fde0: 7468 2e76 616c 7565 203d 2068 6677 0a20  th.value = hfw. 
-0000fdf0: 2020 2020 2020 2070 6174 7465 726e 203d         pattern =
-0000fe00: 2073 656c 662e 636f 6e6e 6563 7469 6f6e   self.connection
-0000fe10: 2e70 6174 7465 726e 696e 672e 6372 6561  .patterning.crea
-0000fe20: 7465 5f6c 696e 6528 0a20 2020 2020 2020  te_line(.       
-0000fe30: 2020 2020 202d 6c69 6e65 5f70 6174 7465       -line_patte
-0000fe40: 726e 5f6c 656e 6774 6820 2f20 322c 2020  rn_length / 2,  
-0000fe50: 2320 785f 7374 6172 740a 2020 2020 2020  # x_start.      
-0000fe60: 2020 2020 2020 2b6c 696e 655f 7061 7474        +line_patt
-0000fe70: 6572 6e5f 6c65 6e67 7468 2c20 2023 2079  ern_length,  # y
-0000fe80: 5f73 7461 7274 0a20 2020 2020 2020 2020  _start.         
-0000fe90: 2020 202b 6c69 6e65 5f70 6174 7465 726e     +line_pattern
-0000fea0: 5f6c 656e 6774 6820 2f20 322c 2020 2320  _length / 2,  # 
-0000feb0: 785f 656e 640a 2020 2020 2020 2020 2020  x_end.          
-0000fec0: 2020 2b6c 696e 655f 7061 7474 6572 6e5f    +line_pattern_
-0000fed0: 6c65 6e67 7468 2c20 2023 2079 5f65 6e64  length,  # y_end
-0000fee0: 0a20 2020 2020 2020 2020 2020 2032 652d  .            2e-
-0000fef0: 362c 0a20 2020 2020 2020 2029 2020 2320  6,.        )  # 
-0000ff00: 6d69 6c6c 696e 6720 6465 7074 680a 2020  milling depth.  
-0000ff10: 2020 2020 2020 7061 7474 6572 6e2e 7469        pattern.ti
-0000ff20: 6d65 203d 2073 7075 7474 6572 5f74 696d  me = sputter_tim
-0000ff30: 6520 0a0a 2020 2020 6465 6620 7275 6e5f  e ..    def run_
-0000ff40: 4749 5328 7365 6c66 2c70 726f 746f 636f  GIS(self,protoco
-0000ff50: 6c29 3a0a 0a20 2020 2020 2020 2067 6973  l):..        gis
-0000ff60: 5f6c 696e 6520 3d20 7072 6f74 6f63 6f6c  _line = protocol
-0000ff70: 5b22 6761 7322 5d0a 2020 2020 2020 2020  ["gas"].        
-0000ff80: 7370 7574 7465 725f 7469 6d65 203d 2070  sputter_time = p
-0000ff90: 726f 746f 636f 6c5b 2273 7075 7474 6572  rotocol["sputter
-0000ffa0: 5f74 696d 6522 5d0a 0a0a 2020 2020 2020  _time"]...      
-0000ffb0: 2020 7365 6c66 2e63 6f6e 6e65 6374 696f    self.connectio
-0000ffc0: 6e2e 6265 616d 732e 656c 6563 7472 6f6e  n.beams.electron
-0000ffd0: 5f62 6561 6d2e 626c 616e 6b28 290a 2020  _beam.blank().  
-0000ffe0: 2020 2020 2020 6966 2073 656c 662e 636f        if self.co
-0000fff0: 6e6e 6563 7469 6f6e 2e70 6174 7465 726e  nnection.pattern
-00010000: 696e 672e 7374 6174 6520 3d3d 2022 4964  ing.state == "Id
-00010010: 6c65 223a 0a20 2020 2020 2020 2020 2020  le":.           
-00010020: 206c 6f67 6769 6e67 2e69 6e66 6f28 6622   logging.info(f"
-00010030: 5370 7574 7465 7269 6e67 2077 6974 6820  Sputtering with 
-00010040: 7b67 6973 5f6c 696e 657d 2066 6f72 207b  {gis_line} for {
-00010050: 7370 7574 7465 725f 7469 6d65 7d20 7365  sputter_time} se
-00010060: 636f 6e64 732e 2e2e 2229 0a20 2020 2020  conds...").     
-00010070: 2020 2020 2020 2073 656c 662e 636f 6e6e         self.conn
-00010080: 6563 7469 6f6e 2e70 6174 7465 726e 696e  ection.patternin
-00010090: 672e 7374 6172 7428 2920 2023 2061 7379  g.start()  # asy
-000100a0: 6e63 6872 6f6e 6f75 7320 7061 7474 6572  nchronous patter
-000100b0: 6e69 6e67 0a20 2020 2020 2020 2020 2020  ning.           
-000100c0: 2074 696d 652e 736c 6565 7028 7370 7574   time.sleep(sput
-000100d0: 7465 725f 7469 6d65 202b 2035 290a 2020  ter_time + 5).  
-000100e0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-000100f0: 2020 2020 2020 2020 7261 6973 6520 5275          raise Ru
-00010100: 6e74 696d 6545 7272 6f72 2822 4361 6e27  ntimeError("Can'
-00010110: 7420 7370 7574 7465 722c 2070 6174 7465  t sputter, patte
-00010120: 726e 696e 6720 7374 6174 6520 6973 206e  rning state is n
-00010130: 6f74 2072 6561 6479 2e22 290a 2020 2020  ot ready.").    
-00010140: 2020 2020 6966 2073 656c 662e 636f 6e6e      if self.conn
-00010150: 6563 7469 6f6e 2e70 6174 7465 726e 696e  ection.patternin
-00010160: 672e 7374 6174 6520 3d3d 2022 5275 6e6e  g.state == "Runn
-00010170: 696e 6722 3a0a 2020 2020 2020 2020 2020  ing":.          
-00010180: 2020 7365 6c66 2e63 6f6e 6e65 6374 696f    self.connectio
-00010190: 6e2e 7061 7474 6572 6e69 6e67 2e73 746f  n.patterning.sto
-000101a0: 7028 290a 2020 2020 2020 2020 2020 2020  p().            
-000101b0: 6c6f 6767 696e 672e 696e 666f 2866 2246  logging.info(f"F
-000101c0: 696e 6973 6865 6420 7370 7574 7465 7269  inished sputteri
-000101d0: 6e67 2077 6974 6820 7b67 6973 5f6c 696e  ng with {gis_lin
-000101e0: 657d 2229 0a20 2020 2020 2020 2065 6c73  e}").        els
-000101f0: 653a 0a20 2020 2020 2020 2020 2020 206c  e:.            l
-00010200: 6f67 6769 6e67 2e77 6172 6e69 6e67 2866  ogging.warning(f
-00010210: 2250 6174 7465 726e 696e 6720 7374 6174  "Patterning stat
-00010220: 6520 6973 207b 7365 6c66 2e63 6f6e 6e65  e is {self.conne
-00010230: 6374 696f 6e2e 7061 7474 6572 6e69 6e67  ction.patterning
-00010240: 2e73 7461 7465 7d22 290a 2020 2020 2020  .state}").      
-00010250: 2020 2020 2020 6c6f 6767 696e 672e 7761        logging.wa
-00010260: 726e 696e 6728 2243 6f6e 7369 6465 7220  rning("Consider 
-00010270: 6164 6a75 7374 696e 6720 7468 6520 7061  adjusting the pa
-00010280: 7474 6572 6e69 6e67 206c 696e 6520 6465  tterning line de
-00010290: 7074 682e 2229 0a0a 0a20 2020 2064 6566  pth.")...    def
-000102a0: 2072 756e 5f4d 756c 7469 6368 656d 2873   run_Multichem(s
-000102b0: 656c 662c 7072 6f74 6f63 6f6c 293a 0a0a  elf,protocol):..
-000102c0: 2020 2020 2020 2020 5f63 6865 636b 5f73          _check_s
-000102d0: 7075 7474 6572 2873 656c 662e 6861 7264  putter(self.hard
-000102e0: 7761 7265 5f73 6574 7469 6e67 7329 0a20  ware_settings). 
-000102f0: 2020 2020 2020 2073 656c 662e 6f72 6967         self.orig
-00010300: 696e 616c 5f61 6374 6976 655f 7669 6577  inal_active_view
-00010310: 203d 2073 656c 662e 636f 6e6e 6563 7469   = self.connecti
-00010320: 6f6e 2e69 6d61 6769 6e67 2e67 6574 5f61  on.imaging.get_a
-00010330: 6374 6976 655f 7669 6577 2829 0a20 2020  ctive_view().   
-00010340: 2020 2020 2073 656c 662e 636f 6e6e 6563       self.connec
-00010350: 7469 6f6e 2e69 6d61 6769 6e67 2e73 6574  tion.imaging.set
-00010360: 5f61 6374 6976 655f 7669 6577 2842 6561  _active_view(Bea
-00010370: 6d54 7970 652e 454c 4543 5452 4f4e 2e76  mType.ELECTRON.v
-00010380: 616c 7565 290a 2020 2020 2020 2020 7365  alue).        se
-00010390: 6c66 2e63 6f6e 6e65 6374 696f 6e2e 7061  lf.connection.pa
-000103a0: 7474 6572 6e69 6e67 2e63 6c65 6172 5f70  tterning.clear_p
-000103b0: 6174 7465 726e 7328 290a 2020 2020 2020  atterns().      
-000103c0: 2020 7365 6c66 2e63 6f6e 6e65 6374 696f    self.connectio
-000103d0: 6e2e 7061 7474 6572 6e69 6e67 2e73 6574  n.patterning.set
-000103e0: 5f64 6566 6175 6c74 5f61 7070 6c69 6361  _default_applica
-000103f0: 7469 6f6e 5f66 696c 6528 7072 6f74 6f63  tion_file(protoc
-00010400: 6f6c 5b22 6170 706c 6963 6174 696f 6e5f  ol["application_
-00010410: 6669 6c65 225d 290a 2020 2020 2020 2020  file"]).        
-00010420: 7365 6c66 2e63 6f6e 6e65 6374 696f 6e2e  self.connection.
-00010430: 7061 7474 6572 6e69 6e67 2e73 6574 5f64  patterning.set_d
-00010440: 6566 6175 6c74 5f62 6561 6d5f 7479 7065  efault_beam_type
-00010450: 2842 6561 6d54 7970 652e 454c 4543 5452  (BeamType.ELECTR
-00010460: 4f4e 2e76 616c 7565 290a 0a20 2020 2020  ON.value)..     
-00010470: 2020 206d 635f 6c69 6e65 203d 2070 726f     mc_line = pro
-00010480: 746f 636f 6c5b 2267 6173 225d 0a20 2020  tocol["gas"].   
-00010490: 2020 2020 2070 6f72 7420 3d20 7365 6c66       port = self
-000104a0: 2e6d 756c 7469 6368 656d 0a20 2020 2020  .multichem.     
-000104b0: 2020 2069 6620 7365 6c66 2e6d 756c 7469     if self.multi
-000104c0: 6368 656d 5f70 6f73 6974 696f 6e28 2920  chem_position() 
-000104d0: 3d3d 2022 5265 7472 6163 7465 6422 3a0a  == "Retracted":.
-000104e0: 2020 2020 2020 2020 2020 2020 706f 7274              port
-000104f0: 2e69 6e73 6572 7428 290a 0a20 2020 2020  .insert()..     
-00010500: 2020 2069 6620 7365 6c66 2e6d 756c 7469     if self.multi
-00010510: 6368 656d 5f74 656d 705f 7265 6164 7928  chem_temp_ready(
-00010520: 6d63 5f6c 696e 6529 203d 3d20 4661 6c73  mc_line) == Fals
-00010530: 653a 0a20 2020 2020 2020 2020 2020 2073  e:.            s
-00010540: 656c 662e 6d75 6c74 6963 6865 6d5f 6865  elf.multichem_he
-00010550: 6174 5f75 7028 6d63 5f6c 696e 6529 0a0a  at_up(mc_line)..
-00010560: 2020 2020 2020 2020 6866 7720 3d20 7072          hfw = pr
-00010570: 6f74 6f63 6f6c 5b22 6866 7722 5d0a 2020  otocol["hfw"].  
-00010580: 2020 2020 2020 6c69 6e65 5f70 6174 7465        line_patte
-00010590: 726e 5f6c 656e 6774 6820 3d20 7072 6f74  rn_length = prot
-000105a0: 6f63 6f6c 5b22 6c65 6e67 7468 225d 0a20  ocol["length"]. 
-000105b0: 2020 2020 2020 2073 7075 7474 6572 5f74         sputter_t
-000105c0: 696d 6520 3d20 7072 6f74 6f63 6f6c 5b22  ime = protocol["
-000105d0: 7370 7574 7465 725f 7469 6d65 225d 0a0a  sputter_time"]..
-000105e0: 2020 2020 2020 2020 7365 6c66 2e63 6f6e          self.con
-000105f0: 6e65 6374 696f 6e2e 6265 616d 732e 656c  nection.beams.el
-00010600: 6563 7472 6f6e 5f62 6561 6d2e 686f 7269  ectron_beam.hori
-00010610: 7a6f 6e74 616c 5f66 6965 6c64 5f77 6964  zontal_field_wid
-00010620: 7468 2e76 616c 7565 203d 2068 6677 0a20  th.value = hfw. 
-00010630: 2020 2020 2020 2070 6174 7465 726e 203d         pattern =
-00010640: 2073 656c 662e 636f 6e6e 6563 7469 6f6e   self.connection
-00010650: 2e70 6174 7465 726e 696e 672e 6372 6561  .patterning.crea
-00010660: 7465 5f6c 696e 6528 0a20 2020 2020 2020  te_line(.       
-00010670: 2020 2020 202d 6c69 6e65 5f70 6174 7465       -line_patte
-00010680: 726e 5f6c 656e 6774 6820 2f20 322c 2020  rn_length / 2,  
-00010690: 2320 785f 7374 6172 740a 2020 2020 2020  # x_start.      
-000106a0: 2020 2020 2020 2b6c 696e 655f 7061 7474        +line_patt
-000106b0: 6572 6e5f 6c65 6e67 7468 2c20 2023 2079  ern_length,  # y
-000106c0: 5f73 7461 7274 0a20 2020 2020 2020 2020  _start.         
-000106d0: 2020 202b 6c69 6e65 5f70 6174 7465 726e     +line_pattern
-000106e0: 5f6c 656e 6774 6820 2f20 322c 2020 2320  _length / 2,  # 
-000106f0: 785f 656e 640a 2020 2020 2020 2020 2020  x_end.          
-00010700: 2020 2b6c 696e 655f 7061 7474 6572 6e5f    +line_pattern_
-00010710: 6c65 6e67 7468 2c20 2023 2079 5f65 6e64  length,  # y_end
-00010720: 0a20 2020 2020 2020 2020 2020 2032 652d  .            2e-
-00010730: 362c 0a20 2020 2020 2020 2029 2020 2320  6,.        )  # 
-00010740: 6d69 6c6c 696e 6720 6465 7074 680a 2020  milling depth.  
-00010750: 2020 2020 2020 2320 7061 7474 6572 6e2e        # pattern.
-00010760: 7469 6d65 203d 2073 7075 7474 6572 5f74  time = sputter_t
-00010770: 696d 6520 2b20 302e 310a 2020 2020 2020  ime + 0.1.      
-00010780: 2020 7061 7474 6572 6e2e 7469 6d65 203d    pattern.time =
-00010790: 2073 7075 7474 6572 5f74 696d 650a 0a20   sputter_time.. 
-000107a0: 2020 2020 2020 2073 656c 662e 636f 6e6e         self.conn
-000107b0: 6563 7469 6f6e 2e62 6561 6d73 2e65 6c65  ection.beams.ele
-000107c0: 6374 726f 6e5f 6265 616d 2e62 6c61 6e6b  ctron_beam.blank
-000107d0: 2829 0a20 2020 2020 2020 2023 2070 6f72  ().        # por
-000107e0: 742e 6c69 6e65 2e6f 7065 6e28 290a 2020  t.line.open().  
-000107f0: 2020 2020 2020 6966 2073 656c 662e 636f        if self.co
-00010800: 6e6e 6563 7469 6f6e 2e70 6174 7465 726e  nnection.pattern
-00010810: 696e 672e 7374 6174 6520 3d3d 2022 4964  ing.state == "Id
-00010820: 6c65 223a 0a20 2020 2020 2020 2020 2020  le":.           
-00010830: 206c 6f67 6769 6e67 2e69 6e66 6f28 6622   logging.info(f"
-00010840: 5370 7574 7465 7269 6e67 2077 6974 6820  Sputtering with 
-00010850: 7b6d 635f 6c69 6e65 7d20 666f 7220 7b73  {mc_line} for {s
-00010860: 7075 7474 6572 5f74 696d 657d 2073 6563  putter_time} sec
-00010870: 6f6e 6473 2e2e 2e22 290a 2020 2020 2020  onds...").      
-00010880: 2020 2020 2020 7365 6c66 2e63 6f6e 6e65        self.conne
-00010890: 6374 696f 6e2e 7061 7474 6572 6e69 6e67  ction.patterning
-000108a0: 2e73 7461 7274 2829 2020 2320 6173 796e  .start()  # asyn
-000108b0: 6368 726f 6e6f 7573 2070 6174 7465 726e  chronous pattern
-000108c0: 696e 670a 2020 2020 2020 2020 2020 2020  ing.            
-000108d0: 7469 6d65 2e73 6c65 6570 2873 7075 7474  time.sleep(sputt
-000108e0: 6572 5f74 696d 6520 2b20 3529 0a20 2020  er_time + 5).   
-000108f0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00010900: 2020 2020 2020 2072 6169 7365 2052 756e         raise Run
-00010910: 7469 6d65 4572 726f 7228 2243 616e 2774  timeError("Can't
-00010920: 2073 7075 7474 6572 2070 6c61 7469 6e75   sputter platinu
-00010930: 6d2c 2070 6174 7465 726e 696e 6720 7374  m, patterning st
-00010940: 6174 6520 6973 206e 6f74 2072 6561 6479  ate is not ready
-00010950: 2e22 290a 2020 2020 2020 2020 6966 2073  .").        if s
-00010960: 656c 662e 636f 6e6e 6563 7469 6f6e 2e70  elf.connection.p
-00010970: 6174 7465 726e 696e 672e 7374 6174 6520  atterning.state 
-00010980: 3d3d 2022 5275 6e6e 696e 6722 3a0a 2020  == "Running":.  
-00010990: 2020 2020 2020 2020 2020 7365 6c66 2e63            self.c
-000109a0: 6f6e 6e65 6374 696f 6e2e 7061 7474 6572  onnection.patter
-000109b0: 6e69 6e67 2e73 746f 7028 290a 2020 2020  ning.stop().    
-000109c0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-000109d0: 2020 2020 2020 6c6f 6767 696e 672e 7761        logging.wa
-000109e0: 726e 696e 6728 6622 5061 7474 6572 6e69  rning(f"Patterni
-000109f0: 6e67 2073 7461 7465 2069 7320 7b73 656c  ng state is {sel
-00010a00: 662e 636f 6e6e 6563 7469 6f6e 2e70 6174  f.connection.pat
-00010a10: 7465 726e 696e 672e 7374 6174 657d 2229  terning.state}")
-00010a20: 0a20 2020 2020 2020 2020 2020 206c 6f67  .            log
-00010a30: 6769 6e67 2e77 6172 6e69 6e67 2822 436f  ging.warning("Co
-00010a40: 6e73 6964 6572 2061 646a 7573 7469 6e67  nsider adjusting
-00010a50: 2074 6865 2070 6174 7465 726e 696e 6720   the patterning 
-00010a60: 6c69 6e65 2064 6570 7468 2e22 290a 2020  line depth.").  
-00010a70: 2020 2020 2020 2320 706f 7274 2e6c 696e        # port.lin
-00010a80: 652e 636c 6f73 6528 290a 0a20 2020 2020  e.close()..     
-00010a90: 2020 2073 656c 662e 6d75 6c74 6963 6865     self.multiche
-00010aa0: 6d2e 6c69 6e65 2e74 7572 6e5f 6865 6174  m.line.turn_heat
-00010ab0: 6572 5f6f 6666 286d 635f 6c69 6e65 290a  er_off(mc_line).
-00010ac0: 0a0a 0a0a 0a20 2020 2064 6566 2047 4953  .....    def GIS
-00010ad0: 5f61 7661 696c 6162 6c65 5f6c 696e 6573  _available_lines
-00010ae0: 2873 656c 6629 202d 3e20 6c69 7374 5b73  (self) -> list[s
-00010af0: 7472 5d3a 0a20 2020 2020 2020 2022 2222  tr]:.        """
-00010b00: 0a20 2020 2020 2020 2052 6574 7572 6e73  .        Returns
-00010b10: 2061 206c 6973 7420 6f66 2061 7661 696c   a list of avail
-00010b20: 6162 6c65 2047 4953 206c 696e 6573 2e0a  able GIS lines..
-00010b30: 2020 2020 2020 2020 4172 6773 3a0a 2020          Args:.  
-00010b40: 2020 2020 2020 2020 2020 4e6f 6e65 0a20            None. 
-00010b50: 2020 2020 2020 2052 6574 7572 6e73 3a0a         Returns:.
-00010b60: 2020 2020 2020 2020 2020 2020 4469 6374              Dict
-00010b70: 696f 6e61 7279 206f 6620 6176 6169 6c61  ionary of availa
-00010b80: 626c 6520 4749 5320 6c69 6e65 732e 0a20  ble GIS lines.. 
-00010b90: 2020 2020 2020 204e 6f74 6573 3a0a 2020         Notes:.  
-00010ba0: 2020 2020 2020 2020 2020 4e6f 6e65 0a20            None. 
-00010bb0: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-00010bc0: 2020 205f 6368 6563 6b5f 7370 7574 7465     _check_sputte
-00010bd0: 7228 7365 6c66 2e68 6172 6477 6172 655f  r(self.hardware_
-00010be0: 7365 7474 696e 6773 290a 0a20 2020 2020  settings)..     
-00010bf0: 2020 2067 6973 5f6c 6973 7420 3d20 7365     gis_list = se
-00010c00: 6c66 2e63 6f6e 6e65 6374 696f 6e2e 6761  lf.connection.ga
-00010c10: 732e 6c69 7374 5f61 6c6c 5f67 6973 5f70  s.list_all_gis_p
-00010c20: 6f72 7473 2829 0a0a 2020 2020 2020 2020  orts()..        
-00010c30: 7365 6c66 2e67 6973 5f6c 696e 6573 203d  self.gis_lines =
-00010c40: 207b 7d0a 0a0a 2020 2020 2020 2020 666f   {}...        fo
-00010c50: 7220 6c69 6e65 2069 6e20 6769 735f 6c69  r line in gis_li
-00010c60: 7374 3a0a 0a20 2020 2020 2020 2020 2020  st:..           
-00010c70: 2067 6973 5f70 6f72 7420 3d20 5468 6572   gis_port = Ther
-00010c80: 6d6f 4749 534c 696e 6528 7365 6c66 2e63  moGISLine(self.c
-00010c90: 6f6e 6e65 6374 696f 6e2e 6761 732e 6765  onnection.gas.ge
-00010ca0: 745f 6769 735f 706f 7274 286c 696e 6529  t_gis_port(line)
-00010cb0: 2c6e 616d 653d 6c69 6e65 2c73 7461 7475  ,name=line,statu
-00010cc0: 733d 2252 6574 7261 6374 6564 2229 0a0a  s="Retracted")..
-00010cd0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00010ce0: 2e67 6973 5f6c 696e 6573 5b6c 696e 655d  .gis_lines[line]
-00010cf0: 203d 2067 6973 5f70 6f72 740a 0a0a 0a20   = gis_port.... 
-00010d00: 2020 2020 2020 2072 6574 7572 6e20 6769         return gi
-00010d10: 735f 6c69 7374 0a0a 2020 2020 6465 6620  s_list..    def 
-00010d20: 4749 535f 6176 6169 6c61 626c 655f 706f  GIS_available_po
-00010d30: 7369 7469 6f6e 7328 7365 6c66 2920 2d3e  sitions(self) ->
-00010d40: 206c 6973 745b 7374 725d 3a0a 2020 2020   list[str]:.    
-00010d50: 2020 2020 2222 2252 6574 7572 6e73 2061      """Returns a
-00010d60: 206c 6973 7420 6f66 2061 7661 696c 6162   list of availab
-00010d70: 6c65 2070 6f73 6974 696f 6e73 2074 6865  le positions the
-00010d80: 2047 4953 2063 616e 206d 6f76 6520 746f   GIS can move to
-00010d90: 2e0a 2020 2020 2020 2020 5265 7475 726e  ..        Return
-00010da0: 733a 0a20 2020 2020 2020 2020 2020 206c  s:.            l
-00010db0: 6973 745b 7374 725d 3a20 706f 7369 7469  ist[str]: positi
-00010dc0: 6f6e 730a 2020 2020 2020 2020 2222 220a  ons.        """.
-00010dd0: 0a20 2020 2020 2020 205f 6368 6563 6b5f  .        _check_
-00010de0: 7370 7574 7465 7228 7365 6c66 2e68 6172  sputter(self.har
-00010df0: 6477 6172 655f 7365 7474 696e 6773 290a  dware_settings).
-00010e00: 0a20 2020 2020 2020 2070 6f73 6974 696f  .        positio
-00010e10: 6e73 203d 205b 2249 6e73 6572 7422 2c20  ns = ["Insert", 
-00010e20: 2252 6574 7261 6374 225d 0a0a 2020 2020  "Retract"]..    
-00010e30: 2020 2020 7265 7475 726e 2070 6f73 6974      return posit
-00010e40: 696f 6e73 0a0a 2020 2020 6465 6620 4749  ions..    def GI
-00010e50: 535f 6d6f 7665 5f74 6f28 7365 6c66 2c6c  S_move_to(self,l
-00010e60: 696e 655f 6e61 6d65 3a73 7472 2c70 6f73  ine_name:str,pos
-00010e70: 6974 696f 6e3a 7374 7229 202d 3e20 4e6f  ition:str) -> No
-00010e80: 6e65 3a0a 0a20 2020 2020 2020 2022 2222  ne:..        """
-00010e90: 4d6f 7665 7320 7468 6520 4749 5320 746f  Moves the GIS to
-00010ea0: 2061 2073 7065 6369 6669 6564 2070 6f73   a specified pos
-00010eb0: 6974 696f 6e2e 0a20 2020 2020 2020 204e  ition..        N
-00010ec0: 6565 6420 746f 2073 7065 6369 6679 2074  eed to specify t
-00010ed0: 6865 206c 696e 6520 6e61 6d65 2061 6e64  he line name and
-00010ee0: 2070 6f73 6974 696f 6e20 746f 206d 6f76   position to mov
-00010ef0: 6520 746f 2e20 4561 6368 2047 4953 206c  e to. Each GIS l
-00010f00: 696e 6520 6973 2061 2073 6570 6572 6174  ine is a seperat
-00010f10: 6520 7079 7468 6f6e 206f 626a 6563 740a  e python object.
-00010f20: 2020 2020 2020 2020 2222 220a 0a20 2020          """..   
-00010f30: 2020 2020 205f 6368 6563 6b5f 7370 7574       _check_sput
-00010f40: 7465 7228 7365 6c66 2e68 6172 6477 6172  ter(self.hardwar
-00010f50: 655f 7365 7474 696e 6773 290a 0a20 2020  e_settings)..   
-00010f60: 2020 2020 2070 6f72 7420 3d20 7365 6c66       port = self
-00010f70: 2e67 6973 5f6c 696e 6573 5b6c 696e 655f  .gis_lines[line_
-00010f80: 6e61 6d65 5d0a 0a20 2020 2020 2020 2069  name]..        i
-00010f90: 6620 706f 7369 7469 6f6e 203d 3d20 2249  f position == "I
-00010fa0: 6e73 6572 7422 3a0a 2020 2020 2020 2020  nsert":.        
-00010fb0: 2020 2020 706f 7274 2e69 6e73 6572 7428      port.insert(
-00010fc0: 290a 2020 2020 2020 2020 656c 6966 2070  ).        elif p
-00010fd0: 6f73 6974 696f 6e20 3d3d 2022 5265 7472  osition == "Retr
-00010fe0: 6163 7422 3a0a 2020 2020 2020 2020 2020  act":.          
-00010ff0: 2020 706f 7274 2e72 6574 7261 6374 2829    port.retract()
-00011000: 0a0a 2020 2020 6465 6620 4749 535f 706f  ..    def GIS_po
-00011010: 7369 7469 6f6e 2873 656c 662c 6c69 6e65  sition(self,line
-00011020: 2920 2d3e 2073 7472 3a0a 2020 2020 2020  ) -> str:.      
-00011030: 2020 2222 220a 2020 2020 2020 2020 5265    """.        Re
-00011040: 7475 726e 7320 7468 6520 6375 7272 656e  turns the curren
-00011050: 7420 706f 7369 7469 6f6e 206f 6620 7468  t position of th
-00011060: 6520 4749 5320 6c69 6e65 2e0a 2020 2020  e GIS line..    
-00011070: 2020 2020 2222 220a 0a20 2020 2020 2020      """..       
-00011080: 205f 6368 6563 6b5f 7370 7574 7465 7228   _check_sputter(
-00011090: 7365 6c66 2e68 6172 6477 6172 655f 7365  self.hardware_se
-000110a0: 7474 696e 6773 290a 0a20 2020 2020 2020  ttings)..       
-000110b0: 2070 6f72 7420 3d20 7365 6c66 2e67 6973   port = self.gis
-000110c0: 5f6c 696e 6573 5b6c 696e 655d 0a0a 2020  _lines[line]..  
-000110d0: 2020 2020 2020 7265 7475 726e 2070 6f72        return por
-000110e0: 742e 7374 6174 7573 0a0a 2020 2020 6465  t.status..    de
-000110f0: 6620 4749 535f 6865 6174 5f75 7028 7365  f GIS_heat_up(se
-00011100: 6c66 2c6c 696e 6529 3a0a 0a20 2020 2020  lf,line):..     
-00011110: 2020 2022 2222 4865 6174 7320 7570 2074     """Heats up t
-00011120: 6865 2073 7065 6369 6669 6564 2047 4953  he specified GIS
-00011130: 206c 696e 650a 2020 2020 2020 2020 446f   line.        Do
-00011140: 6573 2074 6869 7320 6279 2074 7572 6e69  es this by turni
-00011150: 6e67 2074 6865 2068 6561 7465 7220 6f6e  ng the heater on
-00011160: 2066 6f72 2033 2073 6563 6f6e 6473 2061   for 3 seconds a
-00011170: 6e64 2074 6865 6e20 6f66 662e 0a20 2020  nd then off..   
-00011180: 2020 2020 2049 6620 7468 6973 2070 726f       If this pro
-00011190: 6365 6475 7265 2068 6173 2062 6565 6e20  cedure has been 
-000111a0: 646f 6e65 206f 6e63 652c 2069 7420 6973  done once, it is
-000111b0: 2063 6f6e 7369 6465 7265 6420 7465 6d70   considered temp
-000111c0: 5f72 6561 6479 0a20 2020 2020 2020 2022  _ready.        "
-000111d0: 2222 0a0a 2020 2020 2020 2020 5f63 6865  ""..        _che
-000111e0: 636b 5f73 7075 7474 6572 2873 656c 662e  ck_sputter(self.
-000111f0: 6861 7264 7761 7265 5f73 6574 7469 6e67  hardware_setting
-00011200: 7329 0a0a 2020 2020 2020 2020 706f 7274  s)..        port
-00011210: 203d 2073 656c 662e 6769 735f 6c69 6e65   = self.gis_line
-00011220: 735b 6c69 6e65 5d0a 0a20 2020 2020 2020  s[line]..       
-00011230: 2070 6f72 742e 6c69 6e65 2e74 7572 6e5f   port.line.turn_
-00011240: 6865 6174 6572 5f6f 6e28 290a 0a20 2020  heater_on()..   
-00011250: 2020 2020 2074 696d 652e 736c 6565 7028       time.sleep(
-00011260: 3329 0a0a 2020 2020 2020 2020 706f 7274  3)..        port
-00011270: 2e6c 696e 652e 7475 726e 5f68 6561 7465  .line.turn_heate
-00011280: 725f 6f66 6628 290a 0a20 2020 2020 2020  r_off()..       
-00011290: 2070 6f72 742e 7465 6d70 5f72 6561 6479   port.temp_ready
-000112a0: 203d 2054 7275 650a 0a20 2020 2064 6566   = True..    def
-000112b0: 2047 4953 5f74 656d 705f 7265 6164 7928   GIS_temp_ready(
-000112c0: 7365 6c66 2c6c 696e 6529 202d 3e20 626f  self,line) -> bo
-000112d0: 6f6c 3a0a 0a20 2020 2020 2020 2022 2222  ol:..        """
-000112e0: 5265 7475 726e 7320 6966 2074 6865 2068  Returns if the h
-000112f0: 6561 7420 7570 2070 726f 6365 6475 7265  eat up procedure
-00011300: 2068 6173 2062 6565 6e20 646f 6e65 2e20   has been done. 
-00011310: 496e 7465 726e 616c 2066 756e 6374 696f  Internal functio
-00011320: 6e2c 206e 6f74 2070 6f6c 6c65 6420 696e  n, not polled in
-00011330: 666f 726d 6174 696f 6e0a 2020 2020 2020  formation.      
-00011340: 2020 2020 2020 6672 6f6d 2074 6865 2068        from the h
-00011350: 6172 6477 6172 650a 2020 2020 2020 2020  ardware.        
-00011360: 5265 7475 726e 733a 0a20 2020 2020 2020  Returns:.       
-00011370: 2020 2020 2054 7275 6520 6966 2074 6865       True if the
-00011380: 2068 6561 7420 7570 2070 726f 6365 6475   heat up procedu
-00011390: 7265 2068 6173 2062 6565 6e20 646f 6e65  re has been done
-000113a0: 2c20 4661 6c73 6520 6966 206e 6f74 0a20  , False if not. 
-000113b0: 2020 2020 2020 2022 2222 0a0a 2020 2020         """..    
-000113c0: 2020 2020 5f63 6865 636b 5f73 7075 7474      _check_sputt
-000113d0: 6572 2873 656c 662e 6861 7264 7761 7265  er(self.hardware
-000113e0: 5f73 6574 7469 6e67 7329 0a0a 2020 2020  _settings)..    
-000113f0: 2020 2020 706f 7274 203d 2073 656c 662e      port = self.
-00011400: 6769 735f 6c69 6e65 735b 6c69 6e65 5d0a  gis_lines[line].
-00011410: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00011420: 706f 7274 2e74 656d 705f 7265 6164 790a  port.temp_ready.
-00011430: 0a0a 2020 2020 6465 6620 6d75 6c74 6963  ..    def multic
-00011440: 6865 6d5f 6176 6169 6c61 626c 655f 6c69  hem_available_li
-00011450: 6e65 7328 7365 6c66 292d 3e20 6c69 7374  nes(self)-> list
-00011460: 5b73 7472 5d3a 0a0a 2020 2020 2020 2020  [str]:..        
-00011470: 2222 220a 2020 2020 2020 2020 5265 7475  """.        Retu
-00011480: 726e 7320 6120 6c69 7374 206f 6620 6176  rns a list of av
-00011490: 6169 6c61 626c 6520 6d75 6c74 6963 6865  ailable multiche
-000114a0: 6d20 6c69 6e65 732e 0a20 2020 2020 2020  m lines..       
-000114b0: 204c 6973 7420 6973 2061 2073 7472 206f   List is a str o
-000114c0: 6620 6e61 6d65 7320 6f66 2074 6865 206c  f names of the l
-000114d0: 696e 6573 2222 220a 0a20 2020 2020 2020  ines"""..       
-000114e0: 205f 6368 6563 6b5f 7370 7574 7465 7228   _check_sputter(
-000114f0: 7365 6c66 2e68 6172 6477 6172 655f 7365  self.hardware_se
-00011500: 7474 696e 6773 290a 0a20 2020 2020 2020  ttings)..       
-00011510: 2073 656c 662e 6d75 6c74 6963 6865 6d20   self.multichem 
-00011520: 3d20 5468 6572 6d6f 4d75 6c74 6943 6865  = ThermoMultiChe
-00011530: 6d4c 696e 6528 7365 6c66 2e63 6f6e 6e65  mLine(self.conne
-00011540: 6374 696f 6e2e 6761 732e 6765 745f 6d75  ction.gas.get_mu
-00011550: 6c74 6963 6865 6d28 2929 0a0a 2020 2020  ltichem())..    
-00011560: 2020 2020 7365 6c66 2e6d 635f 6c69 6e65      self.mc_line
-00011570: 7320 3d20 7365 6c66 2e6d 756c 7469 6368  s = self.multich
-00011580: 656d 2e6c 696e 652e 6c69 7374 5f61 6c6c  em.line.list_all
-00011590: 5f67 6173 6573 2829 0a0a 2020 2020 2020  _gases()..      
-000115a0: 2020 7365 6c66 2e6d 635f 6c69 6e65 735f    self.mc_lines_
-000115b0: 7465 6d70 203d 7b7d 0a0a 2020 2020 2020  temp ={}..      
-000115c0: 2020 666f 7220 6c69 6e65 2069 6e20 7365    for line in se
-000115d0: 6c66 2e6d 635f 6c69 6e65 733a 0a0a 2020  lf.mc_lines:..  
-000115e0: 2020 2020 2020 2020 2020 7365 6c66 2e6d            self.m
-000115f0: 635f 6c69 6e65 735f 7465 6d70 5b6c 696e  c_lines_temp[lin
-00011600: 655d 203d 2046 616c 7365 0a0a 2020 2020  e] = False..    
-00011610: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
-00011620: 6d63 5f6c 696e 6573 0a0a 2020 2020 6465  mc_lines..    de
-00011630: 6620 6d75 6c74 6963 6865 6d5f 6176 6169  f multichem_avai
-00011640: 6c61 626c 655f 706f 7369 7469 6f6e 7328  lable_positions(
-00011650: 7365 6c66 2920 2d3e 206c 6973 745b 7374  self) -> list[st
-00011660: 725d 3a0a 0a20 2020 2020 2020 2022 2222  r]:..        """
-00011670: 4176 6169 6c61 626c 6520 706f 7369 7469  Available positi
-00011680: 6f6e 7320 7468 6520 6d75 6c74 6963 6865  ons the multiche
-00011690: 6d20 6f62 6a65 6374 2063 616e 206d 6f76  m object can mov
-000116a0: 6520 746f 0a20 2020 2020 2020 2052 6574  e to.        Ret
-000116b0: 7572 6e73 3a0a 2020 2020 2020 2020 2020  urns:.          
-000116c0: 2020 5f74 7970 655f 3a20 6c69 7374 206f    _type_: list o
-000116d0: 6620 7374 7220 6f66 2070 6f73 6974 696f  f str of positio
-000116e0: 6e20 6e61 6d65 730a 2020 2020 2020 2020  n names.        
-000116f0: 2222 220a 0a20 2020 2020 2020 205f 6368  """..        _ch
-00011700: 6563 6b5f 7370 7574 7465 7228 7365 6c66  eck_sputter(self
-00011710: 2e68 6172 6477 6172 655f 7365 7474 696e  .hardware_settin
-00011720: 6773 290a 0a20 2020 2020 2020 2070 6f73  gs)..        pos
-00011730: 6974 696f 6e73 5f65 6e75 6d20 3d20 7365  itions_enum = se
-00011740: 6c66 2e6d 756c 7469 6368 656d 2e70 6f73  lf.multichem.pos
-00011750: 6974 696f 6e73 0a0a 2020 2020 2020 2020  itions..        
-00011760: 7265 7475 726e 2070 6f73 6974 696f 6e73  return positions
-00011770: 5f65 6e75 6d0a 0a20 2020 2064 6566 206d  _enum..    def m
-00011780: 756c 7469 6368 656d 5f6d 6f76 655f 746f  ultichem_move_to
-00011790: 2873 656c 662c 706f 7369 7469 6f6e 3a73  (self,position:s
-000117a0: 7472 293a 0a0a 2020 2020 2020 2020 2222  tr):..        ""
-000117b0: 220a 2020 2020 2020 2020 4d6f 7665 7320  ".        Moves 
-000117c0: 7468 6520 6d75 6c74 6963 6865 6d20 6f62  the multichem ob
-000117d0: 6a65 6374 2074 6f20 6120 7370 6563 6966  ject to a specif
-000117e0: 6965 6420 706f 7369 7469 6f6e 2e0a 2020  ied position..  
-000117f0: 2020 2020 2020 2222 220a 0a20 2020 2020        """..     
-00011800: 2020 205f 6368 6563 6b5f 7370 7574 7465     _check_sputte
-00011810: 7228 7365 6c66 2e68 6172 6477 6172 655f  r(self.hardware_
-00011820: 7365 7474 696e 6773 290a 0a20 2020 2020  settings)..     
-00011830: 2020 2069 6620 706f 7369 7469 6f6e 203d     if position =
-00011840: 3d20 2252 6574 7261 6374 223a 0a20 2020  = "Retract":.   
-00011850: 2020 2020 2020 2020 2073 656c 662e 6d75           self.mu
-00011860: 6c74 6963 6865 6d2e 7265 7472 6163 7428  ltichem.retract(
-00011870: 290a 2020 2020 2020 2020 656c 7365 3a0a  ).        else:.
-00011880: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00011890: 2e6d 756c 7469 6368 656d 2e69 6e73 6572  .multichem.inser
-000118a0: 7428 706f 7369 7469 6f6e 3d70 6f73 6974  t(position=posit
-000118b0: 696f 6e29 0a0a 0a20 2020 2064 6566 206d  ion)...    def m
-000118c0: 756c 7469 6368 656d 5f70 6f73 6974 696f  ultichem_positio
-000118d0: 6e28 7365 6c66 2920 2d3e 2073 7472 3a0a  n(self) -> str:.
-000118e0: 0a20 2020 2020 2020 2022 2222 4375 7272  .        """Curr
-000118f0: 656e 7420 706f 7369 7469 6f6e 206f 6620  ent position of 
-00011900: 7468 6520 6d75 6c74 6963 6865 6d20 6f62  the multichem ob
-00011910: 6a65 6374 0a20 2020 2020 2020 2052 6574  ject.        Ret
-00011920: 7572 6e73 3a0a 2020 2020 2020 2020 2020  urns:.          
-00011930: 2020 5f74 7970 655f 3a20 7374 7220 6e61    _type_: str na
-00011940: 6d65 206f 6620 7468 6520 6375 7272 656e  me of the curren
-00011950: 7420 706f 7369 7469 6f6e 0a20 2020 2020  t position.     
-00011960: 2020 2022 2222 0a0a 2020 2020 2020 2020     """..        
-00011970: 5f63 6865 636b 5f73 7075 7474 6572 2873  _check_sputter(s
-00011980: 656c 662e 6861 7264 7761 7265 5f73 6574  elf.hardware_set
-00011990: 7469 6e67 7329 0a0a 2020 2020 2020 2020  tings)..        
-000119a0: 7265 7475 726e 2073 656c 662e 6d75 6c74  return self.mult
-000119b0: 6963 6865 6d2e 6375 7272 656e 745f 706f  ichem.current_po
-000119c0: 7369 7469 6f6e 0a0a 2020 2020 6465 6620  sition..    def 
-000119d0: 6d75 6c74 6963 6865 6d5f 6865 6174 5f75  multichem_heat_u
-000119e0: 7028 7365 6c66 2c6c 696e 653a 7374 7229  p(self,line:str)
-000119f0: 3a0a 0a20 2020 2020 2020 2022 2222 4865  :..        """He
-00011a00: 6174 2075 7020 7072 6f63 6564 7572 6520  at up procedure 
-00011a10: 6f66 2074 6865 206d 756c 7469 6368 656d  of the multichem
-00011a20: 206f 626a 6563 742c 2069 6620 7468 6973   object, if this
-00011a30: 2070 726f 6365 6475 7265 2068 6173 2062   procedure has b
-00011a40: 6565 6e20 646f 6e65 206f 6e63 652c 0a20  een done once,. 
-00011a50: 2020 2020 2020 2069 7420 6973 2063 6f6e         it is con
-00011a60: 7369 6465 7265 6420 7465 6d70 5f72 6561  sidered temp_rea
-00011a70: 6479 2e20 5072 6f63 6564 7572 6520 6973  dy. Procedure is
-00011a80: 2074 7572 6e69 6e67 2074 6865 2068 6561   turning the hea
-00011a90: 7465 7220 6f6e 2066 6f72 2033 2073 6563  ter on for 3 sec
-00011aa0: 6f6e 6473 2061 6e64 2074 6865 6e20 6f66  onds and then of
-00011ab0: 660a 2020 2020 2020 2020 4d75 7374 2073  f.        Must s
-00011ac0: 7065 6369 6679 2074 6865 206c 696e 6520  pecify the line 
-00011ad0: 746f 2068 6561 7420 7570 0a20 2020 2020  to heat up.     
-00011ae0: 2020 2022 2222 0a0a 2020 2020 2020 2020     """..        
-00011af0: 5f63 6865 636b 5f73 7075 7474 6572 2873  _check_sputter(s
-00011b00: 656c 662e 6861 7264 7761 7265 5f73 6574  elf.hardware_set
-00011b10: 7469 6e67 7329 0a0a 2020 2020 2020 2020  tings)..        
-00011b20: 6173 7365 7274 206c 696e 6520 696e 2073  assert line in s
-00011b30: 656c 662e 6d63 5f6c 696e 6573 2c20 224c  elf.mc_lines, "L
-00011b40: 696e 6520 6e6f 7420 6176 6169 6c61 626c  ine not availabl
-00011b50: 6522 0a0a 2020 2020 2020 2020 7365 6c66  e"..        self
-00011b60: 2e6d 756c 7469 6368 656d 2e6c 696e 652e  .multichem.line.
-00011b70: 7475 726e 5f68 6561 7465 725f 6f6e 286c  turn_heater_on(l
-00011b80: 696e 6529 0a0a 2020 2020 2020 2020 7469  ine)..        ti
-00011b90: 6d65 2e73 6c65 6570 2833 290a 0a20 2020  me.sleep(3)..   
-00011ba0: 2020 2020 2023 2073 656c 662e 6d75 6c74       # self.mult
-00011bb0: 6963 6865 6d2e 6c69 6e65 2e74 7572 6e5f  ichem.line.turn_
-00011bc0: 6865 6174 6572 5f6f 6666 286c 696e 6529  heater_off(line)
-00011bd0: 0a0a 2020 2020 2020 2020 7365 6c66 2e6d  ..        self.m
-00011be0: 635f 6c69 6e65 735f 7465 6d70 5b6c 696e  c_lines_temp[lin
-00011bf0: 655d 203d 2054 7275 650a 0a20 2020 2064  e] = True..    d
-00011c00: 6566 206d 756c 7469 6368 656d 5f74 656d  ef multichem_tem
-00011c10: 705f 7265 6164 7928 7365 6c66 2c6c 696e  p_ready(self,lin
-00011c20: 653a 7374 7229 202d 3e20 626f 6f6c 3a0a  e:str) -> bool:.
-00011c30: 0a20 2020 2020 2020 2022 2222 4368 6563  .        """Chec
-00011c40: 6b73 2069 6620 7468 6520 6865 6174 2075  ks if the heat u
-00011c50: 7020 7072 6f63 6564 7572 6520 666f 7220  p procedure for 
-00011c60: 6120 6c69 6e65 2069 6e20 7468 6520 6d75  a line in the mu
-00011c70: 6c74 6963 6865 6d20 6f62 6a65 6374 2068  ltichem object h
-00011c80: 6173 2062 6565 6e20 646f 6e65 2c0a 2020  as been done,.  
-00011c90: 2020 2020 2020 0a20 2020 2020 2020 2052        .        R
-00011ca0: 6574 7572 6e73 3a0a 2020 2020 2020 2020  eturns:.        
-00011cb0: 2020 2020 5f74 7970 655f 3a20 5265 7475      _type_: Retu
-00011cc0: 726e 7320 7472 7565 2069 6620 646f 6e65  rns true if done
-00011cd0: 2c20 6661 6c73 6520 6966 206e 6f74 0a20  , false if not. 
-00011ce0: 2020 2020 2020 2022 2222 0a0a 2020 2020         """..    
-00011cf0: 2020 2020 5f63 6865 636b 5f73 7075 7474      _check_sputt
-00011d00: 6572 2873 656c 662e 6861 7264 7761 7265  er(self.hardware
-00011d10: 5f73 6574 7469 6e67 7329 0a0a 2020 2020  _settings)..    
-00011d20: 2020 2020 6173 7365 7274 206c 696e 6520      assert line 
-00011d30: 696e 2073 656c 662e 6d63 5f6c 696e 6573  in self.mc_lines
-00011d40: 2c20 224c 696e 6520 6e6f 7420 6176 6169  , "Line not avai
-00011d50: 6c61 626c 6522 0a0a 2020 2020 2020 2020  lable"..        
-00011d60: 7265 7475 726e 2073 656c 662e 6d63 5f6c  return self.mc_l
-00011d70: 696e 6573 5f74 656d 705b 6c69 6e65 5d0a  ines_temp[line].
-00011d80: 0a20 2020 2064 6566 2073 6574 5f6d 6963  .    def set_mic
-00011d90: 726f 7363 6f70 655f 7374 6174 6528 7365  roscope_state(se
-00011da0: 6c66 2c20 6d69 6372 6f73 636f 7065 5f73  lf, microscope_s
-00011db0: 7461 7465 3a20 4d69 6372 6f73 636f 7065  tate: Microscope
-00011dc0: 5374 6174 6529 202d 3e20 4e6f 6e65 3a0a  State) -> None:.
-00011dd0: 2020 2020 2020 2020 2222 2252 6573 6574          """Reset
-00011de0: 2074 6865 206d 6963 726f 7363 6f70 6520   the microscope 
-00011df0: 7374 6174 6520 746f 2074 6865 2070 726f  state to the pro
-00011e00: 7669 6465 6420 7374 6174 652e 0a0a 2020  vided state...  
-00011e10: 2020 2020 2020 4172 6773 3a0a 2020 2020        Args:.    
-00011e20: 2020 2020 2020 2020 6d69 6372 6f73 636f          microsco
-00011e30: 7065 5f73 7461 7465 2028 4d69 6372 6f73  pe_state (Micros
-00011e40: 636f 7065 5374 6174 6529 3a20 4120 604d  copeState): A `M
-00011e50: 6963 726f 7363 6f70 6553 7461 7465 6020  icroscopeState` 
-00011e60: 6f62 6a65 6374 2074 6861 7420 636f 6e74  object that cont
-00011e70: 6169 6e73 2074 6865 2064 6573 6972 6564  ains the desired
-00011e80: 2073 7461 7465 206f 6620 7468 6520 6d69   state of the mi
-00011e90: 6372 6f73 636f 7065 2e0a 0a20 2020 2020  croscope...     
-00011ea0: 2020 2052 6574 7572 6e73 3a0a 2020 2020     Returns:.    
-00011eb0: 2020 2020 2020 2020 4e6f 6e65 2e0a 0a20          None... 
-00011ec0: 2020 2020 2020 2052 6169 7365 733a 0a20         Raises:. 
-00011ed0: 2020 2020 2020 2020 2020 204e 6f6e 652e             None.
-00011ee0: 0a0a 2020 2020 2020 2020 4e6f 7465 733a  ..        Notes:
-00011ef0: 0a20 2020 2020 2020 2020 2020 2054 6869  .            Thi
-00011f00: 7320 6675 6e63 7469 6f6e 2072 6573 746f  s function resto
-00011f10: 7265 7320 7468 6520 6d69 6372 6f73 636f  res the microsco
-00011f20: 7065 2073 7461 7465 2074 6f20 7468 6520  pe state to the 
-00011f30: 7072 6f76 6964 6564 2073 7461 7465 2e20  provided state. 
-00011f40: 4974 206d 6f76 6573 2074 6865 2073 7461  It moves the sta
-00011f50: 6765 2074 6f20 7468 6520 6162 736f 6c75  ge to the absolu
-00011f60: 7465 2070 6f73 6974 696f 6e20 7370 6563  te position spec
-00011f70: 6966 6965 640a 2020 2020 2020 2020 2020  ified.          
-00011f80: 2020 696e 2074 6865 2060 4d69 6372 6f73    in the `Micros
-00011f90: 636f 7065 5374 6174 6560 206f 626a 6563  copeState` objec
-00011fa0: 742c 2061 6e64 2074 6865 6e20 7265 7374  t, and then rest
-00011fb0: 6f72 6573 2074 6865 2065 6c65 6374 726f  ores the electro
-00011fc0: 6e20 616e 6420 696f 6e20 6265 616d 2073  n and ion beam s
-00011fd0: 6574 7469 6e67 7320 746f 2074 6865 6972  ettings to their
-00011fe0: 2076 616c 7565 7320 696e 2074 6865 2060   values in the `
-00011ff0: 4d69 6372 6f73 636f 7065 5374 6174 6560  MicroscopeState`
-00012000: 0a20 2020 2020 2020 2020 2020 206f 626a  .            obj
-00012010: 6563 742e 2049 7420 616c 736f 206c 6f67  ect. It also log
-00012020: 7320 6d65 7373 6167 6573 2069 6e64 6963  s messages indic
-00012030: 6174 696e 6720 7468 6520 7072 6f67 7265  ating the progre
-00012040: 7373 206f 6620 7468 6520 6f70 6572 6174  ss of the operat
-00012050: 696f 6e2e 0a20 2020 2020 2020 2022 2222  ion..        """
-00012060: 0a20 2020 2020 2020 2072 6573 6f6c 7574  .        resolut
-00012070: 696f 6e20 3d20 6622 7b6d 6963 726f 7363  ion = f"{microsc
-00012080: 6f70 655f 7374 6174 652e 6562 5f73 6574  ope_state.eb_set
-00012090: 7469 6e67 732e 7265 736f 6c75 7469 6f6e  tings.resolution
-000120a0: 5b30 5d7d 787b 6d69 6372 6f73 636f 7065  [0]}x{microscope
-000120b0: 5f73 7461 7465 2e65 625f 7365 7474 696e  _state.eb_settin
-000120c0: 6773 2e72 6573 6f6c 7574 696f 6e5b 315d  gs.resolution[1]
-000120d0: 7d22 0a20 2020 2020 2020 2023 2052 6573  }".        # Res
-000120e0: 746f 7265 2065 6c65 6374 726f 6e20 6265  tore electron be
-000120f0: 616d 2073 6574 7469 6e67 730a 2020 2020  am settings.    
-00012100: 2020 2020 6966 2073 656c 662e 6861 7264      if self.hard
-00012110: 7761 7265 5f73 6574 7469 6e67 732e 656c  ware_settings.el
-00012120: 6563 7472 6f6e 5f62 6561 6d20 6973 2046  ectron_beam is F
-00012130: 616c 7365 3a0a 2020 2020 2020 2020 2020  alse:.          
-00012140: 2020 6c6f 6767 696e 672e 7761 726e 696e    logging.warnin
-00012150: 6728 2245 6c65 6374 726f 6e20 6265 616d  g("Electron beam
-00012160: 2069 7320 6e6f 7420 6176 6169 6c61 626c   is not availabl
-00012170: 652e 2229 0a20 2020 2020 2020 2065 6c73  e.").        els
-00012180: 653a 0a20 2020 2020 2020 2020 2020 206c  e:.            l
-00012190: 6f67 6769 6e67 2e69 6e66 6f28 6622 5265  ogging.info(f"Re
-000121a0: 7374 6f72 696e 6720 656c 6563 7472 6f6e  storing electron
-000121b0: 2062 6561 6d20 7365 7474 696e 6773 2e2e   beam settings..
-000121c0: 2e22 290a 2020 2020 2020 2020 2020 2020  .").            
-000121d0: 7365 6c66 2e63 6f6e 6e65 6374 696f 6e2e  self.connection.
-000121e0: 6265 616d 732e 656c 6563 7472 6f6e 5f62  beams.electron_b
-000121f0: 6561 6d2e 776f 726b 696e 675f 6469 7374  eam.working_dist
-00012200: 616e 6365 2e76 616c 7565 203d 2028 0a20  ance.value = (. 
-00012210: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-00012220: 6963 726f 7363 6f70 655f 7374 6174 652e  icroscope_state.
-00012230: 6562 5f73 6574 7469 6e67 732e 776f 726b  eb_settings.work
-00012240: 696e 675f 6469 7374 616e 6365 0a20 2020  ing_distance.   
-00012250: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-00012260: 2020 2020 2020 2073 656c 662e 636f 6e6e         self.conn
-00012270: 6563 7469 6f6e 2e62 6561 6d73 2e65 6c65  ection.beams.ele
-00012280: 6374 726f 6e5f 6265 616d 2e62 6561 6d5f  ctron_beam.beam_
-00012290: 6375 7272 656e 742e 7661 6c75 6520 3d20  current.value = 
-000122a0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-000122b0: 2020 6d69 6372 6f73 636f 7065 5f73 7461    microscope_sta
-000122c0: 7465 2e65 625f 7365 7474 696e 6773 2e62  te.eb_settings.b
-000122d0: 6561 6d5f 6375 7272 656e 740a 2020 2020  eam_current.    
-000122e0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-000122f0: 2020 2020 2020 7365 6c66 2e63 6f6e 6e65        self.conne
-00012300: 6374 696f 6e2e 6265 616d 732e 656c 6563  ction.beams.elec
-00012310: 7472 6f6e 5f62 6561 6d2e 686f 7269 7a6f  tron_beam.horizo
-00012320: 6e74 616c 5f66 6965 6c64 5f77 6964 7468  ntal_field_width
-00012330: 2e76 616c 7565 203d 2028 0a20 2020 2020  .value = (.     
-00012340: 2020 2020 2020 2020 2020 206d 6963 726f             micro
-00012350: 7363 6f70 655f 7374 6174 652e 6562 5f73  scope_state.eb_s
-00012360: 6574 7469 6e67 732e 6866 770a 2020 2020  ettings.hfw.    
-00012370: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00012380: 2020 2020 2020 7365 6c66 2e63 6f6e 6e65        self.conne
-00012390: 6374 696f 6e2e 6265 616d 732e 656c 6563  ction.beams.elec
-000123a0: 7472 6f6e 5f62 6561 6d2e 7363 616e 6e69  tron_beam.scanni
-000123b0: 6e67 2e72 6573 6f6c 7574 696f 6e2e 7661  ng.resolution.va
-000123c0: 6c75 6520 3d20 280a 2020 2020 2020 2020  lue = (.        
-000123d0: 2020 2020 2020 2020 7265 736f 6c75 7469          resoluti
-000123e0: 6f6e 0a20 2020 2020 2020 2020 2020 2029  on.            )
-000123f0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00012400: 662e 636f 6e6e 6563 7469 6f6e 2e62 6561  f.connection.bea
-00012410: 6d73 2e65 6c65 6374 726f 6e5f 6265 616d  ms.electron_beam
-00012420: 2e73 6361 6e6e 696e 672e 6477 656c 6c5f  .scanning.dwell_
-00012430: 7469 6d65 2e76 616c 7565 203d 2028 0a20  time.value = (. 
-00012440: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-00012450: 6963 726f 7363 6f70 655f 7374 6174 652e  icroscope_state.
-00012460: 6562 5f73 6574 7469 6e67 732e 6477 656c  eb_settings.dwel
-00012470: 6c5f 7469 6d65 0a20 2020 2020 2020 2020  l_time.         
-00012480: 2020 2029 0a0a 2020 2020 2020 2020 2320     )..        # 
-00012490: 5265 7374 6f72 6520 696f 6e20 6265 616d  Restore ion beam
-000124a0: 2073 6574 7469 6e67 730a 2020 2020 2020   settings.      
-000124b0: 2020 7265 736f 6c75 7469 6f6e 203d 2066    resolution = f
-000124c0: 227b 6d69 6372 6f73 636f 7065 5f73 7461  "{microscope_sta
-000124d0: 7465 2e69 625f 7365 7474 696e 6773 2e72  te.ib_settings.r
-000124e0: 6573 6f6c 7574 696f 6e5b 305d 7d78 7b6d  esolution[0]}x{m
-000124f0: 6963 726f 7363 6f70 655f 7374 6174 652e  icroscope_state.
-00012500: 6962 5f73 6574 7469 6e67 732e 7265 736f  ib_settings.reso
-00012510: 6c75 7469 6f6e 5b31 5d7d 220a 2020 2020  lution[1]}".    
-00012520: 2020 2020 6966 2073 656c 662e 6861 7264      if self.hard
-00012530: 7761 7265 5f73 6574 7469 6e67 732e 696f  ware_settings.io
-00012540: 6e5f 6265 616d 2069 7320 4661 6c73 653a  n_beam is False:
-00012550: 0a20 2020 2020 2020 2020 2020 206c 6f67  .            log
-00012560: 6769 6e67 2e77 6172 6e69 6e67 2822 496f  ging.warning("Io
-00012570: 6e20 6265 616d 2069 7320 6e6f 7420 6176  n beam is not av
-00012580: 6169 6c61 626c 652e 2229 0a20 2020 2020  ailable.").     
-00012590: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-000125a0: 2020 2020 206c 6f67 6769 6e67 2e69 6e66       logging.inf
-000125b0: 6f28 6622 5265 7374 6f72 696e 6720 696f  o(f"Restoring io
-000125c0: 6e20 6265 616d 2073 6574 7469 6e67 732e  n beam settings.
-000125d0: 2e2e 2229 0a20 2020 2020 2020 2020 2020  ..").           
-000125e0: 2073 656c 662e 636f 6e6e 6563 7469 6f6e   self.connection
-000125f0: 2e62 6561 6d73 2e69 6f6e 5f62 6561 6d2e  .beams.ion_beam.
-00012600: 776f 726b 696e 675f 6469 7374 616e 6365  working_distance
-00012610: 2e76 616c 7565 203d 2028 0a20 2020 2020  .value = (.     
-00012620: 2020 2020 2020 2020 2020 206d 6963 726f             micro
-00012630: 7363 6f70 655f 7374 6174 652e 6962 5f73  scope_state.ib_s
-00012640: 6574 7469 6e67 732e 776f 726b 696e 675f  ettings.working_
-00012650: 6469 7374 616e 6365 0a20 2020 2020 2020  distance.       
-00012660: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
-00012670: 2020 2073 656c 662e 636f 6e6e 6563 7469     self.connecti
-00012680: 6f6e 2e62 6561 6d73 2e69 6f6e 5f62 6561  on.beams.ion_bea
-00012690: 6d2e 6265 616d 5f63 7572 7265 6e74 2e76  m.beam_current.v
-000126a0: 616c 7565 203d 2028 0a20 2020 2020 2020  alue = (.       
-000126b0: 2020 2020 2020 2020 206d 6963 726f 7363           microsc
-000126c0: 6f70 655f 7374 6174 652e 6962 5f73 6574  ope_state.ib_set
-000126d0: 7469 6e67 732e 6265 616d 5f63 7572 7265  tings.beam_curre
-000126e0: 6e74 0a20 2020 2020 2020 2020 2020 2029  nt.            )
-000126f0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00012700: 662e 636f 6e6e 6563 7469 6f6e 2e62 6561  f.connection.bea
-00012710: 6d73 2e69 6f6e 5f62 6561 6d2e 686f 7269  ms.ion_beam.hori
-00012720: 7a6f 6e74 616c 5f66 6965 6c64 5f77 6964  zontal_field_wid
-00012730: 7468 2e76 616c 7565 203d 2028 0a20 2020  th.value = (.   
-00012740: 2020 2020 2020 2020 2020 2020 206d 6963               mic
-00012750: 726f 7363 6f70 655f 7374 6174 652e 6962  roscope_state.ib
-00012760: 5f73 6574 7469 6e67 732e 6866 770a 2020  _settings.hfw.  
-00012770: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-00012780: 2020 2020 2020 2020 7365 6c66 2e63 6f6e          self.con
-00012790: 6e65 6374 696f 6e2e 6265 616d 732e 696f  nection.beams.io
-000127a0: 6e5f 6265 616d 2e73 6361 6e6e 696e 672e  n_beam.scanning.
-000127b0: 7265 736f 6c75 7469 6f6e 2e76 616c 7565  resolution.value
-000127c0: 203d 2028 0a20 2020 2020 2020 2020 2020   = (.           
-000127d0: 2020 2020 2072 6573 6f6c 7574 696f 6e0a       resolution.
-000127e0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-000127f0: 2020 2020 2020 2020 2020 7365 6c66 2e63            self.c
-00012800: 6f6e 6e65 6374 696f 6e2e 6265 616d 732e  onnection.beams.
-00012810: 696f 6e5f 6265 616d 2e73 6361 6e6e 696e  ion_beam.scannin
-00012820: 672e 6477 656c 6c5f 7469 6d65 2e76 616c  g.dwell_time.val
-00012830: 7565 203d 2028 0a20 2020 2020 2020 2020  ue = (.         
-00012840: 2020 2020 2020 206d 6963 726f 7363 6f70         microscop
-00012850: 655f 7374 6174 652e 6962 5f73 6574 7469  e_state.ib_setti
-00012860: 6e67 732e 6477 656c 6c5f 7469 6d65 0a20  ngs.dwell_time. 
-00012870: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
-00012880: 2020 2020 2020 2320 4c69 6e6b 2074 6865        # Link the
-00012890: 2073 7065 6369 6d65 6e20 7374 6167 650a   specimen stage.
-000128a0: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-000128b0: 6861 7264 7761 7265 5f73 6574 7469 6e67  hardware_setting
-000128c0: 732e 7374 6167 655f 656e 6162 6c65 6420  s.stage_enabled 
-000128d0: 6973 2046 616c 7365 3a0a 2020 2020 2020  is False:.      
-000128e0: 2020 2020 2020 6c6f 6767 696e 672e 7761        logging.wa
-000128f0: 726e 696e 6728 2253 7065 6369 6d65 6e20  rning("Specimen 
-00012900: 7374 6167 6520 6973 206e 6f74 2061 7661  stage is not ava
-00012910: 696c 6162 6c65 2e22 290a 2020 2020 2020  ilable.").      
-00012920: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00012930: 2020 2020 7365 6c66 2e63 6f6e 6e65 6374      self.connect
-00012940: 696f 6e2e 7370 6563 696d 656e 2e73 7461  ion.specimen.sta
-00012950: 6765 2e6c 696e 6b28 290a 0a20 2020 2020  ge.link()..     
-00012960: 2020 2073 656c 662e 6d6f 7665 5f73 7461     self.move_sta
-00012970: 6765 5f61 6273 6f6c 7574 6528 6d69 6372  ge_absolute(micr
-00012980: 6f73 636f 7065 5f73 7461 7465 2e61 6273  oscope_state.abs
-00012990: 6f6c 7574 655f 706f 7369 7469 6f6e 290a  olute_position).
-000129a0: 0a20 2020 2020 2020 2023 204c 6f67 2074  .        # Log t
-000129b0: 6865 2063 6f6d 706c 6574 696f 6e20 6f66  he completion of
-000129c0: 2074 6865 206f 7065 7261 7469 6f6e 0a20   the operation. 
-000129d0: 2020 2020 2020 206c 6f67 6769 6e67 2e69         logging.i
-000129e0: 6e66 6f28 6622 4d69 6372 6f73 636f 7065  nfo(f"Microscope
-000129f0: 2073 7461 7465 2072 6573 746f 7265 642e   state restored.
-00012a00: 2229 0a20 2020 200a 2020 2020 6465 6620  ").    .    def 
-00012a10: 6765 745f 6176 6169 6c61 626c 655f 7661  get_available_va
-00012a20: 6c75 6573 2873 656c 662c 206b 6579 3a20  lues(self, key: 
-00012a30: 7374 722c 2062 6561 6d5f 7479 7065 3a20  str, beam_type: 
-00012a40: 4265 616d 5479 7065 203d 204e 6f6e 6529  BeamType = None)
-00012a50: 2d3e 206c 6973 743a 0a20 2020 2020 2020  -> list:.       
-00012a60: 2022 2222 4765 7420 6120 6c69 7374 206f   """Get a list o
-00012a70: 6620 6176 6169 6c61 626c 6520 7661 6c75  f available valu
-00012a80: 6573 2066 6f72 2061 2067 6976 656e 206b  es for a given k
-00012a90: 6579 2e0a 2020 2020 2020 2020 4b65 7973  ey..        Keys
-00012aa0: 3a20 6170 706c 6963 6174 696f 6e5f 6669  : application_fi
-00012ab0: 6c65 2c20 706c 6173 6d61 5f67 6173 2c20  le, plasma_gas, 
-00012ac0: 6375 7272 656e 742c 2064 6574 6563 746f  current, detecto
-00012ad0: 725f 7479 7065 2c20 6465 7465 6374 6f72  r_type, detector
-00012ae0: 5f6d 6f64 650a 2020 2020 2020 2020 2222  _mode.        ""
-00012af0: 220a 0a20 2020 2020 2020 2076 616c 7565  "..        value
-00012b00: 7320 3d20 5b5d 0a20 2020 2020 2020 2069  s = [].        i
-00012b10: 6620 6b65 7920 3d3d 2022 6170 706c 6963  f key == "applic
-00012b20: 6174 696f 6e5f 6669 6c65 223a 0a20 2020  ation_file":.   
-00012b30: 2020 2020 2020 2020 2076 616c 7565 7320           values 
-00012b40: 3d20 7365 6c66 2e63 6f6e 6e65 6374 696f  = self.connectio
-00012b50: 6e2e 7061 7474 6572 6e69 6e67 2e6c 6973  n.patterning.lis
-00012b60: 745f 616c 6c5f 6170 706c 6963 6174 696f  t_all_applicatio
-00012b70: 6e5f 6669 6c65 7328 290a 0a20 2020 2020  n_files()..     
-00012b80: 2020 2069 6620 6265 616d 5f74 7970 6520     if beam_type 
-00012b90: 6973 2042 6561 6d54 7970 652e 494f 4e20  is BeamType.ION 
-00012ba0: 616e 6420 7365 6c66 2e68 6172 6477 6172  and self.hardwar
-00012bb0: 655f 7365 7474 696e 6773 2e69 6f6e 5f62  e_settings.ion_b
-00012bc0: 6561 6d20 6973 2054 7275 653a 0a20 2020  eam is True:.   
-00012bd0: 2020 2020 2020 2020 2069 6620 6b65 7920           if key 
-00012be0: 3d3d 2022 706c 6173 6d61 5f67 6173 223a  == "plasma_gas":
-00012bf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00012c00: 2076 616c 7565 7320 3d20 7365 6c66 2e63   values = self.c
-00012c10: 6f6e 6e65 6374 696f 6e2e 6265 616d 732e  onnection.beams.
-00012c20: 696f 6e5f 6265 616d 2e73 6f75 7263 652e  ion_beam.source.
-00012c30: 706c 6173 6d61 5f67 6173 2e61 7661 696c  plasma_gas.avail
-00012c40: 6162 6c65 5f76 616c 7565 730a 0a20 2020  able_values..   
-00012c50: 2020 2020 2069 6620 6b65 7920 3d3d 2022       if key == "
-00012c60: 6375 7272 656e 7422 3a0a 2020 2020 2020  current":.      
-00012c70: 2020 2020 2020 6966 2062 6561 6d5f 7479        if beam_ty
-00012c80: 7065 2069 7320 4265 616d 5479 7065 2e49  pe is BeamType.I
-00012c90: 4f4e 2061 6e64 2073 656c 662e 6861 7264  ON and self.hard
-00012ca0: 7761 7265 5f73 6574 7469 6e67 732e 696f  ware_settings.io
-00012cb0: 6e5f 6265 616d 2069 7320 5472 7565 3a0a  n_beam is True:.
-00012cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012cd0: 7661 6c75 6573 203d 2073 656c 662e 636f  values = self.co
-00012ce0: 6e6e 6563 7469 6f6e 2e62 6561 6d73 2e69  nnection.beams.i
-00012cf0: 6f6e 5f62 6561 6d2e 6265 616d 5f63 7572  on_beam.beam_cur
-00012d00: 7265 6e74 2e61 7661 696c 6162 6c65 5f76  rent.available_v
-00012d10: 616c 7565 730a 2020 2020 2020 2020 2020  alues.          
-00012d20: 2020 656c 6966 2062 6561 6d5f 7479 7065    elif beam_type
-00012d30: 2069 7320 4265 616d 5479 7065 2e45 4c45   is BeamType.ELE
-00012d40: 4354 524f 4e20 616e 6420 7365 6c66 2e68  CTRON and self.h
-00012d50: 6172 6477 6172 655f 7365 7474 696e 6773  ardware_settings
-00012d60: 2e65 6c65 6374 726f 6e5f 6265 616d 2069  .electron_beam i
-00012d70: 7320 5472 7565 3a0a 2020 2020 2020 2020  s True:.        
-00012d80: 2020 2020 2020 2020 7661 6c75 6573 203d          values =
-00012d90: 2073 656c 662e 636f 6e6e 6563 7469 6f6e   self.connection
-00012da0: 2e62 6561 6d73 2e65 6c65 6374 726f 6e5f  .beams.electron_
-00012db0: 6265 616d 2e62 6561 6d5f 6375 7272 656e  beam.beam_curren
-00012dc0: 742e 6c69 6d69 7473 0a0a 2020 2020 2020  t.limits..      
-00012dd0: 2020 6966 206b 6579 203d 3d20 2264 6574    if key == "det
-00012de0: 6563 746f 725f 7479 7065 223a 0a20 2020  ector_type":.   
-00012df0: 2020 2020 2020 2020 2076 616c 7565 7320           values 
-00012e00: 3d20 7365 6c66 2e63 6f6e 6e65 6374 696f  = self.connectio
-00012e10: 6e2e 6465 7465 6374 6f72 2e74 7970 652e  n.detector.type.
-00012e20: 6176 6169 6c61 626c 655f 7661 6c75 6573  available_values
-00012e30: 0a20 2020 2020 2020 200a 2020 2020 2020  .        .      
-00012e40: 2020 6966 206b 6579 203d 3d20 2264 6574    if key == "det
-00012e50: 6563 746f 725f 6d6f 6465 223a 0a20 2020  ector_mode":.   
-00012e60: 2020 2020 2020 2020 2076 616c 7565 7320           values 
-00012e70: 3d20 7365 6c66 2e63 6f6e 6e65 6374 696f  = self.connectio
-00012e80: 6e2e 6465 7465 6374 6f72 2e6d 6f64 652e  n.detector.mode.
-00012e90: 6176 6169 6c61 626c 655f 7661 6c75 6573  available_values
-00012ea0: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
-00012eb0: 2076 616c 7565 730a 0a20 2020 2064 6566   values..    def
-00012ec0: 2067 6574 5f62 6561 6d5f 7365 7474 696e   get_beam_settin
-00012ed0: 6773 2873 656c 662c 2062 6561 6d5f 7479  gs(self, beam_ty
-00012ee0: 7065 3a20 4265 616d 5479 7065 203d 2042  pe: BeamType = B
-00012ef0: 6561 6d54 7970 652e 454c 4543 5452 4f4e  eamType.ELECTRON
-00012f00: 2920 2d3e 2042 6561 6d53 6574 7469 6e67  ) -> BeamSetting
-00012f10: 733a 0a20 2020 2020 2020 2022 2222 4765  s:.        """Ge
-00012f20: 7420 7468 6520 6375 7272 656e 7420 6265  t the current be
-00012f30: 616d 2073 6574 7469 6e67 7320 666f 7220  am settings for 
-00012f40: 7468 6520 7370 6563 6966 6965 6420 6265  the specified be
-00012f50: 616d 2074 7970 652e 0a0a 2020 2020 2020  am type...      
-00012f60: 2020 4172 6773 3a0a 2020 2020 2020 2020    Args:.        
-00012f70: 2020 2020 6265 616d 5f74 7970 6520 2842      beam_type (B
-00012f80: 6561 6d54 7970 652c 206f 7074 696f 6e61  eamType, optiona
-00012f90: 6c29 3a20 5468 6520 6265 616d 2074 7970  l): The beam typ
-00012fa0: 6520 746f 2067 6574 2074 6865 2073 6574  e to get the set
-00012fb0: 7469 6e67 7320 666f 722e 2044 6566 6175  tings for. Defau
-00012fc0: 6c74 7320 746f 2042 6561 6d54 7970 652e  lts to BeamType.
-00012fd0: 454c 4543 5452 4f4e 2e0a 0a20 2020 2020  ELECTRON...     
-00012fe0: 2020 2052 6574 7572 6e73 3a0a 2020 2020     Returns:.    
-00012ff0: 2020 2020 2020 2020 4265 616d 5365 7474          BeamSett
-00013000: 696e 6773 3a20 4120 6042 6561 6d53 6574  ings: A `BeamSet
-00013010: 7469 6e67 7360 206f 626a 6563 7420 636f  tings` object co
-00013020: 6e74 6169 6e69 6e67 2074 6865 2063 7572  ntaining the cur
-00013030: 7265 6e74 2062 6561 6d20 7365 7474 696e  rent beam settin
-00013040: 6773 2e0a 0a20 2020 2020 2020 2052 6169  gs...        Rai
-00013050: 7365 733a 0a20 2020 2020 2020 2020 2020  ses:.           
-00013060: 204e 6f6e 652e 0a20 2020 2020 2020 2022   None..        "
-00013070: 2222 0a20 2020 2020 2020 206c 6f67 6769  "".        loggi
-00013080: 6e67 2e69 6e66 6f28 6622 4765 7474 696e  ng.info(f"Gettin
-00013090: 6720 7b62 6561 6d5f 7479 7065 2e76 616c  g {beam_type.val
-000130a0: 7565 7d20 6265 616d 2073 6574 7469 6e67  ue} beam setting
-000130b0: 732e 2e2e 2229 0a20 2020 2020 2020 2062  s...").        b
-000130c0: 6561 6d5f 7365 7474 696e 6773 203d 2042  eam_settings = B
-000130d0: 6561 6d53 6574 7469 6e67 7328 0a20 2020  eamSettings(.   
-000130e0: 2020 2020 2020 2020 2062 6561 6d5f 7479           beam_ty
-000130f0: 7065 3d62 6561 6d5f 7479 7065 2c0a 2020  pe=beam_type,.  
-00013100: 2020 2020 2020 2020 2020 776f 726b 696e            workin
-00013110: 675f 6469 7374 616e 6365 3d73 656c 662e  g_distance=self.
-00013120: 6765 7428 2277 6f72 6b69 6e67 5f64 6973  get("working_dis
-00013130: 7461 6e63 6522 2c20 6265 616d 5f74 7970  tance", beam_typ
-00013140: 6529 2c0a 2020 2020 2020 2020 2020 2020  e),.            
-00013150: 6265 616d 5f63 7572 7265 6e74 3d73 656c  beam_current=sel
-00013160: 662e 6765 7428 2263 7572 7265 6e74 222c  f.get("current",
-00013170: 2062 6561 6d5f 7479 7065 292c 0a20 2020   beam_type),.   
-00013180: 2020 2020 2020 2020 2076 6f6c 7461 6765           voltage
-00013190: 3d73 656c 662e 6765 7428 2276 6f6c 7461  =self.get("volta
-000131a0: 6765 222c 2062 6561 6d5f 7479 7065 292c  ge", beam_type),
-000131b0: 0a20 2020 2020 2020 2020 2020 2068 6677  .            hfw
-000131c0: 3d73 656c 662e 6765 7428 2268 6677 222c  =self.get("hfw",
-000131d0: 2062 6561 6d5f 7479 7065 292c 0a20 2020   beam_type),.   
-000131e0: 2020 2020 2020 2020 2072 6573 6f6c 7574           resolut
-000131f0: 696f 6e3d 7365 6c66 2e63 6f6e 6e65 6374  ion=self.connect
-00013200: 696f 6e2e 6265 616d 732e 656c 6563 7472  ion.beams.electr
-00013210: 6f6e 5f62 6561 6d2e 7363 616e 6e69 6e67  on_beam.scanning
-00013220: 2e72 6573 6f6c 7574 696f 6e2e 7661 6c75  .resolution.valu
-00013230: 6520 6966 2062 6561 6d5f 7479 7065 203d  e if beam_type =
-00013240: 3d20 4265 616d 5479 7065 2e45 4c45 4354  = BeamType.ELECT
-00013250: 524f 4e20 656c 7365 2073 656c 662e 636f  RON else self.co
-00013260: 6e6e 6563 7469 6f6e 2e62 6561 6d73 2e69  nnection.beams.i
-00013270: 6f6e 5f62 6561 6d2e 7363 616e 6e69 6e67  on_beam.scanning
-00013280: 2e72 6573 6f6c 7574 696f 6e2e 7661 6c75  .resolution.valu
-00013290: 652c 0a20 2020 2020 2020 2020 2020 2064  e,.            d
-000132a0: 7765 6c6c 5f74 696d 653d 7365 6c66 2e63  well_time=self.c
-000132b0: 6f6e 6e65 6374 696f 6e2e 6265 616d 732e  onnection.beams.
-000132c0: 656c 6563 7472 6f6e 5f62 6561 6d2e 7363  electron_beam.sc
-000132d0: 616e 6e69 6e67 2e64 7765 6c6c 5f74 696d  anning.dwell_tim
-000132e0: 652e 7661 6c75 6520 6966 2062 6561 6d5f  e.value if beam_
-000132f0: 7479 7065 203d 3d20 4265 616d 5479 7065  type == BeamType
-00013300: 2e45 4c45 4354 524f 4e20 656c 7365 2073  .ELECTRON else s
-00013310: 656c 662e 636f 6e6e 6563 7469 6f6e 2e62  elf.connection.b
-00013320: 6561 6d73 2e69 6f6e 5f62 6561 6d2e 7363  eams.ion_beam.sc
-00013330: 616e 6e69 6e67 2e64 7765 6c6c 5f74 696d  anning.dwell_tim
-00013340: 652e 7661 6c75 652c 0a20 2020 2020 2020  e.value,.       
-00013350: 2020 2020 2073 7469 676d 6174 696f 6e3d       stigmation=
-00013360: 7365 6c66 2e67 6574 2822 7374 6967 6d61  self.get("stigma
-00013370: 7469 6f6e 222c 2062 6561 6d5f 7479 7065  tion", beam_type
-00013380: 292c 0a20 2020 2020 2020 2020 2020 2062  ),.            b
-00013390: 6561 6d5f 7368 6966 743d 7365 6c66 2e67  eam_shift=self.g
-000133a0: 6574 2822 7368 6966 7422 2c20 6265 616d  et("shift", beam
-000133b0: 5f74 7970 6529 2c0a 2020 2020 2020 2020  _type),.        
-000133c0: 2020 2020 7363 616e 5f72 6f74 6174 696f      scan_rotatio
-000133d0: 6e3d 7365 6c66 2e67 6574 2822 7363 616e  n=self.get("scan
-000133e0: 5f72 6f74 6174 696f 6e22 2c20 6265 616d  _rotation", beam
-000133f0: 5f74 7970 6529 2c0a 2020 2020 2020 2020  _type),.        
-00013400: 290a 0a20 2020 2020 2020 2072 6574 7572  )..        retur
-00013410: 6e20 6265 616d 5f73 6574 7469 6e67 730a  n beam_settings.
-00013420: 2020 2020 0a20 2020 2064 6566 2067 6574      .    def get
-00013430: 5f64 6574 6563 746f 725f 7365 7474 696e  _detector_settin
-00013440: 6773 2873 656c 662c 2062 6561 6d5f 7479  gs(self, beam_ty
-00013450: 7065 3a20 4265 616d 5479 7065 203d 2042  pe: BeamType = B
-00013460: 6561 6d54 7970 652e 454c 4543 5452 4f4e  eamType.ELECTRON
-00013470: 2920 2d3e 2046 6962 7365 6d44 6574 6563  ) -> FibsemDetec
-00013480: 746f 7253 6574 7469 6e67 733a 0a20 2020  torSettings:.   
-00013490: 2020 2020 2022 2222 4765 7420 7468 6520       """Get the 
-000134a0: 6375 7272 656e 7420 6465 7465 6374 6f72  current detector
-000134b0: 2073 6574 7469 6e67 7320 666f 7220 7468   settings for th
-000134c0: 6520 7370 6563 6966 6965 6420 6265 616d  e specified beam
-000134d0: 2074 7970 652e 0a0a 2020 2020 2020 2020   type...        
-000134e0: 4172 6773 3a0a 2020 2020 2020 2020 2020  Args:.          
-000134f0: 2020 6265 616d 5f74 7970 6520 2842 6561    beam_type (Bea
-00013500: 6d54 7970 652c 206f 7074 696f 6e61 6c29  mType, optional)
-00013510: 3a20 5468 6520 6265 616d 2074 7970 6520  : The beam type 
-00013520: 746f 2067 6574 2074 6865 2073 6574 7469  to get the setti
-00013530: 6e67 7320 666f 722e 2044 6566 6175 6c74  ngs for. Default
-00013540: 7320 746f 2042 6561 6d54 7970 652e 454c  s to BeamType.EL
-00013550: 4543 5452 4f4e 2e0a 0a20 2020 2020 2020  ECTRON...       
-00013560: 2052 6574 7572 6e73 3a0a 2020 2020 2020   Returns:.      
-00013570: 2020 2020 2020 4669 6273 656d 4465 7465        FibsemDete
-00013580: 6374 6f72 5365 7474 696e 6773 3a20 4120  ctorSettings: A 
-00013590: 6046 6962 7365 6d44 6574 6563 746f 7253  `FibsemDetectorS
-000135a0: 6574 7469 6e67 7360 206f 626a 6563 7420  ettings` object 
-000135b0: 636f 6e74 6169 6e69 6e67 2074 6865 2063  containing the c
-000135c0: 7572 7265 6e74 2064 6574 6563 746f 7220  urrent detector 
-000135d0: 7365 7474 696e 6773 2e0a 0a20 2020 2020  settings...     
-000135e0: 2020 2052 6169 7365 733a 0a20 2020 2020     Raises:.     
-000135f0: 2020 2020 2020 204e 6f6e 652e 0a20 2020         None..   
-00013600: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-00013610: 206c 6f67 6769 6e67 2e69 6e66 6f28 6622   logging.info(f"
-00013620: 4765 7474 696e 6720 7b62 6561 6d5f 7479  Getting {beam_ty
-00013630: 7065 2e76 616c 7565 7d20 6465 7465 6374  pe.value} detect
-00013640: 6f72 2073 6574 7469 6e67 732e 2e2e 2229  or settings...")
-00013650: 0a20 2020 2020 2020 2064 6574 6563 746f  .        detecto
-00013660: 725f 7365 7474 696e 6773 203d 2046 6962  r_settings = Fib
-00013670: 7365 6d44 6574 6563 746f 7253 6574 7469  semDetectorSetti
-00013680: 6e67 7328 0a20 2020 2020 2020 2020 2020  ngs(.           
-00013690: 2074 7970 653d 7365 6c66 2e67 6574 2822   type=self.get("
-000136a0: 6465 7465 6374 6f72 5f74 7970 6522 2c20  detector_type", 
-000136b0: 6265 616d 5f74 7970 6529 2c0a 2020 2020  beam_type),.    
-000136c0: 2020 2020 2020 2020 6d6f 6465 3d73 656c          mode=sel
-000136d0: 662e 6765 7428 2264 6574 6563 746f 725f  f.get("detector_
-000136e0: 6d6f 6465 222c 2062 6561 6d5f 7479 7065  mode", beam_type
-000136f0: 292c 0a20 2020 2020 2020 2020 2020 2062  ),.            b
-00013700: 7269 6768 746e 6573 733d 7365 6c66 2e67  rightness=self.g
-00013710: 6574 2822 6465 7465 6374 6f72 5f62 7269  et("detector_bri
-00013720: 6768 746e 6573 7322 2c20 6265 616d 5f74  ghtness", beam_t
-00013730: 7970 6529 2c0a 2020 2020 2020 2020 2020  ype),.          
-00013740: 2020 636f 6e74 7261 7374 3d73 656c 662e    contrast=self.
-00013750: 6765 7428 2264 6574 6563 746f 725f 636f  get("detector_co
-00013760: 6e74 7261 7374 222c 2062 6561 6d5f 7479  ntrast", beam_ty
-00013770: 7065 292c 0a20 2020 2020 2020 2029 0a0a  pe),.        )..
-00013780: 2020 2020 2020 2020 7265 7475 726e 2064          return d
-00013790: 6574 6563 746f 725f 7365 7474 696e 6773  etector_settings
-000137a0: 0a0a 2020 2020 6465 6620 6765 7428 7365  ..    def get(se
-000137b0: 6c66 2c20 6b65 793a 2073 7472 2c20 6265  lf, key: str, be
-000137c0: 616d 5f74 7970 653a 2042 6561 6d54 7970  am_type: BeamTyp
-000137d0: 6520 3d20 4265 616d 5479 7065 2e45 4c45  e = BeamType.ELE
-000137e0: 4354 524f 4e29 202d 3e20 556e 696f 6e5b  CTRON) -> Union[
-000137f0: 666c 6f61 742c 2073 7472 2c20 4e6f 6e65  float, str, None
-00013800: 5d3a 0a20 2020 2020 2020 200a 2020 2020  ]:.        .    
-00013810: 2020 2020 2320 544f 444f 3a20 6d61 6b65      # TODO: make
-00013820: 2074 6865 206c 6973 7420 6f66 2067 6574   the list of get
-00013830: 2061 6e64 2073 6574 206b 6579 7320 6176   and set keys av
-00013840: 6169 6c61 626c 6520 746f 2074 6865 2075  ailable to the u
-00013850: 7365 720a 0a20 2020 2020 2020 2062 6561  ser..        bea
-00013860: 6d20 3d20 7365 6c66 2e63 6f6e 6e65 6374  m = self.connect
-00013870: 696f 6e2e 6265 616d 732e 656c 6563 7472  ion.beams.electr
-00013880: 6f6e 5f62 6561 6d20 6966 2062 6561 6d5f  on_beam if beam_
-00013890: 7479 7065 203d 3d20 4265 616d 5479 7065  type == BeamType
-000138a0: 2e45 4c45 4354 524f 4e20 656c 7365 2073  .ELECTRON else s
-000138b0: 656c 662e 636f 6e6e 6563 7469 6f6e 2e62  elf.connection.b
-000138c0: 6561 6d73 2e69 6f6e 5f62 6561 6d0a 2020  eams.ion_beam.  
-000138d0: 2020 2020 200a 2020 2020 2020 2020 2320       .        # 
-000138e0: 6265 616d 2070 726f 7065 7274 6965 730a  beam properties.
-000138f0: 2020 2020 2020 2020 6966 206b 6579 203d          if key =
-00013900: 3d20 226f 6e22 3a20 0a20 2020 2020 2020  = "on": .       
-00013910: 2020 2020 205f 6368 6563 6b5f 6265 616d       _check_beam
-00013920: 2862 6561 6d5f 7479 7065 2c20 7365 6c66  (beam_type, self
-00013930: 2e68 6172 6477 6172 655f 7365 7474 696e  .hardware_settin
-00013940: 6773 290a 2020 2020 2020 2020 2020 2020  gs).            
-00013950: 7265 7475 726e 2062 6561 6d2e 6973 5f6f  return beam.is_o
-00013960: 6e0a 2020 2020 2020 2020 6966 206b 6579  n.        if key
-00013970: 203d 3d20 2262 6c61 6e6b 6564 223a 0a20   == "blanked":. 
-00013980: 2020 2020 2020 2020 2020 205f 6368 6563             _chec
-00013990: 6b5f 6265 616d 2862 6561 6d5f 7479 7065  k_beam(beam_type
-000139a0: 2c20 7365 6c66 2e68 6172 6477 6172 655f  , self.hardware_
-000139b0: 7365 7474 696e 6773 290a 2020 2020 2020  settings).      
-000139c0: 2020 2020 2020 7265 7475 726e 2062 6561        return bea
-000139d0: 6d2e 6973 5f62 6c61 6e6b 6564 0a20 2020  m.is_blanked.   
-000139e0: 2020 2020 2069 6620 6b65 7920 3d3d 2022       if key == "
-000139f0: 776f 726b 696e 675f 6469 7374 616e 6365  working_distance
-00013a00: 223a 0a20 2020 2020 2020 2020 2020 205f  ":.            _
-00013a10: 6368 6563 6b5f 6265 616d 2862 6561 6d5f  check_beam(beam_
-00013a20: 7479 7065 2c20 7365 6c66 2e68 6172 6477  type, self.hardw
-00013a30: 6172 655f 7365 7474 696e 6773 290a 2020  are_settings).  
-00013a40: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00013a50: 2062 6561 6d2e 776f 726b 696e 675f 6469   beam.working_di
-00013a60: 7374 616e 6365 2e76 616c 7565 0a20 2020  stance.value.   
-00013a70: 2020 2020 2069 6620 6b65 7920 3d3d 2022       if key == "
-00013a80: 6375 7272 656e 7422 3a0a 2020 2020 2020  current":.      
-00013a90: 2020 2020 2020 5f63 6865 636b 5f62 6561        _check_bea
-00013aa0: 6d28 6265 616d 5f74 7970 652c 2073 656c  m(beam_type, sel
-00013ab0: 662e 6861 7264 7761 7265 5f73 6574 7469  f.hardware_setti
-00013ac0: 6e67 7329 0a20 2020 2020 2020 2020 2020  ngs).           
-00013ad0: 2072 6574 7572 6e20 6265 616d 2e62 6561   return beam.bea
-00013ae0: 6d5f 6375 7272 656e 742e 7661 6c75 650a  m_current.value.
-00013af0: 2020 2020 2020 2020 6966 206b 6579 203d          if key =
-00013b00: 3d20 2276 6f6c 7461 6765 223a 0a20 2020  = "voltage":.   
-00013b10: 2020 2020 2020 2020 205f 6368 6563 6b5f           _check_
-00013b20: 6265 616d 2862 6561 6d5f 7479 7065 2c20  beam(beam_type, 
-00013b30: 7365 6c66 2e68 6172 6477 6172 655f 7365  self.hardware_se
-00013b40: 7474 696e 6773 290a 2020 2020 2020 2020  ttings).        
-00013b50: 2020 2020 7265 7475 726e 2062 6561 6d2e      return beam.
-00013b60: 6869 6768 5f76 6f6c 7461 6765 2e76 616c  high_voltage.val
-00013b70: 7565 0a20 2020 2020 2020 2069 6620 6b65  ue.        if ke
-00013b80: 7920 3d3d 2022 6866 7722 3a0a 2020 2020  y == "hfw":.    
-00013b90: 2020 2020 2020 2020 5f63 6865 636b 5f62          _check_b
-00013ba0: 6561 6d28 6265 616d 5f74 7970 652c 2073  eam(beam_type, s
-00013bb0: 656c 662e 6861 7264 7761 7265 5f73 6574  elf.hardware_set
-00013bc0: 7469 6e67 7329 0a20 2020 2020 2020 2020  tings).         
-00013bd0: 2020 2072 6574 7572 6e20 6265 616d 2e68     return beam.h
-00013be0: 6f72 697a 6f6e 7461 6c5f 6669 656c 645f  orizontal_field_
-00013bf0: 7769 6474 682e 7661 6c75 650a 2020 2020  width.value.    
-00013c00: 2020 2020 6966 206b 6579 203d 3d20 2272      if key == "r
-00013c10: 6573 6f6c 7574 696f 6e22 3a0a 2020 2020  esolution":.    
-00013c20: 2020 2020 2020 2020 5f63 6865 636b 5f62          _check_b
-00013c30: 6561 6d28 6265 616d 5f74 7970 652c 2073  eam(beam_type, s
-00013c40: 656c 662e 6861 7264 7761 7265 5f73 6574  elf.hardware_set
-00013c50: 7469 6e67 7329 0a20 2020 2020 2020 2020  tings).         
-00013c60: 2020 2072 6574 7572 6e20 6265 616d 2e73     return beam.s
-00013c70: 6361 6e6e 696e 672e 7265 736f 6c75 7469  canning.resoluti
-00013c80: 6f6e 2e76 616c 7565 0a20 2020 2020 2020  on.value.       
-00013c90: 2069 6620 6b65 7920 3d3d 2022 6477 656c   if key == "dwel
-00013ca0: 6c5f 7469 6d65 223a 0a20 2020 2020 2020  l_time":.       
-00013cb0: 2020 2020 205f 6368 6563 6b5f 6265 616d       _check_beam
-00013cc0: 2862 6561 6d5f 7479 7065 2c20 7365 6c66  (beam_type, self
-00013cd0: 2e68 6172 6477 6172 655f 7365 7474 696e  .hardware_settin
-00013ce0: 6773 290a 2020 2020 2020 2020 2020 2020  gs).            
-00013cf0: 7265 7475 726e 2062 6561 6d2e 7363 616e  return beam.scan
-00013d00: 6e69 6e67 2e64 7765 6c6c 5f74 696d 652e  ning.dwell_time.
-00013d10: 7661 6c75 650a 2020 2020 2020 2020 6966  value.        if
-00013d20: 206b 6579 203d 3d20 2273 6361 6e5f 726f   key == "scan_ro
-00013d30: 7461 7469 6f6e 223a 0a20 2020 2020 2020  tation":.       
-00013d40: 2020 2020 205f 6368 6563 6b5f 6265 616d       _check_beam
-00013d50: 2862 6561 6d5f 7479 7065 2c20 7365 6c66  (beam_type, self
-00013d60: 2e68 6172 6477 6172 655f 7365 7474 696e  .hardware_settin
-00013d70: 6773 290a 2020 2020 2020 2020 2020 2020  gs).            
-00013d80: 7265 7475 726e 2062 6561 6d2e 7363 616e  return beam.scan
-00013d90: 6e69 6e67 2e72 6f74 6174 696f 6e2e 7661  ning.rotation.va
-00013da0: 6c75 650a 2020 2020 2020 2020 6966 206b  lue.        if k
-00013db0: 6579 203d 3d20 2276 6f6c 7461 6765 5f6c  ey == "voltage_l
-00013dc0: 696d 6974 7322 3a0a 2020 2020 2020 2020  imits":.        
-00013dd0: 2020 2020 5f63 6865 636b 5f62 6561 6d28      _check_beam(
-00013de0: 6265 616d 5f74 7970 652c 2073 656c 662e  beam_type, self.
-00013df0: 6861 7264 7761 7265 5f73 6574 7469 6e67  hardware_setting
-00013e00: 7329 0a20 2020 2020 2020 2020 2020 2072  s).            r
-00013e10: 6574 7572 6e20 6265 616d 2e68 6967 685f  eturn beam.high_
-00013e20: 766f 6c74 6167 652e 6c69 6d69 7473 0a20  voltage.limits. 
-00013e30: 2020 2020 2020 2069 6620 6b65 7920 3d3d         if key ==
-00013e40: 2022 766f 6c74 6167 655f 636f 6e74 726f   "voltage_contro
-00013e50: 6c6c 6162 6c65 223a 0a20 2020 2020 2020  llable":.       
-00013e60: 2020 2020 205f 6368 6563 6b5f 6265 616d       _check_beam
-00013e70: 2862 6561 6d5f 7479 7065 2c20 7365 6c66  (beam_type, self
-00013e80: 2e68 6172 6477 6172 655f 7365 7474 696e  .hardware_settin
-00013e90: 6773 290a 2020 2020 2020 2020 2020 2020  gs).            
-00013ea0: 7265 7475 726e 2062 6561 6d2e 6869 6768  return beam.high
-00013eb0: 5f76 6f6c 7461 6765 2e69 735f 636f 6e74  _voltage.is_cont
-00013ec0: 726f 6c6c 6162 6c65 0a20 2020 2020 2020  rollable.       
-00013ed0: 2069 6620 6b65 7920 3d3d 2022 7368 6966   if key == "shif
-00013ee0: 7422 3a0a 2020 2020 2020 2020 2020 2020  t":.            
-00013ef0: 5f63 6865 636b 5f62 6561 6d28 6265 616d  _check_beam(beam
-00013f00: 5f74 7970 652c 2073 656c 662e 6861 7264  _type, self.hard
-00013f10: 7761 7265 5f73 6574 7469 6e67 7329 0a20  ware_settings). 
-00013f20: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00013f30: 6e20 506f 696e 7428 6265 616d 2e62 6561  n Point(beam.bea
-00013f40: 6d5f 7368 6966 742e 7661 6c75 652e 782c  m_shift.value.x,
-00013f50: 2062 6561 6d2e 6265 616d 5f73 6869 6674   beam.beam_shift
-00013f60: 2e76 616c 7565 2e79 290a 2020 2020 2020  .value.y).      
-00013f70: 2020 6966 206b 6579 203d 3d20 2273 7469    if key == "sti
-00013f80: 676d 6174 696f 6e22 3a20 0a20 2020 2020  gmation": .     
-00013f90: 2020 2020 2020 205f 6368 6563 6b5f 6265         _check_be
-00013fa0: 616d 2862 6561 6d5f 7479 7065 2c20 7365  am(beam_type, se
-00013fb0: 6c66 2e68 6172 6477 6172 655f 7365 7474  lf.hardware_sett
-00013fc0: 696e 6773 290a 2020 2020 2020 2020 2020  ings).          
-00013fd0: 2020 7265 7475 726e 2050 6f69 6e74 2862    return Point(b
-00013fe0: 6561 6d2e 7374 6967 6d61 746f 722e 7661  eam.stigmator.va
-00013ff0: 6c75 652e 782c 2062 6561 6d2e 7374 6967  lue.x, beam.stig
-00014000: 6d61 746f 722e 7661 6c75 652e 7929 0a0a  mator.value.y)..
-00014010: 0a20 2020 2020 2020 2023 2069 6f6e 2062  .        # ion b
-00014020: 6561 6d20 7072 6f70 6572 7469 6573 0a20  eam properties. 
-00014030: 2020 2020 2020 2069 6620 6265 616d 5f74         if beam_t
-00014040: 7970 6520 6973 2042 6561 6d54 7970 652e  ype is BeamType.
-00014050: 454c 4543 5452 4f4e 3a0a 2020 2020 2020  ELECTRON:.      
-00014060: 2020 2020 2020 6966 206b 6579 203d 3d20        if key == 
-00014070: 2261 6e67 756c 6172 5f63 6f72 7265 6374  "angular_correct
-00014080: 696f 6e5f 616e 676c 6522 3a0a 2020 2020  ion_angle":.    
-00014090: 2020 2020 2020 2020 2020 2020 5f63 6865              _che
-000140a0: 636b 5f62 6561 6d28 6265 616d 5f74 7970  ck_beam(beam_typ
-000140b0: 652c 2073 656c 662e 6861 7264 7761 7265  e, self.hardware
-000140c0: 5f73 6574 7469 6e67 7329 0a20 2020 2020  _settings).     
-000140d0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-000140e0: 6e20 6265 616d 2e61 6e67 756c 6172 5f63  n beam.angular_c
-000140f0: 6f72 7265 6374 696f 6e2e 616e 676c 652e  orrection.angle.
-00014100: 7661 6c75 650a 0a20 2020 2020 2020 2069  value..        i
-00014110: 6620 6265 616d 5f74 7970 6520 6973 2042  f beam_type is B
-00014120: 6561 6d54 7970 652e 494f 4e3a 0a20 2020  eamType.ION:.   
-00014130: 2020 2020 2020 2020 2069 6620 6b65 7920           if key 
-00014140: 3d3d 2022 706c 6173 6d61 5f67 6173 223a  == "plasma_gas":
-00014150: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00014160: 205f 6368 6563 6b5f 6265 616d 2862 6561   _check_beam(bea
-00014170: 6d5f 7479 7065 2c20 7365 6c66 2e68 6172  m_type, self.har
-00014180: 6477 6172 655f 7365 7474 696e 6773 290a  dware_settings).
-00014190: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000141a0: 7265 7475 726e 2062 6561 6d2e 736f 7572  return beam.sour
-000141b0: 6365 2e70 6c61 736d 615f 6761 732e 7661  ce.plasma_gas.va
-000141c0: 6c75 6520 2320 6d69 6768 7420 6e65 6564  lue # might need
-000141d0: 2074 6f20 6368 6563 6b20 6966 2074 6869   to check if thi
-000141e0: 7320 6973 2061 7661 696c 6162 6c65 3f0a  s is available?.
-000141f0: 0a20 2020 2020 2020 2023 2073 7461 6765  .        # stage
-00014200: 2070 726f 7065 7274 6965 730a 2020 2020   properties.    
-00014210: 2020 2020 6966 206b 6579 203d 3d20 2273      if key == "s
-00014220: 7461 6765 5f70 6f73 6974 696f 6e22 3a0a  tage_position":.
-00014230: 2020 2020 2020 2020 2020 2020 5f63 6865              _che
-00014240: 636b 5f73 7461 6765 2873 656c 662e 6861  ck_stage(self.ha
-00014250: 7264 7761 7265 5f73 6574 7469 6e67 7329  rdware_settings)
-00014260: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00014270: 7572 6e20 7365 6c66 2e63 6f6e 6e65 6374  urn self.connect
-00014280: 696f 6e2e 7370 6563 696d 656e 2e73 7461  ion.specimen.sta
-00014290: 6765 2e63 7572 7265 6e74 5f70 6f73 6974  ge.current_posit
-000142a0: 696f 6e0a 2020 2020 2020 2020 6966 206b  ion.        if k
-000142b0: 6579 203d 3d20 2273 7461 6765 5f68 6f6d  ey == "stage_hom
-000142c0: 6564 223a 0a20 2020 2020 2020 2020 2020  ed":.           
-000142d0: 205f 6368 6563 6b5f 7374 6167 6528 7365   _check_stage(se
-000142e0: 6c66 2e68 6172 6477 6172 655f 7365 7474  lf.hardware_sett
-000142f0: 696e 6773 290a 2020 2020 2020 2020 2020  ings).          
-00014300: 2020 7265 7475 726e 2073 656c 662e 636f    return self.co
-00014310: 6e6e 6563 7469 6f6e 2e73 7065 6369 6d65  nnection.specime
-00014320: 6e2e 7374 6167 652e 6973 5f68 6f6d 6564  n.stage.is_homed
-00014330: 0a20 2020 2020 2020 2069 6620 6b65 7920  .        if key 
-00014340: 3d3d 2022 7374 6167 655f 6c69 6e6b 6564  == "stage_linked
-00014350: 223a 0a20 2020 2020 2020 2020 2020 205f  ":.            _
-00014360: 6368 6563 6b5f 7374 6167 6528 7365 6c66  check_stage(self
-00014370: 2e68 6172 6477 6172 655f 7365 7474 696e  .hardware_settin
-00014380: 6773 290a 2020 2020 2020 2020 2020 2020  gs).            
-00014390: 7265 7475 726e 2073 656c 662e 636f 6e6e  return self.conn
-000143a0: 6563 7469 6f6e 2e73 7065 6369 6d65 6e2e  ection.specimen.
-000143b0: 7374 6167 652e 6973 5f6c 696e 6b65 640a  stage.is_linked.
-000143c0: 0a20 2020 2020 2020 2023 2063 6861 6d62  .        # chamb
-000143d0: 6572 2070 726f 7065 7274 6965 730a 2020  er properties.  
-000143e0: 2020 2020 2020 6966 206b 6579 203d 3d20        if key == 
-000143f0: 2263 6861 6d62 6572 5f73 7461 7465 223a  "chamber_state":
-00014400: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00014410: 7572 6e20 7365 6c66 2e63 6f6e 6e65 6374  urn self.connect
-00014420: 696f 6e2e 7661 6375 756d 2e63 6861 6d62  ion.vacuum.chamb
-00014430: 6572 5f73 7461 7465 0a20 2020 2020 2020  er_state.       
-00014440: 200a 2020 2020 2020 2020 6966 206b 6579   .        if key
-00014450: 203d 3d20 2263 6861 6d62 6572 5f70 7265   == "chamber_pre
-00014460: 7373 7572 6522 3a0a 2020 2020 2020 2020  ssure":.        
-00014470: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
-00014480: 636f 6e6e 6563 7469 6f6e 2e76 6163 7575  connection.vacuu
-00014490: 6d2e 6368 616d 6265 725f 7072 6573 7375  m.chamber_pressu
-000144a0: 7265 2e76 616c 7565 0a0a 2020 2020 2020  re.value..      
-000144b0: 2020 2320 6465 7465 6374 6f72 206d 6f64    # detector mod
-000144c0: 6520 616e 6420 7479 7065 0a20 2020 2020  e and type.     
-000144d0: 2020 2069 6620 6b65 7920 696e 205b 2264     if key in ["d
-000144e0: 6574 6563 746f 725f 6d6f 6465 222c 2022  etector_mode", "
-000144f0: 6465 7465 6374 6f72 5f74 7970 6522 2c20  detector_type", 
-00014500: 2264 6574 6563 746f 725f 6272 6967 6874  "detector_bright
-00014510: 6e65 7373 222c 2022 6465 7465 6374 6f72  ness", "detector
-00014520: 5f63 6f6e 7472 6173 7422 5d3a 0a20 2020  _contrast"]:.   
-00014530: 2020 2020 2020 2020 200a 2020 2020 2020           .      
-00014540: 2020 2020 2020 2320 7365 7420 6265 616d        # set beam
-00014550: 2061 6374 6976 6520 7669 6577 2061 6e64   active view and
-00014560: 2064 6576 6963 650a 2020 2020 2020 2020   device.        
-00014570: 2020 2020 7365 6c66 2e63 6f6e 6e65 6374      self.connect
-00014580: 696f 6e2e 696d 6167 696e 672e 7365 745f  ion.imaging.set_
-00014590: 6163 7469 7665 5f76 6965 7728 6265 616d  active_view(beam
-000145a0: 5f74 7970 652e 7661 6c75 6529 0a20 2020  _type.value).   
-000145b0: 2020 2020 2020 2020 2073 656c 662e 636f           self.co
-000145c0: 6e6e 6563 7469 6f6e 2e69 6d61 6769 6e67  nnection.imaging
-000145d0: 2e73 6574 5f61 6374 6976 655f 6465 7669  .set_active_devi
-000145e0: 6365 2862 6561 6d5f 7479 7065 2e76 616c  ce(beam_type.val
-000145f0: 7565 290a 0a20 2020 2020 2020 2020 2020  ue)..           
-00014600: 2069 6620 6b65 7920 3d3d 2022 6465 7465   if key == "dete
-00014610: 6374 6f72 5f74 7970 6522 3a0a 2020 2020  ctor_type":.    
-00014620: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00014630: 726e 2073 656c 662e 636f 6e6e 6563 7469  rn self.connecti
-00014640: 6f6e 2e64 6574 6563 746f 722e 7479 7065  on.detector.type
-00014650: 2e76 616c 7565 0a20 2020 2020 2020 2020  .value.         
-00014660: 2020 2069 6620 6b65 7920 3d3d 2022 6465     if key == "de
-00014670: 7465 6374 6f72 5f6d 6f64 6522 3a0a 2020  tector_mode":.  
-00014680: 2020 2020 2020 2020 2020 2020 2020 7265                re
-00014690: 7475 726e 2073 656c 662e 636f 6e6e 6563  turn self.connec
-000146a0: 7469 6f6e 2e64 6574 6563 746f 722e 6d6f  tion.detector.mo
-000146b0: 6465 2e76 616c 7565 0a20 2020 2020 2020  de.value.       
-000146c0: 2020 2020 2069 6620 6b65 7920 3d3d 2022       if key == "
-000146d0: 6465 7465 6374 6f72 5f62 7269 6768 746e  detector_brightn
-000146e0: 6573 7322 3a0a 2020 2020 2020 2020 2020  ess":.          
-000146f0: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
-00014700: 662e 636f 6e6e 6563 7469 6f6e 2e64 6574  f.connection.det
-00014710: 6563 746f 722e 6272 6967 6874 6e65 7373  ector.brightness
-00014720: 2e76 616c 7565 0a20 2020 2020 2020 2020  .value.         
-00014730: 2020 2069 6620 6b65 7920 3d3d 2022 6465     if key == "de
-00014740: 7465 6374 6f72 5f63 6f6e 7472 6173 7422  tector_contrast"
-00014750: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00014760: 2020 7265 7475 726e 2073 656c 662e 636f    return self.co
-00014770: 6e6e 6563 7469 6f6e 2e64 6574 6563 746f  nnection.detecto
-00014780: 722e 636f 6e74 7261 7374 2e76 616c 7565  r.contrast.value
-00014790: 0a0a 2020 2020 2020 2020 2320 6d61 6e69  ..        # mani
-000147a0: 7075 6c61 746f 7220 7072 6f70 6572 7469  pulator properti
-000147b0: 6573 0a20 2020 2020 2020 2069 6620 6b65  es.        if ke
-000147c0: 7920 3d3d 2022 6d61 6e69 7075 6c61 746f  y == "manipulato
-000147d0: 725f 706f 7369 7469 6f6e 223a 0a20 2020  r_position":.   
-000147e0: 2020 2020 2020 2020 205f 6368 6563 6b5f           _check_
-000147f0: 6e65 6564 6c65 2873 656c 662e 6861 7264  needle(self.hard
-00014800: 7761 7265 5f73 6574 7469 6e67 7329 0a20  ware_settings). 
-00014810: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00014820: 6e20 7365 6c66 2e63 6f6e 6e65 6374 696f  n self.connectio
-00014830: 6e2e 7370 6563 696d 656e 2e6d 616e 6970  n.specimen.manip
-00014840: 756c 6174 6f72 2e63 7572 7265 6e74 5f70  ulator.current_p
-00014850: 6f73 6974 696f 6e0a 2020 2020 2020 2020  osition.        
-00014860: 6966 206b 6579 203d 3d20 226d 616e 6970  if key == "manip
-00014870: 756c 6174 6f72 5f73 7461 7465 223a 0a20  ulator_state":. 
-00014880: 2020 2020 2020 2020 2020 205f 6368 6563             _chec
-00014890: 6b5f 6e65 6564 6c65 2873 656c 662e 6861  k_needle(self.ha
-000148a0: 7264 7761 7265 5f73 6574 7469 6e67 7329  rdware_settings)
-000148b0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-000148c0: 7572 6e20 7365 6c66 2e63 6f6e 6e65 6374  urn self.connect
-000148d0: 696f 6e2e 7370 6563 696d 656e 2e6d 616e  ion.specimen.man
-000148e0: 6970 756c 6174 6f72 2e73 7461 7465 0a20  ipulator.state. 
-000148f0: 2020 2020 2020 200a 2020 2020 2020 2020         .        
-00014900: 6c6f 6767 696e 672e 7761 726e 696e 6728  logging.warning(
-00014910: 6622 556e 6b6e 6f77 6e20 6b65 793a 207b  f"Unknown key: {
-00014920: 6b65 797d 2028 7b62 6561 6d5f 7479 7065  key} ({beam_type
-00014930: 7d29 2229 0a20 2020 2020 2020 2072 6574  })").        ret
-00014940: 7572 6e20 4e6f 6e65 2020 2020 0a0a 2020  urn None    ..  
-00014950: 2020 6465 6620 7365 7428 7365 6c66 2c20    def set(self, 
-00014960: 6b65 793a 2073 7472 2c20 7661 6c75 652c  key: str, value,
-00014970: 2062 6561 6d5f 7479 7065 3a20 4265 616d   beam_type: Beam
-00014980: 5479 7065 203d 2042 6561 6d54 7970 652e  Type = BeamType.
-00014990: 454c 4543 5452 4f4e 2920 2d3e 204e 6f6e  ELECTRON) -> Non
-000149a0: 653a 0a0a 2020 2020 2020 2020 2320 6765  e:..        # ge
-000149b0: 7420 6265 616d 0a20 2020 2020 2020 2062  t beam.        b
-000149c0: 6561 6d20 3d20 7365 6c66 2e63 6f6e 6e65  eam = self.conne
-000149d0: 6374 696f 6e2e 6265 616d 732e 656c 6563  ction.beams.elec
-000149e0: 7472 6f6e 5f62 6561 6d20 6966 2062 6561  tron_beam if bea
-000149f0: 6d5f 7479 7065 203d 3d20 4265 616d 5479  m_type == BeamTy
-00014a00: 7065 2e45 4c45 4354 524f 4e20 656c 7365  pe.ELECTRON else
-00014a10: 2073 656c 662e 636f 6e6e 6563 7469 6f6e   self.connection
-00014a20: 2e62 6561 6d73 2e69 6f6e 5f62 6561 6d0a  .beams.ion_beam.
-00014a30: 0a20 2020 2020 2020 2023 2062 6561 6d20  .        # beam 
-00014a40: 7072 6f70 6572 7469 6573 0a20 2020 2020  properties.     
-00014a50: 2020 2069 6620 6b65 7920 3d3d 2022 776f     if key == "wo
-00014a60: 726b 696e 675f 6469 7374 616e 6365 223a  rking_distance":
-00014a70: 0a20 2020 2020 2020 2020 2020 205f 6368  .            _ch
-00014a80: 6563 6b5f 6265 616d 2862 6561 6d5f 7479  eck_beam(beam_ty
-00014a90: 7065 2c20 7365 6c66 2e68 6172 6477 6172  pe, self.hardwar
-00014aa0: 655f 7365 7474 696e 6773 290a 2020 2020  e_settings).    
-00014ab0: 2020 2020 2020 2020 6265 616d 2e77 6f72          beam.wor
-00014ac0: 6b69 6e67 5f64 6973 7461 6e63 652e 7661  king_distance.va
-00014ad0: 6c75 6520 3d20 7661 6c75 650a 2020 2020  lue = value.    
-00014ae0: 2020 2020 2020 2020 7365 6c66 2e63 6f6e          self.con
-00014af0: 6e65 6374 696f 6e2e 7370 6563 696d 656e  nection.specimen
-00014b00: 2e73 7461 6765 2e6c 696e 6b28 2920 2320  .stage.link() # 
-00014b10: 4c69 6e6b 2074 6865 2073 7065 6369 6d65  Link the specime
-00014b20: 6e20 7374 6167 650a 2020 2020 2020 2020  n stage.        
-00014b30: 2020 2020 6c6f 6767 696e 672e 696e 666f      logging.info
-00014b40: 2866 227b 6265 616d 5f74 7970 652e 6e61  (f"{beam_type.na
-00014b50: 6d65 7d20 776f 726b 696e 6720 6469 7374  me} working dist
-00014b60: 616e 6365 2073 6574 2074 6f20 7b76 616c  ance set to {val
-00014b70: 7565 7d20 6d2e 2229 0a20 2020 2020 2020  ue} m.").       
-00014b80: 2020 2020 2072 6574 7572 6e20 0a20 2020       return .   
-00014b90: 2020 2020 2069 6620 6b65 7920 3d3d 2022       if key == "
-00014ba0: 6375 7272 656e 7422 3a0a 2020 2020 2020  current":.      
-00014bb0: 2020 2020 2020 5f63 6865 636b 5f62 6561        _check_bea
-00014bc0: 6d28 6265 616d 5f74 7970 652c 2073 656c  m(beam_type, sel
-00014bd0: 662e 6861 7264 7761 7265 5f73 6574 7469  f.hardware_setti
-00014be0: 6e67 7329 0a20 2020 2020 2020 2020 2020  ngs).           
-00014bf0: 2062 6561 6d2e 6265 616d 5f63 7572 7265   beam.beam_curre
-00014c00: 6e74 2e76 616c 7565 203d 2076 616c 7565  nt.value = value
-00014c10: 0a20 2020 2020 2020 2020 2020 206c 6f67  .            log
-00014c20: 6769 6e67 2e69 6e66 6f28 6622 7b62 6561  ging.info(f"{bea
-00014c30: 6d5f 7479 7065 2e6e 616d 657d 2063 7572  m_type.name} cur
-00014c40: 7265 6e74 2073 6574 2074 6f20 7b76 616c  rent set to {val
-00014c50: 7565 7d20 412e 2229 0a20 2020 2020 2020  ue} A.").       
-00014c60: 2020 2020 2072 6574 7572 6e0a 2020 2020       return.    
-00014c70: 2020 2020 6966 206b 6579 203d 3d20 2276      if key == "v
-00014c80: 6f6c 7461 6765 223a 0a20 2020 2020 2020  oltage":.       
-00014c90: 2020 2020 205f 6368 6563 6b5f 6265 616d       _check_beam
-00014ca0: 2862 6561 6d5f 7479 7065 2c20 7365 6c66  (beam_type, self
-00014cb0: 2e68 6172 6477 6172 655f 7365 7474 696e  .hardware_settin
-00014cc0: 6773 290a 2020 2020 2020 2020 2020 2020  gs).            
-00014cd0: 6265 616d 2e68 6967 685f 766f 6c74 6167  beam.high_voltag
-00014ce0: 652e 7661 6c75 6520 3d20 7661 6c75 650a  e.value = value.
-00014cf0: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
-00014d00: 696e 672e 696e 666f 2866 227b 6265 616d  ing.info(f"{beam
-00014d10: 5f74 7970 652e 6e61 6d65 7d20 766f 6c74  _type.name} volt
-00014d20: 6167 6520 7365 7420 746f 207b 7661 6c75  age set to {valu
-00014d30: 657d 2056 2e22 290a 2020 2020 2020 2020  e} V.").        
-00014d40: 2020 2020 7265 7475 726e 0a20 2020 2020      return.     
-00014d50: 2020 2069 6620 6b65 7920 3d3d 2022 6866     if key == "hf
-00014d60: 7722 3a0a 2020 2020 2020 2020 2020 2020  w":.            
-00014d70: 5f63 6865 636b 5f62 6561 6d28 6265 616d  _check_beam(beam
-00014d80: 5f74 7970 652c 2073 656c 662e 6861 7264  _type, self.hard
-00014d90: 7761 7265 5f73 6574 7469 6e67 7329 0a20  ware_settings). 
-00014da0: 2020 2020 2020 2020 2020 2062 6561 6d2e             beam.
-00014db0: 686f 7269 7a6f 6e74 616c 5f66 6965 6c64  horizontal_field
-00014dc0: 5f77 6964 7468 2e76 616c 7565 203d 2076  _width.value = v
-00014dd0: 616c 7565 0a20 2020 2020 2020 2020 2020  alue.           
-00014de0: 206c 6f67 6769 6e67 2e69 6e66 6f28 6622   logging.info(f"
-00014df0: 7b62 6561 6d5f 7479 7065 2e6e 616d 657d  {beam_type.name}
-00014e00: 2048 4657 2073 6574 2074 6f20 7b76 616c   HFW set to {val
-00014e10: 7565 7d20 6d2e 2229 0a20 2020 2020 2020  ue} m.").       
-00014e20: 2020 2020 2072 6574 7572 6e0a 2020 2020       return.    
-00014e30: 2020 2020 6966 206b 6579 203d 3d20 2272      if key == "r
-00014e40: 6573 6f6c 7574 696f 6e22 3a0a 2020 2020  esolution":.    
-00014e50: 2020 2020 2020 2020 5f63 6865 636b 5f62          _check_b
-00014e60: 6561 6d28 6265 616d 5f74 7970 652c 2073  eam(beam_type, s
-00014e70: 656c 662e 6861 7264 7761 7265 5f73 6574  elf.hardware_set
-00014e80: 7469 6e67 7329 0a20 2020 2020 2020 2020  tings).         
-00014e90: 2020 2062 6561 6d2e 7363 616e 6e69 6e67     beam.scanning
-00014ea0: 2e72 6573 6f6c 7574 696f 6e2e 7661 6c75  .resolution.valu
-00014eb0: 6520 3d20 7661 6c75 650a 2020 2020 2020  e = value.      
-00014ec0: 2020 2020 2020 6c6f 6767 696e 672e 696e        logging.in
-00014ed0: 666f 2866 227b 6265 616d 5f74 7970 652e  fo(f"{beam_type.
-00014ee0: 6e61 6d65 7d20 7265 736f 6c75 7469 6f6e  name} resolution
-00014ef0: 2073 6574 2074 6f20 7b76 616c 7565 7d20   set to {value} 
-00014f00: 6d2e 2229 0a20 2020 2020 2020 2020 2020  m.").           
-00014f10: 2072 6574 7572 6e0a 2020 2020 2020 2020   return.        
-00014f20: 6966 206b 6579 203d 3d20 2264 7765 6c6c  if key == "dwell
-00014f30: 5f74 696d 6522 3a0a 2020 2020 2020 2020  _time":.        
-00014f40: 2020 2020 5f63 6865 636b 5f62 6561 6d28      _check_beam(
-00014f50: 6265 616d 5f74 7970 652c 2073 656c 662e  beam_type, self.
-00014f60: 6861 7264 7761 7265 5f73 6574 7469 6e67  hardware_setting
-00014f70: 7329 0a20 2020 2020 2020 2020 2020 2062  s).            b
-00014f80: 6561 6d2e 7363 616e 6e69 6e67 2e64 7765  eam.scanning.dwe
-00014f90: 6c6c 5f74 696d 652e 7661 6c75 6520 3d20  ll_time.value = 
-00014fa0: 7661 6c75 650a 2020 2020 2020 2020 2020  value.          
-00014fb0: 2020 6c6f 6767 696e 672e 696e 666f 2866    logging.info(f
-00014fc0: 227b 6265 616d 5f74 7970 652e 6e61 6d65  "{beam_type.name
-00014fd0: 7d20 6477 656c 6c20 7469 6d65 2073 6574  } dwell time set
-00014fe0: 2074 6f20 7b76 616c 7565 7d20 732e 2229   to {value} s.")
-00014ff0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00015000: 7572 6e0a 2020 2020 2020 2020 6966 206b  urn.        if k
-00015010: 6579 203d 3d20 2273 6361 6e5f 726f 7461  ey == "scan_rota
-00015020: 7469 6f6e 223a 0a20 2020 2020 2020 2020  tion":.         
-00015030: 2020 205f 6368 6563 6b5f 6265 616d 2862     _check_beam(b
-00015040: 6561 6d5f 7479 7065 2c20 7365 6c66 2e68  eam_type, self.h
-00015050: 6172 6477 6172 655f 7365 7474 696e 6773  ardware_settings
-00015060: 290a 2020 2020 2020 2020 2020 2020 6265  ).            be
-00015070: 616d 2e73 6361 6e6e 696e 672e 726f 7461  am.scanning.rota
-00015080: 7469 6f6e 2e76 616c 7565 203d 2076 616c  tion.value = val
-00015090: 7565 0a20 2020 2020 2020 2020 2020 206c  ue.            l
-000150a0: 6f67 6769 6e67 2e69 6e66 6f28 6622 7b62  ogging.info(f"{b
-000150b0: 6561 6d5f 7479 7065 2e6e 616d 657d 2073  eam_type.name} s
-000150c0: 6361 6e20 726f 7461 7469 6f6e 2073 6574  can rotation set
-000150d0: 2074 6f20 7b76 616c 7565 7d20 6465 6772   to {value} degr
-000150e0: 6565 732e 2229 0a20 2020 2020 2020 2020  ees.").         
-000150f0: 2020 2072 6574 7572 6e0a 2020 2020 2020     return.      
-00015100: 2020 6966 206b 6579 203d 3d20 2273 6869    if key == "shi
-00015110: 6674 223a 0a20 2020 2020 2020 2020 2020  ft":.           
-00015120: 205f 6368 6563 6b5f 6265 616d 2862 6561   _check_beam(bea
-00015130: 6d5f 7479 7065 2c20 7365 6c66 2e68 6172  m_type, self.har
-00015140: 6477 6172 655f 7365 7474 696e 6773 290a  dware_settings).
-00015150: 2020 2020 2020 2020 2020 2020 6265 616d              beam
-00015160: 2e62 6561 6d5f 7368 6966 742e 7661 6c75  .beam_shift.valu
-00015170: 652e 7820 3d20 7661 6c75 652e 780a 2020  e.x = value.x.  
-00015180: 2020 2020 2020 2020 2020 6265 616d 2e62            beam.b
-00015190: 6561 6d5f 7368 6966 742e 7661 6c75 652e  eam_shift.value.
-000151a0: 7820 3d20 7661 6c75 652e 790a 2020 2020  x = value.y.    
-000151b0: 2020 2020 2020 2020 6c6f 6767 696e 672e          logging.
-000151c0: 696e 666f 2866 227b 6265 616d 5f74 7970  info(f"{beam_typ
-000151d0: 652e 6e61 6d65 7d20 7368 6966 7420 7365  e.name} shift se
-000151e0: 7420 746f 207b 7661 6c75 657d 2e22 290a  t to {value}.").
-000151f0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00015200: 726e 0a20 2020 2020 2020 2069 6620 6b65  rn.        if ke
-00015210: 7920 3d3d 2022 7374 6967 6d61 7469 6f6e  y == "stigmation
-00015220: 223a 0a20 2020 2020 2020 2020 2020 205f  ":.            _
-00015230: 6368 6563 6b5f 6265 616d 2862 6561 6d5f  check_beam(beam_
-00015240: 7479 7065 2c20 7365 6c66 2e68 6172 6477  type, self.hardw
-00015250: 6172 655f 7365 7474 696e 6773 290a 2020  are_settings).  
-00015260: 2020 2020 2020 2020 2020 6265 616d 2e73            beam.s
-00015270: 7469 676d 6174 6f72 2e76 616c 7565 2e78  tigmator.value.x
-00015280: 203d 2076 616c 7565 2e78 0a20 2020 2020   = value.x.     
-00015290: 2020 2020 2020 2062 6561 6d2e 7374 6967         beam.stig
-000152a0: 6d61 746f 722e 7661 6c75 652e 7920 3d20  mator.value.y = 
-000152b0: 7661 6c75 652e 790a 2020 2020 2020 2020  value.y.        
-000152c0: 2020 2020 6c6f 6767 696e 672e 696e 666f      logging.info
-000152d0: 2866 227b 6265 616d 5f74 7970 652e 6e61  (f"{beam_type.na
-000152e0: 6d65 7d20 7374 6967 6d61 7469 6f6e 2073  me} stigmation s
-000152f0: 6574 2074 6f20 7b76 616c 7565 7d2e 2229  et to {value}.")
-00015300: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00015310: 7572 6e0a 0a20 2020 2020 2020 2023 2062  urn..        # b
-00015320: 6561 6d20 636f 6e74 726f 6c0a 2020 2020  eam control.    
-00015330: 2020 2020 6966 206b 6579 203d 3d20 226f      if key == "o
-00015340: 6e22 3a0a 2020 2020 2020 2020 2020 2020  n":.            
-00015350: 5f63 6865 636b 5f62 6561 6d28 6265 616d  _check_beam(beam
-00015360: 5f74 7970 652c 2073 656c 662e 6861 7264  _type, self.hard
-00015370: 7761 7265 5f73 6574 7469 6e67 7329 0a20  ware_settings). 
-00015380: 2020 2020 2020 2020 2020 2062 6561 6d2e             beam.
-00015390: 7475 726e 5f6f 6e28 2920 6966 2076 616c  turn_on() if val
-000153a0: 7565 2065 6c73 6520 6265 616d 2e74 7572  ue else beam.tur
-000153b0: 6e5f 6f66 6628 290a 2020 2020 2020 2020  n_off().        
-000153c0: 2020 2020 6c6f 6767 696e 672e 696e 666f      logging.info
-000153d0: 2866 227b 6265 616d 5f74 7970 652e 6e61  (f"{beam_type.na
-000153e0: 6d65 7d20 6265 616d 2074 7572 6e65 6420  me} beam turned 
-000153f0: 7b27 6f6e 2720 6966 2076 616c 7565 2065  {'on' if value e
-00015400: 6c73 6520 276f 6666 277d 2e22 290a 2020  lse 'off'}.").  
-00015410: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00015420: 0a20 2020 2020 2020 2069 6620 6b65 7920  .        if key 
-00015430: 3d3d 2022 626c 616e 6b65 6422 3a0a 2020  == "blanked":.  
-00015440: 2020 2020 2020 2020 2020 5f63 6865 636b            _check
-00015450: 5f62 6561 6d28 6265 616d 5f74 7970 652c  _beam(beam_type,
-00015460: 2073 656c 662e 6861 7264 7761 7265 5f73   self.hardware_s
-00015470: 6574 7469 6e67 7329 0a20 2020 2020 2020  ettings).       
-00015480: 2020 2020 2062 6561 6d2e 626c 616e 6b28       beam.blank(
-00015490: 2920 6966 2076 616c 7565 2065 6c73 6520  ) if value else 
-000154a0: 6265 616d 2e75 6e62 6c61 6e6b 2829 0a20  beam.unblank(). 
-000154b0: 2020 2020 2020 2020 2020 206c 6f67 6769             loggi
-000154c0: 6e67 2e69 6e66 6f28 6622 7b62 6561 6d5f  ng.info(f"{beam_
-000154d0: 7479 7065 2e6e 616d 657d 2062 6561 6d20  type.name} beam 
-000154e0: 7b27 626c 616e 6b65 6427 2069 6620 7661  {'blanked' if va
-000154f0: 6c75 6520 656c 7365 2027 756e 626c 616e  lue else 'unblan
-00015500: 6b65 6427 7d2e 2229 0a20 2020 2020 2020  ked'}.").       
-00015510: 2020 2020 2072 6574 7572 6e0a 0a20 2020       return..   
-00015520: 2020 2020 2023 2064 6574 6563 746f 7220       # detector 
-00015530: 7072 6f70 6572 7469 6573 0a20 2020 2020  properties.     
-00015540: 2020 2069 6620 6b65 7920 696e 205b 2264     if key in ["d
-00015550: 6574 6563 746f 725f 6d6f 6465 222c 2022  etector_mode", "
-00015560: 6465 7465 6374 6f72 5f74 7970 6522 2c20  detector_type", 
-00015570: 2264 6574 6563 746f 725f 6272 6967 6874  "detector_bright
-00015580: 6e65 7373 222c 2022 6465 7465 6374 6f72  ness", "detector
-00015590: 5f63 6f6e 7472 6173 7422 5d3a 0a20 2020  _contrast"]:.   
-000155a0: 2020 2020 2020 2020 2023 2073 6574 2062           # set b
-000155b0: 6561 6d20 6163 7469 7665 2076 6965 7720  eam active view 
-000155c0: 616e 6420 6465 7669 6365 0a20 2020 2020  and device.     
-000155d0: 2020 2020 2020 2073 656c 662e 636f 6e6e         self.conn
-000155e0: 6563 7469 6f6e 2e69 6d61 6769 6e67 2e73  ection.imaging.s
-000155f0: 6574 5f61 6374 6976 655f 7669 6577 2862  et_active_view(b
-00015600: 6561 6d5f 7479 7065 2e76 616c 7565 290a  eam_type.value).
-00015610: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00015620: 2e63 6f6e 6e65 6374 696f 6e2e 696d 6167  .connection.imag
-00015630: 696e 672e 7365 745f 6163 7469 7665 5f64  ing.set_active_d
-00015640: 6576 6963 6528 6265 616d 5f74 7970 652e  evice(beam_type.
-00015650: 7661 6c75 6529 0a0a 2020 2020 2020 2020  value)..        
-00015660: 2020 2020 6966 206b 6579 203d 3d20 2264      if key == "d
-00015670: 6574 6563 746f 725f 6d6f 6465 223a 0a20  etector_mode":. 
-00015680: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00015690: 6620 7661 6c75 6520 696e 2073 656c 662e  f value in self.
-000156a0: 636f 6e6e 6563 7469 6f6e 2e64 6574 6563  connection.detec
-000156b0: 746f 722e 6d6f 6465 2e61 7661 696c 6162  tor.mode.availab
-000156c0: 6c65 5f76 616c 7565 733a 0a20 2020 2020  le_values:.     
-000156d0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-000156e0: 656c 662e 636f 6e6e 6563 7469 6f6e 2e64  elf.connection.d
-000156f0: 6574 6563 746f 722e 6d6f 6465 2e76 616c  etector.mode.val
-00015700: 7565 203d 2076 616c 7565 0a20 2020 2020  ue = value.     
-00015710: 2020 2020 2020 2020 2020 2020 2020 206c                 l
-00015720: 6f67 6769 6e67 2e69 6e66 6f28 6622 4465  ogging.info(f"De
-00015730: 7465 6374 6f72 206d 6f64 6520 7365 7420  tector mode set 
-00015740: 746f 207b 7661 6c75 657d 2e22 290a 2020  to {value}.").  
-00015750: 2020 2020 2020 2020 2020 2020 2020 656c                el
-00015760: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00015770: 2020 2020 2020 2020 6c6f 6767 696e 672e          logging.
-00015780: 7761 726e 696e 6728 6622 4465 7465 6374  warning(f"Detect
-00015790: 6f72 206d 6f64 6520 7b76 616c 7565 7d20  or mode {value} 
-000157a0: 6e6f 7420 6176 6169 6c61 626c 652e 2229  not available.")
-000157b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000157c0: 2072 6574 7572 6e0a 2020 2020 2020 2020   return.        
-000157d0: 2020 2020 6966 206b 6579 203d 3d20 2264      if key == "d
-000157e0: 6574 6563 746f 725f 7479 7065 223a 0a20  etector_type":. 
-000157f0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00015800: 6620 7661 6c75 6520 696e 2073 656c 662e  f value in self.
-00015810: 636f 6e6e 6563 7469 6f6e 2e64 6574 6563  connection.detec
-00015820: 746f 722e 7479 7065 2e61 7661 696c 6162  tor.type.availab
-00015830: 6c65 5f76 616c 7565 733a 0a20 2020 2020  le_values:.     
-00015840: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00015850: 656c 662e 636f 6e6e 6563 7469 6f6e 2e64  elf.connection.d
-00015860: 6574 6563 746f 722e 7479 7065 2e76 616c  etector.type.val
-00015870: 7565 203d 2076 616c 7565 0a20 2020 2020  ue = value.     
-00015880: 2020 2020 2020 2020 2020 2020 2020 206c                 l
-00015890: 6f67 6769 6e67 2e69 6e66 6f28 6622 4465  ogging.info(f"De
-000158a0: 7465 6374 6f72 2074 7970 6520 7365 7420  tector type set 
-000158b0: 746f 207b 7661 6c75 657d 2e22 290a 2020  to {value}.").  
-000158c0: 2020 2020 2020 2020 2020 2020 2020 656c                el
-000158d0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-000158e0: 2020 2020 2020 2020 6c6f 6767 696e 672e          logging.
-000158f0: 7761 726e 696e 6728 6622 4465 7465 6374  warning(f"Detect
-00015900: 6f72 2074 7970 6520 7b76 616c 7565 7d20  or type {value} 
-00015910: 6e6f 7420 6176 6169 6c61 626c 652e 2229  not available.")
-00015920: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00015930: 2072 6574 7572 6e0a 2020 2020 2020 2020   return.        
-00015940: 2020 2020 6966 206b 6579 203d 3d20 2264      if key == "d
-00015950: 6574 6563 746f 725f 6272 6967 6874 6e65  etector_brightne
-00015960: 7373 223a 0a20 2020 2020 2020 2020 2020  ss":.           
-00015970: 2020 2020 2069 6620 3020 3c3d 2076 616c       if 0 <= val
-00015980: 7565 203c 3d20 3120 3a0a 2020 2020 2020  ue <= 1 :.      
-00015990: 2020 2020 2020 2020 2020 2020 2020 7365                se
-000159a0: 6c66 2e63 6f6e 6e65 6374 696f 6e2e 6465  lf.connection.de
-000159b0: 7465 6374 6f72 2e62 7269 6768 746e 6573  tector.brightnes
-000159c0: 732e 7661 6c75 6520 3d20 7661 6c75 650a  s.value = value.
-000159d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000159e0: 2020 2020 6c6f 6767 696e 672e 696e 666f      logging.info
-000159f0: 2866 2244 6574 6563 746f 7220 6272 6967  (f"Detector brig
-00015a00: 6874 6e65 7373 2073 6574 2074 6f20 7b76  htness set to {v
-00015a10: 616c 7565 7d2e 2229 0a20 2020 2020 2020  alue}.").       
-00015a20: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-00015a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015a40: 2020 206c 6f67 6769 6e67 2e77 6172 6e69     logging.warni
-00015a50: 6e67 2866 2244 6574 6563 746f 7220 6272  ng(f"Detector br
-00015a60: 6967 6874 6e65 7373 207b 7661 6c75 657d  ightness {value}
-00015a70: 206e 6f74 2061 7661 696c 6162 6c65 2c20   not available, 
-00015a80: 6d75 7374 2062 6520 6265 7477 6565 6e20  must be between 
-00015a90: 3020 616e 6420 312e 2229 0a20 2020 2020  0 and 1.").     
-00015aa0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00015ab0: 6e0a 2020 2020 2020 2020 2020 2020 6966  n.            if
-00015ac0: 206b 6579 203d 3d20 2264 6574 6563 746f   key == "detecto
-00015ad0: 725f 636f 6e74 7261 7374 223a 0a20 2020  r_contrast":.   
-00015ae0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00015af0: 3020 3c3d 2076 616c 7565 203c 3d20 3120  0 <= value <= 1 
-00015b00: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00015b10: 2020 2020 2020 7365 6c66 2e63 6f6e 6e65        self.conne
-00015b20: 6374 696f 6e2e 6465 7465 6374 6f72 2e63  ction.detector.c
-00015b30: 6f6e 7472 6173 742e 7661 6c75 6520 3d20  ontrast.value = 
-00015b40: 7661 6c75 650a 2020 2020 2020 2020 2020  value.          
-00015b50: 2020 2020 2020 2020 2020 6c6f 6767 696e            loggin
-00015b60: 672e 696e 666f 2866 2244 6574 6563 746f  g.info(f"Detecto
-00015b70: 7220 636f 6e74 7261 7374 2073 6574 2074  r contrast set t
-00015b80: 6f20 7b76 616c 7565 7d2e 2229 0a20 2020  o {value}.").   
-00015b90: 2020 2020 2020 2020 2020 2020 2065 6c73               els
-00015ba0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-00015bb0: 2020 2020 2020 206c 6f67 6769 6e67 2e77         logging.w
-00015bc0: 6172 6e69 6e67 2866 2244 6574 6563 746f  arning(f"Detecto
-00015bd0: 7220 636f 6e74 7261 7374 207b 7661 6c75  r contrast {valu
-00015be0: 657d 206e 6f74 2061 7661 696c 6162 6c65  e} not available
-00015bf0: 2c20 6d75 7420 6265 2062 6574 7765 656e  , mut be between
-00015c00: 2030 2061 6e64 2031 2e22 290a 2020 2020   0 and 1.").    
-00015c10: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00015c20: 726e 0a0a 2020 2020 2020 2020 2320 6f6e  rn..        # on
-00015c30: 6c79 2073 7570 706f 7274 6564 2066 6f72  ly supported for
-00015c40: 2045 6c65 6374 726f 6e0a 2020 2020 2020   Electron.      
-00015c50: 2020 6966 2062 6561 6d5f 7479 7065 2069    if beam_type i
-00015c60: 7320 4265 616d 5479 7065 2e45 4c45 4354  s BeamType.ELECT
-00015c70: 524f 4e3a 0a20 2020 2020 2020 2020 2020  RON:.           
-00015c80: 2069 6620 6b65 7920 3d3d 2022 616e 6775   if key == "angu
-00015c90: 6c61 725f 636f 7272 6563 7469 6f6e 5f61  lar_correction_a
-00015ca0: 6e67 6c65 223a 0a20 2020 2020 2020 2020  ngle":.         
-00015cb0: 2020 2020 2020 205f 6368 6563 6b5f 6265         _check_be
-00015cc0: 616d 2862 6561 6d5f 7479 7065 2c20 7365  am(beam_type, se
-00015cd0: 6c66 2e68 6172 6477 6172 655f 7365 7474  lf.hardware_sett
-00015ce0: 696e 6773 290a 2020 2020 2020 2020 2020  ings).          
-00015cf0: 2020 2020 2020 6265 616d 2e61 6e67 756c        beam.angul
-00015d00: 6172 5f63 6f72 7265 6374 696f 6e2e 616e  ar_correction.an
-00015d10: 676c 652e 7661 6c75 6520 3d20 7661 6c75  gle.value = valu
-00015d20: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
-00015d30: 2020 6c6f 6767 696e 672e 696e 666f 2866    logging.info(f
-00015d40: 2241 6e67 756c 6172 2063 6f72 7265 6374  "Angular correct
-00015d50: 696f 6e20 616e 676c 6520 7365 7420 746f  ion angle set to
-00015d60: 207b 7661 6c75 657d 2072 6164 6961 6e73   {value} radians
-00015d70: 2e22 290a 2020 2020 2020 2020 2020 2020  .").            
-00015d80: 2020 2020 7265 7475 726e 0a0a 2020 2020      return..    
-00015d90: 2020 2020 2020 2020 6966 206b 6579 203d          if key =
-00015da0: 3d20 2261 6e67 756c 6172 5f63 6f72 7265  = "angular_corre
-00015db0: 6374 696f 6e5f 7469 6c74 5f63 6f72 7265  ction_tilt_corre
-00015dc0: 6374 696f 6e22 3a0a 2020 2020 2020 2020  ction":.        
-00015dd0: 2020 2020 2020 2020 5f63 6865 636b 5f62          _check_b
-00015de0: 6561 6d28 6265 616d 5f74 7970 652c 2073  eam(beam_type, s
-00015df0: 656c 662e 6861 7264 7761 7265 5f73 6574  elf.hardware_set
-00015e00: 7469 6e67 7329 0a20 2020 2020 2020 2020  tings).         
-00015e10: 2020 2020 2020 2062 6561 6d2e 616e 6775         beam.angu
-00015e20: 6c61 725f 636f 7272 6563 7469 6f6e 2e74  lar_correction.t
-00015e30: 696c 745f 636f 7272 6563 7469 6f6e 2e74  ilt_correction.t
-00015e40: 7572 6e5f 6f6e 2829 2069 6620 7661 6c75  urn_on() if valu
-00015e50: 6520 656c 7365 2062 6561 6d2e 616e 6775  e else beam.angu
-00015e60: 6c61 725f 636f 7272 6563 7469 6f6e 2e74  lar_correction.t
-00015e70: 696c 745f 636f 7272 6563 7469 6f6e 2e74  ilt_correction.t
-00015e80: 7572 6e5f 6f66 6628 290a 2020 2020 2020  urn_off().      
-00015e90: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00015ea0: 0a20 2020 2020 2020 2069 6620 6265 616d  .        if beam
-00015eb0: 5f74 7970 6520 6973 2042 6561 6d54 7970  _type is BeamTyp
-00015ec0: 652e 494f 4e3a 0a20 2020 2020 2020 2020  e.ION:.         
-00015ed0: 2020 2069 6620 6b65 7920 3d3d 2022 706c     if key == "pl
-00015ee0: 6173 6d61 5f67 6173 223a 0a20 2020 2020  asma_gas":.     
-00015ef0: 2020 2020 2020 2020 2020 205f 6368 6563             _chec
-00015f00: 6b5f 6265 616d 2862 6561 6d5f 7479 7065  k_beam(beam_type
-00015f10: 2c20 7365 6c66 2e68 6172 6477 6172 655f  , self.hardware_
-00015f20: 7365 7474 696e 6773 290a 2020 2020 2020  settings).      
-00015f30: 2020 2020 2020 2020 2020 5f63 6865 636b            _check
-00015f40: 5f73 7075 7474 6572 2873 656c 662e 6861  _sputter(self.ha
-00015f50: 7264 7761 7265 5f73 6574 7469 6e67 7329  rdware_settings)
-00015f60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00015f70: 2062 6561 6d2e 736f 7572 6365 2e70 6c61   beam.source.pla
-00015f80: 736d 615f 6761 732e 7661 6c75 6520 3d20  sma_gas.value = 
-00015f90: 7661 6c75 650a 2020 2020 2020 2020 2020  value.          
-00015fa0: 2020 2020 2020 6c6f 6767 696e 672e 696e        logging.in
-00015fb0: 666f 2866 2250 6c61 736d 6120 6761 7320  fo(f"Plasma gas 
-00015fc0: 7365 7420 746f 207b 7661 6c75 657d 2e22  set to {value}."
-00015fd0: 290a 2020 2020 2020 2020 2020 2020 7265  ).            re
-00015fe0: 7475 726e 0a20 2020 2020 2020 2023 2063  turn.        # c
-00015ff0: 6861 6d62 6572 2063 6f6e 7472 6f6c 2028  hamber control (
-00016000: 4e4f 5445 3a20 646f 6e74 2069 6d70 6c6d  NOTE: dont implm
-00016010: 656e 7420 756e 7469 6c20 6162 6c65 2074  ent until able t
-00016020: 6f20 7465 7374 206f 6e20 6861 7264 7761  o test on hardwa
-00016030: 7265 290a 2020 2020 2020 2020 6966 206b  re).        if k
-00016040: 6579 203d 3d20 2270 756d 7022 3a0a 2020  ey == "pump":.  
-00016050: 2020 2020 2020 2020 2020 6c6f 6767 696e            loggin
-00016060: 672e 696e 666f 2866 224e 6f74 2049 6d70  g.info(f"Not Imp
-00016070: 6c65 6d65 6e74 6564 2059 6574 2229 0a20  lemented Yet"). 
-00016080: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00016090: 636f 6e6e 6563 7469 6f6e 2e76 6163 7575  connection.vacuu
-000160a0: 6d2e 7075 6d70 2829 0a20 2020 2020 2020  m.pump().       
-000160b0: 2020 2020 2023 206c 6f67 6769 6e67 2e69       # logging.i
-000160c0: 6e66 6f28 6622 5661 6375 756d 2070 756d  nfo(f"Vacuum pum
-000160d0: 7020 6f6e 2e22 290a 2020 2020 2020 2020  p on.").        
-000160e0: 2020 2020 7265 7475 726e 0a20 2020 2020      return.     
-000160f0: 2020 2069 6620 6b65 7920 3d3d 2022 7665     if key == "ve
-00016100: 6e74 223a 0a20 2020 2020 2020 2020 2020  nt":.           
-00016110: 206c 6f67 6769 6e67 2e69 6e66 6f28 6622   logging.info(f"
-00016120: 4e6f 7420 496d 706c 656d 656e 7465 6420  Not Implemented 
-00016130: 5965 7422 290a 2020 2020 2020 2020 2020  Yet").          
-00016140: 2020 2320 7365 6c66 2e63 6f6e 6e65 6374    # self.connect
-00016150: 696f 6e2e 7661 6375 756d 2e76 656e 7428  ion.vacuum.vent(
-00016160: 290a 2020 2020 2020 2020 2020 2020 6c6f  ).            lo
-00016170: 6767 696e 672e 696e 666f 2866 2256 6163  gging.info(f"Vac
-00016180: 7575 6d20 7665 6e74 206f 6e2e 2229 0a20  uum vent on."). 
-00016190: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-000161a0: 6e0a 0a0a 2020 2020 2020 2020 2320 7374  n...        # st
-000161b0: 6167 6520 7072 6f70 6572 7469 6573 0a20  age properties. 
-000161c0: 2020 2020 2020 2069 6620 6b65 7920 3d3d         if key ==
-000161d0: 2022 7374 6167 655f 686f 6d65 223a 0a20   "stage_home":. 
-000161e0: 2020 2020 2020 2020 2020 205f 6368 6563             _chec
-000161f0: 6b5f 7374 6167 6528 7365 6c66 2e68 6172  k_stage(self.har
-00016200: 6477 6172 655f 7365 7474 696e 6773 290a  dware_settings).
-00016210: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00016220: 2e63 6f6e 6e65 6374 696f 6e2e 7370 6563  .connection.spec
-00016230: 696d 656e 2e73 7461 6765 2e68 6f6d 6528  imen.stage.home(
-00016240: 290a 2020 2020 2020 2020 2020 2020 6c6f  ).            lo
-00016250: 6767 696e 672e 696e 666f 2866 2253 7461  gging.info(f"Sta
-00016260: 6765 2068 6f6d 6564 2e22 290a 2020 2020  ge homed.").    
-00016270: 2020 2020 2020 2020 7265 7475 726e 0a20          return. 
-00016280: 2020 2020 2020 2069 6620 6b65 7920 3d3d         if key ==
-00016290: 2022 7374 6167 655f 6c69 6e6b 223a 0a20   "stage_link":. 
-000162a0: 2020 2020 2020 2020 2020 205f 6368 6563             _chec
-000162b0: 6b5f 7374 6167 6528 7365 6c66 2e68 6172  k_stage(self.har
-000162c0: 6477 6172 655f 7365 7474 696e 6773 290a  dware_settings).
-000162d0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-000162e0: 2e63 6f6e 6e65 6374 696f 6e2e 7370 6563  .connection.spec
-000162f0: 696d 656e 2e73 7461 6765 2e6c 696e 6b28  imen.stage.link(
-00016300: 2920 6966 2076 616c 7565 2065 6c73 6520  ) if value else 
-00016310: 7365 6c66 2e63 6f6e 6e65 6374 696f 6e2e  self.connection.
-00016320: 7370 6563 696d 656e 2e73 7461 6765 2e75  specimen.stage.u
-00016330: 6e6c 696e 6b28 290a 2020 2020 2020 2020  nlink().        
-00016340: 2020 2020 6c6f 6767 696e 672e 696e 666f      logging.info
-00016350: 2866 2253 7461 6765 207b 276c 696e 6b65  (f"Stage {'linke
-00016360: 6427 2069 6620 7661 6c75 6520 656c 7365  d' if value else
-00016370: 2027 756e 6c69 6e6b 6564 277d 2e22 2920   'unlinked'}.") 
-00016380: 2020 200a 2020 2020 2020 2020 2020 2020     .            
-00016390: 7265 7475 726e 0a0a 2020 2020 2020 2020  return..        
-000163a0: 0a20 2020 2020 2020 206c 6f67 6769 6e67  .        logging
-000163b0: 2e77 6172 6e69 6e67 2866 2255 6e6b 6e6f  .warning(f"Unkno
-000163c0: 776e 206b 6579 3a20 7b6b 6579 7d20 287b  wn key: {key} ({
-000163d0: 6265 616d 5f74 7970 657d 2922 290a 2020  beam_type})").  
-000163e0: 2020 2020 2020 7265 7475 726e 0a20 2020        return.   
-000163f0: 200a 2020 2020 6465 6620 6368 6563 6b5f   .    def check_
-00016400: 6176 6169 6c61 626c 655f 7661 6c75 6573  available_values
-00016410: 2873 656c 662c 206b 6579 3a73 7472 2c20  (self, key:str, 
-00016420: 7661 6c75 6573 3a20 6c69 7374 2c20 6265  values: list, be
-00016430: 616d 5f74 7970 653a 2042 6561 6d54 7970  am_type: BeamTyp
-00016440: 6520 3d20 4e6f 6e65 2920 2d3e 2062 6f6f  e = None) -> boo
-00016450: 6c3a 0a0a 2020 2020 2020 2020 6176 6169  l:..        avai
-00016460: 6c61 626c 655f 7661 6c75 6573 203d 2073  lable_values = s
-00016470: 656c 662e 6765 745f 6176 6169 6c61 626c  elf.get_availabl
-00016480: 655f 7661 6c75 6573 286b 6579 2c20 6265  e_values(key, be
-00016490: 616d 5f74 7970 6529 0a0a 2020 2020 2020  am_type)..      
-000164a0: 2020 6966 2061 7661 696c 6162 6c65 5f76    if available_v
-000164b0: 616c 7565 7320 6973 204e 6f6e 653a 0a20  alues is None:. 
-000164c0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-000164d0: 6e20 4661 6c73 650a 2020 2020 2020 2020  n False.        
-000164e0: 0a20 2020 2020 2020 2066 6f72 2076 616c  .        for val
-000164f0: 7565 2069 6e20 7661 6c75 6573 3a0a 2020  ue in values:.  
-00016500: 2020 2020 2020 2020 2020 6966 2076 616c            if val
-00016510: 7565 206e 6f74 2069 6e20 6176 6169 6c61  ue not in availa
-00016520: 626c 655f 7661 6c75 6573 3a0a 2020 2020  ble_values:.    
-00016530: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00016540: 726e 2046 616c 7365 0a0a 2020 2020 2020  rn False..      
-00016550: 2020 2020 2020 6966 2069 7369 6e73 7461        if isinsta
-00016560: 6e63 6528 7661 6c75 652c 2066 6c6f 6174  nce(value, float
-00016570: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00016580: 2020 2069 6620 7661 6c75 6520 3c20 6d69     if value < mi
-00016590: 6e28 6176 6169 6c61 626c 655f 7661 6c75  n(available_valu
-000165a0: 6573 2920 6f72 2076 616c 7565 203e 206d  es) or value > m
-000165b0: 6178 2861 7661 696c 6162 6c65 5f76 616c  ax(available_val
-000165c0: 7565 7329 3a0a 2020 2020 2020 2020 2020  ues):.          
-000165d0: 2020 2020 2020 2020 2020 7265 7475 726e            return
-000165e0: 2046 616c 7365 0a20 2020 2020 2020 2072   False.        r
-000165f0: 6574 7572 6e20 5472 7565 0a20 2020 200a  eturn True.    .
-00016600: 2020 2020 6465 6620 686f 6d65 2873 656c      def home(sel
-00016610: 6629 202d 3e20 4e6f 6e65 3a0a 2020 2020  f) -> None:.    
-00016620: 2020 2020 6966 2073 656c 662e 6861 7264      if self.hard
-00016630: 7761 7265 5f73 6574 7469 6e67 732e 7374  ware_settings.st
-00016640: 6167 655f 656e 6162 6c65 6420 6973 2046  age_enabled is F
-00016650: 616c 7365 3a0a 2020 2020 2020 2020 2020  alse:.          
-00016660: 2020 7261 6973 6520 4e6f 7449 6d70 6c65    raise NotImple
-00016670: 6d65 6e74 6564 4572 726f 7228 2253 7461  mentedError("Sta
-00016680: 6765 206e 6f74 2065 6e61 626c 6564 2e22  ge not enabled."
-00016690: 290a 2020 2020 2020 2020 6c6f 6767 696e  ).        loggin
-000166a0: 672e 696e 666f 2866 2248 6f6d 696e 6720  g.info(f"Homing 
-000166b0: 7374 6167 652e 2229 0a20 2020 2020 2020  stage.").       
-000166c0: 2073 656c 662e 636f 6e6e 6563 7469 6f6e   self.connection
-000166d0: 2e73 7065 6369 6d65 6e2e 7374 6167 652e  .specimen.stage.
-000166e0: 686f 6d65 2829 0a20 2020 2020 2020 206c  home().        l
-000166f0: 6f67 6769 6e67 2e69 6e66 6f28 6622 5374  ogging.info(f"St
-00016700: 6167 6520 686f 6d65 642e 2229 0a0a 0a63  age homed.")...c
-00016710: 6c61 7373 2054 6573 6361 6e4d 6963 726f  lass TescanMicro
-00016720: 7363 6f70 6528 4669 6273 656d 4d69 6372  scope(FibsemMicr
-00016730: 6f73 636f 7065 293a 0a20 2020 2022 2222  oscope):.    """
-00016740: 0a20 2020 2041 2063 6c61 7373 2072 6570  .    A class rep
-00016750: 7265 7365 6e74 696e 6720 6120 5445 5343  resenting a TESC
-00016760: 414e 2046 4942 2d53 454d 206d 6963 726f  AN FIB-SEM micro
-00016770: 7363 6f70 652e 0a0a 2020 2020 5468 6973  scope...    This
-00016780: 2063 6c61 7373 2069 6e68 6572 6974 7320   class inherits 
-00016790: 6672 6f6d 2074 6865 2061 6273 7472 6163  from the abstrac
-000167a0: 7420 6261 7365 2063 6c61 7373 2060 4669  t base class `Fi
-000167b0: 6273 656d 4d69 6372 6f73 636f 7065 602c  bsemMicroscope`,
-000167c0: 2077 6869 6368 2064 6566 696e 6573 2074   which defines t
-000167d0: 6865 2063 6f72 6520 6675 6e63 7469 6f6e  he core function
-000167e0: 616c 6974 7920 6f66 2061 0a20 2020 206d  ality of a.    m
-000167f0: 6963 726f 7363 6f70 652e 2049 6e20 6164  icroscope. In ad
-00016800: 6469 7469 6f6e 2074 6f20 7468 6520 6d65  dition to the me
-00016810: 7468 6f64 7320 6465 6669 6e65 6420 696e  thods defined in
-00016820: 2074 6865 2062 6173 6520 636c 6173 732c   the base class,
-00016830: 2074 6869 7320 636c 6173 7320 7072 6f76   this class prov
-00016840: 6964 6573 2061 6464 6974 696f 6e61 6c20  ides additional 
-00016850: 6d65 7468 6f64 7320 7370 6563 6966 6963  methods specific
-00016860: 0a20 2020 2074 6f20 7468 6520 5445 5343  .    to the TESC
-00016870: 414e 2046 4942 2d53 454d 206d 6963 726f  AN FIB-SEM micro
-00016880: 7363 6f70 652e 0a0a 2020 2020 4174 7472  scope...    Attr
-00016890: 6962 7574 6573 3a0a 2020 2020 2020 2020  ibutes:.        
-000168a0: 636f 6e6e 6563 7469 6f6e 2028 4175 746f  connection (Auto
-000168b0: 6d61 7469 6f6e 293a 2054 6865 206d 6963  mation): The mic
-000168c0: 726f 7363 6f70 6520 636c 6965 6e74 2063  roscope client c
-000168d0: 6f6e 6e65 6374 696f 6e2e 0a20 2020 2020  onnection..     
-000168e0: 2020 2069 6f6e 5f64 6574 6563 746f 725f     ion_detector_
-000168f0: 6163 7469 7665 2028 4175 746f 6d61 7469  active (Automati
-00016900: 6f6e 2e46 4942 2e44 6574 6563 746f 7229  on.FIB.Detector)
-00016910: 3a20 5468 6520 6163 7469 7665 2069 6f6e  : The active ion
-00016920: 2062 6561 6d20 6465 7465 6374 6f72 2e0a   beam detector..
-00016930: 2020 2020 2020 2020 6c61 7374 5f69 6d61          last_ima
-00016940: 6765 5f65 6220 2846 6962 7365 6d49 6d61  ge_eb (FibsemIma
-00016950: 6765 293a 2041 2073 6176 6564 2063 6f70  ge): A saved cop
-00016960: 7920 6f66 2074 6865 206d 6f73 7420 7265  y of the most re
-00016970: 6365 6e74 2065 6c65 6374 726f 6e20 6265  cent electron be
-00016980: 616d 2069 6d61 6765 2e0a 2020 2020 2020  am image..      
-00016990: 2020 6c61 7374 5f69 6d61 6765 5f69 6220    last_image_ib 
-000169a0: 2846 6962 7365 6d49 6d61 6765 293a 2041  (FibsemImage): A
-000169b0: 2073 6176 6564 2063 6f70 7920 6f66 2074   saved copy of t
-000169c0: 6865 206d 6f73 7420 7265 6365 6e74 2069  he most recent i
-000169d0: 6f6e 2062 6561 6d20 696d 6167 652e 0a0a  on beam image...
-000169e0: 2020 2020 496e 6865 7269 7465 6420 4d65      Inherited Me
-000169f0: 7468 6f64 733a 0a20 2020 2020 2020 2063  thods:.        c
-00016a00: 6f6e 6e65 6374 5f74 6f5f 6d69 6372 6f73  onnect_to_micros
-00016a10: 636f 7065 2873 656c 662c 2069 705f 6164  cope(self, ip_ad
-00016a20: 6472 6573 733a 2073 7472 2c20 706f 7274  dress: str, port
-00016a30: 3a20 696e 7420 3d20 3735 3230 2920 2d3e  : int = 7520) ->
-00016a40: 204e 6f6e 653a 200a 2020 2020 2020 2020   None: .        
-00016a50: 2020 2020 436f 6e6e 6563 7420 746f 2061      Connect to a
-00016a60: 2054 6865 726d 6f20 4669 7368 6572 206d   Thermo Fisher m
-00016a70: 6963 726f 7363 6f70 6520 6174 2074 6865  icroscope at the
-00016a80: 2073 7065 6369 6669 6564 2049 5020 6164   specified IP ad
-00016a90: 6472 6573 7320 616e 6420 706f 7274 2e0a  dress and port..
-00016aa0: 0a20 2020 2020 2020 2064 6973 636f 6e6e  .        disconn
-00016ab0: 6563 7428 7365 6c66 2920 2d3e 204e 6f6e  ect(self) -> Non
-00016ac0: 653a 200a 2020 2020 2020 2020 2020 2020  e: .            
-00016ad0: 4469 7363 6f6e 6e65 6374 7320 7468 6520  Disconnects the 
-00016ae0: 6d69 6372 6f73 636f 7065 2063 6c69 656e  microscope clien
-00016af0: 7420 636f 6e6e 6563 7469 6f6e 2e0a 0a20  t connection... 
-00016b00: 2020 2020 2020 2061 6371 7569 7265 5f69         acquire_i
-00016b10: 6d61 6765 2873 656c 662c 2069 6d61 6765  mage(self, image
-00016b20: 5f73 6574 7469 6e67 733a 2049 6d61 6765  _settings: Image
-00016b30: 5365 7474 696e 6773 2920 2d3e 2046 6962  Settings) -> Fib
-00016b40: 7365 6d49 6d61 6765 3a20 0a20 2020 2020  semImage: .     
-00016b50: 2020 2020 2020 2041 6371 7569 7265 2061         Acquire a
-00016b60: 206e 6577 2069 6d61 6765 2077 6974 6820   new image with 
-00016b70: 7468 6520 7370 6563 6966 6965 6420 7365  the specified se
-00016b80: 7474 696e 6773 2e0a 0a20 2020 2020 2020  ttings...       
-00016b90: 206c 6173 745f 696d 6167 6528 7365 6c66   last_image(self
-00016ba0: 2c20 6265 616d 5f74 7970 653a 2042 6561  , beam_type: Bea
-00016bb0: 6d54 7970 6520 3d20 4265 616d 5479 7065  mType = BeamType
-00016bc0: 2e45 4c45 4354 524f 4e29 202d 3e20 4669  .ELECTRON) -> Fi
-00016bd0: 6273 656d 496d 6167 653a 200a 2020 2020  bsemImage: .    
-00016be0: 2020 2020 2020 2020 4765 7420 7468 6520          Get the 
-00016bf0: 6c61 7374 2070 7265 7669 6f75 736c 7920  last previously 
-00016c00: 6163 7175 6972 6564 2069 6d61 6765 2e0a  acquired image..
-00016c10: 0a20 2020 2020 2020 2061 7574 6f63 6f6e  .        autocon
-00016c20: 7472 6173 7428 7365 6c66 2c20 6265 616d  trast(self, beam
-00016c30: 5f74 7970 653d 4265 616d 5479 7065 2e45  _type=BeamType.E
-00016c40: 4c45 4354 524f 4e29 202d 3e20 4e6f 6e65  LECTRON) -> None
-00016c50: 3a20 0a20 2020 2020 2020 2020 2020 2041  : .            A
-00016c60: 7574 6f6d 6174 6963 616c 6c79 2061 646a  utomatically adj
-00016c70: 7573 7420 7468 6520 6d69 6372 6f73 636f  ust the microsco
-00016c80: 7065 2069 6d61 6765 2063 6f6e 7472 6173  pe image contras
-00016c90: 7420 666f 7220 7468 6520 7370 6563 6966  t for the specif
-00016ca0: 6965 6420 6265 616d 2074 7970 652e 0a0a  ied beam type...
-00016cb0: 2020 2020 2020 2020 6175 746f 5f66 6f63          auto_foc
-00016cc0: 7573 2873 656c 662c 2062 6561 6d5f 7479  us(self, beam_ty
-00016cd0: 7065 3a20 4265 616d 5479 7065 2920 2d3e  pe: BeamType) ->
-00016ce0: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-00016cf0: 2020 2041 7574 6f6d 6174 6963 616c 6c79     Automatically
-00016d00: 2061 646a 7573 7420 7468 6520 6d69 6372   adjust the micr
-00016d10: 6f73 636f 7065 2066 6f63 7573 2066 6f72  oscope focus for
-00016d20: 2074 6865 2073 7065 6369 6669 6564 2062   the specified b
-00016d30: 6561 6d20 7479 7065 2e0a 0a20 2020 2020  eam type...     
-00016d40: 2020 2072 6573 6574 5f62 6561 6d5f 7368     reset_beam_sh
-00016d50: 6966 7473 2873 656c 6629 202d 3e20 4e6f  ifts(self) -> No
-00016d60: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-00016d70: 5365 7420 7468 6520 6265 616d 2073 6869  Set the beam shi
-00016d80: 6674 2074 6f20 7a65 726f 2066 6f72 2074  ft to zero for t
-00016d90: 6865 2065 6c65 6374 726f 6e20 616e 6420  he electron and 
-00016da0: 696f 6e20 6265 616d 732e 0a20 2020 2020  ion beams..     
-00016db0: 2020 200a 2020 2020 2020 2020 6265 616d     .        beam
-00016dc0: 5f73 6869 6674 2873 656c 662c 2064 783a  _shift(self, dx:
-00016dd0: 2066 6c6f 6174 2c20 6479 3a20 666c 6f61   float, dy: floa
-00016de0: 742c 2020 6265 616d 5f74 7970 653a 2042  t,  beam_type: B
-00016df0: 6561 6d54 7970 6529 202d 3e20 4e6f 6e65  eamType) -> None
-00016e00: 3a0a 2020 2020 2020 2020 2020 2020 4164  :.            Ad
-00016e10: 6a75 7374 7320 7468 6520 6265 616d 2073  justs the beam s
-00016e20: 6869 6674 206f 6620 6769 7665 6e20 6265  hift of given be
-00016e30: 616d 2062 6173 6564 206f 6e20 7265 6c61  am based on rela
-00016e40: 7469 7665 2076 616c 7565 7320 7468 6174  tive values that
-00016e50: 2061 7265 2070 726f 7669 6465 642e 0a0a   are provided...
-00016e60: 2020 2020 2020 2020 6765 745f 7374 6167          get_stag
-00016e70: 655f 706f 7369 7469 6f6e 2873 656c 6629  e_position(self)
-00016e80: 202d 3e20 4669 6273 656d 5374 6167 6550   -> FibsemStageP
-00016e90: 6f73 6974 696f 6e3a 0a20 2020 2020 2020  osition:.       
-00016ea0: 2020 2020 2047 6574 2074 6865 2063 7572       Get the cur
-00016eb0: 7265 6e74 2073 7461 6765 2070 6f73 6974  rent stage posit
-00016ec0: 696f 6e2e 0a0a 2020 2020 2020 2020 6765  ion...        ge
-00016ed0: 745f 6375 7272 656e 745f 6d69 6372 6f73  t_current_micros
-00016ee0: 636f 7065 5f73 7461 7465 2873 656c 6629  cope_state(self)
-00016ef0: 202d 3e20 4d69 6372 6f73 636f 7065 5374   -> MicroscopeSt
-00016f00: 6174 653a 0a20 2020 2020 2020 2020 2020  ate:.           
-00016f10: 2047 6574 2074 6865 2063 7572 7265 6e74   Get the current
-00016f20: 206d 6963 726f 7363 6f70 6520 7374 6174   microscope stat
-00016f30: 650a 0a20 2020 2020 2020 206d 6f76 655f  e..        move_
-00016f40: 7374 6167 655f 6162 736f 6c75 7465 2873  stage_absolute(s
-00016f50: 656c 662c 2070 6f73 6974 696f 6e3a 2046  elf, position: F
-00016f60: 6962 7365 6d53 7461 6765 506f 7369 7469  ibsemStagePositi
-00016f70: 6f6e 293a 0a20 2020 2020 2020 2020 2020  on):.           
-00016f80: 204d 6f76 6520 7468 6520 7374 6167 6520   Move the stage 
-00016f90: 746f 2074 6865 2073 7065 6369 6669 6564  to the specified
-00016fa0: 2063 6f6f 7264 696e 6174 6573 2e0a 0a20   coordinates... 
-00016fb0: 2020 2020 2020 206d 6f76 655f 7374 6167         move_stag
-00016fc0: 655f 7265 6c61 7469 7665 2873 656c 662c  e_relative(self,
-00016fd0: 2070 6f73 6974 696f 6e3a 2046 6962 7365   position: Fibse
-00016fe0: 6d53 7461 6765 506f 7369 7469 6f6e 293a  mStagePosition):
-00016ff0: 0a20 2020 2020 2020 2020 2020 204d 6f76  .            Mov
-00017000: 6520 7468 6520 7374 6167 6520 6279 2074  e the stage by t
-00017010: 6865 2073 7065 6369 6669 6564 2072 656c  he specified rel
-00017020: 6174 6976 6520 6d6f 7665 2e0a 0a20 2020  ative move...   
-00017030: 2020 2020 2073 7461 626c 655f 6d6f 7665       stable_move
-00017040: 2873 656c 662c 2073 6574 7469 6e67 733a  (self, settings:
-00017050: 204d 6963 726f 7363 6f70 6553 6574 7469   MicroscopeSetti
-00017060: 6e67 732c 2064 783a 2066 6c6f 6174 2c20  ngs, dx: float, 
-00017070: 6479 3a20 666c 6f61 742c 2062 6561 6d5f  dy: float, beam_
-00017080: 7479 7065 3a20 4265 616d 5479 7065 2c29  type: BeamType,)
-00017090: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
-000170a0: 2020 2020 2020 4361 6c63 756c 6174 6520        Calculate 
-000170b0: 7468 6520 636f 7272 6563 7465 6420 7374  the corrected st
-000170c0: 6167 6520 6d6f 7665 6d65 6e74 7320 6261  age movements ba
-000170d0: 7365 6420 6f6e 2074 6865 2062 6561 6d5f  sed on the beam_
-000170e0: 7479 7065 2c20 616e 6420 7468 656e 206d  type, and then m
-000170f0: 6f76 6520 7468 6520 7374 6167 6520 7265  ove the stage re
-00017100: 6c61 7469 7665 6c79 2e0a 0a20 2020 2020  latively...     
-00017110: 2020 2065 7563 656e 7472 6963 5f6d 6f76     eucentric_mov
-00017120: 6528 7365 6c66 2c20 7365 7474 696e 6773  e(self, settings
-00017130: 3a20 4d69 6372 6f73 636f 7065 5365 7474  : MicroscopeSett
-00017140: 696e 6773 2c20 6479 3a20 666c 6f61 742c  ings, dy: float,
-00017150: 2073 7461 7469 635f 7764 3a20 626f 6f6c   static_wd: bool
-00017160: 203d 2054 7275 6529 202d 3e20 4e6f 6e65   = True) -> None
-00017170: 3a0a 2020 2020 2020 2020 2020 2020 4d6f  :.            Mo
-00017180: 7665 2074 6865 2073 7461 6765 2076 6572  ve the stage ver
-00017190: 7469 6361 6c6c 7920 746f 2063 6f72 7265  tically to corre
-000171a0: 6374 2065 7563 656e 7472 6963 2070 6f69  ct eucentric poi
-000171b0: 6e74 0a20 2020 2020 2020 200a 2020 2020  nt.        .    
-000171c0: 2020 2020 6d6f 7665 5f66 6c61 745f 746f      move_flat_to
-000171d0: 5f62 6561 6d28 7365 6c66 2c20 7365 7474  _beam(self, sett
-000171e0: 696e 6773 3a20 4d69 6372 6f73 636f 7065  ings: Microscope
-000171f0: 5365 7474 696e 6773 2c20 6265 616d 5f74  Settings, beam_t
-00017200: 7970 653a 2042 6561 6d54 7970 6520 3d20  ype: BeamType = 
-00017210: 4265 616d 5479 7065 2e45 4c45 4354 524f  BeamType.ELECTRO
-00017220: 4e29 3a0a 2020 2020 2020 2020 2020 2020  N):.            
-00017230: 4d61 6b65 2074 6865 2073 616d 706c 6520  Make the sample 
-00017240: 7375 7266 6163 6520 666c 6174 2074 6f20  surface flat to 
-00017250: 7468 6520 656c 6563 7472 6f6e 206f 7220  the electron or 
-00017260: 696f 6e20 6265 616d 2e0a 2020 2020 2020  ion beam..      
-00017270: 2020 6765 745f 6d61 6e69 7075 6c61 746f    get_manipulato
-00017280: 725f 706f 7369 7469 6f6e 2873 656c 6629  r_position(self)
-00017290: 202d 3e20 4669 6273 656d 4d61 6e69 7075   -> FibsemManipu
-000172a0: 6c61 746f 7250 6f73 6974 696f 6e3a 0a20  latorPosition:. 
-000172b0: 2020 2020 2020 2020 2020 2047 6574 2074             Get t
-000172c0: 6865 2063 7572 7265 6e74 206d 616e 6970  he current manip
-000172d0: 756c 6174 6f72 2070 6f73 6974 696f 6e2e  ulator position.
-000172e0: 0a20 2020 2020 2020 200a 2020 2020 2020  .        .      
-000172f0: 2020 696e 7365 7274 5f6d 616e 6970 756c    insert_manipul
-00017300: 6174 6f72 2873 656c 662c 206e 616d 653a  ator(self, name:
-00017310: 2073 7472 2920 2d3e 204e 6f6e 653a 0a20   str) -> None:. 
-00017320: 2020 2020 2020 2020 2020 2049 6e73 6572             Inser
-00017330: 7420 7468 6520 6d61 6e69 7075 6c61 746f  t the manipulato
-00017340: 7220 696e 746f 2074 6865 2073 616d 706c  r into the sampl
-00017350: 652e 0a20 2020 2020 2020 200a 2020 2020  e..        .    
-00017360: 2020 2020 7265 7472 6163 745f 6d61 6e69      retract_mani
-00017370: 7075 6c61 746f 7228 7365 6c66 2920 2d3e  pulator(self) ->
-00017380: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-00017390: 2020 2052 6574 7261 6374 2074 6865 206d     Retract the m
-000173a0: 616e 6970 756c 6174 6f72 2066 726f 6d20  anipulator from 
-000173b0: 7468 6520 7361 6d70 6c65 2e0a 0a20 2020  the sample...   
-000173c0: 2020 2020 206d 6f76 655f 6d61 6e69 7075       move_manipu
-000173d0: 6c61 746f 725f 7265 6c61 7469 7665 2873  lator_relative(s
-000173e0: 656c 662c 2070 6f73 6974 696f 6e3a 2046  elf, position: F
-000173f0: 6962 7365 6d4d 616e 6970 756c 6174 6f72  ibsemManipulator
-00017400: 506f 7369 7469 6f6e 2920 2d3e 204e 6f6e  Position) -> Non
-00017410: 653a 0a20 2020 2020 2020 2020 2020 204d  e:.            M
-00017420: 6f76 6520 7468 6520 6d61 6e69 7075 6c61  ove the manipula
-00017430: 746f 7220 6279 2074 6865 2073 7065 6369  tor by the speci
-00017440: 6669 6564 2072 656c 6174 6976 6520 6d6f  fied relative mo
-00017450: 7665 2e0a 2020 2020 2020 2020 0a20 2020  ve..        .   
-00017460: 2020 2020 206d 6f76 655f 6d61 6e69 7075       move_manipu
-00017470: 6c61 746f 725f 6162 736f 6c75 7465 2873  lator_absolute(s
-00017480: 656c 662c 2070 6f73 6974 696f 6e3a 2046  elf, position: F
-00017490: 6962 7365 6d4d 616e 6970 756c 6174 6f72  ibsemManipulator
-000174a0: 506f 7369 7469 6f6e 2920 2d3e 204e 6f6e  Position) -> Non
-000174b0: 653a 0a20 2020 2020 2020 2020 2020 204d  e:.            M
-000174c0: 6f76 6520 7468 6520 6d61 6e69 7075 6c61  ove the manipula
-000174d0: 746f 7220 746f 2074 6865 2073 7065 6369  tor to the speci
-000174e0: 6669 6564 2063 6f6f 7264 696e 6174 6573  fied coordinates
-000174f0: 2e0a 0a20 2020 2020 2020 206d 6f76 655f  ...        move_
-00017500: 6d61 6e69 7075 6c61 746f 725f 636f 7272  manipulator_corr
-00017510: 6563 7465 6428 7365 6c66 2c20 6478 3a20  ected(self, dx: 
-00017520: 666c 6f61 742c 2064 793a 2066 6c6f 6174  float, dy: float
-00017530: 2c20 6265 616d 5f74 7970 653a 2042 6561  , beam_type: Bea
-00017540: 6d54 7970 6529 202d 3e20 4e6f 6e65 3a0a  mType) -> None:.
-00017550: 2020 2020 2020 2020 2020 2020 4d6f 7665              Move
-00017560: 2074 6865 206d 616e 6970 756c 6174 6f72   the manipulator
-00017570: 2062 7920 7468 6520 7370 6563 6966 6965   by the specifie
-00017580: 6420 7265 6c61 7469 7665 206d 6f76 652c  d relative move,
-00017590: 2063 6f72 7265 6374 696e 6720 666f 7220   correcting for 
-000175a0: 7468 6520 6265 616d 2074 7970 652e 2020  the beam type.  
-000175b0: 2020 2020 0a0a 2020 2020 2020 2020 6d6f      ..        mo
-000175c0: 7665 5f6d 616e 6970 756c 6174 6f72 5f74  ve_manipulator_t
-000175d0: 6f5f 706f 7369 7469 6f6e 5f6f 6666 7365  o_position_offse
-000175e0: 7428 7365 6c66 2c20 6f66 6673 6574 3a20  t(self, offset: 
-000175f0: 4669 6273 656d 4d61 6e69 7075 6c61 746f  FibsemManipulato
-00017600: 7250 6f73 6974 696f 6e2c 206e 616d 653a  rPosition, name:
-00017610: 2073 7472 2920 2d3e 204e 6f6e 653a 0a20   str) -> None:. 
-00017620: 2020 2020 2020 2020 2020 204d 6f76 6520             Move 
-00017630: 7468 6520 6d61 6e69 7075 6c61 746f 7220  the manipulator 
-00017640: 746f 2074 6865 2073 7065 6369 6669 6564  to the specified
-00017650: 2070 6f73 6974 696f 6e20 6f66 6673 6574   position offset
-00017660: 2e0a 0a20 2020 2020 2020 205f 6765 745f  ...        _get_
-00017670: 7361 7665 645f 6d61 6e69 7075 6c61 746f  saved_manipulato
-00017680: 725f 706f 7369 7469 6f6e 2873 656c 662c  r_position(self,
-00017690: 206e 616d 653a 2073 7472 2920 2d3e 2046   name: str) -> F
-000176a0: 6962 7365 6d4d 616e 6970 756c 6174 6f72  ibsemManipulator
-000176b0: 506f 7369 7469 6f6e 3a0a 2020 2020 2020  Position:.      
-000176c0: 2020 2020 2020 4765 7420 7468 6520 7361        Get the sa
-000176d0: 7665 6420 6d61 6e69 7075 6c61 746f 7220  ved manipulator 
-000176e0: 706f 7369 7469 6f6e 2077 6974 6820 7468  position with th
-000176f0: 6520 7370 6563 6966 6965 6420 6e61 6d65  e specified name
-00017700: 2e0a 2020 2020 2020 2020 7365 7475 705f  ..        setup_
-00017710: 6d69 6c6c 696e 6728 7365 6c66 2c20 6d69  milling(self, mi
-00017720: 6c6c 5f73 6574 7469 6e67 733a 2046 6962  ll_settings: Fib
-00017730: 7365 6d4d 696c 6c69 6e67 5365 7474 696e  semMillingSettin
-00017740: 6773 293a 0a20 2020 2020 2020 2020 2020  gs):.           
-00017750: 2043 6f6e 6669 6775 7265 2074 6865 206d   Configure the m
-00017760: 6963 726f 7363 6f70 6520 666f 7220 6d69  icroscope for mi
-00017770: 6c6c 696e 6720 7573 696e 6720 7468 6520  lling using the 
-00017780: 696f 6e20 6265 616d 2e0a 0a20 2020 2020  ion beam...     
-00017790: 2020 2072 756e 5f6d 696c 6c69 6e67 2873     run_milling(s
-000177a0: 656c 662c 206d 696c 6c69 6e67 5f63 7572  elf, milling_cur
-000177b0: 7265 6e74 3a20 666c 6f61 742c 2061 7379  rent: float, asy
-000177c0: 6e63 683a 2062 6f6f 6c20 3d20 4661 6c73  nch: bool = Fals
-000177d0: 6529 3a0a 2020 2020 2020 2020 2020 2020  e):.            
-000177e0: 5275 6e20 696f 6e20 6265 616d 206d 696c  Run ion beam mil
-000177f0: 6c69 6e67 2075 7369 6e67 2074 6865 2073  ling using the s
-00017800: 7065 6369 6669 6564 206d 696c 6c69 6e67  pecified milling
-00017810: 2063 7572 7265 6e74 2e0a 0a20 2020 2020   current...     
-00017820: 2020 2064 6566 2072 756e 5f6d 696c 6c69     def run_milli
-00017830: 6e67 5f64 7269 6674 5f63 6f72 7265 6374  ng_drift_correct
-00017840: 6564 2873 656c 662c 206d 696c 6c69 6e67  ed(self, milling
-00017850: 5f63 7572 7265 6e74 3a20 666c 6f61 742c  _current: float,
-00017860: 2069 6d61 6765 5f73 6574 7469 6e67 733a   image_settings:
-00017870: 2049 6d61 6765 5365 7474 696e 6773 2c20   ImageSettings, 
-00017880: 7265 665f 696d 6167 653a 2046 6962 7365  ref_image: Fibse
-00017890: 6d49 6d61 6765 2c20 7265 6475 6365 645f  mImage, reduced_
-000178a0: 6172 6561 3a20 4669 6273 656d 5265 6374  area: FibsemRect
-000178b0: 616e 676c 6520 3d20 4e6f 6e65 2c20 6173  angle = None, as
-000178c0: 796e 6368 3a20 626f 6f6c 203d 2046 616c  ynch: bool = Fal
-000178d0: 7365 293a 0a20 2020 2020 2020 2052 756e  se):.        Run
-000178e0: 2069 6f6e 2062 6561 6d20 6d69 6c6c 696e   ion beam millin
-000178f0: 6720 7573 696e 6720 7468 6520 7370 6563  g using the spec
-00017900: 6966 6965 6420 6d69 6c6c 696e 6720 6375  ified milling cu
-00017910: 7272 656e 742c 2061 6e64 2063 6f72 7265  rrent, and corre
-00017920: 6374 2066 6f72 2064 7269 6674 2075 7369  ct for drift usi
-00017930: 6e67 2074 6865 2070 726f 7669 6465 6420  ng the provided 
-00017940: 7265 6665 7265 6e63 6520 696d 6167 652e  reference image.
-00017950: 0a0a 2020 2020 2020 2020 6669 6e69 7368  ..        finish
-00017960: 5f6d 696c 6c69 6e67 2873 656c 662c 2069  _milling(self, i
-00017970: 6d61 6769 6e67 5f63 7572 7265 6e74 3a20  maging_current: 
-00017980: 666c 6f61 7429 3a0a 2020 2020 2020 2020  float):.        
-00017990: 2020 2020 4669 6e61 6c69 7365 7320 7468      Finalises th
-000179a0: 6520 6d69 6c6c 696e 6720 7072 6f63 6573  e milling proces
-000179b0: 7320 6279 2063 6c65 6172 696e 6720 7468  s by clearing th
-000179c0: 6520 6d69 6372 6f73 636f 7065 206f 6620  e microscope of 
-000179d0: 616e 7920 7061 7474 6572 6e73 2061 6e64  any patterns and
-000179e0: 2072 6574 7572 6e69 6e67 2074 6865 2063   returning the c
-000179f0: 7572 7265 6e74 2074 6f20 7468 6520 696d  urrent to the im
-00017a00: 6167 696e 6720 6375 7272 656e 742e 0a0a  aging current...
-00017a10: 2020 2020 2020 2020 6472 6177 5f72 6563          draw_rec
-00017a20: 7461 6e67 6c65 2873 656c 662c 2070 6174  tangle(self, pat
-00017a30: 7465 726e 5f73 6574 7469 6e67 733a 2046  tern_settings: F
-00017a40: 6962 7365 6d50 6174 7465 726e 5365 7474  ibsemPatternSett
-00017a50: 696e 6773 293a 0a20 2020 2020 2020 2020  ings):.         
-00017a60: 2020 2044 7261 7773 2061 2072 6563 7461     Draws a recta
-00017a70: 6e67 6c65 2070 6174 7465 726e 2075 7369  ngle pattern usi
-00017a80: 6e67 2074 6865 2063 7572 7265 6e74 2069  ng the current i
-00017a90: 6f6e 2062 6561 6d2e 0a0a 2020 2020 2020  on beam...      
-00017aa0: 2020 6472 6177 5f6c 696e 6528 7365 6c66    draw_line(self
-00017ab0: 2c20 7061 7474 6572 6e5f 7365 7474 696e  , pattern_settin
-00017ac0: 6773 3a20 4669 6273 656d 5061 7474 6572  gs: FibsemPatter
-00017ad0: 6e53 6574 7469 6e67 7329 3a0a 2020 2020  nSettings):.    
-00017ae0: 2020 2020 2020 2020 4472 6177 7320 6120          Draws a 
-00017af0: 6c69 6e65 2070 6174 7465 726e 206f 6e20  line pattern on 
-00017b00: 7468 6520 6375 7272 656e 7420 696d 6167  the current imag
-00017b10: 696e 6720 7669 6577 206f 6620 7468 6520  ing view of the 
-00017b20: 6d69 6372 6f73 636f 7065 2e0a 2020 2020  microscope..    
-00017b30: 2020 2020 0a20 2020 2020 2020 2064 7261      .        dra
-00017b40: 775f 6369 7263 6c65 2873 656c 662c 2070  w_circle(self, p
-00017b50: 6174 7465 726e 5f73 6574 7469 6e67 733a  attern_settings:
-00017b60: 2046 6962 7365 6d50 6174 7465 726e 5365   FibsemPatternSe
-00017b70: 7474 696e 6773 293a 0a20 2020 2020 2020  ttings):.       
-00017b80: 2020 2020 2044 7261 7773 2061 2063 6972       Draws a cir
-00017b90: 6375 6c61 7220 7061 7474 6572 6e20 6f6e  cular pattern on
-00017ba0: 2074 6865 2063 7572 7265 6e74 2069 6d61   the current ima
-00017bb0: 6769 6e67 2076 6965 7720 6f66 2074 6865  ging view of the
-00017bc0: 206d 6963 726f 7363 6f70 652e 0a0a 2020   microscope...  
-00017bd0: 2020 2020 2020 6765 745f 7363 616e 5f64        get_scan_d
-00017be0: 6972 6563 7469 6f6e 7328 7365 6c66 2920  irections(self) 
-00017bf0: 2d3e 206c 6973 743a 0a20 2020 2020 2020  -> list:.       
-00017c00: 2020 2020 2047 6574 2074 6865 2061 7661       Get the ava
-00017c10: 696c 6162 6c65 2073 6361 6e20 6469 7265  ilable scan dire
-00017c20: 6374 696f 6e73 2066 6f72 206d 696c 6c69  ctions for milli
-00017c30: 6e67 2e20 2020 200a 0a20 2020 2020 2020  ng.    ..       
-00017c40: 2073 6574 7570 5f73 7075 7474 6572 2873   setup_sputter(s
-00017c50: 656c 662c 2070 726f 746f 636f 6c3a 2064  elf, protocol: d
-00017c60: 6963 7429 3a0a 2020 2020 2020 2020 2020  ict):.          
-00017c70: 2020 5365 7420 7570 2074 6865 2073 7075    Set up the spu
-00017c80: 7474 6572 2063 6f61 7469 6e67 2070 726f  tter coating pro
-00017c90: 6365 7373 206f 6e20 7468 6520 6d69 6372  cess on the micr
-00017ca0: 6f73 636f 7065 2e0a 0a20 2020 2020 2020  oscope...       
-00017cb0: 2064 7261 775f 7370 7574 7465 725f 7061   draw_sputter_pa
-00017cc0: 7474 6572 6e28 7365 6c66 2c20 6866 773a  ttern(self, hfw:
-00017cd0: 2066 6c6f 6174 2c20 6c69 6e65 5f70 6174   float, line_pat
-00017ce0: 7465 726e 5f6c 656e 6774 683a 2066 6c6f  tern_length: flo
-00017cf0: 6174 2c20 7370 7574 7465 725f 7469 6d65  at, sputter_time
-00017d00: 3a20 666c 6f61 7429 3a0a 2020 2020 2020  : float):.      
-00017d10: 2020 2020 2020 4472 6177 7320 6120 6c69        Draws a li
-00017d20: 6e65 2070 6174 7465 726e 2066 6f72 2073  ne pattern for s
-00017d30: 7075 7474 6572 696e 6720 7769 7468 2074  puttering with t
-00017d40: 6865 2067 6976 656e 2070 6172 616d 6574  he given paramet
-00017d50: 6572 732e 0a0a 2020 2020 2020 2020 7275  ers...        ru
-00017d60: 6e5f 7370 7574 7465 7228 7365 6c66 2c20  n_sputter(self, 
-00017d70: 2a2a 6b77 6172 6773 293a 0a20 2020 2020  **kwargs):.     
-00017d80: 2020 2020 2020 2052 756e 7320 7468 6520         Runs the 
-00017d90: 4749 5320 506c 6174 696e 756d 2053 7075  GIS Platinum Spu
-00017da0: 7474 6572 2e0a 0a20 2020 2020 2020 2066  tter...        f
-00017db0: 696e 6973 685f 7370 7574 7465 7228 7365  inish_sputter(se
-00017dc0: 6c66 2c20 6170 706c 6963 6174 696f 6e5f  lf, application_
-00017dd0: 6669 6c65 3a20 7374 7229 202d 3e20 4e6f  file: str) -> No
-00017de0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-00017df0: 4669 6e69 7368 2074 6865 2073 7075 7474  Finish the sputt
-00017e00: 6572 2070 726f 6365 7373 2062 7920 636c  er process by cl
-00017e10: 6561 7269 6e67 2070 6174 7465 726e 7320  earing patterns 
-00017e20: 616e 6420 7265 7365 7474 696e 6720 6265  and resetting be
-00017e30: 616d 2061 6e64 2069 6d61 6769 6e67 2073  am and imaging s
-00017e40: 6574 7469 6e67 732e 0a0a 2020 2020 2020  ettings...      
-00017e50: 2020 7365 745f 6d69 6372 6f73 636f 7065    set_microscope
-00017e60: 5f73 7461 7465 2873 656c 662c 206d 6963  _state(self, mic
-00017e70: 726f 7363 6f70 655f 7374 6174 653a 204d  roscope_state: M
-00017e80: 6963 726f 7363 6f70 6553 7461 7465 2920  icroscopeState) 
-00017e90: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
-00017ea0: 2020 2020 2052 6573 6574 2074 6865 206d       Reset the m
-00017eb0: 6963 726f 7363 6f70 6520 7374 6174 6520  icroscope state 
-00017ec0: 746f 2074 6865 2070 726f 7669 6465 6420  to the provided 
-00017ed0: 7374 6174 652e 0a20 2020 2020 2020 200a  state..        .
-00017ee0: 2020 2020 2020 2020 6765 7428 7365 6c66          get(self
-00017ef0: 2c20 6b65 793a 7374 722c 2062 6561 6d5f  , key:str, beam_
-00017f00: 7479 7065 3a20 4265 616d 5479 7065 203d  type: BeamType =
-00017f10: 204e 6f6e 6529 3a0a 2020 2020 2020 2020   None):.        
-00017f20: 2020 2020 5265 7475 726e 7320 7468 6520      Returns the 
-00017f30: 7661 6c75 6520 6f66 2074 6865 2073 7065  value of the spe
-00017f40: 6369 6669 6564 206b 6579 2e0a 0a20 2020  cified key...   
-00017f50: 2020 2020 2073 6574 2873 656c 662c 206b       set(self, k
-00017f60: 6579 3a20 7374 722c 2076 616c 7565 2c20  ey: str, value, 
-00017f70: 6265 616d 5f74 7970 653a 2042 6561 6d54  beam_type: BeamT
-00017f80: 7970 6520 3d20 4e6f 6e65 2920 2d3e 204e  ype = None) -> N
-00017f90: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-00017fa0: 2053 6574 7320 7468 6520 7661 6c75 6520   Sets the value 
-00017fb0: 6f66 2074 6865 2073 7065 6369 6669 6564  of the specified
-00017fc0: 206b 6579 2e0a 0a20 2020 204e 6577 206d   key...    New m
-00017fd0: 6574 686f 6473 3a0a 2020 2020 2020 2020  ethods:.        
-00017fe0: 5f5f 696e 6974 5f5f 2873 656c 6629 3a20  __init__(self): 
-00017ff0: 0a20 2020 2020 2020 2020 2020 2049 6e69  .            Ini
-00018000: 7469 616c 697a 6573 2061 206e 6577 2069  tializes a new i
-00018010: 6e73 7461 6e63 6520 6f66 2074 6865 2063  nstance of the c
-00018020: 6c61 7373 2e0a 0a20 2020 2020 2020 205f  lass...        _
-00018030: 6765 745f 6562 5f69 6d61 6765 2873 656c  get_eb_image(sel
-00018040: 662c 2069 6d61 6765 5f73 6574 7469 6e67  f, image_setting
-00018050: 733d 496d 6167 6553 6574 7469 6e67 7329  s=ImageSettings)
-00018060: 202d 3e20 4669 6273 656d 496d 6167 653a   -> FibsemImage:
-00018070: 0a20 2020 2020 2020 2020 2020 2041 6371  .            Acq
-00018080: 7569 7265 7320 616e 2065 6c65 6374 726f  uires an electro
-00018090: 6e20 6265 616d 2028 4542 2920 696d 6167  n beam (EB) imag
-000180a0: 6520 7769 7468 2074 6865 2067 6976 656e  e with the given
-000180b0: 2073 6574 7469 6e67 7320 616e 6420 7265   settings and re
-000180c0: 7475 726e 7320 6120 4669 6273 656d 496d  turns a FibsemIm
-000180d0: 6167 6520 6f62 6a65 6374 2e0a 0a20 2020  age object...   
-000180e0: 2020 2020 205f 6765 745f 6962 5f69 6d61       _get_ib_ima
-000180f0: 6765 2873 656c 662c 2069 6d61 6765 5f73  ge(self, image_s
-00018100: 6574 7469 6e67 733d 496d 6167 6553 6574  ettings=ImageSet
-00018110: 7469 6e67 7329 3a0a 2020 2020 2020 2020  tings):.        
-00018120: 2020 2020 4163 7175 6972 6573 2061 6e20      Acquires an 
-00018130: 696f 6e20 6265 616d 2028 4942 2920 696d  ion beam (IB) im
-00018140: 6167 6520 7769 7468 2074 6865 2067 6976  age with the giv
-00018150: 656e 2073 6574 7469 6e67 7320 616e 6420  en settings and 
-00018160: 7265 7475 726e 7320 6120 4669 6273 656d  returns a Fibsem
-00018170: 496d 6167 6520 6f62 6a65 6374 2e0a 0a20  Image object... 
-00018180: 2020 2020 2020 205f 795f 636f 7272 6563         _y_correc
-00018190: 7465 645f 7374 6167 655f 6d6f 7665 6d65  ted_stage_moveme
-000181a0: 6e74 2873 656c 662c 2073 6574 7469 6e67  nt(self, setting
-000181b0: 733a 204d 6963 726f 7363 6f70 6553 6574  s: MicroscopeSet
-000181c0: 7469 6e67 732c 2065 7870 6563 7465 645f  tings, expected_
-000181d0: 793a 2066 6c6f 6174 2c20 6265 616d 5f74  y: float, beam_t
-000181e0: 7970 653a 2042 6561 6d54 7970 6520 3d20  ype: BeamType = 
-000181f0: 4265 616d 5479 7065 2e45 4c45 4354 524f  BeamType.ELECTRO
-00018200: 4e29 202d 3e20 4669 6273 656d 5374 6167  N) -> FibsemStag
-00018210: 6550 6f73 6974 696f 6e3a 0a20 2020 2020  ePosition:.     
-00018220: 2020 2020 2020 2043 616c 6375 6c61 7465         Calculate
-00018230: 2074 6865 2079 2063 6f72 7265 6374 6564   the y corrected
-00018240: 2073 7461 6765 206d 6f76 656d 656e 742c   stage movement,
-00018250: 2063 6f72 7265 6374 6564 2066 6f72 2074   corrected for t
-00018260: 6865 2061 6464 6974 696f 6e61 6c20 7469  he additional ti
-00018270: 6c74 206f 6620 7468 6520 7361 6d70 6c65  lt of the sample
-00018280: 2068 6f6c 6465 7220 2870 7265 2d74 696c   holder (pre-til
-00018290: 7420 616e 676c 6529 2e0a 2020 2020 2222  t angle)..    ""
-000182a0: 220a 0a20 2020 2064 6566 205f 5f69 6e69  "..    def __ini
-000182b0: 745f 5f28 7365 6c66 2c20 6970 5f61 6464  t__(self, ip_add
-000182c0: 7265 7373 3a20 7374 7220 3d20 226c 6f63  ress: str = "loc
-000182d0: 616c 686f 7374 2229 3a0a 2020 2020 2020  alhost"):.      
-000182e0: 2020 7365 6c66 2e63 6f6e 6e65 6374 696f    self.connectio
-000182f0: 6e20 3d20 4175 746f 6d61 7469 6f6e 2869  n = Automation(i
-00018300: 705f 6164 6472 6573 7329 0a20 2020 2020  p_address).     
-00018310: 2020 2064 6574 6563 746f 7273 203d 2073     detectors = s
-00018320: 656c 662e 636f 6e6e 6563 7469 6f6e 2e46  elf.connection.F
-00018330: 4942 2e44 6574 6563 746f 722e 456e 756d  IB.Detector.Enum
-00018340: 2829 0a20 2020 2020 2020 2073 656c 662e  ().        self.
-00018350: 696f 6e5f 6465 7465 6374 6f72 5f61 6374  ion_detector_act
-00018360: 6976 6520 3d20 6465 7465 6374 6f72 735b  ive = detectors[
-00018370: 305d 0a20 2020 2020 2020 2073 656c 662e  0].        self.
-00018380: 636f 6e6e 6563 7469 6f6e 2e46 4942 2e44  connection.FIB.D
-00018390: 6574 6563 746f 722e 5365 7428 4368 616e  etector.Set(Chan
-000183a0: 6e65 6c20 3d20 302c 2044 6574 6563 746f  nel = 0, Detecto
-000183b0: 723d 2073 656c 662e 696f 6e5f 6465 7465  r= self.ion_dete
-000183c0: 6374 6f72 5f61 6374 6976 6529 0a20 2020  ctor_active).   
-000183d0: 2020 2020 2073 656c 662e 656c 6563 7472       self.electr
-000183e0: 6f6e 5f64 6574 6563 746f 725f 6163 7469  on_detector_acti
-000183f0: 7665 203d 2073 656c 662e 636f 6e6e 6563  ve = self.connec
-00018400: 7469 6f6e 2e53 454d 2e44 6574 6563 746f  tion.SEM.Detecto
-00018410: 722e 5345 5375 6974 6162 6c65 2829 0a20  r.SESuitable(). 
-00018420: 2020 2020 2020 2073 656c 662e 636f 6e6e         self.conn
-00018430: 6563 7469 6f6e 2e53 454d 2e44 6574 6563  ection.SEM.Detec
-00018440: 746f 722e 5365 7428 4368 616e 6e65 6c20  tor.Set(Channel 
-00018450: 3d20 302c 2044 6574 6563 746f 7220 3d20  = 0, Detector = 
-00018460: 7365 6c66 2e65 6c65 6374 726f 6e5f 6465  self.electron_de
-00018470: 7465 6374 6f72 5f61 6374 6976 6529 0a0a  tector_active)..
-00018480: 2020 2020 2020 2020 7365 6c66 2e6c 6173          self.las
-00018490: 745f 696d 6167 655f 6562 203d 204e 6f6e  t_image_eb = Non
-000184a0: 650a 2020 2020 2020 2020 7365 6c66 2e6c  e.        self.l
-000184b0: 6173 745f 696d 6167 655f 6962 203d 204e  ast_image_ib = N
-000184c0: 6f6e 650a 0a20 2020 2020 2020 2069 6d70  one..        imp
-000184d0: 6f72 7420 6669 6273 656d 0a20 2020 2020  ort fibsem.     
-000184e0: 2020 2066 726f 6d20 6669 6273 656d 2e75     from fibsem.u
-000184f0: 7469 6c73 2069 6d70 6f72 7420 6c6f 6164  tils import load
-00018500: 5f70 726f 746f 636f 6c0a 2020 2020 2020  _protocol.      
-00018510: 2020 6261 7365 5f70 6174 6820 3d20 6f73    base_path = os
-00018520: 2e70 6174 682e 6469 726e 616d 6528 6669  .path.dirname(fi
-00018530: 6273 656d 2e5f 5f70 6174 685f 5f5b 305d  bsem.__path__[0]
-00018540: 290a 2020 2020 2020 2020 7365 6c66 2e68  ).        self.h
-00018550: 6172 6477 6172 655f 7365 7474 696e 6773  ardware_settings
-00018560: 203d 2046 6962 7365 6d48 6172 6477 6172   = FibsemHardwar
-00018570: 652e 5f5f 6672 6f6d 5f64 6963 745f 5f28  e.__from_dict__(
-00018580: 6c6f 6164 5f70 726f 746f 636f 6c28 6f73  load_protocol(os
-00018590: 2e70 6174 682e 6a6f 696e 2862 6173 655f  .path.join(base_
-000185a0: 7061 7468 2c22 6669 6273 656d 222c 2022  path,"fibsem", "
-000185b0: 636f 6e66 6967 222c 2022 6d6f 6465 6c2e  config", "model.
-000185c0: 7961 6d6c 2229 2929 0a0a 2020 2020 6465  yaml")))..    de
-000185d0: 6620 6469 7363 6f6e 6e65 6374 2873 656c  f disconnect(sel
-000185e0: 6629 3a0a 2020 2020 2020 2020 7365 6c66  f):.        self
-000185f0: 2e63 6f6e 6e65 6374 696f 6e2e 4469 7363  .connection.Disc
-00018600: 6f6e 6e65 6374 2829 0a20 2020 2020 2020  onnect().       
-00018610: 2064 656c 2073 656c 662e 636f 6e6e 6563   del self.connec
-00018620: 7469 6f6e 0a20 2020 2020 2020 2073 656c  tion.        sel
-00018630: 662e 636f 6e6e 6563 7469 6f6e 203d 204e  f.connection = N
-00018640: 6f6e 650a 0a20 2020 2023 2040 636c 6173  one..    # @clas
-00018650: 736d 6574 686f 640a 2020 2020 6465 6620  smethod.    def 
-00018660: 636f 6e6e 6563 745f 746f 5f6d 6963 726f  connect_to_micro
-00018670: 7363 6f70 6528 7365 6c66 2c20 6970 5f61  scope(self, ip_a
-00018680: 6464 7265 7373 3a20 7374 722c 2070 6f72  ddress: str, por
-00018690: 743a 2069 6e74 203d 2038 3330 3029 202d  t: int = 8300) -
-000186a0: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
-000186b0: 2222 220a 2020 2020 2020 2020 2020 2020  """.            
-000186c0: 436f 6e6e 6563 7473 2074 6f20 6120 6d69  Connects to a mi
-000186d0: 6372 6f73 636f 7065 2077 6974 6820 7468  croscope with th
-000186e0: 6520 7370 6563 6966 6965 6420 4950 2061  e specified IP a
-000186f0: 6464 7265 7373 2061 6e64 2070 6f72 742e  ddress and port.
-00018700: 0a0a 2020 2020 2020 2020 2020 2020 4172  ..            Ar
-00018710: 6773 3a0a 2020 2020 2020 2020 2020 2020  gs:.            
-00018720: 2020 2020 6970 5f61 6464 7265 7373 3a20      ip_address: 
-00018730: 4120 7374 7269 6e67 2074 6861 7420 7265  A string that re
-00018740: 7072 6573 656e 7473 2074 6865 2049 5020  presents the IP 
-00018750: 6164 6472 6573 7320 6f66 2074 6865 206d  address of the m
-00018760: 6963 726f 7363 6f70 652e 0a20 2020 2020  icroscope..     
-00018770: 2020 2020 2020 2020 2020 2070 6f72 743a             port:
-00018780: 2041 6e20 696e 7465 6765 7220 7468 6174   An integer that
-00018790: 2072 6570 7265 7365 6e74 7320 7468 6520   represents the 
-000187a0: 706f 7274 206e 756d 6265 7220 746f 2075  port number to u
-000187b0: 7365 2028 6465 6661 756c 7420 3833 3030  se (default 8300
-000187c0: 292e 0a0a 2020 2020 2020 2020 2020 2020  )...            
-000187d0: 5265 7475 726e 733a 0a20 2020 2020 2020  Returns:.       
-000187e0: 2020 2020 2020 2020 204e 6f6e 652e 0a20           None.. 
-000187f0: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-00018800: 2020 206c 6f67 6769 6e67 2e69 6e66 6f28     logging.info(
-00018810: 6622 4d69 6372 6f73 636f 7065 2063 6c69  f"Microscope cli
-00018820: 656e 7420 636f 6e6e 6563 7469 6e67 2074  ent connecting t
-00018830: 6f20 5b7b 6970 5f61 6464 7265 7373 7d3a  o [{ip_address}:
-00018840: 7b70 6f72 747d 5d22 290a 2020 2020 2020  {port}]").      
-00018850: 2020 7365 6c66 2e63 6f6e 6e65 6374 696f    self.connectio
-00018860: 6e20 3d20 4175 746f 6d61 7469 6f6e 2869  n = Automation(i
-00018870: 705f 6164 6472 6573 732c 2070 6f72 7429  p_address, port)
-00018880: 0a20 2020 2020 2020 206c 6f67 6769 6e67  .        logging
-00018890: 2e69 6e66 6f28 6622 4d69 6372 6f73 636f  .info(f"Microsco
-000188a0: 7065 2063 6c69 656e 7420 636f 6e6e 6563  pe client connec
-000188b0: 7465 6420 746f 205b 7b69 705f 6164 6472  ted to [{ip_addr
-000188c0: 6573 737d 3a7b 706f 7274 7d5d 2229 0a20  ess}:{port}]"). 
-000188d0: 2020 2020 2020 2073 656c 662e 636f 6e6e         self.conn
-000188e0: 6563 7469 6f6e 2e53 454d 2e44 6574 6563  ection.SEM.Detec
-000188f0: 746f 722e 5365 7428 302c 2073 656c 662e  tor.Set(0, self.
-00018900: 656c 6563 7472 6f6e 5f64 6574 6563 746f  electron_detecto
-00018910: 725f 6163 7469 7665 2c20 4270 702e 4772  r_active, Bpp.Gr
-00018920: 6179 7363 616c 655f 385f 6269 7429 0a20  ayscale_8_bit). 
-00018930: 2020 2020 2020 2069 6d61 6765 203d 2073         image = s
-00018940: 656c 662e 636f 6e6e 6563 7469 6f6e 2e53  elf.connection.S
-00018950: 454d 2e53 6361 6e2e 4163 7175 6972 6549  EM.Scan.AcquireI
-00018960: 6d61 6765 4672 6f6d 4368 616e 6e65 6c28  mageFromChannel(
-00018970: 302c 2031 2c20 312c 2031 3030 290a 2020  0, 1, 1, 100).  
-00018980: 2020 2020 2020 7365 6c66 2e73 6572 6961        self.seria
-00018990: 6c5f 6e75 6d62 6572 203d 2069 6d61 6765  l_number = image
-000189a0: 2e48 6561 6465 725b 224d 4149 4e22 5d5b  .Header["MAIN"][
-000189b0: 2253 6572 6961 6c4e 756d 6265 7222 5d0a  "SerialNumber"].
-000189c0: 2020 2020 2020 2020 7365 6c66 2e6d 6f64          self.mod
-000189d0: 656c 203d 2069 6d61 6765 2e48 6561 6465  el = image.Heade
-000189e0: 725b 224d 4149 4e22 5d5b 2244 6576 6963  r["MAIN"]["Devic
-000189f0: 654d 6f64 656c 225d 0a20 2020 2020 2020  eModel"].       
-00018a00: 2073 656c 662e 736f 6674 7761 7265 5f76   self.software_v
-00018a10: 6572 7369 6f6e 203d 2069 6d61 6765 2e48  ersion = image.H
-00018a20: 6561 6465 725b 224d 4149 4e22 5d5b 2253  eader["MAIN"]["S
-00018a30: 6f66 7477 6172 6556 6572 7369 6f6e 225d  oftwareVersion"]
-00018a40: 0a20 2020 2020 2020 206c 6f67 6769 6e67  .        logging
-00018a50: 2e69 6e66 6f28 6622 4d69 6372 6f73 636f  .info(f"Microsco
-00018a60: 7065 2063 6c69 656e 7420 636f 6e6e 6563  pe client connec
-00018a70: 7465 6420 746f 206d 6f64 656c 207b 7365  ted to model {se
-00018a80: 6c66 2e6d 6f64 656c 7d20 7769 7468 2073  lf.model} with s
-00018a90: 6572 6961 6c20 6e75 6d62 6572 207b 7365  erial number {se
-00018aa0: 6c66 2e73 6572 6961 6c5f 6e75 6d62 6572  lf.serial_number
-00018ab0: 7d20 616e 6420 736f 6674 7761 7265 2076  } and software v
-00018ac0: 6572 7369 6f6e 207b 7365 6c66 2e73 6f66  ersion {self.sof
-00018ad0: 7477 6172 655f 7665 7273 696f 6e7d 2e22  tware_version}."
-00018ae0: 290a 0a20 2020 2064 6566 2061 6371 7569  )..    def acqui
-00018af0: 7265 5f69 6d61 6765 2873 656c 662c 2069  re_image(self, i
-00018b00: 6d61 6765 5f73 6574 7469 6e67 733d 496d  mage_settings=Im
-00018b10: 6167 6553 6574 7469 6e67 7329 202d 3e20  ageSettings) -> 
-00018b20: 4669 6273 656d 496d 6167 653a 0a20 2020  FibsemImage:.   
-00018b30: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-00018b40: 2020 2020 2041 6371 7569 7265 7320 616e       Acquires an
-00018b50: 2069 6d61 6765 2075 7369 6e67 2074 6865   image using the
-00018b60: 2073 7065 6369 6669 6564 2069 6d61 6765   specified image
-00018b70: 2073 6574 7469 6e67 732e 0a0a 2020 2020   settings...    
-00018b80: 2020 2020 2020 2020 4172 6773 3a0a 2020          Args:.  
-00018b90: 2020 2020 2020 2020 2020 2020 2020 696d                im
-00018ba0: 6167 655f 7365 7474 696e 6773 3a20 416e  age_settings: An
-00018bb0: 2069 6e73 7461 6e63 6520 6f66 2074 6865   instance of the
-00018bc0: 2060 496d 6167 6553 6574 7469 6e67 7360   `ImageSettings`
-00018bd0: 2063 6c61 7373 2074 6861 7420 7265 7072   class that repr
-00018be0: 6573 656e 7473 2074 6865 2069 6d61 6765  esents the image
-00018bf0: 2073 6574 7469 6e67 7320 746f 2075 7365   settings to use
-00018c00: 2028 6465 6661 756c 7420 6049 6d61 6765   (default `Image
-00018c10: 5365 7474 696e 6773 6029 2e0a 0a20 2020  Settings`)...   
-00018c20: 2020 2020 2020 2020 2052 6574 7572 6e73           Returns
-00018c30: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00018c40: 2020 4120 6046 6962 7365 6d49 6d61 6765    A `FibsemImage
-00018c50: 6020 6f62 6a65 6374 2074 6861 7420 7265  ` object that re
-00018c60: 7072 6573 656e 7473 2074 6865 2061 6371  presents the acq
-00018c70: 7569 7265 6420 696d 6167 652e 0a20 2020  uired image..   
-00018c80: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-00018c90: 206c 6f67 6769 6e67 2e69 6e66 6f28 6622   logging.info(f"
-00018ca0: 6163 7175 6972 696e 6720 6e65 7720 7b69  acquiring new {i
-00018cb0: 6d61 6765 5f73 6574 7469 6e67 732e 6265  mage_settings.be
-00018cc0: 616d 5f74 7970 652e 6e61 6d65 7d20 696d  am_type.name} im
-00018cd0: 6167 652e 2229 0a20 2020 2020 2020 2069  age.").        i
-00018ce0: 6620 696d 6167 655f 7365 7474 696e 6773  f image_settings
-00018cf0: 2e62 6561 6d5f 7479 7065 2e6e 616d 6520  .beam_type.name 
-00018d00: 3d3d 2022 454c 4543 5452 4f4e 223a 0a20  == "ELECTRON":. 
-00018d10: 2020 2020 2020 2020 2020 205f 6368 6563             _chec
-00018d20: 6b5f 6265 616d 2842 6561 6d54 7970 652e  k_beam(BeamType.
-00018d30: 454c 4543 5452 4f4e 2c20 7365 6c66 2e68  ELECTRON, self.h
-00018d40: 6172 6477 6172 655f 7365 7474 696e 6773  ardware_settings
-00018d50: 290a 2020 2020 2020 2020 2020 2020 696d  ).            im
-00018d60: 6167 6520 3d20 7365 6c66 2e5f 6765 745f  age = self._get_
-00018d70: 6562 5f69 6d61 6765 2869 6d61 6765 5f73  eb_image(image_s
-00018d80: 6574 7469 6e67 7329 0a20 2020 2020 2020  ettings).       
-00018d90: 2020 2020 2073 656c 662e 6c61 7374 5f69       self.last_i
-00018da0: 6d61 6765 5f65 6220 3d20 696d 6167 650a  mage_eb = image.
-00018db0: 2020 2020 2020 2020 6966 2069 6d61 6765          if image
-00018dc0: 5f73 6574 7469 6e67 732e 6265 616d 5f74  _settings.beam_t
-00018dd0: 7970 652e 6e61 6d65 203d 3d20 2249 4f4e  ype.name == "ION
-00018de0: 223a 0a20 2020 2020 2020 2020 2020 205f  ":.            _
-00018df0: 6368 6563 6b5f 6265 616d 2842 6561 6d54  check_beam(BeamT
-00018e00: 7970 652e 494f 4e2c 2073 656c 662e 6861  ype.ION, self.ha
-00018e10: 7264 7761 7265 5f73 6574 7469 6e67 7329  rdware_settings)
-00018e20: 0a20 2020 2020 2020 2020 2020 2069 6d61  .            ima
-00018e30: 6765 203d 2073 656c 662e 5f67 6574 5f69  ge = self._get_i
-00018e40: 625f 696d 6167 6528 696d 6167 655f 7365  b_image(image_se
-00018e50: 7474 696e 6773 290a 2020 2020 2020 2020  ttings).        
-00018e60: 2020 2020 7365 6c66 2e6c 6173 745f 696d      self.last_im
-00018e70: 6167 655f 6962 203d 2069 6d61 6765 0a0a  age_ib = image..
-00018e80: 2020 2020 2020 2020 7265 7475 726e 2069          return i
-00018e90: 6d61 6765 0a0a 2020 2020 6465 6620 5f67  mage..    def _g
-00018ea0: 6574 5f65 625f 696d 6167 6528 7365 6c66  et_eb_image(self
-00018eb0: 2c20 696d 6167 655f 7365 7474 696e 6773  , image_settings
-00018ec0: 3a20 496d 6167 6553 6574 7469 6e67 7329  : ImageSettings)
-00018ed0: 202d 3e20 4669 6273 656d 496d 6167 653a   -> FibsemImage:
-00018ee0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-00018ef0: 2020 2020 2041 6371 7569 7265 7320 616e       Acquires an
-00018f00: 2065 6c65 6374 726f 6e20 6265 616d 2028   electron beam (
-00018f10: 4542 2920 696d 6167 6520 7769 7468 2074  EB) image with t
-00018f20: 6865 2067 6976 656e 2073 6574 7469 6e67  he given setting
-00018f30: 7320 616e 6420 7265 7475 726e 7320 6120  s and returns a 
-00018f40: 4669 6273 656d 496d 6167 6520 6f62 6a65  FibsemImage obje
-00018f50: 6374 2e0a 0a20 2020 2020 2020 2041 7267  ct...        Arg
-00018f60: 733a 0a20 2020 2020 2020 2020 2020 2069  s:.            i
-00018f70: 6d61 6765 5f73 6574 7469 6e67 7320 2849  mage_settings (I
-00018f80: 6d61 6765 5365 7474 696e 6773 293a 2041  mageSettings): A
-00018f90: 6e20 6f62 6a65 6374 2063 6f6e 7461 696e  n object contain
-00018fa0: 696e 6720 7468 6520 7365 7474 696e 6773  ing the settings
-00018fb0: 2066 6f72 2074 6865 2061 6371 7569 7265   for the acquire
-00018fc0: 6420 696d 6167 652e 200a 0a20 2020 2020  d image. ..     
-00018fd0: 2020 2052 6574 7572 6e73 3a0a 2020 2020     Returns:.    
-00018fe0: 2020 2020 2020 2020 4669 6273 656d 496d          FibsemIm
-00018ff0: 6167 653a 2054 6865 2061 6371 7569 7265  age: The acquire
-00019000: 6420 696d 6167 6520 6173 2061 2046 6962  d image as a Fib
-00019010: 7365 6d49 6d61 6765 206f 626a 6563 742e  semImage object.
-00019020: 0a0a 2020 2020 2020 2020 4e6f 7465 733a  ..        Notes:
-00019030: 0a20 2020 2020 2020 2020 2020 2054 6869  .            Thi
-00019040: 7320 6675 6e63 7469 6f6e 2061 6371 7569  s function acqui
-00019050: 7265 7320 616e 2065 6c65 6374 726f 6e20  res an electron 
-00019060: 6265 616d 2028 4542 2920 696d 6167 6520  beam (EB) image 
-00019070: 7769 7468 2074 6865 2067 6976 656e 2073  with the given s
-00019080: 6574 7469 6e67 7320 616e 6420 7265 7475  ettings and retu
-00019090: 726e 7320 6974 2061 7320 6120 4669 6273  rns it as a Fibs
-000190a0: 656d 496d 6167 6520 6f62 6a65 6374 2e20  emImage object. 
-000190b0: 0a20 2020 2020 2020 2020 2020 2054 6865  .            The
-000190c0: 2066 756e 6374 696f 6e20 7365 7473 2075   function sets u
-000190d0: 7020 7468 6520 6d69 6372 6f73 636f 7065  p the microscope
-000190e0: 2070 6172 616d 6574 6572 732c 2069 6e63   parameters, inc
-000190f0: 6c75 6469 6e67 2074 6865 2065 6c65 6374  luding the elect
-00019100: 726f 6e20 6265 616d 2064 7765 6c6c 2074  ron beam dwell t
-00019110: 696d 652c 2069 6d61 6765 2072 6573 6f6c  ime, image resol
-00019120: 7574 696f 6e2c 2061 6e64 200a 2020 2020  ution, and .    
-00019130: 2020 2020 2020 2020 7265 6769 6f6e 206f          region o
-00019140: 6620 696e 7465 7265 7374 2028 524f 4929  f interest (ROI)
-00019150: 2c20 6966 2073 7065 6369 6669 6564 2e20  , if specified. 
-00019160: 4974 2074 6865 6e20 6163 7175 6972 6573  It then acquires
-00019170: 2074 6865 2069 6d61 6765 2061 6e64 2063   the image and c
-00019180: 7265 6174 6573 2061 2046 6962 7365 6d49  reates a FibsemI
-00019190: 6d61 6765 206f 626a 6563 7420 6672 6f6d  mage object from
-000191a0: 2069 742c 200a 2020 2020 2020 2020 2020   it, .          
-000191b0: 2020 696e 636c 7564 696e 6720 6d65 7461    including meta
-000191c0: 6461 7461 206f 6e20 7468 6520 6d69 6372  data on the micr
-000191d0: 6f73 636f 7065 2073 7461 7465 2061 6e64  oscope state and
-000191e0: 2074 6865 2062 6561 6d20 616e 6420 696f   the beam and io
-000191f0: 6e20 7365 7474 696e 6773 2e0a 0a20 2020  n settings...   
-00019200: 2020 2020 2020 2020 2042 6566 6f72 6520           Before 
-00019210: 6163 7175 6972 696e 6720 7468 6520 696d  acquiring the im
-00019220: 6167 652c 2074 6865 2066 756e 6374 696f  age, the functio
-00019230: 6e20 656e 7375 7265 7320 7468 6174 2074  n ensures that t
-00019240: 6865 2065 6c65 6374 726f 6e20 6265 616d  he electron beam
-00019250: 2069 7320 7475 726e 6564 206f 6e20 616e   is turned on an
-00019260: 6420 7468 6174 2074 6865 2053 454d 2073  d that the SEM s
-00019270: 6361 6e20 6973 2073 746f 7070 6564 2e20  can is stopped. 
-00019280: 0a20 2020 2020 2020 2020 2020 2049 7420  .            It 
-00019290: 7365 6c65 6374 7320 7468 6520 6d6f 7374  selects the most
-000192a0: 2073 7569 7461 626c 6520 6465 7465 6374   suitable detect
-000192b0: 6f72 2066 6f72 2074 6865 2069 6d61 6765  or for the image
-000192c0: 2c20 6173 7369 676e 7320 6974 2074 6f20  , assigns it to 
-000192d0: 6120 6368 616e 6e65 6c2c 2061 6e64 2065  a channel, and e
-000192e0: 6e61 626c 6573 2074 6865 2063 6861 6e6e  nables the chann
-000192f0: 656c 2066 6f72 2061 6371 7569 7369 7469  el for acquisiti
-00019300: 6f6e 2e20 0a20 2020 2020 2020 2020 2020  on. .           
-00019310: 2054 6865 2066 756e 6374 696f 6e20 7468   The function th
-00019320: 656e 2061 6371 7569 7265 7320 7468 6520  en acquires the 
-00019330: 696d 6167 6520 6672 6f6d 2074 6865 2063  image from the c
-00019340: 6861 6e6e 656c 2075 7369 6e67 2074 6865  hannel using the
-00019350: 2073 7065 6369 6669 6564 2064 7765 6c6c   specified dwell
-00019360: 2074 696d 6520 616e 6420 7265 736f 6c75   time and resolu
-00019370: 7469 6f6e 2e0a 0a20 2020 2020 2020 2020  tion...         
-00019380: 2020 2054 6865 2066 756e 6374 696f 6e20     The function 
-00019390: 616c 736f 2072 6563 6f72 6473 2074 6865  also records the
-000193a0: 206d 6963 726f 7363 6f70 6520 7374 6174   microscope stat
-000193b0: 6520 6174 2074 6865 2074 696d 6520 6f66  e at the time of
-000193c0: 2069 6d61 6765 2061 6371 7569 7369 7469   image acquisiti
-000193d0: 6f6e 2c20 696e 636c 7564 696e 6720 7468  on, including th
-000193e0: 6520 7374 6167 6520 706f 7369 7469 6f6e  e stage position
-000193f0: 2c20 6265 616d 200a 2020 2020 2020 2020  , beam .        
-00019400: 2020 2020 7365 7474 696e 6773 2c20 616e      settings, an
-00019410: 6420 696f 6e20 6265 616d 2073 6574 7469  d ion beam setti
-00019420: 6e67 732e 2054 6865 2061 6371 7569 7265  ngs. The acquire
-00019430: 6420 696d 6167 6520 6973 2072 6574 7572  d image is retur
-00019440: 6e65 6420 6173 2061 2046 6962 7365 6d49  ned as a FibsemI
-00019450: 6d61 6765 206f 626a 6563 742c 2077 6869  mage object, whi
-00019460: 6368 2069 6e63 6c75 6465 7320 7468 6520  ch includes the 
-00019470: 696d 6167 6520 0a20 2020 2020 2020 2020  image .         
-00019480: 2020 2064 6174 6120 616e 6420 6d65 7461     data and meta
-00019490: 6461 7461 206f 6e20 7468 6520 6d69 6372  data on the micr
-000194a0: 6f73 636f 7065 2073 7461 7465 2061 6e64  oscope state and
-000194b0: 2074 6865 2069 6d61 6765 2073 6574 7469   the image setti
-000194c0: 6e67 732e 0a20 2020 2020 2020 2022 2222  ngs..        """
-000194d0: 0a20 2020 2020 2020 2023 2041 7420 6669  .        # At fi
-000194e0: 7273 7420 6d61 6b65 2073 7572 6520 7468  rst make sure th
-000194f0: 6520 6265 616d 2069 7320 4f4e 0a20 2020  e beam is ON.   
-00019500: 2020 2020 2073 7461 7475 7320 3d20 7365       status = se
-00019510: 6c66 2e63 6f6e 6e65 6374 696f 6e2e 5345  lf.connection.SE
-00019520: 4d2e 4265 616d 2e47 6574 5374 6174 7573  M.Beam.GetStatus
-00019530: 2829 0a20 2020 2020 2020 2069 6620 7374  ().        if st
-00019540: 6174 7573 2021 3d20 4175 746f 6d61 7469  atus != Automati
-00019550: 6f6e 2e53 454d 2e42 6561 6d2e 5374 6174  on.SEM.Beam.Stat
-00019560: 7573 2e42 6561 6d4f 6e3a 0a20 2020 2020  us.BeamOn:.     
-00019570: 2020 2020 2020 2073 656c 662e 636f 6e6e         self.conn
-00019580: 6563 7469 6f6e 2e53 454d 2e42 6561 6d2e  ection.SEM.Beam.
-00019590: 4f6e 2829 0a20 2020 2020 2020 2023 2069  On().        # i
-000195a0: 6d70 6f72 7461 6e74 3a20 7374 6f70 2074  mportant: stop t
-000195b0: 6865 2073 6361 6e6e 696e 6720 6265 666f  he scanning befo
-000195c0: 7265 2077 6520 7374 6172 7420 7363 616e  re we start scan
-000195d0: 6e69 6e67 206f 7220 6265 666f 7265 2061  ning or before a
-000195e0: 7574 6f6d 6174 6963 2070 726f 6365 6475  utomatic procedu
-000195f0: 7265 732c 0a20 2020 2020 2020 2023 2065  res,.        # e
-00019600: 7665 6e20 6265 666f 7265 2077 6520 636f  ven before we co
-00019610: 6e66 6967 7572 6520 7468 6520 6465 7465  nfigure the dete
-00019620: 6374 6f72 730a 2020 2020 2020 2020 7365  ctors.        se
-00019630: 6c66 2e63 6f6e 6e65 6374 696f 6e2e 5345  lf.connection.SE
-00019640: 4d2e 5363 616e 2e53 746f 7028 290a 2020  M.Scan.Stop().  
-00019650: 2020 2020 2020 2320 5365 6c65 6374 2074        # Select t
-00019660: 6865 2064 6574 6563 746f 7220 666f 7220  he detector for 
-00019670: 696d 6167 6520 692e 652e 3a0a 2020 2020  image i.e.:.    
-00019680: 2020 2020 2320 312e 2061 7373 6967 6e20      # 1. assign 
-00019690: 7468 6520 6465 7465 6374 6f72 2074 6f20  the detector to 
-000196a0: 6120 6368 616e 6e65 6c0a 2020 2020 2020  a channel.      
-000196b0: 2020 2320 322e 2065 6e61 626c 6520 7468    # 2. enable th
-000196c0: 6520 6368 616e 6e65 6c20 666f 7220 6163  e channel for ac
-000196d0: 7175 6973 6974 696f 6e0a 2020 2020 2020  quisition.      
-000196e0: 2020 0a20 2020 2020 2020 2073 656c 662e    .        self.
-000196f0: 636f 6e6e 6563 7469 6f6e 2e53 454d 2e44  connection.SEM.D
-00019700: 6574 6563 746f 722e 5365 7428 302c 2073  etector.Set(0, s
-00019710: 656c 662e 656c 6563 7472 6f6e 5f64 6574  elf.electron_det
-00019720: 6563 746f 725f 6163 7469 7665 2c20 4270  ector_active, Bp
-00019730: 702e 4772 6179 7363 616c 655f 385f 6269  p.Grayscale_8_bi
-00019740: 7429 0a0a 2020 2020 2020 2020 6477 656c  t)..        dwel
-00019750: 6c5f 7469 6d65 203d 2069 6d61 6765 5f73  l_time = image_s
-00019760: 6574 7469 6e67 732e 6477 656c 6c5f 7469  ettings.dwell_ti
-00019770: 6d65 202a 2063 6f6e 7374 616e 7473 2e53  me * constants.S
-00019780: 495f 544f 5f4e 414e 4f0a 2020 2020 2020  I_TO_NANO.      
-00019790: 2020 2320 7265 736f 6c75 7469 6f6e 0a20    # resolution. 
-000197a0: 2020 2020 2020 2069 6d61 6765 5769 6474         imageWidt
-000197b0: 6820 3d20 696d 6167 655f 7365 7474 696e  h = image_settin
-000197c0: 6773 2e72 6573 6f6c 7574 696f 6e5b 305d  gs.resolution[0]
-000197d0: 0a20 2020 2020 2020 2069 6d61 6765 4865  .        imageHe
-000197e0: 6967 6874 203d 2069 6d61 6765 5f73 6574  ight = image_set
-000197f0: 7469 6e67 732e 7265 736f 6c75 7469 6f6e  tings.resolution
-00019800: 5b31 5d0a 0a20 2020 2020 2020 2073 656c  [1]..        sel
-00019810: 662e 636f 6e6e 6563 7469 6f6e 2e53 454d  f.connection.SEM
-00019820: 2e4f 7074 6963 732e 5365 7456 6965 7766  .Optics.SetViewf
-00019830: 6965 6c64 280a 2020 2020 2020 2020 2020  ield(.          
-00019840: 2020 696d 6167 655f 7365 7474 696e 6773    image_settings
-00019850: 2e68 6677 202a 2063 6f6e 7374 616e 7473  .hfw * constants
-00019860: 2e4d 4554 5245 5f54 4f5f 4d49 4c4c 494d  .METRE_TO_MILLIM
-00019870: 4554 5245 0a20 2020 2020 2020 2029 0a20  ETRE.        ). 
-00019880: 2020 2020 2020 2069 6620 696d 6167 655f         if image_
-00019890: 7365 7474 696e 6773 2e72 6564 7563 6564  settings.reduced
-000198a0: 5f61 7265 6120 6973 206e 6f74 204e 6f6e  _area is not Non
-000198b0: 653a 0a20 2020 2020 2020 2020 2020 206c  e:.            l
-000198c0: 6566 7420 3d20 2069 6e74 2869 6d61 6765  eft =  int(image
-000198d0: 5f73 6574 7469 6e67 732e 7265 6475 6365  _settings.reduce
-000198e0: 645f 6172 6561 2e6c 6566 7420 2a20 696d  d_area.left * im
-000198f0: 6167 6557 6964 7468 290a 2020 2020 2020  ageWidth).      
-00019900: 2020 2020 2020 746f 7020 3d20 696e 7428        top = int(
-00019910: 696d 6167 655f 7365 7474 696e 6773 2e72  image_settings.r
-00019920: 6564 7563 6564 5f61 7265 612e 746f 7020  educed_area.top 
-00019930: 2a20 696d 6167 6548 6569 6768 7429 200a  * imageHeight) .
-00019940: 2020 2020 2020 2020 2020 2020 7769 6474              widt
-00019950: 6820 3d20 696e 7428 696d 6167 655f 7365  h = int(image_se
-00019960: 7474 696e 6773 2e72 6564 7563 6564 5f61  ttings.reduced_a
-00019970: 7265 612e 7769 6474 6820 2a20 696d 6167  rea.width * imag
-00019980: 6557 6964 7468 290a 2020 2020 2020 2020  eWidth).        
-00019990: 2020 2020 6865 6967 6874 203d 2069 6e74      height = int
-000199a0: 2869 6d61 6765 5f73 6574 7469 6e67 732e  (image_settings.
-000199b0: 7265 6475 6365 645f 6172 6561 2e68 6569  reduced_area.hei
-000199c0: 6768 7420 2a20 696d 6167 6548 6569 6768  ght * imageHeigh
-000199d0: 7429 0a20 2020 2020 2020 2020 2020 2069  t).            i
-000199e0: 6d61 6765 203d 2073 656c 662e 636f 6e6e  mage = self.conn
-000199f0: 6563 7469 6f6e 2e53 454d 2e53 6361 6e2e  ection.SEM.Scan.
-00019a00: 4163 7175 6972 6552 4f49 4672 6f6d 4368  AcquireROIFromCh
-00019a10: 616e 6e65 6c28 0a20 2020 2020 2020 2020  annel(.         
-00019a20: 2020 2020 2020 2043 6861 6e6e 656c 3d20         Channel= 
-00019a30: 302c 0a20 2020 2020 2020 2020 2020 2020  0,.             
-00019a40: 2020 2057 6964 7468 3d20 696d 6167 6557     Width= imageW
-00019a50: 6964 7468 2c0a 2020 2020 2020 2020 2020  idth,.          
-00019a60: 2020 2020 2020 4865 6967 6874 3d20 696d        Height= im
-00019a70: 6167 6548 6569 6768 742c 0a20 2020 2020  ageHeight,.     
-00019a80: 2020 2020 2020 2020 2020 204c 6566 743d             Left=
-00019a90: 206c 6566 742c 0a20 2020 2020 2020 2020   left,.         
-00019aa0: 2020 2020 2020 2054 6f70 3d20 746f 702c         Top= top,
-00019ab0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00019ac0: 2052 6967 6874 3d20 6c65 6674 202b 2077   Right= left + w
-00019ad0: 6964 7468 202d 3120 2c0a 2020 2020 2020  idth -1 ,.      
-00019ae0: 2020 2020 2020 2020 2020 426f 7474 6f6d            Bottom
-00019af0: 3d20 746f 7020 2b20 6865 6967 6874 202d  = top + height -
-00019b00: 2031 2c0a 2020 2020 2020 2020 2020 2020   1,.            
-00019b10: 2020 2020 4477 656c 6c54 696d 653d 2064      DwellTime= d
-00019b20: 7765 6c6c 5f74 696d 650a 2020 2020 2020  well_time.      
-00019b30: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00019b40: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00019b50: 2020 696d 6167 6520 3d20 7365 6c66 2e63    image = self.c
-00019b60: 6f6e 6e65 6374 696f 6e2e 5345 4d2e 5363  onnection.SEM.Sc
-00019b70: 616e 2e41 6371 7569 7265 496d 6167 6546  an.AcquireImageF
-00019b80: 726f 6d43 6861 6e6e 656c 280a 2020 2020  romChannel(.    
-00019b90: 2020 2020 2020 2020 2020 2020 302c 2069              0, i
-00019ba0: 6d61 6765 5769 6474 682c 2069 6d61 6765  mageWidth, image
-00019bb0: 4865 6967 6874 2c20 6477 656c 6c5f 7469  Height, dwell_ti
-00019bc0: 6d65 0a20 2020 2020 2020 2020 2020 2029  me.            )
-00019bd0: 0a0a 2020 2020 2020 2020 6d69 6372 6f73  ..        micros
-00019be0: 636f 7065 5f73 7461 7465 203d 204d 6963  cope_state = Mic
-00019bf0: 726f 7363 6f70 6553 7461 7465 280a 2020  roscopeState(.  
-00019c00: 2020 2020 2020 2020 2020 7469 6d65 7374            timest
-00019c10: 616d 703d 6461 7465 7469 6d65 2e64 6174  amp=datetime.dat
-00019c20: 6574 696d 652e 7469 6d65 7374 616d 7028  etime.timestamp(
-00019c30: 6461 7465 7469 6d65 2e64 6174 6574 696d  datetime.datetim
-00019c40: 652e 6e6f 7728 2929 2c0a 2020 2020 2020  e.now()),.      
-00019c50: 2020 2020 2020 6162 736f 6c75 7465 5f70        absolute_p
-00019c60: 6f73 6974 696f 6e3d 4669 6273 656d 5374  osition=FibsemSt
-00019c70: 6167 6550 6f73 6974 696f 6e28 0a20 2020  agePosition(.   
-00019c80: 2020 2020 2020 2020 2020 2020 2078 3d66               x=f
-00019c90: 6c6f 6174 2869 6d61 6765 2e48 6561 6465  loat(image.Heade
-00019ca0: 725b 2253 454d 225d 5b22 5374 6167 6558  r["SEM"]["StageX
-00019cb0: 225d 292c 0a20 2020 2020 2020 2020 2020  "]),.           
-00019cc0: 2020 2020 2079 3d66 6c6f 6174 2869 6d61       y=float(ima
-00019cd0: 6765 2e48 6561 6465 725b 2253 454d 225d  ge.Header["SEM"]
-00019ce0: 5b22 5374 6167 6559 225d 292c 0a20 2020  ["StageY"]),.   
-00019cf0: 2020 2020 2020 2020 2020 2020 207a 3d66               z=f
-00019d00: 6c6f 6174 2869 6d61 6765 2e48 6561 6465  loat(image.Heade
-00019d10: 725b 2253 454d 225d 5b22 5374 6167 655a  r["SEM"]["StageZ
-00019d20: 225d 292c 0a20 2020 2020 2020 2020 2020  "]),.           
-00019d30: 2020 2020 2072 3d66 6c6f 6174 2869 6d61       r=float(ima
-00019d40: 6765 2e48 6561 6465 725b 2253 454d 225d  ge.Header["SEM"]
-00019d50: 5b22 5374 6167 6552 6f74 6174 696f 6e22  ["StageRotation"
-00019d60: 5d29 2c0a 2020 2020 2020 2020 2020 2020  ]),.            
-00019d70: 2020 2020 743d 666c 6f61 7428 696d 6167      t=float(imag
-00019d80: 652e 4865 6164 6572 5b22 5345 4d22 5d5b  e.Header["SEM"][
-00019d90: 2253 7461 6765 5469 6c74 225d 292c 0a20  "StageTilt"]),. 
-00019da0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-00019db0: 6f6f 7264 696e 6174 655f 7379 7374 656d  oordinate_system
-00019dc0: 3d22 5241 5722 2c0a 2020 2020 2020 2020  ="RAW",.        
-00019dd0: 2020 2020 292c 0a20 2020 2020 2020 2020      ),.         
-00019de0: 2020 2065 625f 7365 7474 696e 6773 3d42     eb_settings=B
-00019df0: 6561 6d53 6574 7469 6e67 7328 0a20 2020  eamSettings(.   
-00019e00: 2020 2020 2020 2020 2020 2020 2062 6561               bea
-00019e10: 6d5f 7479 7065 3d42 6561 6d54 7970 652e  m_type=BeamType.
-00019e20: 454c 4543 5452 4f4e 2c0a 2020 2020 2020  ELECTRON,.      
-00019e30: 2020 2020 2020 2020 2020 776f 726b 696e            workin
-00019e40: 675f 6469 7374 616e 6365 3d66 6c6f 6174  g_distance=float
-00019e50: 2869 6d61 6765 2e48 6561 6465 725b 2253  (image.Header["S
-00019e60: 454d 225d 5b22 5744 225d 292c 0a20 2020  EM"]["WD"]),.   
-00019e70: 2020 2020 2020 2020 2020 2020 2062 6561               bea
-00019e80: 6d5f 6375 7272 656e 743d 666c 6f61 7428  m_current=float(
-00019e90: 696d 6167 652e 4865 6164 6572 5b22 5345  image.Header["SE
-00019ea0: 4d22 5d5b 2250 7265 6469 6374 6564 4265  M"]["PredictedBe
-00019eb0: 616d 4375 7272 656e 7422 5d29 2c0a 2020  amCurrent"]),.  
-00019ec0: 2020 2020 2020 2020 2020 2020 2020 7265                re
-00019ed0: 736f 6c75 7469 6f6e 3d5b 696d 6167 6557  solution=[imageW
-00019ee0: 6964 7468 2c20 696d 6167 6548 6569 6768  idth, imageHeigh
-00019ef0: 745d 2c20 2322 7b7d 787b 7d22 2e66 6f72  t], #"{}x{}".for
-00019f00: 6d61 7428 696d 6167 6557 6964 7468 2c20  mat(imageWidth, 
-00019f10: 696d 6167 6548 6569 6768 7429 2c0a 2020  imageHeight),.  
-00019f20: 2020 2020 2020 2020 2020 2020 2020 6477                dw
-00019f30: 656c 6c5f 7469 6d65 3d66 6c6f 6174 2869  ell_time=float(i
-00019f40: 6d61 6765 2e48 6561 6465 725b 2253 454d  mage.Header["SEM
-00019f50: 225d 5b22 4477 656c 6c54 696d 6522 5d29  "]["DwellTime"])
-00019f60: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00019f70: 2020 7374 6967 6d61 7469 6f6e 3d50 6f69    stigmation=Poi
-00019f80: 6e74 280a 2020 2020 2020 2020 2020 2020  nt(.            
-00019f90: 2020 2020 2020 2020 666c 6f61 7428 696d          float(im
-00019fa0: 6167 652e 4865 6164 6572 5b22 5345 4d22  age.Header["SEM"
-00019fb0: 5d5b 2253 7469 676d 6174 6f72 5822 5d29  ]["StigmatorX"])
-00019fc0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00019fd0: 2020 2020 2020 666c 6f61 7428 696d 6167        float(imag
-00019fe0: 652e 4865 6164 6572 5b22 5345 4d22 5d5b  e.Header["SEM"][
-00019ff0: 2253 7469 676d 6174 6f72 5922 5d29 2c0a  "StigmatorY"]),.
-0001a000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a010: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
-0001a020: 2020 2073 6869 6674 3d50 6f69 6e74 280a     shift=Point(.
-0001a030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a040: 2020 2020 666c 6f61 7428 696d 6167 652e      float(image.
-0001a050: 4865 6164 6572 5b22 5345 4d22 5d5b 2249  Header["SEM"]["I
-0001a060: 6d61 6765 5368 6966 7458 225d 292c 0a20  mageShiftX"]),. 
-0001a070: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a080: 2020 2066 6c6f 6174 2869 6d61 6765 2e48     float(image.H
-0001a090: 6561 6465 725b 2253 454d 225d 5b22 496d  eader["SEM"]["Im
-0001a0a0: 6167 6553 6869 6674 5922 5d29 2c0a 2020  ageShiftY"]),.  
-0001a0b0: 2020 2020 2020 2020 2020 2020 2020 292c                ),
-0001a0c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001a0d0: 2073 6361 6e5f 726f 7461 7469 6f6e 3d73   scan_rotation=s
-0001a0e0: 656c 662e 636f 6e6e 6563 7469 6f6e 2e53  elf.connection.S
-0001a0f0: 454d 2e4f 7074 6963 732e 4765 7449 6d61  EM.Optics.GetIma
-0001a100: 6765 526f 7461 7469 6f6e 2829 2c0a 2020  geRotation(),.  
-0001a110: 2020 2020 2020 2020 2020 292c 0a20 2020            ),.   
-0001a120: 2020 2020 2020 2020 2069 625f 7365 7474           ib_sett
-0001a130: 696e 6773 3d42 6561 6d53 6574 7469 6e67  ings=BeamSetting
-0001a140: 7328 6265 616d 5f74 7970 653d 4265 616d  s(beam_type=Beam
-0001a150: 5479 7065 2e49 4f4e 292c 0a20 2020 2020  Type.ION),.     
-0001a160: 2020 2029 0a0a 2020 2020 2020 2020 6465     )..        de
-0001a170: 7465 6374 6f72 203d 2046 6962 7365 6d44  tector = FibsemD
-0001a180: 6574 6563 746f 7253 6574 7469 6e67 7328  etectorSettings(
-0001a190: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001a1a0: 2074 7970 6520 3d20 7365 6c66 2e67 6574   type = self.get
-0001a1b0: 2822 6465 7465 6374 6f72 5f74 7970 6522  ("detector_type"
-0001a1c0: 2c20 696d 6167 655f 7365 7474 696e 6773  , image_settings
-0001a1d0: 2e62 6561 6d5f 7479 7065 292c 0a20 2020  .beam_type),.   
-0001a1e0: 2020 2020 2020 2020 2020 2020 206d 6f64               mod
-0001a1f0: 6520 3d20 224e 2f41 222c 0a20 2020 2020  e = "N/A",.     
-0001a200: 2020 2020 2020 2020 2020 2063 6f6e 7472             contr
-0001a210: 6173 7420 3d20 7365 6c66 2e67 6574 2822  ast = self.get("
-0001a220: 6465 7465 6374 6f72 5f63 6f6e 7472 6173  detector_contras
-0001a230: 7422 2c20 696d 6167 655f 7365 7474 696e  t", image_settin
-0001a240: 6773 2e62 6561 6d5f 7479 7065 292c 0a20  gs.beam_type),. 
-0001a250: 2020 2020 2020 2020 2020 2020 2020 2062                 b
-0001a260: 7269 6768 746e 6573 733d 2073 656c 662e  rightness= self.
-0001a270: 6765 7428 2264 6574 6563 746f 725f 6272  get("detector_br
-0001a280: 6967 6874 6e65 7373 222c 2069 6d61 6765  ightness", image
-0001a290: 5f73 6574 7469 6e67 732e 6265 616d 5f74  _settings.beam_t
-0001a2a0: 7970 6529 2c0a 0a20 2020 2020 2020 2020  ype),..         
-0001a2b0: 2020 2029 0a0a 2020 2020 2020 2020 696d     )..        im
-0001a2c0: 6167 655f 7365 7474 696e 6773 2e72 6573  age_settings.res
-0001a2d0: 6f6c 7574 696f 6e20 3d20 5b69 6d61 6765  olution = [image
-0001a2e0: 5769 6474 682c 2069 6d61 6765 4865 6967  Width, imageHeig
-0001a2f0: 6874 5d0a 2020 2020 2020 2020 6669 6273  ht].        fibs
-0001a300: 656d 5f69 6d61 6765 203d 2046 6962 7365  em_image = Fibse
-0001a310: 6d49 6d61 6765 2e66 726f 6d54 6573 6361  mImage.fromTesca
-0001a320: 6e49 6d61 6765 280a 2020 2020 2020 2020  nImage(.        
-0001a330: 2020 2020 696d 6167 652c 2064 6565 7063      image, deepc
-0001a340: 6f70 7928 696d 6167 655f 7365 7474 696e  opy(image_settin
-0001a350: 6773 292c 2064 6565 7063 6f70 7928 6d69  gs), deepcopy(mi
-0001a360: 6372 6f73 636f 7065 5f73 7461 7465 292c  croscope_state),
-0001a370: 2064 6574 6563 746f 723d 2064 6574 6563   detector= detec
-0001a380: 746f 720a 2020 2020 2020 2020 290a 0a20  tor.        ).. 
-0001a390: 2020 2020 2020 2023 6669 6273 656d 5f69         #fibsem_i
-0001a3a0: 6d61 6765 2e6d 6574 6164 6174 612e 696d  mage.metadata.im
-0001a3b0: 6167 655f 7365 7474 696e 6773 2e72 6573  age_settings.res
-0001a3c0: 6f6c 7574 696f 6e20 3d20 5b69 6d61 6765  olution = [image
-0001a3d0: 5769 6474 682c 2069 6d61 6765 4865 6967  Width, imageHeig
-0001a3e0: 6874 5d0a 0a20 2020 2020 2020 2072 6574  ht]..        ret
-0001a3f0: 7572 6e20 6669 6273 656d 5f69 6d61 6765  urn fibsem_image
-0001a400: 0a0a 2020 2020 6465 6620 5f67 6574 5f69  ..    def _get_i
-0001a410: 625f 696d 6167 6528 7365 6c66 2c20 696d  b_image(self, im
-0001a420: 6167 655f 7365 7474 696e 6773 3a20 496d  age_settings: Im
-0001a430: 6167 6553 6574 7469 6e67 7329 3a0a 2020  ageSettings):.  
-0001a440: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-0001a450: 2020 4163 7175 6972 6573 2061 6e20 696f    Acquires an io
-0001a460: 6e20 6265 616d 2028 4942 2920 696d 6167  n beam (IB) imag
-0001a470: 6520 7769 7468 2074 6865 2067 6976 656e  e with the given
-0001a480: 2073 6574 7469 6e67 7320 616e 6420 7265   settings and re
-0001a490: 7475 726e 7320 6120 4669 6273 656d 496d  turns a FibsemIm
-0001a4a0: 6167 6520 6f62 6a65 6374 2e0a 0a20 2020  age object...   
-0001a4b0: 2020 2020 2041 7267 733a 0a20 2020 2020       Args:.     
-0001a4c0: 2020 2020 2020 2069 6d61 6765 5f73 6574         image_set
-0001a4d0: 7469 6e67 7320 2849 6d61 6765 5365 7474  tings (ImageSett
-0001a4e0: 696e 6773 293a 2054 6865 2073 6574 7469  ings): The setti
-0001a4f0: 6e67 7320 666f 7220 7468 6520 6163 7175  ngs for the acqu
-0001a500: 6972 6564 2069 6d61 6765 2e0a 0a20 2020  ired image...   
-0001a510: 2020 2020 2052 6574 7572 6e73 3a0a 2020       Returns:.  
-0001a520: 2020 2020 2020 2020 2020 4669 6273 656d            Fibsem
-0001a530: 496d 6167 653a 2054 6865 2061 6371 7569  Image: The acqui
-0001a540: 7265 6420 696d 6167 6520 6173 2061 2046  red image as a F
-0001a550: 6962 7365 6d49 6d61 6765 206f 626a 6563  ibsemImage objec
-0001a560: 742e 0a0a 2020 2020 2020 2020 4e6f 7465  t...        Note
-0001a570: 733a 0a20 2020 2020 2020 2020 2020 202d  s:.            -
-0001a580: 2054 6865 2066 756e 6374 696f 6e20 6163   The function ac
-0001a590: 7175 6972 6573 2061 6e20 4942 2069 6d61  quires an IB ima
-0001a5a0: 6765 2077 6974 6820 7468 6520 6769 7665  ge with the give
-0001a5b0: 6e20 7365 7474 696e 6773 2062 7920 636f  n settings by co
-0001a5c0: 6e66 6967 7572 696e 6720 7468 6520 6465  nfiguring the de
-0001a5d0: 7465 6374 6f72 732c 2073 6361 6e6e 696e  tectors, scannin
-0001a5e0: 672c 2061 6e64 2073 656c 6563 7469 6e67  g, and selecting
-0001a5f0: 2074 6865 2064 7765 6c6c 2074 696d 652c   the dwell time,
-0001a600: 2072 6573 6f6c 7574 696f 6e2c 2061 6e64   resolution, and
-0001a610: 2076 6965 7766 6965 6c64 2e0a 2020 2020   viewfield..    
-0001a620: 2020 2020 2020 2020 2d20 4966 2074 6865          - If the
-0001a630: 2069 6d61 6765 2073 6574 7469 6e67 7320   image settings 
-0001a640: 696e 636c 7564 6520 6120 7265 6475 6365  include a reduce
-0001a650: 6420 6172 6561 2c20 7468 6520 6675 6e63  d area, the func
-0001a660: 7469 6f6e 2077 696c 6c20 6163 7175 6972  tion will acquir
-0001a670: 6520 616e 2069 6d61 6765 2077 6974 6869  e an image withi
-0001a680: 6e20 7468 6520 7265 6475 6365 6420 6172  n the reduced ar
-0001a690: 6561 2e0a 2020 2020 2020 2020 2020 2020  ea..            
-0001a6a0: 2d20 5468 6520 6675 6e63 7469 6f6e 2061  - The function a
-0001a6b0: 6c73 6f20 6361 7074 7572 6573 2074 6865  lso captures the
-0001a6c0: 206d 6963 726f 7363 6f70 6520 7374 6174   microscope stat
-0001a6d0: 6520 6174 2074 6865 2074 696d 6520 6f66  e at the time of
-0001a6e0: 2061 6371 7569 7369 7469 6f6e 2061 6e64   acquisition and
-0001a6f0: 2069 6e63 6c75 6465 7320 7468 6973 2069   includes this i
-0001a700: 6e66 6f72 6d61 7469 6f6e 2069 6e20 7468  nformation in th
-0001a710: 6520 6d65 7461 6461 7461 206f 6620 7468  e metadata of th
-0001a720: 6520 6163 7175 6972 6564 2069 6d61 6765  e acquired image
-0001a730: 2e0a 2020 2020 2020 2020 2222 220a 2020  ..        """.  
-0001a740: 2020 2020 2020 2320 4174 2066 6972 7374        # At first
-0001a750: 206d 616b 6520 7375 7265 2074 6865 2062   make sure the b
-0001a760: 6561 6d20 6973 204f 4e0a 2020 2020 2020  eam is ON.      
-0001a770: 2020 7374 6174 7573 203d 2073 656c 662e    status = self.
-0001a780: 636f 6e6e 6563 7469 6f6e 2e46 4942 2e42  connection.FIB.B
-0001a790: 6561 6d2e 4765 7453 7461 7475 7328 290a  eam.GetStatus().
-0001a7a0: 2020 2020 2020 2020 6966 2073 7461 7475          if statu
-0001a7b0: 7320 213d 2041 7574 6f6d 6174 696f 6e2e  s != Automation.
-0001a7c0: 4649 422e 4265 616d 2e53 7461 7475 732e  FIB.Beam.Status.
-0001a7d0: 4265 616d 4f6e 3a0a 2020 2020 2020 2020  BeamOn:.        
-0001a7e0: 2020 2020 7365 6c66 2e63 6f6e 6e65 6374      self.connect
-0001a7f0: 696f 6e2e 4649 422e 4265 616d 2e4f 6e28  ion.FIB.Beam.On(
-0001a800: 290a 2020 2020 2020 2020 2320 696d 706f  ).        # impo
-0001a810: 7274 616e 743a 2073 746f 7020 7468 6520  rtant: stop the 
-0001a820: 7363 616e 6e69 6e67 2062 6566 6f72 6520  scanning before 
-0001a830: 7765 2073 7461 7274 2073 6361 6e6e 696e  we start scannin
-0001a840: 6720 6f72 2062 6566 6f72 6520 6175 746f  g or before auto
-0001a850: 6d61 7469 6320 7072 6f63 6564 7572 6573  matic procedures
-0001a860: 2c0a 2020 2020 2020 2020 2320 6576 656e  ,.        # even
-0001a870: 2062 6566 6f72 6520 7765 2063 6f6e 6669   before we confi
-0001a880: 6775 7265 2074 6865 2064 6574 6563 746f  gure the detecto
-0001a890: 7273 0a20 2020 2020 2020 2073 656c 662e  rs.        self.
-0001a8a0: 636f 6e6e 6563 7469 6f6e 2e46 4942 2e53  connection.FIB.S
-0001a8b0: 6361 6e2e 5374 6f70 2829 0a20 2020 2020  can.Stop().     
-0001a8c0: 2020 2023 2053 656c 6563 7420 7468 6520     # Select the 
-0001a8d0: 6465 7465 6374 6f72 2066 6f72 2069 6d61  detector for ima
-0001a8e0: 6765 2069 2e65 2e3a 0a20 2020 2020 2020  ge i.e.:.       
-0001a8f0: 2023 2031 2e20 6173 7369 676e 2074 6865   # 1. assign the
-0001a900: 2064 6574 6563 746f 7220 746f 2061 2063   detector to a c
-0001a910: 6861 6e6e 656c 0a20 2020 2020 2020 2023  hannel.        #
-0001a920: 2032 2e20 656e 6162 6c65 2074 6865 2063   2. enable the c
-0001a930: 6861 6e6e 656c 2066 6f72 2061 6371 7569  hannel for acqui
-0001a940: 7369 7469 6f6e 0a20 2020 2020 2020 2073  sition.        s
-0001a950: 656c 662e 636f 6e6e 6563 7469 6f6e 2e46  elf.connection.F
-0001a960: 4942 2e44 6574 6563 746f 722e 5365 7428  IB.Detector.Set(
-0001a970: 0a20 2020 2020 2020 2020 2020 2030 2c20  .            0, 
-0001a980: 7365 6c66 2e69 6f6e 5f64 6574 6563 746f  self.ion_detecto
-0001a990: 725f 6163 7469 7665 2c20 4270 702e 4772  r_active, Bpp.Gr
-0001a9a0: 6179 7363 616c 655f 385f 6269 740a 2020  ayscale_8_bit.  
-0001a9b0: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
-0001a9c0: 2064 7765 6c6c 5f74 696d 6520 3d20 696d   dwell_time = im
-0001a9d0: 6167 655f 7365 7474 696e 6773 2e64 7765  age_settings.dwe
-0001a9e0: 6c6c 5f74 696d 6520 2a20 636f 6e73 7461  ll_time * consta
-0001a9f0: 6e74 732e 5349 5f54 4f5f 4e41 4e4f 0a0a  nts.SI_TO_NANO..
-0001aa00: 2020 2020 2020 2020 2320 7265 736f 6c75          # resolu
-0001aa10: 7469 6f6e 0a20 2020 2020 2020 2069 6d61  tion.        ima
-0001aa20: 6765 5769 6474 6820 3d20 696d 6167 655f  geWidth = image_
-0001aa30: 7365 7474 696e 6773 2e72 6573 6f6c 7574  settings.resolut
-0001aa40: 696f 6e5b 305d 0a20 2020 2020 2020 2069  ion[0].        i
-0001aa50: 6d61 6765 4865 6967 6874 203d 2069 6d61  mageHeight = ima
-0001aa60: 6765 5f73 6574 7469 6e67 732e 7265 736f  ge_settings.reso
-0001aa70: 6c75 7469 6f6e 5b31 5d0a 0a20 2020 2020  lution[1]..     
-0001aa80: 2020 2073 656c 662e 636f 6e6e 6563 7469     self.connecti
-0001aa90: 6f6e 2e46 4942 2e4f 7074 6963 732e 5365  on.FIB.Optics.Se
-0001aaa0: 7456 6965 7766 6965 6c64 280a 2020 2020  tViewfield(.    
-0001aab0: 2020 2020 2020 2020 696d 6167 655f 7365          image_se
-0001aac0: 7474 696e 6773 2e68 6677 202a 2063 6f6e  ttings.hfw * con
-0001aad0: 7374 616e 7473 2e4d 4554 5245 5f54 4f5f  stants.METRE_TO_
-0001aae0: 4d49 4c4c 494d 4554 5245 0a20 2020 2020  MILLIMETRE.     
-0001aaf0: 2020 2029 0a20 2020 2020 2020 200a 2020     ).        .  
-0001ab00: 2020 2020 2020 0a20 2020 2020 2020 2069        .        i
-0001ab10: 6620 696d 6167 655f 7365 7474 696e 6773  f image_settings
-0001ab20: 2e72 6564 7563 6564 5f61 7265 6120 6973  .reduced_area is
-0001ab30: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
-0001ab40: 2020 2020 2020 206c 6566 7420 3d20 2069         left =  i
-0001ab50: 6e74 2869 6d61 6765 5f73 6574 7469 6e67  nt(image_setting
-0001ab60: 732e 7265 6475 6365 645f 6172 6561 2e6c  s.reduced_area.l
-0001ab70: 6566 7420 2a20 696d 6167 6557 6964 7468  eft * imageWidth
-0001ab80: 290a 2020 2020 2020 2020 2020 2020 746f  ).            to
-0001ab90: 7020 3d20 696e 7428 696d 6167 655f 7365  p = int(image_se
-0001aba0: 7474 696e 6773 2e72 6564 7563 6564 5f61  ttings.reduced_a
-0001abb0: 7265 612e 746f 7020 2a20 696d 6167 6548  rea.top * imageH
-0001abc0: 6569 6768 7429 200a 2020 2020 2020 2020  eight) .        
-0001abd0: 2020 2020 7769 6474 6820 3d20 696e 7428      width = int(
-0001abe0: 696d 6167 655f 7365 7474 696e 6773 2e72  image_settings.r
-0001abf0: 6564 7563 6564 5f61 7265 612e 7769 6474  educed_area.widt
-0001ac00: 6820 2a20 696d 6167 6557 6964 7468 290a  h * imageWidth).
-0001ac10: 2020 2020 2020 2020 2020 2020 6865 6967              heig
-0001ac20: 6874 203d 2069 6e74 2869 6d61 6765 5f73  ht = int(image_s
-0001ac30: 6574 7469 6e67 732e 7265 6475 6365 645f  ettings.reduced_
-0001ac40: 6172 6561 2e68 6569 6768 7420 2a20 696d  area.height * im
-0001ac50: 6167 6548 6569 6768 7429 0a20 2020 2020  ageHeight).     
-0001ac60: 2020 2020 2020 2069 6d61 6765 203d 2073         image = s
-0001ac70: 656c 662e 636f 6e6e 6563 7469 6f6e 2e46  elf.connection.F
-0001ac80: 4942 2e53 6361 6e2e 4163 7175 6972 6552  IB.Scan.AcquireR
-0001ac90: 4f49 4672 6f6d 4368 616e 6e65 6c28 0a20  OIFromChannel(. 
-0001aca0: 2020 2020 2020 2020 2020 2020 2020 2043                 C
-0001acb0: 6861 6e6e 656c 3d20 302c 0a20 2020 2020  hannel= 0,.     
-0001acc0: 2020 2020 2020 2020 2020 2057 6964 7468             Width
-0001acd0: 3d20 696d 6167 6557 6964 7468 2c0a 2020  = imageWidth,.  
-0001ace0: 2020 2020 2020 2020 2020 2020 2020 4865                He
-0001acf0: 6967 6874 3d20 696d 6167 6548 6569 6768  ight= imageHeigh
-0001ad00: 742c 0a20 2020 2020 2020 2020 2020 2020  t,.             
-0001ad10: 2020 204c 6566 743d 206c 6566 742c 0a20     Left= left,. 
-0001ad20: 2020 2020 2020 2020 2020 2020 2020 2054                 T
-0001ad30: 6f70 3d20 746f 702c 0a20 2020 2020 2020  op= top,.       
-0001ad40: 2020 2020 2020 2020 2052 6967 6874 3d20           Right= 
-0001ad50: 6c65 6674 202b 2077 6964 7468 202d 3120  left + width -1 
-0001ad60: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0001ad70: 2020 426f 7474 6f6d 3d20 746f 7020 2b20    Bottom= top + 
-0001ad80: 6865 6967 6874 202d 2031 2c0a 2020 2020  height - 1,.    
-0001ad90: 2020 2020 2020 2020 2020 2020 4477 656c              Dwel
-0001ada0: 6c54 696d 653d 2064 7765 6c6c 5f74 696d  lTime= dwell_tim
-0001adb0: 650a 2020 2020 2020 2020 2020 2020 290a  e.            ).
-0001adc0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-0001add0: 2020 2020 2020 2020 2020 696d 6167 6520            image 
-0001ade0: 3d20 7365 6c66 2e63 6f6e 6e65 6374 696f  = self.connectio
-0001adf0: 6e2e 4649 422e 5363 616e 2e41 6371 7569  n.FIB.Scan.Acqui
-0001ae00: 7265 496d 6167 6546 726f 6d43 6861 6e6e  reImageFromChann
-0001ae10: 656c 280a 2020 2020 2020 2020 2020 2020  el(.            
-0001ae20: 2020 2020 302c 2069 6d61 6765 5769 6474      0, imageWidt
-0001ae30: 682c 2069 6d61 6765 4865 6967 6874 2c20  h, imageHeight, 
-0001ae40: 6477 656c 6c5f 7469 6d65 0a20 2020 2020  dwell_time.     
-0001ae50: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
-0001ae60: 2020 6d69 6372 6f73 636f 7065 5f73 7461    microscope_sta
-0001ae70: 7465 203d 204d 6963 726f 7363 6f70 6553  te = MicroscopeS
-0001ae80: 7461 7465 280a 2020 2020 2020 2020 2020  tate(.          
-0001ae90: 2020 7469 6d65 7374 616d 703d 6461 7465    timestamp=date
-0001aea0: 7469 6d65 2e64 6174 6574 696d 652e 7469  time.datetime.ti
-0001aeb0: 6d65 7374 616d 7028 6461 7465 7469 6d65  mestamp(datetime
-0001aec0: 2e64 6174 6574 696d 652e 6e6f 7728 2929  .datetime.now())
-0001aed0: 2c0a 2020 2020 2020 2020 2020 2020 6162  ,.            ab
-0001aee0: 736f 6c75 7465 5f70 6f73 6974 696f 6e3d  solute_position=
-0001aef0: 4669 6273 656d 5374 6167 6550 6f73 6974  FibsemStagePosit
-0001af00: 696f 6e28 0a20 2020 2020 2020 2020 2020  ion(.           
-0001af10: 2020 2020 2078 3d66 6c6f 6174 2869 6d61       x=float(ima
-0001af20: 6765 2e48 6561 6465 725b 2246 4942 225d  ge.Header["FIB"]
-0001af30: 5b22 5374 6167 6558 225d 292c 0a20 2020  ["StageX"]),.   
-0001af40: 2020 2020 2020 2020 2020 2020 2079 3d66               y=f
-0001af50: 6c6f 6174 2869 6d61 6765 2e48 6561 6465  loat(image.Heade
-0001af60: 725b 2246 4942 225d 5b22 5374 6167 6559  r["FIB"]["StageY
-0001af70: 225d 292c 0a20 2020 2020 2020 2020 2020  "]),.           
-0001af80: 2020 2020 207a 3d66 6c6f 6174 2869 6d61       z=float(ima
-0001af90: 6765 2e48 6561 6465 725b 2246 4942 225d  ge.Header["FIB"]
-0001afa0: 5b22 5374 6167 655a 225d 292c 0a20 2020  ["StageZ"]),.   
-0001afb0: 2020 2020 2020 2020 2020 2020 2072 3d66               r=f
-0001afc0: 6c6f 6174 2869 6d61 6765 2e48 6561 6465  loat(image.Heade
-0001afd0: 725b 2246 4942 225d 5b22 5374 6167 6552  r["FIB"]["StageR
-0001afe0: 6f74 6174 696f 6e22 5d29 2c0a 2020 2020  otation"]),.    
-0001aff0: 2020 2020 2020 2020 2020 2020 743d 666c              t=fl
-0001b000: 6f61 7428 696d 6167 652e 4865 6164 6572  oat(image.Header
-0001b010: 5b22 4649 4222 5d5b 2253 7461 6765 5469  ["FIB"]["StageTi
-0001b020: 6c74 225d 292c 0a20 2020 2020 2020 2020  lt"]),.         
-0001b030: 2020 2020 2020 2063 6f6f 7264 696e 6174         coordinat
-0001b040: 655f 7379 7374 656d 3d22 5241 5722 2c0a  e_system="RAW",.
-0001b050: 2020 2020 2020 2020 2020 2020 292c 0a20              ),. 
-0001b060: 2020 2020 2020 2020 2020 2065 625f 7365             eb_se
-0001b070: 7474 696e 6773 3d42 6561 6d53 6574 7469  ttings=BeamSetti
-0001b080: 6e67 7328 6265 616d 5f74 7970 653d 4265  ngs(beam_type=Be
-0001b090: 616d 5479 7065 2e45 4c45 4354 524f 4e29  amType.ELECTRON)
-0001b0a0: 2c0a 2020 2020 2020 2020 2020 2020 6962  ,.            ib
-0001b0b0: 5f73 6574 7469 6e67 733d 4265 616d 5365  _settings=BeamSe
-0001b0c0: 7474 696e 6773 280a 2020 2020 2020 2020  ttings(.        
-0001b0d0: 2020 2020 2020 2020 6265 616d 5f74 7970          beam_typ
-0001b0e0: 653d 4265 616d 5479 7065 2e49 4f4e 2c0a  e=BeamType.ION,.
-0001b0f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b100: 776f 726b 696e 675f 6469 7374 616e 6365  working_distance
-0001b110: 3d66 6c6f 6174 2869 6d61 6765 2e48 6561  =float(image.Hea
-0001b120: 6465 725b 2246 4942 225d 5b22 5744 225d  der["FIB"]["WD"]
-0001b130: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
-0001b140: 2020 2062 6561 6d5f 6375 7272 656e 743d     beam_current=
-0001b150: 666c 6f61 7428 7365 6c66 2e63 6f6e 6e65  float(self.conne
-0001b160: 6374 696f 6e2e 4649 422e 4265 616d 2e52  ction.FIB.Beam.R
-0001b170: 6561 6450 726f 6265 4375 7272 656e 7428  eadProbeCurrent(
-0001b180: 2929 2c0a 2020 2020 2020 2020 2020 2020  )),.            
-0001b190: 2020 2020 7265 736f 6c75 7469 6f6e 3d5b      resolution=[
-0001b1a0: 696d 6167 6557 6964 7468 2c20 696d 6167  imageWidth, imag
-0001b1b0: 6548 6569 6768 745d 2c20 2322 7b7d 787b  eHeight], #"{}x{
-0001b1c0: 7d22 2e66 6f72 6d61 7428 696d 6167 6557  }".format(imageW
-0001b1d0: 6964 7468 2c20 696d 6167 6548 6569 6768  idth, imageHeigh
-0001b1e0: 7429 2c0a 2020 2020 2020 2020 2020 2020  t),.            
-0001b1f0: 2020 2020 6477 656c 6c5f 7469 6d65 3d66      dwell_time=f
-0001b200: 6c6f 6174 2869 6d61 6765 2e48 6561 6465  loat(image.Heade
-0001b210: 725b 2246 4942 225d 5b22 4477 656c 6c54  r["FIB"]["DwellT
-0001b220: 696d 6522 5d29 2c0a 2020 2020 2020 2020  ime"]),.        
-0001b230: 2020 2020 2020 2020 7374 6967 6d61 7469          stigmati
-0001b240: 6f6e 3d50 6f69 6e74 280a 2020 2020 2020  on=Point(.      
-0001b250: 2020 2020 2020 2020 2020 2020 2020 666c                fl
-0001b260: 6f61 7428 696d 6167 652e 4865 6164 6572  oat(image.Header
-0001b270: 5b22 4649 4222 5d5b 2253 7469 676d 6174  ["FIB"]["Stigmat
-0001b280: 6f72 5822 5d29 2c0a 2020 2020 2020 2020  orX"]),.        
-0001b290: 2020 2020 2020 2020 2020 2020 666c 6f61              floa
-0001b2a0: 7428 696d 6167 652e 4865 6164 6572 5b22  t(image.Header["
-0001b2b0: 4649 4222 5d5b 2253 7469 676d 6174 6f72  FIB"]["Stigmator
-0001b2c0: 5922 5d29 2c0a 2020 2020 2020 2020 2020  Y"]),.          
-0001b2d0: 2020 2020 2020 292c 0a20 2020 2020 2020        ),.       
-0001b2e0: 2020 2020 2020 2020 2073 6869 6674 3d50           shift=P
-0001b2f0: 6f69 6e74 280a 2020 2020 2020 2020 2020  oint(.          
-0001b300: 2020 2020 2020 2020 2020 666c 6f61 7428            float(
-0001b310: 696d 6167 652e 4865 6164 6572 5b22 4649  image.Header["FI
-0001b320: 4222 5d5b 2249 6d61 6765 5368 6966 7458  B"]["ImageShiftX
-0001b330: 225d 292c 0a20 2020 2020 2020 2020 2020  "]),.           
-0001b340: 2020 2020 2020 2020 2066 6c6f 6174 2869           float(i
-0001b350: 6d61 6765 2e48 6561 6465 725b 2246 4942  mage.Header["FIB
-0001b360: 225d 5b22 496d 6167 6553 6869 6674 5922  "]["ImageShiftY"
-0001b370: 5d29 2c0a 2020 2020 2020 2020 2020 2020  ]),.            
-0001b380: 2020 2020 292c 0a20 2020 2020 2020 2020      ),.         
-0001b390: 2020 2020 2020 2073 6361 6e5f 726f 7461         scan_rota
-0001b3a0: 7469 6f6e 3d73 656c 662e 636f 6e6e 6563  tion=self.connec
-0001b3b0: 7469 6f6e 2e46 4942 2e4f 7074 6963 732e  tion.FIB.Optics.
-0001b3c0: 4765 7449 6d61 6765 526f 7461 7469 6f6e  GetImageRotation
-0001b3d0: 2829 2c0a 2020 2020 2020 2020 2020 2020  (),.            
-0001b3e0: 292c 0a20 2020 2020 2020 2029 0a0a 2020  ),.        )..  
-0001b3f0: 2020 2020 2020 6465 7465 6374 6f72 203d        detector =
-0001b400: 2046 6962 7365 6d44 6574 6563 746f 7253   FibsemDetectorS
-0001b410: 6574 7469 6e67 7328 0a20 2020 2020 2020  ettings(.       
-0001b420: 2020 2020 2020 2020 2074 7970 6520 3d20           type = 
-0001b430: 7365 6c66 2e67 6574 2822 6465 7465 6374  self.get("detect
-0001b440: 6f72 5f74 7970 6522 2c20 696d 6167 655f  or_type", image_
-0001b450: 7365 7474 696e 6773 2e62 6561 6d5f 7479  settings.beam_ty
-0001b460: 7065 292c 0a20 2020 2020 2020 2020 2020  pe),.           
-0001b470: 2020 2020 206d 6f64 6520 3d20 224e 2f41       mode = "N/A
-0001b480: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
-0001b490: 2020 2063 6f6e 7472 6173 7420 3d20 7365     contrast = se
-0001b4a0: 6c66 2e67 6574 2822 6465 7465 6374 6f72  lf.get("detector
-0001b4b0: 5f63 6f6e 7472 6173 7422 2c20 696d 6167  _contrast", imag
-0001b4c0: 655f 7365 7474 696e 6773 2e62 6561 6d5f  e_settings.beam_
-0001b4d0: 7479 7065 292c 0a20 2020 2020 2020 2020  type),.         
-0001b4e0: 2020 2020 2020 2062 7269 6768 746e 6573         brightnes
-0001b4f0: 733d 2073 656c 662e 6765 7428 2264 6574  s= self.get("det
-0001b500: 6563 746f 725f 6272 6967 6874 6e65 7373  ector_brightness
-0001b510: 222c 2069 6d61 6765 5f73 6574 7469 6e67  ", image_setting
-0001b520: 732e 6265 616d 5f74 7970 6529 2c0a 0a20  s.beam_type),.. 
-0001b530: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-0001b540: 2020 2020 2069 6d61 6765 5f73 6574 7469       image_setti
-0001b550: 6e67 732e 7265 736f 6c75 7469 6f6e 203d  ngs.resolution =
-0001b560: 205b 696d 6167 6557 6964 7468 2c20 696d   [imageWidth, im
-0001b570: 6167 6548 6569 6768 745d 0a20 2020 2020  ageHeight].     
-0001b580: 2020 2066 6962 7365 6d5f 696d 6167 6520     fibsem_image 
-0001b590: 3d20 4669 6273 656d 496d 6167 652e 6672  = FibsemImage.fr
-0001b5a0: 6f6d 5465 7363 616e 496d 6167 6528 0a20  omTescanImage(. 
-0001b5b0: 2020 2020 2020 2020 2020 2069 6d61 6765             image
-0001b5c0: 2c20 6465 6570 636f 7079 2869 6d61 6765  , deepcopy(image
-0001b5d0: 5f73 6574 7469 6e67 7329 2c20 6465 6570  _settings), deep
-0001b5e0: 636f 7079 286d 6963 726f 7363 6f70 655f  copy(microscope_
-0001b5f0: 7374 6174 6529 2c20 6465 7465 6374 6f72  state), detector
-0001b600: 3d20 6465 7465 6374 6f72 0a20 2020 2020  = detector.     
-0001b610: 2020 2029 0a0a 2020 2020 2020 2020 2320     )..        # 
-0001b620: 6669 6273 656d 5f69 6d61 6765 2e6d 6574  fibsem_image.met
-0001b630: 6164 6174 612e 696d 6167 655f 7365 7474  adata.image_sett
-0001b640: 696e 6773 2e72 6573 6f6c 7574 696f 6e20  ings.resolution 
-0001b650: 3d20 5b69 6d61 6765 5769 6474 682c 2069  = [imageWidth, i
-0001b660: 6d61 6765 4865 6967 6874 5d0a 0a20 2020  mageHeight]..   
-0001b670: 2020 2020 2072 6574 7572 6e20 6669 6273       return fibs
-0001b680: 656d 5f69 6d61 6765 0a0a 2020 2020 6465  em_image..    de
-0001b690: 6620 6c61 7374 5f69 6d61 6765 2873 656c  f last_image(sel
-0001b6a0: 662c 2062 6561 6d5f 7479 7065 3a20 4265  f, beam_type: Be
-0001b6b0: 616d 5479 7065 2e45 4c45 4354 524f 4e29  amType.ELECTRON)
-0001b6c0: 202d 3e20 4669 6273 656d 496d 6167 653a   -> FibsemImage:
-0001b6d0: 0a20 2020 2020 2020 2022 2222 2020 2020  .        """    
-0001b6e0: 0a20 2020 2020 2020 2052 6574 7572 6e73  .        Returns
-0001b6f0: 2074 6865 206c 6173 7420 6163 7175 6972   the last acquir
-0001b700: 6564 2069 6d61 6765 2066 6f72 2074 6865  ed image for the
-0001b710: 2073 7065 6369 6669 6564 2062 6561 6d20   specified beam 
-0001b720: 7479 7065 2e0a 0a20 2020 2020 2020 2041  type...        A
-0001b730: 7267 733a 0a20 2020 2020 2020 2020 2020  rgs:.           
-0001b740: 2062 6561 6d5f 7479 7065 2028 4265 616d   beam_type (Beam
-0001b750: 5479 7065 2e45 4c45 4354 524f 4e20 6f72  Type.ELECTRON or
-0001b760: 2042 6561 6d54 7970 652e 494f 4e29 3a20   BeamType.ION): 
-0001b770: 5468 6520 7479 7065 206f 6620 6265 616d  The type of beam
-0001b780: 2075 7365 6420 746f 2061 6371 7569 7265   used to acquire
-0001b790: 2074 6865 2069 6d61 6765 2e0a 0a20 2020   the image...   
-0001b7a0: 2020 2020 2052 6574 7572 6e73 3a0a 2020       Returns:.  
-0001b7b0: 2020 2020 2020 2020 2020 4669 6273 656d            Fibsem
-0001b7c0: 496d 6167 653a 2054 6865 206c 6173 7420  Image: The last 
-0001b7d0: 6163 7175 6972 6564 2069 6d61 6765 206f  acquired image o
-0001b7e0: 6620 7468 6520 7370 6563 6966 6965 6420  f the specified 
-0001b7f0: 6265 616d 2074 7970 652e 0a0a 2020 2020  beam type...    
-0001b800: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-0001b810: 6966 2062 6561 6d5f 7479 7065 203d 3d20  if beam_type == 
-0001b820: 4265 616d 5479 7065 2e45 4c45 4354 524f  BeamType.ELECTRO
-0001b830: 4e3a 0a20 2020 2020 2020 2020 2020 205f  N:.            _
-0001b840: 6368 6563 6b5f 6265 616d 2842 6561 6d54  check_beam(BeamT
-0001b850: 7970 652e 454c 4543 5452 4f4e 2c20 7365  ype.ELECTRON, se
-0001b860: 6c66 2e68 6172 6477 6172 655f 7365 7474  lf.hardware_sett
-0001b870: 696e 6773 290a 2020 2020 2020 2020 2020  ings).          
-0001b880: 2020 696d 6167 6520 3d20 7365 6c66 2e6c    image = self.l
-0001b890: 6173 745f 696d 6167 655f 6562 0a20 2020  ast_image_eb.   
-0001b8a0: 2020 2020 2065 6c69 6620 6265 616d 5f74       elif beam_t
-0001b8b0: 7970 6520 3d3d 2042 6561 6d54 7970 652e  ype == BeamType.
-0001b8c0: 494f 4e3a 0a20 2020 2020 2020 2020 2020  ION:.           
-0001b8d0: 205f 6368 6563 6b5f 6265 616d 2842 6561   _check_beam(Bea
-0001b8e0: 6d54 7970 652e 494f 4e2c 2073 656c 662e  mType.ION, self.
-0001b8f0: 6861 7264 7761 7265 5f73 6574 7469 6e67  hardware_setting
-0001b900: 7329 0a20 2020 2020 2020 2020 2020 2069  s).            i
-0001b910: 6d61 6765 203d 2073 656c 662e 6c61 7374  mage = self.last
-0001b920: 5f69 6d61 6765 5f69 620a 2020 2020 2020  _image_ib.      
-0001b930: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-0001b940: 2020 2020 7261 6973 6520 4578 6365 7074      raise Except
-0001b950: 696f 6e28 2242 6561 6d20 7479 7065 2065  ion("Beam type e
-0001b960: 7272 6f72 2229 0a20 2020 2020 2020 2072  rror").        r
-0001b970: 6574 7572 6e20 696d 6167 650a 0a20 2020  eturn image..   
-0001b980: 2064 6566 205f 6765 745f 7072 6573 6574   def _get_preset
-0001b990: 7328 7365 6c66 293a 0a20 2020 2020 2020  s(self):.       
-0001b9a0: 2070 7265 7365 7473 203d 2073 656c 662e   presets = self.
-0001b9b0: 636f 6e6e 6563 7469 6f6e 2e46 4942 2e50  connection.FIB.P
-0001b9c0: 7265 7365 742e 456e 756d 2829 090a 2020  reset.Enum()..  
-0001b9d0: 2020 2020 2020 7265 7475 726e 2070 7265        return pre
-0001b9e0: 7365 7473 0a0a 2020 2020 6465 6620 6175  sets..    def au
-0001b9f0: 746f 636f 6e74 7261 7374 2873 656c 662c  tocontrast(self,
-0001ba00: 2062 6561 6d5f 7479 7065 3a20 4265 616d   beam_type: Beam
-0001ba10: 5479 7065 2920 2d3e 204e 6f6e 653a 0a20  Type) -> None:. 
-0001ba20: 2020 2020 2020 2022 2222 4175 746f 6d61         """Automa
-0001ba30: 7469 6361 6c6c 7920 6164 6a75 7374 2074  tically adjust t
-0001ba40: 6865 206d 6963 726f 7363 6f70 6520 696d  he microscope im
-0001ba50: 6167 6520 636f 6e74 7261 7374 2066 6f72  age contrast for
-0001ba60: 2074 6865 2073 7065 6369 6669 6564 2062   the specified b
-0001ba70: 6561 6d20 7479 7065 2e0a 0a20 2020 2020  eam type...     
-0001ba80: 2020 2041 7267 733a 0a20 2020 2020 2020     Args:.       
-0001ba90: 2020 2020 2062 6561 6d5f 7479 7065 2028       beam_type (
-0001baa0: 4265 616d 5479 7065 2c20 6f70 7469 6f6e  BeamType, option
-0001bab0: 616c 293a 2054 6865 2069 6d61 6769 6e67  al): The imaging
-0001bac0: 2062 6561 6d20 7479 7065 2066 6f72 2077   beam type for w
-0001bad0: 6869 6368 2074 6f20 6164 6a75 7374 2074  hich to adjust t
-0001bae0: 6865 2063 6f6e 7472 6173 742e 0a20 2020  he contrast..   
-0001baf0: 2020 2020 2020 2020 2020 2020 2044 6566               Def
-0001bb00: 6175 6c74 7320 746f 2042 6561 6d54 7970  aults to BeamTyp
-0001bb10: 652e 454c 4543 5452 4f4e 2e0a 0a20 2020  e.ELECTRON...   
-0001bb20: 2020 2020 2052 6574 7572 6e73 3a0a 2020       Returns:.  
-0001bb30: 2020 2020 2020 2020 2020 4e6f 6e65 0a0a            None..
-0001bb40: 2020 2020 2020 2020 4578 616d 706c 653a          Example:
-0001bb50: 0a20 2020 2020 2020 2020 2020 2054 6f20  .            To 
-0001bb60: 6175 746f 6d61 7469 6361 6c6c 7920 6164  automatically ad
-0001bb70: 6a75 7374 2074 6865 2069 6d61 6765 2063  just the image c
-0001bb80: 6f6e 7472 6173 7420 666f 7220 616e 2069  ontrast for an i
-0001bb90: 6f6e 2062 6561 6d20 7479 7065 3a0a 0a20  on beam type:.. 
-0001bba0: 2020 2020 2020 2020 2020 203e 3e3e 206d             >>> m
-0001bbb0: 6963 726f 7363 6f70 6520 3d20 5465 7363  icroscope = Tesc
-0001bbc0: 616e 4d69 6372 6f73 636f 7065 2829 0a20  anMicroscope(). 
-0001bbd0: 2020 2020 2020 2020 2020 203e 3e3e 206d             >>> m
-0001bbe0: 6963 726f 7363 6f70 652e 636f 6e6e 6563  icroscope.connec
-0001bbf0: 745f 746f 5f6d 6963 726f 7363 6f70 6528  t_to_microscope(
-0001bc00: 290a 2020 2020 2020 2020 2320 2020 2020  ).        #     
-0001bc10: 3e3e 3e20 6d69 6372 6f73 636f 7065 2e61  >>> microscope.a
-0001bc20: 7574 6f63 6f6e 7472 6173 7428 6265 616d  utocontrast(beam
-0001bc30: 5f74 7970 653d 4265 616d 5479 7065 2e49  _type=BeamType.I
-0001bc40: 4f4e 290a 0a0a 2020 2020 2020 2020 2320  ON)...        # 
-0001bc50: 2222 220a 2020 2020 2020 2020 5f63 6865  """.        _che
-0001bc60: 636b 5f62 6561 6d28 6265 616d 5f74 7970  ck_beam(beam_typ
-0001bc70: 652c 2073 656c 662e 6861 7264 7761 7265  e, self.hardware
-0001bc80: 5f73 6574 7469 6e67 7329 0a20 2020 2020  _settings).     
-0001bc90: 2020 206c 6f67 6769 6e67 2e69 6e66 6f28     logging.info(
-0001bca0: 6622 5275 6e6e 696e 6720 6175 746f 636f  f"Running autoco
-0001bcb0: 6e74 7261 7374 206f 6e20 7b62 6561 6d5f  ntrast on {beam_
-0001bcc0: 7479 7065 2e6e 616d 657d 2e22 290a 2020  type.name}.").  
-0001bcd0: 2020 2020 2020 6966 2062 6561 6d5f 7479        if beam_ty
-0001bce0: 7065 203d 3d20 4265 616d 5479 7065 2e45  pe == BeamType.E
-0001bcf0: 4c45 4354 524f 4e3a 0a20 2020 2020 2020  LECTRON:.       
-0001bd00: 2020 2020 2073 656c 662e 636f 6e6e 6563       self.connec
-0001bd10: 7469 6f6e 2e53 454d 2e44 6574 6563 746f  tion.SEM.Detecto
-0001bd20: 722e 4175 746f 5369 676e 616c 2844 6574  r.AutoSignal(Det
-0001bd30: 6563 746f 723d 7365 6c66 2e65 6c65 6374  ector=self.elect
-0001bd40: 726f 6e5f 6465 7465 6374 6f72 5f61 6374  ron_detector_act
-0001bd50: 6976 6529 0a20 2020 2020 2020 2069 6620  ive).        if 
-0001bd60: 6265 616d 5f74 7970 6520 3d3d 2042 6561  beam_type == Bea
-0001bd70: 6d54 7970 652e 494f 4e3a 0a20 2020 2020  mType.ION:.     
-0001bd80: 2020 2020 2020 2073 656c 662e 636f 6e6e         self.conn
-0001bd90: 6563 7469 6f6e 2e46 4942 2e44 6574 6563  ection.FIB.Detec
-0001bda0: 746f 722e 4175 746f 5369 676e 616c 2844  tor.AutoSignal(D
-0001bdb0: 6574 6563 746f 723d 7365 6c66 2e69 6f6e  etector=self.ion
-0001bdc0: 5f64 6574 6563 746f 725f 6163 7469 7665  _detector_active
-0001bdd0: 290a 0a20 2020 200a 2020 2020 6465 6620  )..    .    def 
-0001bde0: 6175 746f 5f66 6f63 7573 2873 656c 662c  auto_focus(self,
-0001bdf0: 2062 6561 6d5f 7479 7065 3a20 4265 616d   beam_type: Beam
-0001be00: 5479 7065 2920 2d3e 204e 6f6e 653a 0a20  Type) -> None:. 
-0001be10: 2020 2020 2020 205f 6368 6563 6b5f 6265         _check_be
-0001be20: 616d 2862 6561 6d5f 7479 7065 2c20 7365  am(beam_type, se
-0001be30: 6c66 2e68 6172 6477 6172 655f 7365 7474  lf.hardware_sett
-0001be40: 696e 6773 290a 2020 2020 2020 2020 6966  ings).        if
-0001be50: 2062 6561 6d5f 7479 7065 203d 3d20 4265   beam_type == Be
-0001be60: 616d 5479 7065 2e45 4c45 4354 524f 4e3a  amType.ELECTRON:
-0001be70: 0a20 2020 2020 2020 2020 2020 206c 6f67  .            log
-0001be80: 6769 6e67 2e69 6e66 6f28 2252 756e 6e69  ging.info("Runni
-0001be90: 6e67 2061 7574 6f66 6f63 7573 206f 6e20  ng autofocus on 
-0001bea0: 656c 6563 7472 6f6e 2062 6561 6d2e 2229  electron beam.")
-0001beb0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-0001bec0: 662e 636f 6e6e 6563 7469 6f6e 2e53 454d  f.connection.SEM
-0001bed0: 2e41 7574 6f57 4446 696e 6528 7365 6c66  .AutoWDFine(self
-0001bee0: 2e65 6c65 6374 726f 6e5f 6465 7465 6374  .electron_detect
-0001bef0: 6f72 5f61 6374 6976 6529 0a20 2020 2020  or_active).     
-0001bf00: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0001bf10: 2020 2020 206c 6f67 6769 6e67 2e69 6e66       logging.inf
-0001bf20: 6f28 2241 7574 6f20 666f 6375 7320 6973  o("Auto focus is
-0001bf30: 206e 6f74 2073 7570 706f 7274 6564 2066   not supported f
-0001bf40: 6f72 2069 6f6e 2062 6561 6d20 7479 7065  or ion beam type
-0001bf50: 2e22 290a 2020 2020 2020 2020 7265 7475  .").        retu
-0001bf60: 726e 200a 0a20 2020 2064 6566 2072 6573  rn ..    def res
-0001bf70: 6574 5f62 6561 6d5f 7368 6966 7473 2873  et_beam_shifts(s
-0001bf80: 656c 6629 3a0a 2020 2020 2020 2020 2222  elf):.        ""
-0001bf90: 220a 2020 2020 2020 2020 5365 7420 7468  ".        Set th
-0001bfa0: 6520 6265 616d 2073 6869 6674 2074 6f20  e beam shift to 
-0001bfb0: 7a65 726f 2066 6f72 2074 6865 2065 6c65  zero for the ele
-0001bfc0: 6374 726f 6e20 616e 6420 696f 6e20 6265  ctron and ion be
-0001bfd0: 616d 732e 0a0a 2020 2020 2020 2020 5265  ams...        Re
-0001bfe0: 7365 7473 2074 6865 2062 6561 6d20 7368  sets the beam sh
-0001bff0: 6966 7420 666f 7220 626f 7468 2074 6865  ift for both the
-0001c000: 2065 6c65 6374 726f 6e20 616e 6420 696f   electron and io
-0001c010: 6e20 6265 616d 7320 746f 2028 302c 3029  n beams to (0,0)
-0001c020: 2c20 6566 6665 6374 6976 656c 7920 6365  , effectively ce
-0001c030: 6e74 6572 696e 6720 7468 6520 6265 616d  ntering the beam
-0001c040: 7320 6f6e 2074 6865 2073 616d 706c 652e  s on the sample.
-0001c050: 0a0a 2020 2020 2020 2020 4172 6773 3a0a  ..        Args:.
-0001c060: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-0001c070: 2028 4669 6273 656d 4d69 6372 6f73 636f   (FibsemMicrosco
-0001c080: 7065 293a 2069 6e73 7461 6e63 6520 6f66  pe): instance of
-0001c090: 2074 6865 2046 6962 7365 6d4d 6963 726f   the FibsemMicro
-0001c0a0: 7363 6f70 6520 6f62 6a65 6374 0a20 2020  scope object.   
-0001c0b0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-0001c0c0: 205f 6368 6563 6b5f 6265 616d 2842 6561   _check_beam(Bea
-0001c0d0: 6d54 7970 652e 454c 4543 5452 4f4e 2c20  mType.ELECTRON, 
-0001c0e0: 7365 6c66 2e68 6172 6477 6172 655f 7365  self.hardware_se
-0001c0f0: 7474 696e 6773 290a 2020 2020 2020 2020  ttings).        
-0001c100: 6c6f 6767 696e 672e 6465 6275 6728 0a20  logging.debug(. 
-0001c110: 2020 2020 2020 2020 2020 2066 2272 6573             f"res
-0001c120: 6574 696e 6720 6562 6561 6d20 7368 6966  eting ebeam shif
-0001c130: 7420 746f 2028 302c 2030 2920 6672 6f6d  t to (0, 0) from
-0001c140: 3a20 7b73 656c 662e 636f 6e6e 6563 7469  : {self.connecti
-0001c150: 6f6e 2e46 4942 2e4f 7074 6963 732e 4765  on.FIB.Optics.Ge
-0001c160: 7449 6d61 6765 5368 6966 7428 297d 2028  tImageShift()} (
-0001c170: 6d6d 2922 0a20 2020 2020 2020 2029 0a20  mm)".        ). 
-0001c180: 2020 2020 2020 2073 656c 662e 636f 6e6e         self.conn
-0001c190: 6563 7469 6f6e 2e46 4942 2e4f 7074 6963  ection.FIB.Optic
-0001c1a0: 732e 5365 7449 6d61 6765 5368 6966 7428  s.SetImageShift(
-0001c1b0: 302c 2030 290a 2020 2020 2020 2020 5f63  0, 0).        _c
-0001c1c0: 6865 636b 5f62 6561 6d28 4265 616d 5479  heck_beam(BeamTy
-0001c1d0: 7065 2e49 4f4e 2c20 7365 6c66 2e68 6172  pe.ION, self.har
-0001c1e0: 6477 6172 655f 7365 7474 696e 6773 290a  dware_settings).
-0001c1f0: 2020 2020 2020 2020 6c6f 6767 696e 672e          logging.
-0001c200: 6465 6275 6728 0a20 2020 2020 2020 2020  debug(.         
-0001c210: 2020 2066 2272 6573 6574 696e 6720 6562     f"reseting eb
-0001c220: 6561 6d20 7368 6966 7420 746f 2028 302c  eam shift to (0,
-0001c230: 2030 2920 6672 6f6d 3a20 7b73 656c 662e   0) from: {self.
-0001c240: 636f 6e6e 6563 7469 6f6e 2e53 454d 2e4f  connection.SEM.O
-0001c250: 7074 6963 732e 4765 7449 6d61 6765 5368  ptics.GetImageSh
-0001c260: 6966 7428 297d 2028 6d6d 2922 0a20 2020  ift()} (mm)".   
-0001c270: 2020 2020 2029 0a20 2020 2020 2020 2073       ).        s
-0001c280: 656c 662e 636f 6e6e 6563 7469 6f6e 2e53  elf.connection.S
-0001c290: 454d 2e4f 7074 6963 732e 5365 7449 6d61  EM.Optics.SetIma
-0001c2a0: 6765 5368 6966 7428 302c 2030 290a 0a0a  geShift(0, 0)...
-0001c2b0: 2020 2020 6465 6620 6265 616d 5f73 6869      def beam_shi
-0001c2c0: 6674 2873 656c 662c 2064 783a 2066 6c6f  ft(self, dx: flo
-0001c2d0: 6174 2c20 6479 3a20 666c 6f61 742c 2062  at, dy: float, b
-0001c2e0: 6561 6d5f 7479 7065 3a20 4265 616d 5479  eam_type: BeamTy
-0001c2f0: 7065 203d 2042 6561 6d54 7970 652e 494f  pe = BeamType.IO
-0001c300: 4e29 3a0a 2020 2020 2020 2020 2222 2241  N):.        """A
-0001c310: 646a 7573 7473 2074 6865 2062 6561 6d20  djusts the beam 
-0001c320: 7368 6966 7420 6261 7365 6420 6f6e 2072  shift based on r
-0001c330: 656c 6174 6976 6520 7661 6c75 6573 2074  elative values t
-0001c340: 6861 7420 6172 6520 7072 6f76 6964 6564  hat are provided
-0001c350: 2e0a 2020 2020 2020 2020 0a20 2020 2020  ..        .     
-0001c360: 2020 2041 7267 733a 0a20 2020 2020 2020     Args:.       
-0001c370: 2020 2020 2073 656c 6620 2846 6962 7365       self (Fibse
-0001c380: 6d4d 6963 726f 7363 6f70 6529 3a20 4669  mMicroscope): Fi
-0001c390: 6273 656d 206d 6963 726f 7363 6f70 6520  bsem microscope 
-0001c3a0: 6f62 6a65 6374 0a20 2020 2020 2020 2020  object.         
-0001c3b0: 2020 2064 7820 2866 6c6f 6174 293a 2074     dx (float): t
-0001c3c0: 6865 2072 656c 6174 6976 6520 7820 7465  he relative x te
-0001c3d0: 726d 0a20 2020 2020 2020 2020 2020 2064  rm.            d
-0001c3e0: 7920 2866 6c6f 6174 293a 2074 6865 2072  y (float): the r
-0001c3f0: 656c 6174 6976 6520 7920 7465 726d 0a20  elative y term. 
-0001c400: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-0001c410: 2020 205f 6368 6563 6b5f 6265 616d 2862     _check_beam(b
-0001c420: 6561 6d5f 7479 7065 2c20 7365 6c66 2e68  eam_type, self.h
-0001c430: 6172 6477 6172 655f 7365 7474 696e 6773  ardware_settings
-0001c440: 290a 2020 2020 2020 2020 6966 2062 6561  ).        if bea
-0001c450: 6d5f 7479 7065 203d 3d20 4265 616d 5479  m_type == BeamTy
-0001c460: 7065 2e49 4f4e 3a0a 2020 2020 2020 2020  pe.ION:.        
-0001c470: 2020 2020 6265 616d 203d 2073 656c 662e      beam = self.
-0001c480: 636f 6e6e 6563 7469 6f6e 2e46 4942 2e4f  connection.FIB.O
-0001c490: 7074 6963 730a 2020 2020 2020 2020 656c  ptics.        el
-0001c4a0: 6966 2062 6561 6d5f 7479 7065 203d 3d20  if beam_type == 
-0001c4b0: 4265 616d 5479 7065 2e45 4c45 4354 524f  BeamType.ELECTRO
-0001c4c0: 4e3a 0a20 2020 2020 2020 2020 2020 2062  N:.            b
-0001c4d0: 6561 6d20 3d20 7365 6c66 2e63 6f6e 6e65  eam = self.conne
-0001c4e0: 6374 696f 6e2e 5345 4d2e 4f70 7469 6373  ction.SEM.Optics
-0001c4f0: 0a20 2020 2020 2020 206c 6f67 6769 6e67  .        logging
-0001c500: 2e69 6e66 6f28 6622 7b62 6561 6d5f 7479  .info(f"{beam_ty
-0001c510: 7065 2e6e 616d 657d 2073 6869 6674 696e  pe.name} shiftin
-0001c520: 6720 6279 2028 7b64 787d 2c20 7b64 797d  g by ({dx}, {dy}
-0001c530: 2922 290a 2020 2020 2020 2020 6c6f 6767  )").        logg
-0001c540: 696e 672e 6465 6275 6728 6622 7b62 6561  ing.debug(f"{bea
-0001c550: 6d5f 7479 7065 2e6e 616d 657d 207c 207b  m_type.name} | {
-0001c560: 6478 7d7c 7b64 797d 2229 200a 2020 2020  dx}|{dy}") .    
-0001c570: 2020 2020 782c 2079 203d 2062 6561 6d2e      x, y = beam.
-0001c580: 4765 7449 6d61 6765 5368 6966 7428 290a  GetImageShift().
-0001c590: 2020 2020 2020 2020 6478 202a 3d20 2063          dx *=  c
-0001c5a0: 6f6e 7374 616e 7473 2e4d 4554 5245 5f54  onstants.METRE_T
-0001c5b0: 4f5f 4d49 4c4c 494d 4554 5245 2023 2043  O_MILLIMETRE # C
-0001c5c0: 6f6e 7665 7274 2074 6f20 6d6d 2066 726f  onvert to mm fro
-0001c5d0: 6d20 6d2e 0a20 2020 2020 2020 2064 7920  m m..        dy 
-0001c5e0: 2a3d 2020 636f 6e73 7461 6e74 732e 4d45  *=  constants.ME
-0001c5f0: 5452 455f 544f 5f4d 494c 4c49 4d45 5452  TRE_TO_MILLIMETR
-0001c600: 450a 2020 2020 2020 2020 7820 2b3d 2064  E.        x += d
-0001c610: 7820 0a20 2020 2020 2020 2079 202b 3d20  x .        y += 
-0001c620: 6479 0a20 2020 2020 2020 2062 6561 6d2e  dy.        beam.
-0001c630: 5365 7449 6d61 6765 5368 6966 7428 782c  SetImageShift(x,
-0001c640: 7929 200a 2020 2020 2020 2020 0a20 2020  y) .        .   
-0001c650: 2064 6566 2067 6574 5f73 7461 6765 5f70   def get_stage_p
-0001c660: 6f73 6974 696f 6e28 7365 6c66 293a 0a20  osition(self):. 
-0001c670: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-0001c680: 2020 2047 6574 2074 6865 2063 7572 7265     Get the curre
-0001c690: 6e74 2073 7461 6765 2070 6f73 6974 696f  nt stage positio
-0001c6a0: 6e2e 0a0a 2020 2020 2020 2020 5468 6973  n...        This
-0001c6b0: 206d 6574 686f 6420 7265 7472 6965 7665   method retrieve
-0001c6c0: 7320 7468 6520 6375 7272 656e 7420 7374  s the current st
-0001c6d0: 6167 6520 706f 7369 7469 6f6e 2066 726f  age position fro
-0001c6e0: 6d20 7468 6520 6d69 6372 6f73 636f 7065  m the microscope
-0001c6f0: 2061 6e64 2072 6574 7572 6e73 2069 7420   and returns it 
-0001c700: 6173 0a20 2020 2020 2020 2061 2046 6962  as.        a Fib
-0001c710: 7365 6d53 7461 6765 506f 7369 7469 6f6e  semStagePosition
-0001c720: 206f 626a 6563 742e 0a0a 2020 2020 2020   object...      
-0001c730: 2020 5265 7475 726e 733a 0a20 2020 2020    Returns:.     
-0001c740: 2020 2020 2020 2046 6962 7365 6d53 7461         FibsemSta
-0001c750: 6765 506f 7369 7469 6f6e 3a20 5468 6520  gePosition: The 
-0001c760: 6375 7272 656e 7420 7374 6167 6520 706f  current stage po
-0001c770: 7369 7469 6f6e 2e0a 2020 2020 2020 2020  sition..        
-0001c780: 2222 220a 2020 2020 2020 2020 6966 2073  """.        if s
-0001c790: 656c 662e 6861 7264 7761 7265 5f73 6574  elf.hardware_set
-0001c7a0: 7469 6e67 732e 7374 6167 655f 656e 6162  tings.stage_enab
-0001c7b0: 6c65 6420 6973 2046 616c 7365 3a0a 2020  led is False:.  
-0001c7c0: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-0001c7d0: 4e6f 7449 6d70 6c65 6d65 6e74 6564 4572  NotImplementedEr
-0001c7e0: 726f 7228 2253 7461 6765 2069 7320 6e6f  ror("Stage is no
-0001c7f0: 7420 656e 6162 6c65 642e 2229 0a20 2020  t enabled.").   
-0001c800: 2020 2020 2078 2c20 792c 207a 2c20 722c       x, y, z, r,
-0001c810: 2074 203d 2073 656c 662e 636f 6e6e 6563   t = self.connec
-0001c820: 7469 6f6e 2e53 7461 6765 2e47 6574 506f  tion.Stage.GetPo
-0001c830: 7369 7469 6f6e 2829 0a20 2020 2020 2020  sition().       
-0001c840: 2073 7461 6765 5f70 6f73 6974 696f 6e20   stage_position 
-0001c850: 3d20 4669 6273 656d 5374 6167 6550 6f73  = FibsemStagePos
-0001c860: 6974 696f 6e28 0a20 2020 2020 2020 2020  ition(.         
-0001c870: 2020 2078 203d 2078 202a 2063 6f6e 7374     x = x * const
-0001c880: 616e 7473 2e4d 494c 4c49 4d45 5452 455f  ants.MILLIMETRE_
-0001c890: 544f 5f4d 4554 5245 2c0a 2020 2020 2020  TO_METRE,.      
-0001c8a0: 2020 2020 2020 7920 3d20 7920 2a20 636f        y = y * co
-0001c8b0: 6e73 7461 6e74 732e 4d49 4c4c 494d 4554  nstants.MILLIMET
-0001c8c0: 5245 5f54 4f5f 4d45 5452 452c 0a20 2020  RE_TO_METRE,.   
-0001c8d0: 2020 2020 2020 2020 207a 203d 207a 202a           z = z *
-0001c8e0: 2063 6f6e 7374 616e 7473 2e4d 494c 4c49   constants.MILLI
-0001c8f0: 4d45 5452 455f 544f 5f4d 4554 5245 2c0a  METRE_TO_METRE,.
-0001c900: 2020 2020 2020 2020 2020 2020 7220 3d20              r = 
-0001c910: 7220 2a20 636f 6e73 7461 6e74 732e 4445  r * constants.DE
-0001c920: 4752 4545 535f 544f 5f52 4144 4941 4e53  GREES_TO_RADIANS
-0001c930: 2c0a 2020 2020 2020 2020 2020 2020 7420  ,.            t 
-0001c940: 3d20 7420 2a20 636f 6e73 7461 6e74 732e  = t * constants.
-0001c950: 4445 4752 4545 535f 544f 5f52 4144 4941  DEGREES_TO_RADIA
-0001c960: 4e53 2c0a 2020 2020 2020 2020 2020 2020  NS,.            
-0001c970: 636f 6f72 6469 6e61 7465 5f73 7973 7465  coordinate_syste
-0001c980: 6d3d 2022 5241 5722 2c0a 2020 2020 2020  m= "RAW",.      
-0001c990: 2020 290a 2020 2020 2020 2020 7265 7475    ).        retu
-0001c9a0: 726e 2073 7461 6765 5f70 6f73 6974 696f  rn stage_positio
-0001c9b0: 6e0a 0a20 2020 2064 6566 2067 6574 5f63  n..    def get_c
-0001c9c0: 7572 7265 6e74 5f6d 6963 726f 7363 6f70  urrent_microscop
-0001c9d0: 655f 7374 6174 6528 7365 6c66 2920 2d3e  e_state(self) ->
-0001c9e0: 204d 6963 726f 7363 6f70 6553 7461 7465   MicroscopeState
-0001c9f0: 3a0a 2020 2020 2020 2020 2222 220a 2020  :.        """.  
-0001ca00: 2020 2020 2020 4765 7420 7468 6520 6375        Get the cu
-0001ca10: 7272 656e 7420 6d69 6372 6f73 636f 7065  rrent microscope
-0001ca20: 2073 7461 7465 0a0a 2020 2020 2020 2020   state..        
-0001ca30: 5468 6973 206d 6574 686f 6420 7265 7472  This method retr
-0001ca40: 6965 7665 7320 7468 6520 6375 7272 656e  ieves the curren
-0001ca50: 7420 6d69 6372 6f73 636f 7065 2073 7461  t microscope sta
-0001ca60: 7465 2066 726f 6d20 7468 6520 6d69 6372  te from the micr
-0001ca70: 6f73 636f 7065 2061 6e64 2072 6574 7572  oscope and retur
-0001ca80: 6e73 2069 7420 6173 0a20 2020 2020 2020  ns it as.       
-0001ca90: 2061 204d 6963 726f 7363 6f70 6553 7461   a MicroscopeSta
-0001caa0: 7465 206f 626a 6563 742e 0a0a 2020 2020  te object...    
-0001cab0: 2020 2020 5265 7475 726e 733a 0a20 2020      Returns:.   
-0001cac0: 2020 2020 2020 2020 204d 6963 726f 7363           Microsc
-0001cad0: 6f70 6553 7461 7465 3a20 6375 7272 656e  opeState: curren
-0001cae0: 7420 6d69 6372 6f73 636f 7065 2073 7461  t microscope sta
-0001caf0: 7465 0a20 2020 2020 2020 2022 2222 0a0a  te.        """..
-0001cb00: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-0001cb10: 6861 7264 7761 7265 5f73 6574 7469 6e67  hardware_setting
-0001cb20: 732e 656c 6563 7472 6f6e 5f62 6561 6d20  s.electron_beam 
-0001cb30: 6973 2054 7275 653a 0a20 2020 2020 2020  is True:.       
-0001cb40: 2020 2020 2069 6d61 6765 5f65 6220 3d20       image_eb = 
-0001cb50: 7365 6c66 2e6c 6173 745f 696d 6167 6528  self.last_image(
-0001cb60: 4265 616d 5479 7065 2e45 4c45 4354 524f  BeamType.ELECTRO
-0001cb70: 4e29 0a20 2020 2020 2020 2020 2020 2069  N).            i
-0001cb80: 6620 696d 6167 655f 6562 2069 7320 6e6f  f image_eb is no
-0001cb90: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
-0001cba0: 2020 2020 2020 2020 6562 5f73 6574 7469          eb_setti
-0001cbb0: 6e67 7320 3d20 4265 616d 5365 7474 696e  ngs = BeamSettin
-0001cbc0: 6773 280a 2020 2020 2020 2020 2020 2020  gs(.            
-0001cbd0: 2020 2020 6265 616d 5f74 7970 653d 4265      beam_type=Be
-0001cbe0: 616d 5479 7065 2e45 4c45 4354 524f 4e2c  amType.ELECTRON,
-0001cbf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001cc00: 2077 6f72 6b69 6e67 5f64 6973 7461 6e63   working_distanc
-0001cc10: 653d 7365 6c66 2e63 6f6e 6e65 6374 696f  e=self.connectio
-0001cc20: 6e2e 5345 4d2e 4f70 7469 6373 2e47 6574  n.SEM.Optics.Get
-0001cc30: 5744 2829 202a 2063 6f6e 7374 616e 7473  WD() * constants
-0001cc40: 2e4d 494c 4c49 4d45 5452 455f 544f 5f4d  .MILLIMETRE_TO_M
-0001cc50: 4554 5245 2c0a 2020 2020 2020 2020 2020  ETRE,.          
-0001cc60: 2020 2020 2020 6265 616d 5f63 7572 7265        beam_curre
-0001cc70: 6e74 3d73 656c 662e 636f 6e6e 6563 7469  nt=self.connecti
-0001cc80: 6f6e 2e53 454d 2e42 6561 6d2e 4765 7443  on.SEM.Beam.GetC
-0001cc90: 7572 7265 6e74 2829 202a 2063 6f6e 7374  urrent() * const
-0001cca0: 616e 7473 2e50 4943 4f5f 544f 5f53 492c  ants.PICO_TO_SI,
-0001ccb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001ccc0: 2068 6677 3d73 656c 662e 636f 6e6e 6563   hfw=self.connec
-0001ccd0: 7469 6f6e 2e53 454d 2e4f 7074 6963 732e  tion.SEM.Optics.
-0001cce0: 4765 7456 6965 7766 6965 6c64 2829 202a  GetViewfield() *
-0001ccf0: 2063 6f6e 7374 616e 7473 2e4d 494c 4c49   constants.MILLI
-0001cd00: 4d45 5452 455f 544f 5f4d 4554 5245 2c0a  METRE_TO_METRE,.
-0001cd10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cd20: 7265 736f 6c75 7469 6f6e 3d69 6d61 6765  resolution=image
-0001cd30: 5f65 622e 6d65 7461 6461 7461 2e69 6d61  _eb.metadata.ima
-0001cd40: 6765 5f73 6574 7469 6e67 732e 7265 736f  ge_settings.reso
-0001cd50: 6c75 7469 6f6e 2c20 2023 2054 4f44 4f20  lution,  # TODO 
-0001cd60: 6669 7820 7468 6573 6520 656d 7074 7920  fix these empty 
-0001cd70: 7061 7261 6d65 7465 7273 0a20 2020 2020  parameters.     
-0001cd80: 2020 2020 2020 2020 2020 2064 7765 6c6c             dwell
-0001cd90: 5f74 696d 653d 696d 6167 655f 6562 2e6d  _time=image_eb.m
-0001cda0: 6574 6164 6174 612e 696d 6167 655f 7365  etadata.image_se
-0001cdb0: 7474 696e 6773 2e64 7765 6c6c 5f74 696d  ttings.dwell_tim
-0001cdc0: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
-0001cdd0: 2020 2073 7469 676d 6174 696f 6e3d 696d     stigmation=im
-0001cde0: 6167 655f 6562 2e6d 6574 6164 6174 612e  age_eb.metadata.
-0001cdf0: 6d69 6372 6f73 636f 7065 5f73 7461 7465  microscope_state
-0001ce00: 2e65 625f 7365 7474 696e 6773 2e73 7469  .eb_settings.sti
-0001ce10: 676d 6174 696f 6e2c 0a20 2020 2020 2020  gmation,.       
-0001ce20: 2020 2020 2020 2020 2073 6869 6674 3d69           shift=i
-0001ce30: 6d61 6765 5f65 622e 6d65 7461 6461 7461  mage_eb.metadata
-0001ce40: 2e6d 6963 726f 7363 6f70 655f 7374 6174  .microscope_stat
-0001ce50: 652e 6562 5f73 6574 7469 6e67 732e 7368  e.eb_settings.sh
-0001ce60: 6966 742c 0a20 2020 2020 2020 2020 2020  ift,.           
-0001ce70: 2020 2020 2073 6361 6e5f 726f 7461 7469       scan_rotati
-0001ce80: 6f6e 3d73 656c 662e 636f 6e6e 6563 7469  on=self.connecti
-0001ce90: 6f6e 2e53 454d 2e4f 7074 6963 732e 4765  on.SEM.Optics.Ge
-0001cea0: 7449 6d61 6765 526f 7461 7469 6f6e 2829  tImageRotation()
-0001ceb0: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
-0001cec0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-0001ced0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001cee0: 2065 625f 7365 7474 696e 6773 203d 2042   eb_settings = B
-0001cef0: 6561 6d53 6574 7469 6e67 7328 4265 616d  eamSettings(Beam
-0001cf00: 5479 7065 2e45 4c45 4354 524f 4e29 0a20  Type.ELECTRON). 
-0001cf10: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-0001cf20: 2020 2020 2020 2020 2065 625f 7365 7474           eb_sett
-0001cf30: 696e 6773 203d 2042 6561 6d53 6574 7469  ings = BeamSetti
-0001cf40: 6e67 7328 4265 616d 5479 7065 2e45 4c45  ngs(BeamType.ELE
-0001cf50: 4354 524f 4e29 0a20 2020 2020 2020 200a  CTRON).        .
-0001cf60: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-0001cf70: 6861 7264 7761 7265 5f73 6574 7469 6e67  hardware_setting
-0001cf80: 732e 696f 6e5f 6265 616d 2069 7320 5472  s.ion_beam is Tr
-0001cf90: 7565 3a0a 2020 2020 2020 2020 2020 2020  ue:.            
-0001cfa0: 696d 6167 655f 6962 203d 2073 656c 662e  image_ib = self.
-0001cfb0: 6c61 7374 5f69 6d61 6765 2842 6561 6d54  last_image(BeamT
-0001cfc0: 7970 652e 494f 4e29 0a20 2020 2020 2020  ype.ION).       
-0001cfd0: 2020 2020 2069 6620 696d 6167 655f 6962       if image_ib
-0001cfe0: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
-0001cff0: 2020 2020 2020 2020 2020 2020 2020 6962                ib
-0001d000: 5f73 6574 7469 6e67 7320 3d20 4265 616d  _settings = Beam
-0001d010: 5365 7474 696e 6773 280a 2020 2020 2020  Settings(.      
-0001d020: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d030: 2020 6265 616d 5f74 7970 653d 4265 616d    beam_type=Beam
-0001d040: 5479 7065 2e49 4f4e 2c0a 2020 2020 2020  Type.ION,.      
-0001d050: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d060: 2020 776f 726b 696e 675f 6469 7374 616e    working_distan
-0001d070: 6365 3d69 6d61 6765 5f69 622e 6d65 7461  ce=image_ib.meta
-0001d080: 6461 7461 2e6d 6963 726f 7363 6f70 655f  data.microscope_
-0001d090: 7374 6174 652e 6962 5f73 6574 7469 6e67  state.ib_setting
-0001d0a0: 732e 776f 726b 696e 675f 6469 7374 616e  s.working_distan
-0001d0b0: 6365 2c0a 2020 2020 2020 2020 2020 2020  ce,.            
-0001d0c0: 2020 2020 2020 2020 2020 2020 6265 616d              beam
-0001d0d0: 5f63 7572 7265 6e74 3d73 656c 662e 636f  _current=self.co
-0001d0e0: 6e6e 6563 7469 6f6e 2e46 4942 2e42 6561  nnection.FIB.Bea
-0001d0f0: 6d2e 5265 6164 5072 6f62 6543 7572 7265  m.ReadProbeCurre
-0001d100: 6e74 2829 202a 2063 6f6e 7374 616e 7473  nt() * constants
-0001d110: 2e50 4943 4f5f 544f 5f53 492c 0a20 2020  .PICO_TO_SI,.   
-0001d120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d130: 2020 2020 2068 6677 3d73 656c 662e 636f       hfw=self.co
-0001d140: 6e6e 6563 7469 6f6e 2e46 4942 2e4f 7074  nnection.FIB.Opt
-0001d150: 6963 732e 4765 7456 6965 7766 6965 6c64  ics.GetViewfield
-0001d160: 2829 202a 2063 6f6e 7374 616e 7473 2e4d  () * constants.M
-0001d170: 494c 4c49 4d45 5452 455f 544f 5f4d 4554  ILLIMETRE_TO_MET
-0001d180: 5245 2c0a 2020 2020 2020 2020 2020 2020  RE,.            
-0001d190: 2020 2020 2020 2020 2020 2020 7265 736f              reso
-0001d1a0: 6c75 7469 6f6e 3d69 6d61 6765 5f69 622e  lution=image_ib.
-0001d1b0: 6d65 7461 6461 7461 2e69 6d61 6765 5f73  metadata.image_s
-0001d1c0: 6574 7469 6e67 732e 7265 736f 6c75 7469  ettings.resoluti
-0001d1d0: 6f6e 2c0a 2020 2020 2020 2020 2020 2020  on,.            
-0001d1e0: 2020 2020 2020 2020 2020 2020 6477 656c              dwel
-0001d1f0: 6c5f 7469 6d65 3d69 6d61 6765 5f69 622e  l_time=image_ib.
-0001d200: 6d65 7461 6461 7461 2e69 6d61 6765 5f73  metadata.image_s
-0001d210: 6574 7469 6e67 732e 6477 656c 6c5f 7469  ettings.dwell_ti
-0001d220: 6d65 2c0a 2020 2020 2020 2020 2020 2020  me,.            
-0001d230: 2020 2020 2020 2020 2020 2020 7374 6967              stig
-0001d240: 6d61 7469 6f6e 3d69 6d61 6765 5f69 622e  mation=image_ib.
-0001d250: 6d65 7461 6461 7461 2e6d 6963 726f 7363  metadata.microsc
-0001d260: 6f70 655f 7374 6174 652e 6962 5f73 6574  ope_state.ib_set
-0001d270: 7469 6e67 732e 7374 6967 6d61 7469 6f6e  tings.stigmation
-0001d280: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0001d290: 2020 2020 2020 2020 2020 7368 6966 743d            shift=
-0001d2a0: 696d 6167 655f 6962 2e6d 6574 6164 6174  image_ib.metadat
-0001d2b0: 612e 6d69 6372 6f73 636f 7065 5f73 7461  a.microscope_sta
-0001d2c0: 7465 2e69 625f 7365 7474 696e 6773 2e73  te.ib_settings.s
-0001d2d0: 6869 6674 2c0a 2020 2020 2020 2020 2020  hift,.          
-0001d2e0: 2020 2020 2020 2020 2020 2020 2020 7363                sc
-0001d2f0: 616e 5f72 6f74 6174 696f 6e3d 7365 6c66  an_rotation=self
-0001d300: 2e63 6f6e 6e65 6374 696f 6e2e 4649 422e  .connection.FIB.
-0001d310: 4f70 7469 6373 2e47 6574 496d 6167 6552  Optics.GetImageR
-0001d320: 6f74 6174 696f 6e28 290a 2020 2020 2020  otation().      
-0001d330: 2020 2020 2020 2020 2020 2020 2020 290a                ).
-0001d340: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d350: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
-0001d360: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-0001d370: 2020 2069 625f 7365 7474 696e 6773 203d     ib_settings =
-0001d380: 2042 6561 6d53 6574 7469 6e67 7328 4265   BeamSettings(Be
-0001d390: 616d 5479 7065 2e49 4f4e 290a 2020 2020  amType.ION).    
-0001d3a0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-0001d3b0: 2020 2020 2020 6962 5f73 6574 7469 6e67        ib_setting
-0001d3c0: 7320 3d20 4265 616d 5365 7474 696e 6773  s = BeamSettings
-0001d3d0: 2842 6561 6d54 7970 652e 494f 4e29 0a20  (BeamType.ION). 
-0001d3e0: 2020 2020 2020 2063 7572 7265 6e74 5f6d         current_m
-0001d3f0: 6963 726f 7363 6f70 655f 7374 6174 6520  icroscope_state 
-0001d400: 3d20 4d69 6372 6f73 636f 7065 5374 6174  = MicroscopeStat
-0001d410: 6528 0a20 2020 2020 2020 2020 2020 2074  e(.            t
-0001d420: 696d 6573 7461 6d70 3d64 6174 6574 696d  imestamp=datetim
-0001d430: 652e 6461 7465 7469 6d65 2e74 696d 6573  e.datetime.times
-0001d440: 7461 6d70 2864 6174 6574 696d 652e 6461  tamp(datetime.da
-0001d450: 7465 7469 6d65 2e6e 6f77 2829 292c 0a20  tetime.now()),. 
-0001d460: 2020 2020 2020 2020 2020 2023 2067 6574             # get
-0001d470: 2061 6273 6f6c 7574 6520 7374 6167 6520   absolute stage 
-0001d480: 636f 6f72 6469 6e61 7465 7320 2852 4157  coordinates (RAW
-0001d490: 290a 2020 2020 2020 2020 2020 2020 6162  ).            ab
-0001d4a0: 736f 6c75 7465 5f70 6f73 6974 696f 6e3d  solute_position=
-0001d4b0: 7365 6c66 2e67 6574 5f73 7461 6765 5f70  self.get_stage_p
-0001d4c0: 6f73 6974 696f 6e28 292c 0a20 2020 2020  osition(),.     
-0001d4d0: 2020 2020 2020 2023 2065 6c65 6374 726f         # electro
-0001d4e0: 6e20 6265 616d 2073 6574 7469 6e67 730a  n beam settings.
-0001d4f0: 2020 2020 2020 2020 2020 2020 6562 5f73              eb_s
-0001d500: 6574 7469 6e67 733d 6562 5f73 6574 7469  ettings=eb_setti
-0001d510: 6e67 732c 0a20 2020 2020 2020 2020 2020  ngs,.           
-0001d520: 2023 2069 6f6e 2062 6561 6d20 7365 7474   # ion beam sett
-0001d530: 696e 6773 0a20 2020 2020 2020 2020 2020  ings.           
-0001d540: 2069 625f 7365 7474 696e 6773 3d69 625f   ib_settings=ib_
-0001d550: 7365 7474 696e 6773 2c0a 2020 2020 2020  settings,.      
-0001d560: 2020 290a 0a20 2020 2020 2020 2072 6574    )..        ret
-0001d570: 7572 6e20 6375 7272 656e 745f 6d69 6372  urn current_micr
-0001d580: 6f73 636f 7065 5f73 7461 7465 0a0a 2020  oscope_state..  
-0001d590: 2020 6465 6620 6d6f 7665 5f73 7461 6765    def move_stage
-0001d5a0: 5f61 6273 6f6c 7574 6528 7365 6c66 2c20  _absolute(self, 
-0001d5b0: 706f 7369 7469 6f6e 3a20 4669 6273 656d  position: Fibsem
-0001d5c0: 5374 6167 6550 6f73 6974 696f 6e29 3a0a  StagePosition):.
-0001d5d0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-0001d5e0: 2020 2020 4d6f 7665 2074 6865 2073 7461      Move the sta
-0001d5f0: 6765 2074 6f20 7468 6520 7370 6563 6966  ge to the specif
-0001d600: 6965 6420 636f 6f72 6469 6e61 7465 732e  ied coordinates.
-0001d610: 0a0a 2020 2020 2020 2020 4172 6773 3a0a  ..        Args:.
-0001d620: 2020 2020 2020 2020 2020 2020 7820 2866              x (f
-0001d630: 6c6f 6174 293a 2054 6865 2078 2d63 6f6f  loat): The x-coo
-0001d640: 7264 696e 6174 6520 746f 206d 6f76 6520  rdinate to move 
-0001d650: 746f 2028 696e 206d 6574 6572 7329 2e0a  to (in meters)..
-0001d660: 2020 2020 2020 2020 2020 2020 7920 2866              y (f
-0001d670: 6c6f 6174 293a 2054 6865 2079 2d63 6f6f  loat): The y-coo
-0001d680: 7264 696e 6174 6520 746f 206d 6f76 6520  rdinate to move 
-0001d690: 746f 2028 696e 206d 6574 6572 7329 2e0a  to (in meters)..
-0001d6a0: 2020 2020 2020 2020 2020 2020 7a20 2866              z (f
-0001d6b0: 6c6f 6174 293a 2054 6865 207a 2d63 6f6f  loat): The z-coo
-0001d6c0: 7264 696e 6174 6520 746f 206d 6f76 6520  rdinate to move 
-0001d6d0: 746f 2028 696e 206d 6574 6572 7329 2e0a  to (in meters)..
-0001d6e0: 2020 2020 2020 2020 2020 2020 7220 2866              r (f
-0001d6f0: 6c6f 6174 293a 2054 6865 2072 6f74 6174  loat): The rotat
-0001d700: 696f 6e20 746f 2061 7070 6c79 2028 696e  ion to apply (in
-0001d710: 2072 6164 6961 6e73 292e 0a20 2020 2020   radians)..     
-0001d720: 2020 2020 2020 2074 7820 2866 6c6f 6174         tx (float
-0001d730: 293a 2054 6865 2078 2d61 7869 7320 7469  ): The x-axis ti
-0001d740: 6c74 2074 6f20 6170 706c 7920 2869 6e20  lt to apply (in 
-0001d750: 7261 6469 616e 7329 2e0a 0a20 2020 2020  radians)...     
-0001d760: 2020 2052 6574 7572 6e73 3a0a 2020 2020     Returns:.    
-0001d770: 2020 2020 2020 2020 4e6f 6e65 0a20 2020          None.   
-0001d780: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-0001d790: 2069 6620 706f 7369 7469 6f6e 2e72 2069   if position.r i
-0001d7a0: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
-0001d7b0: 2020 2020 2020 2020 726f 7461 7469 6f6e          rotation
-0001d7c0: 203d 2054 7275 650a 2020 2020 2020 2020   = True.        
-0001d7d0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-0001d7e0: 2020 726f 7461 7469 6f6e 203d 2046 616c    rotation = Fal
-0001d7f0: 7365 0a20 2020 2020 2020 2069 6620 706f  se.        if po
-0001d800: 7369 7469 6f6e 2e74 2069 7320 6e6f 7420  sition.t is not 
-0001d810: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-0001d820: 2020 7469 6c74 203d 2054 7275 650a 2020    tilt = True.  
-0001d830: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-0001d840: 2020 2020 2020 2020 7469 6c74 203d 2046          tilt = F
-0001d850: 616c 7365 0a20 2020 2020 2020 205f 6368  alse.        _ch
-0001d860: 6563 6b5f 7374 6167 6528 7365 6c66 2e68  eck_stage(self.h
-0001d870: 6172 6477 6172 655f 7365 7474 696e 6773  ardware_settings
-0001d880: 2c20 726f 7461 7469 6f6e 3d72 6f74 6174  , rotation=rotat
-0001d890: 696f 6e2c 2074 696c 743d 7469 6c74 290a  ion, tilt=tilt).
-0001d8a0: 2020 2020 2020 2020 6c6f 6767 696e 672e          logging.
-0001d8b0: 696e 666f 2866 224d 6f76 696e 6720 7374  info(f"Moving st
-0001d8c0: 6167 6520 746f 207b 706f 7369 7469 6f6e  age to {position
-0001d8d0: 7d2e 2229 0a20 2020 2020 2020 2073 656c  }.").        sel
-0001d8e0: 662e 636f 6e6e 6563 7469 6f6e 2e53 7461  f.connection.Sta
-0001d8f0: 6765 2e4d 6f76 6554 6f28 0a20 2020 2020  ge.MoveTo(.     
-0001d900: 2020 2020 2020 2070 6f73 6974 696f 6e2e         position.
-0001d910: 7820 2a20 636f 6e73 7461 6e74 732e 4d45  x * constants.ME
-0001d920: 5452 455f 544f 5f4d 494c 4c49 4d45 5452  TRE_TO_MILLIMETR
-0001d930: 4520 6966 2070 6f73 6974 696f 6e2e 7820  E if position.x 
-0001d940: 6973 206e 6f74 204e 6f6e 6520 656c 7365  is not None else
-0001d950: 204e 6f6e 652c 0a20 2020 2020 2020 2020   None,.         
-0001d960: 2020 2070 6f73 6974 696f 6e2e 7920 2a20     position.y * 
-0001d970: 636f 6e73 7461 6e74 732e 4d45 5452 455f  constants.METRE_
-0001d980: 544f 5f4d 494c 4c49 4d45 5452 4520 6966  TO_MILLIMETRE if
-0001d990: 2070 6f73 6974 696f 6e2e 7920 6973 206e   position.y is n
-0001d9a0: 6f74 204e 6f6e 6520 656c 7365 204e 6f6e  ot None else Non
-0001d9b0: 652c 0a20 2020 2020 2020 2020 2020 2070  e,.            p
-0001d9c0: 6f73 6974 696f 6e2e 7a20 2a20 636f 6e73  osition.z * cons
-0001d9d0: 7461 6e74 732e 4d45 5452 455f 544f 5f4d  tants.METRE_TO_M
-0001d9e0: 494c 4c49 4d45 5452 4520 6966 2070 6f73  ILLIMETRE if pos
-0001d9f0: 6974 696f 6e2e 7a20 6973 206e 6f74 204e  ition.z is not N
-0001da00: 6f6e 6520 656c 7365 204e 6f6e 652c 0a20  one else None,. 
-0001da10: 2020 2020 2020 2020 2020 2070 6f73 6974             posit
-0001da20: 696f 6e2e 7220 2a20 636f 6e73 7461 6e74  ion.r * constant
-0001da30: 732e 5241 4449 414e 535f 544f 5f44 4547  s.RADIANS_TO_DEG
-0001da40: 5245 4553 2069 6620 706f 7369 7469 6f6e  REES if position
-0001da50: 2e72 2069 7320 6e6f 7420 4e6f 6e65 2065  .r is not None e
-0001da60: 6c73 6520 4e6f 6e65 2c0a 2020 2020 2020  lse None,.      
-0001da70: 2020 2020 2020 706f 7369 7469 6f6e 2e74        position.t
-0001da80: 202a 2063 6f6e 7374 616e 7473 2e52 4144   * constants.RAD
-0001da90: 4941 4e53 5f54 4f5f 4445 4752 4545 5320  IANS_TO_DEGREES 
-0001daa0: 6966 2070 6f73 6974 696f 6e2e 7420 6973  if position.t is
-0001dab0: 206e 6f74 204e 6f6e 6520 656c 7365 204e   not None else N
-0001dac0: 6f6e 652c 0a20 2020 2020 2020 2029 0a0a  one,.        )..
-0001dad0: 2020 2020 6465 6620 6d6f 7665 5f73 7461      def move_sta
-0001dae0: 6765 5f72 656c 6174 6976 6528 0a20 2020  ge_relative(.   
-0001daf0: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
-0001db00: 2020 2070 6f73 6974 696f 6e3a 2046 6962     position: Fib
-0001db10: 7365 6d53 7461 6765 506f 7369 7469 6f6e  semStagePosition
-0001db20: 2c0a 2020 2020 293a 0a20 2020 2020 2020  ,.    ):.       
-0001db30: 2022 2222 0a20 2020 2020 2020 204d 6f76   """.        Mov
-0001db40: 6520 7468 6520 7374 6167 6520 6279 2074  e the stage by t
-0001db50: 6865 2073 7065 6369 6669 6564 2072 656c  he specified rel
-0001db60: 6174 6976 6520 6d6f 7665 2e0a 0a20 2020  ative move...   
-0001db70: 2020 2020 2041 7267 733a 0a20 2020 2020       Args:.     
-0001db80: 2020 2020 2020 2078 2028 666c 6f61 7429         x (float)
-0001db90: 3a20 5468 6520 782d 636f 6f72 6469 6e61  : The x-coordina
-0001dba0: 7465 2074 6f20 6d6f 7665 2074 6f20 2869  te to move to (i
-0001dbb0: 6e20 6d65 7465 7273 292e 0a20 2020 2020  n meters)..     
-0001dbc0: 2020 2020 2020 2079 2028 666c 6f61 7429         y (float)
-0001dbd0: 3a20 5468 6520 792d 636f 6f72 6469 6e61  : The y-coordina
-0001dbe0: 7465 2074 6f20 6d6f 7665 2074 6f20 2869  te to move to (i
-0001dbf0: 6e20 6d65 7465 7273 292e 0a20 2020 2020  n meters)..     
-0001dc00: 2020 2020 2020 207a 2028 666c 6f61 7429         z (float)
-0001dc10: 3a20 5468 6520 7a2d 636f 6f72 6469 6e61  : The z-coordina
-0001dc20: 7465 2074 6f20 6d6f 7665 2074 6f20 2869  te to move to (i
-0001dc30: 6e20 6d65 7465 7273 292e 0a20 2020 2020  n meters)..     
-0001dc40: 2020 2020 2020 2072 2028 666c 6f61 7429         r (float)
-0001dc50: 3a20 5468 6520 726f 7461 7469 6f6e 2074  : The rotation t
-0001dc60: 6f20 6170 706c 7920 2869 6e20 6465 6772  o apply (in degr
-0001dc70: 6565 7329 2e0a 2020 2020 2020 2020 2020  ees)..          
-0001dc80: 2020 7478 2028 666c 6f61 7429 3a20 5468    tx (float): Th
-0001dc90: 6520 782d 6178 6973 2074 696c 7420 746f  e x-axis tilt to
-0001dca0: 2061 7070 6c79 2028 696e 2064 6567 7265   apply (in degre
-0001dcb0: 6573 292e 0a0a 2020 2020 2020 2020 5265  es)...        Re
-0001dcc0: 7475 726e 733a 0a20 2020 2020 2020 2020  turns:.         
-0001dcd0: 2020 204e 6f6e 650a 2020 2020 2020 2020     None.        
-0001dce0: 2222 220a 2020 2020 2020 2020 6966 2070  """.        if p
-0001dcf0: 6f73 6974 696f 6e2e 7220 6973 206e 6f74  osition.r is not
-0001dd00: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-0001dd10: 2020 2072 6f74 6174 696f 6e20 3d20 5472     rotation = Tr
-0001dd20: 7565 0a20 2020 2020 2020 2065 6c73 653a  ue.        else:
-0001dd30: 0a20 2020 2020 2020 2020 2020 2072 6f74  .            rot
-0001dd40: 6174 696f 6e20 3d20 4661 6c73 650a 2020  ation = False.  
-0001dd50: 2020 2020 2020 6966 2070 6f73 6974 696f        if positio
-0001dd60: 6e2e 7420 6973 206e 6f74 204e 6f6e 653a  n.t is not None:
-0001dd70: 0a20 2020 2020 2020 2020 2020 2074 696c  .            til
-0001dd80: 7420 3d20 5472 7565 0a20 2020 2020 2020  t = True.       
-0001dd90: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-0001dda0: 2020 2074 696c 7420 3d20 4661 6c73 650a     tilt = False.
-0001ddb0: 2020 2020 2020 2020 5f63 6865 636b 5f73          _check_s
-0001ddc0: 7461 6765 2873 656c 662e 6861 7264 7761  tage(self.hardwa
-0001ddd0: 7265 5f73 6574 7469 6e67 732c 2072 6f74  re_settings, rot
-0001dde0: 6174 696f 6e3d 726f 7461 7469 6f6e 2c20  ation=rotation, 
-0001ddf0: 7469 6c74 3d74 696c 7429 0a20 2020 2020  tilt=tilt).     
-0001de00: 2020 206c 6f67 6769 6e67 2e69 6e66 6f28     logging.info(
-0001de10: 6622 4d6f 7669 6e67 2073 7461 6765 2062  f"Moving stage b
-0001de20: 7920 7b70 6f73 6974 696f 6e7d 2e22 290a  y {position}.").
-0001de30: 2020 2020 2020 2020 2320 6375 7272 656e          # curren
-0001de40: 745f 706f 7369 7469 6f6e 203d 2073 656c  t_position = sel
-0001de50: 662e 6765 745f 7374 6167 655f 706f 7369  f.get_stage_posi
-0001de60: 7469 6f6e 2829 0a20 2020 2020 2020 2023  tion().        #
-0001de70: 2078 322c 7932 2c7a 3220 3d20 7365 6c66   x2,y2,z2 = self
-0001de80: 2e63 6f6e 6e65 6374 696f 6e2e 5374 6167  .connection.Stag
-0001de90: 652e 4b56 462e 436f 6d70 7574 6528 0a20  e.KVF.Compute(. 
-0001dea0: 2020 2020 2020 2023 2020 2020 2077 643d         #     wd=
-0001deb0: 2073 656c 662e 6765 7428 2277 6f72 6b69   self.get("worki
-0001dec0: 6e67 5f64 6973 7461 6e63 6522 2c20 6265  ng_distance", be
-0001ded0: 616d 5f74 7970 653d 4265 616d 5479 7065  am_type=BeamType
-0001dee0: 2e45 4c45 4354 524f 4e29 2c0a 2020 2020  .ELECTRON),.    
-0001def0: 2020 2020 2320 2020 2020 7831 3d20 6375      #     x1= cu
-0001df00: 7272 656e 745f 706f 7369 7469 6f6e 2e78  rrent_position.x
-0001df10: 202a 2063 6f6e 7374 616e 7473 2e4d 4554   * constants.MET
-0001df20: 5245 5f54 4f5f 4d49 4c4c 494d 4554 5245  RE_TO_MILLIMETRE
-0001df30: 2c0a 2020 2020 2020 2020 2320 2020 2020  ,.        #     
-0001df40: 7931 3d20 6375 7272 656e 745f 706f 7369  y1= current_posi
-0001df50: 7469 6f6e 2e79 202a 2063 6f6e 7374 616e  tion.y * constan
-0001df60: 7473 2e4d 4554 5245 5f54 4f5f 4d49 4c4c  ts.METRE_TO_MILL
-0001df70: 494d 4554 5245 2c0a 2020 2020 2020 2020  IMETRE,.        
-0001df80: 2320 2020 2020 7a31 3d20 6375 7272 656e  #     z1= curren
-0001df90: 745f 706f 7369 7469 6f6e 2e7a 202a 2063  t_position.z * c
-0001dfa0: 6f6e 7374 616e 7473 2e4d 4554 5245 5f54  onstants.METRE_T
-0001dfb0: 4f5f 4d49 4c4c 494d 4554 5245 2c0a 2020  O_MILLIMETRE,.  
-0001dfc0: 2020 2020 2020 2320 2020 2020 7231 3d20        #     r1= 
-0001dfd0: 6375 7272 656e 745f 706f 7369 7469 6f6e  current_position
-0001dfe0: 2e72 202a 2063 6f6e 7374 616e 7473 2e52  .r * constants.R
-0001dff0: 4144 4941 4e53 5f54 4f5f 4445 4752 4545  ADIANS_TO_DEGREE
-0001e000: 532c 0a20 2020 2020 2020 2023 2020 2020  S,.        #    
-0001e010: 2074 7831 3d20 6375 7272 656e 745f 706f   tx1= current_po
-0001e020: 7369 7469 6f6e 2e74 202a 2063 6f6e 7374  sition.t * const
-0001e030: 616e 7473 2e52 4144 4941 4e53 5f54 4f5f  ants.RADIANS_TO_
-0001e040: 4445 4752 4545 532c 0a20 2020 2020 2020  DEGREES,.       
-0001e050: 2023 2020 2020 2074 7931 203d 2030 2c0a   #     ty1 = 0,.
-0001e060: 2020 2020 2020 2020 2320 2020 2020 7232          #     r2
-0001e070: 203d 2070 6f73 6974 696f 6e2e 7220 2a20   = position.r * 
-0001e080: 636f 6e73 7461 6e74 732e 5241 4449 414e  constants.RADIAN
-0001e090: 535f 544f 5f44 4547 5245 4553 202b 2063  S_TO_DEGREES + c
-0001e0a0: 7572 7265 6e74 5f70 6f73 6974 696f 6e2e  urrent_position.
-0001e0b0: 7220 2a20 636f 6e73 7461 6e74 732e 5241  r * constants.RA
-0001e0c0: 4449 414e 535f 544f 5f44 4547 5245 4553  DIANS_TO_DEGREES
-0001e0d0: 2c0a 2020 2020 2020 2020 2320 2020 2020  ,.        #     
-0001e0e0: 7478 3220 3d20 706f 7369 7469 6f6e 2e74  tx2 = position.t
-0001e0f0: 202a 2063 6f6e 7374 616e 7473 2e52 4144   * constants.RAD
-0001e100: 4941 4e53 5f54 4f5f 4445 4752 4545 5320  IANS_TO_DEGREES 
-0001e110: 2b20 6375 7272 656e 745f 706f 7369 7469  + current_positi
-0001e120: 6f6e 2e74 202a 2063 6f6e 7374 616e 7473  on.t * constants
-0001e130: 2e52 4144 4941 4e53 5f54 4f5f 4445 4752  .RADIANS_TO_DEGR
-0001e140: 4545 532c 0a20 2020 2020 2020 2023 2020  EES,.        #  
-0001e150: 2020 2074 7932 203d 2030 2c0a 2020 2020     ty2 = 0,.    
-0001e160: 2020 2020 2320 290a 2020 2020 2020 2020      # ).        
-0001e170: 2320 7365 6c66 2e6d 6f76 655f 7374 6167  # self.move_stag
-0001e180: 655f 6162 736f 6c75 7465 2846 6962 7365  e_absolute(Fibse
-0001e190: 6d53 7461 6765 506f 7369 7469 6f6e 2878  mStagePosition(x
-0001e1a0: 322c 7932 2c7a 3229 290a 2020 2020 2020  2,y2,z2)).      
-0001e1b0: 2020 6375 7272 656e 745f 706f 7369 7469    current_positi
-0001e1c0: 6f6e 203d 2073 656c 662e 6765 745f 7374  on = self.get_st
-0001e1d0: 6167 655f 706f 7369 7469 6f6e 2829 0a20  age_position(). 
-0001e1e0: 2020 2020 2020 2078 5f6d 203d 2063 7572         x_m = cur
-0001e1f0: 7265 6e74 5f70 6f73 6974 696f 6e2e 780a  rent_position.x.
-0001e200: 2020 2020 2020 2020 795f 6d20 3d20 6375          y_m = cu
-0001e210: 7272 656e 745f 706f 7369 7469 6f6e 2e79  rrent_position.y
-0001e220: 0a20 2020 2020 2020 207a 5f6d 203d 2063  .        z_m = c
-0001e230: 7572 7265 6e74 5f70 6f73 6974 696f 6e2e  urrent_position.
-0001e240: 7a0a 2020 2020 2020 2020 6e65 775f 706f  z.        new_po
-0001e250: 7369 7469 6f6e 203d 2046 6962 7365 6d53  sition = FibsemS
-0001e260: 7461 6765 506f 7369 7469 6f6e 280a 2020  tagePosition(.  
-0001e270: 2020 2020 2020 2020 2020 7820 3d20 2878            x = (x
-0001e280: 5f6d 202b 2070 6f73 6974 696f 6e2e 7829  _m + position.x)
-0001e290: 2069 6620 706f 7369 7469 6f6e 2e78 2069   if position.x i
-0001e2a0: 7320 6e6f 7420 4e6f 6e65 2065 6c73 6520  s not None else 
-0001e2b0: 785f 6d2c 0a20 2020 2020 2020 2020 2020  x_m,.           
-0001e2c0: 2079 203d 2028 795f 6d20 2b20 706f 7369   y = (y_m + posi
-0001e2d0: 7469 6f6e 2e79 2029 6966 2070 6f73 6974  tion.y )if posit
-0001e2e0: 696f 6e2e 7920 6973 206e 6f74 204e 6f6e  ion.y is not Non
-0001e2f0: 6520 656c 7365 2079 5f6d 2c0a 2020 2020  e else y_m,.    
-0001e300: 2020 2020 2020 2020 7a20 3d20 287a 5f6d          z = (z_m
-0001e310: 202b 2070 6f73 6974 696f 6e2e 7a20 2969   + position.z )i
-0001e320: 6620 706f 7369 7469 6f6e 2e7a 2069 7320  f position.z is 
-0001e330: 6e6f 7420 4e6f 6e65 2065 6c73 6520 7a5f  not None else z_
-0001e340: 6d2c 0a20 2020 2020 2020 2020 2020 2072  m,.            r
-0001e350: 203d 2028 6375 7272 656e 745f 706f 7369   = (current_posi
-0001e360: 7469 6f6e 2e72 202b 2070 6f73 6974 696f  tion.r + positio
-0001e370: 6e2e 7229 2069 6620 706f 7369 7469 6f6e  n.r) if position
-0001e380: 2e72 2069 7320 6e6f 7420 4e6f 6e65 2065  .r is not None e
-0001e390: 6c73 6520 6375 7272 656e 745f 706f 7369  lse current_posi
-0001e3a0: 7469 6f6e 2e72 2c0a 2020 2020 2020 2020  tion.r,.        
-0001e3b0: 2020 2020 7420 3d20 2863 7572 7265 6e74      t = (current
-0001e3c0: 5f70 6f73 6974 696f 6e2e 7420 2b20 706f  _position.t + po
-0001e3d0: 7369 7469 6f6e 2e74 2920 6966 2070 6f73  sition.t) if pos
-0001e3e0: 6974 696f 6e2e 7420 6973 206e 6f74 204e  ition.t is not N
-0001e3f0: 6f6e 6520 656c 7365 2063 7572 7265 6e74  one else current
-0001e400: 5f70 6f73 6974 696f 6e2e 742c 0a20 2020  _position.t,.   
-0001e410: 2020 2020 2020 2020 2063 6f6f 7264 696e           coordin
-0001e420: 6174 655f 7379 7374 656d 203d 2020 2252  ate_system =  "R
-0001e430: 4157 222c 0a20 2020 2020 2020 2029 0a20  AW",.        ). 
-0001e440: 2020 2020 2020 2073 656c 662e 6d6f 7665         self.move
-0001e450: 5f73 7461 6765 5f61 6273 6f6c 7574 6528  _stage_absolute(
-0001e460: 6e65 775f 706f 7369 7469 6f6e 290a 0a20  new_position).. 
-0001e470: 2020 2064 6566 2073 7461 626c 655f 6d6f     def stable_mo
-0001e480: 7665 280a 2020 2020 2020 2020 7365 6c66  ve(.        self
-0001e490: 2c0a 2020 2020 2020 2020 7365 7474 696e  ,.        settin
-0001e4a0: 6773 3a20 4d69 6372 6f73 636f 7065 5365  gs: MicroscopeSe
-0001e4b0: 7474 696e 6773 2c0a 2020 2020 2020 2020  ttings,.        
-0001e4c0: 6478 3a20 666c 6f61 742c 0a20 2020 2020  dx: float,.     
-0001e4d0: 2020 2064 793a 2066 6c6f 6174 2c0a 2020     dy: float,.  
-0001e4e0: 2020 2020 2020 6265 616d 5f74 7970 653a        beam_type:
-0001e4f0: 2042 6561 6d54 7970 652c 0a20 2020 2029   BeamType,.    )
-0001e500: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
-0001e510: 2020 2222 220a 2020 2020 2020 2020 4361    """.        Ca
-0001e520: 6c63 756c 6174 6520 7468 6520 636f 7272  lculate the corr
-0001e530: 6563 7465 6420 7374 6167 6520 6d6f 7665  ected stage move
-0001e540: 6d65 6e74 7320 6261 7365 6420 6f6e 2074  ments based on t
-0001e550: 6865 2062 6561 6d5f 7479 7065 2c20 616e  he beam_type, an
-0001e560: 6420 7468 656e 206d 6f76 6520 7468 6520  d then move the 
-0001e570: 7374 6167 6520 7265 6c61 7469 7665 6c79  stage relatively
-0001e580: 2e0a 0a20 2020 2020 2020 2041 7267 733a  ...        Args:
-0001e590: 0a20 2020 2020 2020 2020 2020 2073 6574  .            set
-0001e5a0: 7469 6e67 7320 284d 6963 726f 7363 6f70  tings (Microscop
-0001e5b0: 6553 6574 7469 6e67 7329 3a20 6d69 6372  eSettings): micr
-0001e5c0: 6f73 636f 7065 2073 6574 7469 6e67 730a  oscope settings.
-0001e5d0: 2020 2020 2020 2020 2020 2020 6478 2028              dx (
-0001e5e0: 666c 6f61 7429 3a20 6469 7374 616e 6365  float): distance
-0001e5f0: 2061 6c6f 6e67 2074 6865 2078 2d61 7869   along the x-axi
-0001e600: 7320 2869 6d61 6765 2063 6f6f 7264 696e  s (image coordin
-0001e610: 6174 6573 290a 2020 2020 2020 2020 2020  ates).          
-0001e620: 2020 6479 2028 666c 6f61 7429 3a20 6469    dy (float): di
-0001e630: 7374 616e 6365 2061 6c6f 6e67 2074 6865  stance along the
-0001e640: 2079 2d61 7869 7320 2869 6d61 6765 2063   y-axis (image c
-0001e650: 6f6f 7264 696e 6174 6573 290a 2020 2020  oordinates).    
-0001e660: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-0001e670: 5f63 6865 636b 5f73 7461 6765 2873 656c  _check_stage(sel
-0001e680: 662e 6861 7264 7761 7265 5f73 6574 7469  f.hardware_setti
-0001e690: 6e67 7329 0a20 2020 2020 2020 2077 6420  ngs).        wd 
-0001e6a0: 3d20 7365 6c66 2e63 6f6e 6e65 6374 696f  = self.connectio
-0001e6b0: 6e2e 5345 4d2e 4f70 7469 6373 2e47 6574  n.SEM.Optics.Get
-0001e6c0: 5744 2829 0a0a 2020 2020 2020 2020 6966  WD()..        if
-0001e6d0: 2062 6561 6d5f 7479 7065 203d 3d20 4265   beam_type == Be
-0001e6e0: 616d 5479 7065 2e45 4c45 4354 524f 4e3a  amType.ELECTRON:
-0001e6f0: 0a20 2020 2020 2020 2020 2020 2069 6d61  .            ima
-0001e700: 6765 5f72 6f74 6174 696f 6e20 3d20 7365  ge_rotation = se
-0001e710: 6c66 2e63 6f6e 6e65 6374 696f 6e2e 5345  lf.connection.SE
-0001e720: 4d2e 4f70 7469 6373 2e47 6574 496d 6167  M.Optics.GetImag
-0001e730: 6552 6f74 6174 696f 6e28 290a 2020 2020  eRotation().    
-0001e740: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-0001e750: 2020 2020 2020 696d 6167 655f 726f 7461        image_rota
-0001e760: 7469 6f6e 203d 2073 656c 662e 636f 6e6e  tion = self.conn
-0001e770: 6563 7469 6f6e 2e46 4942 2e4f 7074 6963  ection.FIB.Optic
-0001e780: 732e 4765 7449 6d61 6765 526f 7461 7469  s.GetImageRotati
-0001e790: 6f6e 2829 0a0a 2020 2020 2020 2020 2320  on()..        # 
-0001e7a0: 6966 2069 6d61 6765 5f72 6f74 6174 696f  if image_rotatio
-0001e7b0: 6e20 3d3d 2030 3a0a 2020 2020 2020 2020  n == 0:.        
-0001e7c0: 2320 2020 2020 6478 5f6d 6f76 6520 3d20  #     dx_move = 
-0001e7d0: 2d64 780a 2020 2020 2020 2020 2320 2020  -dx.        #   
-0001e7e0: 2020 6479 5f6d 6f76 6520 3d20 6479 0a20    dy_move = dy. 
-0001e7f0: 2020 2020 2020 2023 2065 6c69 6620 696d         # elif im
-0001e800: 6167 655f 726f 7461 7469 6f6e 203d 3d20  age_rotation == 
-0001e810: 3138 303a 0a20 2020 2020 2020 2023 2020  180:.        #  
-0001e820: 2020 2064 785f 6d6f 7665 203d 2064 780a     dx_move = dx.
-0001e830: 2020 2020 2020 2020 2320 2020 2020 6479          #     dy
-0001e840: 5f6d 6f76 6520 3d20 2d64 790a 2020 2020  _move = -dy.    
-0001e850: 2020 2020 696d 6167 655f 726f 7461 7469      image_rotati
-0001e860: 6f6e 203d 2073 656c 662e 636f 6e6e 6563  on = self.connec
-0001e870: 7469 6f6e 2e53 454d 2e4f 7074 6963 732e  tion.SEM.Optics.
-0001e880: 4765 7449 6d61 6765 526f 7461 7469 6f6e  GetImageRotation
-0001e890: 2829 0a0a 2020 2020 2020 2020 6478 5f6d  ()..        dx_m
-0001e8a0: 6f76 6520 3d20 202d 2864 782a 6e70 2e63  ove =  -(dx*np.c
-0001e8b0: 6f73 2869 6d61 6765 5f72 6f74 6174 696f  os(image_rotatio
-0001e8c0: 6e2a 6e70 2e70 692f 3138 3029 202b 2064  n*np.pi/180) + d
-0001e8d0: 792a 6e70 2e73 696e 2869 6d61 6765 5f72  y*np.sin(image_r
-0001e8e0: 6f74 6174 696f 6e2a 6e70 2e70 692f 3138  otation*np.pi/18
-0001e8f0: 3029 290a 2020 2020 2020 2020 6479 5f6d  0)).        dy_m
-0001e900: 6f76 6520 3d20 2d28 6479 2a6e 702e 636f  ove = -(dy*np.co
-0001e910: 7328 696d 6167 655f 726f 7461 7469 6f6e  s(image_rotation
-0001e920: 2a6e 702e 7069 2f31 3830 2920 2d20 6478  *np.pi/180) - dx
-0001e930: 2a6e 702e 7369 6e28 696d 6167 655f 726f  *np.sin(image_ro
-0001e940: 7461 7469 6f6e 2a6e 702e 7069 2f31 3830  tation*np.pi/180
-0001e950: 2929 0a0a 2020 2020 2020 2020 2320 6361  ))..        # ca
-0001e960: 6c63 756c 6174 6520 7374 6167 6520 6d6f  lculate stage mo
-0001e970: 7665 6d65 6e74 0a20 2020 2020 2020 2078  vement.        x
-0001e980: 5f6d 6f76 6520 3d20 4669 6273 656d 5374  _move = FibsemSt
-0001e990: 6167 6550 6f73 6974 696f 6e28 783d 6478  agePosition(x=dx
-0001e9a0: 5f6d 6f76 652c 2079 3d30 2c20 7a3d 3029  _move, y=0, z=0)
-0001e9b0: 200a 2020 2020 2020 2020 797a 5f6d 6f76   .        yz_mov
-0001e9c0: 6520 3d20 7365 6c66 2e5f 795f 636f 7272  e = self._y_corr
-0001e9d0: 6563 7465 645f 7374 6167 655f 6d6f 7665  ected_stage_move
-0001e9e0: 6d65 6e74 280a 2020 2020 2020 2020 2020  ment(.          
-0001e9f0: 2020 7365 7474 696e 6773 3d73 6574 7469    settings=setti
-0001ea00: 6e67 732c 0a20 2020 2020 2020 2020 2020  ngs,.           
-0001ea10: 2065 7870 6563 7465 645f 793d 6479 5f6d   expected_y=dy_m
-0001ea20: 6f76 652c 0a20 2020 2020 2020 2020 2020  ove,.           
-0001ea30: 2062 6561 6d5f 7479 7065 3d62 6561 6d5f   beam_type=beam_
-0001ea40: 7479 7065 2c0a 2020 2020 2020 2020 290a  type,.        ).
-0001ea50: 0a20 2020 2020 2020 2023 206d 6f76 6520  .        # move 
-0001ea60: 7374 6167 650a 2020 2020 2020 2020 7374  stage.        st
-0001ea70: 6167 655f 706f 7369 7469 6f6e 203d 2046  age_position = F
-0001ea80: 6962 7365 6d53 7461 6765 506f 7369 7469  ibsemStagePositi
-0001ea90: 6f6e 280a 2020 2020 2020 2020 2020 2020  on(.            
-0001eaa0: 783d 785f 6d6f 7665 2e78 2c20 793d 797a  x=x_move.x, y=yz
-0001eab0: 5f6d 6f76 652e 792c 207a 3d79 7a5f 6d6f  _move.y, z=yz_mo
-0001eac0: 7665 2e7a 2c20 723d 302c 2074 3d30 0a20  ve.z, r=0, t=0. 
-0001ead0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-0001eae0: 206c 6f67 6769 6e67 2e69 6e66 6f28 6622   logging.info(f"
-0001eaf0: 6d6f 7669 6e67 2073 7461 6765 2028 7b62  moving stage ({b
-0001eb00: 6561 6d5f 7479 7065 2e6e 616d 657d 293a  eam_type.name}):
-0001eb10: 207b 7374 6167 655f 706f 7369 7469 6f6e   {stage_position
-0001eb20: 7d22 290a 2020 2020 2020 2020 7365 6c66  }").        self
-0001eb30: 2e6d 6f76 655f 7374 6167 655f 7265 6c61  .move_stage_rela
-0001eb40: 7469 7665 2873 7461 6765 5f70 6f73 6974  tive(stage_posit
-0001eb50: 696f 6e29 0a0a 2020 2020 2020 2020 2320  ion)..        # 
-0001eb60: 6164 6a75 7374 2077 6f72 6b69 6e67 2064  adjust working d
-0001eb70: 6973 7461 6e63 6520 746f 2063 6f6d 7065  istance to compe
-0001eb80: 6e73 6174 6520 666f 7220 7374 6167 6520  nsate for stage 
-0001eb90: 6d6f 7665 6d65 6e74 0a20 2020 2020 2020  movement.       
-0001eba0: 2073 656c 662e 636f 6e6e 6563 7469 6f6e   self.connection
-0001ebb0: 2e53 454d 2e4f 7074 6963 732e 5365 7457  .SEM.Optics.SetW
-0001ebc0: 4428 7764 290a 2020 2020 2020 2020 2320  D(wd).        # 
-0001ebd0: 7365 6c66 2e63 6f6e 6e65 6374 696f 6e2e  self.connection.
-0001ebe0: 7370 6563 696d 656e 2e73 7461 6765 2e6c  specimen.stage.l
-0001ebf0: 696e 6b28 2920 2320 544f 444f 2068 6f77  ink() # TODO how
-0001ec00: 2074 6f20 6c69 6e6b 2066 6f72 2054 4553   to link for TES
-0001ec10: 4341 4e3f 0a0a 2020 2020 2020 2020 7265  CAN?..        re
-0001ec20: 7475 726e 0a0a 2020 2020 6465 6620 6575  turn..    def eu
-0001ec30: 6365 6e74 7269 635f 6d6f 7665 280a 2020  centric_move(.  
-0001ec40: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
-0001ec50: 2020 2020 7365 7474 696e 6773 3a20 4d69      settings: Mi
-0001ec60: 6372 6f73 636f 7065 5365 7474 696e 6773  croscopeSettings
-0001ec70: 2c0a 2020 2020 2020 2020 6479 3a20 666c  ,.        dy: fl
-0001ec80: 6f61 742c 0a20 2020 2020 2020 2073 7461  oat,.        sta
-0001ec90: 7469 635f 7764 3a20 626f 6f6c 203d 2054  tic_wd: bool = T
-0001eca0: 7275 652c 0a20 2020 2029 202d 3e20 4e6f  rue,.    ) -> No
-0001ecb0: 6e65 3a0a 2020 2020 2020 2020 2222 220a  ne:.        """.
-0001ecc0: 2020 2020 2020 2020 4d6f 7665 2074 6865          Move the
-0001ecd0: 2073 7461 6765 2076 6572 7469 6361 6c6c   stage verticall
-0001ece0: 7920 746f 2063 6f72 7265 6374 2065 7563  y to correct euc
-0001ecf0: 656e 7472 6963 2070 6f69 6e74 0a0a 2020  entric point..  
-0001ed00: 2020 2020 2020 4172 6773 3a0a 2020 2020        Args:.    
-0001ed10: 2020 2020 2020 2020 7365 7474 696e 6773          settings
-0001ed20: 2028 4d69 6372 6f73 636f 7065 5365 7474   (MicroscopeSett
-0001ed30: 696e 6773 293a 206d 6963 726f 7363 6f70  ings): microscop
-0001ed40: 6520 7365 7474 696e 6773 0a20 2020 2020  e settings.     
-0001ed50: 2020 2020 2020 2064 7920 2866 6c6f 6174         dy (float
-0001ed60: 293a 2064 6973 7461 6e63 6520 696e 2079  ): distance in y
-0001ed70: 2d61 7869 7320 2869 6d61 6765 2063 6f6f  -axis (image coo
-0001ed80: 7264 696e 6174 6573 290a 2020 2020 2020  rdinates).      
-0001ed90: 2020 2222 220a 2020 2020 2020 2020 5f63    """.        _c
-0001eda0: 6865 636b 5f73 7461 6765 2873 656c 662e  heck_stage(self.
-0001edb0: 6861 7264 7761 7265 5f73 6574 7469 6e67  hardware_setting
-0001edc0: 7329 0a20 2020 2020 2020 2077 6420 3d20  s).        wd = 
-0001edd0: 7365 6c66 2e63 6f6e 6e65 6374 696f 6e2e  self.connection.
-0001ede0: 5345 4d2e 4f70 7469 6373 2e47 6574 5744  SEM.Optics.GetWD
-0001edf0: 2829 0a20 2020 2020 2020 2069 6d61 6765  ().        image
-0001ee00: 5f72 6f74 6174 696f 6e20 3d20 7365 6c66  _rotation = self
-0001ee10: 2e63 6f6e 6e65 6374 696f 6e2e 4649 422e  .connection.FIB.
-0001ee20: 4f70 7469 6373 2e47 6574 496d 6167 6552  Optics.GetImageR
-0001ee30: 6f74 6174 696f 6e28 290a 2020 2020 2020  otation().      
-0001ee40: 2020 2020 2020 0a20 2020 2020 2020 2069        .        i
-0001ee50: 6620 6e70 2e69 7363 6c6f 7365 2869 6d61  f np.isclose(ima
-0001ee60: 6765 5f72 6f74 6174 696f 6e2c 2030 2e30  ge_rotation, 0.0
-0001ee70: 293a 0a20 2020 2020 2020 2020 2020 2064  ):.            d
-0001ee80: 795f 6d6f 7665 203d 202d 6479 0a20 2020  y_move = -dy.   
-0001ee90: 2020 2020 2065 6c69 6620 6e70 2e69 7363       elif np.isc
-0001eea0: 6c6f 7365 2869 6d61 6765 5f72 6f74 6174  lose(image_rotat
-0001eeb0: 696f 6e2c 2031 3830 293a 0a20 2020 2020  ion, 180):.     
-0001eec0: 2020 2020 2020 2064 795f 6d6f 7665 203d         dy_move =
-0001eed0: 2064 790a 2020 2020 2020 2020 2020 2020   dy.            
-0001eee0: 0a20 2020 2020 2020 2050 5245 5449 4c54  .        PRETILT
-0001eef0: 5f53 4947 4e20 3d20 312e 300a 2020 2020  _SIGN = 1.0.    
-0001ef00: 2020 2020 6672 6f6d 2066 6962 7365 6d20      from fibsem 
-0001ef10: 696d 706f 7274 206d 6f76 656d 656e 740a  import movement.
-0001ef20: 2020 2020 2020 2020 2320 6375 7272 656e          # curren
-0001ef30: 7420 7374 6167 6520 706f 7369 7469 6f6e  t stage position
-0001ef40: 0a20 2020 2020 2020 2063 7572 7265 6e74  .        current
-0001ef50: 5f73 7461 6765 5f70 6f73 6974 696f 6e20  _stage_position 
-0001ef60: 3d20 7365 6c66 2e67 6574 5f73 7461 6765  = self.get_stage
-0001ef70: 5f70 6f73 6974 696f 6e28 290a 2020 2020  _position().    
-0001ef80: 2020 2020 7374 6167 655f 726f 7461 7469      stage_rotati
-0001ef90: 6f6e 203d 2063 7572 7265 6e74 5f73 7461  on = current_sta
-0001efa0: 6765 5f70 6f73 6974 696f 6e2e 7220 2520  ge_position.r % 
-0001efb0: 2832 202a 206e 702e 7069 290a 2020 2020  (2 * np.pi).    
-0001efc0: 2020 2020 7374 6167 655f 7469 6c74 203d      stage_tilt =
-0001efd0: 2063 7572 7265 6e74 5f73 7461 6765 5f70   current_stage_p
-0001efe0: 6f73 6974 696f 6e2e 740a 2020 2020 2020  osition.t.      
-0001eff0: 2020 7374 6167 655f 7469 6c74 5f66 6c61    stage_tilt_fla
-0001f000: 745f 746f 5f65 6c65 6374 726f 6e20 3d20  t_to_electron = 
-0001f010: 6e70 2e64 6567 3272 6164 280a 2020 2020  np.deg2rad(.    
-0001f020: 2020 2020 2020 2020 7365 7474 696e 6773          settings
-0001f030: 2e73 7973 7465 6d2e 7374 6167 652e 7469  .system.stage.ti
-0001f040: 6c74 5f66 6c61 745f 746f 5f65 6c65 6374  lt_flat_to_elect
-0001f050: 726f 6e0a 2020 2020 2020 2020 290a 2020  ron.        ).  
-0001f060: 2020 2020 2020 7374 6167 655f 7469 6c74        stage_tilt
-0001f070: 5f66 6c61 745f 746f 5f69 6f6e 203d 206e  _flat_to_ion = n
-0001f080: 702e 6465 6732 7261 6428 7365 7474 696e  p.deg2rad(settin
-0001f090: 6773 2e73 7973 7465 6d2e 7374 6167 652e  gs.system.stage.
-0001f0a0: 7469 6c74 5f66 6c61 745f 746f 5f69 6f6e  tilt_flat_to_ion
-0001f0b0: 290a 0a20 2020 2020 2020 2073 7461 6765  )..        stage
-0001f0c0: 5f72 6f74 6174 696f 6e5f 666c 6174 5f74  _rotation_flat_t
-0001f0d0: 6f5f 696f 6e20 3d20 6e70 2e64 6567 3272  o_ion = np.deg2r
-0001f0e0: 6164 280a 2020 2020 2020 2020 2020 2020  ad(.            
-0001f0f0: 7365 7474 696e 6773 2e73 7973 7465 6d2e  settings.system.
-0001f100: 7374 6167 652e 726f 7461 7469 6f6e 5f66  stage.rotation_f
-0001f110: 6c61 745f 746f 5f69 6f6e 0a20 2020 2020  lat_to_ion.     
-0001f120: 2020 2029 2025 2028 3220 2a20 6e70 2e70     ) % (2 * np.p
-0001f130: 6929 0a0a 2020 2020 2020 2020 6966 206d  i)..        if m
-0001f140: 6f76 656d 656e 742e 726f 7461 7469 6f6e  ovement.rotation
-0001f150: 5f61 6e67 6c65 5f69 735f 736d 616c 6c65  _angle_is_smalle
-0001f160: 7228 0a20 2020 2020 2020 2020 2020 2073  r(.            s
-0001f170: 7461 6765 5f72 6f74 6174 696f 6e2c 2073  tage_rotation, s
-0001f180: 7461 6765 5f72 6f74 6174 696f 6e5f 666c  tage_rotation_fl
-0001f190: 6174 5f74 6f5f 696f 6e2c 2061 746f 6c3d  at_to_ion, atol=
-0001f1a0: 350a 2020 2020 2020 2020 293a 0a20 2020  5.        ):.   
-0001f1b0: 2020 2020 2020 2020 2050 5245 5449 4c54           PRETILT
-0001f1c0: 5f53 4947 4e20 3d20 2d31 2e30 0a0a 2020  _SIGN = -1.0..  
-0001f1d0: 2020 2020 2020 2320 544f 444f 3a20 6368        # TODO: ch
-0001f1e0: 6563 6b20 7468 6973 2070 7265 2d74 696c  eck this pre-til
-0001f1f0: 7420 616e 676c 6520 6361 6c63 756c 6174  t angle calculat
-0001f200: 696f 6e0a 2020 2020 2020 2020 636f 7272  ion.        corr
-0001f210: 6563 7465 645f 7072 6574 696c 745f 616e  ected_pretilt_an
-0001f220: 676c 6520 3d20 5052 4554 494c 545f 5349  gle = PRETILT_SI
-0001f230: 474e 202a 2028 7374 6167 655f 7469 6c74  GN * (stage_tilt
-0001f240: 5f66 6c61 745f 746f 5f65 6c65 6374 726f  _flat_to_electro
-0001f250: 6e20 2d20 7365 7474 696e 6773 2e73 7973  n - settings.sys
-0001f260: 7465 6d2e 7374 6167 652e 7072 655f 7469  tem.stage.pre_ti
-0001f270: 6c74 2a63 6f6e 7374 616e 7473 2e44 4547  lt*constants.DEG
-0001f280: 5245 4553 5f54 4f5f 5241 4449 414e 5329  REES_TO_RADIANS)
-0001f290: 0a20 2020 2020 2020 2070 6572 7370 6563  .        perspec
-0001f2a0: 7469 7665 5f74 696c 7420 3d20 282d 2063  tive_tilt = (- c
-0001f2b0: 6f72 7265 6374 6564 5f70 7265 7469 6c74  orrected_pretilt
-0001f2c0: 5f61 6e67 6c65 202d 2073 7461 6765 5f74  _angle - stage_t
-0001f2d0: 696c 745f 666c 6174 5f74 6f5f 696f 6e29  ilt_flat_to_ion)
-0001f2e0: 0a20 2020 2020 2020 207a 5f70 6572 7370  .        z_persp
-0001f2f0: 6563 7469 7665 203d 202d 2064 795f 6d6f  ective = - dy_mo
-0001f300: 7665 2f6e 702e 636f 7328 2873 7461 6765  ve/np.cos((stage
-0001f310: 5f74 696c 7420 2b20 636f 7272 6563 7465  _tilt + correcte
-0001f320: 645f 7072 6574 696c 745f 616e 676c 6520  d_pretilt_angle 
-0001f330: 2b20 7065 7273 7065 6374 6976 655f 7469  + perspective_ti
-0001f340: 6c74 2929 0a20 2020 2020 2020 207a 5f6d  lt)).        z_m
-0001f350: 6f76 6520 3d20 7a5f 7065 7273 7065 6374  ove = z_perspect
-0001f360: 6976 652a 6e70 2e73 696e 2839 302a 636f  ive*np.sin(90*co
-0001f370: 6e73 7461 6e74 732e 4445 4752 4545 535f  nstants.DEGREES_
-0001f380: 544f 5f52 4144 4941 4e53 202d 2073 7461  TO_RADIANS - sta
-0001f390: 6765 5f74 696c 745f 666c 6174 5f74 6f5f  ge_tilt_flat_to_
-0001f3a0: 696f 6e29 200a 2020 2020 2020 2020 2320  ion) .        # 
-0001f3b0: 7a5f 6d6f 7665 203d 2064 7920 2f20 6e70  z_move = dy / np
-0001f3c0: 2e63 6f73 280a 2020 2020 2020 2020 2320  .cos(.        # 
-0001f3d0: 2020 2020 6e70 2e64 6567 3272 6164 2839      np.deg2rad(9
-0001f3e0: 3020 2d20 7365 7474 696e 6773 2e73 7973  0 - settings.sys
-0001f3f0: 7465 6d2e 7374 6167 652e 7469 6c74 5f66  tem.stage.tilt_f
-0001f400: 6c61 745f 746f 5f69 6f6e 202b 2073 6574  lat_to_ion + set
-0001f410: 7469 6e67 732e 7379 7374 656d 2e73 7461  tings.system.sta
-0001f420: 6765 2e70 7265 5f74 696c 7429 0a20 2020  ge.pre_tilt).   
-0001f430: 2020 2020 2023 2029 2020 2320 544f 444f       # )  # TODO
-0001f440: 3a20 4d41 4749 4320 4e55 4d42 4552 2c20  : MAGIC NUMBER, 
-0001f450: 3930 202d 2066 6962 2074 696c 740a 2020  90 - fib tilt.  
-0001f460: 2020 2020 2020 6c6f 6767 696e 672e 696e        logging.in
-0001f470: 666f 2866 2265 7563 656e 7472 6963 206d  fo(f"eucentric m
-0001f480: 6f76 656d 656e 743a 207b 7a5f 6d6f 7665  ovement: {z_move
-0001f490: 7d22 290a 2020 2020 2020 2020 7a5f 6d6f  }").        z_mo
-0001f4a0: 7665 203d 2046 6962 7365 6d53 7461 6765  ve = FibsemStage
-0001f4b0: 506f 7369 7469 6f6e 2878 3d30 2c20 793d  Position(x=0, y=
-0001f4c0: 302c 207a 3d7a 5f6d 6f76 652c 2072 3d30  0, z=z_move, r=0
-0001f4d0: 2c20 743d 3029 0a20 2020 2020 2020 2073  , t=0).        s
-0001f4e0: 656c 662e 6d6f 7665 5f73 7461 6765 5f72  elf.move_stage_r
-0001f4f0: 656c 6174 6976 6528 7a5f 6d6f 7665 290a  elative(z_move).
-0001f500: 0a20 2020 2020 2020 2073 656c 662e 636f  .        self.co
-0001f510: 6e6e 6563 7469 6f6e 2e53 454d 2e4f 7074  nnection.SEM.Opt
-0001f520: 6963 732e 5365 7457 4428 7764 290a 0a20  ics.SetWD(wd).. 
-0001f530: 2020 2064 6566 205f 795f 636f 7272 6563     def _y_correc
-0001f540: 7465 645f 7374 6167 655f 6d6f 7665 6d65  ted_stage_moveme
-0001f550: 6e74 280a 2020 2020 2020 2020 7365 6c66  nt(.        self
-0001f560: 2c0a 2020 2020 2020 2020 7365 7474 696e  ,.        settin
-0001f570: 6773 3a20 4d69 6372 6f73 636f 7065 5365  gs: MicroscopeSe
-0001f580: 7474 696e 6773 2c0a 2020 2020 2020 2020  ttings,.        
-0001f590: 6578 7065 6374 6564 5f79 3a20 666c 6f61  expected_y: floa
-0001f5a0: 742c 0a20 2020 2020 2020 2062 6561 6d5f  t,.        beam_
-0001f5b0: 7479 7065 3a20 4265 616d 5479 7065 203d  type: BeamType =
-0001f5c0: 2042 6561 6d54 7970 652e 454c 4543 5452   BeamType.ELECTR
-0001f5d0: 4f4e 2c0a 2020 2020 2920 2d3e 2046 6962  ON,.    ) -> Fib
-0001f5e0: 7365 6d53 7461 6765 506f 7369 7469 6f6e  semStagePosition
-0001f5f0: 3a0a 2020 2020 2020 2020 2222 220a 2020  :.        """.  
-0001f600: 2020 2020 2020 4361 6c63 756c 6174 6520        Calculate 
-0001f610: 7468 6520 7920 636f 7272 6563 7465 6420  the y corrected 
-0001f620: 7374 6167 6520 6d6f 7665 6d65 6e74 2c20  stage movement, 
-0001f630: 636f 7272 6563 7465 6420 666f 7220 7468  corrected for th
-0001f640: 6520 6164 6469 7469 6f6e 616c 2074 696c  e additional til
-0001f650: 7420 6f66 2074 6865 2073 616d 706c 6520  t of the sample 
-0001f660: 686f 6c64 6572 2028 7072 652d 7469 6c74  holder (pre-tilt
-0001f670: 2061 6e67 6c65 292e 0a0a 2020 2020 2020   angle)...      
-0001f680: 2020 4172 6773 3a0a 2020 2020 2020 2020    Args:.        
-0001f690: 2020 2020 7365 7474 696e 6773 2028 4d69      settings (Mi
-0001f6a0: 6372 6f73 636f 7065 5365 7474 696e 6773  croscopeSettings
-0001f6b0: 293a 206d 6963 726f 7363 6f70 6520 7365  ): microscope se
-0001f6c0: 7474 696e 6773 0a20 2020 2020 2020 2020  ttings.         
-0001f6d0: 2020 2065 7870 6563 7465 645f 7920 2866     expected_y (f
-0001f6e0: 6c6f 6174 2c20 6f70 7469 6f6e 616c 293a  loat, optional):
-0001f6f0: 2064 6973 7461 6e63 6520 616c 6f6e 6720   distance along 
-0001f700: 792d 6178 6973 2e0a 2020 2020 2020 2020  y-axis..        
-0001f710: 2020 2020 6265 616d 5f74 7970 6520 2842      beam_type (B
-0001f720: 6561 6d54 7970 652c 206f 7074 696f 6e61  eamType, optiona
-0001f730: 6c29 3a20 6265 616d 5f74 7970 6520 746f  l): beam_type to
-0001f740: 206d 6f76 6520 696e 2e20 4465 6661 756c   move in. Defaul
-0001f750: 7473 2074 6f20 4265 616d 5479 7065 2e45  ts to BeamType.E
-0001f760: 4c45 4354 524f 4e2e 0a0a 2020 2020 2020  LECTRON...      
-0001f770: 2020 5265 7475 726e 733a 0a20 2020 2020    Returns:.     
-0001f780: 2020 2020 2020 2053 7461 6765 506f 7369         StagePosi
-0001f790: 7469 6f6e 3a20 7920 636f 7272 6563 7465  tion: y correcte
-0001f7a0: 6420 7374 6167 6520 6d6f 7665 6d65 6e74  d stage movement
-0001f7b0: 2028 7265 6c61 7469 7665 2070 6f73 6974   (relative posit
-0001f7c0: 696f 6e29 0a20 2020 2020 2020 2022 2222  ion).        """
-0001f7d0: 0a0a 2020 2020 2020 2020 2320 544f 444f  ..        # TODO
-0001f7e0: 3a20 7265 706c 6163 6520 7769 7468 2063  : replace with c
-0001f7f0: 616d 6572 6120 6d61 7472 6978 202a 2069  amera matrix * i
-0001f800: 6e76 6572 7365 206b 696e 656d 6174 6963  nverse kinematic
-0001f810: 730a 2020 2020 2020 2020 2320 544f 444f  s.        # TODO
-0001f820: 3a20 7265 706c 6163 6520 7374 6167 655f  : replace stage_
-0001f830: 7469 6c74 5f66 6c61 745f 746f 5f65 6c65  tilt_flat_to_ele
-0001f840: 6374 726f 6e20 7769 7468 2070 7265 2d74  ctron with pre-t
-0001f850: 696c 740a 0a20 2020 2020 2020 2023 2061  ilt..        # a
-0001f860: 6c6c 2061 6e67 6c65 7320 696e 2072 6164  ll angles in rad
-0001f870: 6961 6e73 0a20 2020 2020 2020 2073 7461  ians.        sta
-0001f880: 6765 5f74 696c 745f 666c 6174 5f74 6f5f  ge_tilt_flat_to_
-0001f890: 656c 6563 7472 6f6e 203d 206e 702e 6465  electron = np.de
-0001f8a0: 6732 7261 6428 0a20 2020 2020 2020 2020  g2rad(.         
-0001f8b0: 2020 2073 6574 7469 6e67 732e 7379 7374     settings.syst
-0001f8c0: 656d 2e73 7461 6765 2e74 696c 745f 666c  em.stage.tilt_fl
-0001f8d0: 6174 5f74 6f5f 656c 6563 7472 6f6e 0a20  at_to_electron. 
-0001f8e0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-0001f8f0: 2073 7461 6765 5f74 696c 745f 666c 6174   stage_tilt_flat
-0001f900: 5f74 6f5f 696f 6e20 3d20 6e70 2e64 6567  _to_ion = np.deg
-0001f910: 3272 6164 2873 6574 7469 6e67 732e 7379  2rad(settings.sy
-0001f920: 7374 656d 2e73 7461 6765 2e74 696c 745f  stem.stage.tilt_
-0001f930: 666c 6174 5f74 6f5f 696f 6e29 0a0a 2020  flat_to_ion)..  
-0001f940: 2020 2020 2020 2320 7374 6167 655f 726f        # stage_ro
-0001f950: 7461 7469 6f6e 5f66 6c61 745f 746f 5f65  tation_flat_to_e
-0001f960: 6220 3d20 6e70 2e64 6567 3272 6164 280a  b = np.deg2rad(.
-0001f970: 2020 2020 2020 2020 2320 2020 2020 7365          #     se
-0001f980: 7474 696e 6773 2e73 7973 7465 6d2e 7374  ttings.system.st
-0001f990: 6167 652e 726f 7461 7469 6f6e 5f66 6c61  age.rotation_fla
-0001f9a0: 745f 746f 5f65 6c65 6374 726f 6e0a 2020  t_to_electron.  
-0001f9b0: 2020 2020 2020 2320 2920 2520 2832 202a        # ) % (2 *
-0001f9c0: 206e 702e 7069 290a 2020 2020 2020 2020   np.pi).        
-0001f9d0: 7374 6167 655f 726f 7461 7469 6f6e 5f66  stage_rotation_f
-0001f9e0: 6c61 745f 746f 5f69 6f6e 203d 206e 702e  lat_to_ion = np.
-0001f9f0: 6465 6732 7261 6428 0a20 2020 2020 2020  deg2rad(.       
-0001fa00: 2020 2020 2073 6574 7469 6e67 732e 7379       settings.sy
-0001fa10: 7374 656d 2e73 7461 6765 2e72 6f74 6174  stem.stage.rotat
-0001fa20: 696f 6e5f 666c 6174 5f74 6f5f 696f 6e0a  ion_flat_to_ion.
-0001fa30: 2020 2020 2020 2020 2920 2520 2832 202a          ) % (2 *
-0001fa40: 206e 702e 7069 290a 0a20 2020 2020 2020   np.pi)..       
-0001fa50: 2023 2063 7572 7265 6e74 2073 7461 6765   # current stage
-0001fa60: 2070 6f73 6974 696f 6e0a 2020 2020 2020   position.      
-0001fa70: 2020 6375 7272 656e 745f 7374 6167 655f    current_stage_
-0001fa80: 706f 7369 7469 6f6e 203d 2073 656c 662e  position = self.
-0001fa90: 6765 745f 7374 6167 655f 706f 7369 7469  get_stage_positi
-0001faa0: 6f6e 2829 0a20 2020 2020 2020 2073 7461  on().        sta
-0001fab0: 6765 5f72 6f74 6174 696f 6e20 3d20 6375  ge_rotation = cu
-0001fac0: 7272 656e 745f 7374 6167 655f 706f 7369  rrent_stage_posi
-0001fad0: 7469 6f6e 2e72 2025 2028 3220 2a20 6e70  tion.r % (2 * np
-0001fae0: 2e70 6929 0a20 2020 2020 2020 2073 7461  .pi).        sta
-0001faf0: 6765 5f74 696c 7420 3d20 6375 7272 656e  ge_tilt = curren
-0001fb00: 745f 7374 6167 655f 706f 7369 7469 6f6e  t_stage_position
-0001fb10: 2e74 0a0a 2020 2020 2020 2020 5052 4554  .t..        PRET
-0001fb20: 494c 545f 5349 474e 203d 2031 2e30 0a20  ILT_SIGN = 1.0. 
-0001fb30: 2020 2020 2020 2066 726f 6d20 6669 6273         from fibs
-0001fb40: 656d 2069 6d70 6f72 7420 6d6f 7665 6d65  em import moveme
-0001fb50: 6e74 0a20 2020 2020 2020 2023 2070 7265  nt.        # pre
-0001fb60: 7469 6c74 2061 6e67 6c65 2064 6570 656e  tilt angle depen
-0001fb70: 6473 206f 6e20 726f 7461 7469 6f6e 0a20  ds on rotation. 
-0001fb80: 2020 2020 2020 2023 2069 6620 726f 7461         # if rota
-0001fb90: 7469 6f6e 5f61 6e67 6c65 5f69 735f 736d  tion_angle_is_sm
-0001fba0: 616c 6c65 7228 7374 6167 655f 726f 7461  aller(stage_rota
-0001fbb0: 7469 6f6e 2c20 7374 6167 655f 726f 7461  tion, stage_rota
-0001fbc0: 7469 6f6e 5f66 6c61 745f 746f 5f65 622c  tion_flat_to_eb,
-0001fbd0: 2061 746f 6c3d 3529 3a0a 2020 2020 2020   atol=5):.      
-0001fbe0: 2020 2320 2020 2020 5052 4554 494c 545f    #     PRETILT_
-0001fbf0: 5349 474e 203d 2031 2e30 0a20 2020 2020  SIGN = 1.0.     
-0001fc00: 2020 2069 6620 6d6f 7665 6d65 6e74 2e72     if movement.r
-0001fc10: 6f74 6174 696f 6e5f 616e 676c 655f 6973  otation_angle_is
-0001fc20: 5f73 6d61 6c6c 6572 280a 2020 2020 2020  _smaller(.      
-0001fc30: 2020 2020 2020 7374 6167 655f 726f 7461        stage_rota
-0001fc40: 7469 6f6e 2c20 7374 6167 655f 726f 7461  tion, stage_rota
-0001fc50: 7469 6f6e 5f66 6c61 745f 746f 5f69 6f6e  tion_flat_to_ion
-0001fc60: 2c20 6174 6f6c 3d35 0a20 2020 2020 2020  , atol=5.       
-0001fc70: 2029 3a0a 2020 2020 2020 2020 2020 2020   ):.            
-0001fc80: 5052 4554 494c 545f 5349 474e 203d 202d  PRETILT_SIGN = -
-0001fc90: 312e 300a 0a20 2020 2020 2020 2063 6f72  1.0..        cor
-0001fca0: 7265 6374 6564 5f70 7265 7469 6c74 5f61  rected_pretilt_a
-0001fcb0: 6e67 6c65 203d 2050 5245 5449 4c54 5f53  ngle = PRETILT_S
-0001fcc0: 4947 4e20 2a20 2873 7461 6765 5f74 696c  IGN * (stage_til
-0001fcd0: 745f 666c 6174 5f74 6f5f 656c 6563 7472  t_flat_to_electr
-0001fce0: 6f6e 202d 2073 6574 7469 6e67 732e 7379  on - settings.sy
-0001fcf0: 7374 656d 2e73 7461 6765 2e70 7265 5f74  stem.stage.pre_t
-0001fd00: 696c 742a 636f 6e73 7461 6e74 732e 4445  ilt*constants.DE
-0001fd10: 4752 4545 535f 544f 5f52 4144 4941 4e53  GREES_TO_RADIANS
-0001fd20: 290a 2020 2020 2020 2020 0a20 2020 2020  ).        .     
-0001fd30: 2020 2070 6572 7370 6563 7469 7665 5f74     perspective_t
-0001fd40: 696c 7420 3d20 2d20 636f 7272 6563 7465  ilt = - correcte
-0001fd50: 645f 7072 6574 696c 745f 616e 676c 6520  d_pretilt_angle 
-0001fd60: 6966 2062 6561 6d5f 7479 7065 2069 7320  if beam_type is 
-0001fd70: 4265 616d 5479 7065 2e45 4c45 4354 524f  BeamType.ELECTRO
-0001fd80: 4e20 656c 7365 2028 2d20 636f 7272 6563  N else (- correc
-0001fd90: 7465 645f 7072 6574 696c 745f 616e 676c  ted_pretilt_angl
-0001fda0: 6520 2d20 7374 6167 655f 7469 6c74 5f66  e - stage_tilt_f
-0001fdb0: 6c61 745f 746f 5f69 6f6e 290a 0a20 2020  lat_to_ion)..   
-0001fdc0: 2020 2020 2079 5f6d 6f76 6520 3d20 6578       y_move = ex
-0001fdd0: 7065 6374 6564 5f79 2f6e 702e 636f 7328  pected_y/np.cos(
-0001fde0: 2873 7461 6765 5f74 696c 7420 2b20 636f  (stage_tilt + co
-0001fdf0: 7272 6563 7465 645f 7072 6574 696c 745f  rrected_pretilt_
-0001fe00: 616e 676c 6520 2b20 7065 7273 7065 6374  angle + perspect
-0001fe10: 6976 655f 7469 6c74 2929 0a20 2020 2020  ive_tilt)).     
-0001fe20: 2020 2020 0a20 2020 2020 2020 207a 5f6d      .        z_m
-0001fe30: 6f76 6520 3d20 795f 6d6f 7665 2a6e 702e  ove = y_move*np.
-0001fe40: 7369 6e28 2863 6f72 7265 6374 6564 5f70  sin((corrected_p
-0001fe50: 7265 7469 6c74 5f61 6e67 6c65 2929 200a  retilt_angle)) .
-0001fe60: 2020 2020 2020 2020 7072 696e 7428 6627          print(f'
-0001fe70: 5374 6167 6520 7469 6c74 3a20 7b73 7461  Stage tilt: {sta
-0001fe80: 6765 5f74 696c 747d 2c20 636f 7272 6563  ge_tilt}, correc
-0001fe90: 7465 6420 7072 6574 696c 743a 207b 636f  ted pretilt: {co
-0001fea0: 7272 6563 7465 645f 7072 6574 696c 745f  rrected_pretilt_
-0001feb0: 616e 676c 657d 2c20 795f 6d6f 7665 3a20  angle}, y_move: 
-0001fec0: 7b79 5f6d 6f76 657d 207a 5f6d 6f76 653a  {y_move} z_move:
-0001fed0: 207b 7a5f 6d6f 7665 7d27 290a 0a20 2020   {z_move}')..   
-0001fee0: 2020 2020 2072 6574 7572 6e20 4669 6273       return Fibs
-0001fef0: 656d 5374 6167 6550 6f73 6974 696f 6e28  emStagePosition(
-0001ff00: 783d 302c 2079 3d79 5f6d 6f76 652c 207a  x=0, y=y_move, z
-0001ff10: 3d7a 5f6d 6f76 6529 0a0a 2020 2020 6465  =z_move)..    de
-0001ff20: 6620 6d6f 7665 5f66 6c61 745f 746f 5f62  f move_flat_to_b
-0001ff30: 6561 6d28 0a20 2020 2020 2020 2073 656c  eam(.        sel
-0001ff40: 662c 2073 6574 7469 6e67 733d 4d69 6372  f, settings=Micr
-0001ff50: 6f73 636f 7065 5365 7474 696e 6773 2c20  oscopeSettings, 
-0001ff60: 6265 616d 5f74 7970 653a 2042 6561 6d54  beam_type: BeamT
-0001ff70: 7970 6520 3d20 4265 616d 5479 7065 2e45  ype = BeamType.E
-0001ff80: 4c45 4354 524f 4e0a 2020 2020 293a 0a20  LECTRON.    ):. 
-0001ff90: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-0001ffa0: 2020 204d 6f76 6573 2074 6865 206d 6963     Moves the mic
-0001ffb0: 726f 7363 6f70 6520 7374 6167 6520 746f  roscope stage to
-0001ffc0: 2074 6865 2074 696c 7420 616e 676c 6520   the tilt angle 
-0001ffd0: 636f 7272 6573 706f 6e64 696e 6720 746f  corresponding to
-0001ffe0: 2074 6865 2067 6976 656e 2062 6561 6d20   the given beam 
-0001fff0: 7479 7065 2c0a 2020 2020 2020 2020 736f  type,.        so
-00020000: 2074 6861 7420 7468 6520 7374 6167 6520   that the stage 
-00020010: 6973 2066 6c61 7420 7769 7468 2072 6573  is flat with res
-00020020: 7065 6374 2074 6f20 7468 6520 6265 616d  pect to the beam
-00020030: 2e0a 0a20 2020 2020 2020 2041 7267 733a  ...        Args:
-00020040: 0a20 2020 2020 2020 2020 2020 2073 6574  .            set
-00020050: 7469 6e67 7320 284d 6963 726f 7363 6f70  tings (Microscop
-00020060: 6553 6574 7469 6e67 7329 3a20 5468 6520  eSettings): The 
-00020070: 6375 7272 656e 7420 6d69 6372 6f73 636f  current microsco
-00020080: 7065 2073 6574 7469 6e67 732e 0a20 2020  pe settings..   
-00020090: 2020 2020 2020 2020 2062 6561 6d5f 7479           beam_ty
-000200a0: 7065 2028 4265 616d 5479 7065 293a 2054  pe (BeamType): T
-000200b0: 6865 2074 7970 6520 6f66 2062 6561 6d20  he type of beam 
-000200c0: 746f 2077 6869 6368 2074 6865 2073 7461  to which the sta
-000200d0: 6765 2073 686f 756c 6420 6265 206d 6164  ge should be mad
-000200e0: 6520 666c 6174 2e0a 2020 2020 2020 2020  e flat..        
-000200f0: 2020 2020 2020 2020 4d75 7374 2062 6520          Must be 
-00020100: 6f6e 6520 6f66 2042 6561 6d54 7970 652e  one of BeamType.
-00020110: 454c 4543 5452 4f4e 206f 7220 4265 616d  ELECTRON or Beam
-00020120: 5479 7065 2e49 4f4e 2e0a 0a20 2020 2020  Type.ION...     
-00020130: 2020 2052 6574 7572 6e73 3a0a 2020 2020     Returns:.    
-00020140: 2020 2020 2020 2020 4e6f 6e65 2e0a 2020          None..  
-00020150: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-00020160: 2020 5f63 6865 636b 5f62 6561 6d28 6265    _check_beam(be
-00020170: 616d 5f74 7970 652c 2073 656c 662e 6861  am_type, self.ha
-00020180: 7264 7761 7265 5f73 6574 7469 6e67 7329  rdware_settings)
-00020190: 0a20 2020 2020 2020 2023 2042 5547 2069  .        # BUG i
-000201a0: 6620 4920 7365 7420 6f72 2070 6173 7320  f I set or pass 
-000201b0: 4265 616d 5479 7065 2e49 4f4e 2069 7420  BeamType.ION it 
-000201c0: 7374 696c 6c20 7365 6573 2062 6561 6d5f  still sees beam_
-000201d0: 7479 7065 2061 7320 4265 616d 5479 7065  type as BeamType
-000201e0: 2e45 4c45 4354 524f 4e0a 2020 2020 2020  .ELECTRON.      
-000201f0: 2020 7374 6167 655f 7365 7474 696e 6773    stage_settings
-00020200: 203d 2073 6574 7469 6e67 732e 7379 7374   = settings.syst
-00020210: 656d 2e73 7461 6765 0a0a 2020 2020 2020  em.stage..      
-00020220: 2020 6966 2062 6561 6d5f 7479 7065 2069    if beam_type i
-00020230: 7320 4265 616d 5479 7065 2e49 4f4e 3a0a  s BeamType.ION:.
-00020240: 2020 2020 2020 2020 2020 2020 7469 6c74              tilt
-00020250: 203d 2073 7461 6765 5f73 6574 7469 6e67   = stage_setting
-00020260: 732e 7469 6c74 5f66 6c61 745f 746f 5f69  s.tilt_flat_to_i
-00020270: 6f6e 0a20 2020 2020 2020 2065 6c69 6620  on.        elif 
-00020280: 6265 616d 5f74 7970 6520 6973 2042 6561  beam_type is Bea
-00020290: 6d54 7970 652e 454c 4543 5452 4f4e 3a0a  mType.ELECTRON:.
-000202a0: 2020 2020 2020 2020 2020 2020 7469 6c74              tilt
-000202b0: 203d 2073 7461 6765 5f73 6574 7469 6e67   = stage_setting
-000202c0: 732e 7469 6c74 5f66 6c61 745f 746f 5f65  s.tilt_flat_to_e
-000202d0: 6c65 6374 726f 6e0a 0a20 2020 2020 2020  lectron..       
-000202e0: 206c 6f67 6769 6e67 2e69 6e66 6f28 6622   logging.info(f"
-000202f0: 4d6f 7669 6e67 2053 7461 6765 2046 6c61  Moving Stage Fla
-00020300: 7420 746f 207b 6265 616d 5f74 7970 652e  t to {beam_type.
-00020310: 6e61 6d65 7d20 4265 616d 2229 0a20 2020  name} Beam").   
-00020320: 2020 2020 2073 656c 662e 636f 6e6e 6563       self.connec
-00020330: 7469 6f6e 2e53 7461 6765 2e4d 6f76 6554  tion.Stage.MoveT
-00020340: 6f28 7469 6c74 783d 7469 6c74 290a 0a0a  o(tiltx=tilt)...
-00020350: 2020 2020 6465 6620 6765 745f 6d61 6e69      def get_mani
-00020360: 7075 6c61 746f 725f 7374 6174 6528 7365  pulator_state(se
-00020370: 6c66 2c73 6574 7469 6e67 733d 4d69 6372  lf,settings=Micr
-00020380: 6f73 636f 7065 5365 7474 696e 6773 2920  oscopeSettings) 
-00020390: 2d3e 2062 6f6f 6c3a 0a0a 2020 2020 2020  -> bool:..      
-000203a0: 2020 2222 2272 6574 7572 6e73 2074 7275    """returns tru
-000203b0: 6520 6966 206e 616e 6f6d 616e 6970 756c  e if nanomanipul
-000203c0: 6174 6f72 2069 7320 696e 7365 7274 6564  ator is inserted
-000203d0: 2e20 4d61 6e69 7075 6c61 746f 7220 706f  . Manipulator po
-000203e0: 7369 7469 6f6e 7320 6d75 7374 2062 6520  sitions must be 
-000203f0: 6361 6c69 6272 6174 6564 2061 6e64 2073  calibrated and s
-00020400: 746f 7265 6420 696e 206d 6f64 656c 2e79  tored in model.y
-00020410: 616d 6c20 6669 6c65 2069 6620 6e6f 7420  aml file if not 
-00020420: 646f 6e65 2073 6f0a 0a20 2020 2020 2020  done so..       
-00020430: 2052 6169 7365 733a 0a20 2020 2020 2020   Raises:.       
-00020440: 2020 2020 2056 616c 7565 4572 726f 723a       ValueError:
-00020450: 205f 6465 7363 7269 7074 696f 6e5f 0a0a   _description_..
-00020460: 2020 2020 2020 2020 5265 7475 726e 733a          Returns:
-00020470: 0a20 2020 2020 2020 2020 2020 205f 7479  .            _ty
-00020480: 7065 5f3a 2054 7275 6520 6966 2049 6e73  pe_: True if Ins
-00020490: 6572 7465 642c 2046 616c 7365 2069 6620  erted, False if 
-000204a0: 7265 7472 6163 7465 640a 2020 2020 2020  retracted.      
-000204b0: 2020 2222 220a 0a20 2020 2020 2020 206d    """..        m
-000204c0: 616e 6970 756c 6174 6f72 5f70 6f73 6974  anipulator_posit
-000204d0: 696f 6e73 203d 2073 6574 7469 6e67 732e  ions = settings.
-000204e0: 6861 7264 7761 7265 2e6d 616e 6970 756c  hardware.manipul
-000204f0: 6174 6f72 5f70 6f73 6974 696f 6e73 0a0a  ator_positions..
-00020500: 2020 2020 2020 2020 6966 206e 6f74 206d          if not m
-00020510: 616e 6970 756c 6174 6f72 5f70 6f73 6974  anipulator_posit
-00020520: 696f 6e73 5b22 6361 6c69 6272 6174 6564  ions["calibrated
-00020530: 225d 3a0a 2020 2020 2020 2020 2020 2020  "]:.            
-00020540: 6c6f 6767 696e 672e 7761 726e 696e 6728  logging.warning(
-00020550: 224d 616e 6970 756c 6174 6f72 2070 6f73  "Manipulator pos
-00020560: 6974 696f 6e73 206e 6f74 2063 616c 6962  itions not calib
-00020570: 7261 7465 642c 2063 616e 6e6f 7420 6765  rated, cannot ge
-00020580: 7420 7374 6174 6522 290a 2020 2020 2020  t state").      
-00020590: 2020 2020 2020 7265 7475 726e 2046 616c        return Fal
-000205a0: 7365 0a0a 2020 2020 2020 2020 7265 7472  se..        retr
-000205b0: 6163 7465 645f 706f 7369 7469 6f6e 5f78  acted_position_x
-000205c0: 203d 206d 616e 6970 756c 6174 6f72 5f70   = manipulator_p
-000205d0: 6f73 6974 696f 6e73 5b22 7061 726b 696e  ositions["parkin
-000205e0: 6722 5d5b 2278 225d 2a63 6f6e 7374 616e  g"]["x"]*constan
-000205f0: 7473 2e4d 4554 5245 5f54 4f5f 4d49 4c4c  ts.METRE_TO_MILL
-00020600: 494d 4554 5245 0a20 2020 2020 2020 2072  IMETRE.        r
-00020610: 6574 7261 6374 6564 5f70 6f73 6974 696f  etracted_positio
-00020620: 6e5f 7920 3d20 6d61 6e69 7075 6c61 746f  n_y = manipulato
-00020630: 725f 706f 7369 7469 6f6e 735b 2270 6172  r_positions["par
-00020640: 6b69 6e67 225d 5b22 7922 5d2a 636f 6e73  king"]["y"]*cons
-00020650: 7461 6e74 732e 4d45 5452 455f 544f 5f4d  tants.METRE_TO_M
-00020660: 494c 4c49 4d45 5452 450a 2020 2020 2020  ILLIMETRE.      
-00020670: 2020 7265 7472 6163 7465 645f 706f 7369    retracted_posi
-00020680: 7469 6f6e 5f7a 203d 206d 616e 6970 756c  tion_z = manipul
-00020690: 6174 6f72 5f70 6f73 6974 696f 6e73 5b22  ator_positions["
-000206a0: 7061 726b 696e 6722 5d5b 227a 225d 2a63  parking"]["z"]*c
-000206b0: 6f6e 7374 616e 7473 2e4d 4554 5245 5f54  onstants.METRE_T
-000206c0: 4f5f 4d49 4c4c 494d 4554 5245 0a0a 2020  O_MILLIMETRE..  
-000206d0: 2020 2020 2020 6375 7272 656e 745f 706f        current_po
-000206e0: 7369 7469 6f6e 203d 2073 656c 662e 6765  sition = self.ge
-000206f0: 745f 6d61 6e69 7075 6c61 746f 725f 706f  t_manipulator_po
-00020700: 7369 7469 6f6e 2829 0a0a 2020 2020 2020  sition()..      
-00020710: 2020 6375 7272 656e 745f 706f 7369 7469    current_positi
-00020720: 6f6e 5f61 7272 6179 203d 205b 6375 7272  on_array = [curr
-00020730: 656e 745f 706f 7369 7469 6f6e 2e78 2a63  ent_position.x*c
-00020740: 6f6e 7374 616e 7473 2e4d 4554 5245 5f54  onstants.METRE_T
-00020750: 4f5f 4d49 4c4c 494d 4554 5245 2c20 6375  O_MILLIMETRE, cu
-00020760: 7272 656e 745f 706f 7369 7469 6f6e 2e79  rrent_position.y
-00020770: 2a63 6f6e 7374 616e 7473 2e4d 4554 5245  *constants.METRE
-00020780: 5f54 4f5f 4d49 4c4c 494d 4554 5245 2c20  _TO_MILLIMETRE, 
-00020790: 6375 7272 656e 745f 706f 7369 7469 6f6e  current_position
-000207a0: 2e7a 2a63 6f6e 7374 616e 7473 2e4d 4554  .z*constants.MET
-000207b0: 5245 5f54 4f5f 4d49 4c4c 494d 4554 5245  RE_TO_MILLIMETRE
-000207c0: 5d0a 0a20 2020 2020 2020 2063 6865 636b  ]..        check
-000207d0: 5f63 6f6d 7061 7265 203d 206e 702e 6973  _compare = np.is
-000207e0: 636c 6f73 6528 6375 7272 656e 745f 706f  close(current_po
-000207f0: 7369 7469 6f6e 5f61 7272 6179 2c20 5b72  sition_array, [r
-00020800: 6574 7261 6374 6564 5f70 6f73 6974 696f  etracted_positio
-00020810: 6e5f 782c 2072 6574 7261 6374 6564 5f70  n_x, retracted_p
-00020820: 6f73 6974 696f 6e5f 792c 2072 6574 7261  osition_y, retra
-00020830: 6374 6564 5f70 6f73 6974 696f 6e5f 7a5d  cted_position_z]
-00020840: 2c20 6174 6f6c 3d30 2e31 290a 0a20 2020  , atol=0.1)..   
-00020850: 2020 2020 2072 6574 7572 6e20 5472 7565       return True
-00020860: 2069 6620 4661 6c73 6520 696e 2063 6865   if False in che
-00020870: 636b 5f63 6f6d 7061 7265 2065 6c73 6520  ck_compare else 
-00020880: 4661 6c73 650a 2020 2020 2020 2020 2020  False.          
-00020890: 2020 0a0a 2020 2020 6465 6620 6765 745f    ..    def get_
-000208a0: 6d61 6e69 7075 6c61 746f 725f 706f 7369  manipulator_posi
-000208b0: 7469 6f6e 2873 656c 6629 202d 3e20 4669  tion(self) -> Fi
-000208c0: 6273 656d 4d61 6e69 7075 6c61 746f 7250  bsemManipulatorP
-000208d0: 6f73 6974 696f 6e3a 0a20 2020 2020 2020  osition:.       
-000208e0: 2023 2070 6173 730a 2020 2020 2020 2020   # pass.        
-000208f0: 5f63 6865 636b 5f6e 6565 646c 6528 7365  _check_needle(se
-00020900: 6c66 2e68 6172 6477 6172 655f 7365 7474  lf.hardware_sett
-00020910: 696e 6773 290a 2020 2020 2020 2020 696e  ings).        in
-00020920: 6465 7820 3d20 300a 2020 2020 2020 2020  dex = 0.        
-00020930: 6f75 7470 7574 5f70 6f73 6974 696f 6e20  output_position 
-00020940: 3d20 7365 6c66 2e63 6f6e 6e65 6374 696f  = self.connectio
-00020950: 6e2e 4e61 6e6f 6d61 6e69 7075 6c61 746f  n.Nanomanipulato
-00020960: 722e 4765 7450 6f73 6974 696f 6e28 496e  r.GetPosition(In
-00020970: 6465 783d 696e 6465 7829 0a0a 2020 2020  dex=index)..    
-00020980: 2020 2020 2320 4765 7450 6f73 6974 696f      # GetPositio
-00020990: 6e20 7265 7475 726e 7320 7475 706c 6520  n returns tuple 
-000209a0: 696e 2074 6865 2066 6f72 6d20 2878 2c20  in the form (x, 
-000209b0: 792c 207a 2c20 7229 0a20 2020 2020 2020  y, z, r).       
-000209c0: 2023 2078 2c79 2c7a 2069 6e20 6d6d 2061   # x,y,z in mm a
-000209d0: 6e64 2072 2069 6e20 6465 6772 6565 732c  nd r in degrees,
-000209e0: 206e 6f20 7469 6c74 2069 6e66 6f72 6d61   no tilt informa
-000209f0: 7469 6f6e 0a0a 2020 2020 2020 2020 7820  tion..        x 
-00020a00: 3d20 6f75 7470 7574 5f70 6f73 6974 696f  = output_positio
-00020a10: 6e5b 305d 2a63 6f6e 7374 616e 7473 2e4d  n[0]*constants.M
-00020a20: 494c 4c49 4d45 5452 455f 544f 5f4d 4554  ILLIMETRE_TO_MET
-00020a30: 5245 0a20 2020 2020 2020 2079 203d 206f  RE.        y = o
-00020a40: 7574 7075 745f 706f 7369 7469 6f6e 5b31  utput_position[1
-00020a50: 5d2a 636f 6e73 7461 6e74 732e 4d49 4c4c  ]*constants.MILL
-00020a60: 494d 4554 5245 5f54 4f5f 4d45 5452 450a  IMETRE_TO_METRE.
-00020a70: 2020 2020 2020 2020 7a20 3d20 6f75 7470          z = outp
-00020a80: 7574 5f70 6f73 6974 696f 6e5b 325d 2a63  ut_position[2]*c
-00020a90: 6f6e 7374 616e 7473 2e4d 494c 4c49 4d45  onstants.MILLIME
-00020aa0: 5452 455f 544f 5f4d 4554 5245 0a20 2020  TRE_TO_METRE.   
-00020ab0: 2020 2020 2072 203d 206f 7574 7075 745f       r = output_
-00020ac0: 706f 7369 7469 6f6e 5b33 5d2a 636f 6e73  position[3]*cons
-00020ad0: 7461 6e74 732e 4445 4752 4545 535f 544f  tants.DEGREES_TO
-00020ae0: 5f52 4144 4941 4e53 0a0a 2020 2020 2020  _RADIANS..      
-00020af0: 2020 7265 7475 726e 2046 6962 7365 6d4d    return FibsemM
-00020b00: 616e 6970 756c 6174 6f72 506f 7369 7469  anipulatorPositi
-00020b10: 6f6e 2878 3d78 2c20 793d 792c 207a 3d7a  on(x=x, y=y, z=z
-00020b20: 2c20 723d 7229 0a0a 0a0a 2020 2020 6465  , r=r)....    de
-00020b30: 6620 696e 7365 7274 5f6d 616e 6970 756c  f insert_manipul
-00020b40: 6174 6f72 2873 656c 662c 206e 616d 653a  ator(self, name:
-00020b50: 2073 7472 203d 2022 5374 616e 6462 7922   str = "Standby"
-00020b60: 293a 0a20 2020 2020 2020 205f 6368 6563  ):.        _chec
-00020b70: 6b5f 6e65 6564 6c65 2873 656c 662e 6861  k_needle(self.ha
-00020b80: 7264 7761 7265 5f73 6574 7469 6e67 7329  rdware_settings)
-00020b90: 0a20 2020 2020 2020 2070 7265 7365 745f  .        preset_
-00020ba0: 706f 7369 7469 6f6e 7320 3d20 5b22 5061  positions = ["Pa
-00020bb0: 726b 696e 6722 2c22 5374 616e 6462 7922  rking","Standby"
-00020bc0: 2c22 576f 726b 696e 6722 2c5d 0a0a 2020  ,"Working",]..  
-00020bd0: 2020 2020 2020 6966 206e 616d 6520 3d3d        if name ==
-00020be0: 2022 5041 524b 223a 0a20 2020 2020 2020   "PARK":.       
-00020bf0: 2020 2020 206e 616d 6520 3d20 2250 6172       name = "Par
-00020c00: 6b69 6e67 220a 0a20 2020 2020 2020 2066  king"..        f
-00020c10: 6f72 2070 6f73 6974 696f 6e20 696e 2070  or position in p
-00020c20: 7265 7365 745f 706f 7369 7469 6f6e 733a  reset_positions:
-00020c30: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00020c40: 6e61 6d65 2e6c 6f77 6572 2829 203d 3d20  name.lower() == 
-00020c50: 706f 7369 7469 6f6e 2e6c 6f77 6572 2829  position.lower()
-00020c60: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00020c70: 2020 6e61 6d65 203d 2070 6f73 6974 696f    name = positio
-00020c80: 6e0a 2020 2020 0a0a 2020 2020 2020 2020  n.    ..        
-00020c90: 6966 206e 616d 6520 6e6f 7420 696e 2070  if name not in p
-00020ca0: 7265 7365 745f 706f 7369 7469 6f6e 733a  reset_positions:
-00020cb0: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
-00020cc0: 7365 2056 616c 7565 4572 726f 7228 6622  se ValueError(f"
-00020cd0: 506f 7369 7469 6f6e 207b 6e61 6d65 7d20  Position {name} 
-00020ce0: 6973 206e 6f74 2061 2076 616c 6964 2070  is not a valid p
-00020cf0: 7265 7365 7420 706f 7369 7469 6f6e 2e20  reset position. 
-00020d00: 5661 6c69 6420 706f 7369 7469 6f6e 7320  Valid positions 
-00020d10: 6172 6520 7b70 7265 7365 745f 706f 7369  are {preset_posi
-00020d20: 7469 6f6e 737d 2e22 290a 0a0a 2020 2020  tions}.")...    
-00020d30: 2020 2020 696e 7365 7274 5f70 6f73 6974      insert_posit
-00020d40: 696f 6e20 3d20 6765 7461 7474 7228 7365  ion = getattr(se
-00020d50: 6c66 2e63 6f6e 6e65 6374 696f 6e2e 4e61  lf.connection.Na
-00020d60: 6e6f 6d61 6e69 7075 6c61 746f 722e 506f  nomanipulator.Po
-00020d70: 7369 7469 6f6e 2c6e 616d 6529 0a0a 2020  sition,name)..  
-00020d80: 2020 2020 2020 696e 6465 7820 3d20 300a        index = 0.
-00020d90: 2020 2020 2020 2020 6c6f 6767 696e 672e          logging.
-00020da0: 696e 666f 2866 2249 6e73 6572 7469 6e67  info(f"Inserting
-00020db0: 204e 616e 6f6d 616e 6970 756c 6174 6f72   Nanomanipulator
-00020dc0: 2074 6f20 7b6e 616d 657d 2070 6f73 6974   to {name} posit
-00020dd0: 696f 6e22 290a 2020 2020 2020 2020 7365  ion").        se
-00020de0: 6c66 2e63 6f6e 6e65 6374 696f 6e2e 4e61  lf.connection.Na
-00020df0: 6e6f 6d61 6e69 7075 6c61 746f 722e 4d6f  nomanipulator.Mo
-00020e00: 7665 546f 506f 7369 7469 6f6e 2849 6e64  veToPosition(Ind
-00020e10: 6578 3d69 6e64 6578 2c50 6f73 6974 696f  ex=index,Positio
-00020e20: 6e3d 696e 7365 7274 5f70 6f73 6974 696f  n=insert_positio
-00020e30: 6e29 0a0a 2020 2020 6465 6620 5f63 6865  n)..    def _che
-00020e40: 636b 5f6d 616e 6970 756c 6174 6f72 5f6c  ck_manipulator_l
-00020e50: 696d 6974 7328 7365 6c66 2c78 2c79 2c7a  imits(self,x,y,z
-00020e60: 2c72 293a 0a0a 2020 2020 2020 2020 6c69  ,r):..        li
-00020e70: 6d69 7473 203d 2073 656c 662e 636f 6e6e  mits = self.conn
-00020e80: 6563 7469 6f6e 2e4e 616e 6f6d 616e 6970  ection.Nanomanip
-00020e90: 756c 6174 6f72 2e47 6574 4c69 6d69 7473  ulator.GetLimits
-00020ea0: 2849 6e64 6578 3d30 2c54 7970 653d 3029  (Index=0,Type=0)
-00020eb0: 0a0a 2020 2020 2020 2020 786d 696e 203d  ..        xmin =
-00020ec0: 206c 696d 6974 735b 305d 0a20 2020 2020   limits[0].     
-00020ed0: 2020 2078 6d61 7820 3d20 6c69 6d69 7473     xmax = limits
-00020ee0: 5b31 5d0a 2020 2020 2020 2020 796d 696e  [1].        ymin
-00020ef0: 203d 206c 696d 6974 735b 325d 0a20 2020   = limits[2].   
-00020f00: 2020 2020 2079 6d61 7820 3d20 6c69 6d69       ymax = limi
-00020f10: 7473 5b33 5d0a 2020 2020 2020 2020 7a6d  ts[3].        zm
-00020f20: 696e 203d 206c 696d 6974 735b 345d 0a20  in = limits[4]. 
-00020f30: 2020 2020 2020 207a 6d61 7820 3d20 6c69         zmax = li
-00020f40: 6d69 7473 5b35 5d0a 2020 2020 2020 2020  mits[5].        
-00020f50: 726d 696e 203d 206c 696d 6974 735b 365d  rmin = limits[6]
-00020f60: 0a20 2020 2020 2020 2072 6d61 7820 3d20  .        rmax = 
-00020f70: 6c69 6d69 7473 5b37 5d0a 0a20 2020 2020  limits[7]..     
-00020f80: 2020 2061 7373 6572 7420 7820 3e3d 2078     assert x >= x
-00020f90: 6d69 6e20 616e 6420 7820 3c3d 2078 6d61  min and x <= xma
-00020fa0: 782c 2066 2258 2070 6f73 6974 696f 6e20  x, f"X position 
-00020fb0: 7b78 7d20 6973 206f 7574 7369 6465 206f  {x} is outside o
-00020fc0: 6620 6d61 6e69 7075 6c61 746f 7220 6c69  f manipulator li
-00020fd0: 6d69 7473 207b 786d 696e 7d20 746f 207b  mits {xmin} to {
-00020fe0: 786d 6178 7d22 0a20 2020 2020 2020 2061  xmax}".        a
-00020ff0: 7373 6572 7420 7920 3e3d 2079 6d69 6e20  ssert y >= ymin 
-00021000: 616e 6420 7920 3c3d 2079 6d61 782c 2066  and y <= ymax, f
-00021010: 2259 2070 6f73 6974 696f 6e20 7b79 7d20  "Y position {y} 
-00021020: 6973 206f 7574 7369 6465 206f 6620 6d61  is outside of ma
-00021030: 6e69 7075 6c61 746f 7220 6c69 6d69 7473  nipulator limits
-00021040: 207b 796d 696e 7d20 746f 207b 796d 6178   {ymin} to {ymax
-00021050: 7d22 0a20 2020 2020 2020 2061 7373 6572  }".        asser
-00021060: 7420 7a20 3e3d 207a 6d69 6e20 616e 6420  t z >= zmin and 
-00021070: 7a20 3c3d 207a 6d61 782c 2066 225a 2070  z <= zmax, f"Z p
-00021080: 6f73 6974 696f 6e20 7b7a 7d20 6973 206f  osition {z} is o
-00021090: 7574 7369 6465 206f 6620 6d61 6e69 7075  utside of manipu
-000210a0: 6c61 746f 7220 6c69 6d69 7473 207b 7a6d  lator limits {zm
-000210b0: 696e 7d20 746f 207b 7a6d 6178 7d22 0a20  in} to {zmax}". 
-000210c0: 2020 2020 2020 2061 7373 6572 7420 7220         assert r 
-000210d0: 3e3d 2072 6d69 6e20 616e 6420 7220 3c3d  >= rmin and r <=
-000210e0: 2072 6d61 782c 2066 2252 2070 6f73 6974   rmax, f"R posit
-000210f0: 696f 6e20 7b72 7d20 6973 206f 7574 7369  ion {r} is outsi
-00021100: 6465 206f 6620 6d61 6e69 7075 6c61 746f  de of manipulato
-00021110: 7220 6c69 6d69 7473 207b 726d 696e 7d20  r limits {rmin} 
-00021120: 746f 207b 726d 6178 7d22 0a20 2020 200a  to {rmax}".    .
-00021130: 2020 2020 6465 6620 7265 7472 6163 745f      def retract_
-00021140: 6d61 6e69 7075 6c61 746f 7228 7365 6c66  manipulator(self
-00021150: 293a 0a20 2020 2020 2020 2072 6574 7261  ):.        retra
-00021160: 6374 5f70 6f73 6974 696f 6e20 3d20 6765  ct_position = ge
-00021170: 7461 7474 7228 7365 6c66 2e63 6f6e 6e65  tattr(self.conne
-00021180: 6374 696f 6e2e 4e61 6e6f 6d61 6e69 7075  ction.Nanomanipu
-00021190: 6c61 746f 722e 506f 7369 7469 6f6e 2c22  lator.Position,"
-000211a0: 5061 726b 696e 6722 290a 2020 2020 2020  Parking").      
-000211b0: 2020 696e 6465 7820 3d20 300a 2020 2020    index = 0.    
-000211c0: 2020 2020 7365 6c66 2e63 6f6e 6e65 6374      self.connect
-000211d0: 696f 6e2e 4e61 6e6f 6d61 6e69 7075 6c61  ion.Nanomanipula
-000211e0: 746f 722e 4d6f 7665 546f 506f 7369 7469  tor.MoveToPositi
-000211f0: 6f6e 2849 6e64 6578 3d69 6e64 6578 2c50  on(Index=index,P
-00021200: 6f73 6974 696f 6e3d 7265 7472 6163 745f  osition=retract_
-00021210: 706f 7369 7469 6f6e 290a 2020 2020 2020  position).      
-00021220: 2020 0a0a 2020 2020 0a20 2020 2064 6566    ..    .    def
-00021230: 206d 6f76 655f 6d61 6e69 7075 6c61 746f   move_manipulato
-00021240: 725f 7265 6c61 7469 7665 2873 656c 662c  r_relative(self,
-00021250: 706f 7369 7469 6f6e 3a20 4669 6273 656d  position: Fibsem
-00021260: 4d61 6e69 7075 6c61 746f 7250 6f73 6974  ManipulatorPosit
-00021270: 696f 6e2c 206e 616d 653a 2073 7472 203d  ion, name: str =
-00021280: 204e 6f6e 6529 3a0a 2020 2020 2020 2020   None):.        
-00021290: 6966 206e 6f74 206e 702e 6973 636c 6f73  if not np.isclos
-000212a0: 6528 706f 7369 7469 6f6e 2e72 2c20 302e  e(position.r, 0.
-000212b0: 3029 3a0a 2020 2020 2020 2020 2020 2020  0):.            
-000212c0: 726f 7461 7469 6f6e 203d 2054 7275 650a  rotation = True.
-000212d0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-000212e0: 2020 2020 2020 2020 2020 726f 7461 7469            rotati
-000212f0: 6f6e 203d 2046 616c 7365 0a20 2020 2020  on = False.     
-00021300: 2020 2069 6620 6e6f 7420 6e70 2e69 7363     if not np.isc
-00021310: 6c6f 7365 2870 6f73 6974 696f 6e2e 742c  lose(position.t,
-00021320: 2030 2e30 293a 0a20 2020 2020 2020 2020   0.0):.         
-00021330: 2020 2074 696c 7420 3d20 5472 7565 0a20     tilt = True. 
-00021340: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00021350: 2020 2020 2020 2020 2074 696c 7420 3d20           tilt = 
-00021360: 4661 6c73 650a 2020 2020 2020 2020 5f63  False.        _c
-00021370: 6865 636b 5f6e 6565 646c 6528 7365 6c66  heck_needle(self
-00021380: 2e68 6172 6477 6172 655f 7365 7474 696e  .hardware_settin
-00021390: 6773 2c20 726f 7461 7469 6f6e 2c20 7469  gs, rotation, ti
-000213a0: 6c74 290a 2020 2020 2020 2020 6966 2073  lt).        if s
-000213b0: 656c 662e 636f 6e6e 6563 7469 6f6e 2e4e  elf.connection.N
-000213c0: 616e 6f6d 616e 6970 756c 6174 6f72 2e49  anomanipulator.I
-000213d0: 7343 616c 6962 7261 7465 6428 3029 203d  sCalibrated(0) =
-000213e0: 3d20 4661 6c73 653a 0a20 2020 2020 2020  = False:.       
-000213f0: 2020 2020 206c 6f67 6769 6e67 2e69 6e66       logging.inf
-00021400: 6f28 2243 616c 6962 7261 7469 6e67 206d  o("Calibrating m
-00021410: 616e 6970 756c 6174 6f72 2229 0a20 2020  anipulator").   
-00021420: 2020 2020 2020 2020 2073 656c 662e 636f           self.co
-00021430: 6e6e 6563 7469 6f6e 2e4e 616e 6f6d 616e  nnection.Nanoman
-00021440: 6970 756c 6174 6f72 2e43 616c 6962 7261  ipulator.Calibra
-00021450: 7465 2830 290a 0a20 2020 2020 2020 2063  te(0)..        c
-00021460: 7572 7265 6e74 5f70 6f73 6974 696f 6e20  urrent_position 
-00021470: 3d20 7365 6c66 2e67 6574 5f6d 616e 6970  = self.get_manip
-00021480: 756c 6174 6f72 5f70 6f73 6974 696f 6e28  ulator_position(
-00021490: 290a 2020 2020 2020 2020 0a20 2020 2020  ).        .     
-000214a0: 2020 2078 203d 2028 6375 7272 656e 745f     x = (current_
-000214b0: 706f 7369 7469 6f6e 2e78 202b 2070 6f73  position.x + pos
-000214c0: 6974 696f 6e2e 7829 2a63 6f6e 7374 616e  ition.x)*constan
-000214d0: 7473 2e4d 4554 5245 5f54 4f5f 4d49 4c4c  ts.METRE_TO_MILL
-000214e0: 494d 4554 5245 0a20 2020 2020 2020 2079  IMETRE.        y
-000214f0: 203d 2028 6375 7272 656e 745f 706f 7369   = (current_posi
-00021500: 7469 6f6e 2e79 202b 2070 6f73 6974 696f  tion.y + positio
-00021510: 6e2e 7929 2a63 6f6e 7374 616e 7473 2e4d  n.y)*constants.M
-00021520: 4554 5245 5f54 4f5f 4d49 4c4c 494d 4554  ETRE_TO_MILLIMET
-00021530: 5245 0a20 2020 2020 2020 207a 203d 2028  RE.        z = (
-00021540: 6375 7272 656e 745f 706f 7369 7469 6f6e  current_position
-00021550: 2e7a 202b 2070 6f73 6974 696f 6e2e 7a29  .z + position.z)
-00021560: 2a63 6f6e 7374 616e 7473 2e4d 4554 5245  *constants.METRE
-00021570: 5f54 4f5f 4d49 4c4c 494d 4554 5245 0a20  _TO_MILLIMETRE. 
-00021580: 2020 2020 2020 2072 203d 2028 6375 7272         r = (curr
-00021590: 656e 745f 706f 7369 7469 6f6e 2e72 202b  ent_position.r +
-000215a0: 2070 6f73 6974 696f 6e2e 7229 2a63 6f6e   position.r)*con
-000215b0: 7374 616e 7473 2e52 4144 4941 4e53 5f54  stants.RADIANS_T
-000215c0: 4f5f 4445 4752 4545 530a 2020 2020 2020  O_DEGREES.      
-000215d0: 2020 696e 6465 7820 3d20 300a 0a20 2020    index = 0..   
-000215e0: 2020 2020 2023 2073 656c 662e 5f63 6865       # self._che
-000215f0: 636b 5f6d 616e 6970 756c 6174 6f72 5f6c  ck_manipulator_l
-00021600: 696d 6974 7328 782c 792c 7a2c 7229 0a0a  imits(x,y,z,r)..
-00021610: 2020 2020 2020 2020 6c6f 6767 696e 672e          logging.
-00021620: 696e 666f 2866 226d 6f76 696e 6720 6d61  info(f"moving ma
-00021630: 6e69 7075 6c61 746f 7220 6279 207b 706f  nipulator by {po
-00021640: 7369 7469 6f6e 7d22 290a 2020 2020 2020  sition}").      
-00021650: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
-00021660: 2020 2073 656c 662e 636f 6e6e 6563 7469     self.connecti
-00021670: 6f6e 2e4e 616e 6f6d 616e 6970 756c 6174  on.Nanomanipulat
-00021680: 6f72 2e4d 6f76 6554 6f28 496e 6465 783d  or.MoveTo(Index=
-00021690: 696e 6465 782c 583d 782c 2059 3d79 2c20  index,X=x, Y=y, 
-000216a0: 5a3d 7a2c 2052 6f74 3d72 290a 2020 2020  Z=z, Rot=r).    
-000216b0: 2020 2020 6578 6365 7074 2045 7863 6570      except Excep
-000216c0: 7469 6f6e 2061 7320 653a 0a20 2020 2020  tion as e:.     
-000216d0: 2020 2020 2020 206c 6f67 6769 6e67 2e65         logging.e
-000216e0: 7272 6f72 2865 290a 2020 2020 2020 2020  rror(e).        
-000216f0: 2020 2020 7265 7475 726e 2065 0a0a 2020      return e..  
-00021700: 2020 0a20 2020 2064 6566 206d 6f76 655f    .    def move_
-00021710: 6d61 6e69 7075 6c61 746f 725f 6162 736f  manipulator_abso
-00021720: 6c75 7465 2873 656c 662c 2070 6f73 6974  lute(self, posit
-00021730: 696f 6e3a 2046 6962 7365 6d4d 616e 6970  ion: FibsemManip
-00021740: 756c 6174 6f72 506f 7369 7469 6f6e 2c20  ulatorPosition, 
-00021750: 6e61 6d65 3a20 7374 7220 3d20 4e6f 6e65  name: str = None
-00021760: 293a 0a20 2020 2020 2020 2069 6620 6e6f  ):.        if no
-00021770: 7420 6e70 2e69 7363 6c6f 7365 2870 6f73  t np.isclose(pos
-00021780: 6974 696f 6e2e 722c 2030 2e30 293a 0a20  ition.r, 0.0):. 
-00021790: 2020 2020 2020 2020 2020 2072 6f74 6174             rotat
-000217a0: 696f 6e20 3d20 5472 7565 0a20 2020 2020  ion = True.     
-000217b0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-000217c0: 2020 2020 2072 6f74 6174 696f 6e20 3d20       rotation = 
-000217d0: 4661 6c73 650a 2020 2020 2020 2020 6966  False.        if
-000217e0: 206e 6f74 206e 702e 6973 636c 6f73 6528   not np.isclose(
-000217f0: 706f 7369 7469 6f6e 2e74 2c20 302e 3029  position.t, 0.0)
-00021800: 3a0a 2020 2020 2020 2020 2020 2020 7469  :.            ti
-00021810: 6c74 203d 2054 7275 650a 2020 2020 2020  lt = True.      
-00021820: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00021830: 2020 2020 7469 6c74 203d 2046 616c 7365      tilt = False
-00021840: 0a20 2020 2020 2020 205f 6368 6563 6b5f  .        _check_
-00021850: 6e65 6564 6c65 2873 656c 662e 6861 7264  needle(self.hard
-00021860: 7761 7265 5f73 6574 7469 6e67 732c 2072  ware_settings, r
-00021870: 6f74 6174 696f 6e2c 2074 696c 7429 0a20  otation, tilt). 
-00021880: 2020 2020 2020 2069 6620 7365 6c66 2e63         if self.c
-00021890: 6f6e 6e65 6374 696f 6e2e 4e61 6e6f 6d61  onnection.Nanoma
-000218a0: 6e69 7075 6c61 746f 722e 4973 4361 6c69  nipulator.IsCali
-000218b0: 6272 6174 6564 2830 2920 3d3d 2046 616c  brated(0) == Fal
-000218c0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-000218d0: 6c6f 6767 696e 672e 696e 666f 2822 4361  logging.info("Ca
-000218e0: 6c69 6272 6174 696e 6720 6d61 6e69 7075  librating manipu
-000218f0: 6c61 746f 7222 290a 2020 2020 2020 2020  lator").        
-00021900: 2020 2020 7365 6c66 2e63 6f6e 6e65 6374      self.connect
-00021910: 696f 6e2e 4e61 6e6f 6d61 6e69 7075 6c61  ion.Nanomanipula
-00021920: 746f 722e 4361 6c69 6272 6174 6528 3029  tor.Calibrate(0)
-00021930: 0a20 2020 2020 2020 200a 2020 2020 2020  .        .      
-00021940: 2020 7820 3d20 706f 7369 7469 6f6e 2e78    x = position.x
-00021950: 2a63 6f6e 7374 616e 7473 2e4d 4554 5245  *constants.METRE
-00021960: 5f54 4f5f 4d49 4c4c 494d 4554 5245 0a20  _TO_MILLIMETRE. 
-00021970: 2020 2020 2020 2079 203d 2070 6f73 6974         y = posit
-00021980: 696f 6e2e 792a 636f 6e73 7461 6e74 732e  ion.y*constants.
-00021990: 4d45 5452 455f 544f 5f4d 494c 4c49 4d45  METRE_TO_MILLIME
-000219a0: 5452 450a 2020 2020 2020 2020 7a20 3d20  TRE.        z = 
-000219b0: 706f 7369 7469 6f6e 2e7a 2a63 6f6e 7374  position.z*const
-000219c0: 616e 7473 2e4d 4554 5245 5f54 4f5f 4d49  ants.METRE_TO_MI
-000219d0: 4c4c 494d 4554 5245 0a20 2020 2020 2020  LLIMETRE.       
-000219e0: 2072 203d 2070 6f73 6974 696f 6e2e 722a   r = position.r*
-000219f0: 636f 6e73 7461 6e74 732e 5241 4449 414e  constants.RADIAN
-00021a00: 535f 544f 5f44 4547 5245 4553 0a20 2020  S_TO_DEGREES.   
-00021a10: 2020 2020 2069 6e64 6578 203d 2030 0a0a       index = 0..
-00021a20: 2020 2020 2020 2020 2320 7365 6c66 2e5f          # self._
-00021a30: 6368 6563 6b5f 6d61 6e69 7075 6c61 746f  check_manipulato
-00021a40: 725f 6c69 6d69 7473 2878 2c79 2c7a 2c72  r_limits(x,y,z,r
-00021a50: 290a 0a20 2020 2020 2020 206c 6f67 6769  )..        loggi
-00021a60: 6e67 2e69 6e66 6f28 6622 6d6f 7669 6e67  ng.info(f"moving
-00021a70: 206d 616e 6970 756c 6174 6f72 2074 6f20   manipulator to 
-00021a80: 7b70 6f73 6974 696f 6e7d 2229 0a0a 2020  {position}")..  
-00021a90: 2020 2020 2020 7365 6c66 2e63 6f6e 6e65        self.conne
-00021aa0: 6374 696f 6e2e 4e61 6e6f 6d61 6e69 7075  ction.Nanomanipu
-00021ab0: 6c61 746f 722e 4d6f 7665 546f 2849 6e64  lator.MoveTo(Ind
-00021ac0: 6578 3d69 6e64 6578 2c20 583d 782c 2059  ex=index, X=x, Y
-00021ad0: 3d79 2c20 5a3d 7a2c 2052 6f74 3d72 290a  =y, Z=z, Rot=r).
-00021ae0: 0a20 2020 2064 6566 2063 616c 6962 7261  .    def calibra
-00021af0: 7465 5f6d 616e 6970 756c 6174 6f72 2873  te_manipulator(s
-00021b00: 656c 6629 3a0a 2020 2020 2020 2020 5f63  elf):.        _c
-00021b10: 6865 636b 5f6e 6565 646c 6528 7365 6c66  heck_needle(self
-00021b20: 2e68 6172 6477 6172 655f 7365 7474 696e  .hardware_settin
-00021b30: 6773 290a 2020 2020 2020 2020 6c6f 6767  gs).        logg
-00021b40: 696e 672e 696e 666f 2822 4361 6c69 6272  ing.info("Calibr
-00021b50: 6174 696e 6720 6d61 6e69 7075 6c61 746f  ating manipulato
-00021b60: 7222 290a 2020 2020 2020 2020 7365 6c66  r").        self
-00021b70: 2e63 6f6e 6e65 6374 696f 6e2e 4e61 6e6f  .connection.Nano
-00021b80: 6d61 6e69 7075 6c61 746f 722e 4361 6c69  manipulator.Cali
-00021b90: 6272 6174 6528 3029 0a0a 2020 2020 6465  brate(0)..    de
-00021ba0: 6620 5f78 5f63 6f72 7265 6374 6564 5f6e  f _x_corrected_n
-00021bb0: 6565 646c 655f 6d6f 7665 6d65 6e74 2873  eedle_movement(s
-00021bc0: 656c 662c 2065 7870 6563 7465 645f 783a  elf, expected_x:
-00021bd0: 2066 6c6f 6174 2920 2d3e 2046 6962 7365   float) -> Fibse
-00021be0: 6d4d 616e 6970 756c 6174 6f72 506f 7369  mManipulatorPosi
-00021bf0: 7469 6f6e 3a0a 2020 2020 2020 2020 2222  tion:.        ""
-00021c00: 2243 616c 6375 6c61 7465 2074 6865 2063  "Calculate the c
-00021c10: 6f72 7265 6374 6564 206e 6565 646c 6520  orrected needle 
-00021c20: 6d6f 7665 6d65 6e74 2074 6f20 6d6f 7665  movement to move
-00021c30: 2069 6e20 7468 6520 782d 6178 6973 2e0a   in the x-axis..
-00021c40: 0a20 2020 2020 2020 2041 7267 733a 0a20  .        Args:. 
-00021c50: 2020 2020 2020 2020 2020 2065 7870 6563             expec
-00021c60: 7465 645f 7820 2866 6c6f 6174 293a 2064  ted_x (float): d
-00021c70: 6973 7461 6e63 6520 616c 6f6e 6720 7468  istance along th
-00021c80: 6520 782d 6178 6973 2028 696d 6167 6520  e x-axis (image 
-00021c90: 636f 6f72 6469 6e61 7465 7329 0a20 2020  coordinates).   
-00021ca0: 2020 2020 2052 6574 7572 6e73 3a0a 2020       Returns:.  
-00021cb0: 2020 2020 2020 2020 2020 4669 6273 656d            Fibsem
-00021cc0: 4d61 6e69 7075 6c61 746f 7250 6f73 6974  ManipulatorPosit
-00021cd0: 696f 6e3a 2078 2d63 6f72 7265 6374 6564  ion: x-corrected
-00021ce0: 206e 6565 646c 6520 6d6f 7665 6d65 6e74   needle movement
-00021cf0: 2028 7265 6c61 7469 7665 2070 6f73 6974   (relative posit
-00021d00: 696f 6e29 0a20 2020 2020 2020 2022 2222  ion).        """
-00021d10: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00021d20: 4669 6273 656d 4d61 6e69 7075 6c61 746f  FibsemManipulato
-00021d30: 7250 6f73 6974 696f 6e28 783d 6578 7065  rPosition(x=expe
-00021d40: 6374 6564 5f78 2c20 793d 302c 207a 3d30  cted_x, y=0, z=0
-00021d50: 2920 2023 206e 6f20 6164 6a75 7374 6d65  )  # no adjustme
-00021d60: 6e74 206e 6565 6465 640a 0a0a 2020 2020  nt needed...    
-00021d70: 6465 6620 5f79 5f63 6f72 7265 6374 6564  def _y_corrected
-00021d80: 5f6e 6565 646c 655f 6d6f 7665 6d65 6e74  _needle_movement
-00021d90: 2873 656c 662c 200a 2020 2020 2020 2020  (self, .        
-00021da0: 6578 7065 6374 6564 5f79 3a20 666c 6f61  expected_y: floa
-00021db0: 742c 2073 7461 6765 5f74 696c 743a 2066  t, stage_tilt: f
-00021dc0: 6c6f 6174 0a20 2020 2029 202d 3e20 4669  loat.    ) -> Fi
-00021dd0: 6273 656d 4d61 6e69 7075 6c61 746f 7250  bsemManipulatorP
-00021de0: 6f73 6974 696f 6e3a 0a20 2020 2020 2020  osition:.       
-00021df0: 2022 2222 4361 6c63 756c 6174 6520 7468   """Calculate th
-00021e00: 6520 636f 7272 6563 7465 6420 6e65 6564  e corrected need
-00021e10: 6c65 206d 6f76 656d 656e 7420 746f 206d  le movement to m
-00021e20: 6f76 6520 696e 2074 6865 2079 2d61 7869  ove in the y-axi
-00021e30: 732e 0a0a 2020 2020 2020 2020 4172 6773  s...        Args
-00021e40: 3a0a 2020 2020 2020 2020 2020 2020 6578  :.            ex
-00021e50: 7065 6374 6564 5f79 2028 666c 6f61 7429  pected_y (float)
-00021e60: 3a20 6469 7374 616e 6365 2061 6c6f 6e67  : distance along
-00021e70: 2074 6865 2079 2d61 7869 7320 2869 6d61   the y-axis (ima
-00021e80: 6765 2063 6f6f 7264 696e 6174 6573 290a  ge coordinates).
-00021e90: 2020 2020 2020 2020 2020 2020 7374 6167              stag
-00021ea0: 655f 7469 6c74 2028 666c 6f61 742c 206f  e_tilt (float, o
-00021eb0: 7074 696f 6e61 6c29 3a20 7374 6167 6520  ptional): stage 
-00021ec0: 7469 6c74 2e0a 0a20 2020 2020 2020 2052  tilt...        R
-00021ed0: 6574 7572 6e73 3a0a 2020 2020 2020 2020  eturns:.        
-00021ee0: 2020 2020 4669 6273 656d 4d61 6e69 7075      FibsemManipu
-00021ef0: 6c61 746f 7250 6f73 6974 696f 6e3a 2079  latorPosition: y
-00021f00: 2d63 6f72 7265 6374 6564 206e 6565 646c  -corrected needl
-00021f10: 6520 6d6f 7665 6d65 6e74 2028 7265 6c61  e movement (rela
-00021f20: 7469 7665 2070 6f73 6974 696f 6e29 0a20  tive position). 
-00021f30: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-00021f40: 2020 2079 5f6d 6f76 6520 3d20 2b6e 702e     y_move = +np.
-00021f50: 636f 7328 7374 6167 655f 7469 6c74 2920  cos(stage_tilt) 
-00021f60: 2a20 6578 7065 6374 6564 5f79 0a20 2020  * expected_y.   
-00021f70: 2020 2020 207a 5f6d 6f76 6520 3d20 2b6e       z_move = +n
-00021f80: 702e 7369 6e28 7374 6167 655f 7469 6c74  p.sin(stage_tilt
-00021f90: 2920 2a20 6578 7065 6374 6564 5f79 0a20  ) * expected_y. 
-00021fa0: 2020 2020 2020 2072 6574 7572 6e20 4669         return Fi
-00021fb0: 6273 656d 4d61 6e69 7075 6c61 746f 7250  bsemManipulatorP
-00021fc0: 6f73 6974 696f 6e28 783d 302c 2079 3d79  osition(x=0, y=y
-00021fd0: 5f6d 6f76 652c 207a 3d7a 5f6d 6f76 6529  _move, z=z_move)
-00021fe0: 0a0a 0a20 2020 2064 6566 205f 7a5f 636f  ...    def _z_co
-00021ff0: 7272 6563 7465 645f 6e65 6564 6c65 5f6d  rrected_needle_m
-00022000: 6f76 656d 656e 7428 7365 6c66 2c20 0a20  ovement(self, . 
-00022010: 2020 2020 2020 2065 7870 6563 7465 645f         expected_
-00022020: 7a3a 2066 6c6f 6174 2c20 7374 6167 655f  z: float, stage_
-00022030: 7469 6c74 3a20 666c 6f61 740a 2020 2020  tilt: float.    
-00022040: 2920 2d3e 2046 6962 7365 6d4d 616e 6970  ) -> FibsemManip
-00022050: 756c 6174 6f72 506f 7369 7469 6f6e 3a0a  ulatorPosition:.
-00022060: 2020 2020 2020 2020 2222 2243 616c 6375          """Calcu
-00022070: 6c61 7465 2074 6865 2063 6f72 7265 6374  late the correct
-00022080: 6564 206e 6565 646c 6520 6d6f 7665 6d65  ed needle moveme
-00022090: 6e74 2074 6f20 6d6f 7665 2069 6e20 7468  nt to move in th
-000220a0: 6520 7a2d 6178 6973 2e0a 0a20 2020 2020  e z-axis...     
-000220b0: 2020 2041 7267 733a 0a20 2020 2020 2020     Args:.       
-000220c0: 2020 2020 2065 7870 6563 7465 645f 7a20       expected_z 
-000220d0: 2866 6c6f 6174 293a 2064 6973 7461 6e63  (float): distanc
-000220e0: 6520 616c 6f6e 6720 7468 6520 7a2d 6178  e along the z-ax
-000220f0: 6973 2028 696d 6167 6520 636f 6f72 6469  is (image coordi
-00022100: 6e61 7465 7329 0a20 2020 2020 2020 2020  nates).         
-00022110: 2020 2073 7461 6765 5f74 696c 7420 2866     stage_tilt (f
-00022120: 6c6f 6174 2c20 6f70 7469 6f6e 616c 293a  loat, optional):
-00022130: 2073 7461 6765 2074 696c 742e 0a0a 2020   stage tilt...  
-00022140: 2020 2020 2020 5265 7475 726e 733a 0a20        Returns:. 
-00022150: 2020 2020 2020 2020 2020 2046 6962 7365             Fibse
-00022160: 6d4d 616e 6970 756c 6174 6f72 506f 7369  mManipulatorPosi
-00022170: 7469 6f6e 3a20 7a2d 636f 7272 6563 7465  tion: z-correcte
-00022180: 6420 6e65 6564 6c65 206d 6f76 656d 656e  d needle movemen
-00022190: 7420 2872 656c 6174 6976 6520 706f 7369  t (relative posi
-000221a0: 7469 6f6e 290a 2020 2020 2020 2020 2222  tion).        ""
-000221b0: 220a 2020 2020 2020 2020 795f 6d6f 7665  ".        y_move
-000221c0: 203d 202d 6e70 2e73 696e 2873 7461 6765   = -np.sin(stage
-000221d0: 5f74 696c 7429 202a 2065 7870 6563 7465  _tilt) * expecte
-000221e0: 645f 7a0a 2020 2020 2020 2020 7a5f 6d6f  d_z.        z_mo
-000221f0: 7665 203d 202b 6e70 2e63 6f73 2873 7461  ve = +np.cos(sta
-00022200: 6765 5f74 696c 7429 202a 2065 7870 6563  ge_tilt) * expec
-00022210: 7465 645f 7a0a 2020 2020 2020 2020 7265  ted_z.        re
-00022220: 7475 726e 2046 6962 7365 6d4d 616e 6970  turn FibsemManip
-00022230: 756c 6174 6f72 506f 7369 7469 6f6e 2878  ulatorPosition(x
-00022240: 3d30 2c20 793d 795f 6d6f 7665 2c20 7a3d  =0, y=y_move, z=
-00022250: 7a5f 6d6f 7665 290a 0a20 2020 2064 6566  z_move)..    def
-00022260: 206d 6f76 655f 6d61 6e69 7075 6c61 746f   move_manipulato
-00022270: 725f 636f 7272 6563 7465 6428 7365 6c66  r_corrected(self
-00022280: 2c20 0a20 2020 2020 2020 2064 783a 2066  , .        dx: f
-00022290: 6c6f 6174 203d 2030 2c0a 2020 2020 2020  loat = 0,.      
-000222a0: 2020 6479 3a20 666c 6f61 7420 3d20 302c    dy: float = 0,
-000222b0: 0a20 2020 2020 2020 2062 6561 6d5f 7479  .        beam_ty
-000222c0: 7065 3a20 4265 616d 5479 7065 203d 2042  pe: BeamType = B
-000222d0: 6561 6d54 7970 652e 454c 4543 5452 4f4e  eamType.ELECTRON
-000222e0: 2c0a 2020 2020 2920 2d3e 204e 6f6e 653a  ,.    ) -> None:
-000222f0: 0a20 2020 2020 2020 2022 2222 4361 6c63  .        """Calc
-00022300: 756c 6174 6520 7468 6520 7265 7175 6972  ulate the requir
-00022310: 6564 2063 6f72 7265 6374 6564 206e 6565  ed corrected nee
-00022320: 646c 6520 6d6f 7665 6d65 6e74 7320 6261  dle movements ba
-00022330: 7365 6420 6f6e 2074 6865 2042 6561 6d54  sed on the BeamT
-00022340: 7970 6520 746f 206d 6f76 6520 696e 2074  ype to move in t
-00022350: 6865 2064 6573 6972 6564 2069 6d61 6765  he desired image
-00022360: 2063 6f6f 7264 696e 6174 6573 2e0a 2020   coordinates..  
-00022370: 2020 2020 2020 5468 656e 206d 6f76 6520        Then move 
-00022380: 7468 6520 6e65 6564 6c65 2072 656c 6174  the needle relat
-00022390: 6976 656c 792e 0a0a 2020 2020 2020 2020  ively...        
-000223a0: 4265 616d 5479 7065 2e45 4c45 4354 524f  BeamType.ELECTRO
-000223b0: 4e3a 2020 6d6f 7665 2069 6e20 782c 2079  N:  move in x, y
-000223c0: 2028 7261 7720 636f 6f72 6469 6e61 7465   (raw coordinate
-000223d0: 7329 0a20 2020 2020 2020 2042 6561 6d54  s).        BeamT
-000223e0: 7970 652e 494f 4e3a 2020 2020 2020 206d  ype.ION:       m
-000223f0: 6f76 6520 696e 2078 2c20 7a20 2872 6177  ove in x, z (raw
-00022400: 2063 6f6f 7264 696e 6174 6573 290a 0a20   coordinates).. 
-00022410: 2020 2020 2020 2041 7267 733a 0a20 2020         Args:.   
-00022420: 2020 2020 2020 2020 206d 6963 726f 7363           microsc
-00022430: 6f70 6520 2853 6462 4d69 6372 6f73 636f  ope (SdbMicrosco
-00022440: 7065 436c 6965 6e74 293a 2061 7574 6f53  peClient): autoS
-00022450: 6372 6970 7420 6d69 6372 6f73 636f 7065  cript microscope
-00022460: 2069 6e73 7461 6e63 650a 2020 2020 2020   instance.      
-00022470: 2020 2020 2020 6478 2028 666c 6f61 7429        dx (float)
-00022480: 3a20 6469 7374 616e 6365 2061 6c6f 6e67  : distance along
-00022490: 2074 6865 2078 2d61 7869 7320 2869 6d61   the x-axis (ima
-000224a0: 6765 2063 6f6f 7264 696e 6174 6573 290a  ge coordinates).
-000224b0: 2020 2020 2020 2020 2020 2020 6479 2028              dy (
-000224c0: 666c 6f61 7429 3a20 6469 7374 616e 6365  float): distance
-000224d0: 2061 6c6f 6e67 2074 6865 2079 2d61 7869   along the y-axi
-000224e0: 7320 2869 6d61 6765 2063 6f72 6f64 696e  s (image corodin
-000224f0: 6174 6573 290a 2020 2020 2020 2020 2020  ates).          
-00022500: 2020 6265 616d 5f74 7970 6520 2842 6561    beam_type (Bea
-00022510: 6d54 7970 652c 206f 7074 696f 6e61 6c29  mType, optional)
-00022520: 3a20 7468 6520 6265 616d 2074 7970 6520  : the beam type 
-00022530: 746f 206d 6f76 6520 696e 2e20 4465 6661  to move in. Defa
-00022540: 756c 7473 2074 6f20 4265 616d 5479 7065  ults to BeamType
-00022550: 2e45 4c45 4354 524f 4e2e 0a20 2020 2020  .ELECTRON..     
-00022560: 2020 2022 2222 0a20 2020 2020 2020 205f     """.        _
-00022570: 6368 6563 6b5f 6e65 6564 6c65 2873 656c  check_needle(sel
-00022580: 662e 6861 7264 7761 7265 5f73 6574 7469  f.hardware_setti
-00022590: 6e67 7329 0a0a 2020 2020 2020 2020 6966  ngs)..        if
-000225a0: 2073 656c 662e 636f 6e6e 6563 7469 6f6e   self.connection
-000225b0: 2e4e 616e 6f6d 616e 6970 756c 6174 6f72  .Nanomanipulator
-000225c0: 2e49 7343 616c 6962 7261 7465 6428 3029  .IsCalibrated(0)
-000225d0: 203d 3d20 4661 6c73 653a 0a20 2020 2020   == False:.     
-000225e0: 2020 2020 2020 206c 6f67 6769 6e67 2e69         logging.i
-000225f0: 6e66 6f28 2243 616c 6962 7261 7469 6e67  nfo("Calibrating
-00022600: 206d 616e 6970 756c 6174 6f72 2229 0a20   manipulator"). 
-00022610: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00022620: 636f 6e6e 6563 7469 6f6e 2e4e 616e 6f6d  connection.Nanom
-00022630: 616e 6970 756c 6174 6f72 2e43 616c 6962  anipulator.Calib
-00022640: 7261 7465 2830 290a 2020 2020 2020 2020  rate(0).        
-00022650: 7374 6167 655f 7469 6c74 203d 2073 656c  stage_tilt = sel
-00022660: 662e 6765 745f 7374 6167 655f 706f 7369  f.get_stage_posi
-00022670: 7469 6f6e 2829 2e74 0a0a 0a20 2020 2020  tion().t...     
-00022680: 2020 2023 2023 2078 790a 2020 2020 2020     # # xy.      
-00022690: 2020 2320 6966 2062 6561 6d5f 7479 7065    # if beam_type
-000226a0: 2069 7320 4265 616d 5479 7065 2e45 4c45   is BeamType.ELE
-000226b0: 4354 524f 4e3a 0a20 2020 2020 2020 2023  CTRON:.        #
-000226c0: 2020 2020 2078 5f6d 6f76 6520 3d20 7365       x_move = se
-000226d0: 6c66 2e5f 785f 636f 7272 6563 7465 645f  lf._x_corrected_
-000226e0: 6e65 6564 6c65 5f6d 6f76 656d 656e 7428  needle_movement(
-000226f0: 6578 7065 6374 6564 5f78 3d64 7829 0a20  expected_x=dx). 
-00022700: 2020 2020 2020 2023 2020 2020 2079 7a5f         #     yz_
-00022710: 6d6f 7665 203d 2073 656c 662e 5f79 5f63  move = self._y_c
-00022720: 6f72 7265 6374 6564 5f6e 6565 646c 655f  orrected_needle_
-00022730: 6d6f 7665 6d65 6e74 2864 792c 2073 7461  movement(dy, sta
-00022740: 6765 5f74 696c 743d 7374 6167 655f 7469  ge_tilt=stage_ti
-00022750: 6c74 290a 0a20 2020 2020 2020 2023 2023  lt)..        # #
-00022760: 2078 7a2c 0a20 2020 2020 2020 2023 2069   xz,.        # i
-00022770: 6620 6265 616d 5f74 7970 6520 6973 2042  f beam_type is B
-00022780: 6561 6d54 7970 652e 494f 4e3a 0a0a 2020  eamType.ION:..  
-00022790: 2020 2020 2020 2320 2020 2020 785f 6d6f        #     x_mo
-000227a0: 7665 203d 2073 656c 662e 5f78 5f63 6f72  ve = self._x_cor
-000227b0: 7265 6374 6564 5f6e 6565 646c 655f 6d6f  rected_needle_mo
-000227c0: 7665 6d65 6e74 2865 7870 6563 7465 645f  vement(expected_
-000227d0: 783d 6478 290a 2020 2020 2020 2020 2320  x=dx).        # 
-000227e0: 2020 2020 797a 5f6d 6f76 6520 3d20 7365      yz_move = se
-000227f0: 6c66 2e5f 7a5f 636f 7272 6563 7465 645f  lf._z_corrected_
-00022800: 6e65 6564 6c65 5f6d 6f76 656d 656e 7428  needle_movement(
-00022810: 6578 7065 6374 6564 5f7a 3d64 792c 2073  expected_z=dy, s
-00022820: 7461 6765 5f74 696c 743d 7374 6167 655f  tage_tilt=stage_
-00022830: 7469 6c74 290a 0a20 2020 2020 2020 2023  tilt)..        #
-00022840: 206d 6f76 6520 6e65 6564 6c65 2028 7265   move needle (re
-00022850: 6c61 7469 7665 290a 2020 2020 2020 2020  lative).        
-00022860: 2373 656c 662e 636f 6e6e 6563 7469 6f6e  #self.connection
-00022870: 2e4e 616e 6f6d 616e 6970 756c 6174 6f72  .Nanomanipulator
-00022880: 2e4d 6f76 6554 6f28 496e 6465 783d 302c  .MoveTo(Index=0,
-00022890: 2058 3d78 5f6d 6f76 652e 782c 2059 3d79   X=x_move.x, Y=y
-000228a0: 7a5f 6d6f 7665 2e79 2c20 5a3d 797a 5f6d  z_move.y, Z=yz_m
-000228b0: 6f76 652e 7a29 0a20 2020 2020 2020 2073  ove.z).        s
-000228c0: 656c 662e 6d6f 7665 5f6d 616e 6970 756c  elf.move_manipul
-000228d0: 6174 6f72 5f72 656c 6174 6976 6528 4669  ator_relative(Fi
-000228e0: 6273 656d 4d61 6e69 7075 6c61 746f 7250  bsemManipulatorP
-000228f0: 6f73 6974 696f 6e28 783d 6478 2c20 793d  osition(x=dx, y=
-00022900: 6479 2c20 7a3d 3029 290a 0a20 2020 2020  dy, z=0))..     
-00022910: 2020 2072 6574 7572 6e0a 0a20 2020 2064     return..    d
-00022920: 6566 206d 6f76 655f 6d61 6e69 7075 6c61  ef move_manipula
-00022930: 746f 725f 746f 5f70 6f73 6974 696f 6e5f  tor_to_position_
-00022940: 6f66 6673 6574 2873 656c 662c 206f 6666  offset(self, off
-00022950: 7365 743a 2046 6962 7365 6d4d 616e 6970  set: FibsemManip
-00022960: 756c 6174 6f72 506f 7369 7469 6f6e 2c20  ulatorPosition, 
-00022970: 6e61 6d65 3a20 7374 7220 3d20 4e6f 6e65  name: str = None
-00022980: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
-00022990: 2020 2069 6620 6e6f 7420 6e70 2e69 7363     if not np.isc
-000229a0: 6c6f 7365 286f 6666 7365 742e 722c 2030  lose(offset.r, 0
-000229b0: 2e30 293a 0a20 2020 2020 2020 2020 2020  .0):.           
-000229c0: 2072 6f74 6174 696f 6e20 3d20 5472 7565   rotation = True
-000229d0: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
-000229e0: 2020 2020 2020 2020 2020 2072 6f74 6174             rotat
-000229f0: 696f 6e20 3d20 4661 6c73 650a 2020 2020  ion = False.    
-00022a00: 2020 2020 6966 206e 6f74 206e 702e 6973      if not np.is
-00022a10: 636c 6f73 6528 6f66 6673 6574 2e74 2c20  close(offset.t, 
-00022a20: 302e 3029 3a0a 2020 2020 2020 2020 2020  0.0):.          
-00022a30: 2020 7469 6c74 203d 2054 7275 650a 2020    tilt = True.  
-00022a40: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00022a50: 2020 2020 2020 2020 7469 6c74 203d 2046          tilt = F
-00022a60: 616c 7365 0a20 2020 2020 2020 205f 6368  alse.        _ch
-00022a70: 6563 6b5f 6e65 6564 6c65 2873 656c 662e  eck_needle(self.
-00022a80: 6861 7264 7761 7265 5f73 6574 7469 6e67  hardware_setting
-00022a90: 732c 2072 6f74 6174 696f 6e2c 2074 696c  s, rotation, til
-00022aa0: 7429 0a20 2020 2020 2020 206c 6f67 6769  t).        loggi
-00022ab0: 6e67 2e77 6172 6e69 6e67 2822 4e6f 7420  ng.warning("Not 
-00022ac0: 7375 7070 6f72 7465 6420 6279 2054 4553  supported by TES
-00022ad0: 4341 4e20 4150 4922 290a 2020 2020 2020  CAN API").      
-00022ae0: 2020 2320 7261 6973 6520 4e6f 7449 6d70    # raise NotImp
-00022af0: 6c65 6d65 6e74 6564 4572 726f 7228 224e  lementedError("N
-00022b00: 6f74 2073 7570 706f 7274 6564 2062 7920  ot supported by 
-00022b10: 5445 5343 414e 2041 5049 2229 0a20 2020  TESCAN API").   
-00022b20: 2020 2020 2070 6173 730a 0a20 2020 2064       pass..    d
-00022b30: 6566 205f 6765 745f 7361 7665 645f 6d61  ef _get_saved_ma
-00022b40: 6e69 7075 6c61 746f 725f 706f 7369 7469  nipulator_positi
-00022b50: 6f6e 2873 656c 6629 3a0a 2020 2020 2020  on(self):.      
-00022b60: 2020 5f63 6865 636b 5f6e 6565 646c 6528    _check_needle(
-00022b70: 7365 6c66 2e68 6172 6477 6172 655f 7365  self.hardware_se
-00022b80: 7474 696e 6773 290a 2020 2020 2020 2020  ttings).        
-00022b90: 7061 7373 0a0a 2020 2020 6465 6620 7365  pass..    def se
-00022ba0: 7475 705f 6d69 6c6c 696e 6728 0a20 2020  tup_milling(.   
-00022bb0: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
-00022bc0: 2020 206d 696c 6c5f 7365 7474 696e 6773     mill_settings
-00022bd0: 3a20 4669 6273 656d 4d69 6c6c 696e 6753  : FibsemMillingS
-00022be0: 6574 7469 6e67 732c 0a20 2020 2029 3a0a  ettings,.    ):.
-00022bf0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-00022c00: 2020 2020 436f 6e66 6967 7572 6520 7468      Configure th
-00022c10: 6520 6d69 6372 6f73 636f 7065 2066 6f72  e microscope for
-00022c20: 206d 696c 6c69 6e67 2075 7369 6e67 2074   milling using t
-00022c30: 6865 2069 6f6e 2062 6561 6d2e 0a0a 2020  he ion beam...  
-00022c40: 2020 2020 2020 4172 6773 3a0a 2020 2020        Args:.    
-00022c50: 2020 2020 2020 2020 6170 706c 6963 6174          applicat
-00022c60: 696f 6e5f 6669 6c65 2028 7374 7229 3a20  ion_file (str): 
-00022c70: 5061 7468 2074 6f20 7468 6520 6d69 6c6c  Path to the mill
-00022c80: 696e 6720 6170 706c 6963 6174 696f 6e20  ing application 
-00022c90: 6669 6c65 2e0a 2020 2020 2020 2020 2020  file..          
-00022ca0: 2020 7061 7474 6572 6e69 6e67 5f6d 6f64    patterning_mod
-00022cb0: 6520 2873 7472 293a 2050 6174 7465 726e  e (str): Pattern
-00022cc0: 696e 6720 6d6f 6465 2074 6f20 7573 652e  ing mode to use.
-00022cd0: 0a20 2020 2020 2020 2020 2020 2068 6677  .            hfw
-00022ce0: 2028 666c 6f61 7429 3a20 4465 7369 7265   (float): Desire
-00022cf0: 6420 686f 7269 7a6f 6e74 616c 2066 6965  d horizontal fie
-00022d00: 6c64 2077 6964 7468 2069 6e20 6d65 7465  ld width in mete
-00022d10: 7273 2e0a 2020 2020 2020 2020 2020 2020  rs..            
-00022d20: 6d69 6c6c 5f73 6574 7469 6e67 7320 2846  mill_settings (F
-00022d30: 6962 7365 6d4d 696c 6c69 6e67 5365 7474  ibsemMillingSett
-00022d40: 696e 6773 293a 204d 696c 6c69 6e67 2073  ings): Milling s
-00022d50: 6574 7469 6e67 732e 0a0a 2020 2020 2020  ettings...      
-00022d60: 2020 5265 7475 726e 733a 0a20 2020 2020    Returns:.     
-00022d70: 2020 2020 2020 204e 6f6e 652e 0a0a 2020         None...  
-00022d80: 2020 2020 2020 5261 6973 6573 3a0a 2020        Raises:.  
-00022d90: 2020 2020 2020 2020 2020 4e6f 7449 6d70            NotImp
-00022da0: 6c65 6d65 6e74 6564 4572 726f 723a 2049  lementedError: I
-00022db0: 6620 7468 6520 7370 6563 6966 6965 6420  f the specified 
-00022dc0: 7061 7474 6572 6e69 6e67 206d 6f64 6520  patterning mode 
-00022dd0: 6973 206e 6f74 2073 7570 706f 7274 6564  is not supported
-00022de0: 2e0a 0a20 2020 2020 2020 204e 6f74 653a  ...        Note:
-00022df0: 0a20 2020 2020 2020 2020 2020 2054 6869  .            Thi
-00022e00: 7320 6d65 7468 6f64 2073 6574 7320 7570  s method sets up
-00022e10: 2074 6865 206d 6963 726f 7363 6f70 6520   the microscope 
-00022e20: 696d 6167 696e 6720 616e 6420 7061 7474  imaging and patt
-00022e30: 6572 6e69 6e67 2066 6f72 206d 696c 6c69  erning for milli
-00022e40: 6e67 2075 7369 6e67 2074 6865 2069 6f6e  ng using the ion
-00022e50: 2062 6561 6d2e 0a20 2020 2020 2020 2020   beam..         
-00022e60: 2020 2049 7420 7365 7473 2074 6865 2061     It sets the a
-00022e70: 6374 6976 6520 7669 6577 2061 6e64 2064  ctive view and d
-00022e80: 6576 6963 6520 746f 2074 6865 2069 6f6e  evice to the ion
-00022e90: 2062 6561 6d2c 2074 6865 2064 6566 6175   beam, the defau
-00022ea0: 6c74 2062 6561 6d20 7479 7065 2074 6f20  lt beam type to 
-00022eb0: 7468 6520 696f 6e20 6265 616d 2c0a 2020  the ion beam,.  
-00022ec0: 2020 2020 2020 2020 2020 7468 6520 7370            the sp
-00022ed0: 6563 6966 6965 6420 6170 706c 6963 6174  ecified applicat
-00022ee0: 696f 6e20 6669 6c65 2c20 616e 6420 7468  ion file, and th
-00022ef0: 6520 7370 6563 6966 6965 6420 7061 7474  e specified patt
-00022f00: 6572 6e69 6e67 206d 6f64 652e 0a20 2020  erning mode..   
-00022f10: 2020 2020 2020 2020 2049 7420 616c 736f           It also
-00022f20: 2063 6c65 6172 7320 616e 7920 6578 6973   clears any exis
-00022f30: 7469 6e67 2070 6174 7465 726e 7320 616e  ting patterns an
-00022f40: 6420 7365 7473 2074 6865 2068 6f72 697a  d sets the horiz
-00022f50: 6f6e 7461 6c20 6669 656c 6420 7769 6474  ontal field widt
-00022f60: 6820 746f 2074 6865 2064 6573 6972 6564  h to the desired
-00022f70: 2076 616c 7565 2e0a 2020 2020 2020 2020   value..        
-00022f80: 2020 2020 5468 6520 6d65 7468 6f64 2064      The method d
-00022f90: 6f65 7320 6e6f 7420 7374 6172 7420 7468  oes not start th
-00022fa0: 6520 6d69 6c6c 696e 6720 7072 6f63 6573  e milling proces
-00022fb0: 732e 0a20 2020 2020 2020 2022 2222 0a20  s..        """. 
-00022fc0: 2020 2020 2020 205f 6368 6563 6b5f 6265         _check_be
-00022fd0: 616d 2842 6561 6d54 7970 652e 494f 4e2c  am(BeamType.ION,
-00022fe0: 2073 656c 662e 6861 7264 7761 7265 5f73   self.hardware_s
-00022ff0: 6574 7469 6e67 7329 0a0a 2020 2020 2020  ettings)..      
-00023000: 2020 7370 6f74 5f73 697a 6520 3d20 6d69    spot_size = mi
-00023010: 6c6c 5f73 6574 7469 6e67 732e 7370 6f74  ll_settings.spot
-00023020: 5f73 697a 6520 2023 2061 7070 6c69 6361  _size  # applica
-00023030: 7469 6f6e 5f66 696c 650a 2020 2020 2020  tion_file.      
-00023040: 2020 7261 7465 203d 206d 696c 6c5f 7365    rate = mill_se
-00023050: 7474 696e 6773 2e72 6174 6520 2023 2320  ttings.rate  ## 
-00023060: 696e 2061 7070 6c69 6361 7469 6f6e 2066  in application f
-00023070: 696c 6520 6361 6c6c 6564 2056 6f6c 756d  ile called Volum
-00023080: 6520 7065 7220 446f 7365 2028 6d33 2f43  e per Dose (m3/C
-00023090: 290a 2020 2020 2020 2020 6477 656c 6c5f  ).        dwell_
-000230a0: 7469 6d65 203d 206d 696c 6c5f 7365 7474  time = mill_sett
-000230b0: 696e 6773 2e64 7765 6c6c 5f74 696d 6520  ings.dwell_time 
-000230c0: 2023 2069 6e20 7365 636f 6e64 7320 2323   # in seconds ##
-000230d0: 2069 6e20 6170 706c 6963 6174 696f 6e20   in application 
-000230e0: 6669 6c65 0a0a 2020 2020 2020 2020 6966  file..        if
-000230f0: 206d 696c 6c5f 7365 7474 696e 6773 2e70   mill_settings.p
-00023100: 6174 7465 726e 696e 675f 6d6f 6465 203d  atterning_mode =
-00023110: 3d20 2253 6572 6961 6c22 3a0a 2020 2020  = "Serial":.    
-00023120: 2020 2020 2020 2020 7061 7261 6c6c 656c          parallel
-00023130: 5f6d 6f64 6520 3d20 4661 6c73 650a 2020  _mode = False.  
-00023140: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00023150: 2020 2020 2020 2020 7061 7261 6c6c 656c          parallel
-00023160: 5f6d 6f64 6520 3d20 5472 7565 0a0a 2020  _mode = True..  
-00023170: 2020 2020 2020 7072 696e 7428 6622 7370        print(f"sp
-00023180: 6163 696e 673a 207b 6d69 6c6c 5f73 6574  acing: {mill_set
-00023190: 7469 6e67 732e 7370 6163 696e 677d 2229  tings.spacing}")
-000231a0: 0a0a 2020 2020 2020 2020 7365 6c66 2e73  ..        self.s
-000231b0: 6574 2822 7072 6573 6574 222c 206d 696c  et("preset", mil
-000231c0: 6c5f 7365 7474 696e 6773 2e70 7265 7365  l_settings.prese
-000231d0: 742c 2042 6561 6d54 7970 652e 494f 4e29  t, BeamType.ION)
-000231e0: 0a20 2020 2020 2020 2062 6561 6d5f 6375  .        beam_cu
-000231f0: 7272 656e 7420 3d20 7365 6c66 2e63 6f6e  rrent = self.con
-00023200: 6e65 6374 696f 6e2e 4649 422e 4265 616d  nection.FIB.Beam
-00023210: 2e52 6561 6450 726f 6265 4375 7272 656e  .ReadProbeCurren
-00023220: 7428 290a 2020 2020 2020 2020 7072 696e  t().        prin
-00023230: 7428 6622 6265 616d 5f63 7572 7265 6e74  t(f"beam_current
-00023240: 3a20 7b62 6561 6d5f 6375 7272 656e 747d  : {beam_current}
-00023250: 2229 0a20 2020 2020 2020 206c 6179 6572  ").        layer
-00023260: 5f73 6574 7469 6e67 7320 3d20 4945 7463  _settings = IEtc
-00023270: 6869 6e67 280a 2020 2020 2020 2020 2020  hing(.          
-00023280: 2020 7379 6e63 5772 6974 6546 6965 6c64    syncWriteField
-00023290: 3d46 616c 7365 2c0a 2020 2020 2020 2020  =False,.        
-000232a0: 2020 2020 7772 6974 6546 6965 6c64 5369      writeFieldSi
-000232b0: 7a65 3d6d 696c 6c5f 7365 7474 696e 6773  ze=mill_settings
-000232c0: 2e68 6677 2c0a 2020 2020 2020 2020 2020  .hfw,.          
-000232d0: 2020 6265 616d 4375 7272 656e 743d 6265    beamCurrent=be
-000232e0: 616d 5f63 7572 7265 6e74 2c0a 2020 2020  am_current,.    
-000232f0: 2020 2020 2020 2020 7370 6f74 5369 7a65          spotSize
-00023300: 3d73 706f 745f 7369 7a65 2c0a 2020 2020  =spot_size,.    
-00023310: 2020 2020 2020 2020 7261 7465 3d72 6174          rate=rat
-00023320: 652c 0a20 2020 2020 2020 2020 2020 2064  e,.            d
-00023330: 7765 6c6c 5469 6d65 3d64 7765 6c6c 5f74  wellTime=dwell_t
-00023340: 696d 652c 0a20 2020 2020 2020 2020 2020  ime,.           
-00023350: 2070 6172 616c 6c65 6c3d 7061 7261 6c6c   parallel=parall
-00023360: 656c 5f6d 6f64 652c 0a20 2020 2020 2020  el_mode,.       
-00023370: 2020 2020 2070 7265 7365 7420 3d20 6d69       preset = mi
-00023380: 6c6c 5f73 6574 7469 6e67 732e 7072 6573  ll_settings.pres
-00023390: 6574 2c0a 2020 2020 2020 2020 2020 2020  et,.            
-000233a0: 7370 6163 696e 6720 3d20 6d69 6c6c 5f73  spacing = mill_s
-000233b0: 6574 7469 6e67 732e 7370 6163 696e 672c  ettings.spacing,
-000233c0: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
-000233d0: 2020 2020 7365 6c66 2e6c 6179 6572 203d      self.layer =
-000233e0: 2073 656c 662e 636f 6e6e 6563 7469 6f6e   self.connection
-000233f0: 2e44 7261 7742 6561 6d2e 4c61 7965 7228  .DrawBeam.Layer(
-00023400: 224c 6179 6572 3122 2c20 6c61 7965 725f  "Layer1", layer_
-00023410: 7365 7474 696e 6773 290a 2020 2020 2020  settings).      
-00023420: 2020 0a0a 2020 2020 6465 6620 7275 6e5f    ..    def run_
-00023430: 6d69 6c6c 696e 6728 7365 6c66 2c20 6d69  milling(self, mi
-00023440: 6c6c 696e 675f 6375 7272 656e 743a 2066  lling_current: f
-00023450: 6c6f 6174 2c20 6173 796e 6368 3a20 626f  loat, asynch: bo
-00023460: 6f6c 203d 2046 616c 7365 293a 0a20 2020  ol = False):.   
-00023470: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-00023480: 2052 756e 7320 7468 6520 696f 6e20 6265   Runs the ion be
-00023490: 616d 206d 696c 6c69 6e67 2070 726f 6365  am milling proce
-000234a0: 7373 2075 7369 6e67 2074 6865 2073 7065  ss using the spe
-000234b0: 6369 6669 6564 206d 696c 6c69 6e67 2063  cified milling c
-000234c0: 7572 7265 6e74 2e0a 0a20 2020 2020 2020  urrent...       
-000234d0: 2041 7267 733a 0a20 2020 2020 2020 2020   Args:.         
-000234e0: 2020 206d 696c 6c69 6e67 5f63 7572 7265     milling_curre
-000234f0: 6e74 2028 666c 6f61 7429 3a20 5468 6520  nt (float): The 
-00023500: 6d69 6c6c 696e 6720 6375 7272 656e 7420  milling current 
-00023510: 746f 2075 7365 2c20 696e 2061 6d70 732e  to use, in amps.
-00023520: 0a20 2020 2020 2020 2020 2020 2061 7379  .            asy
-00023530: 6e63 6820 2862 6f6f 6c2c 206f 7074 696f  nch (bool, optio
-00023540: 6e61 6c29 3a20 5768 6574 6865 7220 746f  nal): Whether to
-00023550: 2072 756e 2074 6865 206d 696c 6c69 6e67   run the milling
-00023560: 2061 7379 6e63 6872 6f6e 6f75 736c 792e   asynchronously.
-00023570: 2044 6566 6175 6c74 7320 746f 2046 616c   Defaults to Fal
-00023580: 7365 2e0a 0a20 2020 2020 2020 2052 6574  se...        Ret
-00023590: 7572 6e73 3a0a 2020 2020 2020 2020 2020  urns:.          
-000235a0: 2020 4e6f 6e65 0a20 2020 2020 2020 2022    None.        "
-000235b0: 2222 0a20 2020 2020 2020 205f 6368 6563  "".        _chec
-000235c0: 6b5f 6265 616d 2842 6561 6d54 7970 652e  k_beam(BeamType.
-000235d0: 494f 4e2c 2073 656c 662e 6861 7264 7761  ION, self.hardwa
-000235e0: 7265 5f73 6574 7469 6e67 7329 0a20 2020  re_settings).   
-000235f0: 2020 2020 2073 7461 7475 7320 3d20 7365       status = se
-00023600: 6c66 2e63 6f6e 6e65 6374 696f 6e2e 4649  lf.connection.FI
-00023610: 422e 4265 616d 2e47 6574 5374 6174 7573  B.Beam.GetStatus
-00023620: 2829 0a20 2020 2020 2020 2069 6620 7374  ().        if st
-00023630: 6174 7573 2021 3d20 4175 746f 6d61 7469  atus != Automati
-00023640: 6f6e 2e46 4942 2e42 6561 6d2e 5374 6174  on.FIB.Beam.Stat
-00023650: 7573 2e42 6561 6d4f 6e3a 0a20 2020 2020  us.BeamOn:.     
-00023660: 2020 2020 2020 2073 656c 662e 636f 6e6e         self.conn
-00023670: 6563 7469 6f6e 2e46 4942 2e42 6561 6d2e  ection.FIB.Beam.
-00023680: 4f6e 2829 0a20 2020 2020 2020 2073 656c  On().        sel
-00023690: 662e 636f 6e6e 6563 7469 6f6e 2e44 7261  f.connection.Dra
-000236a0: 7742 6561 6d2e 4c6f 6164 4c61 7965 7228  wBeam.LoadLayer(
-000236b0: 7365 6c66 2e6c 6179 6572 290a 2020 2020  self.layer).    
-000236c0: 2020 2020 6c6f 6767 696e 672e 696e 666f      logging.info
-000236d0: 2866 2272 756e 6e69 6e67 2069 6f6e 2062  (f"running ion b
-000236e0: 6561 6d20 6d69 6c6c 696e 6720 6e6f 772e  eam milling now.
-000236f0: 2e2e 2229 0a20 2020 2020 2020 2073 656c  ..").        sel
-00023700: 662e 636f 6e6e 6563 7469 6f6e 2e44 7261  f.connection.Dra
-00023710: 7742 6561 6d2e 5374 6172 7428 290a 2020  wBeam.Start().  
-00023720: 2020 2020 2020 7365 6c66 2e63 6f6e 6e65        self.conne
-00023730: 6374 696f 6e2e 5072 6f67 7265 7373 2e53  ction.Progress.S
-00023740: 686f 7728 0a20 2020 2020 2020 2020 2020  how(.           
-00023750: 2022 4472 6177 4265 616d 222c 2022 4c61   "DrawBeam", "La
-00023760: 7965 7220 3120 696e 2070 726f 6772 6573  yer 1 in progres
-00023770: 7322 2c20 4661 6c73 652c 2046 616c 7365  s", False, False
-00023780: 2c20 302c 2031 3030 0a20 2020 2020 2020  , 0, 100.       
-00023790: 2029 0a20 2020 2020 2020 2077 6869 6c65   ).        while
-000237a0: 2054 7275 653a 0a20 2020 2020 2020 2020   True:.         
-000237b0: 2020 2073 7461 7475 7320 3d20 7365 6c66     status = self
-000237c0: 2e63 6f6e 6e65 6374 696f 6e2e 4472 6177  .connection.Draw
-000237d0: 4265 616d 2e47 6574 5374 6174 7573 2829  Beam.GetStatus()
-000237e0: 0a20 2020 2020 2020 2020 2020 2072 756e  .            run
-000237f0: 6e69 6e67 203d 2073 7461 7475 735b 305d  ning = status[0]
-00023800: 203d 3d20 4442 5374 6174 7573 2e50 726f   == DBStatus.Pro
-00023810: 6a65 6374 4c6f 6164 6564 4578 706f 7369  jectLoadedExposi
-00023820: 7469 6f6e 496e 5072 6f67 7265 7373 0a20  tionInProgress. 
-00023830: 2020 2020 2020 2020 2020 2069 6620 7275             if ru
-00023840: 6e6e 696e 673a 0a20 2020 2020 2020 2020  nning:.         
-00023850: 2020 2020 2020 2070 726f 6772 6573 7320         progress 
-00023860: 3d20 300a 2020 2020 2020 2020 2020 2020  = 0.            
-00023870: 2020 2020 6966 2073 7461 7475 735b 315d      if status[1]
-00023880: 203e 2030 3a0a 2020 2020 2020 2020 2020   > 0:.          
-00023890: 2020 2020 2020 2020 2020 7072 6f67 7265            progre
-000238a0: 7373 203d 206d 696e 2831 3030 2c20 7374  ss = min(100, st
-000238b0: 6174 7573 5b32 5d20 2f20 7374 6174 7573  atus[2] / status
-000238c0: 5b31 5d20 2a20 3130 3029 0a20 2020 2020  [1] * 100).     
-000238d0: 2020 2020 2020 2020 2020 2070 7269 6e74             print
-000238e0: 5072 6f67 7265 7373 4261 7228 7072 6f67  ProgressBar(prog
-000238f0: 7265 7373 2c20 3130 3029 0a20 2020 2020  ress, 100).     
-00023900: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00023910: 636f 6e6e 6563 7469 6f6e 2e50 726f 6772  connection.Progr
-00023920: 6573 732e 5365 7450 6572 6365 6e74 7328  ess.SetPercents(
-00023930: 7072 6f67 7265 7373 290a 2020 2020 2020  progress).      
-00023940: 2020 2020 2020 2020 2020 7469 6d65 2e73            time.s
-00023950: 6c65 6570 2831 290a 2020 2020 2020 2020  leep(1).        
-00023960: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00023970: 2020 2020 2020 2020 2020 6966 2073 7461            if sta
-00023980: 7475 735b 305d 203d 3d20 4442 5374 6174  tus[0] == DBStat
-00023990: 7573 2e50 726f 6a65 6374 4c6f 6164 6564  us.ProjectLoaded
-000239a0: 4578 706f 7369 7469 6f6e 4964 6c65 3a0a  ExpositionIdle:.
-000239b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000239c0: 2020 2020 7072 696e 7450 726f 6772 6573      printProgres
-000239d0: 7342 6172 2831 3030 2c20 3130 302c 2073  sBar(100, 100, s
-000239e0: 7566 6669 783d 2246 696e 6973 6865 6422  uffix="Finished"
-000239f0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00023a00: 2020 6272 6561 6b0a 0a20 2020 2020 2020    break..       
-00023a10: 2070 7269 6e74 2829 2020 2320 6e65 7720   print()  # new 
-00023a20: 6c69 6e65 206f 6e20 636f 6d70 6c65 7465  line on complete
-00023a30: 0a20 2020 2020 2020 2073 656c 662e 636f  .        self.co
-00023a40: 6e6e 6563 7469 6f6e 2e50 726f 6772 6573  nnection.Progres
-00023a50: 732e 4869 6465 2829 0a0a 2020 2020 6465  s.Hide()..    de
-00023a60: 6620 7275 6e5f 6d69 6c6c 696e 675f 6472  f run_milling_dr
-00023a70: 6966 745f 636f 7272 6563 7465 6428 7365  ift_corrected(se
-00023a80: 6c66 2c20 6d69 6c6c 696e 675f 6375 7272  lf, milling_curr
-00023a90: 656e 743a 2066 6c6f 6174 2c20 200a 2020  ent: float,  .  
-00023aa0: 2020 2020 2020 696d 6167 655f 7365 7474        image_sett
-00023ab0: 696e 6773 3a20 496d 6167 6553 6574 7469  ings: ImageSetti
-00023ac0: 6e67 732c 200a 2020 2020 2020 2020 7265  ngs, .        re
-00023ad0: 665f 696d 6167 653a 2046 6962 7365 6d49  f_image: FibsemI
-00023ae0: 6d61 6765 2c20 0a20 2020 2020 2020 2072  mage, .        r
-00023af0: 6564 7563 6564 5f61 7265 613a 2046 6962  educed_area: Fib
-00023b00: 7365 6d52 6563 7461 6e67 6c65 203d 204e  semRectangle = N
-00023b10: 6f6e 652c 0a20 2020 2020 2020 2061 7379  one,.        asy
-00023b20: 6e63 683a 2062 6f6f 6c20 3d20 4661 6c73  nch: bool = Fals
-00023b30: 650a 2020 2020 2020 2020 293a 0a20 2020  e.        ):.   
-00023b40: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-00023b50: 2052 756e 2069 6f6e 2062 6561 6d20 6d69   Run ion beam mi
-00023b60: 6c6c 696e 6720 7573 696e 6720 7468 6520  lling using the 
-00023b70: 7370 6563 6966 6965 6420 6d69 6c6c 696e  specified millin
-00023b80: 6720 6375 7272 656e 742e 0a0a 2020 2020  g current...    
-00023b90: 2020 2020 4172 6773 3a0a 2020 2020 2020      Args:.      
-00023ba0: 2020 2020 2020 6d69 6c6c 696e 675f 6375        milling_cu
-00023bb0: 7272 656e 7420 2866 6c6f 6174 293a 2054  rrent (float): T
-00023bc0: 6865 2063 7572 7265 6e74 2074 6f20 7573  he current to us
-00023bd0: 6520 666f 7220 6d69 6c6c 696e 6720 696e  e for milling in
-00023be0: 2061 6d70 732e 0a20 2020 2020 2020 2020   amps..         
-00023bf0: 2020 2061 7379 6e63 6820 2862 6f6f 6c2c     asynch (bool,
-00023c00: 206f 7074 696f 6e61 6c29 3a20 4966 2054   optional): If T
-00023c10: 7275 652c 2074 6865 206d 696c 6c69 6e67  rue, the milling
-00023c20: 2077 696c 6c20 6265 2072 756e 2061 7379   will be run asy
-00023c30: 6e63 6872 6f6e 6f75 736c 792e 200a 2020  nchronously. .  
-00023c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023c60: 2020 2044 6566 6175 6c74 7320 746f 2046     Defaults to F
-00023c70: 616c 7365 2c20 696e 2077 6869 6368 2063  alse, in which c
-00023c80: 6173 6520 6974 2077 696c 6c20 7275 6e20  ase it will run 
-00023c90: 7379 6e63 6872 6f6e 6f75 736c 792e 0a0a  synchronously...
-00023ca0: 2020 2020 2020 2020 5265 7475 726e 733a          Returns:
-00023cb0: 0a20 2020 2020 2020 2020 2020 204e 6f6e  .            Non
-00023cc0: 650a 0a20 2020 2020 2020 2052 6169 7365  e..        Raise
-00023cd0: 733a 0a20 2020 2020 2020 2020 2020 204e  s:.            N
-00023ce0: 6f6e 650a 2020 2020 2020 2020 2222 220a  one.        """.
-00023cf0: 2020 2020 2020 2020 5f63 6865 636b 5f62          _check_b
-00023d00: 6561 6d28 4265 616d 5479 7065 2e49 4f4e  eam(BeamType.ION
-00023d10: 2c20 7365 6c66 2e68 6172 6477 6172 655f  , self.hardware_
-00023d20: 7365 7474 696e 6773 290a 2020 2020 2020  settings).      
-00023d30: 2020 7374 6174 7573 203d 2073 656c 662e    status = self.
-00023d40: 636f 6e6e 6563 7469 6f6e 2e46 4942 2e42  connection.FIB.B
-00023d50: 6561 6d2e 4765 7453 7461 7475 7328 290a  eam.GetStatus().
-00023d60: 2020 2020 2020 2020 6966 2073 7461 7475          if statu
-00023d70: 7320 213d 2041 7574 6f6d 6174 696f 6e2e  s != Automation.
-00023d80: 4649 422e 4265 616d 2e53 7461 7475 732e  FIB.Beam.Status.
-00023d90: 4265 616d 4f6e 3a0a 2020 2020 2020 2020  BeamOn:.        
-00023da0: 2020 2020 7365 6c66 2e63 6f6e 6e65 6374      self.connect
-00023db0: 696f 6e2e 4649 422e 4265 616d 2e4f 6e28  ion.FIB.Beam.On(
-00023dc0: 290a 2020 2020 2020 2020 7365 6c66 2e63  ).        self.c
-00023dd0: 6f6e 6e65 6374 696f 6e2e 4472 6177 4265  onnection.DrawBe
-00023de0: 616d 2e4c 6f61 644c 6179 6572 2873 656c  am.LoadLayer(sel
-00023df0: 662e 6c61 7965 7229 0a20 2020 2020 2020  f.layer).       
-00023e00: 206c 6f67 6769 6e67 2e69 6e66 6f28 6622   logging.info(f"
-00023e10: 7275 6e6e 696e 6720 696f 6e20 6265 616d  running ion beam
-00023e20: 206d 696c 6c69 6e67 206e 6f77 2e2e 2e22   milling now..."
-00023e30: 290a 2020 2020 2020 2020 7365 6c66 2e63  ).        self.c
-00023e40: 6f6e 6e65 6374 696f 6e2e 4472 6177 4265  onnection.DrawBe
-00023e50: 616d 2e53 7461 7274 2829 0a20 2020 2020  am.Start().     
-00023e60: 2020 2073 656c 662e 636f 6e6e 6563 7469     self.connecti
-00023e70: 6f6e 2e50 726f 6772 6573 732e 5368 6f77  on.Progress.Show
-00023e80: 280a 2020 2020 2020 2020 2020 2020 2244  (.            "D
-00023e90: 7261 7742 6561 6d22 2c20 224c 6179 6572  rawBeam", "Layer
-00023ea0: 2031 2069 6e20 7072 6f67 7265 7373 222c   1 in progress",
-00023eb0: 2046 616c 7365 2c20 4661 6c73 652c 2030   False, False, 0
-00023ec0: 2c20 3130 300a 2020 2020 2020 2020 290a  , 100.        ).
-00023ed0: 2020 2020 2020 2020 6672 6f6d 2066 6962          from fib
-00023ee0: 7365 6d20 696d 706f 7274 2061 6c69 676e  sem import align
-00023ef0: 6d65 6e74 0a20 2020 2020 2020 2077 6869  ment.        whi
-00023f00: 6c65 2054 7275 653a 0a20 2020 2020 2020  le True:.       
-00023f10: 2020 2020 2073 7461 7475 7320 3d20 7365       status = se
-00023f20: 6c66 2e63 6f6e 6e65 6374 696f 6e2e 4472  lf.connection.Dr
-00023f30: 6177 4265 616d 2e47 6574 5374 6174 7573  awBeam.GetStatus
-00023f40: 2829 0a20 2020 2020 2020 2020 2020 2072  ().            r
-00023f50: 756e 6e69 6e67 203d 2073 7461 7475 735b  unning = status[
-00023f60: 305d 203d 3d20 4442 5374 6174 7573 2e50  0] == DBStatus.P
-00023f70: 726f 6a65 6374 4c6f 6164 6564 4578 706f  rojectLoadedExpo
-00023f80: 7369 7469 6f6e 496e 5072 6f67 7265 7373  sitionInProgress
-00023f90: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00023fa0: 7275 6e6e 696e 673a 0a20 2020 2020 2020  running:.       
-00023fb0: 2020 2020 2020 2020 2070 726f 6772 6573           progres
-00023fc0: 7320 3d20 300a 2020 2020 2020 2020 2020  s = 0.          
-00023fd0: 2020 2020 2020 6966 2073 7461 7475 735b        if status[
-00023fe0: 315d 203e 2030 3a0a 2020 2020 2020 2020  1] > 0:.        
-00023ff0: 2020 2020 2020 2020 2020 2020 7072 6f67              prog
-00024000: 7265 7373 203d 206d 696e 2831 3030 2c20  ress = min(100, 
-00024010: 7374 6174 7573 5b32 5d20 2f20 7374 6174  status[2] / stat
-00024020: 7573 5b31 5d20 2a20 3130 3029 0a20 2020  us[1] * 100).   
-00024030: 2020 2020 2020 2020 2020 2020 2070 7269               pri
-00024040: 6e74 5072 6f67 7265 7373 4261 7228 7072  ntProgressBar(pr
-00024050: 6f67 7265 7373 2c20 3130 3029 0a20 2020  ogress, 100).   
-00024060: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-00024070: 662e 636f 6e6e 6563 7469 6f6e 2e50 726f  f.connection.Pro
-00024080: 6772 6573 732e 5365 7450 6572 6365 6e74  gress.SetPercent
-00024090: 7328 7072 6f67 7265 7373 290a 2020 2020  s(progress).    
-000240a0: 2020 2020 2020 2020 2020 2020 7374 6174              stat
-000240b0: 7573 203d 2073 656c 662e 636f 6e6e 6563  us = self.connec
-000240c0: 7469 6f6e 2e44 7261 7742 6561 6d2e 4765  tion.DrawBeam.Ge
-000240d0: 7453 7461 7475 7328 290a 2020 2020 2020  tStatus().      
-000240e0: 2020 2020 2020 2020 2020 6966 2073 7461            if sta
-000240f0: 7475 735b 305d 203d 3d20 4442 5374 6174  tus[0] == DBStat
-00024100: 7573 2e50 726f 6a65 6374 4c6f 6164 6564  us.ProjectLoaded
-00024110: 4578 706f 7369 7469 6f6e 496e 5072 6f67  ExpositionInProg
-00024120: 7265 7373 3a0a 2020 2020 2020 2020 2020  ress:.          
-00024130: 2020 2020 2020 2020 2020 7365 6c66 2e63            self.c
-00024140: 6f6e 6e65 6374 696f 6e2e 4472 6177 4265  onnection.DrawBe
-00024150: 616d 2e50 6175 7365 2829 0a20 2020 2020  am.Pause().     
-00024160: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
-00024170: 7374 6174 7573 5b30 5d20 3d3d 2044 4253  status[0] == DBS
-00024180: 7461 7475 732e 5072 6f6a 6563 744c 6f61  tatus.ProjectLoa
-00024190: 6465 6445 7870 6f73 6974 696f 6e49 646c  dedExpositionIdl
-000241a0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-000241b0: 2020 2020 2020 2070 7269 6e74 5072 6f67         printProg
-000241c0: 7265 7373 4261 7228 3130 302c 2031 3030  ressBar(100, 100
-000241d0: 2c20 7375 6666 6978 3d22 4669 6e69 7368  , suffix="Finish
-000241e0: 6564 2229 0a20 2020 2020 2020 2020 2020  ed").           
-000241f0: 2020 2020 2020 2020 2073 656c 662e 636f           self.co
-00024200: 6e6e 6563 7469 6f6e 2e44 7261 7742 6561  nnection.DrawBea
-00024210: 6d2e 5374 6f70 2829 0a20 2020 2020 2020  m.Stop().       
-00024220: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-00024230: 662e 636f 6e6e 6563 7469 6f6e 2e44 7261  f.connection.Dra
-00024240: 7742 6561 6d2e 556e 6c6f 6164 4c61 7965  wBeam.UnloadLaye
-00024250: 7228 290a 2020 2020 2020 2020 2020 2020  r().            
-00024260: 2020 2020 2020 2020 6272 6561 6b0a 2020          break.  
-00024270: 2020 2020 2020 2020 2020 2020 2020 6c6f                lo
-00024280: 6767 696e 672e 696e 666f 2822 4472 6966  gging.info("Drif
-00024290: 7420 636f 7272 6563 7469 6f6e 2069 6e20  t correction in 
-000242a0: 7072 6f67 7265 7373 2e2e 2e22 290a 2020  progress...").  
-000242b0: 2020 2020 2020 2020 2020 2020 2020 696d                im
-000242c0: 6167 655f 7365 7474 696e 6773 2e62 6561  age_settings.bea
-000242d0: 6d5f 7479 7065 203d 2042 6561 6d54 7970  m_type = BeamTyp
-000242e0: 652e 494f 4e0a 2020 2020 2020 2020 2020  e.ION.          
-000242f0: 2020 2020 2020 616c 6967 6e6d 656e 742e        alignment.
-00024300: 6265 616d 5f73 6869 6674 5f61 6c69 676e  beam_shift_align
-00024310: 6d65 6e74 280a 2020 2020 2020 2020 2020  ment(.          
-00024320: 2020 2020 2020 2020 2020 7365 6c66 2c0a            self,.
-00024330: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024340: 2020 2020 696d 6167 655f 7365 7474 696e      image_settin
-00024350: 6773 2c0a 2020 2020 2020 2020 2020 2020  gs,.            
-00024360: 2020 2020 2020 2020 7265 665f 696d 6167          ref_imag
-00024370: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
-00024380: 2020 2020 2020 2072 6564 7563 6564 5f61         reduced_a
-00024390: 7265 612c 0a20 2020 2020 2020 2020 2020  rea,.           
-000243a0: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
-000243b0: 2020 2020 2020 2074 696d 652e 736c 6565         time.slee
-000243c0: 7028 3129 0a20 2020 2020 2020 2020 2020  p(1).           
-000243d0: 2020 2020 2073 7461 7475 7320 3d20 7365       status = se
-000243e0: 6c66 2e63 6f6e 6e65 6374 696f 6e2e 4472  lf.connection.Dr
-000243f0: 6177 4265 616d 2e47 6574 5374 6174 7573  awBeam.GetStatus
-00024400: 2829 0a20 2020 2020 2020 2020 2020 2020  ().             
-00024410: 2020 2069 6620 7374 6174 7573 5b30 5d20     if status[0] 
-00024420: 3d3d 2044 4253 7461 7475 732e 5072 6f6a  == DBStatus.Proj
-00024430: 6563 744c 6f61 6465 6445 7870 6f73 6974  ectLoadedExposit
-00024440: 696f 6e50 6175 7365 6420 3a0a 2020 2020  ionPaused :.    
-00024450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024460: 7365 6c66 2e63 6f6e 6e65 6374 696f 6e2e  self.connection.
-00024470: 4472 6177 4265 616d 2e52 6573 756d 6528  DrawBeam.Resume(
-00024480: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00024490: 2020 6c6f 6767 696e 672e 696e 666f 2822    logging.info("
-000244a0: 4472 6966 7420 636f 7272 6563 7469 6f6e  Drift correction
-000244b0: 2063 6f6d 706c 6574 652e 2229 0a20 2020   complete.").   
-000244c0: 2020 2020 2020 2020 2020 2020 2074 696d               tim
-000244d0: 652e 736c 6565 7028 3529 0a20 2020 2020  e.sleep(5).     
-000244e0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-000244f0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00024500: 7374 6174 7573 5b30 5d20 3d3d 2044 4253  status[0] == DBS
-00024510: 7461 7475 732e 5072 6f6a 6563 744c 6f61  tatus.ProjectLoa
-00024520: 6465 6445 7870 6f73 6974 696f 6e49 646c  dedExpositionIdl
-00024530: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-00024540: 2020 2020 2020 2070 7269 6e74 5072 6f67         printProg
-00024550: 7265 7373 4261 7228 3130 302c 2031 3030  ressBar(100, 100
-00024560: 2c20 7375 6666 6978 3d22 4669 6e69 7368  , suffix="Finish
-00024570: 6564 2229 0a20 2020 2020 2020 2020 2020  ed").           
-00024580: 2020 2020 2020 2020 2073 656c 662e 636f           self.co
-00024590: 6e6e 6563 7469 6f6e 2e44 7261 7742 6561  nnection.DrawBea
-000245a0: 6d2e 5374 6f70 2829 0a20 2020 2020 2020  m.Stop().       
-000245b0: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-000245c0: 662e 636f 6e6e 6563 7469 6f6e 2e44 7261  f.connection.Dra
-000245d0: 7742 6561 6d2e 556e 6c6f 6164 4c61 7965  wBeam.UnloadLaye
-000245e0: 7228 290a 2020 2020 2020 2020 2020 2020  r().            
-000245f0: 2020 2020 6272 6561 6b0a 0a20 2020 2020      break..     
-00024600: 2020 2070 7269 6e74 2829 2020 2320 6e65     print()  # ne
-00024610: 7720 6c69 6e65 206f 6e20 636f 6d70 6c65  w line on comple
-00024620: 7465 0a20 2020 2020 2020 2073 656c 662e  te.        self.
-00024630: 636f 6e6e 6563 7469 6f6e 2e50 726f 6772  connection.Progr
-00024640: 6573 732e 4869 6465 2829 0a0a 2020 2020  ess.Hide()..    
-00024650: 6465 6620 6669 6e69 7368 5f6d 696c 6c69  def finish_milli
-00024660: 6e67 2873 656c 662c 2069 6d61 6769 6e67  ng(self, imaging
-00024670: 5f63 7572 7265 6e74 3a20 666c 6f61 7429  _current: float)
-00024680: 3a0a 2020 2020 2020 2020 2222 220a 2020  :.        """.  
-00024690: 2020 2020 2020 4669 6e61 6c69 7365 7320        Finalises 
-000246a0: 7468 6520 6d69 6c6c 696e 6720 7072 6f63  the milling proc
-000246b0: 6573 7320 6279 2063 6c65 6172 696e 6720  ess by clearing 
-000246c0: 7468 6520 6d69 6372 6f73 636f 7065 206f  the microscope o
-000246d0: 6620 616e 7920 7061 7474 6572 6e73 2061  f any patterns a
-000246e0: 6e64 2072 6574 7572 6e69 6e67 2074 6865  nd returning the
-000246f0: 2063 7572 7265 6e74 2074 6f20 7468 6520   current to the 
-00024700: 696d 6167 696e 6720 6375 7272 656e 742e  imaging current.
-00024710: 0a0a 2020 2020 2020 2020 4172 6773 3a0a  ..        Args:.
-00024720: 2020 2020 2020 2020 2020 2020 696d 6167              imag
-00024730: 696e 675f 6375 7272 656e 7420 2866 6c6f  ing_current (flo
-00024740: 6174 293a 2054 6865 2063 7572 7265 6e74  at): The current
-00024750: 2074 6f20 7573 6520 666f 7220 696d 6167   to use for imag
-00024760: 696e 6720 696e 2061 6d70 732e 0a20 2020  ing in amps..   
-00024770: 2020 2020 2023 2022 2222 0a20 2020 2020       # """.     
-00024780: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
-00024790: 2020 2020 7365 6c66 2e63 6f6e 6e65 6374      self.connect
-000247a0: 696f 6e2e 4649 422e 5072 6573 6574 2e41  ion.FIB.Preset.A
-000247b0: 6374 6976 6174 6528 2233 3020 6b65 563b  ctivate("30 keV;
-000247c0: 2055 4852 2069 6d61 6769 6e67 2229 0a20   UHR imaging"). 
-000247d0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-000247e0: 636f 6e6e 6563 7469 6f6e 2e44 7261 7742  connection.DrawB
-000247f0: 6561 6d2e 556e 6c6f 6164 4c61 7965 7228  eam.UnloadLayer(
-00024800: 290a 2020 2020 2020 2020 2020 2020 7072  ).            pr
-00024810: 696e 7428 2268 656c 6c6f 2229 0a20 2020  int("hello").   
-00024820: 2020 2020 2065 7863 6570 743a 0a20 2020       except:.   
-00024830: 2020 2020 2020 2020 2070 6173 730a 0a20           pass.. 
-00024840: 2020 2064 6566 2064 7261 775f 7265 6374     def draw_rect
-00024850: 616e 676c 6528 0a20 2020 2020 2020 2073  angle(.        s
-00024860: 656c 662c 0a20 2020 2020 2020 2070 6174  elf,.        pat
-00024870: 7465 726e 5f73 6574 7469 6e67 733a 2046  tern_settings: F
-00024880: 6962 7365 6d50 6174 7465 726e 5365 7474  ibsemPatternSett
-00024890: 696e 6773 2c0a 2020 2020 293a 0a20 2020  ings,.    ):.   
-000248a0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-000248b0: 2044 7261 7773 2061 2072 6563 7461 6e67   Draws a rectang
-000248c0: 6c65 2070 6174 7465 726e 2075 7369 6e67  le pattern using
-000248d0: 2074 6865 2063 7572 7265 6e74 2069 6f6e   the current ion
-000248e0: 2062 6561 6d2e 0a0a 2020 2020 2020 2020   beam...        
-000248f0: 4172 6773 3a0a 2020 2020 2020 2020 2020  Args:.          
-00024900: 2020 7061 7474 6572 6e5f 7365 7474 696e    pattern_settin
-00024910: 6773 2028 4669 6273 656d 5061 7474 6572  gs (FibsemPatter
-00024920: 6e53 6574 7469 6e67 7329 3a20 7468 6520  nSettings): the 
-00024930: 7365 7474 696e 6773 2066 6f72 2074 6865  settings for the
-00024940: 2070 6174 7465 726e 2074 6f20 6472 6177   pattern to draw
-00024950: 2e0a 0a20 2020 2020 2020 2052 6574 7572  ...        Retur
-00024960: 6e73 3a0a 2020 2020 2020 2020 2020 2020  ns:.            
-00024970: 5061 7474 6572 6e3a 2074 6865 2063 7265  Pattern: the cre
-00024980: 6174 6564 2070 6174 7465 726e 2e0a 0a20  ated pattern... 
-00024990: 2020 2020 2020 2052 6169 7365 733a 0a20         Raises:. 
-000249a0: 2020 2020 2020 2020 2020 2041 7574 6f6d             Autom
-000249b0: 6174 696f 6e45 7272 6f72 3a20 6966 2061  ationError: if a
-000249c0: 6e20 6572 726f 7220 6f63 6375 7273 2077  n error occurs w
-000249d0: 6869 6c65 2063 7265 6174 696e 6720 7468  hile creating th
-000249e0: 6520 7061 7474 6572 6e2e 0a0a 2020 2020  e pattern...    
-000249f0: 2020 2020 4e6f 7465 733a 0a20 2020 2020      Notes:.     
-00024a00: 2020 2020 2020 2054 6865 2072 6563 7461         The recta
-00024a10: 6e67 6c65 2070 6174 7465 726e 2077 696c  ngle pattern wil
-00024a20: 6c20 6265 2063 656e 7465 7265 6420 6174  l be centered at
-00024a30: 2074 6865 2073 7065 6369 6669 6564 2063   the specified c
-00024a40: 6f6f 7264 696e 6174 6573 2028 6365 6e74  oordinates (cent
-00024a50: 7265 5f78 2c20 6365 6e74 7265 5f79 2920  re_x, centre_y) 
-00024a60: 7769 7468 2074 6865 2073 7065 6369 6669  with the specifi
-00024a70: 6564 0a20 2020 2020 2020 2020 2020 2077  ed.            w
-00024a80: 6964 7468 2c20 6865 6967 6874 2061 6e64  idth, height and
-00024a90: 2064 6570 7468 2028 696e 206e 6d29 2e20   depth (in nm). 
-00024aa0: 4966 2074 6865 2063 6c65 616e 696e 675f  If the cleaning_
-00024ab0: 6372 6f73 735f 7365 6374 696f 6e20 6174  cross_section at
-00024ac0: 7472 6962 7574 6520 6f66 2070 6174 7465  tribute of patte
-00024ad0: 726e 5f73 6574 7469 6e67 7320 6973 2054  rn_settings is T
-00024ae0: 7275 652c 2061 0a20 2020 2020 2020 2020  rue, a.         
-00024af0: 2020 2063 6c65 616e 696e 6720 6372 6f73     cleaning cros
-00024b00: 7320 7365 6374 696f 6e20 7061 7474 6572  s section patter
-00024b10: 6e20 7769 6c6c 2062 6520 6372 6561 7465  n will be create
-00024b20: 6420 696e 7374 6561 6420 6f66 2061 2072  d instead of a r
-00024b30: 6563 7461 6e67 6c65 2070 6174 7465 726e  ectangle pattern
-00024b40: 2e0a 0a20 2020 2020 2020 2020 2020 2054  ...            T
-00024b50: 6865 2070 6174 7465 726e 2077 696c 6c20  he pattern will 
-00024b60: 6265 2072 6f74 6174 6564 2062 7920 7468  be rotated by th
-00024b70: 6520 616e 676c 6520 7370 6563 6966 6965  e angle specifie
-00024b80: 6420 696e 2074 6865 2072 6f74 6174 696f  d in the rotatio
-00024b90: 6e20 6174 7472 6962 7574 6520 6f66 2070  n attribute of p
-00024ba0: 6174 7465 726e 5f73 6574 7469 6e67 7320  attern_settings 
-00024bb0: 2869 6e20 6465 6772 6565 7329 0a20 2020  (in degrees).   
-00024bc0: 2020 2020 2020 2020 2061 6e64 2073 6361           and sca
-00024bd0: 6e6e 6564 2069 6e20 7468 6520 6469 7265  nned in the dire
-00024be0: 6374 696f 6e20 7370 6563 6966 6965 6420  ction specified 
-00024bf0: 696e 2074 6865 2073 6361 6e5f 6469 7265  in the scan_dire
-00024c00: 6374 696f 6e20 6174 7472 6962 7574 6520  ction attribute 
-00024c10: 6f66 2070 6174 7465 726e 5f73 6574 7469  of pattern_setti
-00024c20: 6e67 7320 2827 686f 7269 7a6f 6e74 616c  ngs ('horizontal
-00024c30: 2720 6f72 0a20 2020 2020 2020 2020 2020  ' or.           
-00024c40: 2027 7665 7274 6963 616c 2729 2e0a 0a20   'vertical')... 
-00024c50: 2020 2020 2020 2020 2020 2054 6865 2063             The c
-00024c60: 7265 6174 6564 2070 6174 7465 726e 2063  reated pattern c
-00024c70: 616e 2062 6520 6164 6465 6420 746f 2074  an be added to t
-00024c80: 6865 2070 6174 7465 726e 696e 6720 7175  he patterning qu
-00024c90: 6575 6520 616e 6420 6578 6563 7574 6564  eue and executed
-00024ca0: 2075 7369 6e67 2074 6865 206c 6179 6572   using the layer
-00024cb0: 206d 6574 686f 6473 2069 6e20 4175 746f   methods in Auto
-00024cc0: 6d61 7469 6f6e 2e0a 2020 2020 2020 2020  mation..        
-00024cd0: 2222 220a 2020 2020 2020 2020 6365 6e74  """.        cent
-00024ce0: 7265 5f78 203d 2070 6174 7465 726e 5f73  re_x = pattern_s
-00024cf0: 6574 7469 6e67 732e 6365 6e74 7265 5f78  ettings.centre_x
-00024d00: 0a20 2020 2020 2020 2063 656e 7472 655f  .        centre_
-00024d10: 7920 3d20 7061 7474 6572 6e5f 7365 7474  y = pattern_sett
-00024d20: 696e 6773 2e63 656e 7472 655f 790a 2020  ings.centre_y.  
-00024d30: 2020 2020 2020 6465 7074 6820 3d20 7061        depth = pa
-00024d40: 7474 6572 6e5f 7365 7474 696e 6773 2e64  ttern_settings.d
-00024d50: 6570 7468 0a20 2020 2020 2020 2077 6964  epth.        wid
-00024d60: 7468 203d 2070 6174 7465 726e 5f73 6574  th = pattern_set
-00024d70: 7469 6e67 732e 7769 6474 680a 2020 2020  tings.width.    
-00024d80: 2020 2020 6865 6967 6874 203d 2070 6174      height = pat
-00024d90: 7465 726e 5f73 6574 7469 6e67 732e 6865  tern_settings.he
-00024da0: 6967 6874 0a20 2020 2020 2020 2072 6f74  ight.        rot
-00024db0: 6174 696f 6e20 3d20 7061 7474 6572 6e5f  ation = pattern_
-00024dc0: 7365 7474 696e 6773 2e72 6f74 6174 696f  settings.rotatio
-00024dd0: 6e20 2a20 636f 6e73 7461 6e74 732e 5241  n * constants.RA
-00024de0: 4449 414e 535f 544f 5f44 4547 5245 4553  DIANS_TO_DEGREES
-00024df0: 2023 2043 4845 434b 2055 4e49 5453 2028   # CHECK UNITS (
-00024e00: 5445 5343 414e 2054 616b 6573 2044 6567  TESCAN Takes Deg
-00024e10: 7265 6573 290a 2020 2020 2020 2020 7061  rees).        pa
-00024e20: 7468 7320 3d20 7365 6c66 2e67 6574 5f73  ths = self.get_s
-00024e30: 6361 6e5f 6469 7265 6374 696f 6e73 2829  can_directions()
-00024e40: 0a20 2020 2020 2020 2069 6620 7061 7474  .        if patt
-00024e50: 6572 6e5f 7365 7474 696e 6773 2e73 6361  ern_settings.sca
-00024e60: 6e5f 6469 7265 6374 696f 6e20 696e 2070  n_direction in p
-00024e70: 6174 6873 3a0a 2020 2020 2020 2020 2020  aths:.          
-00024e80: 2020 7061 7468 203d 2070 6174 7465 726e    path = pattern
-00024e90: 5f73 6574 7469 6e67 732e 7363 616e 5f64  _settings.scan_d
-00024ea0: 6972 6563 7469 6f6e 0a20 2020 2020 2020  irection.       
-00024eb0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00024ec0: 2020 2070 6174 6820 3d20 2246 6c79 6261     path = "Flyba
-00024ed0: 636b 220a 2020 2020 2020 2020 2020 2020  ck".            
-00024ee0: 6c6f 6767 696e 672e 696e 666f 2866 2253  logging.info(f"S
-00024ef0: 6361 6e20 6469 7265 6374 696f 6e20 7b70  can direction {p
-00024f00: 6174 7465 726e 5f73 6574 7469 6e67 732e  attern_settings.
-00024f10: 7363 616e 5f64 6972 6563 7469 6f6e 7d20  scan_direction} 
-00024f20: 6e6f 7420 7375 7070 6f72 7465 642e 2055  not supported. U
-00024f30: 7369 6e67 2046 6c79 6261 636b 2069 6e73  sing Flyback ins
-00024f40: 7465 6164 2e22 290a 2020 2020 2020 2020  tead.").        
-00024f50: 2020 2020 6c6f 6767 696e 672e 696e 666f      logging.info
-00024f60: 2866 2253 7570 706f 7274 6564 2073 6361  (f"Supported sca
-00024f70: 6e20 6469 7265 6374 696f 6e73 2061 7265  n directions are
-00024f80: 3a20 466c 7962 6163 6b2c 2052 4c45 2c20  : Flyback, RLE, 
-00024f90: 5370 6972 616c 496e 7369 6465 4f75 742c  SpiralInsideOut,
-00024fa0: 2053 7069 7261 6c4f 7574 7369 6465 496e   SpiralOutsideIn
-00024fb0: 2c20 5a69 675a 6167 2229 0a20 2020 2020  , ZigZag").     
-00024fc0: 2020 2073 656c 662e 636f 6e6e 6563 7469     self.connecti
-00024fd0: 6f6e 2e44 7261 7742 6561 6d2e 5363 616e  on.DrawBeam.Scan
-00024fe0: 6e69 6e67 5061 7468 203d 2070 6174 7465  ningPath = patte
-00024ff0: 726e 5f73 6574 7469 6e67 732e 7363 616e  rn_settings.scan
-00025000: 5f64 6972 6563 7469 6f6e 0a0a 2020 2020  _direction..    
-00025010: 2020 2020 6966 2070 6174 7465 726e 5f73      if pattern_s
-00025020: 6574 7469 6e67 732e 636c 6561 6e69 6e67  ettings.cleaning
-00025030: 5f63 726f 7373 5f73 6563 7469 6f6e 3a0a  _cross_section:.
-00025040: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00025050: 2e6c 6179 6572 2e61 6464 5265 6374 616e  .layer.addRectan
-00025060: 676c 6550 6f6c 6973 6828 0a20 2020 2020  glePolish(.     
-00025070: 2020 2020 2020 2020 2020 2043 656e 7465             Cente
-00025080: 7258 3d63 656e 7472 655f 782c 0a20 2020  rX=centre_x,.   
-00025090: 2020 2020 2020 2020 2020 2020 2043 656e               Cen
-000250a0: 7465 7259 3d63 656e 7472 655f 792c 0a20  terY=centre_y,. 
-000250b0: 2020 2020 2020 2020 2020 2020 2020 2044                 D
-000250c0: 6570 7468 3d64 6570 7468 2c0a 2020 2020  epth=depth,.    
-000250d0: 2020 2020 2020 2020 2020 2020 4465 7074              Dept
-000250e0: 6855 6e69 743d 276d 272c 0a20 2020 2020  hUnit='m',.     
-000250f0: 2020 2020 2020 2020 2020 2057 6964 7468             Width
-00025100: 3d77 6964 7468 2c0a 2020 2020 2020 2020  =width,.        
-00025110: 2020 2020 2020 2020 4865 6967 6874 3d68          Height=h
-00025120: 6569 6768 742c 0a20 2020 2020 2020 2020  eight,.         
-00025130: 2020 2020 2020 2041 6e67 6c65 3d72 6f74         Angle=rot
-00025140: 6174 696f 6e2c 0a20 2020 2020 2020 2020  ation,.         
-00025150: 2020 2020 2020 2053 6361 6e6e 696e 6750         ScanningP
-00025160: 6174 683d 7061 7468 0a20 2020 2020 2020  ath=path.       
-00025170: 2020 2020 2029 0a20 2020 2020 2020 2065       ).        e
-00025180: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00025190: 2073 656c 662e 6c61 7965 722e 6164 6452   self.layer.addR
-000251a0: 6563 7461 6e67 6c65 4669 6c6c 6564 280a  ectangleFilled(.
-000251b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000251c0: 4365 6e74 6572 583d 6365 6e74 7265 5f78  CenterX=centre_x
-000251d0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000251e0: 2020 4365 6e74 6572 593d 6365 6e74 7265    CenterY=centre
-000251f0: 5f79 2c0a 2020 2020 2020 2020 2020 2020  _y,.            
-00025200: 2020 2020 4465 7074 683d 6465 7074 682c      Depth=depth,
-00025210: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00025220: 2044 6570 7468 556e 6974 3d27 6d27 2c0a   DepthUnit='m',.
-00025230: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025240: 5769 6474 683d 7769 6474 682c 0a20 2020  Width=width,.   
-00025250: 2020 2020 2020 2020 2020 2020 2048 6569               Hei
-00025260: 6768 743d 6865 6967 6874 2c0a 2020 2020  ght=height,.    
-00025270: 2020 2020 2020 2020 2020 2020 416e 676c              Angl
-00025280: 653d 726f 7461 7469 6f6e 2c0a 2020 2020  e=rotation,.    
-00025290: 2020 2020 2020 2020 2020 2020 5363 616e              Scan
-000252a0: 6e69 6e67 5061 7468 3d70 6174 680a 2020  ningPath=path.  
-000252b0: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
-000252c0: 2020 2020 2070 6174 7465 726e 203d 2073       pattern = s
-000252d0: 656c 662e 6c61 7965 720a 2020 2020 2020  elf.layer.      
-000252e0: 2020 0a20 2020 2020 2020 2072 6574 7572    .        retur
-000252f0: 6e20 7061 7474 6572 6e0a 0a20 2020 2064  n pattern..    d
-00025300: 6566 2064 7261 775f 6c69 6e65 2873 656c  ef draw_line(sel
-00025310: 662c 2070 6174 7465 726e 5f73 6574 7469  f, pattern_setti
-00025320: 6e67 733a 2046 6962 7365 6d50 6174 7465  ngs: FibsemPatte
-00025330: 726e 5365 7474 696e 6773 293a 0a20 2020  rnSettings):.   
-00025340: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-00025350: 2044 7261 7773 2061 206c 696e 6520 7061   Draws a line pa
-00025360: 7474 6572 6e20 6f6e 2074 6865 2063 7572  ttern on the cur
-00025370: 7265 6e74 2069 6d61 6769 6e67 2076 6965  rent imaging vie
-00025380: 7720 6f66 2074 6865 206d 6963 726f 7363  w of the microsc
-00025390: 6f70 652e 0a0a 2020 2020 2020 2020 4172  ope...        Ar
-000253a0: 6773 3a0a 2020 2020 2020 2020 2020 2020  gs:.            
-000253b0: 7061 7474 6572 6e5f 7365 7474 696e 6773  pattern_settings
-000253c0: 2028 4669 6273 656d 5061 7474 6572 6e53   (FibsemPatternS
-000253d0: 6574 7469 6e67 7329 3a20 4120 6461 7461  ettings): A data
-000253e0: 2063 6c61 7373 206f 626a 6563 7420 7370   class object sp
-000253f0: 6563 6966 7969 6e67 2074 6865 2070 6174  ecifying the pat
-00025400: 7465 726e 2070 6172 616d 6574 6572 732c  tern parameters,
-00025410: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00025420: 2069 6e63 6c75 6469 6e67 2074 6865 2073   including the s
-00025430: 7461 7274 2061 6e64 2065 6e64 2070 6f69  tart and end poi
-00025440: 6e74 732c 2061 6e64 2074 6865 2064 6570  nts, and the dep
-00025450: 7468 206f 6620 7468 6520 7061 7474 6572  th of the patter
-00025460: 6e2e 0a0a 2020 2020 2020 2020 5265 7475  n...        Retu
-00025470: 726e 733a 0a20 2020 2020 2020 2020 2020  rns:.           
-00025480: 204c 696e 6550 6174 7465 726e 3a20 4120   LinePattern: A 
-00025490: 6c69 6e65 2070 6174 7465 726e 206f 626a  line pattern obj
-000254a0: 6563 742c 2077 6869 6368 2063 616e 2062  ect, which can b
-000254b0: 6520 7573 6564 2074 6f20 636f 6e66 6967  e used to config
-000254c0: 7572 6520 6675 7274 6865 7220 7072 6f70  ure further prop
-000254d0: 6572 7469 6573 206f 7220 746f 2061 6464  erties or to add
-000254e0: 2074 6865 0a20 2020 2020 2020 2020 2020   the.           
-000254f0: 2020 2020 2070 6174 7465 726e 2074 6f20       pattern to 
-00025500: 7468 6520 6d69 6c6c 696e 6720 6c69 7374  the milling list
-00025510: 2e0a 2020 2020 2020 2020 2222 220a 2020  ..        """.  
-00025520: 2020 2020 2020 7374 6172 745f 7820 3d20        start_x = 
-00025530: 7061 7474 6572 6e5f 7365 7474 696e 6773  pattern_settings
-00025540: 2e73 7461 7274 5f78 0a20 2020 2020 2020  .start_x.       
-00025550: 2073 7461 7274 5f79 203d 2070 6174 7465   start_y = patte
-00025560: 726e 5f73 6574 7469 6e67 732e 7374 6172  rn_settings.star
-00025570: 745f 790a 2020 2020 2020 2020 656e 645f  t_y.        end_
-00025580: 7820 3d20 7061 7474 6572 6e5f 7365 7474  x = pattern_sett
-00025590: 696e 6773 2e65 6e64 5f78 0a20 2020 2020  ings.end_x.     
-000255a0: 2020 2065 6e64 5f79 203d 2070 6174 7465     end_y = patte
-000255b0: 726e 5f73 6574 7469 6e67 732e 656e 645f  rn_settings.end_
-000255c0: 790a 2020 2020 2020 2020 6465 7074 6820  y.        depth 
-000255d0: 3d20 7061 7474 6572 6e5f 7365 7474 696e  = pattern_settin
-000255e0: 6773 2e64 6570 7468 0a0a 2020 2020 2020  gs.depth..      
-000255f0: 2020 7365 6c66 2e6c 6179 6572 2e61 6464    self.layer.add
-00025600: 4c69 6e65 280a 2020 2020 2020 2020 2020  Line(.          
-00025610: 2020 4265 6769 6e58 3d73 7461 7274 5f78    BeginX=start_x
-00025620: 2c20 4265 6769 6e59 3d73 7461 7274 5f79  , BeginY=start_y
-00025630: 2c20 456e 6458 3d65 6e64 5f78 2c20 456e  , EndX=end_x, En
-00025640: 6459 3d65 6e64 5f79 2c20 4465 7074 683d  dY=end_y, Depth=
-00025650: 6465 7074 682c 2044 6570 7468 556e 6974  depth, DepthUnit
-00025660: 3d27 6d27 2c0a 2020 2020 2020 2020 290a  ='m',.        ).
-00025670: 0a20 2020 2020 2020 2070 6174 7465 726e  .        pattern
-00025680: 203d 2073 656c 662e 6c61 7965 720a 2020   = self.layer.  
-00025690: 2020 2020 2020 7265 7475 726e 2070 6174        return pat
-000256a0: 7465 726e 0a0a 2020 2020 6465 6620 6472  tern..    def dr
-000256b0: 6177 5f63 6972 636c 6528 7365 6c66 2c20  aw_circle(self, 
-000256c0: 7061 7474 6572 6e5f 7365 7474 696e 6773  pattern_settings
-000256d0: 3a20 4669 6273 656d 5061 7474 6572 6e53  : FibsemPatternS
-000256e0: 6574 7469 6e67 7329 3a0a 2020 2020 2020  ettings):.      
-000256f0: 2020 2222 220a 2020 2020 2020 2020 4472    """.        Dr
-00025700: 6177 7320 6120 6369 7263 6c65 2070 6174  aws a circle pat
-00025710: 7465 726e 206f 6e20 7468 6520 6375 7272  tern on the curr
-00025720: 656e 7420 696d 6167 696e 6720 7669 6577  ent imaging view
-00025730: 206f 6620 7468 6520 6d69 6372 6f73 636f   of the microsco
-00025740: 7065 2e0a 0a20 2020 2020 2020 2041 7267  pe...        Arg
-00025750: 733a 0a20 2020 2020 2020 2020 2020 2070  s:.            p
-00025760: 6174 7465 726e 5f73 6574 7469 6e67 7320  attern_settings 
-00025770: 2846 6962 7365 6d50 6174 7465 726e 5365  (FibsemPatternSe
-00025780: 7474 696e 6773 293a 2041 2064 6174 6120  ttings): A data 
-00025790: 636c 6173 7320 6f62 6a65 6374 2073 7065  class object spe
-000257a0: 6369 6679 696e 6720 7468 6520 7061 7474  cifying the patt
-000257b0: 6572 6e20 7061 7261 6d65 7465 7273 2c0a  ern parameters,.
-000257c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000257d0: 696e 636c 7564 696e 6720 7468 6520 6365  including the ce
-000257e0: 6e74 7265 2070 6f69 6e74 2c20 7261 6469  ntre point, radi
-000257f0: 7573 2061 6e64 2064 6570 7468 206f 6620  us and depth of 
-00025800: 7468 6520 7061 7474 6572 6e2e 0a0a 2020  the pattern...  
-00025810: 2020 2020 2020 5265 7475 726e 733a 0a20        Returns:. 
-00025820: 2020 2020 2020 2020 2020 2043 6972 636c             Circl
-00025830: 6550 6174 7465 726e 3a20 4120 6369 7263  ePattern: A circ
-00025840: 6c65 2070 6174 7465 726e 206f 626a 6563  le pattern objec
-00025850: 742c 2077 6869 6368 2063 616e 2062 6520  t, which can be 
-00025860: 7573 6564 2074 6f20 636f 6e66 6967 7572  used to configur
-00025870: 6520 6675 7274 6865 7220 7072 6f70 6572  e further proper
-00025880: 7469 6573 206f 7220 746f 2061 6464 2074  ties or to add t
-00025890: 6865 0a20 2020 2020 2020 2020 2020 2020  he.             
-000258a0: 2020 2070 6174 7465 726e 2074 6f20 7468     pattern to th
-000258b0: 6520 6d69 6c6c 696e 6720 6c69 7374 2e0a  e milling list..
-000258c0: 0a20 2020 2020 2020 2020 2020 200a 2020  .            .  
-000258d0: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-000258e0: 2020 7061 7474 6572 6e20 3d20 7365 6c66    pattern = self
-000258f0: 2e6c 6179 6572 2e61 6464 416e 6e75 6c75  .layer.addAnnulu
-00025900: 7346 696c 6c65 6428 0a20 2020 2020 2020  sFilled(.       
-00025910: 2020 2020 2043 656e 7465 7258 3d70 6174       CenterX=pat
-00025920: 7465 726e 5f73 6574 7469 6e67 732e 6365  tern_settings.ce
-00025930: 6e74 7265 5f78 2c0a 2020 2020 2020 2020  ntre_x,.        
-00025940: 2020 2020 4365 6e74 6572 593d 7061 7474      CenterY=patt
-00025950: 6572 6e5f 7365 7474 696e 6773 2e63 656e  ern_settings.cen
-00025960: 7472 655f 792c 0a20 2020 2020 2020 2020  tre_y,.         
-00025970: 2020 2052 6164 6975 7341 3d70 6174 7465     RadiusA=patte
-00025980: 726e 5f73 6574 7469 6e67 732e 7261 6469  rn_settings.radi
-00025990: 7573 2c0a 2020 2020 2020 2020 2020 2020  us,.            
-000259a0: 5261 6469 7573 423d 302c 0a20 2020 2020  RadiusB=0,.     
-000259b0: 2020 2020 2020 2044 6570 7468 3d70 6174         Depth=pat
-000259c0: 7465 726e 5f73 6574 7469 6e67 732e 6465  tern_settings.de
-000259d0: 7074 682c 0a20 2020 2020 2020 2020 2020  pth,.           
-000259e0: 2044 6570 7468 556e 6974 3d27 6d27 2c0a   DepthUnit='m',.
-000259f0: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
-00025a00: 2020 2072 6574 7572 6e20 7061 7474 6572     return patter
-00025a10: 6e0a 2020 2020 0a20 2020 2064 6566 2064  n.    .    def d
-00025a20: 7261 775f 616e 6e75 6c75 7328 7365 6c66  raw_annulus(self
-00025a30: 2c70 6174 7465 726e 5f73 6574 7469 6e67  ,pattern_setting
-00025a40: 733a 2046 6962 7365 6d50 6174 7465 726e  s: FibsemPattern
-00025a50: 5365 7474 696e 6773 293a 0a0a 2020 2020  Settings):..    
-00025a60: 2020 2020 2222 2244 7261 7773 2061 6e20      """Draws an 
-00025a70: 616e 6e75 6c75 7320 2864 6f6e 7574 2920  annulus (donut) 
-00025a80: 7061 7474 6572 6e20 6f6e 2074 6865 2063  pattern on the c
-00025a90: 7572 7265 6e74 2069 6d61 6769 6e67 2076  urrent imaging v
-00025aa0: 6965 7720 6f66 2074 6865 206d 6963 726f  iew of the micro
-00025ab0: 7363 6f70 652e 0a0a 2020 2020 2020 2020  scope...        
-00025ac0: 4172 6773 3a20 0a20 2020 2020 2020 2020  Args: .         
-00025ad0: 2020 2070 6174 7465 726e 5f73 6574 7469     pattern_setti
-00025ae0: 6e67 7320 2846 6962 7365 6d50 6174 7465  ngs (FibsemPatte
-00025af0: 726e 5365 7474 696e 6773 293a 2041 2064  rnSettings): A d
-00025b00: 6174 6120 636c 6173 7320 6f62 6a65 6374  ata class object
-00025b10: 2073 7065 6369 6679 696e 6720 7468 6520   specifying the 
-00025b20: 7061 7474 6572 6e20 7061 7261 6d65 7465  pattern paramete
-00025b30: 7273 2c0a 2020 2020 2020 2020 2020 2020  rs,.            
-00025b40: 696e 636c 7564 696e 6720 7468 6520 6365  including the ce
-00025b50: 6e74 7265 2070 6f69 6e74 2c20 6f75 7465  ntre point, oute
-00025b60: 7220 7261 6469 7573 2061 6e64 2074 6869  r radius and thi
-00025b70: 636b 6e65 7373 206f 6620 7468 6520 616e  ckness of the an
-00025b80: 6e75 6c75 732c 2061 6e64 2074 6865 2064  nulus, and the d
-00025b90: 6570 7468 206f 6620 7468 6520 7061 7474  epth of the patt
-00025ba0: 6572 6e2e 0a0a 2020 2020 2020 2020 5265  ern...        Re
-00025bb0: 7475 726e 733a 0a20 2020 2020 2020 2020  turns:.         
-00025bc0: 2020 2061 6e6e 756c 7573 2070 6174 7465     annulus patte
-00025bd0: 726e 206f 626a 6563 740a 2020 2020 2020  rn object.      
-00025be0: 2020 2222 220a 2020 2020 2020 2020 6f75    """.        ou
-00025bf0: 7465 725f 7261 6469 7573 203d 2070 6174  ter_radius = pat
-00025c00: 7465 726e 5f73 6574 7469 6e67 732e 7261  tern_settings.ra
-00025c10: 6469 7573 0a20 2020 2020 2020 2069 6e6e  dius.        inn
-00025c20: 6572 5f72 6164 6975 7320 3d20 7061 7474  er_radius = patt
-00025c30: 6572 6e5f 7365 7474 696e 6773 2e72 6164  ern_settings.rad
-00025c40: 6975 7320 2d20 7061 7474 6572 6e5f 7365  ius - pattern_se
-00025c50: 7474 696e 6773 2e74 6869 636b 6e65 7373  ttings.thickness
-00025c60: 0a0a 0a20 2020 2020 2020 2070 6174 7465  ...        patte
-00025c70: 726e 203d 2073 656c 662e 6c61 7965 722e  rn = self.layer.
-00025c80: 6164 6441 6e6e 756c 7573 4669 6c6c 6564  addAnnulusFilled
-00025c90: 280a 2020 2020 2020 2020 2020 2020 4365  (.            Ce
-00025ca0: 6e74 6572 583d 7061 7474 6572 6e5f 7365  nterX=pattern_se
-00025cb0: 7474 696e 6773 2e63 656e 7472 655f 782c  ttings.centre_x,
-00025cc0: 0a20 2020 2020 2020 2020 2020 2043 656e  .            Cen
-00025cd0: 7465 7259 3d70 6174 7465 726e 5f73 6574  terY=pattern_set
-00025ce0: 7469 6e67 732e 6365 6e74 7265 5f79 2c0a  tings.centre_y,.
-00025cf0: 2020 2020 2020 2020 2020 2020 5261 6469              Radi
-00025d00: 7573 413d 6f75 7465 725f 7261 6469 7573  usA=outer_radius
-00025d10: 2c0a 2020 2020 2020 2020 2020 2020 5261  ,.            Ra
-00025d20: 6469 7573 423d 696e 6e65 725f 7261 6469  diusB=inner_radi
-00025d30: 7573 2c0a 2020 2020 2020 2020 2020 2020  us,.            
-00025d40: 4465 7074 683d 7061 7474 6572 6e5f 7365  Depth=pattern_se
-00025d50: 7474 696e 6773 2e64 6570 7468 2c0a 2020  ttings.depth,.  
-00025d60: 2020 2020 2020 2020 2020 4465 7074 6855            DepthU
-00025d70: 6e69 743d 276d 272c 0a20 2020 2020 2020  nit='m',.       
-00025d80: 2029 0a0a 2020 2020 2020 2020 7265 7475   )..        retu
-00025d90: 726e 2070 6174 7465 726e 0a20 2020 200a  rn pattern.    .
-00025da0: 2020 2020 6465 6620 6472 6177 5f62 6974      def draw_bit
-00025db0: 6d61 705f 7061 7474 6572 6e28 0a20 2020  map_pattern(.   
-00025dc0: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
-00025dd0: 2020 2070 6174 7465 726e 5f73 6574 7469     pattern_setti
-00025de0: 6e67 733a 2046 6962 7365 6d50 6174 7465  ngs: FibsemPatte
-00025df0: 726e 5365 7474 696e 6773 2c0a 2020 2020  rnSettings,.    
-00025e00: 2020 2020 7061 7468 3a20 7374 722c 0a20      path: str,. 
-00025e10: 2020 2029 3a0a 2020 2020 2020 2020 7265     ):.        re
-00025e20: 7475 726e 204e 6f74 496d 706c 656d 656e  turn NotImplemen
-00025e30: 7465 640a 2020 2020 0a20 2020 2064 6566  ted.    .    def
-00025e40: 2067 6574 5f73 6361 6e5f 6469 7265 6374   get_scan_direct
-00025e50: 696f 6e73 2873 656c 6629 3a0a 2020 2020  ions(self):.    
-00025e60: 2020 2020 0a20 2020 2020 2020 206c 6973      .        lis
-00025e70: 7420 3d20 5b22 466c 7962 6163 6b22 2c20  t = ["Flyback", 
-00025e80: 2252 4c45 222c 2022 5370 6972 616c 496e  "RLE", "SpiralIn
-00025e90: 7369 6465 4f75 7422 2c20 2253 7069 7261  sideOut", "Spira
-00025ea0: 6c4f 7574 7369 6465 496e 222c 2022 5a69  lOutsideIn", "Zi
-00025eb0: 675a 6167 225d 0a20 2020 2020 2020 2072  gZag"].        r
-00025ec0: 6574 7572 6e20 6c69 7374 0a0a 2020 2020  eturn list..    
-00025ed0: 6465 6620 7365 7475 705f 7370 7574 7465  def setup_sputte
-00025ee0: 7228 7365 6c66 2c20 7072 6f74 6f63 6f6c  r(self, protocol
-00025ef0: 3a20 6469 6374 293a 0a20 2020 2020 2020  : dict):.       
-00025f00: 2022 2222 0a20 2020 2020 2020 2053 6574   """.        Set
-00025f10: 2075 7020 7468 6520 7370 7574 7465 7220   up the sputter 
-00025f20: 636f 6174 696e 6720 7072 6f63 6573 7320  coating process 
-00025f30: 6f6e 2074 6865 206d 6963 726f 7363 6f70  on the microscop
-00025f40: 652e 0a0a 2020 2020 2020 2020 4172 6773  e...        Args
-00025f50: 3a0a 2020 2020 2020 2020 2020 2020 7072  :.            pr
-00025f60: 6f74 6f63 6f6c 2028 6469 6374 293a 2043  otocol (dict): C
-00025f70: 6f6e 7461 696e 7320 616c 6c20 6f66 2074  ontains all of t
-00025f80: 6865 206e 6563 6573 7361 7279 2076 616c  he necessary val
-00025f90: 7565 7320 746f 2073 6574 7570 2075 7020  ues to setup up 
-00025fa0: 706c 6174 696e 756d 2073 7075 7474 6572  platinum sputter
-00025fb0: 696e 672e 0a20 2020 2020 2020 2020 2020  ing..           
-00025fc0: 2020 2020 2046 6f72 2054 4553 4341 4e3a       For TESCAN:
-00025fd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00025fe0: 2020 2020 202d 2068 6677 3a20 486f 7269       - hfw: Hori
-00025ff0: 7a6f 6e74 616c 2066 6965 6c64 2077 6964  zontal field wid
-00026000: 7468 2028 6d29 2e0a 2020 2020 2020 2020  th (m)..        
-00026010: 2020 2020 2020 2020 2020 2020 2d20 6265              - be
-00026020: 616d 5f63 7572 7265 6e74 3a20 496f 6e20  am_current: Ion 
-00026030: 6265 616d 2063 7572 7265 6e74 2069 6e20  beam current in 
-00026040: 5b41 5d2e 0a20 2020 2020 2020 2020 2020  [A]..           
-00026050: 2020 2020 2020 2020 202d 2073 706f 745f           - spot_
-00026060: 7369 7a65 3a20 496f 6e20 6265 616d 2073  size: Ion beam s
-00026070: 706f 7420 7369 7a65 2069 6e20 5b6d 5d2e  pot size in [m].
-00026080: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00026090: 2020 2020 202d 2072 6174 653a 2049 6f6e       - rate: Ion
-000260a0: 2f65 6c65 6374 726f 6e20 6574 6368 696e  /electron etchin
-000260b0: 6720 7261 7465 2028 6465 706f 7369 7469  g rate (depositi
-000260c0: 6f6e 2072 6174 6529 2069 6e20 5b6d 332f  on rate) in [m3/
-000260d0: 412f 735d 2e20 452e 672e 2066 6f72 2073  A/s]. E.g. for s
-000260e0: 696c 6963 6f6e 6520 342e 3765 2d31 3020  ilicone 4.7e-10 
-000260f0: 6d33 2f41 2f73 2e0a 2020 2020 2020 2020  m3/A/s..        
-00026100: 2020 2020 2020 2020 2020 2020 2d20 6477              - dw
-00026110: 656c 6c20 7469 6d65 3a20 5069 7865 6c20  ell time: Pixel 
-00026120: 6477 656c 6c20 7469 6d65 2069 6e20 5b73  dwell time in [s
-00026130: 5d2e 0a0a 2020 2020 2020 2020 5265 7475  ]...        Retu
-00026140: 726e 733a 0a20 2020 2020 2020 2020 2020  rns:.           
-00026150: 204e 6f6e 650a 0a20 2020 2020 2020 2052   None..        R
-00026160: 6169 7365 733a 0a20 2020 2020 2020 2020  aises:.         
-00026170: 2020 204e 6f6e 650a 0a20 2020 2020 2020     None..       
-00026180: 204e 6f74 6573 3a0a 2020 2020 2020 2020   Notes:.        
-00026190: 2020 2020 5468 6973 2066 756e 6374 696f      This functio
-000261a0: 6e20 7365 7473 2075 7020 7468 6520 7370  n sets up the sp
-000261b0: 7574 7465 7220 636f 6174 696e 6720 7072  utter coating pr
-000261c0: 6f63 6573 7320 6f6e 2074 6865 206d 6963  ocess on the mic
-000261d0: 726f 7363 6f70 652e 200a 2020 2020 2020  roscope. .      
-000261e0: 2020 2020 2020 4974 2073 6574 7320 7468        It sets th
-000261f0: 6520 6163 7469 7665 2076 6965 7720 746f  e active view to
-00026200: 2074 6865 2065 6c65 6374 726f 6e20 6265   the electron be
-00026210: 616d 2c20 636c 6561 7273 2061 6e79 2065  am, clears any e
-00026220: 7869 7374 696e 6720 7061 7474 6572 6e73  xisting patterns
-00026230: 2c20 616e 6420 7365 7473 2074 6865 2064  , and sets the d
-00026240: 6566 6175 6c74 2062 6561 6d20 7479 7065  efault beam type
-00026250: 2074 6f20 7468 6520 656c 6563 7472 6f6e   to the electron
-00026260: 2062 6561 6d2e 200a 2020 2020 2020 2020   beam. .        
-00026270: 2020 2020 4974 2074 6865 6e20 696e 7365      It then inse
-00026280: 7274 7320 7468 6520 6d75 6c74 6963 6865  rts the multiche
-00026290: 6d20 616e 6420 7475 726e 7320 6f6e 2074  m and turns on t
-000262a0: 6865 2068 6561 7465 7220 666f 7220 7468  he heater for th
-000262b0: 6520 7370 6563 6966 6965 6420 6761 7320  e specified gas 
-000262c0: 6163 636f 7264 696e 6720 746f 2074 6865  according to the
-000262d0: 2067 6976 656e 2070 726f 746f 636f 6c2e   given protocol.
-000262e0: 200a 2020 2020 2020 2020 2020 2020 5468   .            Th
-000262f0: 6973 2066 756e 6374 696f 6e20 616c 736f  is function also
-00026300: 2077 6169 7473 2066 6f72 2033 2073 6563   waits for 3 sec
-00026310: 6f6e 6473 2074 6f20 616c 6c6f 7720 7468  onds to allow th
-00026320: 6520 6865 6174 6572 2074 6f20 7761 726d  e heater to warm
-00026330: 2075 702e 0a20 2020 2020 2020 2022 2222   up..        """
-00026340: 0a20 2020 2020 2020 205f 6368 6563 6b5f  .        _check_
-00026350: 7370 7574 7465 7228 7365 6c66 2e68 6172  sputter(self.har
-00026360: 6477 6172 655f 7365 7474 696e 6773 290a  dware_settings).
-00026370: 2020 2020 2020 2020 7365 6c66 2e63 6f6e          self.con
-00026380: 6e65 6374 696f 6e2e 4649 422e 4265 616d  nection.FIB.Beam
-00026390: 2e4f 6e28 290a 2020 2020 2020 2020 6c69  .On().        li
-000263a0: 6e65 7320 3d20 7365 6c66 2e63 6f6e 6e65  nes = self.conne
-000263b0: 6374 696f 6e2e 4749 532e 456e 756d 2829  ction.GIS.Enum()
-000263c0: 0a20 2020 2020 2020 2066 6f72 206c 696e  .        for lin
-000263d0: 6520 696e 206c 696e 6573 3a0a 2020 2020  e in lines:.    
-000263e0: 2020 2020 2020 2020 6966 206c 696e 652e          if line.
-000263f0: 6e61 6d65 203d 3d20 2250 6c61 7469 6e75  name == "Platinu
-00026400: 6d22 3a0a 2020 2020 2020 2020 2020 2020  m":.            
-00026410: 2020 2020 7365 6c66 2e6c 696e 6520 3d20      self.line = 
-00026420: 6c69 6e65 0a0a 2020 2020 2020 2020 2020  line..          
-00026430: 2020 2020 2020 2320 5374 6172 7420 4749        # Start GI
-00026440: 5320 6865 6174 696e 670a 2020 2020 2020  S heating.      
-00026450: 2020 2020 2020 2020 2020 7365 6c66 2e63            self.c
-00026460: 6f6e 6e65 6374 696f 6e2e 4749 532e 5072  onnection.GIS.Pr
-00026470: 6570 6172 6554 656d 7065 7261 7475 7265  epareTemperature
-00026480: 286c 696e 652c 2054 7275 6529 0a0a 2020  (line, True)..  
-00026490: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-000264a0: 496e 7365 7274 2047 4953 2069 6e74 6f20  Insert GIS into 
-000264b0: 776f 726b 696e 6720 706f 7369 7469 6f6e  working position
-000264c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000264d0: 2073 656c 662e 636f 6e6e 6563 7469 6f6e   self.connection
-000264e0: 2e47 4953 2e4d 6f76 6554 6f28 6c69 6e65  .GIS.MoveTo(line
-000264f0: 2c20 4175 746f 6d61 7469 6f6e 2e47 4953  , Automation.GIS
-00026500: 2e50 6f73 6974 696f 6e2e 576f 726b 696e  .Position.Workin
-00026510: 6729 0a0a 2020 2020 2020 2020 2020 2020  g)..            
-00026520: 2020 2020 2320 5761 6974 2066 6f72 2047      # Wait for G
-00026530: 4953 2068 6561 7465 640a 2020 2020 2020  IS heated.      
-00026540: 2020 2020 2020 2020 2020 7365 6c66 2e63            self.c
-00026550: 6f6e 6e65 6374 696f 6e2e 4749 532e 5761  onnection.GIS.Wa
-00026560: 6974 466f 7254 656d 7065 7261 7475 7265  itForTemperature
-00026570: 5265 6164 7928 6c69 6e65 290a 0a20 2020  Ready(line)..   
-00026580: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
-00026590: 2020 2020 2020 6c61 7965 7253 6574 7469        layerSetti
-000265a0: 6e67 7320 3d20 7365 6c66 2e63 6f6e 6e65  ngs = self.conne
-000265b0: 6374 696f 6e2e 4472 6177 4265 616d 2e4c  ction.DrawBeam.L
-000265c0: 6179 6572 5365 7474 696e 6773 2e49 4465  ayerSettings.IDe
-000265d0: 706f 7369 7469 6f6e 280a 2020 2020 2020  position(.      
-000265e0: 2020 2020 2020 2020 2020 7379 6e63 5772            syncWr
-000265f0: 6974 6546 6965 6c64 3d54 7275 652c 0a20  iteField=True,. 
-00026600: 2020 2020 2020 2020 2020 2020 2020 2077                 w
-00026610: 7269 7465 4669 656c 6453 697a 653d 7072  riteFieldSize=pr
-00026620: 6f74 6f63 6f6c 5b22 6866 7722 5d2c 0a20  otocol["hfw"],. 
-00026630: 2020 2020 2020 2020 2020 2020 2020 2062                 b
-00026640: 6561 6d43 7572 7265 6e74 3d70 726f 746f  eamCurrent=proto
-00026650: 636f 6c5b 2262 6561 6d5f 6375 7272 656e  col["beam_curren
-00026660: 7422 5d2c 0a20 2020 2020 2020 2020 2020  t"],.           
-00026670: 2020 2020 2073 706f 7453 697a 653d 7072       spotSize=pr
-00026680: 6f74 6f63 6f6c 5b22 7370 6f74 5f73 697a  otocol["spot_siz
-00026690: 6522 5d2c 0a20 2020 2020 2020 2020 2020  e"],.           
-000266a0: 2020 2020 2072 6174 653d 3365 2d31 302c       rate=3e-10,
-000266b0: 2023 2056 616c 7565 2066 6f72 2070 6c61   # Value for pla
-000266c0: 7469 6e75 6d0a 2020 2020 2020 2020 2020  tinum.          
-000266d0: 2020 2020 2020 6477 656c 6c54 696d 653d        dwellTime=
-000266e0: 7072 6f74 6f63 6f6c 5b22 6477 656c 6c5f  protocol["dwell_
-000266f0: 7469 6d65 225d 2c0a 2020 2020 2020 2020  time"],.        
-00026700: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-00026710: 2020 7365 6c66 2e6c 6179 6572 203d 2073    self.layer = s
-00026720: 656c 662e 636f 6e6e 6563 7469 6f6e 2e44  elf.connection.D
-00026730: 7261 7742 6561 6d2e 4c61 7965 7228 224c  rawBeam.Layer("L
-00026740: 6179 6572 3122 2c20 6c61 7965 7253 6574  ayer1", layerSet
-00026750: 7469 6e67 7329 0a20 2020 2020 2020 2020  tings).         
-00026760: 2020 2073 656c 662e 636f 6e6e 6563 7469     self.connecti
-00026770: 6f6e 2e44 7261 7742 6561 6d2e 4c6f 6164  on.DrawBeam.Load
-00026780: 4c61 7965 7228 7365 6c66 2e6c 6179 6572  Layer(self.layer
-00026790: 290a 0a20 2020 2020 2020 2065 7863 6570  )..        excep
-000267a0: 743a 0a20 2020 2020 2020 2020 2020 2069  t:.            i
-000267b0: 6d70 6f72 7420 6669 6273 656d 0a20 2020  mport fibsem.   
-000267c0: 2020 2020 2020 2020 2062 6173 655f 7061           base_pa
-000267d0: 7468 203d 206f 732e 7061 7468 2e64 6972  th = os.path.dir
-000267e0: 6e61 6d65 2866 6962 7365 6d2e 5f5f 7061  name(fibsem.__pa
-000267f0: 7468 5f5f 5b30 5d29 0a20 2020 2020 2020  th__[0]).       
-00026800: 2020 2020 206c 6179 6572 5f70 6174 6820       layer_path 
-00026810: 3d20 6f73 2e70 6174 682e 6a6f 696e 2862  = os.path.join(b
-00026820: 6173 655f 7061 7468 2c22 6669 6273 656d  ase_path,"fibsem
-00026830: 222c 2022 636f 6e66 6967 222c 2022 6465  ", "config", "de
-00026840: 706f 7369 7469 6f6e 2e64 6270 2229 0a20  position.dbp"). 
-00026850: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00026860: 6c61 7965 7220 3d20 7365 6c66 2e63 6f6e  layer = self.con
-00026870: 6e65 6374 696f 6e2e 4472 6177 4265 616d  nection.DrawBeam
-00026880: 2e4c 6179 6572 2e66 726f 6d44 6270 286c  .Layer.fromDbp(l
-00026890: 6179 6572 5f70 6174 6829 5b30 5d0a 2020  ayer_path)[0].  
-000268a0: 2020 2020 2020 2020 2020 2320 7365 6c66            # self
-000268b0: 2e6c 6179 6572 203d 2073 656c 662e 636f  .layer = self.co
-000268c0: 6e6e 6563 7469 6f6e 2e44 7261 7742 6561  nnection.DrawBea
-000268d0: 6d2e 4c6f 6164 4c61 7965 7228 6465 6661  m.LoadLayer(defa
-000268e0: 756c 744c 6179 6572 5365 7474 696e 6773  ultLayerSettings
-000268f0: 5b30 5d29 0a0a 2020 2020 6465 6620 6472  [0])..    def dr
-00026900: 6177 5f73 7075 7474 6572 5f70 6174 7465  aw_sputter_patte
-00026910: 726e 2873 656c 662c 2068 6677 2c20 6c69  rn(self, hfw, li
-00026920: 6e65 5f70 6174 7465 726e 5f6c 656e 6774  ne_pattern_lengt
-00026930: 682c 202a 6172 6773 2c20 2a2a 6b77 6172  h, *args, **kwar
-00026940: 6773 293a 0a20 2020 2020 2020 2022 2222  gs):.        """
-00026950: 0a20 2020 2020 2020 2044 7261 7773 2061  .        Draws a
-00026960: 206c 696e 6520 7061 7474 6572 6e20 666f   line pattern fo
-00026970: 7220 7370 7574 7465 7269 6e67 2077 6974  r sputtering wit
-00026980: 6820 7468 6520 6769 7665 6e20 7061 7261  h the given para
-00026990: 6d65 7465 7273 2e0a 0a20 2020 2020 2020  meters...       
-000269a0: 2041 7267 733a 0a20 2020 2020 2020 2020   Args:.         
-000269b0: 2020 2068 6677 2028 666c 6f61 7429 3a20     hfw (float): 
-000269c0: 5468 6520 686f 7269 7a6f 6e74 616c 2066  The horizontal f
-000269d0: 6965 6c64 2077 6964 7468 206f 6620 7468  ield width of th
-000269e0: 6520 656c 6563 7472 6f6e 2062 6561 6d2e  e electron beam.
-000269f0: 0a20 2020 2020 2020 2020 2020 206c 696e  .            lin
-00026a00: 655f 7061 7474 6572 6e5f 6c65 6e67 7468  e_pattern_length
-00026a10: 2028 666c 6f61 7429 3a20 5468 6520 6c65   (float): The le
-00026a20: 6e67 7468 206f 6620 7468 6520 6c69 6e65  ngth of the line
-00026a30: 2070 6174 7465 726e 2074 6f20 6472 6177   pattern to draw
-00026a40: 2e0a 2020 2020 2020 2020 2020 2020 2a61  ..            *a
-00026a50: 7267 732c 202a 2a6b 7761 7267 733a 2054  rgs, **kwargs: T
-00026a60: 6869 7320 7265 7072 6573 656e 7473 2074  his represents t
-00026a70: 6865 2061 7267 756d 656e 7473 2075 7365  he arguments use
-00026a80: 6420 6279 2054 6865 726d 6f4d 6963 726f  d by ThermoMicro
-00026a90: 7363 6f70 6520 7468 6174 2061 7265 206e  scope that are n
-00026aa0: 6f74 2072 6571 7569 7265 6420 666f 7220  ot required for 
-00026ab0: 7468 6520 5465 7363 616e 4d69 6372 6f73  the TescanMicros
-00026ac0: 636f 7065 2e0a 0a20 2020 2020 2020 2052  cope...        R
-00026ad0: 6574 7572 6e73 3a0a 2020 2020 2020 2020  eturns:.        
-00026ae0: 2020 2020 4e6f 6e65 0a0a 2020 2020 2020      None..      
-00026af0: 2020 4e6f 7465 733a 0a20 2020 2020 2020    Notes:.       
-00026b00: 2020 2020 2053 6574 7320 7468 6520 686f       Sets the ho
-00026b10: 7269 7a6f 6e74 616c 2066 6965 6c64 2077  rizontal field w
-00026b20: 6964 7468 206f 6620 7468 6520 656c 6563  idth of the elec
-00026b30: 7472 6f6e 2062 6561 6d20 746f 2074 6865  tron beam to the
-00026b40: 2067 6976 656e 2076 616c 7565 2e0a 2020   given value..  
-00026b50: 2020 2020 2020 2020 2020 4472 6177 7320            Draws 
-00026b60: 6120 6c69 6e65 2070 6174 7465 726e 2066  a line pattern f
-00026b70: 6f72 2073 7075 7474 6572 696e 6720 7769  or sputtering wi
-00026b80: 7468 2074 6865 2067 6976 656e 206c 656e  th the given len
-00026b90: 6774 6820 616e 6420 6d69 6c6c 696e 6720  gth and milling 
-00026ba0: 6465 7074 682e 0a20 2020 2020 2020 2020  depth..         
-00026bb0: 2020 2053 6574 7320 7468 6520 7370 7574     Sets the sput
-00026bc0: 7465 7220 7469 6d65 206f 6620 7468 6520  ter time of the 
-00026bd0: 6c69 6e65 2070 6174 7465 726e 2074 6f20  line pattern to 
-00026be0: 7468 6520 6769 7665 6e20 7661 6c75 652e  the given value.
-00026bf0: 0a0a 2020 2020 2020 2020 2222 220a 2020  ..        """.  
-00026c00: 2020 2020 2020 7365 6c66 2e63 6f6e 6e65        self.conne
-00026c10: 6374 696f 6e2e 4649 422e 4f70 7469 6373  ction.FIB.Optics
-00026c20: 2e53 6574 5669 6577 6669 656c 6428 0a20  .SetViewfield(. 
-00026c30: 2020 2020 2020 2020 2020 2068 6677 202a             hfw *
-00026c40: 2063 6f6e 7374 616e 7473 2e4d 4554 5245   constants.METRE
-00026c50: 5f54 4f5f 4d49 4c4c 494d 4554 5245 0a20  _TO_MILLIMETRE. 
-00026c60: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
-00026c70: 2020 7374 6172 745f 783d 2d6c 696e 655f    start_x=-line_
-00026c80: 7061 7474 6572 6e5f 6c65 6e67 7468 2f32  pattern_length/2
-00026c90: 2c20 0a20 2020 2020 2020 2073 7461 7274  , .        start
-00026ca0: 5f79 3d2b 6c69 6e65 5f70 6174 7465 726e  _y=+line_pattern
-00026cb0: 5f6c 656e 6774 682c 0a20 2020 2020 2020  _length,.       
-00026cc0: 2065 6e64 5f78 3d2b 6c69 6e65 5f70 6174   end_x=+line_pat
-00026cd0: 7465 726e 5f6c 656e 6774 682f 322c 0a20  tern_length/2,. 
-00026ce0: 2020 2020 2020 2065 6e64 5f79 3d2b 6c69         end_y=+li
-00026cf0: 6e65 5f70 6174 7465 726e 5f6c 656e 6774  ne_pattern_lengt
-00026d00: 682c 0a20 2020 2020 2020 2064 6570 7468  h,.        depth
-00026d10: 3d32 652d 360a 2020 2020 2020 2020 0a20  =2e-6.        . 
-00026d20: 2020 2020 2020 2070 6174 7465 726e 203d         pattern =
-00026d30: 2073 656c 662e 6c61 7965 722e 6164 644c   self.layer.addL
-00026d40: 696e 6528 0a20 2020 2020 2020 2020 2020  ine(.           
-00026d50: 2042 6567 696e 583d 7374 6172 745f 782c   BeginX=start_x,
-00026d60: 2042 6567 696e 593d 7374 6172 745f 792c   BeginY=start_y,
-00026d70: 2045 6e64 583d 656e 645f 782c 2045 6e64   EndX=end_x, End
-00026d80: 593d 656e 645f 792c 2044 6570 7468 3d64  Y=end_y, Depth=d
-00026d90: 6570 7468 0a20 2020 2020 2020 2029 0a20  epth.        ). 
-00026da0: 2020 2020 2020 200a 2020 2020 2020 2020         .        
-00026db0: 7265 7475 726e 2070 6174 7465 726e 0a0a  return pattern..
-00026dc0: 2020 2020 6465 6620 7275 6e5f 7370 7574      def run_sput
-00026dd0: 7465 7228 7365 6c66 2c20 2a61 7267 732c  ter(self, *args,
-00026de0: 202a 2a6b 7761 7267 7329 3a0a 2020 2020   **kwargs):.    
-00026df0: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-00026e00: 5275 6e73 2074 6865 2047 4953 2050 6c61  Runs the GIS Pla
-00026e10: 7469 6e75 6d20 5370 7574 7465 722e 0a0a  tinum Sputter...
-00026e20: 2020 2020 2020 2020 4172 6773 3a0a 2020          Args:.  
-00026e30: 2020 2020 2020 2020 2020 2a61 7267 732c            *args,
-00026e40: 202a 2a6b 7761 7267 733a 2055 7365 6420   **kwargs: Used 
-00026e50: 746f 206d 6169 6e74 6169 6e20 6675 6e63  to maintain func
-00026e60: 7469 6f6e 616c 6974 7920 616e 6420 636f  tionality and co
-00026e70: 6d70 6174 6162 696c 6974 7920 6265 7477  mpatability betw
-00026e80: 6565 6e20 6d69 6372 6f73 636f 7065 732e  een microscopes.
-00026e90: 204e 6f20 6172 6775 6d65 6e74 7320 7265   No arguments re
-00026ea0: 7175 6972 6564 2e0a 2020 2020 2020 2020  quired..        
-00026eb0: 2020 2020 0a20 2020 2020 2020 2052 756e      .        Run
-00026ec0: 7320 7468 6520 4749 5320 506c 6174 696e  s the GIS Platin
-00026ed0: 756d 2053 7075 7474 6572 2e0a 0a20 2020  um Sputter...   
-00026ee0: 2020 2020 2052 6574 7572 6e73 3a0a 2020       Returns:.  
-00026ef0: 2020 2020 2020 2020 2020 4e6f 6e65 0a20            None. 
-00026f00: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-00026f10: 2020 205f 6368 6563 6b5f 7370 7574 7465     _check_sputte
-00026f20: 7228 7365 6c66 2e68 6172 6477 6172 655f  r(self.hardware_
-00026f30: 7365 7474 696e 6773 290a 2020 2020 2020  settings).      
-00026f40: 2020 2320 4f70 656e 2047 4953 2076 616c    # Open GIS val
-00026f50: 7665 2074 6f20 6c65 7420 7468 6520 6761  ve to let the ga
-00026f60: 7320 666c 6f77 206f 6e74 6f20 7468 6520  s flow onto the 
-00026f70: 7361 6d70 6c65 0a20 2020 2020 2020 2073  sample.        s
-00026f80: 656c 662e 636f 6e6e 6563 7469 6f6e 2e47  elf.connection.G
-00026f90: 4953 2e4f 7065 6e56 616c 7665 2873 656c  IS.OpenValve(sel
-00026fa0: 662e 6c69 6e65 290a 0a20 2020 2020 2020  f.line)..       
-00026fb0: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
-00026fc0: 2020 2320 5275 6e20 7072 6564 6566 696e    # Run predefin
-00026fd0: 6564 2064 6570 6f73 6974 696f 6e20 7072  ed deposition pr
-00026fe0: 6f63 6573 730a 2020 2020 2020 2020 2020  ocess.          
-00026ff0: 2020 7365 6c66 2e63 6f6e 6e65 6374 696f    self.connectio
-00027000: 6e2e 4472 6177 4265 616d 2e53 7461 7274  n.DrawBeam.Start
-00027010: 2829 0a20 2020 2020 2020 2020 2020 2073  ().            s
-00027020: 656c 662e 636f 6e6e 6563 7469 6f6e 2e50  elf.connection.P
-00027030: 726f 6772 6573 732e 5368 6f77 2822 4472  rogress.Show("Dr
-00027040: 6177 4265 616d 222c 2022 4c61 7965 7220  awBeam", "Layer 
-00027050: 3120 696e 2070 726f 6772 6573 7322 2c20  1 in progress", 
-00027060: 4661 6c73 652c 2046 616c 7365 2c20 302c  False, False, 0,
-00027070: 2031 3030 290a 2020 2020 2020 2020 2020   100).          
-00027080: 2020 6c6f 6767 696e 672e 696e 666f 2822    logging.info("
-00027090: 5370 7574 7465 7269 6e67 2077 6974 6820  Sputtering with 
-000270a0: 706c 6174 696e 756d 2073 7461 7274 6564  platinum started
-000270b0: 2e22 290a 2020 2020 2020 2020 2020 2020  .").            
-000270c0: 7768 696c 6520 5472 7565 3a0a 2020 2020  while True:.    
-000270d0: 2020 2020 2020 2020 2020 2020 7374 6174              stat
-000270e0: 7573 203d 2073 656c 662e 636f 6e6e 6563  us = self.connec
-000270f0: 7469 6f6e 2e44 7261 7742 6561 6d2e 4765  tion.DrawBeam.Ge
-00027100: 7453 7461 7475 7328 290a 2020 2020 2020  tStatus().      
-00027110: 2020 2020 2020 2020 2020 7275 6e6e 696e            runnin
-00027120: 6720 3d20 7374 6174 7573 5b30 5d20 3d3d  g = status[0] ==
-00027130: 2073 656c 662e 636f 6e6e 6563 7469 6f6e   self.connection
-00027140: 2e44 7261 7742 6561 6d2e 5374 6174 7573  .DrawBeam.Status
-00027150: 2e50 726f 6a65 6374 4c6f 6164 6564 4578  .ProjectLoadedEx
-00027160: 706f 7369 7469 6f6e 496e 5072 6f67 7265  positionInProgre
-00027170: 7373 0a20 2020 2020 2020 2020 2020 2020  ss.             
-00027180: 2020 2069 6620 7275 6e6e 696e 673a 0a20     if running:. 
-00027190: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000271a0: 2020 2070 726f 6772 6573 7320 3d20 300a     progress = 0.
-000271b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000271c0: 2020 2020 6966 2073 7461 7475 735b 315d      if status[1]
-000271d0: 203e 2030 3a0a 2020 2020 2020 2020 2020   > 0:.          
-000271e0: 2020 2020 2020 2020 2020 2020 2020 7072                pr
-000271f0: 6f67 7265 7373 203d 206d 696e 2831 3030  ogress = min(100
-00027200: 2c20 7374 6174 7573 5b32 5d20 2f20 7374  , status[2] / st
-00027210: 6174 7573 5b31 5d20 2a20 3130 3029 0a20  atus[1] * 100). 
-00027220: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027230: 2020 2070 7269 6e74 5072 6f67 7265 7373     printProgress
-00027240: 4261 7228 7072 6f67 7265 7373 2c20 3130  Bar(progress, 10
-00027250: 3029 0a20 2020 2020 2020 2020 2020 2020  0).             
-00027260: 2020 2020 2020 2073 656c 662e 636f 6e6e         self.conn
-00027270: 6563 7469 6f6e 2e50 726f 6772 6573 732e  ection.Progress.
-00027280: 5365 7450 6572 6365 6e74 7328 7072 6f67  SetPercents(prog
-00027290: 7265 7373 290a 2020 2020 2020 2020 2020  ress).          
-000272a0: 2020 2020 2020 2020 2020 7469 6d65 2e73            time.s
-000272b0: 6c65 6570 2831 290a 2020 2020 2020 2020  leep(1).        
-000272c0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-000272d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000272e0: 2020 6966 2073 7461 7475 735b 305d 203d    if status[0] =
-000272f0: 3d20 7365 6c66 2e63 6f6e 6e65 6374 696f  = self.connectio
-00027300: 6e2e 4472 6177 4265 616d 2e53 7461 7475  n.DrawBeam.Statu
-00027310: 732e 5072 6f6a 6563 744c 6f61 6465 6445  s.ProjectLoadedE
-00027320: 7870 6f73 6974 696f 6e49 646c 653a 0a20  xpositionIdle:. 
-00027330: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027340: 2020 2020 2020 2070 7269 6e74 5072 6f67         printProg
-00027350: 7265 7373 4261 7228 3130 302c 2031 3030  ressBar(100, 100
-00027360: 2c20 7375 6666 6978 3d27 4669 6e69 7368  , suffix='Finish
-00027370: 6564 2729 0a20 2020 2020 2020 2020 2020  ed').           
-00027380: 2020 2020 2020 2020 2020 2020 2070 7269               pri
-00027390: 6e74 2827 2729 0a20 2020 2020 2020 2020  nt('').         
-000273a0: 2020 2020 2020 2020 2020 2062 7265 616b             break
-000273b0: 0a20 2020 2020 2020 2066 696e 616c 6c79  .        finally
-000273c0: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
-000273d0: 436c 6f73 6520 4749 5320 5661 6c76 6520  Close GIS Valve 
-000273e0: 696e 2062 6f74 6820 2d20 7375 6363 6573  in both - succes
-000273f0: 7320 616e 6420 6661 696c 7572 650a 2020  s and failure.  
-00027400: 2020 2020 2020 2020 2020 7365 6c66 2e63            self.c
-00027410: 6f6e 6e65 6374 696f 6e2e 4749 532e 436c  onnection.GIS.Cl
-00027420: 6f73 6556 616c 7665 2873 656c 662e 6c69  oseValve(self.li
-00027430: 6e65 290a 2020 2020 2020 2020 0a20 2020  ne).        .   
-00027440: 2064 6566 2066 696e 6973 685f 7370 7574   def finish_sput
-00027450: 7465 7228 7365 6c66 2c20 2a61 7267 732c  ter(self, *args,
-00027460: 202a 2a6b 7761 7267 7329 3a0a 2020 2020   **kwargs):.    
-00027470: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-00027480: 4669 6e69 7368 2074 6865 2073 7075 7474  Finish the sputt
-00027490: 6572 2070 726f 6365 7373 2062 7920 7265  er process by re
-000274a0: 7472 6163 7469 6e67 2074 6865 2047 4953  tracting the GIS
-000274b0: 2063 6861 6d62 6572 2061 6e64 2074 7572   chamber and tur
-000274c0: 6e69 6e67 206f 6666 2074 6865 2068 6561  ning off the hea
-000274d0: 7469 6e67 2e0a 0a20 2020 2020 2020 2041  ting...        A
-000274e0: 7267 733a 0a20 2020 2020 2020 2020 2020  rgs:.           
-000274f0: 202a 6172 6773 2c20 2a2a 6b77 6172 6773   *args, **kwargs
-00027500: 3a20 5468 6973 2072 6570 7265 7365 6e74  : This represent
-00027510: 7320 7468 6520 6172 6775 6d65 6e74 7320  s the arguments 
-00027520: 7573 6564 2062 7920 5468 6572 6d6f 4d69  used by ThermoMi
-00027530: 6372 6f73 636f 7065 2074 6861 7420 6172  croscope that ar
-00027540: 6520 6e6f 7420 7265 7175 6972 6564 2066  e not required f
-00027550: 6f72 2074 6865 2054 6573 6361 6e4d 6963  or the TescanMic
-00027560: 726f 7363 6f70 652e 0a0a 2020 2020 2020  roscope...      
-00027570: 2020 5265 7475 726e 733a 0a20 2020 2020    Returns:.     
-00027580: 2020 2020 2020 204e 6f6e 650a 0a20 2020         None..   
-00027590: 2020 2020 2052 6169 7365 733a 0a20 2020       Raises:.   
-000275a0: 2020 2020 2020 2020 204e 6f6e 650a 2020           None.  
-000275b0: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-000275c0: 2020 5f63 6865 636b 5f73 7075 7474 6572    _check_sputter
-000275d0: 2873 656c 662e 6861 7264 7761 7265 5f73  (self.hardware_s
-000275e0: 6574 7469 6e67 7329 0a20 2020 2020 2020  ettings).       
-000275f0: 2023 204d 6f76 6520 4749 5320 6f75 7420   # Move GIS out 
-00027600: 6672 6f6d 2063 6861 6d62 6572 2061 6e64  from chamber and
-00027610: 2074 7572 6e20 6f66 6620 6865 6174 696e   turn off heatin
-00027620: 670a 2020 2020 2020 2020 7365 6c66 2e63  g.        self.c
-00027630: 6f6e 6e65 6374 696f 6e2e 4749 532e 4d6f  onnection.GIS.Mo
-00027640: 7665 546f 2873 656c 662e 6c69 6e65 2c20  veTo(self.line, 
-00027650: 4175 746f 6d61 7469 6f6e 2e47 4953 2e50  Automation.GIS.P
-00027660: 6f73 6974 696f 6e2e 486f 6d65 290a 2020  osition.Home).  
-00027670: 2020 2020 2020 7365 6c66 2e63 6f6e 6e65        self.conne
-00027680: 6374 696f 6e2e 4749 532e 5072 6570 6172  ction.GIS.Prepar
-00027690: 6554 656d 7065 7261 7475 7265 2873 656c  eTemperature(sel
-000276a0: 662e 6c69 6e65 2c20 4661 6c73 6529 0a20  f.line, False). 
-000276b0: 2020 2020 2020 2073 656c 662e 636f 6e6e         self.conn
-000276c0: 6563 7469 6f6e 2e44 7261 7742 6561 6d2e  ection.DrawBeam.
-000276d0: 556e 6c6f 6164 4c61 7965 7228 290a 2020  UnloadLayer().  
-000276e0: 2020 2020 2020 6c6f 6767 696e 672e 696e        logging.in
-000276f0: 666f 2822 506c 6174 696e 756d 2073 7075  fo("Platinum spu
-00027700: 7474 6572 696e 6720 7072 6f63 6573 7320  ttering process 
-00027710: 636f 6d70 6c65 7465 642e 2229 0a0a 2020  completed.")..  
-00027720: 2020 6465 6620 7365 7475 705f 4749 5328    def setup_GIS(
-00027730: 7365 6c66 2c70 726f 746f 636f 6c29 202d  self,protocol) -
-00027740: 3e20 4e6f 6e65 3a0a 0a20 2020 2020 2020  > None:..       
-00027750: 2062 6561 6d5f 7479 7065 203d 2070 726f   beam_type = pro
-00027760: 746f 636f 6c5b 2262 6561 6d5f 7479 7065  tocol["beam_type
-00027770: 225d 0a0a 2020 2020 2020 2020 6966 2062  "]..        if b
-00027780: 6561 6d5f 7479 7065 203d 3d20 2249 4f4e  eam_type == "ION
-00027790: 223a 0a0a 0a20 2020 2020 2020 2020 2020  ":...           
-000277a0: 206c 6179 6572 5365 7474 696e 6773 203d   layerSettings =
-000277b0: 2073 656c 662e 636f 6e6e 6563 7469 6f6e   self.connection
-000277c0: 2e44 7261 7742 6561 6d2e 4c61 7965 7253  .DrawBeam.LayerS
-000277d0: 6574 7469 6e67 732e 4944 6570 6f73 6974  ettings.IDeposit
-000277e0: 696f 6e28 0a20 2020 2020 2020 2020 2020  ion(.           
-000277f0: 2020 2020 2073 796e 6357 7269 7465 4669       syncWriteFi
-00027800: 656c 643d 5472 7565 2c0a 2020 2020 2020  eld=True,.      
-00027810: 2020 2020 2020 2020 2020 7772 6974 6546            writeF
-00027820: 6965 6c64 5369 7a65 3d70 726f 746f 636f  ieldSize=protoco
-00027830: 6c2e 6765 7428 2268 6677 222c 302e 3030  l.get("hfw",0.00
-00027840: 3035 292c 0a20 2020 2020 2020 2020 2020  05),.           
-00027850: 2020 2020 2062 6561 6d43 7572 7265 6e74       beamCurrent
-00027860: 3d70 726f 746f 636f 6c2e 6765 7428 2262  =protocol.get("b
-00027870: 6561 6d5f 6375 7272 656e 7422 2c35 652d  eam_current",5e-
-00027880: 3130 292c 0a20 2020 2020 2020 2020 2020  10),.           
-00027890: 2020 2020 2073 706f 7453 697a 653d 7072       spotSize=pr
-000278a0: 6f74 6f63 6f6c 2e67 6574 2822 7370 6f74  otocol.get("spot
-000278b0: 5f73 697a 6522 2c35 2e30 652d 3829 2c0a  _size",5.0e-8),.
-000278c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000278d0: 7370 6163 696e 673d 312e 302c 0a20 2020  spacing=1.0,.   
-000278e0: 2020 2020 2020 2020 2020 2020 2072 6174               rat
-000278f0: 653d 3365 2d31 302c 2023 2056 616c 7565  e=3e-10, # Value
-00027900: 2066 6f72 2070 6c61 7469 6e75 6d0a 2020   for platinum.  
-00027910: 2020 2020 2020 2020 2020 2020 2020 6477                dw
-00027920: 656c 6c54 696d 653d 7072 6f74 6f63 6f6c  ellTime=protocol
-00027930: 2e67 6574 2822 6477 656c 6c5f 7469 6d65  .get("dwell_time
-00027940: 222c 312e 3065 2d36 292c 0a20 2020 2020  ",1.0e-6),.     
-00027950: 2020 2020 2020 2020 2020 2070 7265 7365             prese
-00027960: 743d 4e6f 6e65 2c0a 2020 2020 2020 2020  t=None,.        
-00027970: 2020 2020 2020 2020 7061 7261 6c6c 656c          parallel
-00027980: 3d46 616c 7365 2c0a 2020 2020 2020 2020  =False,.        
-00027990: 2020 2020 2020 2020 6d61 7465 7269 616c          material
-000279a0: 3d27 4465 6661 756c 7420 4d61 7465 7269  ='Default Materi
-000279b0: 616c 272c 0a20 2020 2020 2020 2020 2020  al',.           
-000279c0: 2020 2020 2067 6973 5072 6563 7572 736f       gisPrecurso
-000279d0: 723d 4e6f 6e65 2c0a 0a20 2020 2020 2020  r=None,..       
-000279e0: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
-000279f0: 656c 7365 3a0a 0a0a 2020 2020 2020 2020  else:...        
-00027a00: 2020 2020 6c61 7965 7253 6574 7469 6e67      layerSetting
-00027a10: 7320 3d20 7365 6c66 2e63 6f6e 6e65 6374  s = self.connect
-00027a20: 696f 6e2e 4472 6177 4265 616d 2e4c 6179  ion.DrawBeam.Lay
-00027a30: 6572 5365 7474 696e 6773 2e45 4465 706f  erSettings.EDepo
-00027a40: 7369 7469 6f6e 280a 2020 2020 2020 2020  sition(.        
-00027a50: 2020 2020 2020 2020 7379 6e63 5772 6974          syncWrit
-00027a60: 6546 6965 6c64 3d54 7275 652c 0a20 2020  eField=True,.   
-00027a70: 2020 2020 2020 2020 2020 2020 2077 7269               wri
-00027a80: 7465 4669 656c 6453 697a 653d 7072 6f74  teFieldSize=prot
-00027a90: 6f63 6f6c 2e67 6574 2822 6866 7722 2c30  ocol.get("hfw",0
-00027aa0: 2e30 3030 3529 2c0a 2020 2020 2020 2020  .0005),.        
-00027ab0: 2020 2020 2020 2020 6265 616d 4375 7272          beamCurr
-00027ac0: 656e 743d 7072 6f74 6f63 6f6c 2e67 6574  ent=protocol.get
-00027ad0: 2822 6265 616d 5f63 7572 7265 6e74 222c  ("beam_current",
-00027ae0: 3565 2d31 3029 2c0a 2020 2020 2020 2020  5e-10),.        
-00027af0: 2020 2020 2020 2020 7370 6f74 5369 7a65          spotSize
-00027b00: 3d70 726f 746f 636f 6c2e 6765 7428 2273  =protocol.get("s
-00027b10: 706f 745f 7369 7a65 222c 352e 3065 2d38  pot_size",5.0e-8
-00027b20: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
-00027b30: 2020 2072 6174 653d 3365 2d31 302c 2023     rate=3e-10, #
-00027b40: 2056 616c 7565 2066 6f72 2070 6c61 7469   Value for plati
-00027b50: 6e75 6d0a 2020 2020 2020 2020 2020 2020  num.            
-00027b60: 2020 2020 7370 6163 696e 673d 312e 302c      spacing=1.0,
-00027b70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00027b80: 2064 7765 6c6c 5469 6d65 3d70 726f 746f   dwellTime=proto
-00027b90: 636f 6c2e 6765 7428 2264 7765 6c6c 5f74  col.get("dwell_t
-00027ba0: 696d 6522 2c31 2e30 652d 3629 2c0a 2020  ime",1.0e-6),.  
-00027bb0: 2020 2020 2020 2020 2020 2020 2020 7072                pr
-00027bc0: 6573 6574 3d4e 6f6e 652c 0a20 2020 2020  eset=None,.     
-00027bd0: 2020 2020 2020 2020 2020 2070 6172 616c             paral
-00027be0: 6c65 6c3d 4661 6c73 652c 0a20 2020 2020  lel=False,.     
-00027bf0: 2020 2020 2020 2020 2020 206d 6174 6572             mater
-00027c00: 6961 6c3d 2744 6566 6175 6c74 204d 6174  ial='Default Mat
-00027c10: 6572 6961 6c27 2c0a 2020 2020 2020 2020  erial',.        
-00027c20: 2020 2020 2020 2020 6769 7350 7265 6375          gisPrecu
-00027c30: 7273 6f72 3d4e 6f6e 652c 0a20 2020 2020  rsor=None,.     
-00027c40: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00027c50: 2073 656c 662e 6769 735f 6c61 7965 7220   self.gis_layer 
-00027c60: 3d20 7365 6c66 2e63 6f6e 6e65 6374 696f  = self.connectio
-00027c70: 6e2e 4472 6177 4265 616d 2e4c 6179 6572  n.DrawBeam.Layer
-00027c80: 2822 4c61 7965 725f 4749 5322 2c20 6c61  ("Layer_GIS", la
-00027c90: 7965 7253 6574 7469 6e67 7329 0a0a 0a20  yerSettings)... 
-00027ca0: 2020 2020 2020 206c 6f67 6769 6e67 2e69         logging.i
-00027cb0: 6e66 6f28 6622 4749 5320 5365 7475 7020  nfo(f"GIS Setup 
-00027cc0: 436f 6d70 6c65 7465 2c20 7b62 6561 6d5f  Complete, {beam_
-00027cd0: 7479 7065 7d20 6c61 7965 7220 7365 7474  type} layer sett
-00027ce0: 696e 6773 206c 6f61 6465 6422 290a 0a20  ings loaded").. 
-00027cf0: 2020 2064 6566 2073 6574 7570 5f47 4953     def setup_GIS
-00027d00: 5f70 6174 7465 726e 2873 656c 662c 7072  _pattern(self,pr
-00027d10: 6f74 6f63 6f6c 293a 0a0a 2020 2020 2020  otocol):..      
-00027d20: 2020 6866 7720 3d20 7072 6f74 6f63 6f6c    hfw = protocol
-00027d30: 5b22 6866 7722 5d0a 2020 2020 2020 2020  ["hfw"].        
-00027d40: 6c69 6e65 5f70 6174 7465 726e 5f6c 656e  line_pattern_len
-00027d50: 6774 6820 3d20 7072 6f74 6f63 6f6c 5b22  gth = protocol["
-00027d60: 6c65 6e67 7468 225d 0a0a 0a20 2020 2020  length"]...     
-00027d70: 2020 2073 7461 7274 5f78 3d2d 6c69 6e65     start_x=-line
-00027d80: 5f70 6174 7465 726e 5f6c 656e 6774 682f  _pattern_length/
-00027d90: 3220 0a20 2020 2020 2020 2073 7461 7274  2 .        start
-00027da0: 5f79 3d2b 6c69 6e65 5f70 6174 7465 726e  _y=+line_pattern
-00027db0: 5f6c 656e 6774 680a 2020 2020 2020 2020  _length.        
-00027dc0: 656e 645f 783d 2b6c 696e 655f 7061 7474  end_x=+line_patt
-00027dd0: 6572 6e5f 6c65 6e67 7468 2f32 0a20 2020  ern_length/2.   
-00027de0: 2020 2020 2065 6e64 5f79 3d2b 6c69 6e65       end_y=+line
-00027df0: 5f70 6174 7465 726e 5f6c 656e 6774 680a  _pattern_length.
-00027e00: 2020 2020 2020 2020 6465 7074 683d 3265          depth=2e
-00027e10: 2d36 0a0a 2020 2020 2020 2020 7365 6c66  -6..        self
-00027e20: 2e67 6973 5f6c 6179 6572 2e61 6464 4c69  .gis_layer.addLi
-00027e30: 6e65 280a 2020 2020 2020 2020 2020 2020  ne(.            
-00027e40: 4265 6769 6e58 3d73 7461 7274 5f78 2c0a  BeginX=start_x,.
-00027e50: 2020 2020 2020 2020 2020 2020 4265 6769              Begi
-00027e60: 6e59 3d73 7461 7274 5f79 2c0a 2020 2020  nY=start_y,.    
-00027e70: 2020 2020 2020 2020 456e 6458 3d65 6e64          EndX=end
-00027e80: 5f78 2c0a 2020 2020 2020 2020 2020 2020  _x,.            
-00027e90: 456e 6459 3d65 6e64 5f79 2c0a 2020 2020  EndY=end_y,.    
-00027ea0: 2020 2020 2020 2020 4465 7074 683d 3365          Depth=3e
-00027eb0: 2d30 362c 0a0a 2020 2020 2020 2020 290a  -06,..        ).
-00027ec0: 0a20 2020 2020 2020 2073 656c 662e 636f  .        self.co
-00027ed0: 6e6e 6563 7469 6f6e 2e44 7261 7742 6561  nnection.DrawBea
-00027ee0: 6d2e 4c6f 6164 4c61 7965 7228 7365 6c66  m.LoadLayer(self
-00027ef0: 2e67 6973 5f6c 6179 6572 290a 2020 2020  .gis_layer).    
-00027f00: 2020 2020 6c6f 6767 696e 672e 696e 666f      logging.info
-00027f10: 2866 2247 4953 2050 6174 7465 726e 2053  (f"GIS Pattern S
-00027f20: 6574 7570 2043 6f6d 706c 6574 6522 290a  etup Complete").
-00027f30: 0a20 2020 2064 6566 2072 756e 5f47 4953  .    def run_GIS
-00027f40: 2873 656c 662c 7072 6f74 6f63 6f6c 2920  (self,protocol) 
-00027f50: 2d3e 204e 6f6e 653a 0a0a 0a20 2020 2020  -> None:...     
-00027f60: 2020 2067 6173 5f6c 696e 6520 3d20 7365     gas_line = se
-00027f70: 6c66 2e6c 696e 6573 5b70 726f 746f 636f  lf.lines[protoco
-00027f80: 6c5b 2767 6173 275d 5d0a 0a20 2020 2020  l['gas']]..     
-00027f90: 2020 2074 7279 3a0a 0a20 2020 2020 2020     try:..       
-00027fa0: 2020 2020 2073 656c 662e 636f 6e6e 6563       self.connec
-00027fb0: 7469 6f6e 2e47 4953 2e4f 7065 6e56 616c  tion.GIS.OpenVal
-00027fc0: 7665 2867 6173 5f6c 696e 6529 0a0a 2020  ve(gas_line)..  
-00027fd0: 2020 2020 2020 6578 6365 7074 2045 7863        except Exc
-00027fe0: 6570 7469 6f6e 2061 7320 653a 0a20 2020  eption as e:.   
-00027ff0: 2020 2020 2020 2020 2069 6620 652e 6172           if e.ar
-00028000: 6773 5b30 5d20 3d3d 2027 4572 726f 722e  gs[0] == 'Error.
-00028010: 4f75 7467 6173 5265 7175 6972 6564 273a  OutgasRequired':
-00028020: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00028030: 206c 6f67 6769 6e67 2e69 6e66 6f28 224f   logging.info("O
-00028040: 7574 6761 7373 696e 6720 7265 7175 6972  utgassing requir
-00028050: 6564 2e22 290a 2020 2020 2020 2020 2020  ed.").          
-00028060: 2020 2020 2020 6c6f 6767 696e 672e 696e        logging.in
-00028070: 666f 2866 224f 7574 6761 7373 696e 6720  fo(f"Outgassing 
-00028080: 7b70 726f 746f 636f 6c5b 2767 6173 275d  {protocol['gas']
-00028090: 7d20 4c69 6e65 2229 0a20 2020 2020 2020  } Line").       
-000280a0: 2020 2020 2020 2020 2073 656c 662e 636f           self.co
-000280b0: 6e6e 6563 7469 6f6e 2e47 4953 2e4f 7574  nnection.GIS.Out
-000280c0: 6761 7328 6761 735f 6c69 6e65 290a 2020  gas(gas_line).  
-000280d0: 2020 2020 2020 2020 2020 2020 2020 7365                se
-000280e0: 6c66 2e63 6f6e 6e65 6374 696f 6e2e 4749  lf.connection.GI
-000280f0: 532e 4f70 656e 5661 6c76 6528 6761 735f  S.OpenValve(gas_
-00028100: 6c69 6e65 290a 0a20 2020 2020 2020 2076  line)..        v
-00028110: 616c 7665 5f6f 7065 6e20 3d20 7365 6c66  alve_open = self
-00028120: 2e63 6f6e 6e65 6374 696f 6e2e 4749 532e  .connection.GIS.
-00028130: 4765 7456 616c 7665 5374 6174 7573 2867  GetValveStatus(g
-00028140: 6173 5f6c 696e 6529 0a0a 2020 2020 2020  as_line)..      
-00028150: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
-00028160: 2020 2023 2052 756e 2070 7265 6465 6669     # Run predefi
-00028170: 6e65 6420 6465 706f 7369 7469 6f6e 2070  ned deposition p
-00028180: 726f 6365 7373 0a20 2020 2020 2020 2020  rocess.         
-00028190: 2020 2073 656c 662e 636f 6e6e 6563 7469     self.connecti
-000281a0: 6f6e 2e44 7261 7742 6561 6d2e 5374 6172  on.DrawBeam.Star
-000281b0: 7428 290a 2020 2020 2020 2020 2020 2020  t().            
-000281c0: 7365 6c66 2e63 6f6e 6e65 6374 696f 6e2e  self.connection.
-000281d0: 5072 6f67 7265 7373 2e53 686f 7728 2244  Progress.Show("D
-000281e0: 7261 7742 6561 6d22 2c20 224c 6179 6572  rawBeam", "Layer
-000281f0: 2031 2069 6e20 7072 6f67 7265 7373 222c   1 in progress",
-00028200: 2046 616c 7365 2c20 4661 6c73 652c 2030   False, False, 0
-00028210: 2c20 3130 3029 0a20 2020 2020 2020 2020  , 100).         
-00028220: 2020 206c 6f67 6769 6e67 2e69 6e66 6f28     logging.info(
-00028230: 2253 7075 7474 6572 696e 6720 7374 6172  "Sputtering star
-00028240: 7465 642e 2229 0a20 2020 2020 2020 2020  ted.").         
-00028250: 2020 2077 6869 6c65 2054 7275 653a 0a20     while True:. 
-00028260: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00028270: 7461 7475 7320 3d20 7365 6c66 2e63 6f6e  tatus = self.con
-00028280: 6e65 6374 696f 6e2e 4472 6177 4265 616d  nection.DrawBeam
-00028290: 2e47 6574 5374 6174 7573 2829 0a20 2020  .GetStatus().   
-000282a0: 2020 2020 2020 2020 2020 2020 2072 756e               run
-000282b0: 6e69 6e67 203d 2073 7461 7475 735b 305d  ning = status[0]
-000282c0: 203d 3d20 7365 6c66 2e63 6f6e 6e65 6374   == self.connect
-000282d0: 696f 6e2e 4472 6177 4265 616d 2e53 7461  ion.DrawBeam.Sta
-000282e0: 7475 732e 5072 6f6a 6563 744c 6f61 6465  tus.ProjectLoade
-000282f0: 6445 7870 6f73 6974 696f 6e49 6e50 726f  dExpositionInPro
-00028300: 6772 6573 730a 2020 2020 2020 2020 2020  gress.          
-00028310: 2020 2020 2020 6966 2072 756e 6e69 6e67        if running
-00028320: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00028330: 2020 2020 2020 7072 6f67 7265 7373 203d        progress =
-00028340: 2030 0a20 2020 2020 2020 2020 2020 2020   0.             
-00028350: 2020 2020 2020 2069 6620 7374 6174 7573         if status
-00028360: 5b31 5d20 3e20 303a 0a20 2020 2020 2020  [1] > 0:.       
-00028370: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028380: 2070 726f 6772 6573 7320 3d20 6d69 6e28   progress = min(
-00028390: 3130 302c 2073 7461 7475 735b 325d 202f  100, status[2] /
-000283a0: 2073 7461 7475 735b 315d 202a 2031 3030   status[1] * 100
-000283b0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-000283c0: 2020 2020 2020 7072 696e 7450 726f 6772        printProgr
-000283d0: 6573 7342 6172 2870 726f 6772 6573 732c  essBar(progress,
-000283e0: 2031 3030 290a 2020 2020 2020 2020 2020   100).          
-000283f0: 2020 2020 2020 2020 2020 7365 6c66 2e63            self.c
-00028400: 6f6e 6e65 6374 696f 6e2e 5072 6f67 7265  onnection.Progre
-00028410: 7373 2e53 6574 5065 7263 656e 7473 2870  ss.SetPercents(p
-00028420: 726f 6772 6573 7329 0a20 2020 2020 2020  rogress).       
-00028430: 2020 2020 2020 2020 2020 2020 2074 696d               tim
-00028440: 652e 736c 6565 7028 3129 0a20 2020 2020  e.sleep(1).     
-00028450: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-00028460: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00028470: 2020 2020 2069 6620 7374 6174 7573 5b30       if status[0
-00028480: 5d20 3d3d 2073 656c 662e 636f 6e6e 6563  ] == self.connec
-00028490: 7469 6f6e 2e44 7261 7742 6561 6d2e 5374  tion.DrawBeam.St
-000284a0: 6174 7573 2e50 726f 6a65 6374 4c6f 6164  atus.ProjectLoad
-000284b0: 6564 4578 706f 7369 7469 6f6e 4964 6c65  edExpositionIdle
-000284c0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000284d0: 2020 2020 2020 2020 2020 7072 696e 7450            printP
-000284e0: 726f 6772 6573 7342 6172 2831 3030 2c20  rogressBar(100, 
-000284f0: 3130 302c 2073 7566 6669 783d 2746 696e  100, suffix='Fin
-00028500: 6973 6865 6427 290a 2020 2020 2020 2020  ished').        
-00028510: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028520: 7072 696e 7428 2727 290a 2020 2020 2020  print('').      
-00028530: 2020 2020 2020 2020 2020 2020 2020 6272                br
-00028540: 6561 6b0a 2020 2020 2020 2020 6669 6e61  eak.        fina
-00028550: 6c6c 793a 0a20 2020 2020 2020 2020 2020  lly:.           
-00028560: 2023 2043 6c6f 7365 2047 4953 2056 616c   # Close GIS Val
-00028570: 7665 2069 6e20 626f 7468 202d 2073 7563  ve in both - suc
-00028580: 6365 7373 2061 6e64 2066 6169 6c75 7265  cess and failure
-00028590: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-000285a0: 7661 6c76 655f 6f70 656e 3a0a 2020 2020  valve_open:.    
-000285b0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-000285c0: 2e63 6f6e 6e65 6374 696f 6e2e 4749 532e  .connection.GIS.
-000285d0: 436c 6f73 6556 616c 7665 2867 6173 5f6c  CloseValve(gas_l
-000285e0: 696e 6529 0a0a 2020 2020 2020 2020 7365  ine)..        se
-000285f0: 6c66 2e63 6f6e 6e65 6374 696f 6e2e 4749  lf.connection.GI
-00028600: 532e 4d6f 7665 546f 2867 6173 5f6c 696e  S.MoveTo(gas_lin
-00028610: 652c 2041 7574 6f6d 6174 696f 6e2e 4749  e, Automation.GI
-00028620: 532e 506f 7369 7469 6f6e 2e48 6f6d 6529  S.Position.Home)
-00028630: 0a20 2020 2020 2020 2023 2073 656c 662e  .        # self.
-00028640: 636f 6e6e 6563 7469 6f6e 2e47 4953 2e50  connection.GIS.P
-00028650: 7265 7061 7265 5465 6d70 6572 6174 7572  repareTemperatur
-00028660: 6528 6761 735f 6c69 6e65 2c20 4661 6c73  e(gas_line, Fals
-00028670: 6529 0a20 2020 2020 2020 2073 656c 662e  e).        self.
-00028680: 636f 6e6e 6563 7469 6f6e 2e44 7261 7742  connection.DrawB
-00028690: 6561 6d2e 556e 6c6f 6164 4c61 7965 7228  eam.UnloadLayer(
-000286a0: 290a 2020 2020 2020 2020 6c6f 6767 696e  ).        loggin
-000286b0: 672e 696e 666f 2822 7072 6f63 6573 7320  g.info("process 
-000286c0: 636f 6d70 6c65 7465 642e 2229 0a0a 0a20  completed.")... 
-000286d0: 2020 2064 6566 2047 4953 5f61 7661 696c     def GIS_avail
-000286e0: 6162 6c65 5f6c 696e 6573 2873 656c 6629  able_lines(self)
-000286f0: 202d 3e20 6c69 7374 5b73 7472 5d3a 0a20   -> list[str]:. 
-00028700: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-00028710: 2020 2052 6574 7572 6e73 2061 206c 6973     Returns a lis
-00028720: 7420 6f66 2061 7661 696c 6162 6c65 2047  t of available G
-00028730: 4953 206c 696e 6573 2e0a 2020 2020 2020  IS lines..      
-00028740: 2020 4172 6773 3a0a 2020 2020 2020 2020    Args:.        
-00028750: 2020 2020 4e6f 6e65 0a20 2020 2020 2020      None.       
-00028760: 2052 6574 7572 6e73 3a0a 2020 2020 2020   Returns:.      
-00028770: 2020 2020 2020 4120 6469 6374 696f 6e61        A dictiona
-00028780: 7279 206f 6620 6176 6169 6c61 626c 6520  ry of available 
-00028790: 4749 5320 6c69 6e65 732e 0a20 2020 2020  GIS lines..     
-000287a0: 2020 2022 2222 0a20 2020 2020 2020 205f     """.        _
-000287b0: 6368 6563 6b5f 7370 7574 7465 7228 7365  check_sputter(se
-000287c0: 6c66 2e68 6172 6477 6172 655f 7365 7474  lf.hardware_sett
-000287d0: 696e 6773 290a 2020 2020 2020 2020 4749  ings).        GI
-000287e0: 535f 6c69 6e65 7320 3d20 7365 6c66 2e63  S_lines = self.c
-000287f0: 6f6e 6e65 6374 696f 6e2e 4749 532e 456e  onnection.GIS.En
-00028800: 756d 2829 0a20 2020 2020 2020 2073 656c  um().        sel
-00028810: 662e 6c69 6e65 7320 3d20 7b7d 0a20 2020  f.lines = {}.   
-00028820: 2020 2020 206c 696e 655f 6e61 6d65 7320       line_names 
-00028830: 3d20 5b5d 0a20 2020 2020 2020 2066 6f72  = [].        for
-00028840: 206c 696e 6520 696e 2047 4953 5f6c 696e   line in GIS_lin
-00028850: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
-00028860: 7365 6c66 2e6c 696e 6573 5b6c 696e 652e  self.lines[line.
-00028870: 6e61 6d65 5d20 3d20 6c69 6e65 0a20 2020  name] = line.   
-00028880: 2020 2020 2020 2020 206c 696e 655f 6e61           line_na
-00028890: 6d65 732e 6170 7065 6e64 286c 696e 652e  mes.append(line.
-000288a0: 6e61 6d65 290a 0a20 2020 2020 2020 2072  name)..        r
-000288b0: 6574 7572 6e20 6c69 6e65 5f6e 616d 6573  eturn line_names
-000288c0: 0a0a 2020 2020 6465 6620 4749 535f 706f  ..    def GIS_po
-000288d0: 7369 7469 6f6e 2873 656c 662c 6c69 6e65  sition(self,line
-000288e0: 5f6e 616d 653a 7374 7229 202d 3e20 7374  _name:str) -> st
-000288f0: 723a 0a20 2020 2020 2020 205f 6368 6563  r:.        _chec
-00028900: 6b5f 7370 7574 7465 7228 7365 6c66 2e68  k_sputter(self.h
-00028910: 6172 6477 6172 655f 7365 7474 696e 6773  ardware_settings
-00028920: 290a 0a20 2020 2020 2020 206c 696e 6520  )..        line 
-00028930: 3d20 7365 6c66 2e6c 696e 6573 5b6c 696e  = self.lines[lin
-00028940: 655f 6e61 6d65 5d0a 0a20 2020 2020 2020  e_name]..       
-00028950: 2070 6f73 6974 696f 6e20 3d20 7365 6c66   position = self
-00028960: 2e63 6f6e 6e65 6374 696f 6e2e 4749 532e  .connection.GIS.
-00028970: 4765 7450 6f73 6974 696f 6e28 6c69 6e65  GetPosition(line
-00028980: 290a 0a20 2020 2020 2020 2072 6574 7572  )..        retur
-00028990: 6e20 706f 7369 7469 6f6e 2e6e 616d 650a  n position.name.
-000289a0: 0a20 2020 2064 6566 2047 4953 5f61 7661  .    def GIS_ava
-000289b0: 696c 6162 6c65 5f70 6f73 6974 696f 6e73  ilable_positions
-000289c0: 2873 656c 6629 202d 3e20 6c69 7374 5b73  (self) -> list[s
-000289d0: 7472 5d3a 0a0a 2020 2020 2020 2020 5f63  tr]:..        _c
-000289e0: 6865 636b 5f73 7075 7474 6572 2873 656c  heck_sputter(sel
-000289f0: 662e 6861 7264 7761 7265 5f73 6574 7469  f.hardware_setti
-00028a00: 6e67 7329 0a20 2020 2020 2020 2073 656c  ngs).        sel
-00028a10: 662e 4749 535f 706f 7369 7469 6f6e 7320  f.GIS_positions 
-00028a20: 3d20 7365 6c66 2e63 6f6e 6e65 6374 696f  = self.connectio
-00028a30: 6e2e 4749 532e 506f 7369 7469 6f6e 0a0a  n.GIS.Position..
-00028a40: 2020 2020 2020 2020 7265 7475 726e 2073          return s
-00028a50: 656c 662e 4749 535f 706f 7369 7469 6f6e  elf.GIS_position
-00028a60: 732e 5f5f 6d65 6d62 6572 735f 5f2e 6b65  s.__members__.ke
-00028a70: 7973 2829 0a0a 2020 2020 6465 6620 4749  ys()..    def GI
-00028a80: 535f 6d6f 7665 5f74 6f28 7365 6c66 2c6c  S_move_to(self,l
-00028a90: 696e 655f 6e61 6d65 2c70 6f73 6974 696f  ine_name,positio
-00028aa0: 6e29 202d 3e20 4e6f 6e65 3a0a 0a20 2020  n) -> None:..   
-00028ab0: 2020 2020 205f 6368 6563 6b5f 7370 7574       _check_sput
-00028ac0: 7465 7228 7365 6c66 2e68 6172 6477 6172  ter(self.hardwar
-00028ad0: 655f 7365 7474 696e 6773 290a 0a20 2020  e_settings)..   
-00028ae0: 2020 2020 206c 696e 6520 3d20 7365 6c66       line = self
-00028af0: 2e6c 696e 6573 5b6c 696e 655f 6e61 6d65  .lines[line_name
-00028b00: 5d0a 0a20 2020 2020 2020 2073 656c 662e  ]..        self.
-00028b10: 636f 6e6e 6563 7469 6f6e 2e47 4953 2e4d  connection.GIS.M
-00028b20: 6f76 6554 6f28 6c69 6e65 2c73 656c 662e  oveTo(line,self.
-00028b30: 4749 535f 706f 7369 7469 6f6e 735b 706f  GIS_positions[po
-00028b40: 7369 7469 6f6e 5d29 0a0a 2020 2020 6465  sition])..    de
-00028b50: 6620 4749 535f 6865 6174 5f75 7028 7365  f GIS_heat_up(se
-00028b60: 6c66 2c6c 696e 655f 6e61 6d65 293a 0a0a  lf,line_name):..
-00028b70: 2020 2020 2020 2020 5f63 6865 636b 5f73          _check_s
-00028b80: 7075 7474 6572 2873 656c 662e 6861 7264  putter(self.hard
-00028b90: 7761 7265 5f73 6574 7469 6e67 7329 0a0a  ware_settings)..
-00028ba0: 2020 2020 2020 2020 6c69 6e65 203d 2073          line = s
-00028bb0: 656c 662e 6c69 6e65 735b 6c69 6e65 5f6e  elf.lines[line_n
-00028bc0: 616d 655d 0a0a 2020 2020 2020 2020 7365  ame]..        se
-00028bd0: 6c66 2e63 6f6e 6e65 6374 696f 6e2e 4749  lf.connection.GI
-00028be0: 532e 5072 6570 6172 6554 656d 7065 7261  S.PrepareTempera
-00028bf0: 7475 7265 286c 696e 652c 5472 7565 290a  ture(line,True).
-00028c00: 0a20 2020 2020 2020 2073 656c 662e 636f  .        self.co
-00028c10: 6e6e 6563 7469 6f6e 2e47 4953 2e57 6169  nnection.GIS.Wai
-00028c20: 7446 6f72 5465 6d70 6572 6174 7572 6552  tForTemperatureR
-00028c30: 6561 6479 286c 696e 6529 0a0a 2020 2020  eady(line)..    
-00028c40: 2020 2020 7469 6d65 2e73 6c65 6570 2835      time.sleep(5
-00028c50: 290a 0a20 2020 2064 6566 2047 4953 5f74  )..    def GIS_t
-00028c60: 656d 705f 7265 6164 7928 7365 6c66 2c6c  emp_ready(self,l
-00028c70: 696e 655f 6e61 6d65 293a 0a0a 2020 2020  ine_name):..    
-00028c80: 2020 2020 5f63 6865 636b 5f73 7075 7474      _check_sputt
-00028c90: 6572 2873 656c 662e 6861 7264 7761 7265  er(self.hardware
-00028ca0: 5f73 6574 7469 6e67 7329 0a0a 2020 2020  _settings)..    
-00028cb0: 2020 2020 6c69 6e65 203d 2073 656c 662e      line = self.
-00028cc0: 6c69 6e65 735b 6c69 6e65 5f6e 616d 655d  lines[line_name]
-00028cd0: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
-00028ce0: 2073 656c 662e 636f 6e6e 6563 7469 6f6e   self.connection
-00028cf0: 2e47 4953 2e47 6574 5465 6d70 6572 6174  .GIS.GetTemperat
-00028d00: 7572 6552 6561 6479 286c 696e 6529 0a0a  ureReady(line)..
-00028d10: 2020 2020 6465 6620 7365 745f 6d69 6372      def set_micr
-00028d20: 6f73 636f 7065 5f73 7461 7465 2873 656c  oscope_state(sel
-00028d30: 662c 206d 6963 726f 7363 6f70 655f 7374  f, microscope_st
-00028d40: 6174 653a 204d 6963 726f 7363 6f70 6553  ate: MicroscopeS
-00028d50: 7461 7465 293a 0a20 2020 2020 2020 2022  tate):.        "
-00028d60: 2222 5265 7365 7420 7468 6520 6d69 6372  ""Reset the micr
-00028d70: 6f73 636f 7065 2073 7461 7465 2074 6f20  oscope state to 
-00028d80: 7468 6520 7072 6f76 6964 6564 2073 7461  the provided sta
-00028d90: 7465 2e0a 0a20 2020 2020 2020 2041 7267  te...        Arg
-00028da0: 733a 0a20 2020 2020 2020 2020 2020 206d  s:.            m
-00028db0: 6963 726f 7363 6f70 655f 7374 6174 6520  icroscope_state 
-00028dc0: 284d 6963 726f 7363 6f70 6553 7461 7465  (MicroscopeState
-00028dd0: 293a 2041 2060 4d69 6372 6f73 636f 7065  ): A `Microscope
-00028de0: 5374 6174 6560 206f 626a 6563 7420 7468  State` object th
-00028df0: 6174 2063 6f6e 7461 696e 7320 7468 6520  at contains the 
-00028e00: 6465 7369 7265 6420 7374 6174 6520 6f66  desired state of
-00028e10: 2074 6865 206d 6963 726f 7363 6f70 652e   the microscope.
-00028e20: 0a0a 2020 2020 2020 2020 5265 7475 726e  ..        Return
-00028e30: 733a 0a20 2020 2020 2020 2020 2020 204e  s:.            N
-00028e40: 6f6e 652e 0a0a 2020 2020 2020 2020 5261  one...        Ra
-00028e50: 6973 6573 3a0a 2020 2020 2020 2020 2020  ises:.          
-00028e60: 2020 4e6f 6e65 2e0a 0a20 2020 2020 2020    None...       
-00028e70: 204e 6f74 6573 3a0a 2020 2020 2020 2020   Notes:.        
-00028e80: 2020 2020 5468 6973 2066 756e 6374 696f      This functio
-00028e90: 6e20 7265 7374 6f72 6573 2074 6865 206d  n restores the m
-00028ea0: 6963 726f 7363 6f70 6520 7374 6174 6520  icroscope state 
-00028eb0: 746f 2074 6865 2070 726f 7669 6465 6420  to the provided 
-00028ec0: 7374 6174 652e 2054 6869 7320 6675 6e63  state. This func
-00028ed0: 7469 6f6e 2063 616e 6e6f 7420 6265 2066  tion cannot be f
-00028ee0: 756c 6c79 2069 6d70 6c65 6d65 6e74 6564  ully implemented
-00028ef0: 2061 7320 7468 6569 7220 6172 6520 6365   as their are ce
-00028f00: 7274 6169 6e20 6173 7065 6374 7320 6f66  rtain aspects of
-00028f10: 0a20 2020 2020 2020 2020 2020 2074 6865  .            the
-00028f20: 2073 7461 7465 2074 6861 7420 6361 6e6e   state that cann
-00028f30: 6f74 2062 6520 7365 7420 666f 7220 7468  ot be set for th
-00028f40: 6520 5445 5343 414e 206d 6963 726f 7363  e TESCAN microsc
-00028f50: 6f70 6520 6279 2074 6865 2054 4553 4341  ope by the TESCA
-00028f60: 4e20 4175 746f 6d61 7469 6f6e 2041 5049  N Automation API
-00028f70: 2e0a 2020 2020 2020 2020 2222 220a 0a20  ..        """.. 
-00028f80: 2020 2020 2020 206c 6f67 6769 6e67 2e69         logging.i
-00028f90: 6e66 6f28 6622 7265 7374 6f72 696e 6720  nfo(f"restoring 
-00028fa0: 6d69 6372 6f73 636f 7065 2073 7461 7465  microscope state
-00028fb0: 2e2e 2e22 290a 0a20 2020 2020 2020 2023  ...")..        #
-00028fc0: 206d 6f76 6520 746f 2070 6f73 6974 696f   move to positio
-00028fd0: 6e0a 2020 2020 2020 2020 5f63 6865 636b  n.        _check
-00028fe0: 5f73 7461 6765 2873 656c 662e 6861 7264  _stage(self.hard
-00028ff0: 7761 7265 5f73 6574 7469 6e67 7329 0a20  ware_settings). 
-00029000: 2020 2020 2020 2073 656c 662e 6d6f 7665         self.move
-00029010: 5f73 7461 6765 5f61 6273 6f6c 7574 6528  _stage_absolute(
-00029020: 706f 7369 7469 6f6e 3d6d 6963 726f 7363  position=microsc
-00029030: 6f70 655f 7374 6174 652e 6162 736f 6c75  ope_state.absolu
-00029040: 7465 5f70 6f73 6974 696f 6e29 0a0a 2020  te_position)..  
-00029050: 2020 2020 2020 2320 7265 7374 6f72 6520        # restore 
-00029060: 656c 6563 7472 6f6e 2062 6561 6d0a 2020  electron beam.  
-00029070: 2020 2020 2020 5f63 6865 636b 5f62 6561        _check_bea
-00029080: 6d28 4265 616d 5479 7065 2e45 4c45 4354  m(BeamType.ELECT
-00029090: 524f 4e2c 2073 656c 662e 6861 7264 7761  RON, self.hardwa
-000290a0: 7265 5f73 6574 7469 6e67 7329 0a20 2020  re_settings).   
-000290b0: 2020 2020 206c 6f67 6769 6e67 2e69 6e66       logging.inf
-000290c0: 6f28 6622 7265 7374 6f72 696e 6720 656c  o(f"restoring el
-000290d0: 6563 7472 6f6e 2062 6561 6d20 7365 7474  ectron beam sett
-000290e0: 696e 6773 2e2e 2e22 290a 2020 2020 2020  ings...").      
-000290f0: 2020 7365 6c66 2e63 6f6e 6e65 6374 696f    self.connectio
-00029100: 6e2e 5345 4d2e 4f70 7469 6373 2e53 6574  n.SEM.Optics.Set
-00029110: 5744 280a 2020 2020 2020 2020 2020 2020  WD(.            
-00029120: 6d69 6372 6f73 636f 7065 5f73 7461 7465  microscope_state
-00029130: 2e65 625f 7365 7474 696e 6773 2e77 6f72  .eb_settings.wor
-00029140: 6b69 6e67 5f64 6973 7461 6e63 650a 2020  king_distance.  
-00029150: 2020 2020 2020 2020 2020 2a20 636f 6e73            * cons
-00029160: 7461 6e74 732e 4d45 5452 455f 544f 5f4d  tants.METRE_TO_M
-00029170: 494c 4c49 4d45 5452 450a 2020 2020 2020  ILLIMETRE.      
-00029180: 2020 290a 0a20 2020 2020 2020 2073 656c    )..        sel
-00029190: 662e 636f 6e6e 6563 7469 6f6e 2e53 454d  f.connection.SEM
-000291a0: 2e42 6561 6d2e 5365 7443 7572 7265 6e74  .Beam.SetCurrent
-000291b0: 280a 2020 2020 2020 2020 2020 2020 6d69  (.            mi
-000291c0: 6372 6f73 636f 7065 5f73 7461 7465 2e65  croscope_state.e
-000291d0: 625f 7365 7474 696e 6773 2e62 6561 6d5f  b_settings.beam_
-000291e0: 6375 7272 656e 7420 2a20 636f 6e73 7461  current * consta
-000291f0: 6e74 732e 5349 5f54 4f5f 5049 434f 0a20  nts.SI_TO_PICO. 
-00029200: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
-00029210: 2020 7365 6c66 2e63 6f6e 6e65 6374 696f    self.connectio
-00029220: 6e2e 5345 4d2e 4f70 7469 6373 2e53 6574  n.SEM.Optics.Set
-00029230: 5669 6577 6669 656c 6428 0a20 2020 2020  Viewfield(.     
-00029240: 2020 2020 2020 206d 6963 726f 7363 6f70         microscop
-00029250: 655f 7374 6174 652e 6562 5f73 6574 7469  e_state.eb_setti
-00029260: 6e67 732e 6866 7720 2a20 636f 6e73 7461  ngs.hfw * consta
-00029270: 6e74 732e 4d45 5452 455f 544f 5f4d 494c  nts.METRE_TO_MIL
-00029280: 4c49 4d45 5452 450a 2020 2020 2020 2020  LIMETRE.        
-00029290: 290a 0a20 2020 2020 2020 2023 206d 6963  )..        # mic
-000292a0: 726f 7363 6f70 652e 6265 616d 732e 656c  roscope.beams.el
-000292b0: 6563 7472 6f6e 5f62 6561 6d2e 7374 6967  ectron_beam.stig
-000292c0: 6d61 746f 722e 7661 6c75 6520 3d20 280a  mator.value = (.
-000292d0: 2020 2020 2020 2020 2320 2020 2020 6d69          #     mi
-000292e0: 6372 6f73 636f 7065 5f73 7461 7465 2e65  croscope_state.e
-000292f0: 625f 7365 7474 696e 6773 2e73 7469 676d  b_settings.stigm
-00029300: 6174 696f 6e0a 2020 2020 2020 2020 2320  ation.        # 
-00029310: 290a 0a20 2020 2020 2020 2023 2072 6573  )..        # res
-00029320: 746f 7265 2069 6f6e 2062 6561 6d0a 2020  tore ion beam.  
-00029330: 2020 2020 2020 5f63 6865 636b 5f62 6561        _check_bea
-00029340: 6d28 4265 616d 5479 7065 2e49 4f4e 2c20  m(BeamType.ION, 
-00029350: 7365 6c66 2e68 6172 6477 6172 655f 7365  self.hardware_se
-00029360: 7474 696e 6773 290a 2020 2020 2020 2020  ttings).        
-00029370: 6c6f 6767 696e 672e 696e 666f 2866 2272  logging.info(f"r
-00029380: 6573 746f 7269 6e67 2069 6f6e 2062 6561  estoring ion bea
-00029390: 6d20 7365 7474 696e 6773 2e2e 2e22 290a  m settings...").
-000293a0: 0a20 2020 2020 2020 2073 656c 662e 636f  .        self.co
-000293b0: 6e6e 6563 7469 6f6e 2e46 4942 2e4f 7074  nnection.FIB.Opt
-000293c0: 6963 732e 5365 7456 6965 7766 6965 6c64  ics.SetViewfield
-000293d0: 280a 2020 2020 2020 2020 2020 2020 6d69  (.            mi
-000293e0: 6372 6f73 636f 7065 5f73 7461 7465 2e69  croscope_state.i
-000293f0: 625f 7365 7474 696e 6773 2e68 6677 202a  b_settings.hfw *
-00029400: 2063 6f6e 7374 616e 7473 2e4d 4554 5245   constants.METRE
-00029410: 5f54 4f5f 4d49 4c4c 494d 4554 5245 0a20  _TO_MILLIMETRE. 
-00029420: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
-00029430: 2020 2320 6d69 6372 6f73 636f 7065 2e62    # microscope.b
-00029440: 6561 6d73 2e69 6f6e 5f62 6561 6d2e 7374  eams.ion_beam.st
-00029450: 6967 6d61 746f 722e 7661 6c75 6520 3d20  igmator.value = 
-00029460: 6d69 6372 6f73 636f 7065 5f73 7461 7465  microscope_state
-00029470: 2e69 625f 7365 7474 696e 6773 2e73 7469  .ib_settings.sti
-00029480: 676d 6174 696f 6e0a 2020 2020 2020 2020  gmation.        
-00029490: 7365 6c66 2e6d 6f76 655f 7374 6167 655f  self.move_stage_
-000294a0: 6162 736f 6c75 7465 286d 6963 726f 7363  absolute(microsc
-000294b0: 6f70 655f 7374 6174 652e 6162 736f 6c75  ope_state.absolu
-000294c0: 7465 5f70 6f73 6974 696f 6e29 0a20 2020  te_position).   
-000294d0: 2020 2020 206c 6f67 6769 6e67 2e69 6e66       logging.inf
-000294e0: 6f28 6622 6d69 6372 6f73 636f 7065 2073  o(f"microscope s
-000294f0: 7461 7465 2072 6573 746f 7265 6422 290a  tate restored").
-00029500: 2020 2020 2020 2020 7265 7475 726e 0a0a          return..
-00029510: 2020 2020 6465 6620 6765 745f 6176 6169      def get_avai
-00029520: 6c61 626c 655f 7661 6c75 6573 2873 656c  lable_values(sel
-00029530: 662c 206b 6579 3a20 7374 722c 2062 6561  f, key: str, bea
-00029540: 6d5f 7479 7065 3a20 4265 616d 5479 7065  m_type: BeamType
-00029550: 203d 204e 6f6e 6529 2d3e 206c 6973 743a   = None)-> list:
-00029560: 0a20 2020 2020 2020 2022 2222 4765 7420  .        """Get 
-00029570: 6120 6c69 7374 206f 6620 6176 6169 6c61  a list of availa
-00029580: 626c 6520 7661 6c75 6573 2066 6f72 2061  ble values for a
-00029590: 2067 6976 656e 206b 6579 2e0a 2020 2020   given key..    
-000295a0: 2020 2020 4b65 7973 3a20 706c 6173 6d61      Keys: plasma
-000295b0: 5f67 6173 2c20 6375 7272 656e 742c 2064  _gas, current, d
-000295c0: 6574 6563 746f 725f 7479 7065 0a20 2020  etector_type.   
-000295d0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-000295e0: 2076 616c 7565 7320 3d20 5b5d 0a20 2020   values = [].   
-000295f0: 2020 2020 2069 6620 6265 616d 5f74 7970       if beam_typ
-00029600: 6520 6973 2042 6561 6d54 7970 652e 494f  e is BeamType.IO
-00029610: 4e3a 0a20 2020 2020 2020 2020 2020 2069  N:.            i
-00029620: 6620 6b65 7920 3d3d 2022 706c 6173 6d61  f key == "plasma
-00029630: 5f67 6173 223a 0a20 2020 2020 2020 2020  _gas":.         
-00029640: 2020 2020 2020 2076 616c 7565 7320 3d20         values = 
-00029650: 7365 6c66 2e63 6f6e 6e65 6374 696f 6e2e  self.connection.
-00029660: 4749 532e 456e 756d 2829 0a0a 2020 2020  GIS.Enum()..    
-00029670: 2020 2020 6966 206b 6579 203d 3d20 2263      if key == "c
-00029680: 7572 7265 6e74 223a 0a20 2020 2020 2020  urrent":.       
-00029690: 2020 2020 2069 6620 6265 616d 5f74 7970       if beam_typ
-000296a0: 6520 3d3d 2042 6561 6d54 7970 652e 454c  e == BeamType.EL
-000296b0: 4543 5452 4f4e 3a0a 2020 2020 2020 2020  ECTRON:.        
-000296c0: 2020 2020 2020 2020 7661 6c75 6573 203d          values =
-000296d0: 205b 312e 3065 2d31 325d 0a20 2020 2020   [1.0e-12].     
-000296e0: 2020 2020 2020 2069 6620 6265 616d 5f74         if beam_t
-000296f0: 7970 6520 3d3d 2042 6561 6d54 7970 652e  ype == BeamType.
-00029700: 494f 4e3a 0a20 2020 2020 2020 2020 2020  ION:.           
-00029710: 2020 2020 2076 616c 7565 7320 3d20 5b32       values = [2
-00029720: 3065 2d31 322c 2036 3065 2d31 322c 2030  0e-12, 60e-12, 0
-00029730: 2e32 652d 392c 2030 2e37 3465 2d39 2c20  .2e-9, 0.74e-9, 
-00029740: 322e 3065 2d39 2c20 372e 3665 2d39 2c20  2.0e-9, 7.6e-9, 
-00029750: 3238 2e30 652d 392c 2031 3230 652d 395d  28.0e-9, 120e-9]
-00029760: 0a0a 2020 2020 2020 2020 6966 206b 6579  ..        if key
-00029770: 203d 3d20 2264 6574 6563 746f 725f 7479   == "detector_ty
-00029780: 7065 2220 616e 6420 6265 616d 5f74 7970  pe" and beam_typ
-00029790: 6520 3d3d 2042 6561 6d54 7970 652e 454c  e == BeamType.EL
-000297a0: 4543 5452 4f4e 3a0a 2020 2020 2020 2020  ECTRON:.        
-000297b0: 2020 2020 7661 6c75 6573 203d 2073 656c      values = sel
-000297c0: 662e 636f 6e6e 6563 7469 6f6e 2e53 454d  f.connection.SEM
-000297d0: 2e44 6574 6563 746f 722e 456e 756d 2829  .Detector.Enum()
-000297e0: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
-000297f0: 2069 2069 6e20 7261 6e67 6528 6c65 6e28   i in range(len(
-00029800: 7661 6c75 6573 2929 3a0a 2020 2020 2020  values)):.      
-00029810: 2020 2020 2020 2020 2020 7661 6c75 6573            values
-00029820: 5b69 2d31 5d20 3d20 7661 6c75 6573 5b69  [i-1] = values[i
-00029830: 2d31 5d2e 6e61 6d65 200a 2020 2020 2020  -1].name .      
-00029840: 2020 6966 206b 6579 203d 3d20 2264 6574    if key == "det
-00029850: 6563 746f 725f 7479 7065 2220 616e 6420  ector_type" and 
-00029860: 6265 616d 5f74 7970 6520 3d3d 2042 6561  beam_type == Bea
-00029870: 6d54 7970 652e 494f 4e3a 0a20 2020 2020  mType.ION:.     
-00029880: 2020 2020 2020 2076 616c 7565 7320 3d20         values = 
-00029890: 7365 6c66 2e63 6f6e 6e65 6374 696f 6e2e  self.connection.
-000298a0: 4649 422e 4465 7465 6374 6f72 2e45 6e75  FIB.Detector.Enu
-000298b0: 6d28 290a 2020 2020 2020 2020 2020 2020  m().            
-000298c0: 666f 7220 6920 696e 2072 616e 6765 286c  for i in range(l
-000298d0: 656e 2876 616c 7565 7329 293a 0a20 2020  en(values)):.   
-000298e0: 2020 2020 2020 2020 2020 2020 2076 616c               val
-000298f0: 7565 735b 692d 315d 203d 2076 616c 7565  ues[i-1] = value
-00029900: 735b 692d 315d 2e6e 616d 650a 2020 2020  s[i-1].name.    
-00029910: 2020 2020 0a20 2020 2020 2020 2069 6620      .        if 
-00029920: 6b65 7920 3d3d 2022 6465 7465 6374 6f72  key == "detector
-00029930: 5f6d 6f64 6522 3a20 0a20 2020 2020 2020  _mode": .       
-00029940: 2020 2020 2076 616c 7565 7320 3d20 4e6f       values = No
-00029950: 6e65 200a 0a20 2020 2020 2020 2069 6620  ne ..        if 
-00029960: 6b65 7920 3d3d 2022 7072 6573 6574 7322  key == "presets"
-00029970: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-00029980: 7475 726e 2073 656c 662e 5f67 6574 5f70  turn self._get_p
-00029990: 7265 7365 7473 2829 0a0a 2020 2020 2020  resets()..      
-000299a0: 2020 7265 7475 726e 2076 616c 7565 730a    return values.
-000299b0: 0a20 2020 2064 6566 2067 6574 5f62 6561  .    def get_bea
-000299c0: 6d5f 7365 7474 696e 6773 2873 656c 662c  m_settings(self,
-000299d0: 2062 6561 6d5f 7479 7065 3a20 4265 616d   beam_type: Beam
-000299e0: 5479 7065 203d 2042 6561 6d54 7970 652e  Type = BeamType.
-000299f0: 454c 4543 5452 4f4e 2920 2d3e 2042 6561  ELECTRON) -> Bea
-00029a00: 6d53 6574 7469 6e67 733a 0a20 2020 2020  mSettings:.     
-00029a10: 2020 2022 2222 4765 7420 7468 6520 6375     """Get the cu
-00029a20: 7272 656e 7420 6265 616d 2073 6574 7469  rrent beam setti
-00029a30: 6e67 7320 666f 7220 7468 6520 6d69 6372  ngs for the micr
-00029a40: 6f73 636f 7065 2e0a 0a20 2020 2020 2020  oscope...       
-00029a50: 2022 2222 0a20 2020 2020 2020 2062 6561   """.        bea
-00029a60: 6d5f 7365 7474 696e 6773 203d 2042 6561  m_settings = Bea
-00029a70: 6d53 6574 7469 6e67 7328 0a20 2020 2020  mSettings(.     
-00029a80: 2020 2020 2020 2062 6561 6d5f 7479 7065         beam_type
-00029a90: 3d62 6561 6d5f 7479 7065 2c0a 2020 2020  =beam_type,.    
-00029aa0: 2020 2020 2020 2020 6265 616d 5f63 7572          beam_cur
-00029ab0: 7265 6e74 3d73 656c 662e 6765 7428 2263  rent=self.get("c
-00029ac0: 7572 7265 6e74 222c 2062 6561 6d5f 7479  urrent", beam_ty
-00029ad0: 7065 292c 0a20 2020 2020 2020 2020 2020  pe),.           
-00029ae0: 2077 6f72 6b69 6e67 5f64 6973 7461 6e63   working_distanc
-00029af0: 653d 7365 6c66 2e67 6574 2822 776f 726b  e=self.get("work
-00029b00: 696e 675f 6469 7374 616e 6365 222c 2062  ing_distance", b
-00029b10: 6561 6d5f 7479 7065 292c 0a20 2020 2020  eam_type),.     
-00029b20: 2020 2020 2020 2068 6677 3d73 656c 662e         hfw=self.
-00029b30: 6765 7428 2268 6677 222c 2062 6561 6d5f  get("hfw", beam_
-00029b40: 7479 7065 292c 0a20 2020 2020 2020 2020  type),.         
-00029b50: 2020 2073 7469 676d 6174 696f 6e3d 7365     stigmation=se
-00029b60: 6c66 2e67 6574 2822 7374 6967 6d61 7469  lf.get("stigmati
-00029b70: 6f6e 222c 2062 6561 6d5f 7479 7065 292c  on", beam_type),
-00029b80: 0a20 2020 2020 2020 2020 2020 2073 6869  .            shi
-00029b90: 6674 3d73 656c 662e 6765 7428 2273 6869  ft=self.get("shi
-00029ba0: 6674 222c 2062 6561 6d5f 7479 7065 292c  ft", beam_type),
-00029bb0: 0a20 2020 2020 2020 2020 2020 2072 6573  .            res
-00029bc0: 6f6c 7574 696f 6e3d 7365 6c66 2e6c 6173  olution=self.las
-00029bd0: 745f 696d 6167 6528 6265 616d 5f74 7970  t_image(beam_typ
-00029be0: 6529 2e6d 6574 6164 6174 612e 696d 6167  e).metadata.imag
-00029bf0: 655f 7365 7474 696e 6773 2e72 6573 6f6c  e_settings.resol
-00029c00: 7574 696f 6e2c 0a20 2020 2020 2020 2020  ution,.         
-00029c10: 2020 2076 6f6c 7461 6765 3d73 656c 662e     voltage=self.
-00029c20: 6765 7428 2276 6f6c 7461 6765 222c 2062  get("voltage", b
-00029c30: 6561 6d5f 7479 7065 292c 0a20 2020 2020  eam_type),.     
-00029c40: 2020 2020 2020 2064 7765 6c6c 5f74 696d         dwell_tim
-00029c50: 653d 7365 6c66 2e6c 6173 745f 696d 6167  e=self.last_imag
-00029c60: 6528 6265 616d 5f74 7970 6529 2e6d 6574  e(beam_type).met
-00029c70: 6164 6174 612e 696d 6167 655f 7365 7474  adata.image_sett
-00029c80: 696e 6773 2e64 7765 6c6c 5f74 696d 652c  ings.dwell_time,
-00029c90: 0a20 2020 2020 2020 2020 2020 2073 6361  .            sca
-00029ca0: 6e5f 726f 7461 7469 6f6e 3d73 656c 662e  n_rotation=self.
-00029cb0: 6765 7428 2273 6361 6e5f 726f 7461 7469  get("scan_rotati
-00029cc0: 6f6e 222c 2062 6561 6d5f 7479 7065 292c  on", beam_type),
-00029cd0: 200a 2020 2020 2020 2020 290a 0a20 2020   .        )..   
-00029ce0: 2020 2020 2072 6574 7572 6e20 6265 616d       return beam
-00029cf0: 5f73 6574 7469 6e67 730a 2020 2020 0a20  _settings.    . 
-00029d00: 2020 2064 6566 2067 6574 5f64 6574 6563     def get_detec
-00029d10: 746f 725f 7365 7474 696e 6773 2873 656c  tor_settings(sel
-00029d20: 662c 2062 6561 6d5f 7479 7065 3a20 4265  f, beam_type: Be
-00029d30: 616d 5479 7065 203d 2042 6561 6d54 7970  amType = BeamTyp
-00029d40: 652e 454c 4543 5452 4f4e 2920 2d3e 2046  e.ELECTRON) -> F
-00029d50: 6962 7365 6d44 6574 6563 746f 7253 6574  ibsemDetectorSet
-00029d60: 7469 6e67 733a 0a20 2020 2020 2020 2022  tings:.        "
-00029d70: 2222 4765 7420 7468 6520 6375 7272 656e  ""Get the curren
-00029d80: 7420 6465 7465 6374 6f72 2073 6574 7469  t detector setti
-00029d90: 6e67 7320 666f 7220 7468 6520 6d69 6372  ngs for the micr
-00029da0: 6f73 636f 7065 2e0a 0a20 2020 2020 2020  oscope...       
-00029db0: 2022 2222 0a20 2020 2020 2020 2064 6574   """.        det
-00029dc0: 6563 746f 725f 7365 7474 696e 6773 203d  ector_settings =
-00029dd0: 2046 6962 7365 6d44 6574 6563 746f 7253   FibsemDetectorS
-00029de0: 6574 7469 6e67 7328 0a20 2020 2020 2020  ettings(.       
-00029df0: 2020 2020 2074 7970 6520 3d20 7365 6c66       type = self
-00029e00: 2e67 6574 2822 6465 7465 6374 6f72 5f74  .get("detector_t
-00029e10: 7970 6522 2c20 6265 616d 5f74 7970 6529  ype", beam_type)
-00029e20: 2c0a 2020 2020 2020 2020 2020 2020 6d6f  ,.            mo
-00029e30: 6465 203d 2073 656c 662e 6765 7428 2264  de = self.get("d
-00029e40: 6574 6563 746f 725f 6d6f 6465 222c 2062  etector_mode", b
-00029e50: 6561 6d5f 7479 7065 292c 0a20 2020 2020  eam_type),.     
-00029e60: 2020 2020 2020 2062 7269 6768 746e 6573         brightnes
-00029e70: 733d 2073 656c 662e 6765 7428 2264 6574  s= self.get("det
-00029e80: 6563 746f 725f 6272 6967 6874 6e65 7373  ector_brightness
-00029e90: 222c 2062 6561 6d5f 7479 7065 292c 0a20  ", beam_type),. 
-00029ea0: 2020 2020 2020 2020 2020 2063 6f6e 7472             contr
-00029eb0: 6173 743d 2073 656c 662e 6765 7428 2264  ast= self.get("d
-00029ec0: 6574 6563 746f 725f 636f 6e74 7261 7374  etector_contrast
-00029ed0: 222c 2062 6561 6d5f 7479 7065 292c 0a20  ", beam_type),. 
-00029ee0: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
-00029ef0: 2020 7265 7475 726e 2064 6574 6563 746f    return detecto
-00029f00: 725f 7365 7474 696e 6773 0a20 2020 200a  r_settings.    .
-00029f10: 2020 2020 6465 6620 6765 7428 7365 6c66      def get(self
-00029f20: 2c20 6b65 793a 2073 7472 2c20 6265 616d  , key: str, beam
-00029f30: 5f74 7970 653a 2042 6561 6d54 7970 6520  _type: BeamType 
-00029f40: 3d20 4265 616d 5479 7065 2e45 4c45 4354  = BeamType.ELECT
-00029f50: 524f 4e29 202d 3e20 556e 696f 6e5b 666c  RON) -> Union[fl
-00029f60: 6f61 742c 2073 7472 2c20 4e6f 6e65 5d3a  oat, str, None]:
-00029f70: 0a0a 2020 2020 2020 2020 6265 616d 203d  ..        beam =
-00029f80: 2073 656c 662e 636f 6e6e 6563 7469 6f6e   self.connection
-00029f90: 2e53 454d 2069 6620 6265 616d 5f74 7970  .SEM if beam_typ
-00029fa0: 6520 3d3d 2042 6561 6d54 7970 652e 454c  e == BeamType.EL
-00029fb0: 4543 5452 4f4e 2065 6c73 6520 7365 6c66  ECTRON else self
-00029fc0: 2e63 6f6e 6e65 6374 696f 6e2e 4649 420a  .connection.FIB.
-00029fd0: 0a20 2020 2020 2020 2023 2062 6561 6d20  .        # beam 
-00029fe0: 7072 6f70 6572 7469 6573 200a 2020 2020  properties .    
-00029ff0: 2020 2020 6966 206b 6579 203d 3d20 226f      if key == "o
-0002a000: 6e22 3a20 0a20 2020 2020 2020 2020 2020  n": .           
-0002a010: 205f 6368 6563 6b5f 6265 616d 2862 6561   _check_beam(bea
-0002a020: 6d5f 7479 7065 2c20 7365 6c66 2e68 6172  m_type, self.har
-0002a030: 6477 6172 655f 7365 7474 696e 6773 290a  dware_settings).
-0002a040: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-0002a050: 726e 2062 6561 6d2e 4265 616d 2e47 6574  rn beam.Beam.Get
-0002a060: 5374 6174 7573 2829 0a20 2020 2020 2020  Status().       
-0002a070: 2069 6620 6b65 7920 3d3d 2022 776f 726b   if key == "work
-0002a080: 696e 675f 6469 7374 616e 6365 2220 616e  ing_distance" an
-0002a090: 6420 6265 616d 5f74 7970 6520 3d3d 2042  d beam_type == B
-0002a0a0: 6561 6d54 7970 652e 454c 4543 5452 4f4e  eamType.ELECTRON
-0002a0b0: 3a0a 2020 2020 2020 2020 2020 2020 5f63  :.            _c
-0002a0c0: 6865 636b 5f62 6561 6d28 6265 616d 5f74  heck_beam(beam_t
-0002a0d0: 7970 652c 2073 656c 662e 6861 7264 7761  ype, self.hardwa
-0002a0e0: 7265 5f73 6574 7469 6e67 7329 0a20 2020  re_settings).   
-0002a0f0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0002a100: 6265 616d 2e4f 7074 6963 732e 4765 7457  beam.Optics.GetW
-0002a110: 4428 2920 2a20 636f 6e73 7461 6e74 732e  D() * constants.
-0002a120: 4d49 4c4c 494d 4554 5245 5f54 4f5f 4d45  MILLIMETRE_TO_ME
-0002a130: 5452 450a 2020 2020 2020 2020 6966 206b  TRE.        if k
-0002a140: 6579 203d 3d20 2263 7572 7265 6e74 223a  ey == "current":
-0002a150: 0a20 2020 2020 2020 2020 2020 205f 6368  .            _ch
-0002a160: 6563 6b5f 6265 616d 2862 6561 6d5f 7479  eck_beam(beam_ty
-0002a170: 7065 2c20 7365 6c66 2e68 6172 6477 6172  pe, self.hardwar
-0002a180: 655f 7365 7474 696e 6773 290a 2020 2020  e_settings).    
-0002a190: 2020 2020 2020 2020 6966 2062 6561 6d5f          if beam_
-0002a1a0: 7479 7065 203d 3d20 4265 616d 5479 7065  type == BeamType
-0002a1b0: 2e45 4c45 4354 524f 4e3a 0a20 2020 2020  .ELECTRON:.     
-0002a1c0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0002a1d0: 6e20 6265 616d 2e42 6561 6d2e 4765 7443  n beam.Beam.GetC
-0002a1e0: 7572 7265 6e74 2829 202a 2063 6f6e 7374  urrent() * const
-0002a1f0: 616e 7473 2e50 4943 4f5f 544f 5f53 490a  ants.PICO_TO_SI.
-0002a200: 2020 2020 2020 2020 2020 2020 656c 7365              else
-0002a210: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0002a220: 2020 7265 7475 726e 2062 6561 6d2e 4265    return beam.Be
-0002a230: 616d 2e52 6561 6450 726f 6265 4375 7272  am.ReadProbeCurr
-0002a240: 656e 7428 2920 2a20 636f 6e73 7461 6e74  ent() * constant
-0002a250: 732e 5049 434f 5f54 4f5f 5349 0a20 2020  s.PICO_TO_SI.   
-0002a260: 2020 2020 2069 6620 6b65 7920 3d3d 2022       if key == "
-0002a270: 766f 6c74 6167 6522 3a0a 2020 2020 2020  voltage":.      
-0002a280: 2020 2020 2020 5f63 6865 636b 5f62 6561        _check_bea
-0002a290: 6d28 6265 616d 5f74 7970 652c 2073 656c  m(beam_type, sel
-0002a2a0: 662e 6861 7264 7761 7265 5f73 6574 7469  f.hardware_setti
-0002a2b0: 6e67 7329 0a20 2020 2020 2020 2020 2020  ngs).           
-0002a2c0: 2072 6574 7572 6e20 6265 616d 2e42 6561   return beam.Bea
-0002a2d0: 6d2e 4765 7456 6f6c 7461 6765 2829 200a  m.GetVoltage() .
-0002a2e0: 2020 2020 2020 2020 6966 206b 6579 203d          if key =
-0002a2f0: 3d20 2268 6677 223a 0a20 2020 2020 2020  = "hfw":.       
-0002a300: 2020 2020 205f 6368 6563 6b5f 6265 616d       _check_beam
-0002a310: 2862 6561 6d5f 7479 7065 2c20 7365 6c66  (beam_type, self
-0002a320: 2e68 6172 6477 6172 655f 7365 7474 696e  .hardware_settin
-0002a330: 6773 290a 2020 2020 2020 2020 2020 2020  gs).            
-0002a340: 7265 7475 726e 2062 6561 6d2e 4f70 7469  return beam.Opti
-0002a350: 6373 2e47 6574 5669 6577 6669 656c 6428  cs.GetViewfield(
-0002a360: 2920 2a20 636f 6e73 7461 6e74 732e 4d49  ) * constants.MI
-0002a370: 4c4c 494d 4554 5245 5f54 4f5f 4d45 5452  LLIMETRE_TO_METR
-0002a380: 450a 2020 2020 2020 2020 6966 206b 6579  E.        if key
-0002a390: 203d 3d20 2272 6573 6f6c 7574 696f 6e22   == "resolution"
-0002a3a0: 3a0a 2020 2020 2020 2020 2020 2020 5f63  :.            _c
-0002a3b0: 6865 636b 5f62 6561 6d28 6265 616d 5f74  heck_beam(beam_t
-0002a3c0: 7970 652c 2073 656c 662e 6861 7264 7761  ype, self.hardwa
-0002a3d0: 7265 5f73 6574 7469 6e67 7329 0a20 2020  re_settings).   
-0002a3e0: 2020 2020 2020 2020 2069 6620 6265 616d           if beam
-0002a3f0: 5f74 7970 6520 3d3d 2042 6561 6d54 7970  _type == BeamTyp
-0002a400: 652e 454c 4543 5452 4f4e 2061 6e64 2073  e.ELECTRON and s
-0002a410: 656c 662e 6c61 7374 5f69 6d61 6765 5f65  elf.last_image_e
-0002a420: 6220 6973 206e 6f74 204e 6f6e 653a 0a20  b is not None:. 
-0002a430: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-0002a440: 6574 7572 6e20 7365 6c66 2e6c 6173 745f  eturn self.last_
-0002a450: 696d 6167 655f 6562 2e6d 6574 6164 6174  image_eb.metadat
-0002a460: 612e 696d 6167 655f 7365 7474 696e 6773  a.image_settings
-0002a470: 2e72 6573 6f6c 7574 696f 6e0a 2020 2020  .resolution.    
-0002a480: 2020 2020 2020 2020 656c 6966 2062 6561          elif bea
-0002a490: 6d5f 7479 7065 203d 3d20 4265 616d 5479  m_type == BeamTy
-0002a4a0: 7065 2e49 4f4e 2061 6e64 2073 656c 662e  pe.ION and self.
-0002a4b0: 6c61 7374 5f69 6d61 6765 5f69 6220 6973  last_image_ib is
-0002a4c0: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
-0002a4d0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0002a4e0: 6e20 7365 6c66 2e6c 6173 745f 696d 6167  n self.last_imag
-0002a4f0: 655f 6962 2e6d 6574 6164 6174 612e 696d  e_ib.metadata.im
-0002a500: 6167 655f 7365 7474 696e 6773 2e72 6573  age_settings.res
-0002a510: 6f6c 7574 696f 6e0a 2020 2020 2020 2020  olution.        
-0002a520: 6966 206b 6579 203d 3d20 2264 7765 6c6c  if key == "dwell
-0002a530: 5f74 696d 6522 3a0a 2020 2020 2020 2020  _time":.        
-0002a540: 2020 2020 5f63 6865 636b 5f62 6561 6d28      _check_beam(
-0002a550: 6265 616d 5f74 7970 652c 2073 656c 662e  beam_type, self.
-0002a560: 6861 7264 7761 7265 5f73 6574 7469 6e67  hardware_setting
-0002a570: 7329 0a20 2020 2020 2020 2020 2020 2069  s).            i
-0002a580: 6620 6265 616d 5f74 7970 6520 3d3d 2042  f beam_type == B
-0002a590: 6561 6d54 7970 652e 454c 4543 5452 4f4e  eamType.ELECTRON
-0002a5a0: 2061 6e64 2073 656c 662e 6c61 7374 5f69   and self.last_i
-0002a5b0: 6d61 6765 5f65 6220 6973 206e 6f74 204e  mage_eb is not N
-0002a5c0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-0002a5d0: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
-0002a5e0: 2e6c 6173 745f 696d 6167 655f 6562 2e6d  .last_image_eb.m
-0002a5f0: 6574 6164 6174 612e 696d 6167 655f 7365  etadata.image_se
-0002a600: 7474 696e 6773 2e64 7765 6c6c 5f74 696d  ttings.dwell_tim
-0002a610: 650a 2020 2020 2020 2020 2020 2020 656c  e.            el
-0002a620: 6966 2062 6561 6d5f 7479 7065 203d 3d20  if beam_type == 
-0002a630: 4265 616d 5479 7065 2e49 4f4e 2061 6e64  BeamType.ION and
-0002a640: 2073 656c 662e 6c61 7374 5f69 6d61 6765   self.last_image
-0002a650: 5f69 6220 6973 206e 6f74 204e 6f6e 653a  _ib is not None:
-0002a660: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002a670: 2072 6574 7572 6e20 7365 6c66 2e6c 6173   return self.las
-0002a680: 745f 696d 6167 655f 6962 2e6d 6574 6164  t_image_ib.metad
-0002a690: 6174 612e 696d 6167 655f 7365 7474 696e  ata.image_settin
-0002a6a0: 6773 2e64 7765 6c6c 5f74 696d 6520 2020  gs.dwell_time   
-0002a6b0: 0a20 2020 2020 2020 2069 6620 6b65 7920  .        if key 
-0002a6c0: 3d3d 2273 6361 6e5f 726f 7461 7469 6f6e  =="scan_rotation
-0002a6d0: 223a 0a20 2020 2020 2020 2020 2020 205f  ":.            _
-0002a6e0: 6368 6563 6b5f 6265 616d 2862 6561 6d5f  check_beam(beam_
-0002a6f0: 7479 7065 2c20 7365 6c66 2e68 6172 6477  type, self.hardw
-0002a700: 6172 655f 7365 7474 696e 6773 290a 2020  are_settings).  
-0002a710: 2020 2020 2020 2020 2020 7265 7475 726e            return
-0002a720: 2062 6561 6d2e 4f70 7469 6373 2e47 6574   beam.Optics.Get
-0002a730: 496d 6167 6552 6f74 6174 696f 6e28 2920  ImageRotation() 
-0002a740: 2020 0a20 2020 2020 2020 2069 6620 6b65    .        if ke
-0002a750: 7920 3d3d 2022 7368 6966 7422 3a0a 2020  y == "shift":.  
-0002a760: 2020 2020 2020 2020 2020 5f63 6865 636b            _check
-0002a770: 5f62 6561 6d28 6265 616d 5f74 7970 652c  _beam(beam_type,
-0002a780: 2073 656c 662e 6861 7264 7761 7265 5f73   self.hardware_s
-0002a790: 6574 7469 6e67 7329 0a20 2020 2020 2020  ettings).       
-0002a7a0: 2020 2020 2076 616c 7565 7320 3d20 6265       values = be
-0002a7b0: 616d 2e4f 7074 6963 732e 4765 7449 6d61  am.Optics.GetIma
-0002a7c0: 6765 5368 6966 7428 290a 2020 2020 2020  geShift().      
-0002a7d0: 2020 2020 2020 7368 6966 7420 3d20 506f        shift = Po
-0002a7e0: 696e 7428 7661 6c75 6573 5b30 5d2a 636f  int(values[0]*co
-0002a7f0: 6e73 7461 6e74 732e 4d49 4c4c 494d 4554  nstants.MILLIMET
-0002a800: 5245 5f54 4f5f 4d45 5452 452c 2076 616c  RE_TO_METRE, val
-0002a810: 7565 735b 315d 2a63 6f6e 7374 616e 7473  ues[1]*constants
-0002a820: 2e4d 494c 4c49 4d45 5452 455f 544f 5f4d  .MILLIMETRE_TO_M
-0002a830: 4554 5245 290a 2020 2020 2020 2020 2020  ETRE).          
-0002a840: 2020 7265 7475 726e 2073 6869 6674 0a20    return shift. 
-0002a850: 2020 2020 2020 200a 2020 2020 2020 2020         .        
-0002a860: 2320 7374 6167 6520 7072 6f70 6572 7469  # stage properti
-0002a870: 6573 0a20 2020 2020 2020 2069 6620 6b65  es.        if ke
-0002a880: 7920 3d3d 2022 7374 6167 655f 706f 7369  y == "stage_posi
-0002a890: 7469 6f6e 223a 0a20 2020 2020 2020 2020  tion":.         
-0002a8a0: 2020 205f 6368 6563 6b5f 7374 6167 6528     _check_stage(
-0002a8b0: 7365 6c66 2e68 6172 6477 6172 655f 7365  self.hardware_se
-0002a8c0: 7474 696e 6773 290a 2020 2020 2020 2020  ttings).        
-0002a8d0: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
-0002a8e0: 6765 745f 7374 6167 655f 706f 7369 7469  get_stage_positi
-0002a8f0: 6f6e 2829 0a20 2020 2020 2020 2069 6620  on().        if 
-0002a900: 6b65 7920 3d3d 2022 7374 6167 655f 6361  key == "stage_ca
-0002a910: 6c69 6272 6174 6564 223a 0a20 2020 2020  librated":.     
-0002a920: 2020 2020 2020 205f 6368 6563 6b5f 7374         _check_st
-0002a930: 6167 6528 7365 6c66 2e68 6172 6477 6172  age(self.hardwar
-0002a940: 655f 7365 7474 696e 6773 290a 2020 2020  e_settings).    
-0002a950: 2020 2020 2020 2020 7265 7475 726e 2073          return s
-0002a960: 656c 662e 636f 6e6e 6563 7469 6f6e 2e53  elf.connection.S
-0002a970: 7461 6765 2e49 7343 616c 6962 7261 7465  tage.IsCalibrate
-0002a980: 6428 290a 2020 2020 2020 2020 0a20 2020  d().        .   
-0002a990: 2020 2020 2023 2063 6861 6d62 6572 2070       # chamber p
-0002a9a0: 726f 7065 7274 6965 730a 2020 2020 2020  roperties.      
-0002a9b0: 2020 6966 206b 6579 203d 3d20 2263 6861    if key == "cha
-0002a9c0: 6d62 6572 5f73 7461 7465 223a 0a20 2020  mber_state":.   
-0002a9d0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0002a9e0: 7365 6c66 2e63 6f6e 6e65 6374 696f 6e2e  self.connection.
-0002a9f0: 4368 616d 6265 722e 4765 7453 7461 7475  Chamber.GetStatu
-0002aa00: 7328 290a 2020 2020 2020 2020 6966 206b  s().        if k
-0002aa10: 6579 203d 3d20 2263 6861 6d62 6572 5f70  ey == "chamber_p
-0002aa20: 7265 7373 7572 6522 3a0a 2020 2020 2020  ressure":.      
-0002aa30: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
-0002aa40: 662e 636f 6e6e 6563 7469 6f6e 2e43 6861  f.connection.Cha
-0002aa50: 6d62 6572 2e47 6574 5072 6573 7375 7265  mber.GetPressure
-0002aa60: 2830 290a 2020 2020 2020 2020 0a20 2020  (0).        .   
-0002aa70: 2020 2020 2023 6465 7465 6374 6f72 2070       #detector p
-0002aa80: 726f 7065 7274 6965 730a 2020 2020 2020  roperties.      
-0002aa90: 2020 6966 206b 6579 203d 3d20 2264 6574    if key == "det
-0002aaa0: 6563 746f 725f 7479 7065 223a 0a20 2020  ector_type":.   
-0002aab0: 2020 2020 2020 2020 2064 6574 6563 746f           detecto
-0002aac0: 7220 3d20 6265 616d 2e44 6574 6563 746f  r = beam.Detecto
-0002aad0: 722e 4765 7428 4368 616e 6e65 6c20 3d20  r.Get(Channel = 
-0002aae0: 3029 200a 2020 2020 2020 2020 2020 2020  0) .            
-0002aaf0: 6966 2064 6574 6563 746f 7220 6973 206e  if detector is n
-0002ab00: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
-0002ab10: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0002ab20: 6465 7465 6374 6f72 2e6e 616d 650a 2020  detector.name.  
-0002ab30: 2020 2020 2020 2020 2020 656c 7365 3a20            else: 
-0002ab40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002ab50: 2072 6574 7572 6e20 4e6f 6e65 0a20 2020   return None.   
-0002ab60: 2020 2020 2069 6620 6b65 7920 3d3d 2022       if key == "
-0002ab70: 6465 7465 6374 6f72 5f63 6f6e 7472 6173  detector_contras
-0002ab80: 7422 3a0a 2020 2020 2020 2020 2020 2020  t":.            
-0002ab90: 6966 2062 6561 6d5f 7479 7065 203d 3d20  if beam_type == 
-0002aba0: 4265 616d 5479 7065 2e45 4c45 4354 524f  BeamType.ELECTRO
-0002abb0: 4e3a 0a20 2020 2020 2020 2020 2020 2020  N:.             
-0002abc0: 2020 2063 6f6e 7472 6173 742c 2062 7269     contrast, bri
-0002abd0: 6768 746e 6573 7320 3d20 6265 616d 2e44  ghtness = beam.D
-0002abe0: 6574 6563 746f 722e 4765 7447 6169 6e42  etector.GetGainB
-0002abf0: 6c61 636b 2844 6574 6563 746f 723d 2073  lack(Detector= s
-0002ac00: 656c 662e 656c 6563 7472 6f6e 5f64 6574  elf.electron_det
-0002ac10: 6563 746f 725f 6163 7469 7665 290a 2020  ector_active).  
-0002ac20: 2020 2020 2020 2020 2020 656c 6966 2062            elif b
-0002ac30: 6561 6d5f 7479 7065 203d 3d20 4265 616d  eam_type == Beam
-0002ac40: 5479 7065 2e49 4f4e 3a0a 2020 2020 2020  Type.ION:.      
-0002ac50: 2020 2020 2020 2020 2020 636f 6e74 7261            contra
-0002ac60: 7374 2c20 6272 6967 6874 6e65 7373 203d  st, brightness =
-0002ac70: 2062 6561 6d2e 4465 7465 6374 6f72 2e47   beam.Detector.G
-0002ac80: 6574 4761 696e 426c 6163 6b28 4465 7465  etGainBlack(Dete
-0002ac90: 6374 6f72 3d20 7365 6c66 2e69 6f6e 5f64  ctor= self.ion_d
-0002aca0: 6574 6563 746f 725f 6163 7469 7665 290a  etector_active).
-0002acb0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-0002acc0: 726e 2063 6f6e 7472 6173 742f 3130 300a  rn contrast/100.
-0002acd0: 2020 2020 2020 2020 6966 206b 6579 203d          if key =
-0002ace0: 3d20 2264 6574 6563 746f 725f 6272 6967  = "detector_brig
-0002acf0: 6874 6e65 7373 223a 0a20 2020 2020 2020  htness":.       
-0002ad00: 2020 2020 2069 6620 6265 616d 5f74 7970       if beam_typ
-0002ad10: 6520 3d3d 2042 6561 6d54 7970 652e 454c  e == BeamType.EL
-0002ad20: 4543 5452 4f4e 3a0a 2020 2020 2020 2020  ECTRON:.        
-0002ad30: 2020 2020 2020 2020 636f 6e74 7261 7374          contrast
-0002ad40: 2c20 6272 6967 6874 6e65 7373 203d 2062  , brightness = b
-0002ad50: 6561 6d2e 4465 7465 6374 6f72 2e47 6574  eam.Detector.Get
-0002ad60: 4761 696e 426c 6163 6b28 4465 7465 6374  GainBlack(Detect
-0002ad70: 6f72 3d20 7365 6c66 2e65 6c65 6374 726f  or= self.electro
-0002ad80: 6e5f 6465 7465 6374 6f72 5f61 6374 6976  n_detector_activ
-0002ad90: 6529 0a20 2020 2020 2020 2020 2020 2065  e).            e
-0002ada0: 6c69 6620 6265 616d 5f74 7970 6520 3d3d  lif beam_type ==
-0002adb0: 2042 6561 6d54 7970 652e 494f 4e3a 0a20   BeamType.ION:. 
-0002adc0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-0002add0: 6f6e 7472 6173 742c 2062 7269 6768 746e  ontrast, brightn
-0002ade0: 6573 7320 3d20 6265 616d 2e44 6574 6563  ess = beam.Detec
-0002adf0: 746f 722e 4765 7447 6169 6e42 6c61 636b  tor.GetGainBlack
-0002ae00: 2844 6574 6563 746f 723d 2073 656c 662e  (Detector= self.
-0002ae10: 696f 6e5f 6465 7465 6374 6f72 5f61 6374  ion_detector_act
-0002ae20: 6976 6529 0a20 2020 2020 2020 2020 2020  ive).           
-0002ae30: 2072 6574 7572 6e20 6272 6967 6874 6e65   return brightne
-0002ae40: 7373 2f31 3030 0a20 2020 2020 2020 200a  ss/100.        .
-0002ae50: 2020 2020 2020 2020 2320 6d61 6e69 7075          # manipu
-0002ae60: 6c61 746f 7220 7072 6f70 6572 7469 6573  lator properties
-0002ae70: 0a20 2020 2020 2020 2069 6620 6b65 7920  .        if key 
-0002ae80: 3d3d 2022 6d61 6e69 7075 6c61 746f 725f  == "manipulator_
-0002ae90: 706f 7369 7469 6f6e 223a 0a20 2020 2020  position":.     
-0002aea0: 2020 2020 2020 205f 6368 6563 6b5f 6e65         _check_ne
-0002aeb0: 6564 6c65 2873 656c 662e 6861 7264 7761  edle(self.hardwa
-0002aec0: 7265 5f73 6574 7469 6e67 7329 0a20 2020  re_settings).   
-0002aed0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0002aee0: 7365 6c66 2e63 6f6e 6e65 6374 696f 6e2e  self.connection.
-0002aef0: 4e61 6e6f 6d61 6e69 7075 6c61 746f 722e  Nanomanipulator.
-0002af00: 4765 7450 6f73 6974 696f 6e28 3029 0a20  GetPosition(0). 
-0002af10: 2020 2020 2020 2069 6620 6b65 7920 3d3d         if key ==
-0002af20: 2022 6d61 6e69 7075 6c61 746f 725f 6361   "manipulator_ca
-0002af30: 6c69 6272 6174 6564 223a 0a20 2020 2020  librated":.     
-0002af40: 2020 2020 2020 205f 6368 6563 6b5f 6e65         _check_ne
-0002af50: 6564 6c65 2873 656c 662e 6861 7264 7761  edle(self.hardwa
-0002af60: 7265 5f73 6574 7469 6e67 7329 0a20 2020  re_settings).   
-0002af70: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0002af80: 7365 6c66 2e63 6f6e 6e65 6374 696f 6e2e  self.connection.
-0002af90: 4e61 6e6f 6d61 6e69 7075 6c61 746f 722e  Nanomanipulator.
-0002afa0: 4973 4361 6c69 6272 6174 6564 2830 290a  IsCalibrated(0).
-0002afb0: 0a20 2020 2020 2020 2069 6620 6b65 7920  .        if key 
-0002afc0: 3d3d 2022 7072 6573 6574 7322 3a0a 2020  == "presets":.  
-0002afd0: 2020 2020 2020 2020 2020 7265 7475 726e            return
-0002afe0: 2073 656c 662e 5f67 6574 5f70 7265 7365   self._get_prese
-0002aff0: 7473 2829 0a0a 2020 2020 2020 2020 6c6f  ts()..        lo
-0002b000: 6767 696e 672e 7761 726e 696e 6728 6622  gging.warning(f"
-0002b010: 556e 6b6e 6f77 6e20 6b65 793a 207b 6b65  Unknown key: {ke
-0002b020: 797d 2028 7b62 6561 6d5f 7479 7065 7d29  y} ({beam_type})
-0002b030: 2229 0a20 2020 2020 2020 2072 6574 7572  ").        retur
-0002b040: 6e20 4e6f 6e65 2020 200a 0a20 2020 2064  n None   ..    d
-0002b050: 6566 2073 6574 2873 656c 662c 206b 6579  ef set(self, key
-0002b060: 3a20 7374 722c 2076 616c 7565 2c20 6265  : str, value, be
-0002b070: 616d 5f74 7970 653a 2042 6561 6d54 7970  am_type: BeamTyp
-0002b080: 6520 3d20 4265 616d 5479 7065 2e45 4c45  e = BeamType.ELE
-0002b090: 4354 524f 4e29 202d 3e20 4e6f 6e65 3a0a  CTRON) -> None:.
-0002b0a0: 0a20 2020 2020 2020 2062 6561 6d20 3d20  .        beam = 
-0002b0b0: 7365 6c66 2e63 6f6e 6e65 6374 696f 6e2e  self.connection.
-0002b0c0: 5345 4d20 6966 2062 6561 6d5f 7479 7065  SEM if beam_type
-0002b0d0: 203d 3d20 4265 616d 5479 7065 2e45 4c45   == BeamType.ELE
-0002b0e0: 4354 524f 4e20 656c 7365 2073 656c 662e  CTRON else self.
-0002b0f0: 636f 6e6e 6563 7469 6f6e 2e46 4942 0a0a  connection.FIB..
-0002b100: 2020 2020 2020 2020 6966 206b 6579 203d          if key =
-0002b110: 3d20 2277 6f72 6b69 6e67 5f64 6973 7461  = "working_dista
-0002b120: 6e63 6522 3a0a 2020 2020 2020 2020 2020  nce":.          
-0002b130: 2020 5f63 6865 636b 5f62 6561 6d28 6265    _check_beam(be
-0002b140: 616d 5f74 7970 652c 2073 656c 662e 6861  am_type, self.ha
-0002b150: 7264 7761 7265 5f73 6574 7469 6e67 7329  rdware_settings)
-0002b160: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-0002b170: 6265 616d 5f74 7970 6520 3d3d 2042 6561  beam_type == Bea
-0002b180: 6d54 7970 652e 454c 4543 5452 4f4e 3a0a  mType.ELECTRON:.
-0002b190: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b1a0: 6265 616d 2e4f 7074 6963 732e 5365 7457  beam.Optics.SetW
-0002b1b0: 4428 7661 6c75 6520 2a20 636f 6e73 7461  D(value * consta
-0002b1c0: 6e74 732e 4d45 5452 455f 544f 5f4d 494c  nts.METRE_TO_MIL
-0002b1d0: 4c49 4d45 5452 4529 0a20 2020 2020 2020  LIMETRE).       
-0002b1e0: 2020 2020 2020 2020 206c 6f67 6769 6e67           logging
-0002b1f0: 2e69 6e66 6f28 6622 456c 6563 7472 6f6e  .info(f"Electron
-0002b200: 2062 6561 6d20 776f 726b 696e 6720 6469   beam working di
-0002b210: 7374 616e 6365 2073 6574 2074 6f20 7b76  stance set to {v
-0002b220: 616c 7565 7d20 6d2e 2229 0a20 2020 2020  alue} m.").     
-0002b230: 2020 2020 2020 2065 6c73 653a 200a 2020         else: .  
-0002b240: 2020 2020 2020 2020 2020 2020 2020 6c6f                lo
-0002b250: 6767 696e 672e 696e 666f 2866 2253 6574  gging.info(f"Set
-0002b260: 7469 6e67 2077 6f72 6b69 6e67 2064 6973  ting working dis
-0002b270: 7461 6e63 6520 666f 7220 696f 6e20 6265  tance for ion be
-0002b280: 616d 2069 7320 6e6f 7420 7375 7070 6f72  am is not suppor
-0002b290: 7465 6420 6279 2054 6573 6361 6e20 4150  ted by Tescan AP
-0002b2a0: 492e 2229 0a20 2020 2020 2020 2020 2020  I.").           
-0002b2b0: 2072 6574 7572 6e0a 2020 2020 2020 2020   return.        
-0002b2c0: 6966 206b 6579 203d 3d20 2263 7572 7265  if key == "curre
-0002b2d0: 6e74 223a 0a20 2020 2020 2020 2020 2020  nt":.           
-0002b2e0: 205f 6368 6563 6b5f 6265 616d 2862 6561   _check_beam(bea
-0002b2f0: 6d5f 7479 7065 2c20 7365 6c66 2e68 6172  m_type, self.har
-0002b300: 6477 6172 655f 7365 7474 696e 6773 290a  dware_settings).
-0002b310: 2020 2020 2020 2020 2020 2020 6966 2062              if b
-0002b320: 6561 6d5f 7479 7065 203d 3d20 4265 616d  eam_type == Beam
-0002b330: 5479 7065 2e45 4c45 4354 524f 4e3a 0a20  Type.ELECTRON:. 
-0002b340: 2020 2020 2020 2020 2020 2020 2020 2062                 b
-0002b350: 6561 6d2e 4265 616d 2e53 6574 4375 7272  eam.Beam.SetCurr
-0002b360: 656e 7428 7661 6c75 6520 2a20 636f 6e73  ent(value * cons
-0002b370: 7461 6e74 732e 5349 5f54 4f5f 5049 434f  tants.SI_TO_PICO
-0002b380: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0002b390: 2020 6c6f 6767 696e 672e 696e 666f 2866    logging.info(f
-0002b3a0: 2245 6c65 6374 726f 6e20 6265 616d 2063  "Electron beam c
-0002b3b0: 7572 7265 6e74 2073 6574 2074 6f20 7b76  urrent set to {v
-0002b3c0: 616c 7565 7d20 412e 2229 0a20 2020 2020  alue} A.").     
-0002b3d0: 2020 2020 2020 2065 6c73 653a 200a 2020         else: .  
-0002b3e0: 2020 2020 2020 2020 2020 2020 2020 6c6f                lo
-0002b3f0: 6767 696e 672e 696e 666f 2866 2253 6574  gging.info(f"Set
-0002b400: 7469 6e67 2063 7572 7265 6e74 2066 6f72  ting current for
-0002b410: 2069 6f6e 2062 6561 6d20 6973 206e 6f74   ion beam is not
-0002b420: 2073 7570 706f 7274 6564 2062 7920 5465   supported by Te
-0002b430: 7363 616e 2041 5049 2c20 706c 6561 7365  scan API, please
-0002b440: 2075 7365 2074 6865 206e 6174 6976 6520   use the native 
-0002b450: 6d69 6372 6f73 636f 7065 2069 6e74 6572  microscope inter
-0002b460: 6661 6365 2e22 290a 2020 2020 2020 2020  face.").        
-0002b470: 2020 2020 7265 7475 726e 0a20 2020 2020      return.     
-0002b480: 2020 2069 6620 6b65 7920 3d3d 2022 766f     if key == "vo
-0002b490: 6c74 6167 6522 3a0a 2020 2020 2020 2020  ltage":.        
-0002b4a0: 2020 2020 5f63 6865 636b 5f62 6561 6d28      _check_beam(
-0002b4b0: 6265 616d 5f74 7970 652c 2073 656c 662e  beam_type, self.
-0002b4c0: 6861 7264 7761 7265 5f73 6574 7469 6e67  hardware_setting
-0002b4d0: 7329 0a20 2020 2020 2020 2020 2020 2069  s).            i
-0002b4e0: 6620 6265 616d 5f74 7970 6520 3d3d 2042  f beam_type == B
-0002b4f0: 6561 6d54 7970 652e 454c 4543 5452 4f4e  eamType.ELECTRON
-0002b500: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0002b510: 2020 6265 616d 2e42 6561 6d2e 5365 7456    beam.Beam.SetV
-0002b520: 6f6c 7461 6765 2876 616c 7565 290a 2020  oltage(value).  
-0002b530: 2020 2020 2020 2020 2020 2020 2020 6c6f                lo
-0002b540: 6767 696e 672e 696e 666f 2866 2245 6c65  gging.info(f"Ele
-0002b550: 6374 726f 6e20 6265 616d 2076 6f6c 7461  ctron beam volta
-0002b560: 6765 2073 6574 2074 6f20 7b76 616c 7565  ge set to {value
-0002b570: 7d20 562e 2229 0a20 2020 2020 2020 2020  } V.").         
-0002b580: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0002b590: 2020 2020 2020 2020 206c 6f67 6769 6e67           logging
-0002b5a0: 2e69 6e66 6f28 6622 5365 7474 696e 6720  .info(f"Setting 
-0002b5b0: 766f 6c74 6167 6520 666f 7220 696f 6e20  voltage for ion 
-0002b5c0: 6265 616d 2069 7320 6e6f 7420 7375 7070  beam is not supp
-0002b5d0: 6f72 7465 6420 6279 2054 6573 6361 6e20  orted by Tescan 
-0002b5e0: 4150 492c 2070 6c65 6173 6520 7573 6520  API, please use 
-0002b5f0: 7468 6520 6e61 7469 7665 206d 6963 726f  the native micro
-0002b600: 7363 6f70 6520 696e 7465 7266 6163 652e  scope interface.
-0002b610: 2229 0a20 2020 2020 2020 2020 2020 2072  ").            r
-0002b620: 6574 7572 6e0a 2020 2020 2020 2020 6966  eturn.        if
-0002b630: 206b 6579 203d 3d20 2268 6677 223a 0a20   key == "hfw":. 
-0002b640: 2020 2020 2020 2020 2020 205f 6368 6563             _chec
-0002b650: 6b5f 6265 616d 2862 6561 6d5f 7479 7065  k_beam(beam_type
-0002b660: 2c20 7365 6c66 2e68 6172 6477 6172 655f  , self.hardware_
-0002b670: 7365 7474 696e 6773 290a 2020 2020 2020  settings).      
-0002b680: 2020 2020 2020 6265 616d 2e4f 7074 6963        beam.Optic
-0002b690: 732e 5365 7456 6965 7766 6965 6c64 2876  s.SetViewfield(v
-0002b6a0: 616c 7565 202a 2063 6f6e 7374 616e 7473  alue * constants
-0002b6b0: 2e4d 4554 5245 5f54 4f5f 4d49 4c4c 494d  .METRE_TO_MILLIM
-0002b6c0: 4554 5245 290a 2020 2020 2020 2020 2020  ETRE).          
-0002b6d0: 2020 6c6f 6767 696e 672e 696e 666f 2866    logging.info(f
-0002b6e0: 227b 6265 616d 5f74 7970 652e 6e61 6d65  "{beam_type.name
-0002b6f0: 7d20 4846 5720 7365 7420 746f 207b 7661  } HFW set to {va
-0002b700: 6c75 657d 206d 2e22 290a 2020 2020 2020  lue} m.").      
-0002b710: 2020 2020 2020 7265 7475 726e 0a20 2020        return.   
-0002b720: 2020 2020 2069 6620 6b65 7920 3d3d 2022       if key == "
-0002b730: 7363 616e 5f72 6f74 6174 696f 6e22 3a0a  scan_rotation":.
-0002b740: 2020 2020 2020 2020 2020 2020 5f63 6865              _che
-0002b750: 636b 5f62 6561 6d28 6265 616d 5f74 7970  ck_beam(beam_typ
-0002b760: 652c 2073 656c 662e 6861 7264 7761 7265  e, self.hardware
-0002b770: 5f73 6574 7469 6e67 7329 0a20 2020 2020  _settings).     
-0002b780: 2020 2020 2020 2062 6561 6d2e 4f70 7469         beam.Opti
-0002b790: 6373 2e53 6574 496d 6167 6552 6f74 6174  cs.SetImageRotat
-0002b7a0: 696f 6e28 7661 6c75 6529 0a20 2020 2020  ion(value).     
-0002b7b0: 2020 2020 2020 206c 6f67 6769 6e67 2e69         logging.i
-0002b7c0: 6e66 6f28 6622 7b62 6561 6d5f 7479 7065  nfo(f"{beam_type
-0002b7d0: 2e6e 616d 657d 2073 6361 6e20 726f 7461  .name} scan rota
-0002b7e0: 7469 6f6e 2073 6574 2074 6f20 7b76 616c  tion set to {val
-0002b7f0: 7565 7d20 6465 6772 6565 732e 2229 0a20  ue} degrees."). 
-0002b800: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0002b810: 6e0a 2020 2020 2020 2020 2320 6265 616d  n.        # beam
-0002b820: 2063 6f6e 7472 6f6c 0a20 2020 2020 2020   control.       
-0002b830: 2069 6620 6b65 7920 3d3d 2022 6f6e 223a   if key == "on":
-0002b840: 0a20 2020 2020 2020 2020 2020 205f 6368  .            _ch
-0002b850: 6563 6b5f 6265 616d 2862 6561 6d5f 7479  eck_beam(beam_ty
-0002b860: 7065 2c20 7365 6c66 2e68 6172 6477 6172  pe, self.hardwar
-0002b870: 655f 7365 7474 696e 6773 290a 2020 2020  e_settings).    
-0002b880: 2020 2020 2020 2020 6265 616d 2e42 6561          beam.Bea
-0002b890: 6d2e 4f6e 2829 2069 6620 7661 6c75 6520  m.On() if value 
-0002b8a0: 656c 7365 2062 6561 6d2e 4265 616d 2e4f  else beam.Beam.O
-0002b8b0: 6666 2829 0a20 2020 2020 2020 2020 2020  ff().           
-0002b8c0: 206c 6f67 6769 6e67 2e69 6e66 6f28 6622   logging.info(f"
-0002b8d0: 7b62 6561 6d5f 7479 7065 2e6e 616d 657d  {beam_type.name}
-0002b8e0: 2062 6561 6d20 7475 726e 6564 207b 276f   beam turned {'o
-0002b8f0: 6e27 2069 6620 7661 6c75 6520 656c 7365  n' if value else
-0002b900: 2027 6f66 6627 7d2e 2229 0a20 2020 2020   'off'}.").     
-0002b910: 2020 2020 2020 2072 6574 7572 6e0a 2020         return.  
-0002b920: 2020 2020 2020 6966 206b 6579 203d 3d20        if key == 
-0002b930: 2273 6869 6674 223a 0a20 2020 2020 2020  "shift":.       
-0002b940: 2020 2020 205f 6368 6563 6b5f 6265 616d       _check_beam
-0002b950: 2862 6561 6d5f 7479 7065 2c20 7365 6c66  (beam_type, self
-0002b960: 2e68 6172 6477 6172 655f 7365 7474 696e  .hardware_settin
-0002b970: 6773 290a 2020 2020 2020 2020 2020 2020  gs).            
-0002b980: 706f 696e 7420 3d20 506f 696e 7428 7661  point = Point(va
-0002b990: 6c75 652e 782a 636f 6e73 7461 6e74 732e  lue.x*constants.
-0002b9a0: 4d45 5452 455f 544f 5f4d 494c 4c49 4d45  METRE_TO_MILLIME
-0002b9b0: 5452 452c 2076 616c 7565 2e79 2a63 6f6e  TRE, value.y*con
-0002b9c0: 7374 616e 7473 2e4d 4554 5245 5f54 4f5f  stants.METRE_TO_
-0002b9d0: 4d49 4c4c 494d 4554 5245 290a 2020 2020  MILLIMETRE).    
-0002b9e0: 2020 2020 2020 2020 6265 616d 2e4f 7074          beam.Opt
-0002b9f0: 6963 732e 5365 7449 6d61 6765 5368 6966  ics.SetImageShif
-0002ba00: 7428 706f 696e 742e 782c 2070 6f69 6e74  t(point.x, point
-0002ba10: 2e79 290a 2020 2020 2020 2020 2020 2020  .y).            
-0002ba20: 6c6f 6767 696e 672e 696e 666f 2866 227b  logging.info(f"{
-0002ba30: 6265 616d 5f74 7970 652e 6e61 6d65 7d20  beam_type.name} 
-0002ba40: 6265 616d 2073 6869 6674 2073 6574 2074  beam shift set t
-0002ba50: 6f20 7b76 616c 7565 7d2e 2229 0a20 2020  o {value}.").   
-0002ba60: 2020 2020 2020 2020 2072 6574 7572 6e0a           return.
-0002ba70: 2020 2020 2020 2020 2320 6465 7465 6374          # detect
-0002ba80: 6f72 2063 6f6e 7472 6f6c 0a20 2020 2020  or control.     
-0002ba90: 2020 2069 6620 6b65 7920 3d3d 2022 6465     if key == "de
-0002baa0: 7465 6374 6f72 5f74 7970 6522 3a0a 2020  tector_type":.  
-0002bab0: 2020 2020 2020 2020 2020 5f63 6865 636b            _check
-0002bac0: 5f62 6561 6d28 6265 616d 5f74 7970 652c  _beam(beam_type,
-0002bad0: 2073 656c 662e 6861 7264 7761 7265 5f73   self.hardware_s
-0002bae0: 6574 7469 6e67 7329 0a20 2020 2020 2020  ettings).       
-0002baf0: 2020 2020 2069 6620 6265 616d 5f74 7970       if beam_typ
-0002bb00: 6520 3d3d 2042 6561 6d54 7970 652e 454c  e == BeamType.EL
-0002bb10: 4543 5452 4f4e 3a0a 2020 2020 2020 2020  ECTRON:.        
-0002bb20: 2020 2020 2020 2020 7365 6c66 2e65 6c65          self.ele
-0002bb30: 6374 726f 6e5f 6465 7465 6374 6f72 5f61  ctron_detector_a
-0002bb40: 6374 6976 6520 3d20 7661 6c75 650a 2020  ctive = value.  
-0002bb50: 2020 2020 2020 2020 2020 2020 2020 6265                be
-0002bb60: 616d 2e44 6574 6563 746f 722e 5365 7428  am.Detector.Set(
-0002bb70: 4368 616e 6e65 6c20 3d20 302c 2044 6574  Channel = 0, Det
-0002bb80: 6563 746f 7220 3d20 7661 6c75 6529 0a20  ector = value). 
-0002bb90: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0002bba0: 656c 662e 656c 6563 7472 6f6e 5f64 6574  elf.electron_det
-0002bbb0: 6563 746f 725f 6163 7469 7665 203d 2062  ector_active = b
-0002bbc0: 6561 6d2e 4465 7465 6374 6f72 2e47 6574  eam.Detector.Get
-0002bbd0: 2843 6861 6e6e 656c 203d 2030 290a 2020  (Channel = 0).  
-0002bbe0: 2020 2020 2020 2020 2020 2020 2020 6c6f                lo
-0002bbf0: 6767 696e 672e 696e 666f 2866 227b 6265  gging.info(f"{be
-0002bc00: 616d 5f74 7970 657d 2064 6574 6563 746f  am_type} detecto
-0002bc10: 7220 7479 7065 2073 6574 2074 6f20 7b76  r type set to {v
-0002bc20: 616c 7565 7d2e 2229 0a20 2020 2020 2020  alue}.").       
-0002bc30: 2020 2020 2020 2020 2072 6574 7572 6e0a           return.
-0002bc40: 2020 2020 2020 2020 2020 2020 656c 6966              elif
-0002bc50: 2062 6561 6d5f 7479 7065 203d 3d20 4265   beam_type == Be
-0002bc60: 616d 5479 7065 2e49 4f4e 3a0a 2020 2020  amType.ION:.    
-0002bc70: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-0002bc80: 2e69 6f6e 5f64 6574 6563 746f 725f 6163  .ion_detector_ac
-0002bc90: 7469 7665 203d 2076 616c 7565 0a20 2020  tive = value.   
-0002bca0: 2020 2020 2020 2020 2020 2020 2062 6561               bea
-0002bcb0: 6d2e 4465 7465 6374 6f72 2e53 6574 2843  m.Detector.Set(C
-0002bcc0: 6861 6e6e 656c 203d 2030 2c20 4465 7465  hannel = 0, Dete
-0002bcd0: 6374 6f72 203d 2076 616c 7565 290a 2020  ctor = value).  
-0002bce0: 2020 2020 2020 2020 2020 2020 2020 7365                se
-0002bcf0: 6c66 2e69 6f6e 5f64 6574 6563 746f 725f  lf.ion_detector_
-0002bd00: 6163 7469 7665 203d 2062 6561 6d2e 4465  active = beam.De
-0002bd10: 7465 6374 6f72 2e47 6574 2843 6861 6e6e  tector.Get(Chann
-0002bd20: 656c 203d 2030 290a 2020 2020 2020 2020  el = 0).        
-0002bd30: 2020 2020 2020 2020 6c6f 6767 696e 672e          logging.
-0002bd40: 696e 666f 2866 227b 6265 616d 5f74 7970  info(f"{beam_typ
-0002bd50: 657d 2064 6574 6563 746f 7220 7479 7065  e} detector type
-0002bd60: 2073 6574 2074 6f20 7b76 616c 7565 7d2e   set to {value}.
-0002bd70: 2229 0a20 2020 2020 2020 2020 2020 2020  ").             
-0002bd80: 2020 2072 6574 7572 6e0a 2020 2020 2020     return.      
-0002bd90: 2020 6966 206b 6579 2069 6e20 5b22 6465    if key in ["de
-0002bda0: 7465 6374 6f72 5f62 7269 6768 746e 6573  tector_brightnes
-0002bdb0: 7322 2c20 2264 6574 6563 746f 725f 636f  s", "detector_co
-0002bdc0: 6e74 7261 7374 225d 3a0a 2020 2020 2020  ntrast"]:.      
-0002bdd0: 2020 2020 2020 5f63 6865 636b 5f62 6561        _check_bea
-0002bde0: 6d28 6265 616d 5f74 7970 652c 2073 656c  m(beam_type, sel
-0002bdf0: 662e 6861 7264 7761 7265 5f73 6574 7469  f.hardware_setti
-0002be00: 6e67 7329 0a20 2020 2020 2020 2020 2020  ngs).           
-0002be10: 2069 6620 6b65 7920 3d3d 2022 6465 7465   if key == "dete
-0002be20: 6374 6f72 5f62 7269 6768 746e 6573 7322  ctor_brightness"
-0002be30: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0002be40: 2020 6966 2030 203c 3d20 7661 6c75 6520    if 0 <= value 
-0002be50: 3c3d 2031 3a0a 2020 2020 2020 2020 2020  <= 1:.          
-0002be60: 2020 2020 2020 2020 2020 6966 2062 6561            if bea
-0002be70: 6d5f 7479 7065 203d 3d20 4265 616d 5479  m_type == BeamTy
-0002be80: 7065 2e45 4c45 4354 524f 4e3a 0a20 2020  pe.ELECTRON:.   
-0002be90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002bea0: 2020 2020 206f 675f 636f 6e74 7261 7374       og_contrast
-0002beb0: 2c20 6f67 5f62 7269 6768 746e 6573 7320  , og_brightness 
-0002bec0: 3d20 6265 616d 2e44 6574 6563 746f 722e  = beam.Detector.
-0002bed0: 4765 7447 6169 6e42 6c61 636b 2844 6574  GetGainBlack(Det
-0002bee0: 6563 746f 723d 2073 656c 662e 656c 6563  ector= self.elec
-0002bef0: 7472 6f6e 5f64 6574 6563 746f 725f 6163  tron_detector_ac
-0002bf00: 7469 7665 290a 2020 2020 2020 2020 2020  tive).          
-0002bf10: 2020 2020 2020 2020 2020 2020 2020 6265                be
-0002bf20: 616d 2e44 6574 6563 746f 722e 5365 7447  am.Detector.SetG
-0002bf30: 6169 6e42 6c61 636b 2844 6574 6563 746f  ainBlack(Detecto
-0002bf40: 723d 2073 656c 662e 656c 6563 7472 6f6e  r= self.electron
-0002bf50: 5f64 6574 6563 746f 725f 6163 7469 7665  _detector_active
-0002bf60: 2c20 4761 696e 203d 206f 675f 636f 6e74  , Gain = og_cont
-0002bf70: 7261 7374 2c20 426c 6163 6b20 3d20 7661  rast, Black = va
-0002bf80: 6c75 652a 3130 3029 0a20 2020 2020 2020  lue*100).       
-0002bf90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002bfa0: 206c 6f67 6769 6e67 2e69 6e66 6f28 6622   logging.info(f"
-0002bfb0: 7b62 6561 6d5f 7479 7065 7d20 6465 7465  {beam_type} dete
-0002bfc0: 6374 6f72 2062 7269 6768 746e 6573 7320  ctor brightness 
-0002bfd0: 7365 7420 746f 207b 7661 6c75 657d 2e22  set to {value}."
-0002bfe0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0002bff0: 2020 2020 2020 656c 6966 2062 6561 6d5f        elif beam_
-0002c000: 7479 7065 203d 3d20 4265 616d 5479 7065  type == BeamType
-0002c010: 2e49 4f4e 3a0a 2020 2020 2020 2020 2020  .ION:.          
-0002c020: 2020 2020 2020 2020 2020 2020 2020 6f67                og
-0002c030: 5f63 6f6e 7472 6173 742c 206f 675f 6272  _contrast, og_br
-0002c040: 6967 6874 6e65 7373 203d 2062 6561 6d2e  ightness = beam.
-0002c050: 4465 7465 6374 6f72 2e47 6574 4761 696e  Detector.GetGain
-0002c060: 426c 6163 6b28 4465 7465 6374 6f72 3d20  Black(Detector= 
-0002c070: 7365 6c66 2e69 6f6e 5f64 6574 6563 746f  self.ion_detecto
-0002c080: 725f 6163 7469 7665 290a 2020 2020 2020  r_active).      
-0002c090: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c0a0: 2020 6265 616d 2e44 6574 6563 746f 722e    beam.Detector.
-0002c0b0: 5365 7447 6169 6e42 6c61 636b 2844 6574  SetGainBlack(Det
-0002c0c0: 6563 746f 723d 2073 656c 662e 696f 6e5f  ector= self.ion_
-0002c0d0: 6465 7465 6374 6f72 5f61 6374 6976 652c  detector_active,
-0002c0e0: 2047 6169 6e20 3d20 6f67 5f63 6f6e 7472   Gain = og_contr
-0002c0f0: 6173 742c 2042 6c61 636b 203d 2076 616c  ast, Black = val
-0002c100: 7565 2a31 3030 290a 2020 2020 2020 2020  ue*100).        
-0002c110: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c120: 6c6f 6767 696e 672e 696e 666f 2866 227b  logging.info(f"{
-0002c130: 6265 616d 5f74 7970 657d 2064 6574 6563  beam_type} detec
-0002c140: 746f 7220 6272 6967 6874 6e65 7373 2073  tor brightness s
-0002c150: 6574 2074 6f20 7b76 616c 7565 7d2e 2229  et to {value}.")
-0002c160: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002c170: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-0002c180: 2020 2020 2020 2020 2020 206c 6f67 6769             loggi
-0002c190: 6e67 2e77 6172 6e69 6e67 2866 2249 6e76  ng.warning(f"Inv
-0002c1a0: 616c 6964 2062 7269 6768 746e 6573 7320  alid brightness 
-0002c1b0: 7661 6c75 653a 207b 7661 6c75 657d 2c20  value: {value}, 
-0002c1c0: 6d75 7374 2062 6520 6265 7477 6565 6e20  must be between 
-0002c1d0: 3020 616e 6420 312e 2229 0a20 2020 2020  0 and 1.").     
-0002c1e0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0002c1f0: 6e20 0a20 2020 2020 2020 2020 2020 2069  n .            i
-0002c200: 6620 6b65 7920 3d3d 2022 6465 7465 6374  f key == "detect
-0002c210: 6f72 5f63 6f6e 7472 6173 7422 3a0a 2020  or_contrast":.  
-0002c220: 2020 2020 2020 2020 2020 2020 2020 6966                if
-0002c230: 2030 203c 3d20 7661 6c75 6520 3c3d 2031   0 <= value <= 1
-0002c240: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0002c250: 2020 2020 2020 6966 2062 6561 6d5f 7479        if beam_ty
-0002c260: 7065 203d 3d20 4265 616d 5479 7065 2e45  pe == BeamType.E
-0002c270: 4c45 4354 524f 4e3a 0a20 2020 2020 2020  LECTRON:.       
-0002c280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c290: 206f 675f 636f 6e74 7261 7374 2c20 6f67   og_contrast, og
-0002c2a0: 5f62 7269 6768 746e 6573 7320 3d20 6265  _brightness = be
-0002c2b0: 616d 2e44 6574 6563 746f 722e 4765 7447  am.Detector.GetG
-0002c2c0: 6169 6e42 6c61 636b 2844 6574 6563 746f  ainBlack(Detecto
-0002c2d0: 723d 2073 656c 662e 656c 6563 7472 6f6e  r= self.electron
-0002c2e0: 5f64 6574 6563 746f 725f 6163 7469 7665  _detector_active
-0002c2f0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0002c300: 2020 2020 2020 2020 2020 6265 616d 2e44            beam.D
-0002c310: 6574 6563 746f 722e 5365 7447 6169 6e42  etector.SetGainB
-0002c320: 6c61 636b 2844 6574 6563 746f 723d 2073  lack(Detector= s
-0002c330: 656c 662e 656c 6563 7472 6f6e 5f64 6574  elf.electron_det
-0002c340: 6563 746f 725f 6163 7469 7665 2c20 4761  ector_active, Ga
-0002c350: 696e 203d 2076 616c 7565 2a31 3030 2c20  in = value*100, 
-0002c360: 426c 6163 6b20 3d20 6f67 5f62 7269 6768  Black = og_brigh
-0002c370: 746e 6573 7329 0a20 2020 2020 2020 2020  tness).         
-0002c380: 2020 2020 2020 2020 2020 2020 2020 206c                 l
-0002c390: 6f67 6769 6e67 2e69 6e66 6f28 6622 7b62  ogging.info(f"{b
-0002c3a0: 6561 6d5f 7479 7065 7d20 6465 7465 6374  eam_type} detect
-0002c3b0: 6f72 2063 6f6e 7472 6173 7420 7365 7420  or contrast set 
-0002c3c0: 746f 207b 7661 6c75 657d 2e22 290a 2020  to {value}.").  
-0002c3d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c3e0: 2020 656c 6966 2062 6561 6d5f 7479 7065    elif beam_type
-0002c3f0: 203d 3d20 4265 616d 5479 7065 2e49 4f4e   == BeamType.ION
-0002c400: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0002c410: 2020 2020 2020 2020 2020 6f67 5f63 6f6e            og_con
-0002c420: 7472 6173 742c 206f 675f 6272 6967 6874  trast, og_bright
-0002c430: 6e65 7373 203d 2062 6561 6d2e 4465 7465  ness = beam.Dete
-0002c440: 6374 6f72 2e47 6574 4761 696e 426c 6163  ctor.GetGainBlac
-0002c450: 6b28 4465 7465 6374 6f72 3d20 7365 6c66  k(Detector= self
-0002c460: 2e69 6f6e 5f64 6574 6563 746f 725f 6163  .ion_detector_ac
-0002c470: 7469 7665 290a 2020 2020 2020 2020 2020  tive).          
-0002c480: 2020 2020 2020 2020 2020 2020 2020 6265                be
-0002c490: 616d 2e44 6574 6563 746f 722e 5365 7447  am.Detector.SetG
-0002c4a0: 6169 6e42 6c61 636b 2844 6574 6563 746f  ainBlack(Detecto
-0002c4b0: 723d 2073 656c 662e 696f 6e5f 6465 7465  r= self.ion_dete
-0002c4c0: 6374 6f72 5f61 6374 6976 652c 2047 6169  ctor_active, Gai
-0002c4d0: 6e20 3d20 7661 6c75 652a 3130 302c 2042  n = value*100, B
-0002c4e0: 6c61 636b 203d 206f 675f 6272 6967 6874  lack = og_bright
-0002c4f0: 6e65 7373 290a 2020 2020 2020 2020 2020  ness).          
-0002c500: 2020 2020 2020 2020 2020 2020 2020 6c6f                lo
-0002c510: 6767 696e 672e 696e 666f 2866 227b 6265  gging.info(f"{be
-0002c520: 616d 5f74 7970 657d 2064 6574 6563 746f  am_type} detecto
-0002c530: 7220 636f 6e74 7261 7374 2073 6574 2074  r contrast set t
-0002c540: 6f20 7b76 616c 7565 7d2e 2229 0a20 2020  o {value}.").   
-0002c550: 2020 2020 2020 2020 2020 2020 2065 6c73               els
-0002c560: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-0002c570: 2020 2020 2020 206c 6f67 6769 6e67 2e77         logging.w
-0002c580: 6172 6e69 6e67 2866 2249 6e76 616c 6964  arning(f"Invalid
-0002c590: 2063 6f6e 7472 6173 7420 7661 6c75 653a   contrast value:
-0002c5a0: 207b 7661 6c75 657d 2c20 6d75 7374 2062   {value}, must b
-0002c5b0: 6520 6265 7477 6565 6e20 3020 616e 6420  e between 0 and 
-0002c5c0: 312e 2229 0a20 2020 2020 2020 2020 2020  1.").           
-0002c5d0: 2020 2020 2072 6574 7572 6e20 0a0a 2020       return ..  
-0002c5e0: 2020 2020 2020 6966 206b 6579 203d 3d20        if key == 
-0002c5f0: 2270 7265 7365 7422 3a0a 2020 2020 2020  "preset":.      
-0002c600: 2020 2020 2020 6265 616d 2e50 7265 7365        beam.Prese
-0002c610: 742e 4163 7469 7661 7465 2876 616c 7565  t.Activate(value
-0002c620: 290a 2020 2020 2020 2020 2020 2020 6c6f  ).            lo
-0002c630: 6767 696e 672e 696e 666f 2866 2250 7265  gging.info(f"Pre
-0002c640: 7365 7420 7b76 616c 7565 7d20 6163 7469  set {value} acti
-0002c650: 7661 7465 6420 666f 7220 7b62 6561 6d5f  vated for {beam_
-0002c660: 7479 7065 7d2e 2229 0a20 2020 2020 2020  type}.").       
-0002c670: 2020 2020 2072 6574 7572 6e0a 0a20 2020       return..   
-0002c680: 2020 2020 206c 6f67 6769 6e67 2e77 6172       logging.war
-0002c690: 6e69 6e67 2866 2255 6e6b 6e6f 776e 206b  ning(f"Unknown k
-0002c6a0: 6579 3a20 7b6b 6579 7d20 287b 6265 616d  ey: {key} ({beam
-0002c6b0: 5f74 7970 657d 2922 290a 2020 2020 2020  _type})").      
-0002c6c0: 2020 7265 7475 726e 0a0a 2020 2020 6465    return..    de
-0002c6d0: 6620 6368 6563 6b5f 6176 6169 6c61 626c  f check_availabl
-0002c6e0: 655f 7661 6c75 6573 2873 656c 662c 206b  e_values(self, k
-0002c6f0: 6579 3a20 7374 722c 2062 6561 6d5f 7479  ey: str, beam_ty
-0002c700: 7065 3a20 4265 616d 5479 7065 203d 204e  pe: BeamType = N
-0002c710: 6f6e 6529 202d 3e20 626f 6f6c 3a0a 2020  one) -> bool:.  
-0002c720: 2020 2020 2020 7265 7475 726e 2046 616c        return Fal
-0002c730: 7365 0a20 2020 200a 2020 2020 6465 6620  se.    .    def 
-0002c740: 686f 6d65 2873 656c 6629 202d 3e20 4e6f  home(self) -> No
-0002c750: 6e65 3a0a 2020 2020 2020 2020 2320 686f  ne:.        # ho
-0002c760: 6d65 203d 2046 6962 7365 6d53 7461 6765  me = FibsemStage
-0002c770: 506f 7369 7469 6f6e 2878 3d30 2c20 793d  Position(x=0, y=
-0002c780: 302c 207a 3d30 2e30 3831 2c20 723d 302c  0, z=0.081, r=0,
-0002c790: 2074 3d30 290a 2020 2020 2020 2020 2320   t=0).        # 
-0002c7a0: 7365 6c66 2e6d 6f76 655f 7374 6167 655f  self.move_stage_
-0002c7b0: 6162 736f 6c75 7465 2868 6f6d 6529 0a20  absolute(home). 
-0002c7c0: 2020 2020 2020 206c 6f67 6769 6e67 2e69         logging.i
-0002c7d0: 6e66 6f28 6622 4e6f 2068 6f6d 696e 6720  nfo(f"No homing 
-0002c7e0: 6176 6169 6c61 626c 652c 2070 6c65 6173  available, pleas
-0002c7f0: 6520 7573 6520 6e61 7469 7665 2055 492e  e use native UI.
-0002c800: 2229 0a20 2020 2020 2020 2072 6574 7572  ").        retur
-0002c810: 6e0a 0a23 2323 2323 2323 2323 2323 2323  n..#############
-0002c820: 2323 2323 2323 2323 2323 230a 636c 6173  ###########.clas
-0002c830: 7320 4465 6d6f 4d69 6372 6f73 636f 7065  s DemoMicroscope
-0002c840: 2846 6962 7365 6d4d 6963 726f 7363 6f70  (FibsemMicroscop
-0002c850: 6529 3a0a 0a20 2020 2064 6566 205f 5f69  e):..    def __i
-0002c860: 6e69 745f 5f28 7365 6c66 293a 2020 2020  nit__(self):    
-0002c870: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
-0002c880: 2073 656c 662e 636f 6e6e 6563 7469 6f6e   self.connection
-0002c890: 203d 204e 6f6e 650a 2020 2020 2020 2020   = None.        
-0002c8a0: 7365 6c66 2e73 7461 6765 5f70 6f73 6974  self.stage_posit
-0002c8b0: 696f 6e20 3d20 4669 6273 656d 5374 6167  ion = FibsemStag
-0002c8c0: 6550 6f73 6974 696f 6e28 783d 302c 2079  ePosition(x=0, y
-0002c8d0: 3d30 2c20 7a3d 302c 2072 3d30 2c20 743d  =0, z=0, r=0, t=
-0002c8e0: 3029 0a20 2020 2020 2020 2073 656c 662e  0).        self.
-0002c8f0: 6d61 6e69 7075 6c61 746f 725f 706f 7369  manipulator_posi
-0002c900: 7469 6f6e 203d 2046 6962 7365 6d4d 616e  tion = FibsemMan
-0002c910: 6970 756c 6174 6f72 506f 7369 7469 6f6e  ipulatorPosition
-0002c920: 2829 0a20 2020 2020 2020 2073 656c 662e  ().        self.
-0002c930: 656c 6563 7472 6f6e 5f62 6561 6d20 3d20  electron_beam = 
-0002c940: 4265 616d 5365 7474 696e 6773 280a 2020  BeamSettings(.  
-0002c950: 2020 2020 2020 2020 2020 6265 616d 5f74            beam_t
-0002c960: 7970 653d 4265 616d 5479 7065 2e45 4c45  ype=BeamType.ELE
-0002c970: 4354 524f 4e2c 0a20 2020 2020 2020 2020  CTRON,.         
-0002c980: 2020 2077 6f72 6b69 6e67 5f64 6973 7461     working_dista
-0002c990: 6e63 653d 342e 3065 2d33 2c0a 2020 2020  nce=4.0e-3,.    
-0002c9a0: 2020 2020 2020 2020 6265 616d 5f63 7572          beam_cur
-0002c9b0: 7265 6e74 3d31 652d 3132 2c0a 2020 2020  rent=1e-12,.    
-0002c9c0: 2020 2020 2020 2020 766f 6c74 6167 653d          voltage=
-0002c9d0: 3230 3030 2c0a 2020 2020 2020 2020 2020  2000,.          
-0002c9e0: 2020 6866 773d 3135 3065 2d36 2c0a 2020    hfw=150e-6,.  
-0002c9f0: 2020 2020 2020 2020 2020 7265 736f 6c75            resolu
-0002ca00: 7469 6f6e 3d5b 3135 3336 2c20 3130 3234  tion=[1536, 1024
-0002ca10: 5d2c 0a20 2020 2020 2020 2020 2020 2064  ],.            d
-0002ca20: 7765 6c6c 5f74 696d 653d 3165 2d36 2c0a  well_time=1e-6,.
-0002ca30: 2020 2020 2020 2020 2020 2020 7374 6967              stig
-0002ca40: 6d61 7469 6f6e 3d50 6f69 6e74 2830 2c20  mation=Point(0, 
-0002ca50: 3029 2c0a 2020 2020 2020 2020 2020 2020  0),.            
-0002ca60: 7368 6966 743d 506f 696e 7428 302c 2030  shift=Point(0, 0
-0002ca70: 292c 0a20 2020 2020 2020 2020 2020 2073  ),.            s
-0002ca80: 6361 6e5f 726f 7461 7469 6f6e 3d30 2c0a  can_rotation=0,.
-0002ca90: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-0002caa0: 2020 7365 6c66 2e69 6f6e 5f62 6561 6d20    self.ion_beam 
-0002cab0: 3d20 4265 616d 5365 7474 696e 6773 280a  = BeamSettings(.
-0002cac0: 2020 2020 2020 2020 2020 2020 6265 616d              beam
-0002cad0: 5f74 7970 653d 4265 616d 5479 7065 2e49  _type=BeamType.I
-0002cae0: 4f4e 2c0a 2020 2020 2020 2020 2020 2020  ON,.            
-0002caf0: 776f 726b 696e 675f 6469 7374 616e 6365  working_distance
-0002cb00: 3d31 362e 3565 2d33 2c0a 2020 2020 2020  =16.5e-3,.      
-0002cb10: 2020 2020 2020 6265 616d 5f63 7572 7265        beam_curre
-0002cb20: 6e74 3d32 3065 2d31 322c 200a 2020 2020  nt=20e-12, .    
-0002cb30: 2020 2020 2020 2020 766f 6c74 6167 653d          voltage=
-0002cb40: 3330 3030 302c 0a20 2020 2020 2020 2020  30000,.         
-0002cb50: 2020 2068 6677 3d31 3530 652d 362c 0a20     hfw=150e-6,. 
-0002cb60: 2020 2020 2020 2020 2020 2072 6573 6f6c             resol
-0002cb70: 7574 696f 6e3d 5b31 3533 362c 2031 3032  ution=[1536, 102
-0002cb80: 345d 2c0a 2020 2020 2020 2020 2020 2020  4],.            
-0002cb90: 6477 656c 6c5f 7469 6d65 3d31 652d 362c  dwell_time=1e-6,
-0002cba0: 0a20 2020 2020 2020 2020 2020 2073 7469  .            sti
-0002cbb0: 676d 6174 696f 6e3d 506f 696e 7428 302c  gmation=Point(0,
-0002cbc0: 2030 292c 0a20 2020 2020 2020 2020 2020   0),.           
-0002cbd0: 2073 6869 6674 3d50 6f69 6e74 2830 2c20   shift=Point(0, 
-0002cbe0: 3029 2c0a 2020 2020 2020 2020 2020 2020  0),.            
-0002cbf0: 7363 616e 5f72 6f74 6174 696f 6e3d 302c  scan_rotation=0,
-0002cc00: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
-0002cc10: 2020 2020 7365 6c66 2e65 6c65 6374 726f      self.electro
-0002cc20: 6e5f 6465 7465 6374 6f72 5f73 6574 7469  n_detector_setti
-0002cc30: 6e67 7320 3d20 4669 6273 656d 4465 7465  ngs = FibsemDete
-0002cc40: 6374 6f72 5365 7474 696e 6773 280a 2020  ctorSettings(.  
-0002cc50: 2020 2020 2020 2020 2020 7479 7065 3d22            type="
-0002cc60: 4554 4422 2c0a 2020 2020 2020 2020 2020  ETD",.          
-0002cc70: 2020 6d6f 6465 3d22 5365 636f 6e64 6172    mode="Secondar
-0002cc80: 7945 6c65 6374 726f 6e73 222c 0a20 2020  yElectrons",.   
-0002cc90: 2020 2020 2020 2020 2062 7269 6768 746e           brightn
-0002cca0: 6573 733d 302e 352c 0a20 2020 2020 2020  ess=0.5,.       
-0002ccb0: 2020 2020 2063 6f6e 7472 6173 743d 302e       contrast=0.
-0002ccc0: 352c 0a20 2020 2020 2020 2029 0a20 2020  5,.        ).   
-0002ccd0: 2020 2020 2073 656c 662e 696f 6e5f 6465       self.ion_de
-0002cce0: 7465 6374 6f72 5f73 6574 7469 6e67 7320  tector_settings 
-0002ccf0: 3d20 4669 6273 656d 4465 7465 6374 6f72  = FibsemDetector
-0002cd00: 5365 7474 696e 6773 280a 2020 2020 2020  Settings(.      
-0002cd10: 2020 2020 2020 7479 7065 3d22 4554 4422        type="ETD"
-0002cd20: 2c0a 2020 2020 2020 2020 2020 2020 6d6f  ,.            mo
-0002cd30: 6465 3d22 5365 636f 6e64 6172 7945 6c65  de="SecondaryEle
-0002cd40: 6374 726f 6e73 222c 0a20 2020 2020 2020  ctrons",.       
-0002cd50: 2020 2020 2062 7269 6768 746e 6573 733d       brightness=
-0002cd60: 302e 352c 0a20 2020 2020 2020 2020 2020  0.5,.           
-0002cd70: 2063 6f6e 7472 6173 743d 302e 352c 0a20   contrast=0.5,. 
-0002cd80: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-0002cd90: 2069 6d70 6f72 7420 6669 6273 656d 0a20   import fibsem. 
-0002cda0: 2020 2020 2020 2066 726f 6d20 6669 6273         from fibs
-0002cdb0: 656d 2e75 7469 6c73 2069 6d70 6f72 7420  em.utils import 
-0002cdc0: 6c6f 6164 5f70 726f 746f 636f 6c0a 2020  load_protocol.  
-0002cdd0: 2020 2020 2020 696d 706f 7274 206f 730a        import os.
-0002cde0: 2020 2020 2020 2020 6261 7365 5f70 6174          base_pat
-0002cdf0: 6820 3d20 6f73 2e70 6174 682e 6469 726e  h = os.path.dirn
-0002ce00: 616d 6528 6669 6273 656d 2e5f 5f70 6174  ame(fibsem.__pat
-0002ce10: 685f 5f5b 305d 290a 2020 2020 2020 2020  h__[0]).        
-0002ce20: 7365 6c66 2e68 6172 6477 6172 655f 7365  self.hardware_se
-0002ce30: 7474 696e 6773 203d 2046 6962 7365 6d48  ttings = FibsemH
-0002ce40: 6172 6477 6172 652e 5f5f 6672 6f6d 5f64  ardware.__from_d
-0002ce50: 6963 745f 5f28 6c6f 6164 5f70 726f 746f  ict__(load_proto
-0002ce60: 636f 6c28 6f73 2e70 6174 682e 6a6f 696e  col(os.path.join
-0002ce70: 2862 6173 655f 7061 7468 2c20 2266 6962  (base_path, "fib
-0002ce80: 7365 6d22 2c20 2263 6f6e 6669 6722 2c20  sem", "config", 
-0002ce90: 226d 6f64 656c 2e79 616d 6c22 2929 290a  "model.yaml"))).
-0002cea0: 0a0a 0a20 2020 2064 6566 2063 6f6e 6e65  ...    def conne
-0002ceb0: 6374 5f74 6f5f 6d69 6372 6f73 636f 7065  ct_to_microscope
-0002cec0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-0002ced0: 6c6f 6767 696e 672e 696e 666f 2866 2243  logging.info(f"C
-0002cee0: 6f6e 6e65 6374 6564 2074 6f20 4465 6d6f  onnected to Demo
-0002cef0: 204d 6963 726f 7363 6f70 6522 290a 2020   Microscope").  
-0002cf00: 2020 2020 2020 6c6f 6767 696e 672e 696e        logging.in
-0002cf10: 666f 2866 224d 6963 726f 7363 6f70 6520  fo(f"Microscope 
-0002cf20: 636c 6965 6e74 2063 6f6e 6e65 6374 6564  client connected
-0002cf30: 2074 6f20 6d6f 6465 6c20 4465 6d6f 2077   to model Demo w
-0002cf40: 6974 6820 7365 7269 616c 206e 756d 6265  ith serial numbe
-0002cf50: 7220 3132 3334 3536 2061 6e64 2073 6f66  r 123456 and sof
-0002cf60: 7477 6172 6520 7665 7273 696f 6e20 302e  tware version 0.
-0002cf70: 3122 290a 2020 2020 2020 2020 7265 7475  1").        retu
-0002cf80: 726e 0a0a 2020 2020 6465 6620 6469 7363  rn..    def disc
-0002cf90: 6f6e 6e65 6374 2873 656c 6629 3a0a 2020  onnect(self):.  
-0002cfa0: 2020 2020 2020 6c6f 6767 696e 672e 696e        logging.in
-0002cfb0: 666f 2866 2244 6973 636f 6e6e 6563 7465  fo(f"Disconnecte
-0002cfc0: 6420 6672 6f6d 2044 656d 6f20 4d69 6372  d from Demo Micr
-0002cfd0: 6f73 636f 7065 2229 0a0a 2020 2020 6465  oscope")..    de
-0002cfe0: 6620 6163 7175 6972 655f 696d 6167 6528  f acquire_image(
-0002cff0: 7365 6c66 2c20 696d 6167 655f 7365 7474  self, image_sett
-0002d000: 696e 6773 3a20 496d 6167 6553 6574 7469  ings: ImageSetti
-0002d010: 6e67 7329 202d 3e20 4669 6273 656d 496d  ngs) -> FibsemIm
-0002d020: 6167 653a 0a20 2020 2020 2020 205f 6368  age:.        _ch
-0002d030: 6563 6b5f 6265 616d 2869 6d61 6765 5f73  eck_beam(image_s
-0002d040: 6574 7469 6e67 732e 6265 616d 5f74 7970  ettings.beam_typ
-0002d050: 652c 2073 656c 662e 6861 7264 7761 7265  e, self.hardware
-0002d060: 5f73 6574 7469 6e67 7329 0a20 2020 2020  _settings).     
-0002d070: 2020 2076 6677 203d 2069 6d61 6765 5f73     vfw = image_s
-0002d080: 6574 7469 6e67 732e 6866 7720 2a20 696d  ettings.hfw * im
-0002d090: 6167 655f 7365 7474 696e 6773 2e72 6573  age_settings.res
-0002d0a0: 6f6c 7574 696f 6e5b 315d 202f 2069 6d61  olution[1] / ima
-0002d0b0: 6765 5f73 6574 7469 6e67 732e 7265 736f  ge_settings.reso
-0002d0c0: 6c75 7469 6f6e 5b30 5d0a 2020 2020 2020  lution[0].      
-0002d0d0: 2020 7069 7865 6c73 697a 6520 3d20 506f    pixelsize = Po
-0002d0e0: 696e 7428 696d 6167 655f 7365 7474 696e  int(image_settin
-0002d0f0: 6773 2e68 6677 202f 2069 6d61 6765 5f73  gs.hfw / image_s
-0002d100: 6574 7469 6e67 732e 7265 736f 6c75 7469  ettings.resoluti
-0002d110: 6f6e 5b30 5d2c 200a 2020 2020 2020 2020  on[0], .        
-0002d120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002d130: 2020 7666 7720 2f20 696d 6167 655f 7365    vfw / image_se
-0002d140: 7474 696e 6773 2e72 6573 6f6c 7574 696f  ttings.resolutio
-0002d150: 6e5b 315d 290a 2020 2020 2020 2020 0a20  n[1]).        . 
-0002d160: 2020 2020 2020 206c 6f67 6769 6e67 2e69         logging.i
-0002d170: 6e66 6f28 6622 4163 7175 6972 696e 6720  nfo(f"Acquiring 
-0002d180: 696d 6167 653a 207b 696d 6167 655f 7365  image: {image_se
-0002d190: 7474 696e 6773 2e62 6561 6d5f 7479 7065  ttings.beam_type
-0002d1a0: 7d22 290a 2020 2020 2020 2020 696d 6167  }").        imag
-0002d1b0: 6520 3d20 4669 6273 656d 496d 6167 6528  e = FibsemImage(
-0002d1c0: 0a20 2020 2020 2020 2020 2020 2064 6174  .            dat
-0002d1d0: 613d 6e70 2e72 616e 646f 6d2e 7261 6e64  a=np.random.rand
-0002d1e0: 696e 7428 6c6f 773d 302c 2068 6967 683d  int(low=0, high=
-0002d1f0: 3235 362c 200a 2020 2020 2020 2020 2020  256, .          
-0002d200: 2020 2020 2020 7369 7a65 3d28 696d 6167        size=(imag
-0002d210: 655f 7365 7474 696e 6773 2e72 6573 6f6c  e_settings.resol
-0002d220: 7574 696f 6e5b 315d 2c69 6d61 6765 5f73  ution[1],image_s
-0002d230: 6574 7469 6e67 732e 7265 736f 6c75 7469  ettings.resoluti
-0002d240: 6f6e 5b30 5d29 2c20 0a20 2020 2020 2020  on[0]), .       
-0002d250: 2020 2020 2020 2020 2064 7479 7065 3d6e           dtype=n
-0002d260: 702e 7569 6e74 3829 2c0a 2020 2020 2020  p.uint8),.      
-0002d270: 2020 2020 2020 6d65 7461 6461 7461 3d46        metadata=F
-0002d280: 6962 7365 6d49 6d61 6765 4d65 7461 6461  ibsemImageMetada
-0002d290: 7461 2869 6d61 6765 5f73 6574 7469 6e67  ta(image_setting
-0002d2a0: 733d 696d 6167 655f 7365 7474 696e 6773  s=image_settings
-0002d2b0: 2c20 7069 7865 6c5f 7369 7a65 3d70 6978  , pixel_size=pix
-0002d2c0: 656c 7369 7a65 2c0a 2020 2020 2020 2020  elsize,.        
-0002d2d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002d2e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002d2f0: 206d 6963 726f 7363 6f70 655f 7374 6174   microscope_stat
-0002d300: 653d 4d69 6372 6f73 636f 7065 5374 6174  e=MicroscopeStat
-0002d310: 6528 292c 6465 7465 6374 6f72 5f73 6574  e(),detector_set
-0002d320: 7469 6e67 733d 4669 6273 656d 4465 7465  tings=FibsemDete
-0002d330: 6374 6f72 5365 7474 696e 6773 2829 2929  ctorSettings()))
-0002d340: 0a0a 2020 2020 2020 2020 6966 2069 6d61  ..        if ima
-0002d350: 6765 5f73 6574 7469 6e67 732e 6265 616d  ge_settings.beam
-0002d360: 5f74 7970 6520 6973 2042 6561 6d54 7970  _type is BeamTyp
-0002d370: 652e 454c 4543 5452 4f4e 3a0a 2020 2020  e.ELECTRON:.    
-0002d380: 2020 2020 2020 2020 7365 6c66 2e5f 6562          self._eb
-0002d390: 5f69 6d61 6765 203d 2069 6d61 6765 0a20  _image = image. 
-0002d3a0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-0002d3b0: 2020 2020 2020 2020 2073 656c 662e 5f69           self._i
-0002d3c0: 625f 696d 6167 6520 3d20 696d 6167 650a  b_image = image.
-0002d3d0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-0002d3e0: 696d 6167 650a 0a20 2020 2064 6566 206c  image..    def l
-0002d3f0: 6173 745f 696d 6167 6528 7365 6c66 2c20  ast_image(self, 
-0002d400: 6265 616d 5f74 7970 653a 2042 6561 6d54  beam_type: BeamT
-0002d410: 7970 6529 202d 3e20 4669 6273 656d 496d  ype) -> FibsemIm
-0002d420: 6167 653a 0a20 2020 2020 2020 205f 6368  age:.        _ch
-0002d430: 6563 6b5f 6265 616d 2862 6561 6d5f 7479  eck_beam(beam_ty
-0002d440: 7065 2c20 7365 6c66 2e68 6172 6477 6172  pe, self.hardwar
-0002d450: 655f 7365 7474 696e 6773 290a 2020 2020  e_settings).    
-0002d460: 2020 2020 6c6f 6767 696e 672e 696e 666f      logging.info
-0002d470: 2866 2247 6574 7469 6e67 206c 6173 7420  (f"Getting last 
-0002d480: 696d 6167 653a 207b 6265 616d 5f74 7970  image: {beam_typ
-0002d490: 657d 2229 0a20 2020 2020 2020 2072 6574  e}").        ret
-0002d4a0: 7572 6e20 7365 6c66 2e5f 6562 5f69 6d61  urn self._eb_ima
-0002d4b0: 6765 2069 6620 6265 616d 5f74 7970 6520  ge if beam_type 
-0002d4c0: 6973 2042 6561 6d54 7970 652e 454c 4543  is BeamType.ELEC
-0002d4d0: 5452 4f4e 2065 6c73 6520 7365 6c66 2e5f  TRON else self._
-0002d4e0: 6962 5f69 6d61 6765 0a20 2020 200a 2020  ib_image.    .  
-0002d4f0: 2020 6465 6620 6175 746f 636f 6e74 7261    def autocontra
-0002d500: 7374 2873 656c 662c 2062 6561 6d5f 7479  st(self, beam_ty
-0002d510: 7065 3a20 4265 616d 5479 7065 2920 2d3e  pe: BeamType) ->
-0002d520: 204e 6f6e 653a 0a20 2020 2020 2020 205f   None:.        _
-0002d530: 6368 6563 6b5f 6265 616d 2862 6561 6d5f  check_beam(beam_
-0002d540: 7479 7065 2c20 7365 6c66 2e68 6172 6477  type, self.hardw
-0002d550: 6172 655f 7365 7474 696e 6773 290a 2020  are_settings).  
-0002d560: 2020 2020 2020 6c6f 6767 696e 672e 696e        logging.in
-0002d570: 666f 2866 2241 7574 6f63 6f6e 7472 6173  fo(f"Autocontras
-0002d580: 743a 207b 6265 616d 5f74 7970 657d 2229  t: {beam_type}")
-0002d590: 0a0a 2020 2020 6465 6620 6175 746f 5f66  ..    def auto_f
-0002d5a0: 6f63 7573 2873 656c 662c 2062 6561 6d5f  ocus(self, beam_
-0002d5b0: 7479 7065 3a20 4265 616d 5479 7065 2920  type: BeamType) 
-0002d5c0: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
-0002d5d0: 205f 6368 6563 6b5f 6265 616d 2862 6561   _check_beam(bea
-0002d5e0: 6d5f 7479 7065 2c20 7365 6c66 2e68 6172  m_type, self.har
-0002d5f0: 6477 6172 655f 7365 7474 696e 6773 290a  dware_settings).
-0002d600: 2020 2020 2020 2020 6c6f 6767 696e 672e          logging.
-0002d610: 696e 666f 2866 2241 7574 6f20 666f 6375  info(f"Auto focu
-0002d620: 733a 207b 6265 616d 5f74 7970 657d 2229  s: {beam_type}")
-0002d630: 0a20 2020 2020 2020 206c 6f67 6769 6e67  .        logging
-0002d640: 2e69 6e66 6f28 6622 4927 6d20 666f 6375  .info(f"I'm focu
-0002d650: 7369 6e67 206d 7920 6c61 7365 722e 2e2e  sing my laser...
-0002d660: 2229 0a0a 2020 2020 6465 6620 7265 7365  ")..    def rese
-0002d670: 745f 6265 616d 5f73 6869 6674 7328 7365  t_beam_shifts(se
-0002d680: 6c66 2920 2d3e 204e 6f6e 653a 0a20 2020  lf) -> None:.   
-0002d690: 2020 2020 206c 6f67 6769 6e67 2e69 6e66       logging.inf
-0002d6a0: 6f28 6622 5265 7365 7474 696e 6720 6265  o(f"Resetting be
-0002d6b0: 616d 2073 6869 6674 7322 290a 2020 2020  am shifts").    
-0002d6c0: 2020 2020 7365 6c66 2e65 6c65 6374 726f      self.electro
-0002d6d0: 6e5f 6265 616d 2e73 6869 6674 203d 2050  n_beam.shift = P
-0002d6e0: 6f69 6e74 2830 2c30 290a 2020 2020 2020  oint(0,0).      
-0002d6f0: 2020 7365 6c66 2e69 6f6e 5f62 6561 6d2e    self.ion_beam.
-0002d700: 7368 6966 7420 3d20 506f 696e 7428 302c  shift = Point(0,
-0002d710: 3029 0a0a 2020 2020 6465 6620 6265 616d  0)..    def beam
-0002d720: 5f73 6869 6674 2873 656c 662c 2064 783a  _shift(self, dx:
-0002d730: 2066 6c6f 6174 2c20 6479 3a20 666c 6f61   float, dy: floa
-0002d740: 742c 2062 6561 6d5f 7479 7065 3a20 4265  t, beam_type: Be
-0002d750: 616d 5479 7065 2920 2d3e 204e 6f6e 653a  amType) -> None:
-0002d760: 0a20 2020 2020 2020 2062 6561 6d5f 7479  .        beam_ty
-0002d770: 7065 203d 2042 6561 6d54 7970 652e 494f  pe = BeamType.IO
-0002d780: 4e20 2320 544f 444f 3a20 6164 6420 6265  N # TODO: add be
-0002d790: 616d 5f74 7970 6520 746f 2070 6172 616d  am_type to param
-0002d7a0: 7320 666f 7220 4142 430a 2020 2020 2020  s for ABC.      
-0002d7b0: 2020 5f63 6865 636b 5f62 6561 6d28 6265    _check_beam(be
-0002d7c0: 616d 5f74 7970 652c 2073 656c 662e 6861  am_type, self.ha
-0002d7d0: 7264 7761 7265 5f73 6574 7469 6e67 7329  rdware_settings)
-0002d7e0: 0a20 2020 2020 2020 206c 6f67 6769 6e67  .        logging
-0002d7f0: 2e69 6e66 6f28 6622 4265 616d 2073 6869  .info(f"Beam shi
-0002d800: 6674 3a20 6478 3d7b 6478 3a2e 3265 7d2c  ft: dx={dx:.2e},
-0002d810: 2064 793d 7b64 793a 2e32 657d 2028 7b62   dy={dy:.2e} ({b
-0002d820: 6561 6d5f 7479 7065 7d29 2229 0a20 2020  eam_type})").   
-0002d830: 2020 2020 206c 6f67 6769 6e67 2e64 6562       logging.deb
-0002d840: 7567 2866 227b 6265 616d 5f74 7970 652e  ug(f"{beam_type.
-0002d850: 6e61 6d65 7d20 7c20 7b64 787d 7c7b 6479  name} | {dx}|{dy
-0002d860: 7d22 2920 0a20 2020 2020 2020 2069 6620  }") .        if 
-0002d870: 6265 616d 5f74 7970 6520 3d3d 2042 6561  beam_type == Bea
-0002d880: 6d54 7970 652e 454c 4543 5452 4f4e 3a0a  mType.ELECTRON:.
-0002d890: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-0002d8a0: 2e65 6c65 6374 726f 6e5f 6265 616d 2e73  .electron_beam.s
-0002d8b0: 6869 6674 202b 3d20 506f 696e 7428 6478  hift += Point(dx
-0002d8c0: 2c20 6479 290a 2020 2020 2020 2020 656c  , dy).        el
-0002d8d0: 6966 2062 6561 6d5f 7479 7065 203d 3d20  if beam_type == 
-0002d8e0: 4265 616d 5479 7065 2e49 4f4e 3a0a 2020  BeamType.ION:.  
-0002d8f0: 2020 2020 2020 2020 2020 7365 6c66 2e69            self.i
-0002d900: 6f6e 5f62 6561 6d2e 7368 6966 7420 2b3d  on_beam.shift +=
-0002d910: 2050 6f69 6e74 2864 782c 2064 7929 0a0a   Point(dx, dy)..
-0002d920: 2020 2020 6465 6620 6765 745f 7374 6167      def get_stag
-0002d930: 655f 706f 7369 7469 6f6e 2873 656c 6629  e_position(self)
-0002d940: 202d 3e20 4669 6273 656d 5374 6167 6550   -> FibsemStageP
-0002d950: 6f73 6974 696f 6e3a 0a20 2020 2020 2020  osition:.       
-0002d960: 205f 6368 6563 6b5f 7374 6167 6528 7365   _check_stage(se
-0002d970: 6c66 2e68 6172 6477 6172 655f 7365 7474  lf.hardware_sett
-0002d980: 696e 6773 290a 2020 2020 2020 2020 6c6f  ings).        lo
-0002d990: 6767 696e 672e 696e 666f 2866 2247 6574  gging.info(f"Get
-0002d9a0: 7469 6e67 2073 7461 6765 2070 6f73 6974  ting stage posit
-0002d9b0: 696f 6e3a 207b 7365 6c66 2e73 7461 6765  ion: {self.stage
-0002d9c0: 5f70 6f73 6974 696f 6e7d 2229 0a20 2020  _position}").   
-0002d9d0: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
-0002d9e0: 2e73 7461 6765 5f70 6f73 6974 696f 6e0a  .stage_position.
-0002d9f0: 2020 2020 0a20 2020 2064 6566 2067 6574      .    def get
-0002da00: 5f63 7572 7265 6e74 5f6d 6963 726f 7363  _current_microsc
-0002da10: 6f70 655f 7374 6174 6528 7365 6c66 2920  ope_state(self) 
-0002da20: 2d3e 204d 6963 726f 7363 6f70 6553 7461  -> MicroscopeSta
-0002da30: 7465 3a0a 2020 2020 2020 2020 5f63 6865  te:.        _che
-0002da40: 636b 5f73 7461 6765 2873 656c 662e 6861  ck_stage(self.ha
-0002da50: 7264 7761 7265 5f73 6574 7469 6e67 7329  rdware_settings)
-0002da60: 0a20 2020 2020 2020 206c 6f67 6769 6e67  .        logging
-0002da70: 2e69 6e66 6f28 6622 4765 7474 696e 6720  .info(f"Getting 
-0002da80: 6d69 6372 6f73 636f 7065 2073 7461 7465  microscope state
-0002da90: 2229 0a20 2020 2020 2020 2072 6574 7572  ").        retur
-0002daa0: 6e20 4d69 6372 6f73 636f 7065 5374 6174  n MicroscopeStat
-0002dab0: 6528 6162 736f 6c75 7465 5f70 6f73 6974  e(absolute_posit
-0002dac0: 696f 6e3d 7365 6c66 2e73 7461 6765 5f70  ion=self.stage_p
-0002dad0: 6f73 6974 696f 6e29 0a0a 2020 2020 6465  osition)..    de
-0002dae0: 6620 6d6f 7665 5f73 7461 6765 5f61 6273  f move_stage_abs
-0002daf0: 6f6c 7574 6528 7365 6c66 2c20 706f 7369  olute(self, posi
-0002db00: 7469 6f6e 3a20 4669 6273 656d 5374 6167  tion: FibsemStag
-0002db10: 6550 6f73 6974 696f 6e29 202d 3e20 4e6f  ePosition) -> No
-0002db20: 6e65 3a0a 2020 2020 2020 2020 6966 2070  ne:.        if p
-0002db30: 6f73 6974 696f 6e2e 7220 6973 204e 6f6e  osition.r is Non
-0002db40: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
-0002db50: 6f74 6174 696f 6e20 3d20 5472 7565 0a20  otation = True. 
-0002db60: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-0002db70: 2020 2020 2020 2020 2072 6f74 6174 696f           rotatio
-0002db80: 6e20 3d20 4661 6c73 650a 2020 2020 2020  n = False.      
-0002db90: 2020 6966 2070 6f73 6974 696f 6e2e 7420    if position.t 
-0002dba0: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
-0002dbb0: 2020 2020 2074 696c 7420 3d20 5472 7565       tilt = True
-0002dbc0: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
-0002dbd0: 2020 2020 2020 2020 2020 2074 696c 7420             tilt 
-0002dbe0: 3d20 4661 6c73 650a 2020 2020 2020 2020  = False.        
-0002dbf0: 5f63 6865 636b 5f73 7461 6765 2873 656c  _check_stage(sel
-0002dc00: 662e 6861 7264 7761 7265 5f73 6574 7469  f.hardware_setti
-0002dc10: 6e67 732c 2072 6f74 6174 696f 6e3d 726f  ngs, rotation=ro
-0002dc20: 7461 7469 6f6e 2c20 7469 6c74 3d74 696c  tation, tilt=til
-0002dc30: 7429 0a20 2020 2020 2020 206c 6f67 6769  t).        loggi
-0002dc40: 6e67 2e69 6e66 6f28 6622 4d6f 7669 6e67  ng.info(f"Moving
-0002dc50: 2073 7461 6765 3a20 7b70 6f73 6974 696f   stage: {positio
-0002dc60: 6e7d 2028 4162 736f 6c75 7465 2922 290a  n} (Absolute)").
-0002dc70: 2020 2020 2020 2020 7365 6c66 2e73 7461          self.sta
-0002dc80: 6765 5f70 6f73 6974 696f 6e20 3d20 706f  ge_position = po
-0002dc90: 7369 7469 6f6e 0a0a 2020 2020 6465 6620  sition..    def 
-0002dca0: 6d6f 7665 5f73 7461 6765 5f72 656c 6174  move_stage_relat
-0002dcb0: 6976 6528 7365 6c66 2c20 706f 7369 7469  ive(self, positi
-0002dcc0: 6f6e 3a20 4669 6273 656d 5374 6167 6550  on: FibsemStageP
-0002dcd0: 6f73 6974 696f 6e29 202d 3e20 4e6f 6e65  osition) -> None
-0002dce0: 3a0a 2020 2020 2020 2020 6966 2070 6f73  :.        if pos
-0002dcf0: 6974 696f 6e2e 7220 6973 206e 6f74 204e  ition.r is not N
-0002dd00: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-0002dd10: 2072 6f74 6174 696f 6e20 3d20 5472 7565   rotation = True
-0002dd20: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
-0002dd30: 2020 2020 2020 2020 2020 2072 6f74 6174             rotat
-0002dd40: 696f 6e20 3d20 4661 6c73 650a 2020 2020  ion = False.    
-0002dd50: 2020 2020 6966 2070 6f73 6974 696f 6e2e      if position.
-0002dd60: 7420 6973 206e 6f74 204e 6f6e 653a 0a20  t is not None:. 
-0002dd70: 2020 2020 2020 2020 2020 2074 696c 7420             tilt 
-0002dd80: 3d20 5472 7565 0a20 2020 2020 2020 2065  = True.        e
-0002dd90: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-0002dda0: 2074 696c 7420 3d20 4661 6c73 650a 2020   tilt = False.  
-0002ddb0: 2020 2020 2020 5f63 6865 636b 5f73 7461        _check_sta
-0002ddc0: 6765 2873 656c 662e 6861 7264 7761 7265  ge(self.hardware
-0002ddd0: 5f73 6574 7469 6e67 732c 2072 6f74 6174  _settings, rotat
-0002dde0: 696f 6e3d 726f 7461 7469 6f6e 2c20 7469  ion=rotation, ti
-0002ddf0: 6c74 3d74 696c 7429 0a20 2020 2020 2020  lt=tilt).       
-0002de00: 206c 6f67 6769 6e67 2e69 6e66 6f28 6622   logging.info(f"
-0002de10: 4d6f 7669 6e67 2073 7461 6765 3a20 7b70  Moving stage: {p
-0002de20: 6f73 6974 696f 6e7d 2028 5265 6c61 7469  osition} (Relati
-0002de30: 7665 2922 290a 2020 2020 2020 2020 7365  ve)").        se
-0002de40: 6c66 2e73 7461 6765 5f70 6f73 6974 696f  lf.stage_positio
-0002de50: 6e20 2b3d 2070 6f73 6974 696f 6e0a 0a20  n += position.. 
-0002de60: 2020 2064 6566 2073 7461 626c 655f 6d6f     def stable_mo
-0002de70: 7665 2873 656c 662c 2073 6574 7469 6e67  ve(self, setting
-0002de80: 733a 204d 6963 726f 7363 6f70 6553 6574  s: MicroscopeSet
-0002de90: 7469 6e67 732c 2064 783a 2066 6c6f 6174  tings, dx: float
-0002dea0: 2c20 6479 3a66 6c6f 6174 2c20 6265 616d  , dy:float, beam
-0002deb0: 5f74 7970 653a 2042 6561 6d54 7970 6529  _type: BeamType)
-0002dec0: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
-0002ded0: 2020 5f63 6865 636b 5f73 7461 6765 2873    _check_stage(s
-0002dee0: 656c 662e 6861 7264 7761 7265 5f73 6574  elf.hardware_set
-0002def0: 7469 6e67 7329 0a20 2020 2020 2020 2070  tings).        p
-0002df00: 7265 5f74 696c 7420 3d20 6e70 2e64 6567  re_tilt = np.deg
-0002df10: 3272 6164 2873 6574 7469 6e67 732e 7379  2rad(settings.sy
-0002df20: 7374 656d 2e73 7461 6765 2e70 7265 5f74  stem.stage.pre_t
-0002df30: 696c 7429 0a20 2020 2020 2020 200a 2020  ilt).        .  
-0002df40: 2020 2020 2020 7374 6167 655f 706f 7369        stage_posi
-0002df50: 7469 6f6e 203d 2046 6962 7365 6d53 7461  tion = FibsemSta
-0002df60: 6765 506f 7369 7469 6f6e 280a 2020 2020  gePosition(.    
-0002df70: 2020 2020 2020 2020 783d 666c 6f61 7428          x=float(
-0002df80: 6478 292c 0a20 2020 2020 2020 2020 2020  dx),.           
-0002df90: 2079 3d66 6c6f 6174 2864 792a 6e70 2e63   y=float(dy*np.c
-0002dfa0: 6f73 2870 7265 5f74 696c 7429 292c 0a20  os(pre_tilt)),. 
-0002dfb0: 2020 2020 2020 2020 2020 207a 3d66 6c6f             z=flo
-0002dfc0: 6174 2864 792a 6e70 2e73 696e 2870 7265  at(dy*np.sin(pre
-0002dfd0: 5f74 696c 7429 292c 0a20 2020 2020 2020  _tilt)),.       
-0002dfe0: 2020 2020 2072 3d30 2c0a 2020 2020 2020       r=0,.      
-0002dff0: 2020 2020 2020 743d 302c 0a20 2020 2020        t=0,.     
-0002e000: 2020 2020 2020 2063 6f6f 7264 696e 6174         coordinat
-0002e010: 655f 7379 7374 656d 3d22 5241 5722 2c0a  e_system="RAW",.
-0002e020: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
-0002e030: 2020 206c 6f67 6769 6e67 2e69 6e66 6f28     logging.info(
-0002e040: 6622 4d6f 7669 6e67 2073 7461 6765 3a20  f"Moving stage: 
-0002e050: 7b73 7461 6765 5f70 6f73 6974 696f 6e7d  {stage_position}
-0002e060: 2c20 6265 616d 5f74 7970 6520 3d20 7b62  , beam_type = {b
-0002e070: 6561 6d5f 7479 7065 2e6e 616d 657d 2028  eam_type.name} (
-0002e080: 5374 6162 6c65 2922 290a 0a20 2020 2020  Stable)")..     
-0002e090: 2020 2073 656c 662e 7374 6167 655f 706f     self.stage_po
-0002e0a0: 7369 7469 6f6e 202b 3d20 7374 6167 655f  sition += stage_
-0002e0b0: 706f 7369 7469 6f6e 0a20 2020 2020 2020  position.       
-0002e0c0: 2072 6574 7572 6e20 7374 6167 655f 706f   return stage_po
-0002e0d0: 7369 7469 6f6e 0a0a 0a20 2020 2064 6566  sition...    def
-0002e0e0: 2065 7563 656e 7472 6963 5f6d 6f76 6528   eucentric_move(
-0002e0f0: 7365 6c66 2c20 7365 7474 696e 6773 3a4d  self, settings:M
-0002e100: 6963 726f 7363 6f70 6553 6574 7469 6e67  icroscopeSetting
-0002e110: 732c 2064 793a 2066 6c6f 6174 2c20 7374  s, dy: float, st
-0002e120: 6174 6963 5f77 643a 2062 6f6f 6c3d 5472  atic_wd: bool=Tr
-0002e130: 7565 2920 2d3e 204e 6f6e 653a 0a20 2020  ue) -> None:.   
-0002e140: 2020 2020 205f 6368 6563 6b5f 7374 6167       _check_stag
-0002e150: 6528 7365 6c66 2e68 6172 6477 6172 655f  e(self.hardware_
-0002e160: 7365 7474 696e 6773 290a 2020 2020 2020  settings).      
-0002e170: 2020 6c6f 6767 696e 672e 696e 666f 2866    logging.info(f
-0002e180: 224d 6f76 696e 6720 7374 6167 653a 2064  "Moving stage: d
-0002e190: 793d 7b64 793a 2e32 657d 2028 4575 6365  y={dy:.2e} (Euce
-0002e1a0: 6e74 7269 6329 2229 0a20 2020 2020 2020  ntric)").       
-0002e1b0: 2073 656c 662e 7374 6167 655f 706f 7369   self.stage_posi
-0002e1c0: 7469 6f6e 2e7a 202b 3d20 6479 202f 206e  tion.z += dy / n
-0002e1d0: 702e 636f 7328 6e70 2e64 6567 3272 6164  p.cos(np.deg2rad
-0002e1e0: 2839 302d 7365 7474 696e 6773 2e73 7973  (90-settings.sys
-0002e1f0: 7465 6d2e 7374 6167 652e 7469 6c74 5f66  tem.stage.tilt_f
-0002e200: 6c61 745f 746f 5f69 6f6e 2929 0a0a 2020  lat_to_ion))..  
-0002e210: 2020 6465 6620 6d6f 7665 5f66 6c61 745f    def move_flat_
-0002e220: 746f 5f62 6561 6d28 7365 6c66 2c20 7365  to_beam(self, se
-0002e230: 7474 696e 6773 3a20 4d69 6372 6f73 636f  ttings: Microsco
-0002e240: 7065 5365 7474 696e 6773 2c20 6265 616d  peSettings, beam
-0002e250: 5f74 7970 653a 2042 6561 6d54 7970 6529  _type: BeamType)
-0002e260: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
-0002e270: 2020 5f63 6865 636b 5f73 7461 6765 2873    _check_stage(s
-0002e280: 656c 662e 6861 7264 7761 7265 5f73 6574  elf.hardware_set
-0002e290: 7469 6e67 732c 2074 696c 7420 3d20 5472  tings, tilt = Tr
-0002e2a0: 7565 290a 2020 2020 2020 2020 2020 2020  ue).            
-0002e2b0: 2020 2020 0a20 2020 2020 2020 2069 6620      .        if 
-0002e2c0: 6265 616d 5f74 7970 6520 6973 2042 6561  beam_type is Bea
-0002e2d0: 6d54 7970 652e 454c 4543 5452 4f4e 3a0a  mType.ELECTRON:.
-0002e2e0: 2020 2020 2020 2020 2020 2020 7220 3d20              r = 
-0002e2f0: 7365 7474 696e 6773 2e73 7973 7465 6d2e  settings.system.
-0002e300: 7374 6167 652e 7469 6c74 5f66 6c61 745f  stage.tilt_flat_
-0002e310: 746f 5f65 6c65 6374 726f 6e0a 2020 2020  to_electron.    
-0002e320: 2020 2020 2020 2020 7420 3d20 7365 7474          t = sett
-0002e330: 696e 6773 2e73 7973 7465 6d2e 7374 6167  ings.system.stag
-0002e340: 652e 7469 6c74 5f66 6c61 745f 746f 5f65  e.tilt_flat_to_e
-0002e350: 6c65 6374 726f 6e0a 2020 2020 2020 2020  lectron.        
-0002e360: 6966 2062 6561 6d5f 7479 7065 2069 7320  if beam_type is 
-0002e370: 4265 616d 5479 7065 2e49 4f4e 3a0a 2020  BeamType.ION:.  
-0002e380: 2020 2020 2020 2020 2020 7220 3d20 7365            r = se
-0002e390: 7474 696e 6773 2e73 7973 7465 6d2e 7374  ttings.system.st
-0002e3a0: 6167 652e 7469 6c74 5f66 6c61 745f 746f  age.tilt_flat_to
-0002e3b0: 5f69 6f6e 0a20 2020 2020 2020 2020 2020  _ion.           
-0002e3c0: 2074 203d 2073 6574 7469 6e67 732e 7379   t = settings.sy
-0002e3d0: 7374 656d 2e73 7461 6765 2e74 696c 745f  stem.stage.tilt_
-0002e3e0: 666c 6174 5f74 6f5f 696f 6e0a 0a20 2020  flat_to_ion..   
-0002e3f0: 2020 2020 2023 2070 7265 2d74 696c 7420       # pre-tilt 
-0002e400: 6164 6a75 7374 6d65 6e74 0a20 2020 2020  adjustment.     
-0002e410: 2020 2074 2020 3d20 7420 2d20 7365 7474     t  = t - sett
-0002e420: 696e 6773 2e73 7973 7465 6d2e 7374 6167  ings.system.stag
-0002e430: 652e 7072 655f 7469 6c74 0a20 2020 2020  e.pre_tilt.     
-0002e440: 2020 200a 2020 2020 2020 2020 6c6f 6767     .        logg
-0002e450: 696e 672e 696e 666f 2866 224d 6f76 696e  ing.info(f"Movin
-0002e460: 6720 7374 6167 653a 2046 6c61 7420 746f  g stage: Flat to
-0002e470: 207b 6265 616d 5f74 7970 652e 6e61 6d65   {beam_type.name
-0002e480: 7d20 6265 616d 2c20 723d 7b72 3a2e 3266  } beam, r={r:.2f
-0002e490: 7d2c 2074 3d7b 743a 2e32 667d 2922 290a  }, t={t:.2f})").
-0002e4a0: 0a20 2020 2020 2020 2073 656c 662e 7374  .        self.st
-0002e4b0: 6167 655f 706f 7369 7469 6f6e 2e72 203d  age_position.r =
-0002e4c0: 206e 702e 6465 6732 7261 6428 7229 0a20   np.deg2rad(r). 
-0002e4d0: 2020 2020 2020 2073 656c 662e 7374 6167         self.stag
-0002e4e0: 655f 706f 7369 7469 6f6e 2e74 203d 206e  e_position.t = n
-0002e4f0: 702e 6465 6732 7261 6428 7429 0a20 2020  p.deg2rad(t).   
-0002e500: 200a 2020 2020 6465 6620 6765 745f 6d61   .    def get_ma
-0002e510: 6e69 7075 6c61 746f 725f 706f 7369 7469  nipulator_positi
-0002e520: 6f6e 2873 656c 6629 202d 3e20 4669 6273  on(self) -> Fibs
-0002e530: 656d 4d61 6e69 7075 6c61 746f 7250 6f73  emManipulatorPos
-0002e540: 6974 696f 6e3a 0a20 2020 2020 2020 205f  ition:.        _
-0002e550: 6368 6563 6b5f 6e65 6564 6c65 2873 656c  check_needle(sel
-0002e560: 662e 6861 7264 7761 7265 5f73 6574 7469  f.hardware_setti
-0002e570: 6e67 7329 0a20 2020 2020 2020 206c 6f67  ngs).        log
-0002e580: 6769 6e67 2e69 6e66 6f28 6622 4765 7474  ging.info(f"Gett
-0002e590: 696e 6720 6d61 6e69 7075 6c61 746f 7220  ing manipulator 
-0002e5a0: 706f 7369 7469 6f6e 3a20 7b73 656c 662e  position: {self.
-0002e5b0: 6d61 6e69 7075 6c61 746f 725f 706f 7369  manipulator_posi
-0002e5c0: 7469 6f6e 7d22 290a 2020 2020 2020 2020  tion}").        
-0002e5d0: 7265 7475 726e 2073 656c 662e 6d61 6e69  return self.mani
-0002e5e0: 7075 6c61 746f 725f 706f 7369 7469 6f6e  pulator_position
-0002e5f0: 0a0a 2020 2020 6465 6620 6765 745f 6d61  ..    def get_ma
-0002e600: 6e69 7075 6c61 746f 725f 7374 6174 6528  nipulator_state(
-0002e610: 7365 6c66 2c73 6574 7469 6e67 733a 4d69  self,settings:Mi
-0002e620: 6372 6f73 636f 7065 5365 7474 696e 6773  croscopeSettings
-0002e630: 3d4e 6f6e 6529 202d 3e20 626f 6f6c 3a0a  =None) -> bool:.
-0002e640: 2020 2020 2020 2020 5f63 6865 636b 5f6e          _check_n
-0002e650: 6565 646c 6528 7365 6c66 2e68 6172 6477  eedle(self.hardw
-0002e660: 6172 655f 7365 7474 696e 6773 290a 2020  are_settings).  
-0002e670: 2020 2020 2020 6966 2073 656c 662e 6d61        if self.ma
-0002e680: 6e69 7075 6c61 746f 725f 706f 7369 7469  nipulator_positi
-0002e690: 6f6e 2e78 203d 3d20 3020 616e 6420 7365  on.x == 0 and se
-0002e6a0: 6c66 2e6d 616e 6970 756c 6174 6f72 5f70  lf.manipulator_p
-0002e6b0: 6f73 6974 696f 6e2e 7920 3d3d 2030 2061  osition.y == 0 a
-0002e6c0: 6e64 2073 656c 662e 6d61 6e69 7075 6c61  nd self.manipula
-0002e6d0: 746f 725f 706f 7369 7469 6f6e 2e7a 203d  tor_position.z =
-0002e6e0: 3d20 303a 0a20 2020 2020 2020 2020 2020  = 0:.           
-0002e6f0: 2073 656c 662e 6d61 6e69 7075 6c61 746f   self.manipulato
-0002e700: 725f 7374 6174 6520 3d20 4661 6c73 650a  r_state = False.
-0002e710: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-0002e720: 2020 2020 2020 2020 2020 7365 6c66 2e6d            self.m
-0002e730: 616e 6970 756c 6174 6f72 5f73 7461 7465  anipulator_state
-0002e740: 203d 2054 7275 650a 2020 2020 2020 2020   = True.        
-0002e750: 0a20 2020 2020 2020 206c 6f67 6769 6e67  .        logging
-0002e760: 2e69 6e66 6f28 6622 4765 7474 696e 6720  .info(f"Getting 
-0002e770: 6d61 6e69 7075 6c61 746f 7220 7374 6174  manipulator stat
-0002e780: 653a 207b 7365 6c66 2e6d 616e 6970 756c  e: {self.manipul
-0002e790: 6174 6f72 5f73 7461 7465 7d22 290a 2020  ator_state}").  
-0002e7a0: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
-0002e7b0: 662e 6d61 6e69 7075 6c61 746f 725f 7374  f.manipulator_st
-0002e7c0: 6174 650a 0a20 2020 2064 6566 2069 6e73  ate..    def ins
-0002e7d0: 6572 745f 6d61 6e69 7075 6c61 746f 7228  ert_manipulator(
-0002e7e0: 7365 6c66 2c20 6e61 6d65 3a20 7374 7220  self, name: str 
-0002e7f0: 3d20 2250 4152 4b22 293a 0a20 2020 2020  = "PARK"):.     
-0002e800: 2020 205f 6368 6563 6b5f 6e65 6564 6c65     _check_needle
-0002e810: 2873 656c 662e 6861 7264 7761 7265 5f73  (self.hardware_s
-0002e820: 6574 7469 6e67 7329 0a20 2020 2020 2020  ettings).       
-0002e830: 206c 6f67 6769 6e67 2e69 6e66 6f28 6622   logging.info(f"
-0002e840: 496e 7365 7274 696e 6720 6d61 6e69 7075  Inserting manipu
-0002e850: 6c61 746f 7220 746f 207b 6e61 6d65 7d22  lator to {name}"
-0002e860: 290a 2020 2020 0a20 2020 2064 6566 2072  ).    .    def r
-0002e870: 6574 7261 6374 5f6d 616e 6970 756c 6174  etract_manipulat
-0002e880: 6f72 2873 656c 6629 3a0a 2020 2020 2020  or(self):.      
-0002e890: 2020 5f63 6865 636b 5f6e 6565 646c 6528    _check_needle(
-0002e8a0: 7365 6c66 2e68 6172 6477 6172 655f 7365  self.hardware_se
-0002e8b0: 7474 696e 6773 290a 2020 2020 2020 2020  ttings).        
-0002e8c0: 6c6f 6767 696e 672e 696e 666f 2866 2252  logging.info(f"R
-0002e8d0: 6574 7261 6374 696e 6720 6d61 6e69 7075  etracting manipu
-0002e8e0: 6c61 746f 7222 290a 2020 2020 0a20 2020  lator").    .   
-0002e8f0: 2064 6566 206d 6f76 655f 6d61 6e69 7075   def move_manipu
-0002e900: 6c61 746f 725f 7265 6c61 7469 7665 2873  lator_relative(s
-0002e910: 656c 662c 2070 6f73 6974 696f 6e3a 2046  elf, position: F
-0002e920: 6962 7365 6d4d 616e 6970 756c 6174 6f72  ibsemManipulator
-0002e930: 506f 7369 7469 6f6e 293a 0a20 2020 2020  Position):.     
-0002e940: 2020 2069 6620 6e6f 7420 6e70 2e69 7363     if not np.isc
-0002e950: 6c6f 7365 2870 6f73 6974 696f 6e2e 722c  lose(position.r,
-0002e960: 2030 2e30 293a 0a20 2020 2020 2020 2020   0.0):.         
-0002e970: 2020 2072 6f74 6174 696f 6e20 3d20 5472     rotation = Tr
-0002e980: 7565 0a20 2020 2020 2020 2065 6c73 653a  ue.        else:
-0002e990: 0a20 2020 2020 2020 2020 2020 2072 6f74  .            rot
-0002e9a0: 6174 696f 6e20 3d20 4661 6c73 650a 2020  ation = False.  
-0002e9b0: 2020 2020 2020 6966 206e 6f74 206e 702e        if not np.
-0002e9c0: 6973 636c 6f73 6528 706f 7369 7469 6f6e  isclose(position
-0002e9d0: 2e74 2c20 302e 3029 3a0a 2020 2020 2020  .t, 0.0):.      
-0002e9e0: 2020 2020 2020 7469 6c74 203d 2054 7275        tilt = Tru
-0002e9f0: 650a 2020 2020 2020 2020 656c 7365 3a0a  e.        else:.
-0002ea00: 2020 2020 2020 2020 2020 2020 7469 6c74              tilt
-0002ea10: 203d 2046 616c 7365 0a20 2020 2020 2020   = False.       
-0002ea20: 205f 6368 6563 6b5f 6e65 6564 6c65 2873   _check_needle(s
-0002ea30: 656c 662e 6861 7264 7761 7265 5f73 6574  elf.hardware_set
-0002ea40: 7469 6e67 732c 2072 6f74 6174 696f 6e2c  tings, rotation,
-0002ea50: 2074 696c 7429 0a20 2020 2020 2020 206c   tilt).        l
-0002ea60: 6f67 6769 6e67 2e69 6e66 6f28 6622 4d6f  ogging.info(f"Mo
-0002ea70: 7669 6e67 206d 616e 6970 756c 6174 6f72  ving manipulator
-0002ea80: 3a20 7b70 6f73 6974 696f 6e7d 2028 5265  : {position} (Re
-0002ea90: 6c61 7469 7665 2922 290a 2020 2020 2020  lative)").      
-0002eaa0: 2020 7365 6c66 2e6d 616e 6970 756c 6174    self.manipulat
-0002eab0: 6f72 5f70 6f73 6974 696f 6e20 2b3d 2070  or_position += p
-0002eac0: 6f73 6974 696f 6e0a 2020 2020 0a20 2020  osition.    .   
-0002ead0: 2064 6566 206d 6f76 655f 6d61 6e69 7075   def move_manipu
-0002eae0: 6c61 746f 725f 6162 736f 6c75 7465 2873  lator_absolute(s
-0002eaf0: 656c 662c 2070 6f73 6974 696f 6e3a 2046  elf, position: F
-0002eb00: 6962 7365 6d4d 616e 6970 756c 6174 6f72  ibsemManipulator
-0002eb10: 506f 7369 7469 6f6e 293a 0a20 2020 2020  Position):.     
-0002eb20: 2020 205f 6368 6563 6b5f 6e65 6564 6c65     _check_needle
-0002eb30: 2873 656c 662e 6861 7264 7761 7265 5f73  (self.hardware_s
-0002eb40: 6574 7469 6e67 7329 0a20 2020 2020 2020  ettings).       
-0002eb50: 206c 6f67 6769 6e67 2e69 6e66 6f28 6622   logging.info(f"
-0002eb60: 4d6f 7669 6e67 206d 616e 6970 756c 6174  Moving manipulat
-0002eb70: 6f72 3a20 7b70 6f73 6974 696f 6e7d 2028  or: {position} (
-0002eb80: 4162 736f 6c75 7465 2922 290a 2020 2020  Absolute)").    
-0002eb90: 2020 2020 7365 6c66 2e6d 616e 6970 756c      self.manipul
-0002eba0: 6174 6f72 5f70 6f73 6974 696f 6e20 3d20  ator_position = 
-0002ebb0: 706f 7369 7469 6f6e 0a20 2020 2020 2020  position.       
-0002ebc0: 2020 2020 2020 200a 2020 2020 6465 6620         .    def 
-0002ebd0: 6d6f 7665 5f6d 616e 6970 756c 6174 6f72  move_manipulator
-0002ebe0: 5f63 6f72 7265 6374 6564 2873 656c 662c  _corrected(self,
-0002ebf0: 2064 783a 2066 6c6f 6174 2c20 6479 3a20   dx: float, dy: 
-0002ec00: 666c 6f61 742c 2062 6561 6d5f 7479 7065  float, beam_type
-0002ec10: 3a20 4265 616d 5479 7065 293a 0a20 2020  : BeamType):.   
-0002ec20: 2020 2020 205f 6368 6563 6b5f 6e65 6564       _check_need
-0002ec30: 6c65 2873 656c 662e 6861 7264 7761 7265  le(self.hardware
-0002ec40: 5f73 6574 7469 6e67 7329 0a20 2020 2020  _settings).     
-0002ec50: 2020 206c 6f67 6769 6e67 2e69 6e66 6f28     logging.info(
-0002ec60: 6622 4d6f 7669 6e67 206d 616e 6970 756c  f"Moving manipul
-0002ec70: 6174 6f72 3a20 6478 3d7b 6478 3a2e 3265  ator: dx={dx:.2e
-0002ec80: 7d2c 2064 793d 7b64 793a 2e32 657d 2c20  }, dy={dy:.2e}, 
-0002ec90: 6265 616d 5f74 7970 6520 3d20 7b62 6561  beam_type = {bea
-0002eca0: 6d5f 7479 7065 2e6e 616d 657d 2028 436f  m_type.name} (Co
-0002ecb0: 7272 6563 7465 6429 2229 0a20 2020 2020  rrected)").     
-0002ecc0: 2020 2073 656c 662e 6d61 6e69 7075 6c61     self.manipula
-0002ecd0: 746f 725f 706f 7369 7469 6f6e 2e78 202b  tor_position.x +
-0002ece0: 3d20 6478 0a20 2020 2020 2020 2073 656c  = dx.        sel
-0002ecf0: 662e 6d61 6e69 7075 6c61 746f 725f 706f  f.manipulator_po
-0002ed00: 7369 7469 6f6e 2e79 202b 3d20 6479 0a20  sition.y += dy. 
-0002ed10: 2020 2020 2020 200a 0a20 2020 2064 6566         ..    def
-0002ed20: 206d 6f76 655f 6d61 6e69 7075 6c61 746f   move_manipulato
-0002ed30: 725f 746f 5f70 6f73 6974 696f 6e5f 6f66  r_to_position_of
-0002ed40: 6673 6574 2873 656c 662c 206f 6666 7365  fset(self, offse
-0002ed50: 743a 2046 6962 7365 6d4d 616e 6970 756c  t: FibsemManipul
-0002ed60: 6174 6f72 506f 7369 7469 6f6e 2c20 6e61  atorPosition, na
-0002ed70: 6d65 3a20 7374 7220 3d20 4e6f 6e65 2920  me: str = None) 
-0002ed80: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
-0002ed90: 205f 6368 6563 6b5f 6e65 6564 6c65 2873   _check_needle(s
-0002eda0: 656c 662e 6861 7264 7761 7265 5f73 6574  elf.hardware_set
-0002edb0: 7469 6e67 7329 0a20 2020 2020 2020 2069  tings).        i
-0002edc0: 6620 6e61 6d65 2069 7320 4e6f 6e65 3a0a  f name is None:.
-0002edd0: 2020 2020 2020 2020 2020 2020 6e61 6d65              name
-0002ede0: 203d 2022 4555 4345 4e54 5249 4322 0a0a   = "EUCENTRIC"..
-0002edf0: 2020 2020 2020 2020 706f 7369 7469 6f6e          position
-0002ee00: 203d 2073 656c 662e 5f67 6574 5f73 6176   = self._get_sav
-0002ee10: 6564 5f6d 616e 6970 756c 6174 6f72 5f70  ed_manipulator_p
-0002ee20: 6f73 6974 696f 6e28 6e61 6d65 290a 2020  osition(name).  
-0002ee30: 2020 2020 2020 0a20 2020 2020 2020 206c        .        l
-0002ee40: 6f67 6769 6e67 2e69 6e66 6f28 6622 4d6f  ogging.info(f"Mo
-0002ee50: 7669 6e67 206d 616e 6970 756c 6174 6f72  ving manipulator
-0002ee60: 3a20 7b6f 6666 7365 747d 2074 6f20 7b6e  : {offset} to {n
-0002ee70: 616d 657d 2229 0a20 2020 2020 2020 2073  ame}").        s
-0002ee80: 656c 662e 6d61 6e69 7075 6c61 746f 725f  elf.manipulator_
-0002ee90: 706f 7369 7469 6f6e 203d 2070 6f73 6974  position = posit
-0002eea0: 696f 6e20 2b20 6f66 6673 6574 0a0a 2020  ion + offset..  
-0002eeb0: 2020 6465 6620 5f67 6574 5f73 6176 6564    def _get_saved
-0002eec0: 5f6d 616e 6970 756c 6174 6f72 5f70 6f73  _manipulator_pos
-0002eed0: 6974 696f 6e28 7365 6c66 2c20 6e61 6d65  ition(self, name
-0002eee0: 3a20 7374 7220 3d20 2250 4152 4b22 2920  : str = "PARK") 
-0002eef0: 2d3e 2046 6962 7365 6d4d 616e 6970 756c  -> FibsemManipul
-0002ef00: 6174 6f72 506f 7369 7469 6f6e 3a0a 2020  atorPosition:.  
-0002ef10: 2020 2020 2020 5f63 6865 636b 5f6e 6565        _check_nee
-0002ef20: 646c 6528 7365 6c66 2e68 6172 6477 6172  dle(self.hardwar
-0002ef30: 655f 7365 7474 696e 6773 290a 0a20 2020  e_settings)..   
-0002ef40: 2020 2020 2069 6620 6e61 6d65 206e 6f74       if name not
-0002ef50: 2069 6e20 5b22 5041 524b 222c 2022 4555   in ["PARK", "EU
-0002ef60: 4345 4e54 5249 4322 5d3a 0a20 2020 2020  CENTRIC"]:.     
-0002ef70: 2020 2020 2020 2072 6169 7365 2056 616c         raise Val
-0002ef80: 7565 4572 726f 7228 6622 556e 6b6e 6f77  ueError(f"Unknow
-0002ef90: 6e20 6d61 6e69 7075 6c61 746f 7220 706f  n manipulator po
-0002efa0: 7369 7469 6f6e 3a20 7b6e 616d 657d 2229  sition: {name}")
-0002efb0: 0a20 2020 2020 2020 2069 6620 6e61 6d65  .        if name
-0002efc0: 203d 3d20 2250 4152 4b22 3a0a 2020 2020   == "PARK":.    
-0002efd0: 2020 2020 2020 2020 7265 7475 726e 2046          return F
-0002efe0: 6962 7365 6d4d 616e 6970 756c 6174 6f72  ibsemManipulator
-0002eff0: 506f 7369 7469 6f6e 2878 3d30 2c20 793d  Position(x=0, y=
-0002f000: 302c 207a 3d30 2c20 723d 302c 2074 3d30  0, z=0, r=0, t=0
-0002f010: 290a 2020 2020 2020 2020 6966 206e 616d  ).        if nam
-0002f020: 6520 3d3d 2022 4555 4345 4e54 5249 4322  e == "EUCENTRIC"
-0002f030: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-0002f040: 7475 726e 2046 6962 7365 6d4d 616e 6970  turn FibsemManip
-0002f050: 756c 6174 6f72 506f 7369 7469 6f6e 2878  ulatorPosition(x
-0002f060: 3d30 2c20 793d 302c 207a 3d30 2c20 723d  =0, y=0, z=0, r=
-0002f070: 302c 2074 3d30 290a 0a20 2020 2064 6566  0, t=0)..    def
-0002f080: 2073 6574 7570 5f6d 696c 6c69 6e67 2873   setup_milling(s
-0002f090: 656c 662c 206d 696c 6c5f 7365 7474 696e  elf, mill_settin
-0002f0a0: 6773 3a20 4669 6273 656d 4d69 6c6c 696e  gs: FibsemMillin
-0002f0b0: 6753 6574 7469 6e67 7329 3a0a 2020 2020  gSettings):.    
-0002f0c0: 2020 2020 5f63 6865 636b 5f62 6561 6d28      _check_beam(
-0002f0d0: 4265 616d 5479 7065 2e49 4f4e 2c20 7365  BeamType.ION, se
-0002f0e0: 6c66 2e68 6172 6477 6172 655f 7365 7474  lf.hardware_sett
-0002f0f0: 696e 6773 290a 2020 2020 2020 2020 6c6f  ings).        lo
-0002f100: 6767 696e 672e 696e 666f 2866 2253 6574  gging.info(f"Set
-0002f110: 7469 6e67 2075 7020 6d69 6c6c 696e 673a  ting up milling:
-0002f120: 207b 6d69 6c6c 5f73 6574 7469 6e67 732e   {mill_settings.
-0002f130: 7061 7474 6572 6e69 6e67 5f6d 6f64 657d  patterning_mode}
-0002f140: 2c20 7b6d 696c 6c5f 7365 7474 696e 6773  , {mill_settings
-0002f150: 7d22 290a 0a20 2020 2064 6566 2072 756e  }")..    def run
-0002f160: 5f6d 696c 6c69 6e67 2873 656c 662c 206d  _milling(self, m
-0002f170: 696c 6c69 6e67 5f63 7572 7265 6e74 3a20  illing_current: 
-0002f180: 666c 6f61 742c 2061 7379 6e63 683a 2062  float, asynch: b
-0002f190: 6f6f 6c20 3d20 4661 6c73 6529 202d 3e20  ool = False) -> 
-0002f1a0: 4e6f 6e65 3a0a 2020 2020 2020 2020 5f63  None:.        _c
-0002f1b0: 6865 636b 5f62 6561 6d28 4265 616d 5479  heck_beam(BeamTy
-0002f1c0: 7065 2e49 4f4e 2c20 7365 6c66 2e68 6172  pe.ION, self.har
-0002f1d0: 6477 6172 655f 7365 7474 696e 6773 290a  dware_settings).
-0002f1e0: 2020 2020 2020 2020 6c6f 6767 696e 672e          logging.
-0002f1f0: 696e 666f 2866 2252 756e 6e69 6e67 206d  info(f"Running m
-0002f200: 696c 6c69 6e67 3a20 7b6d 696c 6c69 6e67  illing: {milling
-0002f210: 5f63 7572 7265 6e74 3a2e 3265 7d2c 207b  _current:.2e}, {
-0002f220: 6173 796e 6368 7d22 290a 2020 2020 2020  asynch}").      
-0002f230: 2020 696d 706f 7274 2072 616e 646f 6d0a    import random.
-0002f240: 2020 2020 2020 2020 7469 6d65 2e73 6c65          time.sle
-0002f250: 6570 2872 616e 646f 6d2e 7261 6e64 696e  ep(random.randin
-0002f260: 7428 312c 2035 2929 0a0a 2020 2020 6465  t(1, 5))..    de
-0002f270: 6620 6669 6e69 7368 5f6d 696c 6c69 6e67  f finish_milling
-0002f280: 2873 656c 662c 2069 6d61 6769 6e67 5f63  (self, imaging_c
-0002f290: 7572 7265 6e74 3a20 666c 6f61 7429 202d  urrent: float) -
-0002f2a0: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
-0002f2b0: 5f63 6865 636b 5f62 6561 6d28 4265 616d  _check_beam(Beam
-0002f2c0: 5479 7065 2e49 4f4e 2c20 7365 6c66 2e68  Type.ION, self.h
-0002f2d0: 6172 6477 6172 655f 7365 7474 696e 6773  ardware_settings
-0002f2e0: 290a 2020 2020 2020 2020 6c6f 6767 696e  ).        loggin
-0002f2f0: 672e 696e 666f 2866 2246 696e 6973 6869  g.info(f"Finishi
-0002f300: 6e67 206d 696c 6c69 6e67 3a20 7b69 6d61  ng milling: {ima
-0002f310: 6769 6e67 5f63 7572 7265 6e74 3a2e 3265  ging_current:.2e
-0002f320: 7d22 290a 0a20 2020 2064 6566 2064 7261  }")..    def dra
-0002f330: 775f 7265 6374 616e 676c 6528 7365 6c66  w_rectangle(self
-0002f340: 2c20 7061 7474 6572 6e5f 7365 7474 696e  , pattern_settin
-0002f350: 6773 3a20 4669 6273 656d 5061 7474 6572  gs: FibsemPatter
-0002f360: 6e53 6574 7469 6e67 7329 202d 3e20 4e6f  nSettings) -> No
-0002f370: 6e65 3a0a 2020 2020 2020 2020 6c6f 6767  ne:.        logg
-0002f380: 696e 672e 696e 666f 2866 2244 7261 7769  ing.info(f"Drawi
-0002f390: 6e67 2072 6563 7461 6e67 6c65 3a20 7b70  ng rectangle: {p
-0002f3a0: 6174 7465 726e 5f73 6574 7469 6e67 737d  attern_settings}
-0002f3b0: 2229 0a0a 2020 2020 6465 6620 6472 6177  ")..    def draw
-0002f3c0: 5f6c 696e 6528 7365 6c66 2c20 7061 7474  _line(self, patt
-0002f3d0: 6572 6e5f 7365 7474 696e 6773 3a20 4669  ern_settings: Fi
-0002f3e0: 6273 656d 5061 7474 6572 6e53 6574 7469  bsemPatternSetti
-0002f3f0: 6e67 7329 202d 3e20 4e6f 6e65 3a0a 2020  ngs) -> None:.  
-0002f400: 2020 2020 2020 6c6f 6767 696e 672e 696e        logging.in
-0002f410: 666f 2866 2244 7261 7769 6e67 206c 696e  fo(f"Drawing lin
-0002f420: 653a 207b 7061 7474 6572 6e5f 7365 7474  e: {pattern_sett
-0002f430: 696e 6773 7d22 290a 0a20 2020 2064 6566  ings}")..    def
-0002f440: 2064 7261 775f 6369 7263 6c65 2873 656c   draw_circle(sel
-0002f450: 662c 2070 6174 7465 726e 5f73 6574 7469  f, pattern_setti
-0002f460: 6e67 733a 2046 6962 7365 6d50 6174 7465  ngs: FibsemPatte
-0002f470: 726e 5365 7474 696e 6773 2920 2d3e 204e  rnSettings) -> N
-0002f480: 6f6e 653a 0a20 2020 2020 2020 206c 6f67  one:.        log
-0002f490: 6769 6e67 2e69 6e66 6f28 6622 4472 6177  ging.info(f"Draw
-0002f4a0: 696e 6720 6369 7263 6c65 3a20 7b70 6174  ing circle: {pat
-0002f4b0: 7465 726e 5f73 6574 7469 6e67 737d 2229  tern_settings}")
-0002f4c0: 0a20 2020 200a 2020 2020 6465 6620 6472  .    .    def dr
-0002f4d0: 6177 5f61 6e6e 756c 7573 2873 656c 662c  aw_annulus(self,
-0002f4e0: 2070 6174 7465 726e 5f73 6574 7469 6e67   pattern_setting
-0002f4f0: 733a 2046 6962 7365 6d50 6174 7465 726e  s: FibsemPattern
-0002f500: 5365 7474 696e 6773 2920 2d3e 204e 6f6e  Settings) -> Non
-0002f510: 653a 0a20 2020 2020 2020 206c 6f67 6769  e:.        loggi
-0002f520: 6e67 2e69 6e66 6f28 6622 4472 6177 696e  ng.info(f"Drawin
-0002f530: 6720 616e 6e75 6c75 733a 207b 7061 7474  g annulus: {patt
-0002f540: 6572 6e5f 7365 7474 696e 6773 7d22 290a  ern_settings}").
-0002f550: 0a20 2020 2064 6566 2067 6574 5f73 6361  .    def get_sca
-0002f560: 6e5f 6469 7265 6374 696f 6e73 2873 656c  n_directions(sel
-0002f570: 6629 202d 3e20 6c69 7374 3a0a 2020 2020  f) -> list:.    
-0002f580: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-0002f590: 5265 7475 726e 7320 7468 6520 6176 6169  Returns the avai
-0002f5a0: 6c61 626c 6520 7363 616e 2064 6972 6563  lable scan direc
-0002f5b0: 7469 6f6e 7320 6f66 2074 6865 206d 6963  tions of the mic
-0002f5c0: 726f 7363 6f70 652e 0a0a 2020 2020 2020  roscope...      
-0002f5d0: 2020 5265 7475 726e 733a 0a20 2020 2020    Returns:.     
-0002f5e0: 2020 2020 2020 206c 6973 743a 2054 6865         list: The
-0002f5f0: 2073 6361 6e20 6469 7265 6374 696f 6e20   scan direction 
-0002f600: 6f66 2074 6865 206d 6963 726f 7363 6f70  of the microscop
-0002f610: 652e 0a0a 2020 2020 2020 2020 5261 6973  e...        Rais
-0002f620: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
-0002f630: 4e6f 6e65 0a20 2020 2020 2020 2022 2222  None.        """
-0002f640: 0a20 2020 2020 2020 206c 6973 7420 3d20  .        list = 
-0002f650: 5b22 426f 7474 6f6d 546f 546f 7022 2c20  ["BottomToTop", 
-0002f660: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002f670: 2022 4c65 6674 546f 5269 6768 7422 2c20   "LeftToRight", 
-0002f680: 090a 2020 2020 2020 2020 2020 2020 2020  ..              
-0002f690: 2020 2252 6967 6874 546f 4c65 6674 222c    "RightToLeft",
-0002f6a0: 2009 0a20 2020 2020 2020 2020 2020 2020   ..             
-0002f6b0: 2020 2022 546f 7054 6f42 6f74 746f 6d22     "TopToBottom"
-0002f6c0: 5d0a 2020 2020 2020 2020 7265 7475 726e  ].        return
-0002f6d0: 206c 6973 7420 0a0a 2020 2020 6465 6620   list ..    def 
-0002f6e0: 6472 6177 5f62 6974 6d61 705f 7061 7474  draw_bitmap_patt
-0002f6f0: 6572 6e28 7365 6c66 2c20 7061 7474 6572  ern(self, patter
-0002f700: 6e5f 7365 7474 696e 6773 3a20 4669 6273  n_settings: Fibs
-0002f710: 656d 5061 7474 6572 6e53 6574 7469 6e67  emPatternSetting
-0002f720: 732c 0a20 2020 2020 2020 2070 6174 683a  s,.        path:
-0002f730: 2073 7472 293a 0a20 2020 2020 2020 2072   str):.        r
-0002f740: 6574 7572 6e20 0a20 2020 2064 6566 2072  eturn .    def r
-0002f750: 756e 5f6d 696c 6c69 6e67 5f64 7269 6674  un_milling_drift
-0002f760: 5f63 6f72 7265 6374 6564 2873 656c 6629  _corrected(self)
-0002f770: 3a0a 2020 2020 2020 2020 5f63 6865 636b  :.        _check
-0002f780: 5f62 6561 6d28 4265 616d 5479 7065 2e49  _beam(BeamType.I
-0002f790: 4f4e 2c20 7365 6c66 2e68 6172 6477 6172  ON, self.hardwar
-0002f7a0: 655f 7365 7474 696e 6773 290a 2020 2020  e_settings).    
-0002f7b0: 2020 2020 7265 7475 726e 0a0a 2020 2020      return..    
-0002f7c0: 6465 6620 7365 7475 705f 7370 7574 7465  def setup_sputte
-0002f7d0: 7228 7365 6c66 2c20 7072 6f74 6f63 6f6c  r(self, protocol
-0002f7e0: 3a20 6469 6374 2920 2d3e 204e 6f6e 653a  : dict) -> None:
-0002f7f0: 0a20 2020 2020 2020 205f 6368 6563 6b5f  .        _check_
-0002f800: 7370 7574 7465 7228 7365 6c66 2e68 6172  sputter(self.har
-0002f810: 6477 6172 655f 7365 7474 696e 6773 290a  dware_settings).
-0002f820: 2020 2020 2020 2020 6c6f 6767 696e 672e          logging.
-0002f830: 696e 666f 2866 2253 6574 7469 6e67 2075  info(f"Setting u
-0002f840: 7020 7370 7574 7465 723a 207b 7072 6f74  p sputter: {prot
-0002f850: 6f63 6f6c 7d22 290a 0a20 2020 2064 6566  ocol}")..    def
-0002f860: 2064 7261 775f 7370 7574 7465 725f 7061   draw_sputter_pa
-0002f870: 7474 6572 6e28 7365 6c66 2c20 6866 773a  ttern(self, hfw:
-0002f880: 2066 6c6f 6174 2c20 6c69 6e65 5f70 6174   float, line_pat
-0002f890: 7465 726e 5f6c 656e 6774 683a 2066 6c6f  tern_length: flo
-0002f8a0: 6174 2c20 7370 7574 7465 725f 7469 6d65  at, sputter_time
-0002f8b0: 3a20 666c 6f61 7429 3a0a 2020 2020 2020  : float):.      
-0002f8c0: 2020 6c6f 6767 696e 672e 696e 666f 2866    logging.info(f
-0002f8d0: 2244 7261 7769 6e67 2073 7075 7474 6572  "Drawing sputter
-0002f8e0: 2070 6174 7465 726e 3a20 6866 773d 7b68   pattern: hfw={h
-0002f8f0: 6677 3a2e 3265 7d2c 206c 696e 655f 7061  fw:.2e}, line_pa
-0002f900: 7474 6572 6e5f 6c65 6e67 7468 3d7b 6c69  ttern_length={li
-0002f910: 6e65 5f70 6174 7465 726e 5f6c 656e 6774  ne_pattern_lengt
-0002f920: 683a 2e32 657d 2c20 7370 7574 7465 725f  h:.2e}, sputter_
-0002f930: 7469 6d65 3d7b 7370 7574 7465 725f 7469  time={sputter_ti
-0002f940: 6d65 3a2e 3265 7d22 290a 0a20 2020 2064  me:.2e}")..    d
-0002f950: 6566 2072 756e 5f73 7075 7474 6572 2873  ef run_sputter(s
-0002f960: 656c 662c 202a 2a6b 7761 7267 7329 3a0a  elf, **kwargs):.
-0002f970: 2020 2020 2020 2020 5f63 6865 636b 5f73          _check_s
-0002f980: 7075 7474 6572 2873 656c 662e 6861 7264  putter(self.hard
-0002f990: 7761 7265 5f73 6574 7469 6e67 7329 0a20  ware_settings). 
-0002f9a0: 2020 2020 2020 206c 6f67 6769 6e67 2e69         logging.i
-0002f9b0: 6e66 6f28 6622 5275 6e6e 696e 6720 7370  nfo(f"Running sp
-0002f9c0: 7574 7465 723a 207b 6b77 6172 6773 7d22  utter: {kwargs}"
-0002f9d0: 290a 0a20 2020 2064 6566 2066 696e 6973  )..    def finis
-0002f9e0: 685f 7370 7574 7465 7228 7365 6c66 2c20  h_sputter(self, 
-0002f9f0: 2a2a 6b77 6172 6773 293a 0a20 2020 2020  **kwargs):.     
-0002fa00: 2020 205f 6368 6563 6b5f 7370 7574 7465     _check_sputte
-0002fa10: 7228 7365 6c66 2e68 6172 6477 6172 655f  r(self.hardware_
-0002fa20: 7365 7474 696e 6773 290a 2020 2020 2020  settings).      
-0002fa30: 2020 6c6f 6767 696e 672e 696e 666f 2866    logging.info(f
-0002fa40: 2246 696e 6973 6869 6e67 2073 7075 7474  "Finishing sputt
-0002fa50: 6572 3a20 7b6b 7761 7267 737d 2229 0a0a  er: {kwargs}")..
-0002fa60: 2020 2020 6465 6620 4749 535f 6176 6169      def GIS_avai
-0002fa70: 6c61 626c 655f 6c69 6e65 7328 7365 6c66  lable_lines(self
-0002fa80: 2920 2d3e 206c 6973 745b 7374 725d 3a0a  ) -> list[str]:.
-0002fa90: 0a20 2020 2020 2020 2073 656c 662e 6769  .        self.gi
-0002faa0: 735f 6c69 6e65 7320 3d20 7b0a 2020 2020  s_lines = {.    
-0002fab0: 2020 2020 2020 2020 2257 6174 6572 223a          "Water":
-0002fac0: 2054 6865 726d 6f47 4953 4c69 6e65 284e   ThermoGISLine(N
-0002fad0: 6f6e 652c 2257 6174 6572 2229 2c0a 2020  one,"Water"),.  
-0002fae0: 2020 2020 2020 2020 2020 2250 7422 3a20            "Pt": 
-0002faf0: 5468 6572 6d6f 4749 534c 696e 6528 4e6f  ThermoGISLine(No
-0002fb00: 6e65 2c22 5074 2229 2c0a 2020 2020 2020  ne,"Pt"),.      
-0002fb10: 2020 2020 2020 2243 6172 626f 6e22 3a20        "Carbon": 
-0002fb20: 5468 6572 6d6f 4749 534c 696e 6528 4e6f  ThermoGISLine(No
-0002fb30: 6e65 2c22 4322 290a 2020 2020 2020 2020  ne,"C").        
-0002fb40: 7d0a 0a20 2020 2020 2020 2072 6574 7572  }..        retur
-0002fb50: 6e20 6c69 7374 2873 656c 662e 6769 735f  n list(self.gis_
-0002fb60: 6c69 6e65 732e 6b65 7973 2829 290a 0a20  lines.keys()).. 
-0002fb70: 2020 2064 6566 2047 4953 5f61 7661 696c     def GIS_avail
-0002fb80: 6162 6c65 5f70 6f73 6974 696f 6e73 2873  able_positions(s
-0002fb90: 656c 6629 202d 3e20 6c69 7374 5b73 7472  elf) -> list[str
-0002fba0: 5d3a 0a0a 2020 2020 2020 2020 706f 7369  ]:..        posi
-0002fbb0: 7469 6f6e 7320 3d20 5b22 496e 7365 7274  tions = ["Insert
-0002fbc0: 222c 2252 6574 7261 6374 225d 0a0a 2020  ","Retract"]..  
-0002fbd0: 2020 2020 2020 7265 7475 726e 2070 6f73        return pos
-0002fbe0: 6974 696f 6e73 0a0a 2020 2020 6465 6620  itions..    def 
-0002fbf0: 4749 535f 6d6f 7665 5f74 6f28 7365 6c66  GIS_move_to(self
-0002fc00: 2c6c 696e 655f 6e61 6d65 3a20 7374 722c  ,line_name: str,
-0002fc10: 2070 6f73 6974 696f 6e5f 6e61 6d65 3a20   position_name: 
-0002fc20: 7374 7229 202d 3e20 4e6f 6e65 3a0a 0a0a  str) -> None:...
-0002fc30: 2020 2020 2020 2020 6c69 6e65 203d 2073          line = s
-0002fc40: 656c 662e 6769 735f 6c69 6e65 735b 6c69  elf.gis_lines[li
-0002fc50: 6e65 5f6e 616d 655d 0a0a 2020 2020 2020  ne_name]..      
-0002fc60: 2020 6966 2070 6f73 6974 696f 6e5f 6e61    if position_na
-0002fc70: 6d65 203d 3d20 2249 6e73 6572 7422 3a0a  me == "Insert":.
-0002fc80: 0a20 2020 2020 2020 2020 2020 206c 696e  .            lin
-0002fc90: 652e 7374 6174 7573 203d 2022 496e 7365  e.status = "Inse
-0002fca0: 7274 6564 220a 0a20 2020 2020 2020 2069  rted"..        i
-0002fcb0: 6620 706f 7369 7469 6f6e 5f6e 616d 6520  f position_name 
-0002fcc0: 3d3d 2022 5265 7472 6163 7422 3a0a 0a20  == "Retract":.. 
-0002fcd0: 2020 2020 2020 2020 2020 206c 696e 652e             line.
-0002fce0: 7374 6174 7573 203d 2022 5265 7472 6163  status = "Retrac
-0002fcf0: 7465 6422 0a0a 2020 2020 6465 6620 4749  ted"..    def GI
-0002fd00: 535f 706f 7369 7469 6f6e 2873 656c 662c  S_position(self,
-0002fd10: 6c69 6e65 5f6e 616d 6529 3a0a 0a20 2020  line_name):..   
-0002fd20: 2020 2020 206c 696e 6520 3d20 7365 6c66       line = self
-0002fd30: 2e67 6973 5f6c 696e 6573 5b6c 696e 655f  .gis_lines[line_
-0002fd40: 6e61 6d65 5d0a 0a20 2020 2020 2020 2072  name]..        r
-0002fd50: 6574 7572 6e20 6c69 6e65 2e73 7461 7475  eturn line.statu
-0002fd60: 730a 0a20 2020 2064 6566 2047 4953 5f68  s..    def GIS_h
-0002fd70: 6561 745f 7570 2873 656c 662c 6c69 6e65  eat_up(self,line
-0002fd80: 5f6e 616d 6529 3a0a 0a0a 2020 2020 2020  _name):...      
-0002fd90: 2020 6c69 6e65 203d 2073 656c 662e 6769    line = self.gi
-0002fda0: 735f 6c69 6e65 735b 6c69 6e65 5f6e 616d  s_lines[line_nam
-0002fdb0: 655d 0a20 2020 2020 2020 2074 696d 652e  e].        time.
-0002fdc0: 736c 6565 7028 3529 0a20 2020 2020 2020  sleep(5).       
-0002fdd0: 206c 696e 652e 7465 6d70 5f72 6561 6479   line.temp_ready
-0002fde0: 203d 2054 7275 650a 0a20 2020 2064 6566   = True..    def
-0002fdf0: 2047 4953 5f74 656d 705f 7265 6164 7928   GIS_temp_ready(
-0002fe00: 7365 6c66 2c6c 696e 655f 6e61 6d65 293a  self,line_name):
-0002fe10: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
-0002fe20: 2073 656c 662e 6769 735f 6c69 6e65 735b   self.gis_lines[
-0002fe30: 6c69 6e65 5f6e 616d 655d 2e74 656d 705f  line_name].temp_
-0002fe40: 7265 6164 790a 0a20 2020 2064 6566 206d  ready..    def m
-0002fe50: 756c 7469 6368 656d 5f61 7661 696c 6162  ultichem_availab
-0002fe60: 6c65 5f6c 696e 6573 2873 656c 6629 3a0a  le_lines(self):.
-0002fe70: 0a20 2020 2020 2020 2073 656c 662e 6d75  .        self.mu
-0002fe80: 6c74 6963 6865 6d20 3d20 5468 6572 6d6f  ltichem = Thermo
-0002fe90: 4d75 6c74 6943 6865 6d4c 696e 6528 290a  MultiChemLine().
-0002fea0: 0a20 2020 2020 2020 2073 656c 662e 6d63  .        self.mc
-0002feb0: 5f6c 696e 6573 203d 205b 226d 635f 5761  _lines = ["mc_Wa
-0002fec0: 7465 7222 2c22 6d63 5f50 7422 2c22 6d63  ter","mc_Pt","mc
-0002fed0: 5f43 225d 0a0a 2020 2020 2020 2020 7365  _C"]..        se
-0002fee0: 6c66 2e6d 635f 6c69 6e65 735f 7465 6d70  lf.mc_lines_temp
-0002fef0: 203d 7b7d 0a0a 2020 2020 2020 2020 666f   ={}..        fo
-0002ff00: 7220 6c69 6e65 2069 6e20 7365 6c66 2e6d  r line in self.m
-0002ff10: 635f 6c69 6e65 733a 0a0a 2020 2020 2020  c_lines:..      
-0002ff20: 2020 2020 2020 7365 6c66 2e6d 635f 6c69        self.mc_li
-0002ff30: 6e65 735f 7465 6d70 5b6c 696e 655d 203d  nes_temp[line] =
-0002ff40: 2046 616c 7365 0a0a 2020 2020 2020 2020   False..        
-0002ff50: 7265 7475 726e 2073 656c 662e 6d63 5f6c  return self.mc_l
-0002ff60: 696e 6573 0a0a 2020 2020 6465 6620 6d75  ines..    def mu
-0002ff70: 6c74 6963 6865 6d5f 6176 6169 6c61 626c  ltichem_availabl
-0002ff80: 655f 706f 7369 7469 6f6e 7328 7365 6c66  e_positions(self
-0002ff90: 293a 0a0a 2020 2020 2020 2020 706f 7369  ):..        posi
-0002ffa0: 7469 6f6e 7320 3d20 7365 6c66 2e6d 756c  tions = self.mul
-0002ffb0: 7469 6368 656d 2e70 6f73 6974 696f 6e73  tichem.positions
-0002ffc0: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
-0002ffd0: 2070 6f73 6974 696f 6e73 0a0a 2020 2020   positions..    
-0002ffe0: 6465 6620 6d75 6c74 6963 6865 6d5f 6d6f  def multichem_mo
-0002fff0: 7665 5f74 6f28 7365 6c66 2c70 6f73 6974  ve_to(self,posit
-00030000: 696f 6e29 3a0a 0a20 2020 2020 2020 2069  ion):..        i
-00030010: 6620 706f 7369 7469 6f6e 203d 3d20 2252  f position == "R
-00030020: 6574 7261 6374 223a 0a20 2020 2020 2020  etract":.       
-00030030: 2020 2020 2073 656c 662e 6d75 6c74 6963       self.multic
-00030040: 6865 6d2e 7265 7472 6163 7428 290a 2020  hem.retract().  
-00030050: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00030060: 2020 2020 2020 2020 7365 6c66 2e6d 756c          self.mul
-00030070: 7469 6368 656d 2e69 6e73 6572 7428 706f  tichem.insert(po
-00030080: 7369 7469 6f6e 290a 0a20 2020 2064 6566  sition)..    def
-00030090: 206d 756c 7469 6368 656d 5f70 6f73 6974   multichem_posit
-000300a0: 696f 6e28 7365 6c66 293a 0a0a 2020 2020  ion(self):..    
-000300b0: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
-000300c0: 6d75 6c74 6963 6865 6d2e 6375 7272 656e  multichem.curren
-000300d0: 745f 706f 7369 7469 6f6e 0a0a 2020 2020  t_position..    
-000300e0: 6465 6620 6d75 6c74 6963 6865 6d5f 6865  def multichem_he
-000300f0: 6174 5f75 7028 7365 6c66 2c6c 696e 653a  at_up(self,line:
-00030100: 7374 7229 3a0a 0a20 2020 2020 2020 205f  str):..        _
-00030110: 6368 6563 6b5f 7370 7574 7465 7228 7365  check_sputter(se
-00030120: 6c66 2e68 6172 6477 6172 655f 7365 7474  lf.hardware_sett
-00030130: 696e 6773 290a 0a20 2020 2020 2020 2061  ings)..        a
-00030140: 7373 6572 7420 6c69 6e65 2069 6e20 7365  ssert line in se
-00030150: 6c66 2e6d 635f 6c69 6e65 732c 2022 4c69  lf.mc_lines, "Li
-00030160: 6e65 206e 6f74 2061 7661 696c 6162 6c65  ne not available
-00030170: 220a 0a20 2020 2020 2020 2074 696d 652e  "..        time.
-00030180: 736c 6565 7028 3329 0a0a 2020 2020 2020  sleep(3)..      
-00030190: 2020 7365 6c66 2e6d 635f 6c69 6e65 735f    self.mc_lines_
-000301a0: 7465 6d70 5b6c 696e 655d 203d 2054 7275  temp[line] = Tru
-000301b0: 650a 0a20 2020 2064 6566 206d 756c 7469  e..    def multi
-000301c0: 6368 656d 5f74 656d 705f 7265 6164 7928  chem_temp_ready(
-000301d0: 7365 6c66 2c6c 696e 653a 7374 7229 202d  self,line:str) -
-000301e0: 3e20 626f 6f6c 3a0a 0a20 2020 2020 2020  > bool:..       
-000301f0: 205f 6368 6563 6b5f 7370 7574 7465 7228   _check_sputter(
-00030200: 7365 6c66 2e68 6172 6477 6172 655f 7365  self.hardware_se
-00030210: 7474 696e 6773 290a 0a20 2020 2020 2020  ttings)..       
-00030220: 2061 7373 6572 7420 6c69 6e65 2069 6e20   assert line in 
-00030230: 7365 6c66 2e6d 635f 6c69 6e65 732c 2022  self.mc_lines, "
-00030240: 4c69 6e65 206e 6f74 2061 7661 696c 6162  Line not availab
-00030250: 6c65 220a 0a20 2020 2020 2020 2072 6574  le"..        ret
-00030260: 7572 6e20 7365 6c66 2e6d 635f 6c69 6e65  urn self.mc_line
-00030270: 735f 7465 6d70 5b6c 696e 655d 0a0a 2020  s_temp[line]..  
-00030280: 2020 6465 6620 7365 745f 6d69 6372 6f73    def set_micros
-00030290: 636f 7065 5f73 7461 7465 2873 656c 662c  cope_state(self,
-000302a0: 2073 7461 7465 3a20 4d69 6372 6f73 636f   state: Microsco
-000302b0: 7065 5374 6174 6529 3a0a 0a20 2020 2020  peState):..     
-000302c0: 2020 205f 6368 6563 6b5f 7370 7574 7465     _check_sputte
-000302d0: 7228 7365 6c66 2e68 6172 6477 6172 655f  r(self.hardware_
-000302e0: 7365 7474 696e 6773 290a 2020 2020 2020  settings).      
-000302f0: 2020 5f63 6865 636b 5f6e 6565 646c 6528    _check_needle(
-00030300: 7365 6c66 2e68 6172 6477 6172 655f 7365  self.hardware_se
-00030310: 7474 696e 6773 290a 2020 2020 2020 2020  ttings).        
-00030320: 5f63 6865 636b 5f62 6561 6d28 4265 616d  _check_beam(Beam
-00030330: 5479 7065 2e49 4f4e 2c20 7365 6c66 2e68  Type.ION, self.h
-00030340: 6172 6477 6172 655f 7365 7474 696e 6773  ardware_settings
-00030350: 290a 2020 2020 2020 2020 5f63 6865 636b  ).        _check
-00030360: 5f62 6561 6d28 4265 616d 5479 7065 2e45  _beam(BeamType.E
-00030370: 4c45 4354 524f 4e2c 2073 656c 662e 6861  LECTRON, self.ha
-00030380: 7264 7761 7265 5f73 6574 7469 6e67 7329  rdware_settings)
-00030390: 0a20 2020 2020 2020 205f 6368 6563 6b5f  .        _check_
-000303a0: 7374 6167 6528 7365 6c66 2e68 6172 6477  stage(self.hardw
-000303b0: 6172 655f 7365 7474 696e 6773 290a 2020  are_settings).  
-000303c0: 2020 2020 2020 7365 6c66 2e6d 6f76 655f        self.move_
-000303d0: 7374 6167 655f 6162 736f 6c75 7465 2873  stage_absolute(s
-000303e0: 7461 7465 2e61 6273 6f6c 7574 655f 706f  tate.absolute_po
-000303f0: 7369 7469 6f6e 290a 2020 2020 2020 2020  sition).        
-00030400: 6c6f 6767 696e 672e 696e 666f 2866 2253  logging.info(f"S
-00030410: 6574 7469 6e67 206d 6963 726f 7363 6f70  etting microscop
-00030420: 6520 7374 6174 6522 290a 2020 2020 2020  e state").      
-00030430: 2020 0a0a 2020 2020 6465 6620 6765 745f    ..    def get_
-00030440: 6176 6169 6c61 626c 655f 7661 6c75 6573  available_values
-00030450: 2873 656c 662c 206b 6579 3a20 7374 722c  (self, key: str,
-00030460: 2062 6561 6d5f 7479 7065 3a20 4265 616d   beam_type: Beam
-00030470: 5479 7065 203d 204e 6f6e 6529 202d 3e20  Type = None) -> 
-00030480: 6c69 7374 5b66 6c6f 6174 5d3a 0a20 2020  list[float]:.   
-00030490: 2020 2020 200a 2020 2020 2020 2020 7661       .        va
-000304a0: 6c75 6573 203d 205b 5d0a 2020 2020 2020  lues = [].      
-000304b0: 2020 6966 206b 6579 203d 3d20 2263 7572    if key == "cur
-000304c0: 7265 6e74 223a 0a20 2020 2020 2020 2020  rent":.         
-000304d0: 2020 205f 6368 6563 6b5f 6265 616d 2862     _check_beam(b
-000304e0: 6561 6d5f 7479 7065 2c20 7365 6c66 2e68  eam_type, self.h
-000304f0: 6172 6477 6172 655f 7365 7474 696e 6773  ardware_settings
-00030500: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
-00030510: 2062 6561 6d5f 7479 7065 203d 3d20 4265   beam_type == Be
-00030520: 616d 5479 7065 2e45 4c45 4354 524f 4e3a  amType.ELECTRON:
-00030530: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00030540: 2076 616c 7565 7320 3d20 5b31 2e30 652d   values = [1.0e-
-00030550: 3132 5d0a 2020 2020 2020 2020 2020 2020  12].            
-00030560: 6966 2062 6561 6d5f 7479 7065 203d 3d20  if beam_type == 
-00030570: 4265 616d 5479 7065 2e49 4f4e 3a0a 2020  BeamType.ION:.  
-00030580: 2020 2020 2020 2020 2020 2020 2020 7661                va
-00030590: 6c75 6573 203d 205b 3230 652d 3132 2c20  lues = [20e-12, 
-000305a0: 3630 652d 3132 2c20 302e 3265 2d39 2c20  60e-12, 0.2e-9, 
-000305b0: 302e 3734 652d 392c 2032 2e30 652d 392c  0.74e-9, 2.0e-9,
-000305c0: 2037 2e36 652d 392c 2032 382e 3065 2d39   7.6e-9, 28.0e-9
-000305d0: 2c20 3132 3065 2d39 5d0a 2020 2020 2020  , 120e-9].      
-000305e0: 2020 0a0a 2020 2020 2020 2020 6966 206b    ..        if k
-000305f0: 6579 203d 3d20 2261 7070 6c69 6361 7469  ey == "applicati
-00030600: 6f6e 5f66 696c 6522 3a0a 2020 2020 2020  on_file":.      
-00030610: 2020 2020 2020 7661 6c75 6573 203d 205b        values = [
-00030620: 2253 6922 2c20 2261 7574 6f6c 616d 656c  "Si", "autolamel
-00030630: 6c61 222c 2022 6372 796f 5f50 745f 6465  la", "cryo_Pt_de
-00030640: 7022 5d0a 0a20 2020 2020 2020 2069 6620  p"]..        if 
-00030650: 6b65 7920 3d3d 2022 6465 7465 6374 6f72  key == "detector
-00030660: 5f74 7970 6522 3a0a 2020 2020 2020 2020  _type":.        
-00030670: 2020 2020 7661 6c75 6573 203d 205b 2245      values = ["E
-00030680: 5444 222c 2022 544c 4422 2c20 2245 4453  TD", "TLD", "EDS
-00030690: 225d 0a20 2020 2020 2020 2069 6620 6b65  "].        if ke
-000306a0: 7920 3d3d 2022 6465 7465 6374 6f72 5f6d  y == "detector_m
-000306b0: 6f64 6522 3a0a 2020 2020 2020 2020 2020  ode":.          
-000306c0: 2020 7661 6c75 6573 203d 205b 2253 6563    values = ["Sec
-000306d0: 6f6e 6461 7279 456c 6563 7472 6f6e 7322  ondaryElectrons"
-000306e0: 2c20 2242 6163 6b73 6361 7474 6572 6564  , "Backscattered
-000306f0: 456c 6563 7472 6f6e 7322 2c20 2245 4453  Electrons", "EDS
-00030700: 225d 0a0a 2020 2020 2020 2020 7265 7475  "]..        retu
-00030710: 726e 2076 616c 7565 730a 0a20 2020 2064  rn values..    d
-00030720: 6566 2067 6574 5f62 6561 6d5f 7365 7474  ef get_beam_sett
-00030730: 696e 6773 2873 656c 662c 2062 6561 6d5f  ings(self, beam_
-00030740: 7479 7065 3a20 4265 616d 5479 7065 2920  type: BeamType) 
-00030750: 2d3e 2042 6561 6d53 6574 7469 6e67 733a  -> BeamSettings:
-00030760: 0a20 2020 2020 2020 2062 6561 6d5f 7365  .        beam_se
-00030770: 7474 696e 6773 203d 2042 6561 6d53 6574  ttings = BeamSet
-00030780: 7469 6e67 7328 0a20 2020 2020 2020 2020  tings(.         
-00030790: 2020 2062 6561 6d5f 7479 7065 3d62 6561     beam_type=bea
-000307a0: 6d5f 7479 7065 2c0a 2020 2020 2020 2020  m_type,.        
-000307b0: 2020 2020 766f 6c74 6167 653d 7365 6c66      voltage=self
-000307c0: 2e67 6574 2822 766f 6c74 6167 6522 2c20  .get("voltage", 
-000307d0: 6265 616d 5f74 7970 6529 2c0a 2020 2020  beam_type),.    
-000307e0: 2020 2020 2020 2020 6265 616d 5f63 7572          beam_cur
-000307f0: 7265 6e74 3d73 656c 662e 6765 7428 2263  rent=self.get("c
-00030800: 7572 7265 6e74 222c 2062 6561 6d5f 7479  urrent", beam_ty
-00030810: 7065 292c 0a20 2020 2020 2020 2020 2020  pe),.           
-00030820: 2077 6f72 6b69 6e67 5f64 6973 7461 6e63   working_distanc
-00030830: 653d 7365 6c66 2e67 6574 2822 776f 726b  e=self.get("work
-00030840: 696e 675f 6469 7374 616e 6365 222c 2062  ing_distance", b
-00030850: 6561 6d5f 7479 7065 292c 0a20 2020 2020  eam_type),.     
-00030860: 2020 2020 2020 2068 6677 3d73 656c 662e         hfw=self.
-00030870: 6765 7428 2268 6677 222c 2062 6561 6d5f  get("hfw", beam_
-00030880: 7479 7065 292c 0a20 2020 2020 2020 2020  type),.         
-00030890: 2020 2073 7469 676d 6174 696f 6e3d 7365     stigmation=se
-000308a0: 6c66 2e67 6574 2822 7374 6967 6d61 7469  lf.get("stigmati
-000308b0: 6f6e 222c 2062 6561 6d5f 7479 7065 292c  on", beam_type),
-000308c0: 0a20 2020 2020 2020 2020 2020 2073 6869  .            shi
-000308d0: 6674 3d73 656c 662e 6765 7428 2273 6869  ft=self.get("shi
-000308e0: 6674 222c 2062 6561 6d5f 7479 7065 292c  ft", beam_type),
-000308f0: 0a20 2020 2020 2020 2020 2020 2072 6573  .            res
-00030900: 6f6c 7574 696f 6e3d 7365 6c66 2e67 6574  olution=self.get
-00030910: 2822 7265 736f 6c75 7469 6f6e 222c 2062  ("resolution", b
-00030920: 6561 6d5f 7479 7065 292c 0a20 2020 2020  eam_type),.     
-00030930: 2020 2020 2020 2064 7765 6c6c 5f74 696d         dwell_tim
-00030940: 653d 7365 6c66 2e67 6574 2822 6477 656c  e=self.get("dwel
-00030950: 6c5f 7469 6d65 222c 2062 6561 6d5f 7479  l_time", beam_ty
-00030960: 7065 292c 0a20 2020 2020 2020 2029 0a20  pe),.        ). 
-00030970: 2020 2020 2020 2072 6574 7572 6e20 6265         return be
-00030980: 616d 5f73 6574 7469 6e67 730a 2020 2020  am_settings.    
-00030990: 0a20 2020 2064 6566 2067 6574 5f64 6574  .    def get_det
-000309a0: 6563 746f 725f 7365 7474 696e 6773 2873  ector_settings(s
-000309b0: 656c 662c 2062 6561 6d5f 7479 7065 3a20  elf, beam_type: 
-000309c0: 4265 616d 5479 7065 2920 2d3e 2046 6962  BeamType) -> Fib
-000309d0: 7365 6d44 6574 6563 746f 7253 6574 7469  semDetectorSetti
-000309e0: 6e67 733a 0a20 2020 2020 2020 2064 6574  ngs:.        det
-000309f0: 6563 746f 725f 7365 7474 696e 6773 203d  ector_settings =
-00030a00: 2046 6962 7365 6d44 6574 6563 746f 7253   FibsemDetectorS
-00030a10: 6574 7469 6e67 7328 0a20 2020 2020 2020  ettings(.       
-00030a20: 2020 2020 2064 7479 7065 3d73 656c 662e       dtype=self.
-00030a30: 6765 7428 2264 6574 6563 746f 725f 7479  get("detector_ty
-00030a40: 7065 222c 2062 6561 6d5f 7479 7065 292c  pe", beam_type),
-00030a50: 0a20 2020 2020 2020 2020 2020 206d 6f64  .            mod
-00030a60: 653d 7365 6c66 2e67 6574 2822 6465 7465  e=self.get("dete
-00030a70: 6374 6f72 5f6d 6f64 6522 2c20 6265 616d  ctor_mode", beam
-00030a80: 5f74 7970 6529 2c0a 2020 2020 2020 2020  _type),.        
-00030a90: 2020 2020 6272 6967 6874 6e65 7373 3d73      brightness=s
-00030aa0: 656c 662e 6765 7428 2264 6574 6563 746f  elf.get("detecto
-00030ab0: 725f 6272 6967 6874 6e65 7373 222c 2062  r_brightness", b
-00030ac0: 6561 6d5f 7479 7065 292c 0a20 2020 2020  eam_type),.     
-00030ad0: 2020 2020 2020 2063 6f6e 7472 6173 743d         contrast=
-00030ae0: 7365 6c66 2e67 6574 2822 6465 7465 6374  self.get("detect
-00030af0: 6f72 5f63 6f6e 7472 6173 7422 2c20 6265  or_contrast", be
-00030b00: 616d 5f74 7970 6529 2c0a 2020 2020 2020  am_type),.      
-00030b10: 2020 290a 2020 2020 2020 2020 7265 7475    ).        retu
-00030b20: 726e 2064 6574 6563 746f 725f 7365 7474  rn detector_sett
-00030b30: 696e 6773 0a0a 2020 2020 6465 6620 6765  ings..    def ge
-00030b40: 7428 7365 6c66 2c20 6b65 792c 2062 6561  t(self, key, bea
-00030b50: 6d5f 7479 7065 3a20 4265 616d 5479 7065  m_type: BeamType
-00030b60: 203d 204e 6f6e 6529 202d 3e20 666c 6f61   = None) -> floa
-00030b70: 743a 0a20 2020 2020 2020 206c 6f67 6769  t:.        loggi
-00030b80: 6e67 2e64 6562 7567 2866 2247 6574 7469  ng.debug(f"Getti
-00030b90: 6e67 207b 6b65 797d 2028 7b62 6561 6d5f  ng {key} ({beam_
-00030ba0: 7479 7065 7d29 2229 0a0a 2020 2020 2020  type})")..      
-00030bb0: 2020 2320 6765 7420 6265 616d 0a20 2020    # get beam.   
-00030bc0: 2020 2020 2069 6620 6265 616d 5f74 7970       if beam_typ
-00030bd0: 6520 6973 206e 6f74 204e 6f6e 653a 0a20  e is not None:. 
-00030be0: 2020 2020 2020 2020 2020 2062 6561 6d20             beam 
-00030bf0: 3d20 7365 6c66 2e65 6c65 6374 726f 6e5f  = self.electron_
-00030c00: 6265 616d 2069 6620 6265 616d 5f74 7970  beam if beam_typ
-00030c10: 6520 6973 2042 6561 6d54 7970 652e 454c  e is BeamType.EL
-00030c20: 4543 5452 4f4e 2065 6c73 6520 7365 6c66  ECTRON else self
-00030c30: 2e69 6f6e 5f62 6561 6d0a 2020 2020 2020  .ion_beam.      
-00030c40: 2020 2020 2020 6465 7465 6374 6f72 203d        detector =
-00030c50: 2073 656c 662e 656c 6563 7472 6f6e 5f64   self.electron_d
-00030c60: 6574 6563 746f 725f 7365 7474 696e 6773  etector_settings
-00030c70: 2069 6620 6265 616d 5f74 7970 6520 6973   if beam_type is
-00030c80: 2042 6561 6d54 7970 652e 454c 4543 5452   BeamType.ELECTR
-00030c90: 4f4e 2065 6c73 6520 7365 6c66 2e69 6f6e  ON else self.ion
-00030ca0: 5f64 6574 6563 746f 725f 7365 7474 696e  _detector_settin
-00030cb0: 6773 0a20 2020 2020 2020 2023 2076 6f6c  gs.        # vol
-00030cc0: 7461 6765 0a20 2020 2020 2020 2069 6620  tage.        if 
-00030cd0: 6b65 7920 3d3d 2022 766f 6c74 6167 6522  key == "voltage"
-00030ce0: 3a0a 2020 2020 2020 2020 2020 2020 5f63  :.            _c
-00030cf0: 6865 636b 5f62 6561 6d28 6265 616d 5f74  heck_beam(beam_t
-00030d00: 7970 652c 2073 656c 662e 6861 7264 7761  ype, self.hardwa
-00030d10: 7265 5f73 6574 7469 6e67 7329 0a20 2020  re_settings).   
-00030d20: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-00030d30: 6265 616d 2e76 6f6c 7461 6765 0a20 2020  beam.voltage.   
-00030d40: 2020 2020 2020 2020 200a 2020 2020 2020           .      
-00030d50: 2020 2320 6375 7272 656e 740a 2020 2020    # current.    
-00030d60: 2020 2020 6966 206b 6579 203d 3d20 2263      if key == "c
-00030d70: 7572 7265 6e74 223a 0a20 2020 2020 2020  urrent":.       
-00030d80: 2020 2020 205f 6368 6563 6b5f 6265 616d       _check_beam
-00030d90: 2862 6561 6d5f 7479 7065 2c20 7365 6c66  (beam_type, self
-00030da0: 2e68 6172 6477 6172 655f 7365 7474 696e  .hardware_settin
-00030db0: 6773 290a 2020 2020 2020 2020 2020 2020  gs).            
-00030dc0: 7265 7475 726e 2062 6561 6d2e 6265 616d  return beam.beam
-00030dd0: 5f63 7572 7265 6e74 0a0a 2020 2020 2020  _current..      
-00030de0: 2020 2320 776f 726b 696e 6720 6469 7374    # working dist
-00030df0: 616e 6365 0a20 2020 2020 2020 2069 6620  ance.        if 
-00030e00: 6b65 7920 3d3d 2022 776f 726b 696e 675f  key == "working_
-00030e10: 6469 7374 616e 6365 223a 0a20 2020 2020  distance":.     
-00030e20: 2020 2020 2020 205f 6368 6563 6b5f 6265         _check_be
-00030e30: 616d 2862 6561 6d5f 7479 7065 2c20 7365  am(beam_type, se
-00030e40: 6c66 2e68 6172 6477 6172 655f 7365 7474  lf.hardware_sett
-00030e50: 696e 6773 290a 2020 2020 2020 2020 2020  ings).          
-00030e60: 2020 7265 7475 726e 2062 6561 6d2e 776f    return beam.wo
-00030e70: 726b 696e 675f 6469 7374 616e 6365 0a20  rking_distance. 
-00030e80: 2020 2020 2020 200a 2020 2020 2020 2020         .        
-00030e90: 6966 206b 6579 203d 3d20 2273 7469 676d  if key == "stigm
-00030ea0: 6174 696f 6e22 3a0a 2020 2020 2020 2020  ation":.        
-00030eb0: 2020 2020 5f63 6865 636b 5f62 6561 6d28      _check_beam(
-00030ec0: 6265 616d 5f74 7970 652c 2073 656c 662e  beam_type, self.
-00030ed0: 6861 7264 7761 7265 5f73 6574 7469 6e67  hardware_setting
-00030ee0: 7329 0a20 2020 2020 2020 2020 2020 2072  s).            r
-00030ef0: 6574 7572 6e20 506f 696e 7428 6265 616d  eturn Point(beam
-00030f00: 2e73 7469 676d 6174 696f 6e2e 782c 2062  .stigmation.x, b
-00030f10: 6561 6d2e 7374 6967 6d61 7469 6f6e 2e79  eam.stigmation.y
-00030f20: 290a 2020 2020 2020 2020 6966 206b 6579  ).        if key
-00030f30: 203d 3d20 2273 6869 6674 223a 0a20 2020   == "shift":.   
-00030f40: 2020 2020 2020 2020 205f 6368 6563 6b5f           _check_
-00030f50: 6265 616d 2862 6561 6d5f 7479 7065 2c20  beam(beam_type, 
-00030f60: 7365 6c66 2e68 6172 6477 6172 655f 7365  self.hardware_se
-00030f70: 7474 696e 6773 290a 2020 2020 2020 2020  ttings).        
-00030f80: 2020 2020 7265 7475 726e 2050 6f69 6e74      return Point
-00030f90: 2862 6561 6d2e 7368 6966 742e 782c 2062  (beam.shift.x, b
-00030fa0: 6561 6d2e 7368 6966 742e 7929 0a0a 2020  eam.shift.y)..  
-00030fb0: 2020 2020 2020 6966 206b 6579 203d 3d20        if key == 
-00030fc0: 2273 6361 6e5f 726f 7461 7469 6f6e 223a  "scan_rotation":
-00030fd0: 0a20 2020 2020 2020 2020 2020 205f 6368  .            _ch
-00030fe0: 6563 6b5f 6265 616d 2862 6561 6d5f 7479  eck_beam(beam_ty
-00030ff0: 7065 2c20 7365 6c66 2e68 6172 6477 6172  pe, self.hardwar
-00031000: 655f 7365 7474 696e 6773 290a 2020 2020  e_settings).    
-00031010: 2020 2020 2020 2020 7265 7475 726e 2062          return b
-00031020: 6561 6d2e 7363 616e 5f72 6f74 6174 696f  eam.scan_rotatio
-00031030: 6e0a 0a20 2020 2020 2020 2069 6620 6b65  n..        if ke
-00031040: 7920 3d3d 2022 6465 7465 6374 6f72 5f74  y == "detector_t
-00031050: 7970 6522 3a0a 2020 2020 2020 2020 2020  ype":.          
-00031060: 2020 7265 7475 726e 2064 6574 6563 746f    return detecto
-00031070: 722e 7479 7065 0a20 2020 2020 2020 2069  r.type.        i
-00031080: 6620 6b65 7920 3d3d 2022 6465 7465 6374  f key == "detect
-00031090: 6f72 5f6d 6f64 6522 3a0a 2020 2020 2020  or_mode":.      
-000310a0: 2020 2020 2020 7265 7475 726e 2064 6574        return det
-000310b0: 6563 746f 722e 6d6f 6465 0a20 2020 2020  ector.mode.     
-000310c0: 2020 2069 6620 6b65 7920 3d3d 2022 6465     if key == "de
-000310d0: 7465 6374 6f72 5f62 7269 6768 746e 6573  tector_brightnes
-000310e0: 7322 3a0a 2020 2020 2020 2020 2020 2020  s":.            
-000310f0: 7265 7475 726e 2064 6574 6563 746f 722e  return detector.
-00031100: 6272 6967 6874 6e65 7373 0a20 2020 2020  brightness.     
-00031110: 2020 2069 6620 6b65 7920 3d3d 2022 6465     if key == "de
-00031120: 7465 6374 6f72 5f63 6f6e 7472 6173 7422  tector_contrast"
-00031130: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-00031140: 7475 726e 2064 6574 6563 746f 722e 636f  turn detector.co
-00031150: 6e74 7261 7374 0a0a 2020 2020 2020 2020  ntrast..        
-00031160: 6c6f 6767 696e 672e 7761 726e 696e 6728  logging.warning(
-00031170: 6622 556e 6b6e 6f77 6e20 6b65 793a 207b  f"Unknown key: {
-00031180: 6b65 797d 2028 7b62 6561 6d5f 7479 7065  key} ({beam_type
-00031190: 7d29 2229 0a20 2020 2020 2020 2072 6574  })").        ret
-000311a0: 7572 6e20 4e6f 7449 6d70 6c65 6d65 6e74  urn NotImplement
-000311b0: 6564 0a0a 2020 2020 6465 6620 7365 7428  ed..    def set(
-000311c0: 7365 6c66 2c20 6b65 793a 2073 7472 2c20  self, key: str, 
-000311d0: 7661 6c75 652c 2062 6561 6d5f 7479 7065  value, beam_type
-000311e0: 3a20 4265 616d 5479 7065 203d 204e 6f6e  : BeamType = Non
-000311f0: 6529 202d 3e20 4e6f 6e65 3a0a 2020 2020  e) -> None:.    
-00031200: 2020 2020 6c6f 6767 696e 672e 696e 666f      logging.info
-00031210: 2866 2253 6574 7469 6e67 207b 6b65 797d  (f"Setting {key}
-00031220: 2074 6f20 7b76 616c 7565 7d20 287b 6265   to {value} ({be
-00031230: 616d 5f74 7970 657d 2922 290a 2020 2020  am_type})").    
-00031240: 2020 2020 0a20 2020 2020 2020 2023 2067      .        # g
-00031250: 6574 2062 6561 6d0a 2020 2020 2020 2020  et beam.        
-00031260: 6966 2062 6561 6d5f 7479 7065 2069 7320  if beam_type is 
-00031270: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
-00031280: 2020 2020 2020 6265 616d 203d 2073 656c        beam = sel
-00031290: 662e 656c 6563 7472 6f6e 5f62 6561 6d20  f.electron_beam 
-000312a0: 6966 2062 6561 6d5f 7479 7065 2069 7320  if beam_type is 
-000312b0: 4265 616d 5479 7065 2e45 4c45 4354 524f  BeamType.ELECTRO
-000312c0: 4e20 656c 7365 2073 656c 662e 696f 6e5f  N else self.ion_
-000312d0: 6265 616d 0a20 2020 2020 2020 2020 2020  beam.           
-000312e0: 2064 6574 6563 746f 7220 3d20 7365 6c66   detector = self
-000312f0: 2e65 6c65 6374 726f 6e5f 6465 7465 6374  .electron_detect
-00031300: 6f72 5f73 6574 7469 6e67 7320 6966 2062  or_settings if b
-00031310: 6561 6d5f 7479 7065 2069 7320 4265 616d  eam_type is Beam
-00031320: 5479 7065 2e45 4c45 4354 524f 4e20 656c  Type.ELECTRON el
-00031330: 7365 2073 656c 662e 696f 6e5f 6465 7465  se self.ion_dete
-00031340: 6374 6f72 5f73 6574 7469 6e67 730a 0a20  ctor_settings.. 
-00031350: 2020 2020 2020 2023 2076 6f6c 7461 6765         # voltage
-00031360: 0a20 2020 2020 2020 2069 6620 6b65 7920  .        if key 
-00031370: 3d3d 2022 766f 6c74 6167 6522 3a0a 2020  == "voltage":.  
-00031380: 2020 2020 2020 2020 2020 5f63 6865 636b            _check
-00031390: 5f62 6561 6d28 6265 616d 5f74 7970 652c  _beam(beam_type,
-000313a0: 2073 656c 662e 6861 7264 7761 7265 5f73   self.hardware_s
-000313b0: 6574 7469 6e67 7329 0a20 2020 2020 2020  ettings).       
-000313c0: 2020 2020 2062 6561 6d2e 766f 6c74 6167       beam.voltag
-000313d0: 6520 3d20 7661 6c75 650a 2020 2020 2020  e = value.      
-000313e0: 2020 2020 2020 7265 7475 726e 0a20 2020        return.   
-000313f0: 2020 2020 2023 2063 7572 7265 6e74 0a20       # current. 
-00031400: 2020 2020 2020 2069 6620 6b65 7920 3d3d         if key ==
-00031410: 2022 6375 7272 656e 7422 3a0a 2020 2020   "current":.    
-00031420: 2020 2020 2020 2020 5f63 6865 636b 5f62          _check_b
-00031430: 6561 6d28 6265 616d 5f74 7970 652c 2073  eam(beam_type, s
-00031440: 656c 662e 6861 7264 7761 7265 5f73 6574  elf.hardware_set
-00031450: 7469 6e67 7329 0a20 2020 2020 2020 2020  tings).         
-00031460: 2020 2062 6561 6d2e 6265 616d 5f63 7572     beam.beam_cur
-00031470: 7265 6e74 203d 2076 616c 7565 0a20 2020  rent = value.   
-00031480: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-00031490: 2020 2020 2020 200a 2020 2020 2020 2020         .        
-000314a0: 0a20 2020 2020 2020 2069 6620 6b65 7920  .        if key 
-000314b0: 3d3d 2022 776f 726b 696e 675f 6469 7374  == "working_dist
-000314c0: 616e 6365 223a 0a20 2020 2020 2020 2020  ance":.         
-000314d0: 2020 205f 6368 6563 6b5f 6265 616d 2862     _check_beam(b
-000314e0: 6561 6d5f 7479 7065 2c20 7365 6c66 2e68  eam_type, self.h
-000314f0: 6172 6477 6172 655f 7365 7474 696e 6773  ardware_settings
-00031500: 290a 2020 2020 2020 2020 2020 2020 6265  ).            be
-00031510: 616d 2e77 6f72 6b69 6e67 5f64 6973 7461  am.working_dista
-00031520: 6e63 6520 3d20 7661 6c75 650a 2020 2020  nce = value.    
-00031530: 2020 2020 2020 2020 7265 7475 726e 0a20          return. 
-00031540: 2020 2020 2020 200a 2020 2020 2020 2020         .        
-00031550: 6966 206b 6579 203d 3d20 2273 7469 676d  if key == "stigm
-00031560: 6174 696f 6e22 3a0a 2020 2020 2020 2020  ation":.        
-00031570: 2020 2020 5f63 6865 636b 5f62 6561 6d28      _check_beam(
-00031580: 6265 616d 5f74 7970 652c 2073 656c 662e  beam_type, self.
-00031590: 6861 7264 7761 7265 5f73 6574 7469 6e67  hardware_setting
-000315a0: 7329 0a20 2020 2020 2020 2020 2020 2062  s).            b
-000315b0: 6561 6d2e 7374 6967 6d61 7469 6f6e 203d  eam.stigmation =
-000315c0: 2076 616c 7565 0a20 2020 2020 2020 2020   value.         
-000315d0: 2020 2072 6574 7572 6e0a 2020 2020 2020     return.      
-000315e0: 2020 6966 206b 6579 203d 3d20 2273 6869    if key == "shi
-000315f0: 6674 223a 0a20 2020 2020 2020 2020 2020  ft":.           
-00031600: 205f 6368 6563 6b5f 6265 616d 2862 6561   _check_beam(bea
-00031610: 6d5f 7479 7065 2c20 7365 6c66 2e68 6172  m_type, self.har
-00031620: 6477 6172 655f 7365 7474 696e 6773 290a  dware_settings).
-00031630: 2020 2020 2020 2020 2020 2020 6265 616d              beam
-00031640: 2e73 6869 6674 203d 2076 616c 7565 0a20  .shift = value. 
-00031650: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00031660: 6e0a 0a20 2020 2020 2020 2069 6620 6b65  n..        if ke
-00031670: 7920 3d3d 2022 6465 7465 6374 6f72 5f74  y == "detector_t
-00031680: 7970 6522 3a0a 2020 2020 2020 2020 2020  ype":.          
-00031690: 2020 6465 7465 6374 6f72 2e74 7970 6520    detector.type 
-000316a0: 3d20 7661 6c75 650a 2020 2020 2020 2020  = value.        
-000316b0: 2020 2020 7265 7475 726e 0a20 2020 2020      return.     
-000316c0: 2020 2069 6620 6b65 7920 3d3d 2022 6465     if key == "de
-000316d0: 7465 6374 6f72 5f6d 6f64 6522 3a0a 2020  tector_mode":.  
-000316e0: 2020 2020 2020 2020 2020 6465 7465 6374            detect
-000316f0: 6f72 2e6d 6f64 6520 3d20 7661 6c75 650a  or.mode = value.
-00031700: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00031710: 726e 200a 2020 2020 2020 2020 6966 206b  rn .        if k
-00031720: 6579 203d 3d20 2264 6574 6563 746f 725f  ey == "detector_
-00031730: 636f 6e74 7261 7374 223a 0a20 2020 2020  contrast":.     
-00031740: 2020 2020 2020 2064 6574 6563 746f 722e         detector.
-00031750: 636f 6e74 7261 7374 203d 2076 616c 7565  contrast = value
-00031760: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00031770: 7572 6e0a 2020 2020 2020 2020 6966 206b  urn.        if k
-00031780: 6579 203d 3d20 2264 6574 6563 746f 725f  ey == "detector_
-00031790: 6272 6967 6874 6e65 7373 223a 0a20 2020  brightness":.   
-000317a0: 2020 2020 2020 2020 2064 6574 6563 746f           detecto
-000317b0: 722e 6272 6967 6874 6e65 7373 203d 2076  r.brightness = v
-000317c0: 616c 7565 0a20 2020 2020 2020 2020 2020  alue.           
-000317d0: 2072 6574 7572 6e0a 0a20 2020 2020 2020   return..       
-000317e0: 206c 6f67 6769 6e67 2e77 6172 6e69 6e67   logging.warning
-000317f0: 2866 2255 6e6b 6e6f 776e 206b 6579 3a20  (f"Unknown key: 
-00031800: 7b6b 6579 7d20 287b 6265 616d 5f74 7970  {key} ({beam_typ
-00031810: 657d 2922 290a 2020 2020 2020 2020 7265  e})").        re
-00031820: 7475 726e 204e 6f74 496d 706c 656d 656e  turn NotImplemen
-00031830: 7465 640a 0a20 2020 2064 6566 2067 6574  ted..    def get
-00031840: 5f62 6561 6d5f 7379 7374 656d 5f73 7461  _beam_system_sta
-00031850: 7465 2873 656c 662c 2062 6561 6d5f 7479  te(self, beam_ty
-00031860: 7065 3a20 4265 616d 5479 7065 2920 2d3e  pe: BeamType) ->
-00031870: 2042 6561 6d53 7973 7465 6d53 6574 7469   BeamSystemSetti
-00031880: 6e67 733a 0a20 2020 2020 2020 205f 6368  ngs:.        _ch
-00031890: 6563 6b5f 6265 616d 2862 6561 6d5f 7479  eck_beam(beam_ty
-000318a0: 7065 2c20 7365 6c66 2e68 6172 6477 6172  pe, self.hardwar
-000318b0: 655f 7365 7474 696e 6773 290a 2020 2020  e_settings).    
-000318c0: 2020 2020 2320 6765 7420 6375 7272 656e      # get curren
-000318d0: 7420 6265 616d 2073 6574 7469 6e67 730a  t beam settings.
-000318e0: 2020 2020 2020 2020 766f 6c74 6167 6520          voltage 
-000318f0: 3d20 3330 3030 300a 2020 2020 2020 2020  = 30000.        
-00031900: 6375 7272 656e 7420 3d20 3230 652d 3132  current = 20e-12
-00031910: 200a 2020 2020 2020 2020 6465 7465 6374   .        detect
-00031920: 6f72 5f74 7970 6520 3d20 2245 5444 220a  or_type = "ETD".
-00031930: 2020 2020 2020 2020 6465 7465 6374 6f72          detector
-00031940: 5f6d 6f64 6520 3d20 2253 6563 6f6e 6461  _mode = "Seconda
-00031950: 7279 456c 6563 7472 6f6e 7322 0a20 2020  ryElectrons".   
-00031960: 2020 2020 2073 6869 6674 203d 2050 6f69       shift = Poi
-00031970: 6e74 2830 2c20 3029 0a0a 2020 2020 2020  nt(0, 0)..      
-00031980: 2020 6966 2062 6561 6d5f 7479 7065 2069    if beam_type i
-00031990: 7320 4265 616d 5479 7065 2e49 4f4e 3a0a  s BeamType.ION:.
-000319a0: 2020 2020 2020 2020 2020 2020 6575 6365              euce
-000319b0: 6e74 7269 635f 6865 6967 6874 203d 2031  ntric_height = 1
-000319c0: 362e 3565 2d33 0a20 2020 2020 2020 2020  6.5e-3.         
-000319d0: 2020 2070 6c61 736d 615f 6761 7320 3d20     plasma_gas = 
-000319e0: 2241 7267 6f6e 220a 2020 2020 2020 2020  "Argon".        
-000319f0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00031a00: 2020 6575 6365 6e74 7269 635f 6865 6967    eucentric_heig
-00031a10: 6874 203d 2034 2e30 652d 330a 2020 2020  ht = 4.0e-3.    
-00031a20: 2020 2020 2020 2020 706c 6173 6d61 5f67          plasma_g
-00031a30: 6173 203d 204e 6f6e 650a 0a20 2020 2020  as = None..     
-00031a40: 2020 2072 6574 7572 6e20 4265 616d 5379     return BeamSy
-00031a50: 7374 656d 5365 7474 696e 6773 280a 2020  stemSettings(.  
-00031a60: 2020 2020 2020 2020 2020 6265 616d 5f74            beam_t
-00031a70: 7970 653d 6265 616d 5f74 7970 652c 0a20  ype=beam_type,. 
-00031a80: 2020 2020 2020 2020 2020 2076 6f6c 7461             volta
-00031a90: 6765 3d76 6f6c 7461 6765 2c0a 2020 2020  ge=voltage,.    
-00031aa0: 2020 2020 2020 2020 6375 7272 656e 743d          current=
-00031ab0: 6375 7272 656e 742c 0a20 2020 2020 2020  current,.       
-00031ac0: 2020 2020 2064 6574 6563 746f 725f 7479       detector_ty
-00031ad0: 7065 3d64 6574 6563 746f 725f 7479 7065  pe=detector_type
-00031ae0: 2c0a 2020 2020 2020 2020 2020 2020 6465  ,.            de
-00031af0: 7465 6374 6f72 5f6d 6f64 653d 6465 7465  tector_mode=dete
-00031b00: 6374 6f72 5f6d 6f64 652c 0a20 2020 2020  ctor_mode,.     
-00031b10: 2020 2020 2020 2065 7563 656e 7472 6963         eucentric
-00031b20: 5f68 6569 6768 743d 6575 6365 6e74 7269  _height=eucentri
-00031b30: 635f 6865 6967 6874 2c0a 2020 2020 2020  c_height,.      
-00031b40: 2020 2020 2020 706c 6173 6d61 5f67 6173        plasma_gas
-00031b50: 3d70 6c61 736d 615f 6761 732c 0a20 2020  =plasma_gas,.   
-00031b60: 2020 2020 2029 0a20 2020 200a 2020 2020       ).    .    
-00031b70: 6465 6620 6368 6563 6b5f 6176 6169 6c61  def check_availa
-00031b80: 626c 655f 7661 6c75 6573 2873 656c 662c  ble_values(self,
-00031b90: 206b 6579 3a20 7374 722c 2076 616c 7565   key: str, value
-00031ba0: 2c20 6265 616d 5f74 7970 653a 2042 6561  , beam_type: Bea
-00031bb0: 6d54 7970 6520 3d20 4e6f 6e65 2920 2d3e  mType = None) ->
-00031bc0: 2062 6f6f 6c3a 0a20 2020 2020 2020 206c   bool:.        l
-00031bd0: 6f67 6769 6e67 2e69 6e66 6f28 6622 4368  ogging.info(f"Ch
-00031be0: 6563 6b69 6e67 2069 6620 7b6b 6579 7d3d  ecking if {key}=
-00031bf0: 7b76 616c 7565 7d20 6973 2061 7661 696c  {value} is avail
-00031c00: 6162 6c65 2028 7b62 6561 6d5f 7479 7065  able ({beam_type
-00031c10: 7d29 2229 0a20 2020 2020 2020 2072 6574  })").        ret
-00031c20: 7572 6e20 5472 7565 0a20 2020 200a 2020  urn True.    .  
-00031c30: 2020 6465 6620 686f 6d65 2873 656c 6629    def home(self)
-00031c40: 3a0a 2020 2020 2020 2020 5f63 6865 636b  :.        _check
-00031c50: 5f73 7461 6765 2873 656c 662e 6861 7264  _stage(self.hard
-00031c60: 7761 7265 5f73 6574 7469 6e67 7329 0a20  ware_settings). 
-00031c70: 2020 2020 2020 206c 6f67 6769 6e67 2e69         logging.i
-00031c80: 6e66 6f28 2248 6f6d 696e 6720 5374 6167  nfo("Homing Stag
-00031c90: 6522 290a 2020 2020 2020 2020 7265 7475  e").        retu
-00031ca0: 726e 0a0a 0a23 2323 2323 2323 2323 2323  rn...###########
-00031cb0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00031cc0: 2323 2323 2323 2323 2323 2323 2320 4865  ############# He
-00031cd0: 6c70 6572 2066 756e 6374 696f 6e73 2023  lper functions #
-00031ce0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00031cf0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00031d00: 2323 2323 2323 230a 0a0a 0a64 6566 2070  #######....def p
-00031d10: 7269 6e74 5072 6f67 7265 7373 4261 7228  rintProgressBar(
-00031d20: 0a20 2020 2076 616c 7565 2c20 746f 7461  .    value, tota
-00031d30: 6c2c 2070 7265 6669 783d 2222 2c20 7375  l, prefix="", su
-00031d40: 6666 6978 3d22 222c 2064 6563 696d 616c  ffix="", decimal
-00031d50: 733d 302c 206c 656e 6774 683d 3130 302c  s=0, length=100,
-00031d60: 2066 696c 6c3d 22e2 9688 220a 293a 0a20   fill="...".):. 
-00031d70: 2020 2022 2222 0a20 2020 2074 6572 6d69     """.    termi
-00031d80: 6e61 6c20 7072 6f67 7265 7373 2062 6172  nal progress bar
-00031d90: 0a20 2020 2022 2222 0a20 2020 2070 6572  .    """.    per
-00031da0: 6365 6e74 203d 2028 227b 303a 2e22 202b  cent = ("{0:." +
-00031db0: 2073 7472 2864 6563 696d 616c 7329 202b   str(decimals) +
-00031dc0: 2022 667d 2229 2e66 6f72 6d61 7428 3130   "f}").format(10
-00031dd0: 3020 2a20 2876 616c 7565 202f 2066 6c6f  0 * (value / flo
-00031de0: 6174 2874 6f74 616c 2929 290a 2020 2020  at(total))).    
-00031df0: 6669 6c6c 6564 5f6c 656e 6774 6820 3d20  filled_length = 
-00031e00: 696e 7428 6c65 6e67 7468 202a 2076 616c  int(length * val
-00031e10: 7565 202f 2f20 746f 7461 6c29 0a20 2020  ue // total).   
-00031e20: 2062 6172 203d 2066 696c 6c20 2a20 6669   bar = fill * fi
-00031e30: 6c6c 6564 5f6c 656e 6774 6820 2b20 222d  lled_length + "-
-00031e40: 2220 2a20 286c 656e 6774 6820 2d20 6669  " * (length - fi
-00031e50: 6c6c 6564 5f6c 656e 6774 6829 0a20 2020  lled_length).   
-00031e60: 2070 7269 6e74 2866 225c 727b 7072 6566   print(f"\r{pref
-00031e70: 6978 7d20 7c7b 6261 727d 7c20 7b70 6572  ix} |{bar}| {per
-00031e80: 6365 6e74 7d25 207b 7375 6666 6978 7d22  cent}% {suffix}"
-00031e90: 2c20 656e 643d 225c 7222 290a 0a64 6566  , end="\r")..def
-00031ea0: 205f 6368 6563 6b5f 6265 616d 2862 6561   _check_beam(bea
-00031eb0: 6d5f 7479 7065 3a20 4265 616d 5479 7065  m_type: BeamType
-00031ec0: 2c20 6861 7264 7761 7265 5f73 6574 7469  , hardware_setti
-00031ed0: 6e67 733a 2046 6962 7365 6d48 6172 6477  ngs: FibsemHardw
-00031ee0: 6172 6529 3a0a 2020 2020 2222 220a 2020  are):.    """.  
-00031ef0: 2020 4368 6563 6b73 2069 6620 6265 616d    Checks if beam
-00031f00: 2069 7320 6176 6169 6c61 626c 652e 0a20   is available.. 
-00031f10: 2020 2022 2222 0a20 2020 2069 6620 6265     """.    if be
-00031f20: 616d 5f74 7970 6520 3d3d 2042 6561 6d54  am_type == BeamT
-00031f30: 7970 652e 454c 4543 5452 4f4e 2061 6e64  ype.ELECTRON and
-00031f40: 2068 6172 6477 6172 655f 7365 7474 696e   hardware_settin
-00031f50: 6773 2e65 6c65 6374 726f 6e5f 6265 616d  gs.electron_beam
-00031f60: 203d 3d20 4661 6c73 653a 0a20 2020 2020   == False:.     
-00031f70: 2020 2072 6169 7365 204e 6f74 496d 706c     raise NotImpl
-00031f80: 656d 656e 7465 6445 7272 6f72 2822 5468  ementedError("Th
-00031f90: 6520 6d69 6372 6f73 636f 7065 2064 6f65  e microscope doe
-00031fa0: 7320 6e6f 7420 6861 7665 2061 6e20 656c  s not have an el
-00031fb0: 6563 7472 6f6e 2062 6561 6d2e 2229 0a20  ectron beam."). 
-00031fc0: 2020 2069 6620 6265 616d 5f74 7970 6520     if beam_type 
-00031fd0: 3d3d 2042 6561 6d54 7970 652e 494f 4e20  == BeamType.ION 
-00031fe0: 616e 6420 6861 7264 7761 7265 5f73 6574  and hardware_set
-00031ff0: 7469 6e67 732e 696f 6e5f 6265 616d 203d  tings.ion_beam =
-00032000: 3d20 4661 6c73 653a 0a20 2020 2020 2020  = False:.       
-00032010: 2072 6169 7365 204e 6f74 496d 706c 656d   raise NotImplem
-00032020: 656e 7465 6445 7272 6f72 2822 5468 6520  entedError("The 
-00032030: 6d69 6372 6f73 636f 7065 2064 6f65 7320  microscope does 
-00032040: 6e6f 7420 6861 7665 2061 6e20 696f 6e20  not have an ion 
-00032050: 6265 616d 2e22 290a 0a64 6566 205f 6368  beam.")..def _ch
-00032060: 6563 6b5f 7374 6167 6528 6861 7264 7761  eck_stage(hardwa
-00032070: 7265 5f73 6574 7469 6e67 733a 2046 6962  re_settings: Fib
-00032080: 7365 6d48 6172 6477 6172 652c 2072 6f74  semHardware, rot
-00032090: 6174 696f 6e3a 2062 6f6f 6c20 3d20 4661  ation: bool = Fa
-000320a0: 6c73 652c 2074 696c 743a 2062 6f6f 6c20  lse, tilt: bool 
-000320b0: 3d20 4661 6c73 6529 3a0a 2020 2020 2222  = False):.    ""
-000320c0: 220a 2020 2020 4368 6563 6b73 2069 6620  ".    Checks if 
-000320d0: 7468 6520 7374 6167 6520 6973 2066 756c  the stage is ful
-000320e0: 6c79 206d 6f76 6162 6c65 2e0a 2020 2020  ly movable..    
-000320f0: 2222 220a 2020 2020 6966 2068 6172 6477  """.    if hardw
-00032100: 6172 655f 7365 7474 696e 6773 2e73 7461  are_settings.sta
-00032110: 6765 5f65 6e61 626c 6564 203d 3d20 4661  ge_enabled == Fa
-00032120: 6c73 653a 0a20 2020 2020 2020 2072 6169  lse:.        rai
-00032130: 7365 204e 6f74 496d 706c 656d 656e 7465  se NotImplemente
-00032140: 6445 7272 6f72 2822 5468 6520 6d69 6372  dError("The micr
-00032150: 6f73 636f 7065 2064 6f65 7320 6e6f 7420  oscope does not 
-00032160: 6861 7665 2061 206d 6f76 696e 6720 7374  have a moving st
-00032170: 6167 652e 2229 0a20 2020 2069 6620 6861  age.").    if ha
-00032180: 7264 7761 7265 5f73 6574 7469 6e67 732e  rdware_settings.
-00032190: 7374 6167 655f 726f 7461 7469 6f6e 203d  stage_rotation =
-000321a0: 3d20 4661 6c73 6520 616e 6420 726f 7461  = False and rota
-000321b0: 7469 6f6e 203d 3d20 5472 7565 3a0a 2020  tion == True:.  
-000321c0: 2020 2020 2020 7261 6973 6520 4e6f 7449        raise NotI
-000321d0: 6d70 6c65 6d65 6e74 6564 4572 726f 7228  mplementedError(
-000321e0: 2254 6865 206d 6963 726f 7363 6f70 6520  "The microscope 
-000321f0: 7374 6167 6520 646f 6573 206e 6f74 2072  stage does not r
-00032200: 6f74 6174 652e 2229 0a20 2020 2069 6620  otate.").    if 
-00032210: 6861 7264 7761 7265 5f73 6574 7469 6e67  hardware_setting
-00032220: 732e 7374 6167 655f 7469 6c74 203d 3d20  s.stage_tilt == 
-00032230: 4661 6c73 6520 616e 6420 7469 6c74 203d  False and tilt =
-00032240: 3d20 5472 7565 3a0a 2020 2020 2020 2020  = True:.        
-00032250: 7261 6973 6520 4e6f 7449 6d70 6c65 6d65  raise NotImpleme
-00032260: 6e74 6564 4572 726f 7228 2254 6865 206d  ntedError("The m
-00032270: 6963 726f 7363 6f70 6520 7374 6167 6520  icroscope stage 
-00032280: 646f 6573 206e 6f74 2074 696c 742e 2229  does not tilt.")
-00032290: 0a0a 6465 6620 5f63 6865 636b 5f6e 6565  ..def _check_nee
-000322a0: 646c 6528 6861 7264 7761 7265 5f73 6574  dle(hardware_set
-000322b0: 7469 6e67 733a 2046 6962 7365 6d48 6172  tings: FibsemHar
-000322c0: 6477 6172 652c 2072 6f74 6174 696f 6e3a  dware, rotation:
-000322d0: 2062 6f6f 6c20 3d20 4661 6c73 652c 2074   bool = False, t
-000322e0: 696c 743a 2062 6f6f 6c20 3d20 4661 6c73  ilt: bool = Fals
-000322f0: 6529 3a0a 2020 2020 2222 220a 2020 2020  e):.    """.    
-00032300: 4368 6563 6b73 2069 6620 7468 6520 6e65  Checks if the ne
-00032310: 6564 6c65 2069 7320 6176 6169 6c61 626c  edle is availabl
-00032320: 652e 0a20 2020 2022 2222 0a20 2020 2069  e..    """.    i
-00032330: 6620 6861 7264 7761 7265 5f73 6574 7469  f hardware_setti
-00032340: 6e67 732e 6d61 6e69 7075 6c61 746f 725f  ngs.manipulator_
-00032350: 656e 6162 6c65 6420 3d3d 2046 616c 7365  enabled == False
-00032360: 3a0a 2020 2020 2020 2020 7261 6973 6520  :.        raise 
-00032370: 4e6f 7449 6d70 6c65 6d65 6e74 6564 4572  NotImplementedEr
-00032380: 726f 7228 2254 6865 206d 6963 726f 7363  ror("The microsc
-00032390: 6f70 6520 646f 6573 206e 6f74 2068 6176  ope does not hav
-000323a0: 6520 6120 6e65 6564 6c65 2e22 290a 2020  e a needle.").  
-000323b0: 2020 6966 2068 6172 6477 6172 655f 7365    if hardware_se
-000323c0: 7474 696e 6773 2e6d 616e 6970 756c 6174  ttings.manipulat
-000323d0: 6f72 5f72 6f74 6174 696f 6e20 3d3d 2046  or_rotation == F
-000323e0: 616c 7365 2061 6e64 2072 6f74 6174 696f  alse and rotatio
-000323f0: 6e20 3d3d 2054 7275 653a 0a20 2020 2020  n == True:.     
-00032400: 2020 2072 6169 7365 204e 6f74 496d 706c     raise NotImpl
-00032410: 656d 656e 7465 6445 7272 6f72 2822 5468  ementedError("Th
-00032420: 6520 6d69 6372 6f73 636f 7065 206e 6565  e microscope nee
-00032430: 646c 6520 646f 6573 206e 6f74 2072 6f74  dle does not rot
-00032440: 6174 652e 2229 0a20 2020 2069 6620 6861  ate.").    if ha
-00032450: 7264 7761 7265 5f73 6574 7469 6e67 732e  rdware_settings.
-00032460: 6d61 6e69 7075 6c61 746f 725f 7469 6c74  manipulator_tilt
-00032470: 203d 3d20 4661 6c73 6520 616e 6420 7469   == False and ti
-00032480: 6c74 203d 3d20 5472 7565 3a0a 2020 2020  lt == True:.    
-00032490: 2020 2020 7261 6973 6520 4e6f 7449 6d70      raise NotImp
-000324a0: 6c65 6d65 6e74 6564 4572 726f 7228 2254  lementedError("T
-000324b0: 6865 206d 6963 726f 7363 6f70 6520 6e65  he microscope ne
-000324c0: 6564 6c65 2064 6f65 7320 6e6f 7420 7469  edle does not ti
-000324d0: 6c74 2e22 290a 0a64 6566 205f 6368 6563  lt.")..def _chec
-000324e0: 6b5f 7370 7574 7465 7228 6861 7264 7761  k_sputter(hardwa
-000324f0: 7265 5f73 6574 7469 6e67 733a 2046 6962  re_settings: Fib
-00032500: 7365 6d48 6172 6477 6172 6529 3a0a 2020  semHardware):.  
-00032510: 2020 2222 220a 2020 2020 4368 6563 6b73    """.    Checks
-00032520: 2069 6620 7468 6520 7370 7574 7465 7220   if the sputter 
-00032530: 6973 2061 7661 696c 6162 6c65 2e0a 2020  is available..  
-00032540: 2020 2222 220a 2020 2020 6966 2068 6172    """.    if har
-00032550: 6477 6172 655f 7365 7474 696e 6773 2e67  dware_settings.g
-00032560: 6973 5f65 6e61 626c 6564 203d 3d20 4661  is_enabled == Fa
-00032570: 6c73 653a 0a20 2020 2020 2020 2072 6169  lse:.        rai
-00032580: 7365 204e 6f74 496d 706c 656d 656e 7465  se NotImplemente
-00032590: 6445 7272 6f72 2822 5468 6520 6d69 6372  dError("The micr
-000325a0: 6f73 636f 7065 2064 6f65 7320 6e6f 7420  oscope does not 
-000325b0: 6861 7665 2061 2047 4953 2073 7973 7465  have a GIS syste
-000325c0: 6d2e 2229 0a20 2020 2069 6620 6861 7264  m.").    if hard
-000325d0: 7761 7265 5f73 6574 7469 6e67 732e 6769  ware_settings.gi
-000325e0: 735f 6d75 6c74 6963 6865 6d20 3d3d 2046  s_multichem == F
-000325f0: 616c 7365 3a0a 2020 2020 2020 2020 7261  alse:.        ra
-00032600: 6973 6520 4e6f 7449 6d70 6c65 6d65 6e74  ise NotImplement
-00032610: 6564 4572 726f 7228 2254 6865 206d 6963  edError("The mic
-00032620: 726f 7363 6f70 6520 646f 6573 206e 6f74  roscope does not
-00032630: 2068 6176 6520 6120 6d75 6c74 6963 6865   have a multiche
-00032640: 6d20 7379 7374 656d 2e22 290a 2020 2020  m system.").    
-00032650: 0a                                       .
+00000a20: 746f 7253 6574 7469 6e67 732c 0a20 2020  torSettings,.   
+00000a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00000a40: 2020 2020 2020 2020 2020 2020 5468 6572              Ther
+00000a50: 6d6f 4749 534c 696e 652c 5468 6572 6d6f  moGISLine,Thermo
+00000a60: 4d75 6c74 6943 6865 6d4c 696e 652c 2053  MultiChemLine, S
+00000a70: 7461 6765 5365 7474 696e 6773 290a 0a0a  tageSettings)...
+00000a80: 636c 6173 7320 4669 6273 656d 4d69 6372  class FibsemMicr
+00000a90: 6f73 636f 7065 2841 4243 293a 0a20 2020  oscope(ABC):.   
+00000aa0: 2022 2222 4162 7374 7261 6374 2063 6c61   """Abstract cla
+00000ab0: 7373 2063 6f6e 7461 696e 696e 6720 616c  ss containing al
+00000ac0: 6c20 7468 6520 636f 7265 206d 6963 726f  l the core micro
+00000ad0: 7363 6f70 6520 6675 6e63 7469 6f6e 616c  scope functional
+00000ae0: 6974 6965 7322 2222 0a0a 2020 2020 4061  ities"""..    @a
+00000af0: 6273 7472 6163 746d 6574 686f 640a 2020  bstractmethod.  
+00000b00: 2020 6465 6620 636f 6e6e 6563 745f 746f    def connect_to
+00000b10: 5f6d 6963 726f 7363 6f70 6528 7365 6c66  _microscope(self
+00000b20: 2c20 6970 5f61 6464 7265 7373 3a20 7374  , ip_address: st
+00000b30: 722c 2070 6f72 743a 2069 6e74 2920 2d3e  r, port: int) ->
+00000b40: 204e 6f6e 653a 0a20 2020 2020 2020 2070   None:.        p
+00000b50: 6173 730a 0a20 2020 2040 6162 7374 7261  ass..    @abstra
+00000b60: 6374 6d65 7468 6f64 0a20 2020 2064 6566  ctmethod.    def
+00000b70: 2064 6973 636f 6e6e 6563 7428 7365 6c66   disconnect(self
+00000b80: 293a 0a20 2020 2020 2020 2070 6173 730a  ):.        pass.
+00000b90: 0a20 2020 2040 6162 7374 7261 6374 6d65  .    @abstractme
+00000ba0: 7468 6f64 0a20 2020 2064 6566 2061 6371  thod.    def acq
+00000bb0: 7569 7265 5f69 6d61 6765 2873 656c 662c  uire_image(self,
+00000bc0: 2069 6d61 6765 5f73 6574 7469 6e67 733a   image_settings:
+00000bd0: 496d 6167 6553 6574 7469 6e67 7329 202d  ImageSettings) -
+00000be0: 3e20 4669 6273 656d 496d 6167 653a 0a20  > FibsemImage:. 
+00000bf0: 2020 2020 2020 2070 6173 730a 0a20 2020         pass..   
+00000c00: 2040 6162 7374 7261 6374 6d65 7468 6f64   @abstractmethod
+00000c10: 0a20 2020 2064 6566 206c 6173 745f 696d  .    def last_im
+00000c20: 6167 6528 7365 6c66 2c20 6265 616d 5f74  age(self, beam_t
+00000c30: 7970 653a 2042 6561 6d54 7970 6529 202d  ype: BeamType) -
+00000c40: 3e20 4669 6273 656d 496d 6167 653a 0a20  > FibsemImage:. 
+00000c50: 2020 2020 2020 2070 6173 730a 0a20 2020         pass..   
+00000c60: 2040 6162 7374 7261 6374 6d65 7468 6f64   @abstractmethod
+00000c70: 0a20 2020 2064 6566 2061 7574 6f63 6f6e  .    def autocon
+00000c80: 7472 6173 7428 7365 6c66 2c20 6265 616d  trast(self, beam
+00000c90: 5f74 7970 653a 2042 6561 6d54 7970 6529  _type: BeamType)
+00000ca0: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
+00000cb0: 2020 7061 7373 0a0a 2020 2020 4061 6273    pass..    @abs
+00000cc0: 7472 6163 746d 6574 686f 640a 2020 2020  tractmethod.    
+00000cd0: 6465 6620 6175 746f 5f66 6f63 7573 2873  def auto_focus(s
+00000ce0: 656c 662c 2062 6561 6d5f 7479 7065 3a20  elf, beam_type: 
+00000cf0: 4265 616d 5479 7065 2920 2d3e 204e 6f6e  BeamType) -> Non
+00000d00: 653a 0a20 2020 2020 2020 2070 6173 730a  e:.        pass.
+00000d10: 0a20 2020 2040 6162 7374 7261 6374 6d65  .    @abstractme
+00000d20: 7468 6f64 0a20 2020 2064 6566 2072 6573  thod.    def res
+00000d30: 6574 5f62 6561 6d5f 7368 6966 7473 2873  et_beam_shifts(s
+00000d40: 656c 6629 202d 3e20 4e6f 6e65 3a0a 2020  elf) -> None:.  
+00000d50: 2020 2020 2020 7061 7373 0a0a 2020 2020        pass..    
+00000d60: 4061 6273 7472 6163 746d 6574 686f 640a  @abstractmethod.
+00000d70: 2020 2020 6465 6620 6265 616d 5f73 6869      def beam_shi
+00000d80: 6674 2873 656c 662c 2064 783a 2066 6c6f  ft(self, dx: flo
+00000d90: 6174 2c20 6479 3a20 666c 6f61 742c 2062  at, dy: float, b
+00000da0: 6561 6d5f 7479 7065 3a20 4265 616d 5479  eam_type: BeamTy
+00000db0: 7065 2920 2d3e 204e 6f6e 653a 0a20 2020  pe) -> None:.   
+00000dc0: 2020 2020 2070 6173 730a 0a20 2020 2040       pass..    @
+00000dd0: 6162 7374 7261 6374 6d65 7468 6f64 0a20  abstractmethod. 
+00000de0: 2020 2064 6566 2067 6574 5f73 7461 6765     def get_stage
+00000df0: 5f70 6f73 6974 696f 6e28 7365 6c66 2920  _position(self) 
+00000e00: 2d3e 2046 6962 7365 6d53 7461 6765 506f  -> FibsemStagePo
+00000e10: 7369 7469 6f6e 3a0a 2020 2020 2020 2020  sition:.        
+00000e20: 7061 7373 0a0a 2020 2020 4061 6273 7472  pass..    @abstr
+00000e30: 6163 746d 6574 686f 640a 2020 2020 6465  actmethod.    de
+00000e40: 6620 6765 745f 6375 7272 656e 745f 6d69  f get_current_mi
+00000e50: 6372 6f73 636f 7065 5f73 7461 7465 2873  croscope_state(s
+00000e60: 656c 6629 202d 3e20 4d69 6372 6f73 636f  elf) -> Microsco
+00000e70: 7065 5374 6174 653a 0a20 2020 2020 2020  peState:.       
+00000e80: 2070 6173 730a 0a20 2020 2040 6162 7374   pass..    @abst
+00000e90: 7261 6374 6d65 7468 6f64 0a20 2020 2064  ractmethod.    d
+00000ea0: 6566 206d 6f76 655f 7374 6167 655f 6162  ef move_stage_ab
+00000eb0: 736f 6c75 7465 2873 656c 662c 2070 6f73  solute(self, pos
+00000ec0: 6974 696f 6e3a 2046 6962 7365 6d53 7461  ition: FibsemSta
+00000ed0: 6765 506f 7369 7469 6f6e 2920 2d3e 204e  gePosition) -> N
+00000ee0: 6f6e 653a 0a20 2020 2020 2020 2070 6173  one:.        pas
+00000ef0: 730a 0a20 2020 2040 6162 7374 7261 6374  s..    @abstract
+00000f00: 6d65 7468 6f64 0a20 2020 2064 6566 206d  method.    def m
+00000f10: 6f76 655f 7374 6167 655f 7265 6c61 7469  ove_stage_relati
+00000f20: 7665 2873 656c 662c 2070 6f73 6974 696f  ve(self, positio
+00000f30: 6e3a 2046 6962 7365 6d53 7461 6765 506f  n: FibsemStagePo
+00000f40: 7369 7469 6f6e 2920 2d3e 204e 6f6e 653a  sition) -> None:
+00000f50: 0a20 2020 2020 2020 2070 6173 730a 0a20  .        pass.. 
+00000f60: 2020 2040 6162 7374 7261 6374 6d65 7468     @abstractmeth
+00000f70: 6f64 0a20 2020 2064 6566 2073 7461 626c  od.    def stabl
+00000f80: 655f 6d6f 7665 2873 656c 662c 0a20 2020  e_move(self,.   
+00000f90: 2020 2020 2073 6574 7469 6e67 733a 204d       settings: M
+00000fa0: 6963 726f 7363 6f70 6553 6574 7469 6e67  icroscopeSetting
+00000fb0: 732c 0a20 2020 2020 2020 2064 783a 2066  s,.        dx: f
+00000fc0: 6c6f 6174 2c0a 2020 2020 2020 2020 6479  loat,.        dy
+00000fd0: 3a20 666c 6f61 742c 0a20 2020 2020 2020  : float,.       
+00000fe0: 2062 6561 6d5f 7479 7065 3a20 4265 616d   beam_type: Beam
+00000ff0: 5479 7065 2c0a 2020 2020 2920 2d3e 2046  Type,.    ) -> F
+00001000: 6962 7365 6d53 7461 6765 506f 7369 7469  ibsemStagePositi
+00001010: 6f6e 3a0a 2020 2020 2020 2020 7061 7373  on:.        pass
+00001020: 0a0a 2020 2020 4061 6273 7472 6163 746d  ..    @abstractm
+00001030: 6574 686f 640a 2020 2020 6465 6620 6575  ethod.    def eu
+00001040: 6365 6e74 7269 635f 6d6f 7665 2873 656c  centric_move(sel
+00001050: 662c 0a20 2020 2020 2020 2073 6574 7469  f,.        setti
+00001060: 6e67 733a 204d 6963 726f 7363 6f70 6553  ngs: MicroscopeS
+00001070: 6574 7469 6e67 732c 0a20 2020 2020 2020  ettings,.       
+00001080: 2064 793a 2066 6c6f 6174 2c0a 2020 2020   dy: float,.    
+00001090: 2020 2020 7374 6174 6963 5f77 643a 2062      static_wd: b
+000010a0: 6f6f 6c20 3d20 5472 7565 2c0a 2020 2020  ool = True,.    
+000010b0: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
+000010c0: 2020 2070 6173 730a 0a20 2020 2040 6162     pass..    @ab
+000010d0: 7374 7261 6374 6d65 7468 6f64 0a20 2020  stractmethod.   
+000010e0: 2064 6566 206d 6f76 655f 666c 6174 5f74   def move_flat_t
+000010f0: 6f5f 6265 616d 2873 656c 662c 2073 6574  o_beam(self, set
+00001100: 7469 6e67 733a 204d 6963 726f 7363 6f70  tings: Microscop
+00001110: 6553 6574 7469 6e67 732c 2062 6561 6d5f  eSettings, beam_
+00001120: 7479 7065 3a20 4265 616d 5479 7065 2920  type: BeamType) 
+00001130: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
+00001140: 2070 6173 730a 0a20 2020 2040 6162 7374   pass..    @abst
+00001150: 7261 6374 6d65 7468 6f64 0a20 2020 2064  ractmethod.    d
+00001160: 6566 2067 6574 5f6d 616e 6970 756c 6174  ef get_manipulat
+00001170: 6f72 5f70 6f73 6974 696f 6e28 7365 6c66  or_position(self
+00001180: 2920 2d3e 2046 6962 7365 6d4d 616e 6970  ) -> FibsemManip
+00001190: 756c 6174 6f72 506f 7369 7469 6f6e 3a0a  ulatorPosition:.
+000011a0: 2020 2020 2020 2020 7061 7373 0a0a 2020          pass..  
+000011b0: 2020 4061 6273 7472 6163 746d 6574 686f    @abstractmetho
+000011c0: 640a 2020 2020 6465 6620 696e 7365 7274  d.    def insert
+000011d0: 5f6d 616e 6970 756c 6174 6f72 2873 656c  _manipulator(sel
+000011e0: 662c 206e 616d 653a 2073 7472 2920 2d3e  f, name: str) ->
+000011f0: 204e 6f6e 653a 0a20 2020 2020 2020 2070   None:.        p
+00001200: 6173 730a 0a20 2020 2040 6162 7374 7261  ass..    @abstra
+00001210: 6374 6d65 7468 6f64 0a20 2020 2064 6566  ctmethod.    def
+00001220: 2072 6574 7261 6374 5f6d 616e 6970 756c   retract_manipul
+00001230: 6174 6f72 2873 656c 6629 3a0a 2020 2020  ator(self):.    
+00001240: 2020 2020 7061 7373 0a0a 2020 2020 4061      pass..    @a
+00001250: 6273 7472 6163 746d 6574 686f 640a 2020  bstractmethod.  
+00001260: 2020 6465 6620 6d6f 7665 5f6d 616e 6970    def move_manip
+00001270: 756c 6174 6f72 5f72 656c 6174 6976 6528  ulator_relative(
+00001280: 7365 6c66 2c20 706f 7369 7469 6f6e 3a20  self, position: 
+00001290: 4669 6273 656d 4d61 6e69 7075 6c61 746f  FibsemManipulato
+000012a0: 7250 6f73 6974 696f 6e29 202d 3e20 4e6f  rPosition) -> No
+000012b0: 6e65 3a0a 2020 2020 2020 2020 7061 7373  ne:.        pass
+000012c0: 0a0a 2020 2020 4061 6273 7472 6163 746d  ..    @abstractm
+000012d0: 6574 686f 640a 2020 2020 6465 6620 6d6f  ethod.    def mo
+000012e0: 7665 5f6d 616e 6970 756c 6174 6f72 5f61  ve_manipulator_a
+000012f0: 6273 6f6c 7574 6528 7365 6c66 2c20 706f  bsolute(self, po
+00001300: 7369 7469 6f6e 3a20 4669 6273 656d 4d61  sition: FibsemMa
+00001310: 6e69 7075 6c61 746f 7250 6f73 6974 696f  nipulatorPositio
+00001320: 6e29 202d 3e20 4e6f 6e65 3a0a 2020 2020  n) -> None:.    
+00001330: 2020 2020 7061 7373 0a20 2020 200a 2020      pass.    .  
+00001340: 2020 4061 6273 7472 6163 746d 6574 686f    @abstractmetho
+00001350: 640a 2020 2020 6465 6620 6d6f 7665 5f6d  d.    def move_m
+00001360: 616e 6970 756c 6174 6f72 5f63 6f72 7265  anipulator_corre
+00001370: 6374 6564 2873 656c 662c 2064 783a 2066  cted(self, dx: f
+00001380: 6c6f 6174 2c20 6479 3a20 666c 6f61 742c  loat, dy: float,
+00001390: 2062 6561 6d5f 7479 7065 3a20 4265 616d   beam_type: Beam
+000013a0: 5479 7065 2920 2d3e 204e 6f6e 653a 0a20  Type) -> None:. 
+000013b0: 2020 2020 2020 2070 6173 730a 0a20 2020         pass..   
+000013c0: 2040 6162 7374 7261 6374 6d65 7468 6f64   @abstractmethod
+000013d0: 0a20 2020 2064 6566 206d 6f76 655f 6d61  .    def move_ma
+000013e0: 6e69 7075 6c61 746f 725f 746f 5f70 6f73  nipulator_to_pos
+000013f0: 6974 696f 6e5f 6f66 6673 6574 2873 656c  ition_offset(sel
+00001400: 662c 206f 6666 7365 743a 2046 6962 7365  f, offset: Fibse
+00001410: 6d4d 616e 6970 756c 6174 6f72 506f 7369  mManipulatorPosi
+00001420: 7469 6f6e 2c20 6e61 6d65 3a20 7374 7229  tion, name: str)
+00001430: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
+00001440: 2020 7061 7373 0a0a 2020 2020 4061 6273    pass..    @abs
+00001450: 7472 6163 746d 6574 686f 640a 2020 2020  tractmethod.    
+00001460: 6465 6620 5f67 6574 5f73 6176 6564 5f6d  def _get_saved_m
+00001470: 616e 6970 756c 6174 6f72 5f70 6f73 6974  anipulator_posit
+00001480: 696f 6e28 7365 6c66 2c20 6e61 6d65 3a20  ion(self, name: 
+00001490: 7374 7229 202d 3e20 4669 6273 656d 4d61  str) -> FibsemMa
+000014a0: 6e69 7075 6c61 746f 7250 6f73 6974 696f  nipulatorPositio
+000014b0: 6e3a 0a20 2020 2020 2020 2070 6173 730a  n:.        pass.
+000014c0: 0a20 2020 2040 6162 7374 7261 6374 6d65  .    @abstractme
+000014d0: 7468 6f64 0a20 2020 2064 6566 2073 6574  thod.    def set
+000014e0: 7570 5f6d 696c 6c69 6e67 2873 656c 662c  up_milling(self,
+000014f0: 206d 696c 6c5f 7365 7474 696e 6773 3a20   mill_settings: 
+00001500: 4669 6273 656d 4d69 6c6c 696e 6753 6574  FibsemMillingSet
+00001510: 7469 6e67 7329 202d 3e20 4e6f 6e65 3a0a  tings) -> None:.
+00001520: 2020 2020 2020 2020 7061 7373 0a0a 2020          pass..  
+00001530: 2020 4061 6273 7472 6163 746d 6574 686f    @abstractmetho
+00001540: 640a 2020 2020 6465 6620 7275 6e5f 6d69  d.    def run_mi
+00001550: 6c6c 696e 6728 7365 6c66 2c20 6d69 6c6c  lling(self, mill
+00001560: 696e 675f 6375 7272 656e 743a 2066 6c6f  ing_current: flo
+00001570: 6174 2c20 6173 796e 6368 3a20 626f 6f6c  at, asynch: bool
+00001580: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
+00001590: 2020 2070 6173 730a 2020 2020 0a20 2020     pass.    .   
+000015a0: 2040 6162 7374 7261 6374 6d65 7468 6f64   @abstractmethod
+000015b0: 0a20 2020 2064 6566 2072 756e 5f6d 696c  .    def run_mil
+000015c0: 6c69 6e67 5f64 7269 6674 5f63 6f72 7265  ling_drift_corre
+000015d0: 6374 6564 2873 656c 662c 206d 696c 6c69  cted(self, milli
+000015e0: 6e67 5f63 7572 7265 6e74 3a20 666c 6f61  ng_current: floa
+000015f0: 742c 2020 0a20 2020 2020 2020 2069 6d61  t,  .        ima
+00001600: 6765 5f73 6574 7469 6e67 733a 2049 6d61  ge_settings: Ima
+00001610: 6765 5365 7474 696e 6773 2c20 0a20 2020  geSettings, .   
+00001620: 2020 2020 2072 6566 5f69 6d61 6765 3a20       ref_image: 
+00001630: 4669 6273 656d 496d 6167 652c 200a 2020  FibsemImage, .  
+00001640: 2020 2020 2020 7265 6475 6365 645f 6172        reduced_ar
+00001650: 6561 3a20 4669 6273 656d 5265 6374 616e  ea: FibsemRectan
+00001660: 676c 6520 3d20 4e6f 6e65 2c0a 2020 2020  gle = None,.    
+00001670: 2020 2020 6173 796e 6368 3a20 626f 6f6c      asynch: bool
+00001680: 203d 2046 616c 7365 0a20 2020 2020 2020   = False.       
+00001690: 2029 3a0a 2020 2020 2020 2020 7061 7373   ):.        pass
+000016a0: 0a0a 2020 2020 4061 6273 7472 6163 746d  ..    @abstractm
+000016b0: 6574 686f 640a 2020 2020 6465 6620 6669  ethod.    def fi
+000016c0: 6e69 7368 5f6d 696c 6c69 6e67 2873 656c  nish_milling(sel
+000016d0: 662c 2069 6d61 6769 6e67 5f63 7572 7265  f, imaging_curre
+000016e0: 6e74 3a20 666c 6f61 7429 202d 3e20 4e6f  nt: float) -> No
+000016f0: 6e65 3a0a 2020 2020 2020 2020 7061 7373  ne:.        pass
+00001700: 0a0a 2020 2020 4061 6273 7472 6163 746d  ..    @abstractm
+00001710: 6574 686f 640a 2020 2020 6465 6620 6472  ethod.    def dr
+00001720: 6177 5f72 6563 7461 6e67 6c65 2873 656c  aw_rectangle(sel
+00001730: 662c 2070 6174 7465 726e 5f73 6574 7469  f, pattern_setti
+00001740: 6e67 733a 2046 6962 7365 6d50 6174 7465  ngs: FibsemPatte
+00001750: 726e 5365 7474 696e 6773 293a 0a20 2020  rnSettings):.   
+00001760: 2020 2020 2070 6173 730a 0a20 2020 2040       pass..    @
+00001770: 6162 7374 7261 6374 6d65 7468 6f64 0a20  abstractmethod. 
+00001780: 2020 2064 6566 2064 7261 775f 6c69 6e65     def draw_line
+00001790: 2873 656c 662c 2070 6174 7465 726e 5f73  (self, pattern_s
+000017a0: 6574 7469 6e67 733a 2046 6962 7365 6d50  ettings: FibsemP
+000017b0: 6174 7465 726e 5365 7474 696e 6773 293a  atternSettings):
+000017c0: 0a20 2020 2020 2020 2070 6173 730a 0a20  .        pass.. 
+000017d0: 2020 2040 6162 7374 7261 6374 6d65 7468     @abstractmeth
+000017e0: 6f64 0a20 2020 2064 6566 2064 7261 775f  od.    def draw_
+000017f0: 6369 7263 6c65 2873 656c 662c 2070 6174  circle(self, pat
+00001800: 7465 726e 5f73 6574 7469 6e67 733a 2046  tern_settings: F
+00001810: 6962 7365 6d50 6174 7465 726e 5365 7474  ibsemPatternSett
+00001820: 696e 6773 293a 0a20 2020 2020 2020 2070  ings):.        p
+00001830: 6173 730a 0a20 2020 2040 6162 7374 7261  ass..    @abstra
+00001840: 6374 6d65 7468 6f64 0a20 2020 2064 6566  ctmethod.    def
+00001850: 2064 7261 775f 6269 746d 6170 5f70 6174   draw_bitmap_pat
+00001860: 7465 726e 280a 2020 2020 2020 2020 7365  tern(.        se
+00001870: 6c66 2c0a 2020 2020 2020 2020 7061 7474  lf,.        patt
+00001880: 6572 6e5f 7365 7474 696e 6773 3a20 4669  ern_settings: Fi
+00001890: 6273 656d 5061 7474 6572 6e53 6574 7469  bsemPatternSetti
+000018a0: 6e67 732c 0a20 2020 2020 2020 2070 6174  ngs,.        pat
+000018b0: 683a 2073 7472 2c0a 2020 2020 293a 0a20  h: str,.    ):. 
+000018c0: 2020 2020 2020 2070 6173 730a 0a20 2020         pass..   
+000018d0: 2040 6162 7374 7261 6374 6d65 7468 6f64   @abstractmethod
+000018e0: 0a20 2020 2064 6566 2067 6574 5f73 6361  .    def get_sca
+000018f0: 6e5f 6469 7265 6374 696f 6e73 2873 656c  n_directions(sel
+00001900: 6629 202d 3e20 6c69 7374 3a0a 2020 2020  f) -> list:.    
+00001910: 2020 2020 7061 7373 0a0a 2020 2020 4061      pass..    @a
+00001920: 6273 7472 6163 746d 6574 686f 640a 2020  bstractmethod.  
+00001930: 2020 6465 6620 7365 7475 705f 7370 7574    def setup_sput
+00001940: 7465 7228 7365 6c66 2c20 2a61 7267 732c  ter(self, *args,
+00001950: 202a 2a6b 7761 7267 7329 3a0a 2020 2020   **kwargs):.    
+00001960: 2020 2020 7061 7373 0a0a 2020 2020 4061      pass..    @a
+00001970: 6273 7472 6163 746d 6574 686f 640a 2020  bstractmethod.  
+00001980: 2020 6465 6620 6472 6177 5f73 7075 7474    def draw_sputt
+00001990: 6572 5f70 6174 7465 726e 2873 656c 662c  er_pattern(self,
+000019a0: 202a 6172 6773 2c20 2a2a 6b77 6172 6773   *args, **kwargs
+000019b0: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
+000019c0: 2020 2070 6173 730a 0a20 2020 2040 6162     pass..    @ab
+000019d0: 7374 7261 6374 6d65 7468 6f64 0a20 2020  stractmethod.   
+000019e0: 2064 6566 2072 756e 5f73 7075 7474 6572   def run_sputter
+000019f0: 2873 656c 662c 202a 6172 6773 2c20 2a2a  (self, *args, **
+00001a00: 6b77 6172 6773 293a 0a20 2020 2020 2020  kwargs):.       
+00001a10: 2070 6173 730a 0a20 2020 2040 6162 7374   pass..    @abst
+00001a20: 7261 6374 6d65 7468 6f64 0a20 2020 2064  ractmethod.    d
+00001a30: 6566 2066 696e 6973 685f 7370 7574 7465  ef finish_sputte
+00001a40: 7228 7365 6c66 293a 0a20 2020 2020 2020  r(self):.       
+00001a50: 2070 6173 730a 0a20 2020 2040 6162 7374   pass..    @abst
+00001a60: 7261 6374 6d65 7468 6f64 0a20 2020 2064  ractmethod.    d
+00001a70: 6566 2073 6574 5f6d 6963 726f 7363 6f70  ef set_microscop
+00001a80: 655f 7374 6174 6528 7365 6c66 2c20 7374  e_state(self, st
+00001a90: 6174 653a 204d 6963 726f 7363 6f70 6553  ate: MicroscopeS
+00001aa0: 7461 7465 2920 2d3e 204e 6f6e 653a 0a20  tate) -> None:. 
+00001ab0: 2020 2020 2020 2070 6173 730a 2020 2020         pass.    
+00001ac0: 0a20 2020 2040 6162 7374 7261 6374 6d65  .    @abstractme
+00001ad0: 7468 6f64 0a20 2020 2064 6566 2067 6574  thod.    def get
+00001ae0: 5f61 7661 696c 6162 6c65 5f76 616c 7565  _available_value
+00001af0: 7328 7365 6c66 2c20 6b65 793a 7374 722c  s(self, key:str,
+00001b00: 2062 6561 6d5f 7479 7065 3a20 4265 616d   beam_type: Beam
+00001b10: 5479 7065 203d 204e 6f6e 6529 202d 3e20  Type = None) -> 
+00001b20: 6c69 7374 3a0a 2020 2020 2020 2020 7061  list:.        pa
+00001b30: 7373 0a0a 2020 2020 4061 6273 7472 6163  ss..    @abstrac
+00001b40: 746d 6574 686f 640a 2020 2020 6465 6620  tmethod.    def 
+00001b50: 6765 7428 7365 6c66 2c20 6b65 793a 7374  get(self, key:st
+00001b60: 722c 2062 6561 6d5f 7479 7065 3a20 4265  r, beam_type: Be
+00001b70: 616d 5479 7065 203d 204e 6f6e 6529 3a0a  amType = None):.
+00001b80: 2020 2020 2020 2020 7061 7373 0a20 2020          pass.   
+00001b90: 200a 2020 2020 4061 6273 7472 6163 746d   .    @abstractm
+00001ba0: 6574 686f 640a 2020 2020 6465 6620 6765  ethod.    def ge
+00001bb0: 745f 6265 616d 5f73 6574 7469 6e67 7328  t_beam_settings(
+00001bc0: 7365 6c66 2c20 6265 616d 5f74 7970 653a  self, beam_type:
+00001bd0: 2042 6561 6d54 7970 6520 3d20 4e6f 6e65   BeamType = None
+00001be0: 2920 2d3e 2042 6561 6d53 6574 7469 6e67  ) -> BeamSetting
+00001bf0: 733a 0a20 2020 2020 2020 2070 6173 730a  s:.        pass.
+00001c00: 0a20 2020 2064 6566 2073 6574 5f62 6561  .    def set_bea
+00001c10: 6d5f 7365 7474 696e 6773 2873 656c 662c  m_settings(self,
+00001c20: 2073 6574 7469 6e67 733a 2042 6561 6d53   settings: BeamS
+00001c30: 7973 7465 6d53 6574 7469 6e67 7329 202d  ystemSettings) -
+00001c40: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
+00001c50: 7061 7373 0a0a 2020 2020 4061 6273 7472  pass..    @abstr
+00001c60: 6163 746d 6574 686f 640a 2020 2020 6465  actmethod.    de
+00001c70: 6620 6765 745f 6465 7465 6374 6f72 5f73  f get_detector_s
+00001c80: 6574 7469 6e67 7328 7365 6c66 2c20 6265  ettings(self, be
+00001c90: 616d 5f74 7970 653a 2042 6561 6d54 7970  am_type: BeamTyp
+00001ca0: 6520 3d20 4e6f 6e65 2920 2d3e 2046 6962  e = None) -> Fib
+00001cb0: 7365 6d44 6574 6563 746f 7253 6574 7469  semDetectorSetti
+00001cc0: 6e67 733a 0a20 2020 2020 2020 2070 6173  ngs:.        pas
+00001cd0: 730a 0a20 2020 2040 6162 7374 7261 6374  s..    @abstract
+00001ce0: 6d65 7468 6f64 0a20 2020 2064 6566 2073  method.    def s
+00001cf0: 6574 2873 656c 662c 206b 6579 3a20 7374  et(self, key: st
+00001d00: 722c 2076 616c 7565 2c20 6265 616d 5f74  r, value, beam_t
+00001d10: 7970 653a 2042 6561 6d54 7970 6520 3d20  ype: BeamType = 
+00001d20: 4e6f 6e65 2920 2d3e 204e 6f6e 653a 0a20  None) -> None:. 
+00001d30: 2020 2020 2020 2070 6173 730a 0a20 2020         pass..   
+00001d40: 2040 6162 7374 7261 6374 6d65 7468 6f64   @abstractmethod
+00001d50: 0a0a 2020 2020 6465 6620 6368 6563 6b5f  ..    def check_
+00001d60: 6176 6169 6c61 626c 655f 7661 6c75 6573  available_values
+00001d70: 2873 656c 662c 206b 6579 3a73 7472 2c20  (self, key:str, 
+00001d80: 7661 6c75 6573 2c20 6265 616d 5f74 7970  values, beam_typ
+00001d90: 653a 2042 6561 6d54 7970 6520 3d20 4e6f  e: BeamType = No
+00001da0: 6e65 2920 2d3e 2062 6f6f 6c3a 0a20 2020  ne) -> bool:.   
+00001db0: 2020 2020 2070 6173 730a 0a20 2020 2040       pass..    @
+00001dc0: 6162 7374 7261 6374 6d65 7468 6f64 0a20  abstractmethod. 
+00001dd0: 2020 2064 6566 2067 6574 5f6d 616e 6970     def get_manip
+00001de0: 756c 6174 6f72 5f73 7461 7465 2873 656c  ulator_state(sel
+00001df0: 662c 2073 6574 7469 6e67 733a 204d 6963  f, settings: Mic
+00001e00: 726f 7363 6f70 6553 6574 7469 6e67 7329  roscopeSettings)
+00001e10: 202d 3e20 626f 6f6c 3a0a 2020 2020 2020   -> bool:.      
+00001e20: 2020 7061 7373 0a0a 2020 2020 4061 6273    pass..    @abs
+00001e30: 7472 6163 746d 6574 686f 640a 2020 2020  tractmethod.    
+00001e40: 6465 6620 686f 6d65 2873 656c 6629 3a0a  def home(self):.
+00001e50: 2020 2020 2020 2020 7061 7373 0a0a 636c          pass..cl
+00001e60: 6173 7320 5468 6572 6d6f 4d69 6372 6f73  ass ThermoMicros
+00001e70: 636f 7065 2846 6962 7365 6d4d 6963 726f  cope(FibsemMicro
+00001e80: 7363 6f70 6529 3a0a 2020 2020 2222 220a  scope):.    """.
+00001e90: 2020 2020 4120 636c 6173 7320 7265 7072      A class repr
+00001ea0: 6573 656e 7469 6e67 2061 2054 6865 726d  esenting a Therm
+00001eb0: 6f20 4669 7368 6572 2046 4942 2d53 454d  o Fisher FIB-SEM
+00001ec0: 206d 6963 726f 7363 6f70 652e 0a0a 2020   microscope...  
+00001ed0: 2020 5468 6973 2063 6c61 7373 2069 6e68    This class inh
+00001ee0: 6572 6974 7320 6672 6f6d 2074 6865 2061  erits from the a
+00001ef0: 6273 7472 6163 7420 6261 7365 2063 6c61  bstract base cla
+00001f00: 7373 2060 4669 6273 656d 4d69 6372 6f73  ss `FibsemMicros
+00001f10: 636f 7065 602c 2077 6869 6368 2064 6566  cope`, which def
+00001f20: 696e 6573 2074 6865 2063 6f72 6520 6675  ines the core fu
+00001f30: 6e63 7469 6f6e 616c 6974 7920 6f66 2061  nctionality of a
+00001f40: 0a20 2020 206d 6963 726f 7363 6f70 652e  .    microscope.
+00001f50: 2049 6e20 6164 6469 7469 6f6e 2074 6f20   In addition to 
+00001f60: 7468 6520 6d65 7468 6f64 7320 6465 6669  the methods defi
+00001f70: 6e65 6420 696e 2074 6865 2062 6173 6520  ned in the base 
+00001f80: 636c 6173 732c 2074 6869 7320 636c 6173  class, this clas
+00001f90: 7320 7072 6f76 6964 6573 2061 6464 6974  s provides addit
+00001fa0: 696f 6e61 6c20 6d65 7468 6f64 7320 7370  ional methods sp
+00001fb0: 6563 6966 6963 0a20 2020 2074 6f20 7468  ecific.    to th
+00001fc0: 6520 5468 6572 6d6f 2046 6973 6865 7220  e Thermo Fisher 
+00001fd0: 4649 422d 5345 4d20 6d69 6372 6f73 636f  FIB-SEM microsco
+00001fe0: 7065 2e0a 0a20 2020 2041 7474 7269 6275  pe...    Attribu
+00001ff0: 7465 733a 0a20 2020 2020 2020 2063 6f6e  tes:.        con
+00002000: 6e65 6374 696f 6e20 2853 6462 4d69 6372  nection (SdbMicr
+00002010: 6f73 636f 7065 436c 6965 6e74 293a 2054  oscopeClient): T
+00002020: 6865 206d 6963 726f 7363 6f70 6520 636c  he microscope cl
+00002030: 6965 6e74 2063 6f6e 6e65 6374 696f 6e2e  ient connection.
+00002040: 0a0a 2020 2020 496e 6865 7269 7465 6420  ..    Inherited 
+00002050: 4d65 7468 6f64 733a 0a20 2020 2020 2020  Methods:.       
+00002060: 2063 6f6e 6e65 6374 5f74 6f5f 6d69 6372   connect_to_micr
+00002070: 6f73 636f 7065 2873 656c 662c 2069 705f  oscope(self, ip_
+00002080: 6164 6472 6573 733a 2073 7472 2c20 706f  address: str, po
+00002090: 7274 3a20 696e 7420 3d20 3735 3230 2920  rt: int = 7520) 
+000020a0: 2d3e 204e 6f6e 653a 200a 2020 2020 2020  -> None: .      
+000020b0: 2020 2020 2020 436f 6e6e 6563 7420 746f        Connect to
+000020c0: 2061 2054 6865 726d 6f20 4669 7368 6572   a Thermo Fisher
+000020d0: 206d 6963 726f 7363 6f70 6520 6174 2074   microscope at t
+000020e0: 6865 2073 7065 6369 6669 6564 2049 5020  he specified IP 
+000020f0: 6164 6472 6573 7320 616e 6420 706f 7274  address and port
+00002100: 2e0a 0a20 2020 2020 2020 2064 6973 636f  ...        disco
+00002110: 6e6e 6563 7428 7365 6c66 2920 2d3e 204e  nnect(self) -> N
+00002120: 6f6e 653a 200a 2020 2020 2020 2020 2020  one: .          
+00002130: 2020 4469 7363 6f6e 6e65 6374 7320 7468    Disconnects th
+00002140: 6520 6d69 6372 6f73 636f 7065 2063 6c69  e microscope cli
+00002150: 656e 7420 636f 6e6e 6563 7469 6f6e 2e0a  ent connection..
+00002160: 0a20 2020 2020 2020 2061 6371 7569 7265  .        acquire
+00002170: 5f69 6d61 6765 2873 656c 662c 2069 6d61  _image(self, ima
+00002180: 6765 5f73 6574 7469 6e67 733a 2049 6d61  ge_settings: Ima
+00002190: 6765 5365 7474 696e 6773 2920 2d3e 2046  geSettings) -> F
+000021a0: 6962 7365 6d49 6d61 6765 3a20 0a20 2020  ibsemImage: .   
+000021b0: 2020 2020 2020 2020 2041 6371 7569 7265           Acquire
+000021c0: 2061 206e 6577 2069 6d61 6765 2077 6974   a new image wit
+000021d0: 6820 7468 6520 7370 6563 6966 6965 6420  h the specified 
+000021e0: 7365 7474 696e 6773 2e0a 0a20 2020 2020  settings...     
+000021f0: 2020 206c 6173 745f 696d 6167 6528 7365     last_image(se
+00002200: 6c66 2c20 6265 616d 5f74 7970 653a 2042  lf, beam_type: B
+00002210: 6561 6d54 7970 6520 3d20 4265 616d 5479  eamType = BeamTy
+00002220: 7065 2e45 4c45 4354 524f 4e29 202d 3e20  pe.ELECTRON) -> 
+00002230: 4669 6273 656d 496d 6167 653a 200a 2020  FibsemImage: .  
+00002240: 2020 2020 2020 2020 2020 4765 7420 7468            Get th
+00002250: 6520 6c61 7374 2070 7265 7669 6f75 736c  e last previousl
+00002260: 7920 6163 7175 6972 6564 2069 6d61 6765  y acquired image
+00002270: 2e0a 0a20 2020 2020 2020 2061 7574 6f63  ...        autoc
+00002280: 6f6e 7472 6173 7428 7365 6c66 2c20 6265  ontrast(self, be
+00002290: 616d 5f74 7970 653d 4265 616d 5479 7065  am_type=BeamType
+000022a0: 2e45 4c45 4354 524f 4e29 202d 3e20 4e6f  .ELECTRON) -> No
+000022b0: 6e65 3a20 0a20 2020 2020 2020 2020 2020  ne: .           
+000022c0: 2041 7574 6f6d 6174 6963 616c 6c79 2061   Automatically a
+000022d0: 646a 7573 7420 7468 6520 6d69 6372 6f73  djust the micros
+000022e0: 636f 7065 2069 6d61 6765 2063 6f6e 7472  cope image contr
+000022f0: 6173 7420 666f 7220 7468 6520 7370 6563  ast for the spec
+00002300: 6966 6965 6420 6265 616d 2074 7970 652e  ified beam type.
+00002310: 0a0a 2020 2020 2020 2020 6175 746f 5f66  ..        auto_f
+00002320: 6f63 7573 2873 656c 662c 2062 6561 6d5f  ocus(self, beam_
+00002330: 7479 7065 3a20 4265 616d 5479 7065 2920  type: BeamType) 
+00002340: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
+00002350: 2020 2020 2041 7574 6f6d 6174 6963 616c       Automatical
+00002360: 6c79 2061 646a 7573 7420 7468 6520 6d69  ly adjust the mi
+00002370: 6372 6f73 636f 7065 2066 6f63 7573 2066  croscope focus f
+00002380: 6f72 2074 6865 2073 7065 6369 6669 6564  or the specified
+00002390: 2062 6561 6d20 7479 7065 2e0a 0a20 2020   beam type...   
+000023a0: 2020 2020 2072 6573 6574 5f62 6561 6d5f       reset_beam_
+000023b0: 7368 6966 7473 2873 656c 6629 202d 3e20  shifts(self) -> 
+000023c0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+000023d0: 2020 5365 7420 7468 6520 6265 616d 2073    Set the beam s
+000023e0: 6869 6674 2074 6f20 7a65 726f 2066 6f72  hift to zero for
+000023f0: 2074 6865 2065 6c65 6374 726f 6e20 616e   the electron an
+00002400: 6420 696f 6e20 6265 616d 732e 0a20 2020  d ion beams..   
+00002410: 2020 2020 200a 2020 2020 2020 2020 6265       .        be
+00002420: 616d 5f73 6869 6674 2873 656c 662c 2064  am_shift(self, d
+00002430: 783a 2066 6c6f 6174 2c20 6479 3a20 666c  x: float, dy: fl
+00002440: 6f61 742c 2020 6265 616d 5f74 7970 653a  oat,  beam_type:
+00002450: 2042 6561 6d54 7970 6529 202d 3e20 4e6f   BeamType) -> No
+00002460: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+00002470: 4164 6a75 7374 7320 7468 6520 6265 616d  Adjusts the beam
+00002480: 2073 6869 6674 206f 6620 6769 7665 6e20   shift of given 
+00002490: 6265 616d 2062 6173 6564 206f 6e20 7265  beam based on re
+000024a0: 6c61 7469 7665 2076 616c 7565 7320 7468  lative values th
+000024b0: 6174 2061 7265 2070 726f 7669 6465 642e  at are provided.
+000024c0: 0a0a 2020 2020 2020 2020 6765 745f 7374  ..        get_st
+000024d0: 6167 655f 706f 7369 7469 6f6e 2873 656c  age_position(sel
+000024e0: 6629 202d 3e20 4669 6273 656d 5374 6167  f) -> FibsemStag
+000024f0: 6550 6f73 6974 696f 6e3a 0a20 2020 2020  ePosition:.     
+00002500: 2020 2020 2020 2047 6574 2074 6865 2063         Get the c
+00002510: 7572 7265 6e74 2073 7461 6765 2070 6f73  urrent stage pos
+00002520: 6974 696f 6e2e 0a0a 2020 2020 2020 2020  ition...        
+00002530: 6765 745f 6375 7272 656e 745f 6d69 6372  get_current_micr
+00002540: 6f73 636f 7065 5f73 7461 7465 2873 656c  oscope_state(sel
+00002550: 6629 202d 3e20 4d69 6372 6f73 636f 7065  f) -> Microscope
+00002560: 5374 6174 653a 0a20 2020 2020 2020 2020  State:.         
+00002570: 2020 2047 6574 2074 6865 2063 7572 7265     Get the curre
+00002580: 6e74 206d 6963 726f 7363 6f70 6520 7374  nt microscope st
+00002590: 6174 650a 0a20 2020 2020 2020 206d 6f76  ate..        mov
+000025a0: 655f 7374 6167 655f 6162 736f 6c75 7465  e_stage_absolute
+000025b0: 2873 656c 662c 2070 6f73 6974 696f 6e3a  (self, position:
+000025c0: 2046 6962 7365 6d53 7461 6765 506f 7369   FibsemStagePosi
+000025d0: 7469 6f6e 293a 0a20 2020 2020 2020 2020  tion):.         
+000025e0: 2020 204d 6f76 6520 7468 6520 7374 6167     Move the stag
+000025f0: 6520 746f 2074 6865 2073 7065 6369 6669  e to the specifi
+00002600: 6564 2063 6f6f 7264 696e 6174 6573 2e0a  ed coordinates..
+00002610: 0a20 2020 2020 2020 206d 6f76 655f 7374  .        move_st
+00002620: 6167 655f 7265 6c61 7469 7665 2873 656c  age_relative(sel
+00002630: 662c 2070 6f73 6974 696f 6e3a 2046 6962  f, position: Fib
+00002640: 7365 6d53 7461 6765 506f 7369 7469 6f6e  semStagePosition
+00002650: 293a 0a20 2020 2020 2020 2020 2020 204d  ):.            M
+00002660: 6f76 6520 7468 6520 7374 6167 6520 6279  ove the stage by
+00002670: 2074 6865 2073 7065 6369 6669 6564 2072   the specified r
+00002680: 656c 6174 6976 6520 6d6f 7665 2e0a 0a20  elative move... 
+00002690: 2020 2020 2020 2073 7461 626c 655f 6d6f         stable_mo
+000026a0: 7665 2873 656c 662c 2073 6574 7469 6e67  ve(self, setting
+000026b0: 733a 204d 6963 726f 7363 6f70 6553 6574  s: MicroscopeSet
+000026c0: 7469 6e67 732c 2064 783a 2066 6c6f 6174  tings, dx: float
+000026d0: 2c20 6479 3a20 666c 6f61 742c 2062 6561  , dy: float, bea
+000026e0: 6d5f 7479 7065 3a20 4265 616d 5479 7065  m_type: BeamType
+000026f0: 2c29 202d 3e20 4e6f 6e65 3a0a 2020 2020  ,) -> None:.    
+00002700: 2020 2020 2020 2020 4361 6c63 756c 6174          Calculat
+00002710: 6520 7468 6520 636f 7272 6563 7465 6420  e the corrected 
+00002720: 7374 6167 6520 6d6f 7665 6d65 6e74 7320  stage movements 
+00002730: 6261 7365 6420 6f6e 2074 6865 2062 6561  based on the bea
+00002740: 6d5f 7479 7065 2c20 616e 6420 7468 656e  m_type, and then
+00002750: 206d 6f76 6520 7468 6520 7374 6167 6520   move the stage 
+00002760: 7265 6c61 7469 7665 6c79 2e0a 0a20 2020  relatively...   
+00002770: 2020 2020 2065 7563 656e 7472 6963 5f6d       eucentric_m
+00002780: 6f76 6528 7365 6c66 2c20 7365 7474 696e  ove(self, settin
+00002790: 6773 3a20 4d69 6372 6f73 636f 7065 5365  gs: MicroscopeSe
+000027a0: 7474 696e 6773 2c20 6479 3a20 666c 6f61  ttings, dy: floa
+000027b0: 742c 2073 7461 7469 635f 7764 3a20 626f  t, static_wd: bo
+000027c0: 6f6c 203d 2054 7275 6529 202d 3e20 4e6f  ol = True) -> No
+000027d0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+000027e0: 4d6f 7665 2074 6865 2073 7461 6765 2076  Move the stage v
+000027f0: 6572 7469 6361 6c6c 7920 746f 2063 6f72  ertically to cor
+00002800: 7265 6374 2065 7563 656e 7472 6963 2070  rect eucentric p
+00002810: 6f69 6e74 0a20 2020 2020 2020 200a 2020  oint.        .  
+00002820: 2020 2020 2020 6d6f 7665 5f66 6c61 745f        move_flat_
+00002830: 746f 5f62 6561 6d28 7365 6c66 2c20 7365  to_beam(self, se
+00002840: 7474 696e 6773 3a20 4d69 6372 6f73 636f  ttings: Microsco
+00002850: 7065 5365 7474 696e 6773 2c20 6265 616d  peSettings, beam
+00002860: 5f74 7970 653a 2042 6561 6d54 7970 6520  _type: BeamType 
+00002870: 3d20 4265 616d 5479 7065 2e45 4c45 4354  = BeamType.ELECT
+00002880: 524f 4e29 3a0a 2020 2020 2020 2020 2020  RON):.          
+00002890: 2020 4d61 6b65 2074 6865 2073 616d 706c    Make the sampl
+000028a0: 6520 7375 7266 6163 6520 666c 6174 2074  e surface flat t
+000028b0: 6f20 7468 6520 656c 6563 7472 6f6e 206f  o the electron o
+000028c0: 7220 696f 6e20 6265 616d 2e0a 0a20 2020  r ion beam...   
+000028d0: 2020 2020 2067 6574 5f6d 616e 6970 756c       get_manipul
+000028e0: 6174 6f72 5f70 6f73 6974 696f 6e28 7365  ator_position(se
+000028f0: 6c66 2920 2d3e 2046 6962 7365 6d4d 616e  lf) -> FibsemMan
+00002900: 6970 756c 6174 6f72 506f 7369 7469 6f6e  ipulatorPosition
+00002910: 3a0a 2020 2020 2020 2020 2020 2020 4765  :.            Ge
+00002920: 7420 7468 6520 6375 7272 656e 7420 6d61  t the current ma
+00002930: 6e69 7075 6c61 746f 7220 706f 7369 7469  nipulator positi
+00002940: 6f6e 2e0a 2020 2020 2020 2020 0a20 2020  on..        .   
+00002950: 2020 2020 2069 6e73 6572 745f 6d61 6e69       insert_mani
+00002960: 7075 6c61 746f 7228 7365 6c66 2c20 6e61  pulator(self, na
+00002970: 6d65 3a20 7374 7229 202d 3e20 4e6f 6e65  me: str) -> None
+00002980: 3a0a 2020 2020 2020 2020 2020 2020 496e  :.            In
+00002990: 7365 7274 2074 6865 206d 616e 6970 756c  sert the manipul
+000029a0: 6174 6f72 2069 6e74 6f20 7468 6520 7361  ator into the sa
+000029b0: 6d70 6c65 2e0a 2020 2020 2020 2020 0a20  mple..        . 
+000029c0: 2020 2020 2020 2072 6574 7261 6374 5f6d         retract_m
+000029d0: 616e 6970 756c 6174 6f72 2873 656c 6629  anipulator(self)
+000029e0: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
+000029f0: 2020 2020 2020 5265 7472 6163 7420 7468        Retract th
+00002a00: 6520 6d61 6e69 7075 6c61 746f 7220 6672  e manipulator fr
+00002a10: 6f6d 2074 6865 2073 616d 706c 652e 0a0a  om the sample...
+00002a20: 2020 2020 2020 2020 6d6f 7665 5f6d 616e          move_man
+00002a30: 6970 756c 6174 6f72 5f72 656c 6174 6976  ipulator_relativ
+00002a40: 6528 7365 6c66 2c20 706f 7369 7469 6f6e  e(self, position
+00002a50: 3a20 4669 6273 656d 4d61 6e69 7075 6c61  : FibsemManipula
+00002a60: 746f 7250 6f73 6974 696f 6e29 202d 3e20  torPosition) -> 
+00002a70: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+00002a80: 2020 4d6f 7665 2074 6865 206d 616e 6970    Move the manip
+00002a90: 756c 6174 6f72 2062 7920 7468 6520 7370  ulator by the sp
+00002aa0: 6563 6966 6965 6420 7265 6c61 7469 7665  ecified relative
+00002ab0: 206d 6f76 652e 0a20 2020 2020 2020 200a   move..        .
+00002ac0: 2020 2020 2020 2020 6d6f 7665 5f6d 616e          move_man
+00002ad0: 6970 756c 6174 6f72 5f61 6273 6f6c 7574  ipulator_absolut
+00002ae0: 6528 7365 6c66 2c20 706f 7369 7469 6f6e  e(self, position
+00002af0: 3a20 4669 6273 656d 4d61 6e69 7075 6c61  : FibsemManipula
+00002b00: 746f 7250 6f73 6974 696f 6e29 202d 3e20  torPosition) -> 
+00002b10: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+00002b20: 2020 4d6f 7665 2074 6865 206d 616e 6970    Move the manip
+00002b30: 756c 6174 6f72 2074 6f20 7468 6520 7370  ulator to the sp
+00002b40: 6563 6966 6965 6420 636f 6f72 6469 6e61  ecified coordina
+00002b50: 7465 732e 0a0a 2020 2020 2020 2020 6d6f  tes...        mo
+00002b60: 7665 5f6d 616e 6970 756c 6174 6f72 5f63  ve_manipulator_c
+00002b70: 6f72 7265 6374 6564 2873 656c 662c 2064  orrected(self, d
+00002b80: 783a 2066 6c6f 6174 2c20 6479 3a20 666c  x: float, dy: fl
+00002b90: 6f61 742c 2062 6561 6d5f 7479 7065 3a20  oat, beam_type: 
+00002ba0: 4265 616d 5479 7065 2920 2d3e 204e 6f6e  BeamType) -> Non
+00002bb0: 653a 0a20 2020 2020 2020 2020 2020 204d  e:.            M
+00002bc0: 6f76 6520 7468 6520 6d61 6e69 7075 6c61  ove the manipula
+00002bd0: 746f 7220 6279 2074 6865 2073 7065 6369  tor by the speci
+00002be0: 6669 6564 2072 656c 6174 6976 6520 6d6f  fied relative mo
+00002bf0: 7665 2c20 636f 7272 6563 7469 6e67 2066  ve, correcting f
+00002c00: 6f72 2074 6865 2062 6561 6d20 7479 7065  or the beam type
+00002c10: 2e20 2020 2020 200a 0a20 2020 2020 2020  .      ..       
+00002c20: 206d 6f76 655f 6d61 6e69 7075 6c61 746f   move_manipulato
+00002c30: 725f 746f 5f70 6f73 6974 696f 6e5f 6f66  r_to_position_of
+00002c40: 6673 6574 2873 656c 662c 206f 6666 7365  fset(self, offse
+00002c50: 743a 2046 6962 7365 6d4d 616e 6970 756c  t: FibsemManipul
+00002c60: 6174 6f72 506f 7369 7469 6f6e 2c20 6e61  atorPosition, na
+00002c70: 6d65 3a20 7374 7229 202d 3e20 4e6f 6e65  me: str) -> None
+00002c80: 3a0a 2020 2020 2020 2020 2020 2020 4d6f  :.            Mo
+00002c90: 7665 2074 6865 206d 616e 6970 756c 6174  ve the manipulat
+00002ca0: 6f72 2074 6f20 7468 6520 7370 6563 6966  or to the specif
+00002cb0: 6965 6420 706f 7369 7469 6f6e 206f 6666  ied position off
+00002cc0: 7365 742e 0a0a 2020 2020 2020 2020 5f67  set...        _g
+00002cd0: 6574 5f73 6176 6564 5f6d 616e 6970 756c  et_saved_manipul
+00002ce0: 6174 6f72 5f70 6f73 6974 696f 6e28 7365  ator_position(se
+00002cf0: 6c66 2c20 6e61 6d65 3a20 7374 7229 202d  lf, name: str) -
+00002d00: 3e20 4669 6273 656d 4d61 6e69 7075 6c61  > FibsemManipula
+00002d10: 746f 7250 6f73 6974 696f 6e3a 0a20 2020  torPosition:.   
+00002d20: 2020 2020 2020 2020 2047 6574 2074 6865           Get the
+00002d30: 2073 6176 6564 206d 616e 6970 756c 6174   saved manipulat
+00002d40: 6f72 2070 6f73 6974 696f 6e20 7769 7468  or position with
+00002d50: 2074 6865 2073 7065 6369 6669 6564 206e   the specified n
+00002d60: 616d 652e 0a0a 2020 2020 2020 2020 7365  ame...        se
+00002d70: 7475 705f 6d69 6c6c 696e 6728 7365 6c66  tup_milling(self
+00002d80: 2c20 6d69 6c6c 5f73 6574 7469 6e67 733a  , mill_settings:
+00002d90: 2046 6962 7365 6d4d 696c 6c69 6e67 5365   FibsemMillingSe
+00002da0: 7474 696e 6773 293a 0a20 2020 2020 2020  ttings):.       
+00002db0: 2020 2020 2043 6f6e 6669 6775 7265 2074       Configure t
+00002dc0: 6865 206d 6963 726f 7363 6f70 6520 666f  he microscope fo
+00002dd0: 7220 6d69 6c6c 696e 6720 7573 696e 6720  r milling using 
+00002de0: 7468 6520 696f 6e20 6265 616d 2e0a 0a20  the ion beam... 
+00002df0: 2020 2020 2020 2072 756e 5f6d 696c 6c69         run_milli
+00002e00: 6e67 2873 656c 662c 206d 696c 6c69 6e67  ng(self, milling
+00002e10: 5f63 7572 7265 6e74 3a20 666c 6f61 742c  _current: float,
+00002e20: 2061 7379 6e63 683a 2062 6f6f 6c20 3d20   asynch: bool = 
+00002e30: 4661 6c73 6529 3a0a 2020 2020 2020 2020  False):.        
+00002e40: 2020 2020 5275 6e20 696f 6e20 6265 616d      Run ion beam
+00002e50: 206d 696c 6c69 6e67 2075 7369 6e67 2074   milling using t
+00002e60: 6865 2073 7065 6369 6669 6564 206d 696c  he specified mil
+00002e70: 6c69 6e67 2063 7572 7265 6e74 2e0a 0a20  ling current... 
+00002e80: 2020 2020 2020 2064 6566 2072 756e 5f6d         def run_m
+00002e90: 696c 6c69 6e67 5f64 7269 6674 5f63 6f72  illing_drift_cor
+00002ea0: 7265 6374 6564 2873 656c 662c 206d 696c  rected(self, mil
+00002eb0: 6c69 6e67 5f63 7572 7265 6e74 3a20 666c  ling_current: fl
+00002ec0: 6f61 742c 2069 6d61 6765 5f73 6574 7469  oat, image_setti
+00002ed0: 6e67 733a 2049 6d61 6765 5365 7474 696e  ngs: ImageSettin
+00002ee0: 6773 2c20 7265 665f 696d 6167 653a 2046  gs, ref_image: F
+00002ef0: 6962 7365 6d49 6d61 6765 2c20 7265 6475  ibsemImage, redu
+00002f00: 6365 645f 6172 6561 3a20 4669 6273 656d  ced_area: Fibsem
+00002f10: 5265 6374 616e 676c 6520 3d20 4e6f 6e65  Rectangle = None
+00002f20: 2c20 6173 796e 6368 3a20 626f 6f6c 203d  , asynch: bool =
+00002f30: 2046 616c 7365 293a 0a20 2020 2020 2020   False):.       
+00002f40: 2020 2020 2052 756e 2069 6f6e 2062 6561       Run ion bea
+00002f50: 6d20 6d69 6c6c 696e 6720 7573 696e 6720  m milling using 
+00002f60: 7468 6520 7370 6563 6966 6965 6420 6d69  the specified mi
+00002f70: 6c6c 696e 6720 6375 7272 656e 742c 2061  lling current, a
+00002f80: 6e64 2063 6f72 7265 6374 2066 6f72 2064  nd correct for d
+00002f90: 7269 6674 2075 7369 6e67 2074 6865 2070  rift using the p
+00002fa0: 726f 7669 6465 6420 7265 6665 7265 6e63  rovided referenc
+00002fb0: 6520 696d 6167 652e 0a20 2020 2020 2020  e image..       
+00002fc0: 200a 2020 2020 2020 2020 6669 6e69 7368   .        finish
+00002fd0: 5f6d 696c 6c69 6e67 2873 656c 662c 2069  _milling(self, i
+00002fe0: 6d61 6769 6e67 5f63 7572 7265 6e74 3a20  maging_current: 
+00002ff0: 666c 6f61 7429 3a0a 2020 2020 2020 2020  float):.        
+00003000: 2020 2020 4669 6e61 6c69 7365 7320 7468      Finalises th
+00003010: 6520 6d69 6c6c 696e 6720 7072 6f63 6573  e milling proces
+00003020: 7320 6279 2063 6c65 6172 696e 6720 7468  s by clearing th
+00003030: 6520 6d69 6372 6f73 636f 7065 206f 6620  e microscope of 
+00003040: 616e 7920 7061 7474 6572 6e73 2061 6e64  any patterns and
+00003050: 2072 6574 7572 6e69 6e67 2074 6865 2063   returning the c
+00003060: 7572 7265 6e74 2074 6f20 7468 6520 696d  urrent to the im
+00003070: 6167 696e 6720 6375 7272 656e 742e 0a0a  aging current...
+00003080: 2020 2020 2020 2020 6472 6177 5f72 6563          draw_rec
+00003090: 7461 6e67 6c65 2873 656c 662c 2070 6174  tangle(self, pat
+000030a0: 7465 726e 5f73 6574 7469 6e67 733a 2046  tern_settings: F
+000030b0: 6962 7365 6d50 6174 7465 726e 5365 7474  ibsemPatternSett
+000030c0: 696e 6773 293a 0a20 2020 2020 2020 2020  ings):.         
+000030d0: 2020 2044 7261 7773 2061 2072 6563 7461     Draws a recta
+000030e0: 6e67 6c65 2070 6174 7465 726e 2075 7369  ngle pattern usi
+000030f0: 6e67 2074 6865 2063 7572 7265 6e74 2069  ng the current i
+00003100: 6f6e 2062 6561 6d2e 0a0a 2020 2020 2020  on beam...      
+00003110: 2020 6472 6177 5f6c 696e 6528 7365 6c66    draw_line(self
+00003120: 2c20 7061 7474 6572 6e5f 7365 7474 696e  , pattern_settin
+00003130: 6773 3a20 4669 6273 656d 5061 7474 6572  gs: FibsemPatter
+00003140: 6e53 6574 7469 6e67 7329 3a0a 2020 2020  nSettings):.    
+00003150: 2020 2020 2020 2020 4472 6177 7320 6120          Draws a 
+00003160: 6c69 6e65 2070 6174 7465 726e 206f 6e20  line pattern on 
+00003170: 7468 6520 6375 7272 656e 7420 696d 6167  the current imag
+00003180: 696e 6720 7669 6577 206f 6620 7468 6520  ing view of the 
+00003190: 6d69 6372 6f73 636f 7065 2e0a 0a20 2020  microscope...   
+000031a0: 2020 2020 2064 7261 775f 6369 7263 6c65       draw_circle
+000031b0: 2873 656c 662c 2070 6174 7465 726e 5f73  (self, pattern_s
+000031c0: 6574 7469 6e67 733a 2046 6962 7365 6d50  ettings: FibsemP
+000031d0: 6174 7465 726e 5365 7474 696e 6773 293a  atternSettings):
+000031e0: 0a20 2020 2020 2020 2020 2020 2044 7261  .            Dra
+000031f0: 7773 2061 2063 6972 6375 6c61 7220 7061  ws a circular pa
+00003200: 7474 6572 6e20 6f6e 2074 6865 2063 7572  ttern on the cur
+00003210: 7265 6e74 2069 6d61 6769 6e67 2076 6965  rent imaging vie
+00003220: 7720 6f66 2074 6865 206d 6963 726f 7363  w of the microsc
+00003230: 6f70 652e 0a20 2020 2020 2020 200a 2020  ope..        .  
+00003240: 2020 2020 2020 6472 6177 5f62 6974 6d61        draw_bitma
+00003250: 705f 7061 7474 6572 6e28 7365 6c66 2c20  p_pattern(self, 
+00003260: 7061 7474 6572 6e5f 7365 7474 696e 6773  pattern_settings
+00003270: 3a20 4669 6273 656d 5061 7474 6572 6e53  : FibsemPatternS
+00003280: 6574 7469 6e67 732c 2070 6174 683a 2073  ettings, path: s
+00003290: 7472 293a 0a20 2020 2020 2020 2020 2020  tr):.           
+000032a0: 2044 7261 7773 2061 2062 6974 6d61 7020   Draws a bitmap 
+000032b0: 7061 7474 6572 6e20 7573 696e 6720 7468  pattern using th
+000032c0: 6520 7072 6f76 6964 6564 2069 6d61 6765  e provided image
+000032d0: 2066 696c 652e 200a 0a20 2020 2020 2020   file. ..       
+000032e0: 2067 6574 5f73 6361 6e5f 6469 7265 6374   get_scan_direct
+000032f0: 696f 6e73 2873 656c 6629 202d 3e20 6c69  ions(self) -> li
+00003300: 7374 3a0a 2020 2020 2020 2020 2020 2020  st:.            
+00003310: 4765 7420 7468 6520 6176 6169 6c61 626c  Get the availabl
+00003320: 6520 7363 616e 2064 6972 6563 7469 6f6e  e scan direction
+00003330: 7320 666f 7220 6d69 6c6c 696e 672e 0a0a  s for milling...
+00003340: 2020 2020 2020 2020 7365 7475 705f 7370          setup_sp
+00003350: 7574 7465 7228 7365 6c66 2c20 7072 6f74  utter(self, prot
+00003360: 6f63 6f6c 3a20 6469 6374 293a 0a20 2020  ocol: dict):.   
+00003370: 2020 2020 2020 2020 2053 6574 2075 7020           Set up 
+00003380: 7468 6520 7370 7574 7465 7220 636f 6174  the sputter coat
+00003390: 696e 6720 7072 6f63 6573 7320 6f6e 2074  ing process on t
+000033a0: 6865 206d 6963 726f 7363 6f70 652e 0a0a  he microscope...
+000033b0: 2020 2020 2020 2020 6472 6177 5f73 7075          draw_spu
+000033c0: 7474 6572 5f70 6174 7465 726e 2873 656c  tter_pattern(sel
+000033d0: 662c 2068 6677 3a20 666c 6f61 742c 206c  f, hfw: float, l
+000033e0: 696e 655f 7061 7474 6572 6e5f 6c65 6e67  ine_pattern_leng
+000033f0: 7468 3a20 666c 6f61 742c 2073 7075 7474  th: float, sputt
+00003400: 6572 5f74 696d 653a 2066 6c6f 6174 293a  er_time: float):
+00003410: 0a20 2020 2020 2020 2020 2020 2044 7261  .            Dra
+00003420: 7773 2061 206c 696e 6520 7061 7474 6572  ws a line patter
+00003430: 6e20 666f 7220 7370 7574 7465 7269 6e67  n for sputtering
+00003440: 2077 6974 6820 7468 6520 6769 7665 6e20   with the given 
+00003450: 7061 7261 6d65 7465 7273 2e0a 0a20 2020  parameters...   
+00003460: 2020 2020 2072 756e 5f73 7075 7474 6572       run_sputter
+00003470: 2873 656c 662c 202a 2a6b 7761 7267 7329  (self, **kwargs)
+00003480: 3a0a 2020 2020 2020 2020 2020 2020 5275  :.            Ru
+00003490: 6e73 2074 6865 2047 4953 2050 6c61 7469  ns the GIS Plati
+000034a0: 6e75 6d20 5370 7574 7465 722e 0a0a 2020  num Sputter...  
+000034b0: 2020 2020 2020 6669 6e69 7368 5f73 7075        finish_spu
+000034c0: 7474 6572 2873 656c 662c 2061 7070 6c69  tter(self, appli
+000034d0: 6361 7469 6f6e 5f66 696c 653a 2073 7472  cation_file: str
+000034e0: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
+000034f0: 2020 2020 2020 2046 696e 6973 6820 7468         Finish th
+00003500: 6520 7370 7574 7465 7220 7072 6f63 6573  e sputter proces
+00003510: 7320 6279 2063 6c65 6172 696e 6720 7061  s by clearing pa
+00003520: 7474 6572 6e73 2061 6e64 2072 6573 6574  tterns and reset
+00003530: 7469 6e67 2062 6561 6d20 616e 6420 696d  ting beam and im
+00003540: 6167 696e 6720 7365 7474 696e 6773 2e0a  aging settings..
+00003550: 0a20 2020 2020 2020 2073 6574 5f6d 6963  .        set_mic
+00003560: 726f 7363 6f70 655f 7374 6174 6528 7365  roscope_state(se
+00003570: 6c66 2c20 6d69 6372 6f73 636f 7065 5f73  lf, microscope_s
+00003580: 7461 7465 3a20 4d69 6372 6f73 636f 7065  tate: Microscope
+00003590: 5374 6174 6529 202d 3e20 4e6f 6e65 3a0a  State) -> None:.
+000035a0: 2020 2020 2020 2020 2020 2020 5265 7365              Rese
+000035b0: 7420 7468 6520 6d69 6372 6f73 636f 7065  t the microscope
+000035c0: 2073 7461 7465 2074 6f20 7468 6520 7072   state to the pr
+000035d0: 6f76 6964 6564 2073 7461 7465 2e0a 2020  ovided state..  
+000035e0: 2020 2020 2020 0a20 2020 2020 2020 2067        .        g
+000035f0: 6574 2873 656c 662c 206b 6579 3a73 7472  et(self, key:str
+00003600: 2c20 6265 616d 5f74 7970 653a 2042 6561  , beam_type: Bea
+00003610: 6d54 7970 6520 3d20 4e6f 6e65 293a 0a20  mType = None):. 
+00003620: 2020 2020 2020 2020 2020 2052 6574 7572             Retur
+00003630: 6e73 2074 6865 2076 616c 7565 206f 6620  ns the value of 
+00003640: 7468 6520 7370 6563 6966 6965 6420 6b65  the specified ke
+00003650: 792e 0a0a 2020 2020 2020 2020 7365 7428  y...        set(
+00003660: 7365 6c66 2c20 6b65 793a 2073 7472 2c20  self, key: str, 
+00003670: 7661 6c75 652c 2062 6561 6d5f 7479 7065  value, beam_type
+00003680: 3a20 4265 616d 5479 7065 203d 204e 6f6e  : BeamType = Non
+00003690: 6529 202d 3e20 4e6f 6e65 3a0a 2020 2020  e) -> None:.    
+000036a0: 2020 2020 2020 2020 5365 7473 2074 6865          Sets the
+000036b0: 2076 616c 7565 206f 6620 7468 6520 7370   value of the sp
+000036c0: 6563 6966 6965 6420 6b65 792e 0a0a 2020  ecified key...  
+000036d0: 2020 4e65 7720 6d65 7468 6f64 733a 0a20    New methods:. 
+000036e0: 2020 2020 2020 205f 5f69 6e69 745f 5f28         __init__(
+000036f0: 7365 6c66 293a 200a 2020 2020 2020 2020  self): .        
+00003700: 2020 2020 496e 6974 6961 6c69 7a65 7320      Initializes 
+00003710: 6120 6e65 7720 696e 7374 616e 6365 206f  a new instance o
+00003720: 6620 7468 6520 636c 6173 732e 0a0a 2020  f the class...  
+00003730: 2020 2020 2020 5f79 5f63 6f72 7265 6374        _y_correct
+00003740: 6564 5f73 7461 6765 5f6d 6f76 656d 656e  ed_stage_movemen
+00003750: 7428 7365 6c66 2c20 7365 7474 696e 6773  t(self, settings
+00003760: 3a20 4d69 6372 6f73 636f 7065 5365 7474  : MicroscopeSett
+00003770: 696e 6773 2c20 6578 7065 6374 6564 5f79  ings, expected_y
+00003780: 3a20 666c 6f61 742c 2062 6561 6d5f 7479  : float, beam_ty
+00003790: 7065 3a20 4265 616d 5479 7065 203d 2042  pe: BeamType = B
+000037a0: 6561 6d54 7970 652e 454c 4543 5452 4f4e  eamType.ELECTRON
+000037b0: 2920 2d3e 2046 6962 7365 6d53 7461 6765  ) -> FibsemStage
+000037c0: 506f 7369 7469 6f6e 3a0a 2020 2020 2020  Position:.      
+000037d0: 2020 2020 2020 4361 6c63 756c 6174 6520        Calculate 
+000037e0: 7468 6520 7920 636f 7272 6563 7465 6420  the y corrected 
+000037f0: 7374 6167 6520 6d6f 7665 6d65 6e74 2c20  stage movement, 
+00003800: 636f 7272 6563 7465 6420 666f 7220 7468  corrected for th
+00003810: 6520 6164 6469 7469 6f6e 616c 2074 696c  e additional til
+00003820: 7420 6f66 2074 6865 2073 616d 706c 6520  t of the sample 
+00003830: 686f 6c64 6572 2028 7072 652d 7469 6c74  holder (pre-tilt
+00003840: 2061 6e67 6c65 292e 0a20 2020 2022 2222   angle)..    """
+00003850: 0a0a 2020 2020 6465 6620 5f5f 696e 6974  ..    def __init
+00003860: 5f5f 2873 656c 662c 2068 6172 6477 6172  __(self, hardwar
+00003870: 655f 7365 7474 696e 6773 3a20 4669 6273  e_settings: Fibs
+00003880: 656d 4861 7264 7761 7265 203d 204e 6f6e  emHardware = Non
+00003890: 652c 2073 7461 6765 5f73 6574 7469 6e67  e, stage_setting
+000038a0: 733a 2053 7461 6765 5365 7474 696e 6773  s: StageSettings
+000038b0: 203d 4e6f 6e65 2c29 3a0a 2020 2020 2020   =None,):.      
+000038c0: 2020 7365 6c66 2e63 6f6e 6e65 6374 696f    self.connectio
+000038d0: 6e20 3d20 5364 624d 6963 726f 7363 6f70  n = SdbMicroscop
+000038e0: 6543 6c69 656e 7428 290a 2020 2020 2020  eClient().      
+000038f0: 2020 696d 706f 7274 2066 6962 7365 6d0a    import fibsem.
+00003900: 2020 2020 2020 2020 6672 6f6d 2066 6962          from fib
+00003910: 7365 6d2e 7574 696c 7320 696d 706f 7274  sem.utils import
+00003920: 206c 6f61 645f 7072 6f74 6f63 6f6c 0a20   load_protocol. 
+00003930: 2020 2020 2020 2069 6d70 6f72 7420 6669         import fi
+00003940: 6273 656d 2e63 6f6e 6669 6720 6173 2063  bsem.config as c
+00003950: 6667 0a20 2020 2020 2020 2069 6620 6861  fg.        if ha
+00003960: 7264 7761 7265 5f73 6574 7469 6e67 7320  rdware_settings 
+00003970: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
+00003980: 2020 2020 2064 6963 745f 7379 7374 656d       dict_system
+00003990: 203d 206c 6f61 645f 7072 6f74 6f63 6f6c   = load_protocol
+000039a0: 286f 732e 7061 7468 2e6a 6f69 6e28 6366  (os.path.join(cf
+000039b0: 672e 434f 4e46 4947 5f50 4154 482c 2022  g.CONFIG_PATH, "
+000039c0: 7379 7374 656d 2e79 616d 6c22 2929 0a20  system.yaml")). 
+000039d0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+000039e0: 6861 7264 7761 7265 5f73 6574 7469 6e67  hardware_setting
+000039f0: 7320 3d20 4669 6273 656d 4861 7264 7761  s = FibsemHardwa
+00003a00: 7265 2e5f 5f66 726f 6d5f 6469 6374 5f5f  re.__from_dict__
+00003a10: 2864 6963 745f 7379 7374 656d 5b22 6d6f  (dict_system["mo
+00003a20: 6465 6c22 5d29 0a20 2020 2020 2020 2065  del"]).        e
+00003a30: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00003a40: 2073 656c 662e 6861 7264 7761 7265 5f73   self.hardware_s
+00003a50: 6574 7469 6e67 7320 3d20 6861 7264 7761  ettings = hardwa
+00003a60: 7265 5f73 6574 7469 6e67 730a 2020 2020  re_settings.    
+00003a70: 2020 2020 6966 2073 7461 6765 5f73 6574      if stage_set
+00003a80: 7469 6e67 7320 6973 204e 6f6e 653a 0a20  tings is None:. 
+00003a90: 2020 2020 2020 2020 2020 2064 6963 745f             dict_
+00003aa0: 7374 6167 6520 3d20 6c6f 6164 5f70 726f  stage = load_pro
+00003ab0: 746f 636f 6c28 6f73 2e70 6174 682e 6a6f  tocol(os.path.jo
+00003ac0: 696e 2863 6667 2e43 4f4e 4649 475f 5041  in(cfg.CONFIG_PA
+00003ad0: 5448 2c20 2273 7973 7465 6d2e 7961 6d6c  TH, "system.yaml
+00003ae0: 2229 290a 2020 2020 2020 2020 2020 2020  ")).            
+00003af0: 7365 6c66 2e73 7461 6765 5f73 6574 7469  self.stage_setti
+00003b00: 6e67 7320 3d20 5374 6167 6553 6574 7469  ngs = StageSetti
+00003b10: 6e67 732e 5f5f 6672 6f6d 5f64 6963 745f  ngs.__from_dict_
+00003b20: 5f28 6469 6374 5f73 7461 6765 5b22 7379  _(dict_stage["sy
+00003b30: 7374 656d 225d 5b22 7374 6167 6522 5d29  stem"]["stage"])
+00003b40: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+00003b50: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00003b60: 7374 6167 655f 7365 7474 696e 6773 203d  stage_settings =
+00003b70: 2073 7461 6765 5f73 6574 7469 6e67 730a   stage_settings.
+00003b80: 0a20 2020 2064 6566 2064 6973 636f 6e6e  .    def disconn
+00003b90: 6563 7428 7365 6c66 293a 0a20 2020 2020  ect(self):.     
+00003ba0: 2020 2073 656c 662e 636f 6e6e 6563 7469     self.connecti
+00003bb0: 6f6e 2e64 6973 636f 6e6e 6563 7428 290a  on.disconnect().
+00003bc0: 2020 2020 2020 2020 6465 6c20 7365 6c66          del self
+00003bd0: 2e63 6f6e 6e65 6374 696f 6e0a 2020 2020  .connection.    
+00003be0: 2020 2020 7365 6c66 2e63 6f6e 6e65 6374      self.connect
+00003bf0: 696f 6e20 3d20 4e6f 6e65 0a0a 2020 2020  ion = None..    
+00003c00: 2320 4063 6c61 7373 6d65 7468 6f64 0a20  # @classmethod. 
+00003c10: 2020 2064 6566 2063 6f6e 6e65 6374 5f74     def connect_t
+00003c20: 6f5f 6d69 6372 6f73 636f 7065 2873 656c  o_microscope(sel
+00003c30: 662c 2069 705f 6164 6472 6573 733a 2073  f, ip_address: s
+00003c40: 7472 2c20 706f 7274 3a20 696e 7420 3d20  tr, port: int = 
+00003c50: 3735 3230 2920 2d3e 204e 6f6e 653a 0a20  7520) -> None:. 
+00003c60: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+00003c70: 2020 2043 6f6e 6e65 6374 2074 6f20 6120     Connect to a 
+00003c80: 5468 6572 6d6f 2046 6973 6865 7220 6d69  Thermo Fisher mi
+00003c90: 6372 6f73 636f 7065 2061 7420 7468 6520  croscope at the 
+00003ca0: 7370 6563 6966 6965 6420 4950 2061 6464  specified IP add
+00003cb0: 7265 7373 2061 6e64 2070 6f72 742e 0a0a  ress and port...
+00003cc0: 2020 2020 2020 2020 4172 6773 3a0a 2020          Args:.  
+00003cd0: 2020 2020 2020 2020 2020 6970 5f61 6464            ip_add
+00003ce0: 7265 7373 2028 7374 7229 3a20 5468 6520  ress (str): The 
+00003cf0: 4950 2061 6464 7265 7373 206f 6620 7468  IP address of th
+00003d00: 6520 6d69 6372 6f73 636f 7065 2074 6f20  e microscope to 
+00003d10: 636f 6e6e 6563 7420 746f 2e0a 2020 2020  connect to..    
+00003d20: 2020 2020 2020 2020 706f 7274 2028 696e          port (in
+00003d30: 7429 3a20 5468 6520 706f 7274 206e 756d  t): The port num
+00003d40: 6265 7220 6f66 2074 6865 206d 6963 726f  ber of the micro
+00003d50: 7363 6f70 6520 2864 6566 6175 6c74 3a20  scope (default: 
+00003d60: 3735 3230 292e 0a0a 2020 2020 2020 2020  7520)...        
+00003d70: 5265 7475 726e 733a 0a20 2020 2020 2020  Returns:.       
+00003d80: 2020 2020 204e 6f6e 653a 2054 6869 7320       None: This 
+00003d90: 6675 6e63 7469 6f6e 2064 6f65 736e 2774  function doesn't
+00003da0: 2072 6574 7572 6e20 616e 7974 6869 6e67   return anything
+00003db0: 2e0a 0a20 2020 2020 2020 2052 6169 7365  ...        Raise
+00003dc0: 733a 0a20 2020 2020 2020 2020 2020 2045  s:.            E
+00003dd0: 7863 6570 7469 6f6e 3a20 4966 2074 6865  xception: If the
+00003de0: 7265 2773 2061 6e20 6572 726f 7220 7768  re's an error wh
+00003df0: 696c 6520 636f 6e6e 6563 7469 6e67 2074  ile connecting t
+00003e00: 6f20 7468 6520 6d69 6372 6f73 636f 7065  o the microscope
+00003e10: 2e0a 0a20 2020 2020 2020 2045 7861 6d70  ...        Examp
+00003e20: 6c65 3a0a 2020 2020 2020 2020 2020 2020  le:.            
+00003e30: 546f 2063 6f6e 6e65 6374 2074 6f20 6120  To connect to a 
+00003e40: 6d69 6372 6f73 636f 7065 2077 6974 6820  microscope with 
+00003e50: 4950 2061 6464 7265 7373 2031 3932 2e31  IP address 192.1
+00003e60: 3638 2e30 2e31 3020 616e 6420 706f 7274  68.0.10 and port
+00003e70: 2037 3532 303a 0a0a 2020 2020 2020 2020   7520:..        
+00003e80: 2020 2020 3e3e 3e20 6d69 6372 6f73 636f      >>> microsco
+00003e90: 7065 203d 2054 6865 726d 6f4d 6963 726f  pe = ThermoMicro
+00003ea0: 7363 6f70 6528 290a 2020 2020 2020 2020  scope().        
+00003eb0: 2020 2020 3e3e 3e20 6d69 6372 6f73 636f      >>> microsco
+00003ec0: 7065 2e63 6f6e 6e65 6374 5f74 6f5f 6d69  pe.connect_to_mi
+00003ed0: 6372 6f73 636f 7065 2822 3139 322e 3136  croscope("192.16
+00003ee0: 382e 302e 3130 222c 2037 3532 3029 0a0a  8.0.10", 7520)..
+00003ef0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+00003f00: 2020 2020 2320 544f 444f 3a20 6765 7420      # TODO: get 
+00003f10: 7468 6520 706f 7274 0a20 2020 2020 2020  the port.       
+00003f20: 206c 6f67 6769 6e67 2e69 6e66 6f28 6622   logging.info(f"
+00003f30: 4d69 6372 6f73 636f 7065 2063 6c69 656e  Microscope clien
+00003f40: 7420 636f 6e6e 6563 7469 6e67 2074 6f20  t connecting to 
+00003f50: 5b7b 6970 5f61 6464 7265 7373 7d3a 7b70  [{ip_address}:{p
+00003f60: 6f72 747d 5d22 290a 2020 2020 2020 2020  ort}]").        
+00003f70: 7365 6c66 2e63 6f6e 6e65 6374 696f 6e2e  self.connection.
+00003f80: 636f 6e6e 6563 7428 686f 7374 3d69 705f  connect(host=ip_
+00003f90: 6164 6472 6573 732c 2070 6f72 743d 706f  address, port=po
+00003fa0: 7274 290a 2020 2020 2020 2020 6c6f 6767  rt).        logg
+00003fb0: 696e 672e 696e 666f 2866 224d 6963 726f  ing.info(f"Micro
+00003fc0: 7363 6f70 6520 636c 6965 6e74 2063 6f6e  scope client con
+00003fd0: 6e65 6374 6564 2074 6f20 5b7b 6970 5f61  nected to [{ip_a
+00003fe0: 6464 7265 7373 7d3a 7b70 6f72 747d 5d22  ddress}:{port}]"
+00003ff0: 290a 2020 2020 2020 2020 7365 6c66 2e73  ).        self.s
+00004000: 6572 6961 6c5f 6e75 6d62 6572 203d 2073  erial_number = s
+00004010: 656c 662e 636f 6e6e 6563 7469 6f6e 2e73  elf.connection.s
+00004020: 6572 7669 6365 2e73 7973 7465 6d2e 7365  ervice.system.se
+00004030: 7269 616c 5f6e 756d 6265 720a 2020 2020  rial_number.    
+00004040: 2020 2020 7365 6c66 2e6d 6f64 656c 203d      self.model =
+00004050: 2073 656c 662e 636f 6e6e 6563 7469 6f6e   self.connection
+00004060: 2e73 6572 7669 6365 2e73 7973 7465 6d2e  .service.system.
+00004070: 6e61 6d65 0a20 2020 2020 2020 2073 656c  name.        sel
+00004080: 662e 736f 6674 7761 7265 5f76 6572 7369  f.software_versi
+00004090: 6f6e 203d 2073 656c 662e 636f 6e6e 6563  on = self.connec
+000040a0: 7469 6f6e 2e73 6572 7669 6365 2e73 7973  tion.service.sys
+000040b0: 7465 6d2e 7665 7273 696f 6e0a 2020 2020  tem.version.    
+000040c0: 2020 2020 6c6f 6767 696e 672e 696e 666f      logging.info
+000040d0: 2866 224d 6963 726f 7363 6f70 6520 636c  (f"Microscope cl
+000040e0: 6965 6e74 2063 6f6e 6e65 6374 6564 2074  ient connected t
+000040f0: 6f20 6d6f 6465 6c20 7b73 656c 662e 6d6f  o model {self.mo
+00004100: 6465 6c7d 2077 6974 6820 7365 7269 616c  del} with serial
+00004110: 206e 756d 6265 7220 7b73 656c 662e 7365   number {self.se
+00004120: 7269 616c 5f6e 756d 6265 727d 2061 6e64  rial_number} and
+00004130: 2073 6f66 7477 6172 6520 7665 7273 696f   software versio
+00004140: 6e20 7b73 656c 662e 736f 6674 7761 7265  n {self.software
+00004150: 5f76 6572 7369 6f6e 7d2e 2229 0a0a 2020  _version}.")..  
+00004160: 2020 6465 6620 6163 7175 6972 655f 696d    def acquire_im
+00004170: 6167 6528 7365 6c66 2c20 696d 6167 655f  age(self, image_
+00004180: 7365 7474 696e 6773 3a49 6d61 6765 5365  settings:ImageSe
+00004190: 7474 696e 6773 2920 2d3e 2046 6962 7365  ttings) -> Fibse
+000041a0: 6d49 6d61 6765 3a0a 2020 2020 2020 2020  mImage:.        
+000041b0: 2222 220a 2020 2020 2020 2020 4163 7175  """.        Acqu
+000041c0: 6972 6520 6120 6e65 7720 696d 6167 6520  ire a new image 
+000041d0: 7769 7468 2074 6865 2073 7065 6369 6669  with the specifi
+000041e0: 6564 2073 6574 7469 6e67 732e 0a0a 2020  ed settings...  
+000041f0: 2020 2020 2020 2020 2020 4172 6773 3a0a            Args:.
+00004200: 2020 2020 2020 2020 2020 2020 696d 6167              imag
+00004210: 655f 7365 7474 696e 6773 2028 496d 6167  e_settings (Imag
+00004220: 6553 6574 7469 6e67 7329 3a20 5468 6520  eSettings): The 
+00004230: 7365 7474 696e 6773 2066 6f72 2074 6865  settings for the
+00004240: 206e 6577 2069 6d61 6765 2e0a 0a20 2020   new image...   
+00004250: 2020 2020 2052 6574 7572 6e73 3a0a 2020       Returns:.  
+00004260: 2020 2020 2020 2020 2020 4669 6273 656d            Fibsem
+00004270: 496d 6167 653a 2041 206e 6577 2046 6962  Image: A new Fib
+00004280: 7365 6d49 6d61 6765 206f 626a 6563 7420  semImage object 
+00004290: 7265 7072 6573 656e 7469 6e67 2074 6865  representing the
+000042a0: 2061 6371 7569 7265 6420 696d 6167 652e   acquired image.
+000042b0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+000042c0: 2020 2020 205f 6368 6563 6b5f 6265 616d       _check_beam
+000042d0: 2862 6561 6d5f 7479 7065 203d 2069 6d61  (beam_type = ima
+000042e0: 6765 5f73 6574 7469 6e67 732e 6265 616d  ge_settings.beam
+000042f0: 5f74 7970 652c 2068 6172 6477 6172 655f  _type, hardware_
+00004300: 7365 7474 696e 6773 203d 2073 656c 662e  settings = self.
+00004310: 6861 7264 7761 7265 5f73 6574 7469 6e67  hardware_setting
+00004320: 7329 0a20 2020 2020 2020 2023 2073 6574  s).        # set
+00004330: 2066 7261 6d65 2073 6574 7469 6e67 730a   frame settings.
+00004340: 2020 2020 2020 2020 6966 2069 6d61 6765          if image
+00004350: 5f73 6574 7469 6e67 732e 7265 6475 6365  _settings.reduce
+00004360: 645f 6172 6561 2069 7320 6e6f 7420 4e6f  d_area is not No
+00004370: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+00004380: 7265 6475 6365 645f 6172 6561 203d 2069  reduced_area = i
+00004390: 6d61 6765 5f73 6574 7469 6e67 732e 7265  mage_settings.re
+000043a0: 6475 6365 645f 6172 6561 2e5f 5f74 6f5f  duced_area.__to_
+000043b0: 4645 495f 5f28 290a 2020 2020 2020 2020  FEI__().        
+000043c0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+000043d0: 2020 7265 6475 6365 645f 6172 6561 203d    reduced_area =
+000043e0: 204e 6f6e 650a 2020 2020 2020 2020 2020   None.          
+000043f0: 2020 6966 2069 6d61 6765 5f73 6574 7469    if image_setti
+00004400: 6e67 732e 6265 616d 5f74 7970 6520 3d3d  ngs.beam_type ==
+00004410: 2042 6561 6d54 7970 652e 454c 4543 5452   BeamType.ELECTR
+00004420: 4f4e 3a0a 2020 2020 2020 2020 2020 2020  ON:.            
+00004430: 2020 2020 7365 6c66 2e63 6f6e 6e65 6374      self.connect
+00004440: 696f 6e2e 6265 616d 732e 656c 6563 7472  ion.beams.electr
+00004450: 6f6e 5f62 6561 6d2e 7363 616e 6e69 6e67  on_beam.scanning
+00004460: 2e6d 6f64 652e 7365 745f 6675 6c6c 5f66  .mode.set_full_f
+00004470: 7261 6d65 2829 0a20 2020 2020 2020 2020  rame().         
+00004480: 2020 2069 6620 696d 6167 655f 7365 7474     if image_sett
+00004490: 696e 6773 2e62 6561 6d5f 7479 7065 203d  ings.beam_type =
+000044a0: 3d20 4265 616d 5479 7065 2e49 4f4e 203a  = BeamType.ION :
+000044b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000044c0: 2073 656c 662e 636f 6e6e 6563 7469 6f6e   self.connection
+000044d0: 2e62 6561 6d73 2e69 6f6e 5f62 6561 6d2e  .beams.ion_beam.
+000044e0: 7363 616e 6e69 6e67 2e6d 6f64 652e 7365  scanning.mode.se
+000044f0: 745f 6675 6c6c 5f66 7261 6d65 2829 0a20  t_full_frame(). 
+00004500: 2020 2020 2020 200a 2020 2020 2020 2020         .        
+00004510: 6672 616d 655f 7365 7474 696e 6773 203d  frame_settings =
+00004520: 2047 7261 6246 7261 6d65 5365 7474 696e   GrabFrameSettin
+00004530: 6773 280a 2020 2020 2020 2020 2020 2020  gs(.            
+00004540: 7265 736f 6c75 7469 6f6e 3d66 227b 696d  resolution=f"{im
+00004550: 6167 655f 7365 7474 696e 6773 2e72 6573  age_settings.res
+00004560: 6f6c 7574 696f 6e5b 305d 7d78 7b69 6d61  olution[0]}x{ima
+00004570: 6765 5f73 6574 7469 6e67 732e 7265 736f  ge_settings.reso
+00004580: 6c75 7469 6f6e 5b31 5d7d 222c 0a20 2020  lution[1]}",.   
+00004590: 2020 2020 2020 2020 2064 7765 6c6c 5f74           dwell_t
+000045a0: 696d 653d 696d 6167 655f 7365 7474 696e  ime=image_settin
+000045b0: 6773 2e64 7765 6c6c 5f74 696d 652c 0a20  gs.dwell_time,. 
+000045c0: 2020 2020 2020 2020 2020 2072 6564 7563             reduc
+000045d0: 6564 5f61 7265 613d 7265 6475 6365 645f  ed_area=reduced_
+000045e0: 6172 6561 2c0a 2020 2020 2020 2020 290a  area,.        ).
+000045f0: 0a20 2020 2020 2020 2069 6620 696d 6167  .        if imag
+00004600: 655f 7365 7474 696e 6773 2e62 6561 6d5f  e_settings.beam_
+00004610: 7479 7065 203d 3d20 4265 616d 5479 7065  type == BeamType
+00004620: 2e45 4c45 4354 524f 4e3a 0a20 2020 2020  .ELECTRON:.     
+00004630: 2020 2020 2020 2068 6677 5f6c 696d 6974         hfw_limit
+00004640: 7320 3d20 280a 2020 2020 2020 2020 2020  s = (.          
+00004650: 2020 2020 2020 7365 6c66 2e63 6f6e 6e65        self.conne
+00004660: 6374 696f 6e2e 6265 616d 732e 656c 6563  ction.beams.elec
+00004670: 7472 6f6e 5f62 6561 6d2e 686f 7269 7a6f  tron_beam.horizo
+00004680: 6e74 616c 5f66 6965 6c64 5f77 6964 7468  ntal_field_width
+00004690: 2e6c 696d 6974 730a 2020 2020 2020 2020  .limits.        
+000046a0: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+000046b0: 2020 696d 6167 655f 7365 7474 696e 6773    image_settings
+000046c0: 2e68 6677 203d 206e 702e 636c 6970 280a  .hfw = np.clip(.
+000046d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000046e0: 696d 6167 655f 7365 7474 696e 6773 2e68  image_settings.h
+000046f0: 6677 2c20 6866 775f 6c69 6d69 7473 2e6d  fw, hfw_limits.m
+00004700: 696e 2c20 6866 775f 6c69 6d69 7473 2e6d  in, hfw_limits.m
+00004710: 6178 0a20 2020 2020 2020 2020 2020 2029  ax.            )
+00004720: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00004730: 662e 636f 6e6e 6563 7469 6f6e 2e62 6561  f.connection.bea
+00004740: 6d73 2e65 6c65 6374 726f 6e5f 6265 616d  ms.electron_beam
+00004750: 2e68 6f72 697a 6f6e 7461 6c5f 6669 656c  .horizontal_fiel
+00004760: 645f 7769 6474 682e 7661 6c75 6520 3d20  d_width.value = 
+00004770: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00004780: 2020 696d 6167 655f 7365 7474 696e 6773    image_settings
+00004790: 2e68 6677 0a20 2020 2020 2020 2020 2020  .hfw.           
+000047a0: 2029 0a0a 2020 2020 2020 2020 6966 2069   )..        if i
+000047b0: 6d61 6765 5f73 6574 7469 6e67 732e 6265  mage_settings.be
+000047c0: 616d 5f74 7970 6520 3d3d 2042 6561 6d54  am_type == BeamT
+000047d0: 7970 652e 494f 4e3a 0a20 2020 2020 2020  ype.ION:.       
+000047e0: 2020 2020 2068 6677 5f6c 696d 6974 7320       hfw_limits 
+000047f0: 3d20 7365 6c66 2e63 6f6e 6e65 6374 696f  = self.connectio
+00004800: 6e2e 6265 616d 732e 696f 6e5f 6265 616d  n.beams.ion_beam
+00004810: 2e68 6f72 697a 6f6e 7461 6c5f 6669 656c  .horizontal_fiel
+00004820: 645f 7769 6474 682e 6c69 6d69 7473 0a20  d_width.limits. 
+00004830: 2020 2020 2020 2020 2020 2069 6d61 6765             image
+00004840: 5f73 6574 7469 6e67 732e 6866 7720 3d20  _settings.hfw = 
+00004850: 6e70 2e63 6c69 7028 0a20 2020 2020 2020  np.clip(.       
+00004860: 2020 2020 2020 2020 2069 6d61 6765 5f73           image_s
+00004870: 6574 7469 6e67 732e 6866 772c 2068 6677  ettings.hfw, hfw
+00004880: 5f6c 696d 6974 732e 6d69 6e2c 2068 6677  _limits.min, hfw
+00004890: 5f6c 696d 6974 732e 6d61 780a 2020 2020  _limits.max.    
+000048a0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+000048b0: 2020 2020 2020 7365 6c66 2e63 6f6e 6e65        self.conne
+000048c0: 6374 696f 6e2e 6265 616d 732e 696f 6e5f  ction.beams.ion_
+000048d0: 6265 616d 2e68 6f72 697a 6f6e 7461 6c5f  beam.horizontal_
+000048e0: 6669 656c 645f 7769 6474 682e 7661 6c75  field_width.valu
+000048f0: 6520 3d20 280a 2020 2020 2020 2020 2020  e = (.          
+00004900: 2020 2020 2020 696d 6167 655f 7365 7474        image_sett
+00004910: 696e 6773 2e68 6677 0a20 2020 2020 2020  ings.hfw.       
+00004920: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
+00004930: 6c6f 6767 696e 672e 696e 666f 2866 2261  logging.info(f"a
+00004940: 6371 7569 7269 6e67 206e 6577 207b 696d  cquiring new {im
+00004950: 6167 655f 7365 7474 696e 6773 2e62 6561  age_settings.bea
+00004960: 6d5f 7479 7065 2e6e 616d 657d 2069 6d61  m_type.name} ima
+00004970: 6765 2e22 290a 2020 2020 2020 2020 7365  ge.").        se
+00004980: 6c66 2e63 6f6e 6e65 6374 696f 6e2e 696d  lf.connection.im
+00004990: 6167 696e 672e 7365 745f 6163 7469 7665  aging.set_active
+000049a0: 5f76 6965 7728 696d 6167 655f 7365 7474  _view(image_sett
+000049b0: 696e 6773 2e62 6561 6d5f 7479 7065 2e76  ings.beam_type.v
+000049c0: 616c 7565 290a 2020 2020 2020 2020 7365  alue).        se
+000049d0: 6c66 2e63 6f6e 6e65 6374 696f 6e2e 696d  lf.connection.im
+000049e0: 6167 696e 672e 7365 745f 6163 7469 7665  aging.set_active
+000049f0: 5f64 6576 6963 6528 696d 6167 655f 7365  _device(image_se
+00004a00: 7474 696e 6773 2e62 6561 6d5f 7479 7065  ttings.beam_type
+00004a10: 2e76 616c 7565 290a 2020 2020 2020 2020  .value).        
+00004a20: 696d 6167 6520 3d20 7365 6c66 2e63 6f6e  image = self.con
+00004a30: 6e65 6374 696f 6e2e 696d 6167 696e 672e  nection.imaging.
+00004a40: 6772 6162 5f66 7261 6d65 2866 7261 6d65  grab_frame(frame
+00004a50: 5f73 6574 7469 6e67 7329 0a0a 2020 2020  _settings)..    
+00004a60: 2020 2020 6966 2069 6d61 6765 5f73 6574      if image_set
+00004a70: 7469 6e67 732e 7265 6475 6365 645f 6172  tings.reduced_ar
+00004a80: 6561 2069 7320 6e6f 7420 4e6f 6e65 3a0a  ea is not None:.
+00004a90: 2020 2020 2020 2020 2020 2020 6966 2069              if i
+00004aa0: 6d61 6765 5f73 6574 7469 6e67 732e 6265  mage_settings.be
+00004ab0: 616d 5f74 7970 6520 3d3d 2042 6561 6d54  am_type == BeamT
+00004ac0: 7970 652e 454c 4543 5452 4f4e 3a0a 2020  ype.ELECTRON:.  
+00004ad0: 2020 2020 2020 2020 2020 2020 2020 7365                se
+00004ae0: 6c66 2e63 6f6e 6e65 6374 696f 6e2e 6265  lf.connection.be
+00004af0: 616d 732e 656c 6563 7472 6f6e 5f62 6561  ams.electron_bea
+00004b00: 6d2e 7363 616e 6e69 6e67 2e6d 6f64 652e  m.scanning.mode.
+00004b10: 7365 745f 6675 6c6c 5f66 7261 6d65 2829  set_full_frame()
+00004b20: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
+00004b30: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00004b40: 2020 2073 656c 662e 636f 6e6e 6563 7469     self.connecti
+00004b50: 6f6e 2e62 6561 6d73 2e69 6f6e 5f62 6561  on.beams.ion_bea
+00004b60: 6d2e 7363 616e 6e69 6e67 2e6d 6f64 652e  m.scanning.mode.
+00004b70: 7365 745f 6675 6c6c 5f66 7261 6d65 2829  set_full_frame()
+00004b80: 0a0a 2020 2020 2020 2020 7374 6174 6520  ..        state 
+00004b90: 3d20 7365 6c66 2e67 6574 5f63 7572 7265  = self.get_curre
+00004ba0: 6e74 5f6d 6963 726f 7363 6f70 655f 7374  nt_microscope_st
+00004bb0: 6174 6528 290a 0a20 2020 2020 2020 2064  ate()..        d
+00004bc0: 6574 6563 746f 7220 3d20 4669 6273 656d  etector = Fibsem
+00004bd0: 4465 7465 6374 6f72 5365 7474 696e 6773  DetectorSettings
+00004be0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00004bf0: 2020 7479 7065 203d 2073 656c 662e 6765    type = self.ge
+00004c00: 7428 2264 6574 6563 746f 725f 7479 7065  t("detector_type
+00004c10: 222c 2069 6d61 6765 5f73 6574 7469 6e67  ", image_setting
+00004c20: 732e 6265 616d 5f74 7970 6529 2c0a 2020  s.beam_type),.  
+00004c30: 2020 2020 2020 2020 2020 2020 2020 6d6f                mo
+00004c40: 6465 203d 2073 656c 662e 6765 7428 2264  de = self.get("d
+00004c50: 6574 6563 746f 725f 6d6f 6465 222c 2069  etector_mode", i
+00004c60: 6d61 6765 5f73 6574 7469 6e67 732e 6265  mage_settings.be
+00004c70: 616d 5f74 7970 6529 2c0a 2020 2020 2020  am_type),.      
+00004c80: 2020 2020 2020 2020 2020 636f 6e74 7261            contra
+00004c90: 7374 203d 2073 656c 662e 6765 7428 2264  st = self.get("d
+00004ca0: 6574 6563 746f 725f 636f 6e74 7261 7374  etector_contrast
+00004cb0: 222c 2069 6d61 6765 5f73 6574 7469 6e67  ", image_setting
+00004cc0: 732e 6265 616d 5f74 7970 6529 2c0a 2020  s.beam_type),.  
+00004cd0: 2020 2020 2020 2020 2020 2020 2020 6272                br
+00004ce0: 6967 6874 6e65 7373 3d20 7365 6c66 2e67  ightness= self.g
+00004cf0: 6574 2822 6465 7465 6374 6f72 5f62 7269  et("detector_bri
+00004d00: 6768 746e 6573 7322 2c20 696d 6167 655f  ghtness", image_
+00004d10: 7365 7474 696e 6773 2e62 6561 6d5f 7479  settings.beam_ty
+00004d20: 7065 292c 0a0a 2020 2020 2020 2020 2020  pe),..          
+00004d30: 2020 290a 0a20 2020 2020 2020 2066 6962    )..        fib
+00004d40: 7365 6d5f 696d 6167 6520 3d20 4669 6273  sem_image = Fibs
+00004d50: 656d 496d 6167 652e 6672 6f6d 4164 6f72  emImage.fromAdor
+00004d60: 6e65 6449 6d61 6765 280a 2020 2020 2020  nedImage(.      
+00004d70: 2020 2020 2020 636f 7079 2e64 6565 7063        copy.deepc
+00004d80: 6f70 7928 696d 6167 6529 2c20 636f 7079  opy(image), copy
+00004d90: 2e64 6565 7063 6f70 7928 696d 6167 655f  .deepcopy(image_
+00004da0: 7365 7474 696e 6773 292c 2063 6f70 792e  settings), copy.
+00004db0: 6465 6570 636f 7079 2873 7461 7465 292c  deepcopy(state),
+00004dc0: 2064 6574 6563 746f 7220 3d20 6465 7465   detector = dete
+00004dd0: 6374 6f72 0a20 2020 2020 2020 2029 0a0a  ctor.        )..
+00004de0: 2020 2020 2020 2020 7265 7475 726e 2066          return f
+00004df0: 6962 7365 6d5f 696d 6167 650a 0a20 2020  ibsem_image..   
+00004e00: 2064 6566 206c 6173 745f 696d 6167 6528   def last_image(
+00004e10: 7365 6c66 2c20 6265 616d 5f74 7970 653a  self, beam_type:
+00004e20: 2042 6561 6d54 7970 6520 3d20 4265 616d   BeamType = Beam
+00004e30: 5479 7065 2e45 4c45 4354 524f 4e29 202d  Type.ELECTRON) -
+00004e40: 3e20 4669 6273 656d 496d 6167 653a 0a20  > FibsemImage:. 
+00004e50: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+00004e60: 2020 2047 6574 2074 6865 206c 6173 7420     Get the last 
+00004e70: 7072 6576 696f 7573 6c79 2061 6371 7569  previously acqui
+00004e80: 7265 6420 696d 6167 652e 0a0a 2020 2020  red image...    
+00004e90: 2020 2020 4172 6773 3a0a 2020 2020 2020      Args:.      
+00004ea0: 2020 2020 2020 6265 616d 5f74 7970 6520        beam_type 
+00004eb0: 2842 6561 6d54 7970 652c 206f 7074 696f  (BeamType, optio
+00004ec0: 6e61 6c29 3a20 5468 6520 696d 6167 696e  nal): The imagin
+00004ed0: 6720 6265 616d 2074 7970 6520 6f66 2074  g beam type of t
+00004ee0: 6865 206c 6173 7420 696d 6167 652e 0a20  he last image.. 
+00004ef0: 2020 2020 2020 2020 2020 2020 2020 2044                 D
+00004f00: 6566 6175 6c74 7320 746f 2042 6561 6d54  efaults to BeamT
+00004f10: 7970 652e 454c 4543 5452 4f4e 2e0a 0a20  ype.ELECTRON... 
+00004f20: 2020 2020 2020 2052 6574 7572 6e73 3a0a         Returns:.
+00004f30: 2020 2020 2020 2020 2020 2020 4669 6273              Fibs
+00004f40: 656d 496d 6167 653a 2041 206e 6577 2046  emImage: A new F
+00004f50: 6962 7365 6d49 6d61 6765 206f 626a 6563  ibsemImage objec
+00004f60: 7420 7265 7072 6573 656e 7469 6e67 2074  t representing t
+00004f70: 6865 206c 6173 7420 6163 7175 6972 6564  he last acquired
+00004f80: 2069 6d61 6765 2e0a 0a20 2020 2020 2020   image...       
+00004f90: 2052 6169 7365 733a 0a20 2020 2020 2020   Raises:.       
+00004fa0: 2020 2020 2045 7863 6570 7469 6f6e 3a20       Exception: 
+00004fb0: 4966 2074 6865 7265 2773 2061 6e20 6572  If there's an er
+00004fc0: 726f 7220 7768 696c 6520 6765 7474 696e  ror while gettin
+00004fd0: 6720 7468 6520 6c61 7374 2069 6d61 6765  g the last image
+00004fe0: 2e0a 2020 2020 2020 2020 2222 220a 2020  ..        """.  
+00004ff0: 2020 2020 2020 5f63 6865 636b 5f62 6561        _check_bea
+00005000: 6d28 6265 616d 5f74 7970 6520 3d20 6265  m(beam_type = be
+00005010: 616d 5f74 7970 652c 2068 6172 6477 6172  am_type, hardwar
+00005020: 655f 7365 7474 696e 6773 203d 2073 656c  e_settings = sel
+00005030: 662e 6861 7264 7761 7265 5f73 6574 7469  f.hardware_setti
+00005040: 6e67 7329 2020 2020 2020 2020 0a20 2020  ngs)        .   
+00005050: 2020 2020 2073 656c 662e 636f 6e6e 6563       self.connec
+00005060: 7469 6f6e 2e69 6d61 6769 6e67 2e73 6574  tion.imaging.set
+00005070: 5f61 6374 6976 655f 7669 6577 2862 6561  _active_view(bea
+00005080: 6d5f 7479 7065 2e76 616c 7565 290a 2020  m_type.value).  
+00005090: 2020 2020 2020 7365 6c66 2e63 6f6e 6e65        self.conne
+000050a0: 6374 696f 6e2e 696d 6167 696e 672e 7365  ction.imaging.se
+000050b0: 745f 6163 7469 7665 5f64 6576 6963 6528  t_active_device(
+000050c0: 6265 616d 5f74 7970 652e 7661 6c75 6529  beam_type.value)
+000050d0: 0a20 2020 2020 2020 2069 6d61 6765 203d  .        image =
+000050e0: 2073 656c 662e 636f 6e6e 6563 7469 6f6e   self.connection
+000050f0: 2e69 6d61 6769 6e67 2e67 6574 5f69 6d61  .imaging.get_ima
+00005100: 6765 2829 0a0a 2020 2020 2020 2020 6672  ge()..        fr
+00005110: 6f6d 2061 7574 6f73 6372 6970 745f 7364  om autoscript_sd
+00005120: 625f 6d69 6372 6f73 636f 7065 5f63 6c69  b_microscope_cli
+00005130: 656e 742e 7374 7275 6374 7572 6573 2069  ent.structures i
+00005140: 6d70 6f72 7420 4164 6f72 6e65 6449 6d61  mport AdornedIma
+00005150: 6765 0a20 2020 2020 2020 2069 6d61 6765  ge.        image
+00005160: 203d 2041 646f 726e 6564 496d 6167 6528   = AdornedImage(
+00005170: 6461 7461 3d69 6d61 6765 2e64 6174 612e  data=image.data.
+00005180: 6173 7479 7065 286e 702e 7569 6e74 3829  astype(np.uint8)
+00005190: 2c20 6d65 7461 6461 7461 3d69 6d61 6765  , metadata=image
+000051a0: 2e6d 6574 6164 6174 6129 0a0a 2020 2020  .metadata)..    
+000051b0: 2020 2020 7374 6174 6520 3d20 7365 6c66      state = self
+000051c0: 2e67 6574 5f63 7572 7265 6e74 5f6d 6963  .get_current_mic
+000051d0: 726f 7363 6f70 655f 7374 6174 6528 290a  roscope_state().
+000051e0: 0a20 2020 2020 2020 2069 6d61 6765 5f73  .        image_s
+000051f0: 6574 7469 6e67 7320 3d20 4669 6273 656d  ettings = Fibsem
+00005200: 496d 6167 654d 6574 6164 6174 612e 696d  ImageMetadata.im
+00005210: 6167 655f 7365 7474 696e 6773 5f66 726f  age_settings_fro
+00005220: 6d5f 6164 6f72 6e65 6428 0a20 2020 2020  m_adorned(.     
+00005230: 2020 2020 2020 2069 6d61 6765 2c20 6265         image, be
+00005240: 616d 5f74 7970 650a 2020 2020 2020 2020  am_type.        
+00005250: 290a 0a20 2020 2020 2020 2064 6574 6563  )..        detec
+00005260: 746f 7220 3d20 4669 6273 656d 4465 7465  tor = FibsemDete
+00005270: 6374 6f72 5365 7474 696e 6773 280a 2020  ctorSettings(.  
+00005280: 2020 2020 2020 2020 2020 2020 2020 7479                ty
+00005290: 7065 203d 2073 656c 662e 6765 7428 2264  pe = self.get("d
+000052a0: 6574 6563 746f 725f 7479 7065 222c 2062  etector_type", b
+000052b0: 6561 6d5f 7479 7065 292c 0a20 2020 2020  eam_type),.     
+000052c0: 2020 2020 2020 2020 2020 206d 6f64 6520             mode 
+000052d0: 3d20 7365 6c66 2e67 6574 2822 6465 7465  = self.get("dete
+000052e0: 6374 6f72 5f6d 6f64 6522 2c20 6265 616d  ctor_mode", beam
+000052f0: 5f74 7970 6529 2c0a 2020 2020 2020 2020  _type),.        
+00005300: 2020 2020 2020 2020 636f 6e74 7261 7374          contrast
+00005310: 203d 2073 656c 662e 6765 7428 2264 6574   = self.get("det
+00005320: 6563 746f 725f 636f 6e74 7261 7374 222c  ector_contrast",
+00005330: 2062 6561 6d5f 7479 7065 292c 0a20 2020   beam_type),.   
+00005340: 2020 2020 2020 2020 2020 2020 2062 7269               bri
+00005350: 6768 746e 6573 733d 2073 656c 662e 6765  ghtness= self.ge
+00005360: 7428 2264 6574 6563 746f 725f 6272 6967  t("detector_brig
+00005370: 6874 6e65 7373 222c 2062 6561 6d5f 7479  htness", beam_ty
+00005380: 7065 292c 0a0a 2020 2020 2020 2020 2020  pe),..          
+00005390: 2020 290a 0a20 2020 2020 2020 2066 6962    )..        fib
+000053a0: 7365 6d5f 696d 6167 6520 3d20 4669 6273  sem_image = Fibs
+000053b0: 656d 496d 6167 652e 6672 6f6d 4164 6f72  emImage.fromAdor
+000053c0: 6e65 6449 6d61 6765 2869 6d61 6765 2c20  nedImage(image, 
+000053d0: 696d 6167 655f 7365 7474 696e 6773 2c20  image_settings, 
+000053e0: 7374 6174 652c 2064 6574 6563 746f 7220  state, detector 
+000053f0: 3d20 6465 7465 6374 6f72 2920 0a0a 2020  = detector) ..  
+00005400: 2020 2020 2020 7265 7475 726e 2066 6962        return fib
+00005410: 7365 6d5f 696d 6167 650a 0a20 2020 2064  sem_image..    d
+00005420: 6566 2061 7574 6f63 6f6e 7472 6173 7428  ef autocontrast(
+00005430: 7365 6c66 2c20 6265 616d 5f74 7970 653d  self, beam_type=
+00005440: 4265 616d 5479 7065 2e45 4c45 4354 524f  BeamType.ELECTRO
+00005450: 4e29 202d 3e20 4e6f 6e65 3a0a 2020 2020  N) -> None:.    
+00005460: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+00005470: 4175 746f 6d61 7469 6361 6c6c 7920 6164  Automatically ad
+00005480: 6a75 7374 2074 6865 206d 6963 726f 7363  just the microsc
+00005490: 6f70 6520 696d 6167 6520 636f 6e74 7261  ope image contra
+000054a0: 7374 2066 6f72 2074 6865 2073 7065 6369  st for the speci
+000054b0: 6669 6564 2062 6561 6d20 7479 7065 2e0a  fied beam type..
+000054c0: 0a20 2020 2020 2020 2041 7267 733a 0a20  .        Args:. 
+000054d0: 2020 2020 2020 2020 2020 2062 6561 6d5f             beam_
+000054e0: 7479 7065 2028 4265 616d 5479 7065 2c20  type (BeamType, 
+000054f0: 6f70 7469 6f6e 616c 293a 2054 6865 2069  optional): The i
+00005500: 6d61 6769 6e67 2062 6561 6d20 7479 7065  maging beam type
+00005510: 2066 6f72 2077 6869 6368 2074 6f20 6164   for which to ad
+00005520: 6a75 7374 2074 6865 2063 6f6e 7472 6173  just the contras
+00005530: 742e 0a20 2020 2020 2020 2020 2020 2020  t..             
+00005540: 2020 2044 6566 6175 6c74 7320 746f 2042     Defaults to B
+00005550: 6561 6d54 7970 652e 454c 4543 5452 4f4e  eamType.ELECTRON
+00005560: 2e0a 0a20 2020 2020 2020 2052 6574 7572  ...        Retur
+00005570: 6e73 3a0a 2020 2020 2020 2020 2020 2020  ns:.            
+00005580: 4e6f 6e65 0a0a 2020 2020 2020 2020 4578  None..        Ex
+00005590: 616d 706c 653a 0a20 2020 2020 2020 2020  ample:.         
+000055a0: 2020 2054 6f20 6175 746f 6d61 7469 6361     To automatica
+000055b0: 6c6c 7920 6164 6a75 7374 2074 6865 2069  lly adjust the i
+000055c0: 6d61 6765 2063 6f6e 7472 6173 7420 666f  mage contrast fo
+000055d0: 7220 616e 2069 6f6e 2062 6561 6d20 7479  r an ion beam ty
+000055e0: 7065 3a0a 0a20 2020 2020 2020 2020 2020  pe:..           
+000055f0: 203e 3e3e 206d 6963 726f 7363 6f70 6520   >>> microscope 
+00005600: 3d20 5468 6572 6d6f 4d69 6372 6f73 636f  = ThermoMicrosco
+00005610: 7065 2829 0a20 2020 2020 2020 2020 2020  pe().           
+00005620: 203e 3e3e 206d 6963 726f 7363 6f70 652e   >>> microscope.
+00005630: 636f 6e6e 6563 745f 746f 5f6d 6963 726f  connect_to_micro
+00005640: 7363 6f70 6528 290a 2020 2020 2020 2020  scope().        
+00005650: 2020 2020 3e3e 3e20 6d69 6372 6f73 636f      >>> microsco
+00005660: 7065 2e61 7574 6f63 6f6e 7472 6173 7428  pe.autocontrast(
+00005670: 6265 616d 5f74 7970 653d 4265 616d 5479  beam_type=BeamTy
+00005680: 7065 2e49 4f4e 290a 0a20 2020 2020 2020  pe.ION)..       
+00005690: 2022 2222 0a20 2020 2020 2020 205f 6368   """.        _ch
+000056a0: 6563 6b5f 6265 616d 2862 6561 6d5f 7479  eck_beam(beam_ty
+000056b0: 7065 203d 2062 6561 6d5f 7479 7065 2c20  pe = beam_type, 
+000056c0: 6861 7264 7761 7265 5f73 6574 7469 6e67  hardware_setting
+000056d0: 7320 3d20 7365 6c66 2e68 6172 6477 6172  s = self.hardwar
+000056e0: 655f 7365 7474 696e 6773 290a 2020 2020  e_settings).    
+000056f0: 2020 2020 6c6f 6767 696e 672e 696e 666f      logging.info
+00005700: 2866 2252 756e 6e69 6e67 2061 7574 6f63  (f"Running autoc
+00005710: 6f6e 7472 6173 7420 6f6e 207b 6265 616d  ontrast on {beam
+00005720: 5f74 7970 652e 6e61 6d65 7d2e 2229 0a20  _type.name}."). 
+00005730: 2020 2020 2020 2073 656c 662e 636f 6e6e         self.conn
+00005740: 6563 7469 6f6e 2e69 6d61 6769 6e67 2e73  ection.imaging.s
+00005750: 6574 5f61 6374 6976 655f 7669 6577 2862  et_active_view(b
+00005760: 6561 6d5f 7479 7065 2e76 616c 7565 290a  eam_type.value).
+00005770: 2020 2020 2020 2020 7365 6c66 2e63 6f6e          self.con
+00005780: 6e65 6374 696f 6e2e 696d 6167 696e 672e  nection.imaging.
+00005790: 7365 745f 6163 7469 7665 5f64 6576 6963  set_active_devic
+000057a0: 6528 6265 616d 5f74 7970 652e 7661 6c75  e(beam_type.valu
+000057b0: 6529 0a20 2020 2020 2020 2073 656c 662e  e).        self.
+000057c0: 636f 6e6e 6563 7469 6f6e 2e61 7574 6f5f  connection.auto_
+000057d0: 6675 6e63 7469 6f6e 732e 7275 6e5f 6175  functions.run_au
+000057e0: 746f 5f63 6228 290a 0a20 2020 2064 6566  to_cb()..    def
+000057f0: 2061 7574 6f5f 666f 6375 7328 7365 6c66   auto_focus(self
+00005800: 2c20 6265 616d 5f74 7970 653a 2042 6561  , beam_type: Bea
+00005810: 6d54 7970 6529 202d 3e20 4e6f 6e65 3a0a  mType) -> None:.
+00005820: 2020 2020 2020 2020 2222 2241 7574 6f6d          """Autom
+00005830: 6174 6963 616c 6c79 2066 6f63 7573 2074  atically focus t
+00005840: 6865 2073 7065 6369 6669 6564 2062 6561  he specified bea
+00005850: 6d20 7479 7065 2e0a 0a20 2020 2020 2020  m type...       
+00005860: 2041 7267 733a 0a20 2020 2020 2020 2020   Args:.         
+00005870: 2020 2062 6561 6d5f 7479 7065 2028 4265     beam_type (Be
+00005880: 616d 5479 7065 293a 2054 6865 2069 6d61  amType): The ima
+00005890: 6769 6e67 2062 6561 6d20 7479 7065 2066  ging beam type f
+000058a0: 6f72 2077 6869 6368 2074 6f20 666f 6375  or which to focu
+000058b0: 732e 0a20 2020 2020 2020 2022 2222 0a20  s..        """. 
+000058c0: 2020 2020 2020 205f 6368 6563 6b5f 6265         _check_be
+000058d0: 616d 2862 6561 6d5f 7479 7065 203d 2062  am(beam_type = b
+000058e0: 6561 6d5f 7479 7065 2c20 6861 7264 7761  eam_type, hardwa
+000058f0: 7265 5f73 6574 7469 6e67 7320 3d20 7365  re_settings = se
+00005900: 6c66 2e68 6172 6477 6172 655f 7365 7474  lf.hardware_sett
+00005910: 696e 6773 290a 2020 2020 2020 2020 6c6f  ings).        lo
+00005920: 6767 696e 672e 696e 666f 2866 2252 756e  gging.info(f"Run
+00005930: 6e69 6e67 2061 7574 6f2d 666f 6375 7320  ning auto-focus 
+00005940: 6f6e 207b 6265 616d 5f74 7970 652e 6e61  on {beam_type.na
+00005950: 6d65 7d2e 2229 0a20 2020 2020 2020 2073  me}.").        s
+00005960: 656c 662e 636f 6e6e 6563 7469 6f6e 2e69  elf.connection.i
+00005970: 6d61 6769 6e67 2e73 6574 5f61 6374 6976  maging.set_activ
+00005980: 655f 7669 6577 2862 6561 6d5f 7479 7065  e_view(beam_type
+00005990: 2e76 616c 7565 2920 200a 2020 2020 2020  .value)  .      
+000059a0: 2020 7365 6c66 2e63 6f6e 6e65 6374 696f    self.connectio
+000059b0: 6e2e 696d 6167 696e 672e 7365 745f 6163  n.imaging.set_ac
+000059c0: 7469 7665 5f64 6576 6963 6528 6265 616d  tive_device(beam
+000059d0: 5f74 7970 652e 7661 6c75 6529 0a20 2020  _type.value).   
+000059e0: 2020 2020 2073 656c 662e 636f 6e6e 6563       self.connec
+000059f0: 7469 6f6e 2e61 7574 6f5f 6675 6e63 7469  tion.auto_functi
+00005a00: 6f6e 732e 7275 6e5f 6175 746f 5f66 6f63  ons.run_auto_foc
+00005a10: 7573 2829 0a0a 2020 2020 6465 6620 7265  us()..    def re
+00005a20: 7365 745f 6265 616d 5f73 6869 6674 7328  set_beam_shifts(
+00005a30: 7365 6c66 2920 2d3e 204e 6f6e 653a 0a20  self) -> None:. 
+00005a40: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+00005a50: 2020 2053 6574 2074 6865 2062 6561 6d20     Set the beam 
+00005a60: 7368 6966 7420 746f 207a 6572 6f20 666f  shift to zero fo
+00005a70: 7220 7468 6520 656c 6563 7472 6f6e 2061  r the electron a
+00005a80: 6e64 2069 6f6e 2062 6561 6d73 2e0a 0a20  nd ion beams... 
+00005a90: 2020 2020 2020 2052 6573 6574 7320 7468         Resets th
+00005aa0: 6520 6265 616d 2073 6869 6674 2066 6f72  e beam shift for
+00005ab0: 2062 6f74 6820 7468 6520 656c 6563 7472   both the electr
+00005ac0: 6f6e 2061 6e64 2069 6f6e 2062 6561 6d73  on and ion beams
+00005ad0: 2074 6f20 2830 2c30 292c 2065 6666 6563   to (0,0), effec
+00005ae0: 7469 7665 6c79 2063 656e 7465 7269 6e67  tively centering
+00005af0: 2074 6865 2062 6561 6d73 206f 6e20 7468   the beams on th
+00005b00: 6520 7361 6d70 6c65 2e0a 0a20 2020 2020  e sample...     
+00005b10: 2020 2041 7267 733a 0a20 2020 2020 2020     Args:.       
+00005b20: 2020 2020 2073 656c 6620 2846 6962 7365       self (Fibse
+00005b30: 6d4d 6963 726f 7363 6f70 6529 3a20 696e  mMicroscope): in
+00005b40: 7374 616e 6365 206f 6620 7468 6520 4669  stance of the Fi
+00005b50: 6273 656d 4d69 6372 6f73 636f 7065 206f  bsemMicroscope o
+00005b60: 626a 6563 740a 2020 2020 2020 2020 2222  bject.        ""
+00005b70: 220a 2020 2020 2020 2020 6672 6f6d 2061  ".        from a
+00005b80: 7574 6f73 6372 6970 745f 7364 625f 6d69  utoscript_sdb_mi
+00005b90: 6372 6f73 636f 7065 5f63 6c69 656e 742e  croscope_client.
+00005ba0: 7374 7275 6374 7572 6573 2069 6d70 6f72  structures impor
+00005bb0: 7420 506f 696e 7420 6173 2054 6865 726d  t Point as Therm
+00005bc0: 6f50 6f69 6e74 0a20 2020 2020 2020 205f  oPoint.        _
+00005bd0: 6368 6563 6b5f 6265 616d 2862 6561 6d5f  check_beam(beam_
+00005be0: 7479 7065 203d 2042 6561 6d54 7970 652e  type = BeamType.
+00005bf0: 454c 4543 5452 4f4e 2c20 6861 7264 7761  ELECTRON, hardwa
+00005c00: 7265 5f73 6574 7469 6e67 7320 3d20 7365  re_settings = se
+00005c10: 6c66 2e68 6172 6477 6172 655f 7365 7474  lf.hardware_sett
+00005c20: 696e 6773 290a 2020 2020 2020 2020 2320  ings).        # 
+00005c30: 7265 7365 7420 7a65 726f 2062 6561 6d73  reset zero beams
+00005c40: 6869 6674 0a20 2020 2020 2020 206c 6f67  hift.        log
+00005c50: 6769 6e67 2e64 6562 7567 280a 2020 2020  ging.debug(.    
+00005c60: 2020 2020 2020 2020 6622 7265 7365 7469          f"reseti
+00005c70: 6e67 2065 6265 616d 2073 6869 6674 2074  ng ebeam shift t
+00005c80: 6f20 2830 2c20 3029 2066 726f 6d3a 207b  o (0, 0) from: {
+00005c90: 7365 6c66 2e63 6f6e 6e65 6374 696f 6e2e  self.connection.
+00005ca0: 6265 616d 732e 656c 6563 7472 6f6e 5f62  beams.electron_b
+00005cb0: 6561 6d2e 6265 616d 5f73 6869 6674 2e76  eam.beam_shift.v
+00005cc0: 616c 7565 7d22 0a20 2020 2020 2020 2029  alue}".        )
+00005cd0: 0a20 2020 2020 2020 2073 656c 662e 636f  .        self.co
+00005ce0: 6e6e 6563 7469 6f6e 2e62 6561 6d73 2e65  nnection.beams.e
+00005cf0: 6c65 6374 726f 6e5f 6265 616d 2e62 6561  lectron_beam.bea
+00005d00: 6d5f 7368 6966 742e 7661 6c75 6520 3d20  m_shift.value = 
+00005d10: 5468 6572 6d6f 506f 696e 7428 302c 2030  ThermoPoint(0, 0
+00005d20: 290a 2020 2020 2020 2020 5f63 6865 636b  ).        _check
+00005d30: 5f62 6561 6d28 6265 616d 5f74 7970 6520  _beam(beam_type 
+00005d40: 3d20 4265 616d 5479 7065 2e49 4f4e 2c20  = BeamType.ION, 
+00005d50: 6861 7264 7761 7265 5f73 6574 7469 6e67  hardware_setting
+00005d60: 7320 3d20 7365 6c66 2e68 6172 6477 6172  s = self.hardwar
+00005d70: 655f 7365 7474 696e 6773 290a 2020 2020  e_settings).    
+00005d80: 2020 2020 6c6f 6767 696e 672e 6465 6275      logging.debu
+00005d90: 6728 0a20 2020 2020 2020 2020 2020 2066  g(.            f
+00005da0: 2272 6573 6574 696e 6720 6962 6561 6d20  "reseting ibeam 
+00005db0: 7368 6966 7420 746f 2028 302c 2030 2920  shift to (0, 0) 
+00005dc0: 6672 6f6d 3a20 7b73 656c 662e 636f 6e6e  from: {self.conn
+00005dd0: 6563 7469 6f6e 2e62 6561 6d73 2e65 6c65  ection.beams.ele
+00005de0: 6374 726f 6e5f 6265 616d 2e62 6561 6d5f  ctron_beam.beam_
+00005df0: 7368 6966 742e 7661 6c75 657d 220a 2020  shift.value}".  
+00005e00: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00005e10: 7365 6c66 2e63 6f6e 6e65 6374 696f 6e2e  self.connection.
+00005e20: 6265 616d 732e 696f 6e5f 6265 616d 2e62  beams.ion_beam.b
+00005e30: 6561 6d5f 7368 6966 742e 7661 6c75 6520  eam_shift.value 
+00005e40: 3d20 5468 6572 6d6f 506f 696e 7428 302c  = ThermoPoint(0,
+00005e50: 2030 290a 2020 2020 2020 2020 6c6f 6767   0).        logg
+00005e60: 696e 672e 6465 6275 6728 6622 7265 7365  ing.debug(f"rese
+00005e70: 7420 6265 616d 2073 6869 6674 7320 746f  t beam shifts to
+00005e80: 207a 6572 6f20 636f 6d70 6c65 7465 2229   zero complete")
+00005e90: 0a0a 2020 2020 6465 6620 6265 616d 5f73  ..    def beam_s
+00005ea0: 6869 6674 2873 656c 662c 2064 783a 2066  hift(self, dx: f
+00005eb0: 6c6f 6174 2c20 6479 3a20 666c 6f61 742c  loat, dy: float,
+00005ec0: 2062 6561 6d5f 7479 7065 3a20 4265 616d   beam_type: Beam
+00005ed0: 5479 7065 203d 2042 6561 6d54 7970 652e  Type = BeamType.
+00005ee0: 494f 4e29 202d 3e20 4e6f 6e65 3a0a 2020  ION) -> None:.  
+00005ef0: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+00005f00: 2020 4164 6a75 7374 7320 7468 6520 6265    Adjusts the be
+00005f10: 616d 2073 6869 6674 2062 6173 6564 206f  am shift based o
+00005f20: 6e20 7265 6c61 7469 7665 2076 616c 7565  n relative value
+00005f30: 7320 7468 6174 2061 7265 2070 726f 7669  s that are provi
+00005f40: 6465 642e 0a20 2020 2020 2020 200a 2020  ded..        .  
+00005f50: 2020 2020 2020 4172 6773 3a0a 2020 2020        Args:.    
+00005f60: 2020 2020 2020 2020 7365 6c66 2028 4669          self (Fi
+00005f70: 6273 656d 4d69 6372 6f73 636f 7065 293a  bsemMicroscope):
+00005f80: 2046 6962 7365 6d20 6d69 6372 6f73 636f   Fibsem microsco
+00005f90: 7065 206f 626a 6563 740a 2020 2020 2020  pe object.      
+00005fa0: 2020 2020 2020 6478 2028 666c 6f61 7429        dx (float)
+00005fb0: 3a20 7468 6520 7265 6c61 7469 7665 2078  : the relative x
+00005fc0: 2074 6572 6d0a 2020 2020 2020 2020 2020   term.          
+00005fd0: 2020 6479 2028 666c 6f61 7429 3a20 7468    dy (float): th
+00005fe0: 6520 7265 6c61 7469 7665 2079 2074 6572  e relative y ter
+00005ff0: 6d0a 2020 2020 2020 2020 2222 220a 2020  m.        """.  
+00006000: 2020 2020 2020 5f63 6865 636b 5f62 6561        _check_bea
+00006010: 6d28 6265 616d 5f74 7970 6520 3d20 6265  m(beam_type = be
+00006020: 616d 5f74 7970 652c 2068 6172 6477 6172  am_type, hardwar
+00006030: 655f 7365 7474 696e 6773 203d 2073 656c  e_settings = sel
+00006040: 662e 6861 7264 7761 7265 5f73 6574 7469  f.hardware_setti
+00006050: 6e67 7329 0a20 2020 2020 2020 206c 6f67  ngs).        log
+00006060: 6769 6e67 2e69 6e66 6f28 6622 7b62 6561  ging.info(f"{bea
+00006070: 6d5f 7479 7065 2e6e 616d 657d 2073 6869  m_type.name} shi
+00006080: 6674 696e 6720 6279 2028 7b64 787d 2c20  fting by ({dx}, 
+00006090: 7b64 797d 2922 290a 2020 2020 2020 2020  {dy})").        
+000060a0: 6c6f 6767 696e 672e 6465 6275 6728 6622  logging.debug(f"
+000060b0: 7b62 6561 6d5f 7479 7065 2e6e 616d 657d  {beam_type.name}
+000060c0: 207c 207b 6478 7d7c 7b64 797d 2229 200a   | {dx}|{dy}") .
+000060d0: 2020 2020 2020 2020 6966 2062 6561 6d5f          if beam_
+000060e0: 7479 7065 203d 3d20 4265 616d 5479 7065  type == BeamType
+000060f0: 2e45 4c45 4354 524f 4e3a 0a20 2020 2020  .ELECTRON:.     
+00006100: 2020 2020 2020 2073 656c 662e 636f 6e6e         self.conn
+00006110: 6563 7469 6f6e 2e62 6561 6d73 2e65 6c65  ection.beams.ele
+00006120: 6374 726f 6e5f 6265 616d 2e62 6561 6d5f  ctron_beam.beam_
+00006130: 7368 6966 742e 7661 6c75 6520 2b3d 2028  shift.value += (
+00006140: 2d64 782c 2064 7929 0a20 2020 2020 2020  -dx, dy).       
+00006150: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00006160: 2020 2073 656c 662e 636f 6e6e 6563 7469     self.connecti
+00006170: 6f6e 2e62 6561 6d73 2e69 6f6e 5f62 6561  on.beams.ion_bea
+00006180: 6d2e 6265 616d 5f73 6869 6674 2e76 616c  m.beam_shift.val
+00006190: 7565 202b 3d20 282d 6478 2c20 6479 290a  ue += (-dx, dy).
+000061a0: 0a20 2020 2064 6566 2067 6574 5f73 7461  .    def get_sta
+000061b0: 6765 5f70 6f73 6974 696f 6e28 7365 6c66  ge_position(self
+000061c0: 2920 2d3e 2046 6962 7365 6d53 7461 6765  ) -> FibsemStage
+000061d0: 506f 7369 7469 6f6e 3a0a 2020 2020 2020  Position:.      
+000061e0: 2020 2222 220a 2020 2020 2020 2020 4765    """.        Ge
+000061f0: 7420 7468 6520 6375 7272 656e 7420 7374  t the current st
+00006200: 6167 6520 706f 7369 7469 6f6e 2e0a 0a20  age position... 
+00006210: 2020 2020 2020 2054 6869 7320 6d65 7468         This meth
+00006220: 6f64 2072 6574 7269 6576 6573 2074 6865  od retrieves the
+00006230: 2063 7572 7265 6e74 2073 7461 6765 2070   current stage p
+00006240: 6f73 6974 696f 6e20 6672 6f6d 2074 6865  osition from the
+00006250: 206d 6963 726f 7363 6f70 6520 616e 6420   microscope and 
+00006260: 7265 7475 726e 7320 6974 2061 730a 2020  returns it as.  
+00006270: 2020 2020 2020 6120 4669 6273 656d 5374        a FibsemSt
+00006280: 6167 6550 6f73 6974 696f 6e20 6f62 6a65  agePosition obje
+00006290: 6374 2e0a 0a20 2020 2020 2020 2052 6574  ct...        Ret
+000062a0: 7572 6e73 3a0a 2020 2020 2020 2020 2020  urns:.          
+000062b0: 2020 4669 6273 656d 5374 6167 6550 6f73    FibsemStagePos
+000062c0: 6974 696f 6e3a 2054 6865 2063 7572 7265  ition: The curre
+000062d0: 6e74 2073 7461 6765 2070 6f73 6974 696f  nt stage positio
+000062e0: 6e2e 0a20 2020 2020 2020 2022 2222 0a20  n..        """. 
+000062f0: 2020 2020 2020 2069 6620 7365 6c66 2e68         if self.h
+00006300: 6172 6477 6172 655f 7365 7474 696e 6773  ardware_settings
+00006310: 2e73 7461 6765 5f65 6e61 626c 6564 2069  .stage_enabled i
+00006320: 7320 4661 6c73 653a 0a20 2020 2020 2020  s False:.       
+00006330: 2020 2020 2072 6169 7365 204e 6f74 496d       raise NotIm
+00006340: 706c 656d 656e 7465 6445 7272 6f72 2822  plementedError("
+00006350: 5468 6520 6d69 6372 6f73 636f 7065 2064  The microscope d
+00006360: 6f65 7320 6e6f 7420 6861 7665 2061 206d  oes not have a m
+00006370: 6f76 696e 6720 7374 6167 652e 2229 0a20  oving stage."). 
+00006380: 2020 2020 2020 2073 656c 662e 636f 6e6e         self.conn
+00006390: 6563 7469 6f6e 2e73 7065 6369 6d65 6e2e  ection.specimen.
+000063a0: 7374 6167 652e 7365 745f 6465 6661 756c  stage.set_defaul
+000063b0: 745f 636f 6f72 6469 6e61 7465 5f73 7973  t_coordinate_sys
+000063c0: 7465 6d28 0a20 2020 2020 2020 2020 2020  tem(.           
+000063d0: 2043 6f6f 7264 696e 6174 6553 7973 7465   CoordinateSyste
+000063e0: 6d2e 5241 570a 2020 2020 2020 2020 290a  m.RAW.        ).
+000063f0: 2020 2020 2020 2020 7374 6167 655f 706f          stage_po
+00006400: 7369 7469 6f6e 203d 2073 656c 662e 636f  sition = self.co
+00006410: 6e6e 6563 7469 6f6e 2e73 7065 6369 6d65  nnection.specime
+00006420: 6e2e 7374 6167 652e 6375 7272 656e 745f  n.stage.current_
+00006430: 706f 7369 7469 6f6e 0a20 2020 2020 2020  position.       
+00006440: 2073 656c 662e 636f 6e6e 6563 7469 6f6e   self.connection
+00006450: 2e73 7065 6369 6d65 6e2e 7374 6167 652e  .specimen.stage.
+00006460: 7365 745f 6465 6661 756c 745f 636f 6f72  set_default_coor
+00006470: 6469 6e61 7465 5f73 7973 7465 6d28 0a20  dinate_system(. 
+00006480: 2020 2020 2020 2020 2020 2043 6f6f 7264             Coord
+00006490: 696e 6174 6553 7973 7465 6d2e 5350 4543  inateSystem.SPEC
+000064a0: 494d 454e 0a20 2020 2020 2020 2029 0a20  IMEN.        ). 
+000064b0: 2020 2020 2020 2072 6574 7572 6e20 4669         return Fi
+000064c0: 6273 656d 5374 6167 6550 6f73 6974 696f  bsemStagePositio
+000064d0: 6e2e 6672 6f6d 5f61 7574 6f73 6372 6970  n.from_autoscrip
+000064e0: 745f 706f 7369 7469 6f6e 2873 7461 6765  t_position(stage
+000064f0: 5f70 6f73 6974 696f 6e29 0a0a 2020 2020  _position)..    
+00006500: 6465 6620 6765 745f 6375 7272 656e 745f  def get_current_
+00006510: 6d69 6372 6f73 636f 7065 5f73 7461 7465  microscope_state
+00006520: 2873 656c 6629 202d 3e20 4d69 6372 6f73  (self) -> Micros
+00006530: 636f 7065 5374 6174 653a 0a20 2020 2020  copeState:.     
+00006540: 2020 2022 2222 0a20 2020 2020 2020 2047     """.        G
+00006550: 6574 2074 6865 2063 7572 7265 6e74 206d  et the current m
+00006560: 6963 726f 7363 6f70 6520 7374 6174 650a  icroscope state.
+00006570: 0a20 2020 2020 2020 2054 6869 7320 6d65  .        This me
+00006580: 7468 6f64 2072 6574 7269 6576 6573 2074  thod retrieves t
+00006590: 6865 2063 7572 7265 6e74 206d 6963 726f  he current micro
+000065a0: 7363 6f70 6520 7374 6174 6520 6672 6f6d  scope state from
+000065b0: 2074 6865 206d 6963 726f 7363 6f70 6520   the microscope 
+000065c0: 616e 6420 7265 7475 726e 7320 6974 2061  and returns it a
+000065d0: 730a 2020 2020 2020 2020 6120 4d69 6372  s.        a Micr
+000065e0: 6f73 636f 7065 5374 6174 6520 6f62 6a65  oscopeState obje
+000065f0: 6374 2e0a 0a20 2020 2020 2020 2052 6574  ct...        Ret
+00006600: 7572 6e73 3a0a 2020 2020 2020 2020 2020  urns:.          
+00006610: 2020 4d69 6372 6f73 636f 7065 5374 6174    MicroscopeStat
+00006620: 653a 2063 7572 7265 6e74 206d 6963 726f  e: current micro
+00006630: 7363 6f70 6520 7374 6174 650a 2020 2020  scope state.    
+00006640: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+00006650: 7265 736f 6c75 7469 6f6e 5f65 6220 3d20  resolution_eb = 
+00006660: 7365 6c66 2e63 6f6e 6e65 6374 696f 6e2e  self.connection.
+00006670: 6265 616d 732e 656c 6563 7472 6f6e 5f62  beams.electron_b
+00006680: 6561 6d2e 7363 616e 6e69 6e67 2e72 6573  eam.scanning.res
+00006690: 6f6c 7574 696f 6e2e 7661 6c75 650a 2020  olution.value.  
+000066a0: 2020 2020 2020 7769 6474 685f 6562 203d        width_eb =
+000066b0: 2069 6e74 2872 6573 6f6c 7574 696f 6e5f   int(resolution_
+000066c0: 6562 2e73 706c 6974 2822 7822 295b 305d  eb.split("x")[0]
+000066d0: 290a 2020 2020 2020 2020 6865 6967 6874  ).        height
+000066e0: 5f65 6220 3d20 696e 7428 7265 736f 6c75  _eb = int(resolu
+000066f0: 7469 6f6e 5f65 622e 7370 6c69 7428 2278  tion_eb.split("x
+00006700: 2229 5b2d 315d 290a 2020 2020 2020 2020  ")[-1]).        
+00006710: 7265 736f 6c75 7469 6f6e 5f5f 6962 203d  resolution__ib =
+00006720: 2073 656c 662e 636f 6e6e 6563 7469 6f6e   self.connection
+00006730: 2e62 6561 6d73 2e69 6f6e 5f62 6561 6d2e  .beams.ion_beam.
+00006740: 7363 616e 6e69 6e67 2e72 6573 6f6c 7574  scanning.resolut
+00006750: 696f 6e2e 7661 6c75 650a 2020 2020 2020  ion.value.      
+00006760: 2020 7769 6474 685f 6962 203d 2069 6e74    width_ib = int
+00006770: 2872 6573 6f6c 7574 696f 6e5f 5f69 622e  (resolution__ib.
+00006780: 7370 6c69 7428 2278 2229 5b30 5d29 0a20  split("x")[0]). 
+00006790: 2020 2020 2020 2068 6569 6768 745f 6962         height_ib
+000067a0: 203d 2069 6e74 2872 6573 6f6c 7574 696f   = int(resolutio
+000067b0: 6e5f 5f69 622e 7370 6c69 7428 2278 2229  n__ib.split("x")
+000067c0: 5b2d 315d 290a 0a0a 2020 2020 2020 2020  [-1])...        
+000067d0: 6966 2073 656c 662e 6861 7264 7761 7265  if self.hardware
+000067e0: 5f73 6574 7469 6e67 732e 656c 6563 7472  _settings.electr
+000067f0: 6f6e 5f62 6561 6d20 6973 2054 7275 653a  on_beam is True:
+00006800: 0a20 2020 2020 2020 2020 2020 2065 625f  .            eb_
+00006810: 7365 7474 696e 6773 3d42 6561 6d53 6574  settings=BeamSet
+00006820: 7469 6e67 7328 0a20 2020 2020 2020 2020  tings(.         
+00006830: 2020 2020 2020 2062 6561 6d5f 7479 7065         beam_type
+00006840: 3d42 6561 6d54 7970 652e 454c 4543 5452  =BeamType.ELECTR
+00006850: 4f4e 2c0a 2020 2020 2020 2020 2020 2020  ON,.            
+00006860: 2020 2020 776f 726b 696e 675f 6469 7374      working_dist
+00006870: 616e 6365 3d73 656c 662e 636f 6e6e 6563  ance=self.connec
+00006880: 7469 6f6e 2e62 6561 6d73 2e65 6c65 6374  tion.beams.elect
+00006890: 726f 6e5f 6265 616d 2e77 6f72 6b69 6e67  ron_beam.working
+000068a0: 5f64 6973 7461 6e63 652e 7661 6c75 652c  _distance.value,
+000068b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000068c0: 2062 6561 6d5f 6375 7272 656e 743d 7365   beam_current=se
+000068d0: 6c66 2e63 6f6e 6e65 6374 696f 6e2e 6265  lf.connection.be
+000068e0: 616d 732e 656c 6563 7472 6f6e 5f62 6561  ams.electron_bea
+000068f0: 6d2e 6265 616d 5f63 7572 7265 6e74 2e76  m.beam_current.v
+00006900: 616c 7565 2c0a 2020 2020 2020 2020 2020  alue,.          
+00006910: 2020 2020 2020 766f 6c74 6167 653d 7365        voltage=se
+00006920: 6c66 2e63 6f6e 6e65 6374 696f 6e2e 6265  lf.connection.be
+00006930: 616d 732e 656c 6563 7472 6f6e 5f62 6561  ams.electron_bea
+00006940: 6d2e 6869 6768 5f76 6f6c 7461 6765 2e76  m.high_voltage.v
+00006950: 616c 7565 2c0a 2020 2020 2020 2020 2020  alue,.          
+00006960: 2020 2020 2020 6866 773d 7365 6c66 2e63        hfw=self.c
+00006970: 6f6e 6e65 6374 696f 6e2e 6265 616d 732e  onnection.beams.
+00006980: 656c 6563 7472 6f6e 5f62 6561 6d2e 686f  electron_beam.ho
+00006990: 7269 7a6f 6e74 616c 5f66 6965 6c64 5f77  rizontal_field_w
+000069a0: 6964 7468 2e76 616c 7565 2c0a 2020 2020  idth.value,.    
+000069b0: 2020 2020 2020 2020 2020 2020 7265 736f              reso
+000069c0: 6c75 7469 6f6e 3d5b 7769 6474 685f 6562  lution=[width_eb
+000069d0: 2c20 6865 6967 6874 5f65 625d 2c0a 2020  , height_eb],.  
+000069e0: 2020 2020 2020 2020 2020 2020 2020 6477                dw
+000069f0: 656c 6c5f 7469 6d65 3d73 656c 662e 636f  ell_time=self.co
+00006a00: 6e6e 6563 7469 6f6e 2e62 6561 6d73 2e65  nnection.beams.e
+00006a10: 6c65 6374 726f 6e5f 6265 616d 2e73 6361  lectron_beam.sca
+00006a20: 6e6e 696e 672e 6477 656c 6c5f 7469 6d65  nning.dwell_time
+00006a30: 2e76 616c 7565 2c0a 2020 2020 2020 2020  .value,.        
+00006a40: 2020 2020 2020 2020 7363 616e 5f72 6f74          scan_rot
+00006a50: 6174 696f 6e3d 7365 6c66 2e63 6f6e 6e65  ation=self.conne
+00006a60: 6374 696f 6e2e 6265 616d 732e 656c 6563  ction.beams.elec
+00006a70: 7472 6f6e 5f62 6561 6d2e 7363 616e 6e69  tron_beam.scanni
+00006a80: 6e67 2e72 6f74 6174 696f 6e2e 7661 6c75  ng.rotation.valu
+00006a90: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
+00006aa0: 2020 2073 6869 6674 3d50 6f69 6e74 2873     shift=Point(s
+00006ab0: 656c 662e 636f 6e6e 6563 7469 6f6e 2e62  elf.connection.b
+00006ac0: 6561 6d73 2e65 6c65 6374 726f 6e5f 6265  eams.electron_be
+00006ad0: 616d 2e62 6561 6d5f 7368 6966 742e 7661  am.beam_shift.va
+00006ae0: 6c75 652e 782c 2073 656c 662e 636f 6e6e  lue.x, self.conn
+00006af0: 6563 7469 6f6e 2e62 6561 6d73 2e65 6c65  ection.beams.ele
+00006b00: 6374 726f 6e5f 6265 616d 2e62 6561 6d5f  ctron_beam.beam_
+00006b10: 7368 6966 742e 7661 6c75 652e 7929 2c0a  shift.value.y),.
+00006b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006b30: 7374 6967 6d61 7469 6f6e 3d50 6f69 6e74  stigmation=Point
+00006b40: 2873 656c 662e 636f 6e6e 6563 7469 6f6e  (self.connection
+00006b50: 2e62 6561 6d73 2e65 6c65 6374 726f 6e5f  .beams.electron_
+00006b60: 6265 616d 2e73 7469 676d 6174 6f72 2e76  beam.stigmator.v
+00006b70: 616c 7565 2e78 2c20 7365 6c66 2e63 6f6e  alue.x, self.con
+00006b80: 6e65 6374 696f 6e2e 6265 616d 732e 656c  nection.beams.el
+00006b90: 6563 7472 6f6e 5f62 6561 6d2e 7374 6967  ectron_beam.stig
+00006ba0: 6d61 746f 722e 7661 6c75 652e 7929 2c0a  mator.value.y),.
+00006bb0: 2020 2020 2020 2020 2020 2020 2920 200a              )  .
+00006bc0: 2020 2020 2020 2020 2020 2020 2320 6562              # eb
+00006bd0: 5f73 6574 7469 6e67 7320 3d20 7365 6c66  _settings = self
+00006be0: 2e67 6574 5f62 6561 6d5f 7365 7474 696e  .get_beam_settin
+00006bf0: 6773 2862 6561 6d5f 7479 7065 3d42 6561  gs(beam_type=Bea
+00006c00: 6d54 7970 652e 454c 4543 5452 4f4e 2920  mType.ELECTRON) 
+00006c10: 2320 544f 444f 3a20 4348 414e 4745 5f54  # TODO: CHANGE_T
+00006c20: 4849 535f 4f56 4552 0a20 2020 2020 2020  HIS_OVER.       
+00006c30: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00006c40: 2020 2065 625f 7365 7474 696e 6773 3d4e     eb_settings=N
+00006c50: 6f6e 650a 2020 2020 2020 2020 0a20 2020  one.        .   
+00006c60: 2020 2020 2069 6620 7365 6c66 2e68 6172       if self.har
+00006c70: 6477 6172 655f 7365 7474 696e 6773 2e69  dware_settings.i
+00006c80: 6f6e 5f62 6561 6d20 6973 2054 7275 653a  on_beam is True:
+00006c90: 0a20 2020 2020 2020 2020 2020 2069 625f  .            ib_
+00006ca0: 7365 7474 696e 6773 3d42 6561 6d53 6574  settings=BeamSet
+00006cb0: 7469 6e67 7328 0a20 2020 2020 2020 2020  tings(.         
+00006cc0: 2020 2020 2020 2062 6561 6d5f 7479 7065         beam_type
+00006cd0: 3d42 6561 6d54 7970 652e 494f 4e2c 0a20  =BeamType.ION,. 
+00006ce0: 2020 2020 2020 2020 2020 2020 2020 2077                 w
+00006cf0: 6f72 6b69 6e67 5f64 6973 7461 6e63 653d  orking_distance=
+00006d00: 7365 6c66 2e63 6f6e 6e65 6374 696f 6e2e  self.connection.
+00006d10: 6265 616d 732e 696f 6e5f 6265 616d 2e77  beams.ion_beam.w
+00006d20: 6f72 6b69 6e67 5f64 6973 7461 6e63 652e  orking_distance.
+00006d30: 7661 6c75 652c 0a20 2020 2020 2020 2020  value,.         
+00006d40: 2020 2020 2020 2062 6561 6d5f 6375 7272         beam_curr
+00006d50: 656e 743d 7365 6c66 2e63 6f6e 6e65 6374  ent=self.connect
+00006d60: 696f 6e2e 6265 616d 732e 696f 6e5f 6265  ion.beams.ion_be
+00006d70: 616d 2e62 6561 6d5f 6375 7272 656e 742e  am.beam_current.
+00006d80: 7661 6c75 652c 0a20 2020 2020 2020 2020  value,.         
+00006d90: 2020 2020 2020 2068 6677 3d73 656c 662e         hfw=self.
+00006da0: 636f 6e6e 6563 7469 6f6e 2e62 6561 6d73  connection.beams
+00006db0: 2e69 6f6e 5f62 6561 6d2e 686f 7269 7a6f  .ion_beam.horizo
+00006dc0: 6e74 616c 5f66 6965 6c64 5f77 6964 7468  ntal_field_width
+00006dd0: 2e76 616c 7565 2c0a 2020 2020 2020 2020  .value,.        
+00006de0: 2020 2020 2020 2020 7265 736f 6c75 7469          resoluti
+00006df0: 6f6e 3d5b 7769 6474 685f 6962 2c20 6865  on=[width_ib, he
+00006e00: 6967 6874 5f69 625d 2c0a 2020 2020 2020  ight_ib],.      
+00006e10: 2020 2020 2020 2020 2020 6477 656c 6c5f            dwell_
+00006e20: 7469 6d65 3d73 656c 662e 636f 6e6e 6563  time=self.connec
+00006e30: 7469 6f6e 2e62 6561 6d73 2e69 6f6e 5f62  tion.beams.ion_b
+00006e40: 6561 6d2e 7363 616e 6e69 6e67 2e64 7765  eam.scanning.dwe
+00006e50: 6c6c 5f74 696d 652e 7661 6c75 652c 0a20  ll_time.value,. 
+00006e60: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00006e70: 6361 6e5f 726f 7461 7469 6f6e 3d73 656c  can_rotation=sel
+00006e80: 662e 636f 6e6e 6563 7469 6f6e 2e62 6561  f.connection.bea
+00006e90: 6d73 2e69 6f6e 5f62 6561 6d2e 7363 616e  ms.ion_beam.scan
+00006ea0: 6e69 6e67 2e72 6f74 6174 696f 6e2e 7661  ning.rotation.va
+00006eb0: 6c75 652c 0a20 2020 2020 2020 2020 2020  lue,.           
+00006ec0: 2020 2020 2076 6f6c 7461 6765 3d73 656c       voltage=sel
+00006ed0: 662e 636f 6e6e 6563 7469 6f6e 2e62 6561  f.connection.bea
+00006ee0: 6d73 2e69 6f6e 5f62 6561 6d2e 6869 6768  ms.ion_beam.high
+00006ef0: 5f76 6f6c 7461 6765 2e76 616c 7565 2c0a  _voltage.value,.
+00006f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006f10: 7368 6966 743d 506f 696e 7428 7365 6c66  shift=Point(self
+00006f20: 2e63 6f6e 6e65 6374 696f 6e2e 6265 616d  .connection.beam
+00006f30: 732e 696f 6e5f 6265 616d 2e62 6561 6d5f  s.ion_beam.beam_
+00006f40: 7368 6966 742e 7661 6c75 652e 782c 2073  shift.value.x, s
+00006f50: 656c 662e 636f 6e6e 6563 7469 6f6e 2e62  elf.connection.b
+00006f60: 6561 6d73 2e69 6f6e 5f62 6561 6d2e 6265  eams.ion_beam.be
+00006f70: 616d 5f73 6869 6674 2e76 616c 7565 2e79  am_shift.value.y
+00006f80: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+00006f90: 2020 2073 7469 676d 6174 696f 6e3d 506f     stigmation=Po
+00006fa0: 696e 7428 7365 6c66 2e63 6f6e 6e65 6374  int(self.connect
+00006fb0: 696f 6e2e 6265 616d 732e 696f 6e5f 6265  ion.beams.ion_be
+00006fc0: 616d 2e73 7469 676d 6174 6f72 2e76 616c  am.stigmator.val
+00006fd0: 7565 2e78 2c20 7365 6c66 2e63 6f6e 6e65  ue.x, self.conne
+00006fe0: 6374 696f 6e2e 6265 616d 732e 696f 6e5f  ction.beams.ion_
+00006ff0: 6265 616d 2e73 7469 676d 6174 6f72 2e76  beam.stigmator.v
+00007000: 616c 7565 2e79 292c 0a20 2020 2020 2020  alue.y),.       
+00007010: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+00007020: 2020 2023 2069 625f 7365 7474 696e 6773     # ib_settings
+00007030: 203d 2073 656c 662e 6765 745f 6265 616d   = self.get_beam
+00007040: 5f73 6574 7469 6e67 7328 6265 616d 5f74  _settings(beam_t
+00007050: 7970 653d 4265 616d 5479 7065 2e49 4f4e  ype=BeamType.ION
+00007060: 2920 2320 544f 444f 3a20 4348 414e 4745  ) # TODO: CHANGE
+00007070: 5f54 4849 535f 4f56 4552 0a0a 2020 2020  _THIS_OVER..    
+00007080: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00007090: 2020 2020 2020 6962 5f73 6574 7469 6e67        ib_setting
+000070a0: 733d 4e6f 6e65 0a0a 2020 2020 2020 2020  s=None..        
+000070b0: 6375 7272 656e 745f 6d69 6372 6f73 636f  current_microsco
+000070c0: 7065 5f73 7461 7465 203d 204d 6963 726f  pe_state = Micro
+000070d0: 7363 6f70 6553 7461 7465 280a 2020 2020  scopeState(.    
+000070e0: 2020 2020 2020 2020 7469 6d65 7374 616d          timestam
+000070f0: 703d 6461 7465 7469 6d65 2e64 6174 6574  p=datetime.datet
+00007100: 696d 652e 7469 6d65 7374 616d 7028 6461  ime.timestamp(da
+00007110: 7465 7469 6d65 2e64 6174 6574 696d 652e  tetime.datetime.
+00007120: 6e6f 7728 2929 2c0a 2020 2020 2020 2020  now()),.        
+00007130: 2020 2020 2320 6765 7420 6162 736f 6c75      # get absolu
+00007140: 7465 2073 7461 6765 2063 6f6f 7264 696e  te stage coordin
+00007150: 6174 6573 2028 5241 5729 0a20 2020 2020  ates (RAW).     
+00007160: 2020 2020 2020 2061 6273 6f6c 7574 655f         absolute_
+00007170: 706f 7369 7469 6f6e 3d73 656c 662e 6765  position=self.ge
+00007180: 745f 7374 6167 655f 706f 7369 7469 6f6e  t_stage_position
+00007190: 2829 2c0a 2020 2020 2020 2020 2020 2020  (),.            
+000071a0: 2320 656c 6563 7472 6f6e 2062 6561 6d20  # electron beam 
+000071b0: 7365 7474 696e 6773 0a20 2020 2020 2020  settings.       
+000071c0: 2020 2020 2065 625f 7365 7474 696e 6773       eb_settings
+000071d0: 3d65 625f 7365 7474 696e 6773 2c0a 2020  =eb_settings,.  
+000071e0: 2020 2020 2020 2020 2020 2320 696f 6e20            # ion 
+000071f0: 6265 616d 2073 6574 7469 6e67 730a 2020  beam settings.  
+00007200: 2020 2020 2020 2020 2020 6962 5f73 6574            ib_set
+00007210: 7469 6e67 733d 6962 5f73 6574 7469 6e67  tings=ib_setting
+00007220: 732c 0a20 2020 2020 2020 2029 0a0a 2020  s,.        )..  
+00007230: 2020 2020 2020 7265 7475 726e 2063 7572        return cur
+00007240: 7265 6e74 5f6d 6963 726f 7363 6f70 655f  rent_microscope_
+00007250: 7374 6174 650a 0a20 2020 2064 6566 206d  state..    def m
+00007260: 6f76 655f 7374 6167 655f 6162 736f 6c75  ove_stage_absolu
+00007270: 7465 2873 656c 662c 2070 6f73 6974 696f  te(self, positio
+00007280: 6e3a 2046 6962 7365 6d53 7461 6765 506f  n: FibsemStagePo
+00007290: 7369 7469 6f6e 293a 0a20 2020 2020 2020  sition):.       
+000072a0: 2022 2222 0a20 2020 2020 2020 204d 6f76   """.        Mov
+000072b0: 6520 7468 6520 7374 6167 6520 746f 2074  e the stage to t
+000072c0: 6865 2073 7065 6369 6669 6564 2063 6f6f  he specified coo
+000072d0: 7264 696e 6174 6573 2e0a 0a20 2020 2020  rdinates...     
+000072e0: 2020 2041 7267 733a 0a20 2020 2020 2020     Args:.       
+000072f0: 2020 2020 2078 2028 666c 6f61 7429 3a20       x (float): 
+00007300: 5468 6520 782d 636f 6f72 6469 6e61 7465  The x-coordinate
+00007310: 2074 6f20 6d6f 7665 2074 6f20 2869 6e20   to move to (in 
+00007320: 6d65 7465 7273 292e 0a20 2020 2020 2020  meters)..       
+00007330: 2020 2020 2079 2028 666c 6f61 7429 3a20       y (float): 
+00007340: 5468 6520 792d 636f 6f72 6469 6e61 7465  The y-coordinate
+00007350: 2074 6f20 6d6f 7665 2074 6f20 2869 6e20   to move to (in 
+00007360: 6d65 7465 7273 292e 0a20 2020 2020 2020  meters)..       
+00007370: 2020 2020 207a 2028 666c 6f61 7429 3a20       z (float): 
+00007380: 5468 6520 7a2d 636f 6f72 6469 6e61 7465  The z-coordinate
+00007390: 2074 6f20 6d6f 7665 2074 6f20 2869 6e20   to move to (in 
+000073a0: 6d65 7465 7273 292e 0a20 2020 2020 2020  meters)..       
+000073b0: 2020 2020 2072 2028 666c 6f61 7429 3a20       r (float): 
+000073c0: 5468 6520 726f 7461 7469 6f6e 2074 6f20  The rotation to 
+000073d0: 6170 706c 7920 2869 6e20 7261 6469 616e  apply (in radian
+000073e0: 7329 2e0a 2020 2020 2020 2020 2020 2020  s)..            
+000073f0: 7478 2028 666c 6f61 7429 3a20 5468 6520  tx (float): The 
+00007400: 782d 6178 6973 2074 696c 7420 746f 2061  x-axis tilt to a
+00007410: 7070 6c79 2028 696e 2072 6164 6961 6e73  pply (in radians
+00007420: 292e 0a0a 2020 2020 2020 2020 5265 7475  )...        Retu
+00007430: 726e 733a 0a20 2020 2020 2020 2020 2020  rns:.           
+00007440: 204e 6f6e 650a 2020 2020 2020 2020 2222   None.        ""
+00007450: 220a 2020 2020 2020 2020 6966 2070 6f73  ".        if pos
+00007460: 6974 696f 6e2e 7220 6973 206e 6f74 204e  ition.r is not N
+00007470: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+00007480: 2072 6f74 6174 696f 6e20 3d20 5472 7565   rotation = True
+00007490: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+000074a0: 2020 2020 2020 2020 2020 2072 6f74 6174             rotat
+000074b0: 696f 6e20 3d20 4661 6c73 650a 2020 2020  ion = False.    
+000074c0: 2020 2020 6966 2070 6f73 6974 696f 6e2e      if position.
+000074d0: 7420 6973 206e 6f74 204e 6f6e 653a 0a20  t is not None:. 
+000074e0: 2020 2020 2020 2020 2020 2074 696c 7420             tilt 
+000074f0: 3d20 5472 7565 0a20 2020 2020 2020 2065  = True.        e
+00007500: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00007510: 2074 696c 7420 3d20 4661 6c73 650a 2020   tilt = False.  
+00007520: 2020 2020 2020 5f63 6865 636b 5f73 7461        _check_sta
+00007530: 6765 2873 656c 662e 6861 7264 7761 7265  ge(self.hardware
+00007540: 5f73 6574 7469 6e67 732c 2072 6f74 6174  _settings, rotat
+00007550: 696f 6e3d 726f 7461 7469 6f6e 2c20 7469  ion=rotation, ti
+00007560: 6c74 3d74 696c 7429 0a20 2020 2020 2020  lt=tilt).       
+00007570: 206c 6f67 6769 6e67 2e69 6e66 6f28 6622   logging.info(f"
+00007580: 4d6f 7669 6e67 2073 7461 6765 2074 6f20  Moving stage to 
+00007590: 7b70 6f73 6974 696f 6e7d 2e22 290a 2020  {position}.").  
+000075a0: 2020 2020 2020 7374 6167 6520 3d20 7365        stage = se
+000075b0: 6c66 2e63 6f6e 6e65 6374 696f 6e2e 7370  lf.connection.sp
+000075c0: 6563 696d 656e 2e73 7461 6765 0a20 2020  ecimen.stage.   
+000075d0: 2020 2020 2074 6865 726d 6f5f 706f 7369       thermo_posi
+000075e0: 7469 6f6e 203d 2070 6f73 6974 696f 6e2e  tion = position.
+000075f0: 746f 5f61 7574 6f73 6372 6970 745f 706f  to_autoscript_po
+00007600: 7369 7469 6f6e 2829 0a20 2020 2020 2020  sition().       
+00007610: 2074 6865 726d 6f5f 706f 7369 7469 6f6e   thermo_position
+00007620: 2e63 6f6f 7264 696e 6174 655f 7379 7374  .coordinate_syst
+00007630: 656d 203d 2043 6f6f 7264 696e 6174 6553  em = CoordinateS
+00007640: 7973 7465 6d2e 5241 570a 2020 2020 2020  ystem.RAW.      
+00007650: 2020 7374 6167 652e 6162 736f 6c75 7465    stage.absolute
+00007660: 5f6d 6f76 6528 7468 6572 6d6f 5f70 6f73  _move(thermo_pos
+00007670: 6974 696f 6e2c 204d 6f76 6553 6574 7469  ition, MoveSetti
+00007680: 6e67 7328 726f 7461 7465 5f63 6f6d 7075  ngs(rotate_compu
+00007690: 6365 6e74 7269 633d 5472 7565 2929 2023  centric=True)) #
+000076a0: 2054 4f44 4f3a 2054 6869 7320 6e65 6564   TODO: This need
+000076b0: 7320 6174 206c 6561 7374 2061 6e20 6f70  s at least an op
+000076c0: 7469 6f6e 616c 2073 6166 6520 6d6f 7665  tional safe move
+000076d0: 2074 6f20 7072 6576 656e 7420 636f 6c6c   to prevent coll
+000076e0: 6973 696f 6e3f 0a0a 2020 2020 6465 6620  ision?..    def 
+000076f0: 6d6f 7665 5f73 7461 6765 5f72 656c 6174  move_stage_relat
+00007700: 6976 6528 7365 6c66 2c20 706f 7369 7469  ive(self, positi
+00007710: 6f6e 3a20 4669 6273 656d 5374 6167 6550  on: FibsemStageP
+00007720: 6f73 6974 696f 6e29 3a0a 2020 2020 2020  osition):.      
+00007730: 2020 2222 220a 2020 2020 2020 2020 4d6f    """.        Mo
+00007740: 7665 2074 6865 2073 7461 6765 2062 7920  ve the stage by 
+00007750: 7468 6520 7370 6563 6966 6965 6420 7265  the specified re
+00007760: 6c61 7469 7665 206d 6f76 652e 0a0a 2020  lative move...  
+00007770: 2020 2020 2020 4172 6773 3a0a 2020 2020        Args:.    
+00007780: 2020 2020 2020 2020 7820 2866 6c6f 6174          x (float
+00007790: 293a 2054 6865 2078 2d63 6f6f 7264 696e  ): The x-coordin
+000077a0: 6174 6520 746f 206d 6f76 6520 746f 2028  ate to move to (
+000077b0: 696e 206d 6574 6572 7329 2e0a 2020 2020  in meters)..    
+000077c0: 2020 2020 2020 2020 7920 2866 6c6f 6174          y (float
+000077d0: 293a 2054 6865 2079 2d63 6f6f 7264 696e  ): The y-coordin
+000077e0: 6174 6520 746f 206d 6f76 6520 746f 2028  ate to move to (
+000077f0: 696e 206d 6574 6572 7329 2e0a 2020 2020  in meters)..    
+00007800: 2020 2020 2020 2020 7a20 2866 6c6f 6174          z (float
+00007810: 293a 2054 6865 207a 2d63 6f6f 7264 696e  ): The z-coordin
+00007820: 6174 6520 746f 206d 6f76 6520 746f 2028  ate to move to (
+00007830: 696e 206d 6574 6572 7329 2e0a 2020 2020  in meters)..    
+00007840: 2020 2020 2020 2020 7220 2866 6c6f 6174          r (float
+00007850: 293a 2054 6865 2072 6f74 6174 696f 6e20  ): The rotation 
+00007860: 746f 2061 7070 6c79 2028 696e 2072 6164  to apply (in rad
+00007870: 6961 6e73 292e 0a20 2020 2020 2020 2020  ians)..         
+00007880: 2020 2074 7820 2866 6c6f 6174 293a 2054     tx (float): T
+00007890: 6865 2078 2d61 7869 7320 7469 6c74 2074  he x-axis tilt t
+000078a0: 6f20 6170 706c 7920 2869 6e20 7261 6469  o apply (in radi
+000078b0: 616e 7329 2e0a 0a20 2020 2020 2020 2052  ans)...        R
+000078c0: 6574 7572 6e73 3a0a 2020 2020 2020 2020  eturns:.        
+000078d0: 2020 2020 4e6f 6e65 0a20 2020 2020 2020      None.       
+000078e0: 2022 2222 0a20 2020 2020 2020 2069 6620   """.        if 
+000078f0: 706f 7369 7469 6f6e 2e72 2069 7320 6e6f  position.r is no
+00007900: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
+00007910: 2020 2020 726f 7461 7469 6f6e 203d 2054      rotation = T
+00007920: 7275 650a 2020 2020 2020 2020 656c 7365  rue.        else
+00007930: 3a0a 2020 2020 2020 2020 2020 2020 726f  :.            ro
+00007940: 7461 7469 6f6e 203d 2046 616c 7365 0a20  tation = False. 
+00007950: 2020 2020 2020 2069 6620 706f 7369 7469         if positi
+00007960: 6f6e 2e74 2069 7320 6e6f 7420 4e6f 6e65  on.t is not None
+00007970: 3a0a 2020 2020 2020 2020 2020 2020 7469  :.            ti
+00007980: 6c74 203d 2054 7275 650a 2020 2020 2020  lt = True.      
+00007990: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+000079a0: 2020 2020 7469 6c74 203d 2046 616c 7365      tilt = False
+000079b0: 0a20 2020 2020 2020 205f 6368 6563 6b5f  .        _check_
+000079c0: 7374 6167 6528 7365 6c66 2e68 6172 6477  stage(self.hardw
+000079d0: 6172 655f 7365 7474 696e 6773 2c20 726f  are_settings, ro
+000079e0: 7461 7469 6f6e 3d72 6f74 6174 696f 6e2c  tation=rotation,
+000079f0: 2074 696c 743d 7469 6c74 290a 2020 2020   tilt=tilt).    
+00007a00: 2020 2020 6c6f 6767 696e 672e 696e 666f      logging.info
+00007a10: 2866 224d 6f76 696e 6720 7374 6167 6520  (f"Moving stage 
+00007a20: 6279 207b 706f 7369 7469 6f6e 7d2e 2229  by {position}.")
+00007a30: 0a20 2020 2020 2020 2073 7461 6765 203d  .        stage =
+00007a40: 2073 656c 662e 636f 6e6e 6563 7469 6f6e   self.connection
+00007a50: 2e73 7065 6369 6d65 6e2e 7374 6167 650a  .specimen.stage.
+00007a60: 2020 2020 2020 2020 7468 6572 6d6f 5f70          thermo_p
+00007a70: 6f73 6974 696f 6e20 3d20 706f 7369 7469  osition = positi
+00007a80: 6f6e 2e74 6f5f 6175 746f 7363 7269 7074  on.to_autoscript
+00007a90: 5f70 6f73 6974 696f 6e28 290a 2020 2020  _position().    
+00007aa0: 2020 2020 7468 6572 6d6f 5f70 6f73 6974      thermo_posit
+00007ab0: 696f 6e2e 636f 6f72 6469 6e61 7465 5f73  ion.coordinate_s
+00007ac0: 7973 7465 6d20 3d20 436f 6f72 6469 6e61  ystem = Coordina
+00007ad0: 7465 5379 7374 656d 2e52 4157 0a20 2020  teSystem.RAW.   
+00007ae0: 2020 2020 2073 7461 6765 2e72 656c 6174       stage.relat
+00007af0: 6976 655f 6d6f 7665 2874 6865 726d 6f5f  ive_move(thermo_
+00007b00: 706f 7369 7469 6f6e 290a 0a20 2020 2064  position)..    d
+00007b10: 6566 2073 7461 626c 655f 6d6f 7665 280a  ef stable_move(.
+00007b20: 2020 2020 2020 2020 7365 6c66 2c0a 2020          self,.  
+00007b30: 2020 2020 2020 7365 7474 696e 6773 3a20        settings: 
+00007b40: 4d69 6372 6f73 636f 7065 5365 7474 696e  MicroscopeSettin
+00007b50: 6773 2c0a 2020 2020 2020 2020 6478 3a20  gs,.        dx: 
+00007b60: 666c 6f61 742c 0a20 2020 2020 2020 2064  float,.        d
+00007b70: 793a 2066 6c6f 6174 2c0a 2020 2020 2020  y: float,.      
+00007b80: 2020 6265 616d 5f74 7970 653a 2042 6561    beam_type: Bea
+00007b90: 6d54 7970 652c 0a20 2020 2020 2020 205f  mType,.        _
+00007ba0: 6669 7865 643a 2062 6f6f 6c20 3d20 4661  fixed: bool = Fa
+00007bb0: 6c73 652c 200a 2020 2020 2920 2d3e 204e  lse, .    ) -> N
+00007bc0: 6f6e 653a 0a20 2020 2020 2020 2022 2222  one:.        """
+00007bd0: 0a20 2020 2020 2020 2043 616c 6375 6c61  .        Calcula
+00007be0: 7465 2074 6865 2063 6f72 7265 6374 6564  te the corrected
+00007bf0: 2073 7461 6765 206d 6f76 656d 656e 7473   stage movements
+00007c00: 2062 6173 6564 206f 6e20 7468 6520 6265   based on the be
+00007c10: 616d 5f74 7970 652c 2061 6e64 2074 6865  am_type, and the
+00007c20: 6e20 6d6f 7665 2074 6865 2073 7461 6765  n move the stage
+00007c30: 2072 656c 6174 6976 656c 792e 0a0a 2020   relatively...  
+00007c40: 2020 2020 2020 4172 6773 3a0a 2020 2020        Args:.    
+00007c50: 2020 2020 2020 2020 7365 7474 696e 6773          settings
+00007c60: 2028 4d69 6372 6f73 636f 7065 5365 7474   (MicroscopeSett
+00007c70: 696e 6773 293a 206d 6963 726f 7363 6f70  ings): microscop
+00007c80: 6520 7365 7474 696e 6773 0a20 2020 2020  e settings.     
+00007c90: 2020 2020 2020 2064 7820 2866 6c6f 6174         dx (float
+00007ca0: 293a 2064 6973 7461 6e63 6520 616c 6f6e  ): distance alon
+00007cb0: 6720 7468 6520 782d 6178 6973 2028 696d  g the x-axis (im
+00007cc0: 6167 6520 636f 6f72 6469 6e61 7465 7329  age coordinates)
+00007cd0: 0a20 2020 2020 2020 2020 2020 2064 7920  .            dy 
+00007ce0: 2866 6c6f 6174 293a 2064 6973 7461 6e63  (float): distanc
+00007cf0: 6520 616c 6f6e 6720 7468 6520 792d 6178  e along the y-ax
+00007d00: 6973 2028 696d 6167 6520 636f 6f72 6469  is (image coordi
+00007d10: 6e61 7465 7329 0a20 2020 2020 2020 2020  nates).         
+00007d20: 2020 2062 6561 6d5f 7479 7065 2028 4265     beam_type (Be
+00007d30: 616d 5479 7065 293a 2062 6561 6d20 7479  amType): beam ty
+00007d40: 7065 2074 6f20 6d6f 7665 2069 6e0a 2020  pe to move in.  
+00007d50: 2020 2020 2020 2020 2020 5f66 6978 6564            _fixed
+00007d60: 2028 626f 6f6c 2c20 6f70 7469 6f6e 616c   (bool, optional
+00007d70: 293a 2077 6865 7468 6572 2074 6f20 6669  ): whether to fi
+00007d80: 7820 7468 6520 776f 726b 696e 6720 6469  x the working di
+00007d90: 7374 616e 6365 2e20 4465 6661 756c 7473  stance. Defaults
+00007da0: 2074 6f20 4661 6c73 652e 0a20 2020 2020   to False..     
+00007db0: 2020 2022 2222 0a20 2020 2020 2020 205f     """.        _
+00007dc0: 6368 6563 6b5f 7374 6167 6528 7365 6c66  check_stage(self
+00007dd0: 2e68 6172 6477 6172 655f 7365 7474 696e  .hardware_settin
+00007de0: 6773 290a 2020 2020 2020 2020 7764 203d  gs).        wd =
+00007df0: 2073 656c 662e 636f 6e6e 6563 7469 6f6e   self.connection
+00007e00: 2e62 6561 6d73 2e65 6c65 6374 726f 6e5f  .beams.electron_
+00007e10: 6265 616d 2e77 6f72 6b69 6e67 5f64 6973  beam.working_dis
+00007e20: 7461 6e63 652e 7661 6c75 650a 0a20 2020  tance.value..   
+00007e30: 2020 2020 2069 6620 6265 616d 5f74 7970       if beam_typ
+00007e40: 6520 3d3d 2042 6561 6d54 7970 652e 454c  e == BeamType.EL
+00007e50: 4543 5452 4f4e 3a0a 2020 2020 2020 2020  ECTRON:.        
+00007e60: 2020 2020 696d 6167 655f 726f 7461 7469      image_rotati
+00007e70: 6f6e 203d 2073 656c 662e 636f 6e6e 6563  on = self.connec
+00007e80: 7469 6f6e 2e62 6561 6d73 2e65 6c65 6374  tion.beams.elect
+00007e90: 726f 6e5f 6265 616d 2e73 6361 6e6e 696e  ron_beam.scannin
+00007ea0: 672e 726f 7461 7469 6f6e 2e76 616c 7565  g.rotation.value
+00007eb0: 0a20 2020 2020 2020 2065 6c69 6620 6265  .        elif be
+00007ec0: 616d 5f74 7970 6520 3d3d 2042 6561 6d54  am_type == BeamT
+00007ed0: 7970 652e 494f 4e3a 0a20 2020 2020 2020  ype.ION:.       
+00007ee0: 2020 2020 2069 6d61 6765 5f72 6f74 6174       image_rotat
+00007ef0: 696f 6e20 3d20 7365 6c66 2e63 6f6e 6e65  ion = self.conne
+00007f00: 6374 696f 6e2e 6265 616d 732e 696f 6e5f  ction.beams.ion_
+00007f10: 6265 616d 2e73 6361 6e6e 696e 672e 726f  beam.scanning.ro
+00007f20: 7461 7469 6f6e 2e76 616c 7565 0a0a 2020  tation.value..  
+00007f30: 2020 2020 2020 6966 206e 702e 6973 636c        if np.iscl
+00007f40: 6f73 6528 696d 6167 655f 726f 7461 7469  ose(image_rotati
+00007f50: 6f6e 2c20 302e 3029 3a0a 2020 2020 2020  on, 0.0):.      
+00007f60: 2020 2020 2020 6478 203d 2064 780a 2020        dx = dx.  
+00007f70: 2020 2020 2020 2020 2020 6479 203d 2064            dy = d
+00007f80: 790a 2020 2020 2020 2020 656c 6966 206e  y.        elif n
+00007f90: 702e 6973 636c 6f73 6528 696d 6167 655f  p.isclose(image_
+00007fa0: 726f 7461 7469 6f6e 2c20 6e70 2e70 6929  rotation, np.pi)
+00007fb0: 3a0a 2020 2020 2020 2020 2020 2020 6478  :.            dx
+00007fc0: 202a 3d20 2d31 2e30 0a20 2020 2020 2020   *= -1.0.       
+00007fd0: 2020 2020 2064 7920 2a3d 202d 312e 300a       dy *= -1.0.
+00007fe0: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
+00007ff0: 2023 2063 616c 6375 6c61 7465 2073 7461   # calculate sta
+00008000: 6765 206d 6f76 656d 656e 740a 2020 2020  ge movement.    
+00008010: 2020 2020 785f 6d6f 7665 203d 2046 6962      x_move = Fib
+00008020: 7365 6d53 7461 6765 506f 7369 7469 6f6e  semStagePosition
+00008030: 2878 3d64 782c 2079 3d30 2c20 7a3d 3029  (x=dx, y=0, z=0)
+00008040: 0a20 2020 2020 2020 2079 7a5f 6d6f 7665  .        yz_move
+00008050: 203d 2073 656c 662e 5f79 5f63 6f72 7265   = self._y_corre
+00008060: 6374 6564 5f73 7461 6765 5f6d 6f76 656d  cted_stage_movem
+00008070: 656e 7428 0a20 2020 2020 2020 2020 2020  ent(.           
+00008080: 2073 6574 7469 6e67 733d 7365 7474 696e   settings=settin
+00008090: 6773 2c0a 2020 2020 2020 2020 2020 2020  gs,.            
+000080a0: 6578 7065 6374 6564 5f79 3d64 792c 0a20  expected_y=dy,. 
+000080b0: 2020 2020 2020 2020 2020 2062 6561 6d5f             beam_
+000080c0: 7479 7065 3d62 6561 6d5f 7479 7065 2c0a  type=beam_type,.
+000080d0: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
+000080e0: 2020 2023 206d 6f76 6520 7374 6167 650a     # move stage.
+000080f0: 2020 2020 2020 2020 7374 6167 655f 706f          stage_po
+00008100: 7369 7469 6f6e 203d 2046 6962 7365 6d53  sition = FibsemS
+00008110: 7461 6765 506f 7369 7469 6f6e 280a 2020  tagePosition(.  
+00008120: 2020 2020 2020 2020 2020 783d 785f 6d6f            x=x_mo
+00008130: 7665 2e78 2c0a 2020 2020 2020 2020 2020  ve.x,.          
+00008140: 2020 793d 797a 5f6d 6f76 652e 792c 0a20    y=yz_move.y,. 
+00008150: 2020 2020 2020 2020 2020 207a 3d79 7a5f             z=yz_
+00008160: 6d6f 7665 2e7a 2c0a 2020 2020 2020 2020  move.z,.        
+00008170: 2020 2020 723d 302c 0a20 2020 2020 2020      r=0,.       
+00008180: 2020 2020 2074 3d30 2c0a 2020 2020 2020       t=0,.      
+00008190: 2020 2020 2020 636f 6f72 6469 6e61 7465        coordinate
+000081a0: 5f73 7973 7465 6d3d 2252 4157 222c 0a20  _system="RAW",. 
+000081b0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+000081c0: 206c 6f67 6769 6e67 2e69 6e66 6f28 6622   logging.info(f"
+000081d0: 6d6f 7669 6e67 2073 7461 6765 2028 7b62  moving stage ({b
+000081e0: 6561 6d5f 7479 7065 2e6e 616d 657d 293a  eam_type.name}):
+000081f0: 207b 7374 6167 655f 706f 7369 7469 6f6e   {stage_position
+00008200: 7d22 290a 2020 2020 2020 2020 7365 6c66  }").        self
+00008210: 2e6d 6f76 655f 7374 6167 655f 7265 6c61  .move_stage_rela
+00008220: 7469 7665 2873 7461 6765 5f70 6f73 6974  tive(stage_posit
+00008230: 696f 6e29 0a0a 2020 2020 2020 2020 2320  ion)..        # 
+00008240: 6164 6a75 7374 2077 6f72 6b69 6e67 2064  adjust working d
+00008250: 6973 7461 6e63 6520 746f 2063 6f6d 7065  istance to compe
+00008260: 6e73 6174 6520 666f 7220 7374 6167 6520  nsate for stage 
+00008270: 6d6f 7665 6d65 6e74 0a20 2020 2020 2020  movement.       
+00008280: 2069 6620 5f66 6978 6564 3a0a 2020 2020   if _fixed:.    
+00008290: 2020 2020 2020 2020 7764 203d 2073 6574          wd = set
+000082a0: 7469 6e67 732e 7379 7374 656d 2e65 6c65  tings.system.ele
+000082b0: 6374 726f 6e2e 6575 6365 6e74 7269 635f  ctron.eucentric_
+000082c0: 6865 6967 6874 0a20 2020 2020 2020 200a  height.        .
+000082d0: 2020 2020 2020 2020 7365 6c66 2e63 6f6e          self.con
+000082e0: 6e65 6374 696f 6e2e 6265 616d 732e 656c  nection.beams.el
+000082f0: 6563 7472 6f6e 5f62 6561 6d2e 776f 726b  ectron_beam.work
+00008300: 696e 675f 6469 7374 616e 6365 2e76 616c  ing_distance.val
+00008310: 7565 203d 2077 640a 2020 2020 2020 2020  ue = wd.        
+00008320: 7365 6c66 2e63 6f6e 6e65 6374 696f 6e2e  self.connection.
+00008330: 7370 6563 696d 656e 2e73 7461 6765 2e6c  specimen.stage.l
+00008340: 696e 6b28 290a 0a20 2020 2020 2020 2072  ink()..        r
+00008350: 6574 7572 6e20 7374 6167 655f 706f 7369  eturn stage_posi
+00008360: 7469 6f6e 0a0a 2020 2020 6465 6620 6575  tion..    def eu
+00008370: 6365 6e74 7269 635f 6d6f 7665 280a 2020  centric_move(.  
+00008380: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
+00008390: 2020 2020 7365 7474 696e 6773 3a20 4d69      settings: Mi
+000083a0: 6372 6f73 636f 7065 5365 7474 696e 6773  croscopeSettings
+000083b0: 2c0a 2020 2020 2020 2020 6479 3a20 666c  ,.        dy: fl
+000083c0: 6f61 742c 0a20 2020 2020 2020 2073 7461  oat,.        sta
+000083d0: 7469 635f 7764 3a20 626f 6f6c 203d 2054  tic_wd: bool = T
+000083e0: 7275 652c 0a20 2020 2029 202d 3e20 4e6f  rue,.    ) -> No
+000083f0: 6e65 3a0a 2020 2020 2020 2020 2222 220a  ne:.        """.
+00008400: 2020 2020 2020 2020 4d6f 7665 2074 6865          Move the
+00008410: 2073 7461 6765 2076 6572 7469 6361 6c6c   stage verticall
+00008420: 7920 746f 2063 6f72 7265 6374 2065 7563  y to correct euc
+00008430: 656e 7472 6963 2070 6f69 6e74 0a0a 2020  entric point..  
+00008440: 2020 2020 2020 4172 6773 3a0a 2020 2020        Args:.    
+00008450: 2020 2020 2020 2020 7365 7474 696e 6773          settings
+00008460: 2028 4d69 6372 6f73 636f 7065 5365 7474   (MicroscopeSett
+00008470: 696e 6773 293a 206d 6963 726f 7363 6f70  ings): microscop
+00008480: 6520 7365 7474 696e 6773 0a20 2020 2020  e settings.     
+00008490: 2020 2020 2020 2064 7920 2866 6c6f 6174         dy (float
+000084a0: 293a 2064 6973 7461 6e63 6520 696e 2079  ): distance in y
+000084b0: 2d61 7869 7320 2869 6d61 6765 2063 6f6f  -axis (image coo
+000084c0: 7264 696e 6174 6573 290a 2020 2020 2020  rdinates).      
+000084d0: 2020 2222 220a 2020 2020 2020 2020 5f63    """.        _c
+000084e0: 6865 636b 5f73 7461 6765 2873 656c 662e  heck_stage(self.
+000084f0: 6861 7264 7761 7265 5f73 6574 7469 6e67  hardware_setting
+00008500: 7329 0a20 2020 2020 2020 2077 6420 3d20  s).        wd = 
+00008510: 7365 6c66 2e63 6f6e 6e65 6374 696f 6e2e  self.connection.
+00008520: 6265 616d 732e 656c 6563 7472 6f6e 5f62  beams.electron_b
+00008530: 6561 6d2e 776f 726b 696e 675f 6469 7374  eam.working_dist
+00008540: 616e 6365 2e76 616c 7565 0a20 2020 2020  ance.value.     
+00008550: 2020 2069 6d61 6765 5f72 6f74 6174 696f     image_rotatio
+00008560: 6e20 3d20 7365 6c66 2e63 6f6e 6e65 6374  n = self.connect
+00008570: 696f 6e2e 6265 616d 732e 696f 6e5f 6265  ion.beams.ion_be
+00008580: 616d 2e73 6361 6e6e 696e 672e 726f 7461  am.scanning.rota
+00008590: 7469 6f6e 2e76 616c 7565 0a20 2020 2020  tion.value.     
+000085a0: 2020 2069 6620 6e70 2e69 7363 6c6f 7365     if np.isclose
+000085b0: 2869 6d61 6765 5f72 6f74 6174 696f 6e2c  (image_rotation,
+000085c0: 2030 2e30 293a 0a20 2020 2020 2020 2020   0.0):.         
+000085d0: 2020 2064 7920 3d20 6479 0a20 2020 2020     dy = dy.     
+000085e0: 2020 2065 6c69 6620 6e70 2e69 7363 6c6f     elif np.isclo
+000085f0: 7365 2869 6d61 6765 5f72 6f74 6174 696f  se(image_rotatio
+00008600: 6e2c 206e 702e 7069 293a 0a20 2020 2020  n, np.pi):.     
+00008610: 2020 2020 2020 2064 7920 3d20 2d64 790a         dy = -dy.
+00008620: 2020 2020 2020 2020 2320 544f 444f 3a20          # TODO: 
+00008630: 646f 6573 2074 6869 7320 6e65 6564 2074  does this need t
+00008640: 6865 2070 6572 7370 6563 7469 7665 2063  he perspective c
+00008650: 6f72 7265 6374 696f 6e20 746f 6f3f 0a0a  orrection too?..
+00008660: 2020 2020 2020 2020 7a5f 6d6f 7665 203d          z_move =
+00008670: 2064 7920 2f20 6e70 2e63 6f73 286e 702e   dy / np.cos(np.
+00008680: 6465 6732 7261 6428 3930 202d 2073 656c  deg2rad(90 - sel
+00008690: 662e 7374 6167 655f 7365 7474 696e 6773  f.stage_settings
+000086a0: 2e74 696c 745f 666c 6174 5f74 6f5f 696f  .tilt_flat_to_io
+000086b0: 6e29 2920 2023 2054 4f44 4f3a 204d 4147  n))  # TODO: MAG
+000086c0: 4943 204e 554d 4245 522c 2039 3020 2d20  IC NUMBER, 90 - 
+000086d0: 6669 6220 7469 6c74 0a0a 2020 2020 2020  fib tilt..      
+000086e0: 2020 6d6f 7665 5f73 6574 7469 6e67 7320    move_settings 
+000086f0: 3d20 4d6f 7665 5365 7474 696e 6773 286c  = MoveSettings(l
+00008700: 696e 6b5f 7a5f 793d 5472 7565 290a 2020  ink_z_y=True).  
+00008710: 2020 2020 2020 7a5f 6d6f 7665 203d 2046        z_move = F
+00008720: 6962 7365 6d53 7461 6765 506f 7369 7469  ibsemStagePositi
+00008730: 6f6e 280a 2020 2020 2020 2020 2020 2020  on(.            
+00008740: 7a3d 7a5f 6d6f 7665 2c20 636f 6f72 6469  z=z_move, coordi
+00008750: 6e61 7465 5f73 7973 7465 6d3d 2253 7065  nate_system="Spe
+00008760: 6369 6d65 6e22 0a20 2020 2020 2020 2029  cimen".        )
+00008770: 2e74 6f5f 6175 746f 7363 7269 7074 5f70  .to_autoscript_p
+00008780: 6f73 6974 696f 6e28 290a 2020 2020 2020  osition().      
+00008790: 2020 7365 6c66 2e63 6f6e 6e65 6374 696f    self.connectio
+000087a0: 6e2e 7370 6563 696d 656e 2e73 7461 6765  n.specimen.stage
+000087b0: 2e72 656c 6174 6976 655f 6d6f 7665 287a  .relative_move(z
+000087c0: 5f6d 6f76 652c 206d 6f76 655f 7365 7474  _move, move_sett
+000087d0: 696e 6773 290a 2020 2020 2020 2020 6c6f  ings).        lo
+000087e0: 6767 696e 672e 696e 666f 2866 2265 7563  gging.info(f"euc
+000087f0: 656e 7472 6963 206d 6f76 656d 656e 743a  entric movement:
+00008800: 207b 7a5f 6d6f 7665 7d22 290a 0a20 2020   {z_move}")..   
+00008810: 2020 2020 2069 6620 7374 6174 6963 5f77       if static_w
+00008820: 643a 0a20 2020 2020 2020 2020 2020 2073  d:.            s
+00008830: 656c 662e 636f 6e6e 6563 7469 6f6e 2e62  elf.connection.b
+00008840: 6561 6d73 2e65 6c65 6374 726f 6e5f 6265  eams.electron_be
+00008850: 616d 2e77 6f72 6b69 6e67 5f64 6973 7461  am.working_dista
+00008860: 6e63 652e 7661 6c75 6520 3d20 280a 2020  nce.value = (.  
+00008870: 2020 2020 2020 2020 2020 2020 2020 7365                se
+00008880: 7474 696e 6773 2e73 7973 7465 6d2e 656c  ttings.system.el
+00008890: 6563 7472 6f6e 2e65 7563 656e 7472 6963  ectron.eucentric
+000088a0: 5f68 6569 6768 740a 2020 2020 2020 2020  _height.        
+000088b0: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+000088c0: 2020 7365 6c66 2e63 6f6e 6e65 6374 696f    self.connectio
+000088d0: 6e2e 6265 616d 732e 696f 6e5f 6265 616d  n.beams.ion_beam
+000088e0: 2e77 6f72 6b69 6e67 5f64 6973 7461 6e63  .working_distanc
+000088f0: 652e 7661 6c75 6520 3d20 280a 2020 2020  e.value = (.    
+00008900: 2020 2020 2020 2020 2020 2020 7365 7474              sett
+00008910: 696e 6773 2e73 7973 7465 6d2e 696f 6e2e  ings.system.ion.
+00008920: 6575 6365 6e74 7269 635f 6865 6967 6874  eucentric_height
+00008930: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
+00008940: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00008950: 2020 2020 2020 2020 2073 656c 662e 636f           self.co
+00008960: 6e6e 6563 7469 6f6e 2e62 6561 6d73 2e65  nnection.beams.e
+00008970: 6c65 6374 726f 6e5f 6265 616d 2e77 6f72  lectron_beam.wor
+00008980: 6b69 6e67 5f64 6973 7461 6e63 652e 7661  king_distance.va
+00008990: 6c75 6520 3d20 7764 0a20 2020 2020 2020  lue = wd.       
+000089a0: 2073 656c 662e 636f 6e6e 6563 7469 6f6e   self.connection
+000089b0: 2e73 7065 6369 6d65 6e2e 7374 6167 652e  .specimen.stage.
+000089c0: 6c69 6e6b 2829 0a0a 2020 2020 6465 6620  link()..    def 
+000089d0: 5f79 5f63 6f72 7265 6374 6564 5f73 7461  _y_corrected_sta
+000089e0: 6765 5f6d 6f76 656d 656e 7428 0a20 2020  ge_movement(.   
+000089f0: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
+00008a00: 2020 2073 6574 7469 6e67 733a 204d 6963     settings: Mic
+00008a10: 726f 7363 6f70 6553 6574 7469 6e67 732c  roscopeSettings,
+00008a20: 0a20 2020 2020 2020 2065 7870 6563 7465  .        expecte
+00008a30: 645f 793a 2066 6c6f 6174 2c0a 2020 2020  d_y: float,.    
+00008a40: 2020 2020 6265 616d 5f74 7970 653a 2042      beam_type: B
+00008a50: 6561 6d54 7970 6520 3d20 4265 616d 5479  eamType = BeamTy
+00008a60: 7065 2e45 4c45 4354 524f 4e2c 0a20 2020  pe.ELECTRON,.   
+00008a70: 2029 202d 3e20 4669 6273 656d 5374 6167   ) -> FibsemStag
+00008a80: 6550 6f73 6974 696f 6e3a 0a20 2020 2020  ePosition:.     
+00008a90: 2020 2022 2222 0a20 2020 2020 2020 2043     """.        C
+00008aa0: 616c 6375 6c61 7465 2074 6865 2079 2063  alculate the y c
+00008ab0: 6f72 7265 6374 6564 2073 7461 6765 206d  orrected stage m
+00008ac0: 6f76 656d 656e 742c 2063 6f72 7265 6374  ovement, correct
+00008ad0: 6564 2066 6f72 2074 6865 2061 6464 6974  ed for the addit
+00008ae0: 696f 6e61 6c20 7469 6c74 206f 6620 7468  ional tilt of th
+00008af0: 6520 7361 6d70 6c65 2068 6f6c 6465 7220  e sample holder 
+00008b00: 2870 7265 2d74 696c 7420 616e 676c 6529  (pre-tilt angle)
+00008b10: 2e0a 0a20 2020 2020 2020 2041 7267 733a  ...        Args:
+00008b20: 0a20 2020 2020 2020 2020 2020 2073 6574  .            set
+00008b30: 7469 6e67 7320 284d 6963 726f 7363 6f70  tings (Microscop
+00008b40: 6553 6574 7469 6e67 7329 3a20 6d69 6372  eSettings): micr
+00008b50: 6f73 636f 7065 2073 6574 7469 6e67 730a  oscope settings.
+00008b60: 2020 2020 2020 2020 2020 2020 6578 7065              expe
+00008b70: 6374 6564 5f79 2028 666c 6f61 742c 206f  cted_y (float, o
+00008b80: 7074 696f 6e61 6c29 3a20 6469 7374 616e  ptional): distan
+00008b90: 6365 2061 6c6f 6e67 2079 2d61 7869 732e  ce along y-axis.
+00008ba0: 0a20 2020 2020 2020 2020 2020 2062 6561  .            bea
+00008bb0: 6d5f 7479 7065 2028 4265 616d 5479 7065  m_type (BeamType
+00008bc0: 2c20 6f70 7469 6f6e 616c 293a 2062 6561  , optional): bea
+00008bd0: 6d5f 7479 7065 2074 6f20 6d6f 7665 2069  m_type to move i
+00008be0: 6e2e 2044 6566 6175 6c74 7320 746f 2042  n. Defaults to B
+00008bf0: 6561 6d54 7970 652e 454c 4543 5452 4f4e  eamType.ELECTRON
+00008c00: 2e0a 0a20 2020 2020 2020 2052 6574 7572  ...        Retur
+00008c10: 6e73 3a0a 2020 2020 2020 2020 2020 2020  ns:.            
+00008c20: 5374 6167 6550 6f73 6974 696f 6e3a 2079  StagePosition: y
+00008c30: 2063 6f72 7265 6374 6564 2073 7461 6765   corrected stage
+00008c40: 206d 6f76 656d 656e 7420 2872 656c 6174   movement (relat
+00008c50: 6976 6520 706f 7369 7469 6f6e 290a 2020  ive position).  
+00008c60: 2020 2020 2020 2222 220a 0a20 2020 2020        """..     
+00008c70: 2020 2023 2054 4f44 4f3a 2072 6570 6c61     # TODO: repla
+00008c80: 6365 2077 6974 6820 6361 6d65 7261 206d  ce with camera m
+00008c90: 6174 7269 7820 2a20 696e 7665 7273 6520  atrix * inverse 
+00008ca0: 6b69 6e65 6d61 7469 6373 0a20 2020 2020  kinematics.     
+00008cb0: 2020 2023 2054 4f44 4f3a 2072 6570 6c61     # TODO: repla
+00008cc0: 6365 2073 7461 6765 5f74 696c 745f 666c  ce stage_tilt_fl
+00008cd0: 6174 5f74 6f5f 656c 6563 7472 6f6e 2077  at_to_electron w
+00008ce0: 6974 6820 7072 652d 7469 6c74 0a0a 2020  ith pre-tilt..  
+00008cf0: 2020 2020 2020 2320 616c 6c20 616e 676c        # all angl
+00008d00: 6573 2069 6e20 7261 6469 616e 730a 2020  es in radians.  
+00008d10: 2020 2020 2020 7374 6167 655f 7469 6c74        stage_tilt
+00008d20: 5f66 6c61 745f 746f 5f65 6c65 6374 726f  _flat_to_electro
+00008d30: 6e20 3d20 6e70 2e64 6567 3272 6164 280a  n = np.deg2rad(.
+00008d40: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00008d50: 2e73 7461 6765 5f73 6574 7469 6e67 732e  .stage_settings.
+00008d60: 7469 6c74 5f66 6c61 745f 746f 5f65 6c65  tilt_flat_to_ele
+00008d70: 6374 726f 6e0a 2020 2020 2020 2020 290a  ctron.        ).
+00008d80: 2020 2020 2020 2020 7374 6167 655f 7469          stage_ti
+00008d90: 6c74 5f66 6c61 745f 746f 5f69 6f6e 203d  lt_flat_to_ion =
+00008da0: 206e 702e 6465 6732 7261 6428 7365 6c66   np.deg2rad(self
+00008db0: 2e73 7461 6765 5f73 6574 7469 6e67 732e  .stage_settings.
+00008dc0: 7469 6c74 5f66 6c61 745f 746f 5f69 6f6e  tilt_flat_to_ion
+00008dd0: 290a 0a20 2020 2020 2020 2073 7461 6765  )..        stage
+00008de0: 5f70 7265 7469 6c74 203d 206e 702e 6465  _pretilt = np.de
+00008df0: 6732 7261 6428 7365 6c66 2e73 7461 6765  g2rad(self.stage
+00008e00: 5f73 6574 7469 6e67 732e 7072 655f 7469  _settings.pre_ti
+00008e10: 6c74 290a 0a20 2020 2020 2020 2073 7461  lt)..        sta
+00008e20: 6765 5f72 6f74 6174 696f 6e5f 666c 6174  ge_rotation_flat
+00008e30: 5f74 6f5f 6562 203d 206e 702e 6465 6732  _to_eb = np.deg2
+00008e40: 7261 6428 0a20 2020 2020 2020 2020 2020  rad(.           
+00008e50: 2073 656c 662e 7374 6167 655f 7365 7474   self.stage_sett
+00008e60: 696e 6773 2e72 6f74 6174 696f 6e5f 666c  ings.rotation_fl
+00008e70: 6174 5f74 6f5f 656c 6563 7472 6f6e 0a20  at_to_electron. 
+00008e80: 2020 2020 2020 2029 2025 2028 3220 2a20         ) % (2 * 
+00008e90: 6e70 2e70 6929 0a20 2020 2020 2020 2073  np.pi).        s
+00008ea0: 7461 6765 5f72 6f74 6174 696f 6e5f 666c  tage_rotation_fl
+00008eb0: 6174 5f74 6f5f 696f 6e20 3d20 6e70 2e64  at_to_ion = np.d
+00008ec0: 6567 3272 6164 280a 2020 2020 2020 2020  eg2rad(.        
+00008ed0: 2020 2020 7365 6c66 2e73 7461 6765 5f73      self.stage_s
+00008ee0: 6574 7469 6e67 732e 726f 7461 7469 6f6e  ettings.rotation
+00008ef0: 5f66 6c61 745f 746f 5f69 6f6e 0a20 2020  _flat_to_ion.   
+00008f00: 2020 2020 2029 2025 2028 3220 2a20 6e70       ) % (2 * np
+00008f10: 2e70 6929 0a0a 2020 2020 2020 2020 2320  .pi)..        # 
+00008f20: 6375 7272 656e 7420 7374 6167 6520 706f  current stage po
+00008f30: 7369 7469 6f6e 0a20 2020 2020 2020 2063  sition.        c
+00008f40: 7572 7265 6e74 5f73 7461 6765 5f70 6f73  urrent_stage_pos
+00008f50: 6974 696f 6e20 3d20 7365 6c66 2e67 6574  ition = self.get
+00008f60: 5f73 7461 6765 5f70 6f73 6974 696f 6e28  _stage_position(
+00008f70: 290a 2020 2020 2020 2020 7374 6167 655f  ).        stage_
+00008f80: 726f 7461 7469 6f6e 203d 2063 7572 7265  rotation = curre
+00008f90: 6e74 5f73 7461 6765 5f70 6f73 6974 696f  nt_stage_positio
+00008fa0: 6e2e 7220 2520 2832 202a 206e 702e 7069  n.r % (2 * np.pi
+00008fb0: 290a 2020 2020 2020 2020 7374 6167 655f  ).        stage_
+00008fc0: 7469 6c74 203d 2063 7572 7265 6e74 5f73  tilt = current_s
+00008fd0: 7461 6765 5f70 6f73 6974 696f 6e2e 740a  tage_position.t.
+00008fe0: 0a20 2020 2020 2020 2050 5245 5449 4c54  .        PRETILT
+00008ff0: 5f53 4947 4e20 3d20 312e 300a 2020 2020  _SIGN = 1.0.    
+00009000: 2020 2020 2320 7072 6574 696c 7420 616e      # pretilt an
+00009010: 676c 6520 6465 7065 6e64 7320 6f6e 2072  gle depends on r
+00009020: 6f74 6174 696f 6e0a 2020 2020 2020 2020  otation.        
+00009030: 6672 6f6d 2066 6962 7365 6d20 696d 706f  from fibsem impo
+00009040: 7274 206d 6f76 656d 656e 740a 2020 2020  rt movement.    
+00009050: 2020 2020 6966 206d 6f76 656d 656e 742e      if movement.
+00009060: 726f 7461 7469 6f6e 5f61 6e67 6c65 5f69  rotation_angle_i
+00009070: 735f 736d 616c 6c65 7228 7374 6167 655f  s_smaller(stage_
+00009080: 726f 7461 7469 6f6e 2c20 7374 6167 655f  rotation, stage_
+00009090: 726f 7461 7469 6f6e 5f66 6c61 745f 746f  rotation_flat_to
+000090a0: 5f65 622c 2061 746f 6c3d 3529 3a0a 2020  _eb, atol=5):.  
+000090b0: 2020 2020 2020 2020 2020 5052 4554 494c            PRETIL
+000090c0: 545f 5349 474e 203d 2031 2e30 0a20 2020  T_SIGN = 1.0.   
+000090d0: 2020 2020 2069 6620 6d6f 7665 6d65 6e74       if movement
+000090e0: 2e72 6f74 6174 696f 6e5f 616e 676c 655f  .rotation_angle_
+000090f0: 6973 5f73 6d61 6c6c 6572 280a 2020 2020  is_smaller(.    
+00009100: 2020 2020 2020 2020 7374 6167 655f 726f          stage_ro
+00009110: 7461 7469 6f6e 2c20 7374 6167 655f 726f  tation, stage_ro
+00009120: 7461 7469 6f6e 5f66 6c61 745f 746f 5f69  tation_flat_to_i
+00009130: 6f6e 2c20 6174 6f6c 3d35 0a20 2020 2020  on, atol=5.     
+00009140: 2020 2029 3a0a 2020 2020 2020 2020 2020     ):.          
+00009150: 2020 5052 4554 494c 545f 5349 474e 203d    PRETILT_SIGN =
+00009160: 202d 312e 300a 0a20 2020 2020 2020 2023   -1.0..        #
+00009170: 2063 6f72 7265 6374 6564 5f70 7265 7469   corrected_preti
+00009180: 6c74 5f61 6e67 6c65 203d 2050 5245 5449  lt_angle = PRETI
+00009190: 4c54 5f53 4947 4e20 2a20 7374 6167 655f  LT_SIGN * stage_
+000091a0: 7469 6c74 5f66 6c61 745f 746f 5f65 6c65  tilt_flat_to_ele
+000091b0: 6374 726f 6e0a 2020 2020 2020 2020 636f  ctron.        co
+000091c0: 7272 6563 7465 645f 7072 6574 696c 745f  rrected_pretilt_
+000091d0: 616e 676c 6520 3d20 5052 4554 494c 545f  angle = PRETILT_
+000091e0: 5349 474e 202a 2028 7374 6167 655f 7072  SIGN * (stage_pr
+000091f0: 6574 696c 7420 2b20 7374 6167 655f 7469  etilt + stage_ti
+00009200: 6c74 5f66 6c61 745f 746f 5f65 6c65 6374  lt_flat_to_elect
+00009210: 726f 6e29 2023 2065 6c65 6374 726f 6e20  ron) # electron 
+00009220: 616e 676c 6520 3d20 302c 2069 6f6e 203d  angle = 0, ion =
+00009230: 2035 320a 0a20 2020 2020 2020 2023 2070   52..        # p
+00009240: 6572 7370 6563 7469 7665 2074 696c 7420  erspective tilt 
+00009250: 6164 6a75 7374 6d65 6e74 2028 6469 6666  adjustment (diff
+00009260: 6572 656e 6365 2062 6574 7765 656e 2070  erence between p
+00009270: 6572 7370 6563 7469 7665 2076 6965 7720  erspective view 
+00009280: 616e 6420 7361 6d70 6c65 2063 6f6f 7264  and sample coord
+00009290: 696e 6174 6520 7379 7374 656d 290a 2020  inate system).  
+000092a0: 2020 2020 2020 6966 2062 6561 6d5f 7479        if beam_ty
+000092b0: 7065 203d 3d20 4265 616d 5479 7065 2e45  pe == BeamType.E
+000092c0: 4c45 4354 524f 4e3a 0a20 2020 2020 2020  LECTRON:.       
+000092d0: 2020 2020 2070 6572 7370 6563 7469 7665       perspective
+000092e0: 5f74 696c 745f 6164 6a75 7374 6d65 6e74  _tilt_adjustment
+000092f0: 203d 202d 636f 7272 6563 7465 645f 7072   = -corrected_pr
+00009300: 6574 696c 745f 616e 676c 650a 2020 2020  etilt_angle.    
+00009310: 2020 2020 2020 2020 5343 414c 455f 4641          SCALE_FA
+00009320: 4354 4f52 203d 2031 2e30 2020 2320 302e  CTOR = 1.0  # 0.
+00009330: 3738 3334 3220 2023 2070 6174 656e 7465  78342  # patente
+00009340: 6420 7465 6368 6e6f 6c6f 6779 0a20 2020  d technology.   
+00009350: 2020 2020 2065 6c69 6620 6265 616d 5f74       elif beam_t
+00009360: 7970 6520 3d3d 2042 6561 6d54 7970 652e  ype == BeamType.
+00009370: 494f 4e3a 0a20 2020 2020 2020 2020 2020  ION:.           
+00009380: 2070 6572 7370 6563 7469 7665 5f74 696c   perspective_til
+00009390: 745f 6164 6a75 7374 6d65 6e74 203d 2028  t_adjustment = (
+000093a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000093b0: 202d 636f 7272 6563 7465 645f 7072 6574   -corrected_pret
+000093c0: 696c 745f 616e 676c 6520 2d20 7374 6167  ilt_angle - stag
+000093d0: 655f 7469 6c74 5f66 6c61 745f 746f 5f69  e_tilt_flat_to_i
+000093e0: 6f6e 0a20 2020 2020 2020 2020 2020 2029  on.            )
+000093f0: 0a20 2020 2020 2020 2020 2020 2053 4341  .            SCA
+00009400: 4c45 5f46 4143 544f 5220 3d20 312e 300a  LE_FACTOR = 1.0.
+00009410: 0a20 2020 2020 2020 2023 2074 6865 2061  .        # the a
+00009420: 6d6f 756e 7420 7468 6520 7361 6d70 6c65  mount the sample
+00009430: 2068 6173 2074 6f20 6d6f 7665 2069 6e20   has to move in 
+00009440: 7468 6520 792d 6178 6973 0a20 2020 2020  the y-axis.     
+00009450: 2020 2079 5f73 616d 706c 655f 6d6f 7665     y_sample_move
+00009460: 203d 2028 6578 7065 6374 6564 5f79 202a   = (expected_y *
+00009470: 2053 4341 4c45 5f46 4143 544f 5229 202f   SCALE_FACTOR) /
+00009480: 206e 702e 636f 7328 0a20 2020 2020 2020   np.cos(.       
+00009490: 2020 2020 2073 7461 6765 5f74 696c 7420       stage_tilt 
+000094a0: 2b20 7065 7273 7065 6374 6976 655f 7469  + perspective_ti
+000094b0: 6c74 5f61 646a 7573 746d 656e 740a 2020  lt_adjustment.  
+000094c0: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
+000094d0: 2023 2061 6e67 6c65 2066 6f72 2061 646a   # angle for adj
+000094e0: 7573 7465 6d65 6e74 200a 2020 2020 2020  ustement .      
+000094f0: 2020 2320 616e 676c 6520 3d20 636f 7272    # angle = corr
+00009500: 6563 7465 645f 7072 6574 696c 745f 616e  ected_pretilt_an
+00009510: 676c 6520 2b20 7374 6167 655f 7469 6c74  gle + stage_tilt
+00009520: 202b 2070 6572 7370 6563 7469 7665 5f74   + perspective_t
+00009530: 696c 745f 6164 6a75 7374 6d65 6e74 0a20  ilt_adjustment. 
+00009540: 2020 2020 2020 2023 2079 5f73 616d 706c         # y_sampl
+00009550: 655f 6d6f 7665 203d 2028 6578 7065 6374  e_move = (expect
+00009560: 6564 5f79 202a 2053 4341 4c45 5f46 4143  ed_y * SCALE_FAC
+00009570: 544f 5229 202f 206e 702e 636f 7328 616e  TOR) / np.cos(an
+00009580: 676c 6529 0a0a 2020 2020 2020 2020 2320  gle)..        # 
+00009590: 7468 6520 616d 6f75 6e74 2074 6865 2073  the amount the s
+000095a0: 7461 6765 2068 6173 2074 6f20 6d6f 7665  tage has to move
+000095b0: 2069 6e20 6561 6368 2061 7869 730a 2020   in each axis.  
+000095c0: 2020 2020 2020 0a20 2020 2020 2020 2079        .        y
+000095d0: 5f6d 6f76 6520 3d20 795f 7361 6d70 6c65  _move = y_sample
+000095e0: 5f6d 6f76 6520 2a20 6e70 2e63 6f73 2863  _move * np.cos(c
+000095f0: 6f72 7265 6374 6564 5f70 7265 7469 6c74  orrected_pretilt
+00009600: 5f61 6e67 6c65 290a 2020 2020 2020 2020  _angle).        
+00009610: 7a5f 6d6f 7665 203d 202d 795f 7361 6d70  z_move = -y_samp
+00009620: 6c65 5f6d 6f76 6520 2a20 6e70 2e73 696e  le_move * np.sin
+00009630: 2863 6f72 7265 6374 6564 5f70 7265 7469  (corrected_preti
+00009640: 6c74 5f61 6e67 6c65 2920 2354 4f44 4f3a  lt_angle) #TODO:
+00009650: 2069 6e76 6573 7469 6761 7465 2074 6869   investigate thi
+00009660: 730a 0a20 2020 2020 2020 2072 6574 7572  s..        retur
+00009670: 6e20 4669 6273 656d 5374 6167 6550 6f73  n FibsemStagePos
+00009680: 6974 696f 6e28 783d 302c 2079 3d79 5f6d  ition(x=0, y=y_m
+00009690: 6f76 652c 207a 3d7a 5f6d 6f76 6529 0a0a  ove, z=z_move)..
+000096a0: 2020 2020 6465 6620 6d6f 7665 5f66 6c61      def move_fla
+000096b0: 745f 746f 5f62 6561 6d28 0a20 2020 2020  t_to_beam(.     
+000096c0: 2020 2073 656c 662c 2073 6574 7469 6e67     self, setting
+000096d0: 733a 204d 6963 726f 7363 6f70 6553 6574  s: MicroscopeSet
+000096e0: 7469 6e67 732c 2062 6561 6d5f 7479 7065  tings, beam_type
+000096f0: 3a20 4265 616d 5479 7065 203d 2042 6561  : BeamType = Bea
+00009700: 6d54 7970 652e 454c 4543 5452 4f4e 0a20  mType.ELECTRON. 
+00009710: 2020 2029 202d 3e20 4e6f 6e65 3a0a 2020     ) -> None:.  
+00009720: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+00009730: 2020 4d6f 7665 7320 7468 6520 6d69 6372    Moves the micr
+00009740: 6f73 636f 7065 2073 7461 6765 2074 6f20  oscope stage to 
+00009750: 7468 6520 7469 6c74 2061 6e67 6c65 2063  the tilt angle c
+00009760: 6f72 7265 7370 6f6e 6469 6e67 2074 6f20  orresponding to 
+00009770: 7468 6520 6769 7665 6e20 6265 616d 2074  the given beam t
+00009780: 7970 652c 0a20 2020 2020 2020 2073 6f20  ype,.        so 
+00009790: 7468 6174 2074 6865 2073 7461 6765 2069  that the stage i
+000097a0: 7320 666c 6174 2077 6974 6820 7265 7370  s flat with resp
+000097b0: 6563 7420 746f 2074 6865 2062 6561 6d2e  ect to the beam.
+000097c0: 0a0a 2020 2020 2020 2020 4172 6773 3a0a  ..        Args:.
+000097d0: 2020 2020 2020 2020 2020 2020 7365 7474              sett
+000097e0: 696e 6773 2028 4d69 6372 6f73 636f 7065  ings (Microscope
+000097f0: 5365 7474 696e 6773 293a 2054 6865 2063  Settings): The c
+00009800: 7572 7265 6e74 206d 6963 726f 7363 6f70  urrent microscop
+00009810: 6520 7365 7474 696e 6773 2e0a 2020 2020  e settings..    
+00009820: 2020 2020 2020 2020 6265 616d 5f74 7970          beam_typ
+00009830: 6520 2842 6561 6d54 7970 6529 3a20 5468  e (BeamType): Th
+00009840: 6520 7479 7065 206f 6620 6265 616d 2074  e type of beam t
+00009850: 6f20 7768 6963 6820 7468 6520 7374 6167  o which the stag
+00009860: 6520 7368 6f75 6c64 2062 6520 6d61 6465  e should be made
+00009870: 2066 6c61 742e 0a20 2020 2020 2020 2020   flat..         
+00009880: 2020 2020 2020 204d 7573 7420 6265 206f         Must be o
+00009890: 6e65 206f 6620 4265 616d 5479 7065 2e45  ne of BeamType.E
+000098a0: 4c45 4354 524f 4e20 6f72 2042 6561 6d54  LECTRON or BeamT
+000098b0: 7970 652e 494f 4e2e 0a0a 2020 2020 2020  ype.ION...      
+000098c0: 2020 5265 7475 726e 733a 0a20 2020 2020    Returns:.     
+000098d0: 2020 2020 2020 204e 6f6e 652e 0a20 2020         None..   
+000098e0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+000098f0: 205f 6368 6563 6b5f 7374 6167 6528 7365   _check_stage(se
+00009900: 6c66 2e68 6172 6477 6172 655f 7365 7474  lf.hardware_sett
+00009910: 696e 6773 2c20 7469 6c74 3d54 7275 6529  ings, tilt=True)
+00009920: 0a20 2020 2020 2020 2073 7461 6765 5f73  .        stage_s
+00009930: 6574 7469 6e67 7320 3d20 7365 6c66 2e73  ettings = self.s
+00009940: 7461 6765 5f73 6574 7469 6e67 730a 0a20  tage_settings.. 
+00009950: 2020 2020 2020 2069 6620 6265 616d 5f74         if beam_t
+00009960: 7970 6520 6973 2042 6561 6d54 7970 652e  ype is BeamType.
+00009970: 454c 4543 5452 4f4e 3a0a 2020 2020 2020  ELECTRON:.      
+00009980: 2020 2020 2020 726f 7461 7469 6f6e 203d        rotation =
+00009990: 206e 702e 6465 6732 7261 6428 7374 6167   np.deg2rad(stag
+000099a0: 655f 7365 7474 696e 6773 2e72 6f74 6174  e_settings.rotat
+000099b0: 696f 6e5f 666c 6174 5f74 6f5f 656c 6563  ion_flat_to_elec
+000099c0: 7472 6f6e 290a 2020 2020 2020 2020 2020  tron).          
+000099d0: 2020 7469 6c74 203d 206e 702e 6465 6732    tilt = np.deg2
+000099e0: 7261 6428 7374 6167 655f 7365 7474 696e  rad(stage_settin
+000099f0: 6773 2e70 7265 5f74 696c 7429 0a0a 2020  gs.pre_tilt)..  
+00009a00: 2020 2020 2020 6966 2062 6561 6d5f 7479        if beam_ty
+00009a10: 7065 2069 7320 4265 616d 5479 7065 2e49  pe is BeamType.I
+00009a20: 4f4e 3a0a 2020 2020 2020 2020 2020 2020  ON:.            
+00009a30: 726f 7461 7469 6f6e 203d 206e 702e 6465  rotation = np.de
+00009a40: 6732 7261 6428 7374 6167 655f 7365 7474  g2rad(stage_sett
+00009a50: 696e 6773 2e72 6f74 6174 696f 6e5f 666c  ings.rotation_fl
+00009a60: 6174 5f74 6f5f 696f 6e29 0a20 2020 2020  at_to_ion).     
+00009a70: 2020 2020 2020 2074 696c 7420 3d20 6e70         tilt = np
+00009a80: 2e64 6567 3272 6164 280a 2020 2020 2020  .deg2rad(.      
+00009a90: 2020 2020 2020 2020 2020 7374 6167 655f            stage_
+00009aa0: 7365 7474 696e 6773 2e74 696c 745f 666c  settings.tilt_fl
+00009ab0: 6174 5f74 6f5f 696f 6e20 2d20 7374 6167  at_to_ion - stag
+00009ac0: 655f 7365 7474 696e 6773 2e70 7265 5f74  e_settings.pre_t
+00009ad0: 696c 740a 2020 2020 2020 2020 2020 2020  ilt.            
+00009ae0: 290a 0a20 2020 2020 2020 2070 6f73 6974  )..        posit
+00009af0: 696f 6e20 3d20 7365 6c66 2e67 6574 5f73  ion = self.get_s
+00009b00: 7461 6765 5f70 6f73 6974 696f 6e28 290a  tage_position().
+00009b10: 0a20 2020 2020 2020 2023 2075 7064 6174  .        # updat
+00009b20: 6564 2073 6166 6520 726f 7461 7469 6f6e  ed safe rotation
+00009b30: 206d 6f76 650a 2020 2020 2020 2020 6c6f   move.        lo
+00009b40: 6767 696e 672e 696e 666f 2866 226d 6f76  gging.info(f"mov
+00009b50: 696e 6720 666c 6174 2074 6f20 7b62 6561  ing flat to {bea
+00009b60: 6d5f 7479 7065 2e6e 616d 657d 2229 0a20  m_type.name}"). 
+00009b70: 2020 2020 2020 2073 7461 6765 5f70 6f73         stage_pos
+00009b80: 6974 696f 6e20 3d20 4669 6273 656d 5374  ition = FibsemSt
+00009b90: 6167 6550 6f73 6974 696f 6e28 723d 726f  agePosition(r=ro
+00009ba0: 7461 7469 6f6e 2c20 743d 7469 6c74 290a  tation, t=tilt).
+00009bb0: 2020 2020 2020 2020 7365 6c66 2e5f 7361          self._sa
+00009bc0: 6665 5f61 6273 6f6c 7574 655f 7374 6167  fe_absolute_stag
+00009bd0: 655f 6d6f 7665 6d65 6e74 2873 7461 6765  e_movement(stage
+00009be0: 5f70 6f73 6974 696f 6e29 0a0a 2020 2020  _position)..    
+00009bf0: 0a20 2020 2064 6566 205f 7361 6665 5f72  .    def _safe_r
+00009c00: 6f74 6174 696f 6e5f 6d6f 7665 6d65 6e74  otation_movement
+00009c10: 280a 2020 2020 2020 2020 7365 6c66 2c20  (.        self, 
+00009c20: 7374 6167 655f 706f 7369 7469 6f6e 3a20  stage_position: 
+00009c30: 4669 6273 656d 5374 6167 6550 6f73 6974  FibsemStagePosit
+00009c40: 696f 6e0a 2020 2020 293a 0a20 2020 2020  ion.    ):.     
+00009c50: 2020 2022 2222 5469 6c74 2074 6865 2073     """Tilt the s
+00009c60: 7461 6765 2066 6c61 7420 7768 656e 2070  tage flat when p
+00009c70: 6572 666f 726d 696e 6720 6120 6c61 7267  erforming a larg
+00009c80: 6520 726f 7461 7469 6f6e 2074 6f20 7072  e rotation to pr
+00009c90: 6576 656e 7420 636f 6c6c 6973 696f 6e2e  event collision.
+00009ca0: 0a0a 2020 2020 2020 2020 4172 6773 3a0a  ..        Args:.
+00009cb0: 2020 2020 2020 2020 2020 2020 7374 6167              stag
+00009cc0: 655f 706f 7369 7469 6f6e 2028 5374 6167  e_position (Stag
+00009cd0: 6550 6f73 6974 696f 6e29 3a20 6465 7369  ePosition): desi
+00009ce0: 7265 6420 7374 6167 6520 706f 7369 7469  red stage positi
+00009cf0: 6f6e 2e0a 2020 2020 2020 2020 2222 220a  on..        """.
+00009d00: 2020 2020 2020 2020 6375 7272 656e 745f          current_
+00009d10: 706f 7369 7469 6f6e 203d 2073 656c 662e  position = self.
+00009d20: 6765 745f 7374 6167 655f 706f 7369 7469  get_stage_positi
+00009d30: 6f6e 2829 0a0a 2020 2020 2020 2020 2320  on()..        # 
+00009d40: 7469 6c74 2066 6c61 7420 666f 7220 6c61  tilt flat for la
+00009d50: 7267 6520 726f 7461 7469 6f6e 7320 746f  rge rotations to
+00009d60: 2070 7265 7665 6e74 2063 6f6c 6c69 7369   prevent collisi
+00009d70: 6f6e 730a 2020 2020 2020 2020 6672 6f6d  ons.        from
+00009d80: 2066 6962 7365 6d20 696d 706f 7274 206d   fibsem import m
+00009d90: 6f76 656d 656e 740a 2020 2020 2020 2020  ovement.        
+00009da0: 6966 206d 6f76 656d 656e 742e 726f 7461  if movement.rota
+00009db0: 7469 6f6e 5f61 6e67 6c65 5f69 735f 6c61  tion_angle_is_la
+00009dc0: 7267 6572 2873 7461 6765 5f70 6f73 6974  rger(stage_posit
+00009dd0: 696f 6e2e 722c 2063 7572 7265 6e74 5f70  ion.r, current_p
+00009de0: 6f73 6974 696f 6e2e 7229 3a0a 0a20 2020  osition.r):..   
+00009df0: 2020 2020 2020 2020 2073 656c 662e 6d6f           self.mo
+00009e00: 7665 5f73 7461 6765 5f61 6273 6f6c 7574  ve_stage_absolut
+00009e10: 6528 4669 6273 656d 5374 6167 6550 6f73  e(FibsemStagePos
+00009e20: 6974 696f 6e28 743d 3029 290a 2020 2020  ition(t=0)).    
+00009e30: 2020 2020 2020 2020 6c6f 6767 696e 672e          logging.
+00009e40: 696e 666f 2866 2274 696c 7469 6e67 2074  info(f"tilting t
+00009e50: 6f20 666c 6174 2066 6f72 206c 6172 6765  o flat for large
+00009e60: 2072 6f74 6174 696f 6e2e 2229 0a0a 2020   rotation.")..  
+00009e70: 2020 2020 2020 7265 7475 726e 0a0a 0a20        return... 
+00009e80: 2020 2064 6566 205f 7361 6665 5f61 6273     def _safe_abs
+00009e90: 6f6c 7574 655f 7374 6167 655f 6d6f 7665  olute_stage_move
+00009ea0: 6d65 6e74 2873 656c 662c 2073 7461 6765  ment(self, stage
+00009eb0: 5f70 6f73 6974 696f 6e3a 2046 6962 7365  _position: Fibse
+00009ec0: 6d53 7461 6765 506f 7369 7469 6f6e 0a20  mStagePosition. 
+00009ed0: 2020 2029 202d 3e20 4e6f 6e65 3a0a 2020     ) -> None:.  
+00009ee0: 2020 2020 2020 2222 224d 6f76 6520 7468        """Move th
+00009ef0: 6520 7374 6167 6520 746f 2074 6865 2064  e stage to the d
+00009f00: 6573 6972 6564 2070 6f73 6974 696f 6e20  esired position 
+00009f10: 696e 2061 2073 6166 6520 6d61 6e6e 6572  in a safe manner
+00009f20: 2c20 7573 696e 6720 636f 6d70 7563 656e  , using compucen
+00009f30: 7472 6963 2072 6f74 6174 696f 6e2e 0a20  tric rotation.. 
+00009f40: 2020 2020 2020 2053 7570 706f 7274 7320         Supports 
+00009f50: 6d6f 7665 6d65 6e74 7320 696e 2074 6865  movements in the
+00009f60: 2073 7461 6765 5f70 6f73 6974 696f 6e20   stage_position 
+00009f70: 636f 6f72 6469 6e61 7465 2073 7973 7465  coordinate syste
+00009f80: 6d0a 0a20 2020 2020 2020 2022 2222 0a0a  m..        """..
+00009f90: 2020 2020 2020 2020 2320 7469 6c74 2066          # tilt f
+00009fa0: 6c61 7420 666f 7220 6c61 7267 6520 726f  lat for large ro
+00009fb0: 7461 7469 6f6e 7320 746f 2070 7265 7665  tations to preve
+00009fc0: 6e74 2063 6f6c 6c69 7369 6f6e 730a 2020  nt collisions.  
+00009fd0: 2020 2020 2020 7365 6c66 2e5f 7361 6665        self._safe
+00009fe0: 5f72 6f74 6174 696f 6e5f 6d6f 7665 6d65  _rotation_moveme
+00009ff0: 6e74 2873 7461 6765 5f70 6f73 6974 696f  nt(stage_positio
+0000a000: 6e29 0a0a 2020 2020 2020 2020 2320 6d6f  n)..        # mo
+0000a010: 7665 2074 6f20 636f 6d70 7563 656e 7472  ve to compucentr
+0000a020: 6963 2072 6f74 6174 696f 6e0a 2020 2020  ic rotation.    
+0000a030: 2020 2020 7365 6c66 2e6d 6f76 655f 7374      self.move_st
+0000a040: 6167 655f 6162 736f 6c75 7465 2846 6962  age_absolute(Fib
+0000a050: 7365 6d53 7461 6765 506f 7369 7469 6f6e  semStagePosition
+0000a060: 2872 3d73 7461 6765 5f70 6f73 6974 696f  (r=stage_positio
+0000a070: 6e2e 7229 290a 0a20 2020 2020 2020 206c  n.r))..        l
+0000a080: 6f67 6769 6e67 2e69 6e66 6f28 6622 7361  ogging.info(f"sa
+0000a090: 6665 206d 6f76 696e 6720 746f 207b 7374  fe moving to {st
+0000a0a0: 6167 655f 706f 7369 7469 6f6e 7d22 290a  age_position}").
+0000a0b0: 2020 2020 2020 2020 7365 6c66 2e6d 6f76          self.mov
+0000a0c0: 655f 7374 6167 655f 6162 736f 6c75 7465  e_stage_absolute
+0000a0d0: 2873 7461 6765 5f70 6f73 6974 696f 6e29  (stage_position)
+0000a0e0: 0a0a 2020 2020 2020 2020 6c6f 6767 696e  ..        loggin
+0000a0f0: 672e 696e 666f 2866 2273 6166 6520 6d6f  g.info(f"safe mo
+0000a100: 7665 6d65 6e74 2063 6f6d 706c 6574 652e  vement complete.
+0000a110: 2229 0a0a 2020 2020 2020 2020 7265 7475  ")..        retu
+0000a120: 726e 0a0a 2020 2020 6465 6620 5f63 616c  rn..    def _cal
+0000a130: 6375 6c61 7465 5f6e 6577 5f70 6f73 6974  culate_new_posit
+0000a140: 696f 6e28 7365 6c66 2c20 7365 7474 696e  ion(self, settin
+0000a150: 6773 3a20 4d69 6372 6f73 636f 7065 5365  gs: MicroscopeSe
+0000a160: 7474 696e 6773 2c20 0a20 2020 2020 2020  ttings, .       
+0000a170: 2064 783a 666c 6f61 742c 2064 793a 666c   dx:float, dy:fl
+0000a180: 6f61 742c 200a 2020 2020 2020 2020 6265  oat, .        be
+0000a190: 616d 5f74 7970 653a 4265 616d 5479 7065  am_type:BeamType
+0000a1a0: 2c20 0a20 2020 2020 2020 2062 6173 655f  , .        base_
+0000a1b0: 706f 7369 7469 6f6e 3a46 6962 7365 6d53  position:FibsemS
+0000a1c0: 7461 6765 506f 7369 7469 6f6e 2920 2d3e  tagePosition) ->
+0000a1d0: 2046 6962 7365 6d53 7461 6765 506f 7369   FibsemStagePosi
+0000a1e0: 7469 6f6e 3a0a 0a20 2020 2020 2020 2023  tion:..        #
+0000a1f0: 2073 7461 626c 652d 6d6f 7665 2d70 726f   stable-move-pro
+0000a200: 6a65 6374 696f 6e0a 2020 2020 2020 2020  jection.        
+0000a210: 706f 696e 745f 797a 203d 2073 656c 662e  point_yz = self.
+0000a220: 5f79 5f63 6f72 7265 6374 6564 5f73 7461  _y_corrected_sta
+0000a230: 6765 5f6d 6f76 656d 656e 7428 7365 7474  ge_movement(sett
+0000a240: 696e 6773 2c20 6479 2c20 6265 616d 5f74  ings, dy, beam_t
+0000a250: 7970 6529 0a20 2020 2020 2020 2064 792c  ype).        dy,
+0000a260: 2064 7a20 3d20 706f 696e 745f 797a 2e79   dz = point_yz.y
+0000a270: 2c20 706f 696e 745f 797a 2e7a 0a0a 2020  , point_yz.z..  
+0000a280: 2020 2020 2020 2320 6361 6c63 756c 6174        # calculat
+0000a290: 6520 7468 6520 636f 7272 6563 7465 6420  e the corrected 
+0000a2a0: 6d6f 7665 2074 6f20 7265 6163 6820 7468  move to reach th
+0000a2b0: 6174 2070 6f69 6e74 2066 726f 6d20 6261  at point from ba
+0000a2c0: 7365 2d73 7461 7465 3f0a 2020 2020 2020  se-state?.      
+0000a2d0: 2020 5f6e 6577 5f70 6f73 6974 696f 6e20    _new_position 
+0000a2e0: 3d20 6465 6570 636f 7079 2862 6173 655f  = deepcopy(base_
+0000a2f0: 706f 7369 7469 6f6e 290a 2020 2020 2020  position).      
+0000a300: 2020 5f6e 6577 5f70 6f73 6974 696f 6e2e    _new_position.
+0000a310: 7820 2b3d 2064 780a 2020 2020 2020 2020  x += dx.        
+0000a320: 5f6e 6577 5f70 6f73 6974 696f 6e2e 7920  _new_position.y 
+0000a330: 2b3d 2064 790a 2020 2020 2020 2020 5f6e  += dy.        _n
+0000a340: 6577 5f70 6f73 6974 696f 6e2e 7a20 2b3d  ew_position.z +=
+0000a350: 2064 7a0a 0a20 2020 2020 2020 2072 6574   dz..        ret
+0000a360: 7572 6e20 5f6e 6577 5f70 6f73 6974 696f  urn _new_positio
+0000a370: 6e0a 0a20 2020 2064 6566 2067 6574 5f6d  n..    def get_m
+0000a380: 616e 6970 756c 6174 6f72 5f73 7461 7465  anipulator_state
+0000a390: 2873 656c 662c 7365 7474 696e 6773 3a4d  (self,settings:M
+0000a3a0: 6963 726f 7363 6f70 6553 6574 7469 6e67  icroscopeSetting
+0000a3b0: 733d 4e6f 6e65 293a 0a0a 2020 2020 2020  s=None):..      
+0000a3c0: 2020 7374 6174 6520 3d20 7365 6c66 2e63    state = self.c
+0000a3d0: 6f6e 6e65 6374 696f 6e2e 7370 6563 696d  onnection.specim
+0000a3e0: 656e 2e6d 616e 6970 756c 6174 6f72 2e73  en.manipulator.s
+0000a3f0: 7461 7465 0a0a 2020 2020 2020 2020 7265  tate..        re
+0000a400: 7475 726e 2054 7275 6520 6966 2073 7461  turn True if sta
+0000a410: 7465 203d 3d20 4d61 6e69 7075 6c61 746f  te == Manipulato
+0000a420: 7253 7461 7465 2e49 4e53 4552 5445 4420  rState.INSERTED 
+0000a430: 656c 7365 2046 616c 7365 0a0a 2020 2020  else False..    
+0000a440: 6465 6620 6765 745f 6d61 6e69 7075 6c61  def get_manipula
+0000a450: 746f 725f 706f 7369 7469 6f6e 2873 656c  tor_position(sel
+0000a460: 6629 202d 3e20 4669 6273 656d 4d61 6e69  f) -> FibsemMani
+0000a470: 7075 6c61 746f 7250 6f73 6974 696f 6e3a  pulatorPosition:
+0000a480: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
+0000a490: 2e68 6172 6477 6172 655f 7365 7474 696e  .hardware_settin
+0000a4a0: 6773 2e6d 616e 6970 756c 6174 6f72 5f65  gs.manipulator_e
+0000a4b0: 6e61 626c 6564 2069 7320 4661 6c73 653a  nabled is False:
+0000a4c0: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
+0000a4d0: 7365 204e 6f74 496d 706c 656d 656e 7465  se NotImplemente
+0000a4e0: 6445 7272 6f72 2822 4d61 6e69 7075 6c61  dError("Manipula
+0000a4f0: 746f 7220 6e6f 7420 656e 6162 6c65 642e  tor not enabled.
+0000a500: 2229 0a20 2020 2020 2020 2070 6f73 6974  ").        posit
+0000a510: 696f 6e20 3d20 7365 6c66 2e63 6f6e 6e65  ion = self.conne
+0000a520: 6374 696f 6e2e 7370 6563 696d 656e 2e6d  ction.specimen.m
+0000a530: 616e 6970 756c 6174 6f72 2e63 7572 7265  anipulator.curre
+0000a540: 6e74 5f70 6f73 6974 696f 6e0a 2020 2020  nt_position.    
+0000a550: 2020 2020 7265 7475 726e 2046 6962 7365      return Fibse
+0000a560: 6d4d 616e 6970 756c 6174 6f72 506f 7369  mManipulatorPosi
+0000a570: 7469 6f6e 2e66 726f 6d5f 6175 746f 7363  tion.from_autosc
+0000a580: 7269 7074 5f70 6f73 6974 696f 6e28 706f  ript_position(po
+0000a590: 7369 7469 6f6e 290a 2020 2020 0a20 2020  sition).    .   
+0000a5a0: 2064 6566 2069 6e73 6572 745f 6d61 6e69   def insert_mani
+0000a5b0: 7075 6c61 746f 7228 7365 6c66 2c20 6e61  pulator(self, na
+0000a5c0: 6d65 3a20 7374 7220 3d20 2250 4152 4b22  me: str = "PARK"
+0000a5d0: 293a 0a20 2020 2020 2020 2069 6620 7365  ):.        if se
+0000a5e0: 6c66 2e68 6172 6477 6172 655f 7365 7474  lf.hardware_sett
+0000a5f0: 696e 6773 2e6d 616e 6970 756c 6174 6f72  ings.manipulator
+0000a600: 5f65 6e61 626c 6564 2069 7320 4661 6c73  _enabled is Fals
+0000a610: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
+0000a620: 6169 7365 204e 6f74 496d 706c 656d 656e  aise NotImplemen
+0000a630: 7465 6445 7272 6f72 2822 4d61 6e69 7075  tedError("Manipu
+0000a640: 6c61 746f 7220 6e6f 7420 656e 6162 6c65  lator not enable
+0000a650: 642e 2229 0a20 2020 2020 2020 2020 0a20  d.").         . 
+0000a660: 2020 2020 2020 2069 6620 6e61 6d65 206e         if name n
+0000a670: 6f74 2069 6e20 5b22 5041 524b 222c 2022  ot in ["PARK", "
+0000a680: 4555 4345 4e54 5249 4322 5d3a 0a20 2020  EUCENTRIC"]:.   
+0000a690: 2020 2020 2020 2020 2072 6169 7365 2056           raise V
+0000a6a0: 616c 7565 4572 726f 7228 6622 696e 7365  alueError(f"inse
+0000a6b0: 7274 2070 6f73 6974 696f 6e20 7b6e 616d  rt position {nam
+0000a6c0: 657d 206e 6f74 2073 7570 706f 7274 6564  e} not supported
+0000a6d0: 2e22 290a 0a20 2020 2020 2020 2069 6e73  .")..        ins
+0000a6e0: 6572 745f 706f 7369 7469 6f6e 203d 204d  ert_position = M
+0000a6f0: 616e 6970 756c 6174 6f72 5361 7665 6450  anipulatorSavedP
+0000a700: 6f73 6974 696f 6e2e 5041 524b 2069 6620  osition.PARK if 
+0000a710: 6e61 6d65 203d 3d20 2250 4152 4b22 2065  name == "PARK" e
+0000a720: 6c73 6520 4d61 6e69 7075 6c61 746f 7253  lse ManipulatorS
+0000a730: 6176 6564 506f 7369 7469 6f6e 2e45 5543  avedPosition.EUC
+0000a740: 454e 5452 4943 0a20 2020 2020 2020 206e  ENTRIC.        n
+0000a750: 6565 646c 6520 3d20 7365 6c66 2e63 6f6e  eedle = self.con
+0000a760: 6e65 6374 696f 6e2e 7370 6563 696d 656e  nection.specimen
+0000a770: 2e6d 616e 6970 756c 6174 6f72 0a20 2020  .manipulator.   
+0000a780: 2020 2020 2069 6e73 6572 745f 706f 7369       insert_posi
+0000a790: 7469 6f6e 203d 206e 6565 646c 652e 6765  tion = needle.ge
+0000a7a0: 745f 7361 7665 645f 706f 7369 7469 6f6e  t_saved_position
+0000a7b0: 280a 2020 2020 2020 2020 2020 2020 696e  (.            in
+0000a7c0: 7365 7274 5f70 6f73 6974 696f 6e2c 204d  sert_position, M
+0000a7d0: 616e 6970 756c 6174 6f72 436f 6f72 6469  anipulatorCoordi
+0000a7e0: 6e61 7465 5379 7374 656d 2e52 4157 0a20  nateSystem.RAW. 
+0000a7f0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+0000a800: 206e 6565 646c 652e 696e 7365 7274 2869   needle.insert(i
+0000a810: 6e73 6572 745f 706f 7369 7469 6f6e 290a  nsert_position).
+0000a820: 2020 2020 2020 2020 6c6f 6767 696e 672e          logging.
+0000a830: 696e 666f 2866 2269 6e73 6572 7465 6420  info(f"inserted 
+0000a840: 6e65 6564 6c65 2074 6f20 7b69 6e73 6572  needle to {inser
+0000a850: 745f 706f 7369 7469 6f6e 7d2e 2229 0a0a  t_position}.")..
+0000a860: 2020 2020 0a20 2020 2064 6566 2072 6574      .    def ret
+0000a870: 7261 6374 5f6d 616e 6970 756c 6174 6f72  ract_manipulator
+0000a880: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+0000a890: 0a20 2020 2020 2020 2023 2072 6574 7261  .        # retra
+0000a8a0: 6374 206d 756c 7469 6368 656d 0a20 2020  ct multichem.   
+0000a8b0: 2020 2020 2023 2072 6574 7261 6374 5f6d       # retract_m
+0000a8c0: 756c 7469 6368 656d 286d 6963 726f 7363  ultichem(microsc
+0000a8d0: 6f70 6529 2023 2054 4f44 4f3a 3f0a 2020  ope) # TODO:?.  
+0000a8e0: 2020 2020 2020 6966 2073 656c 662e 6861        if self.ha
+0000a8f0: 7264 7761 7265 5f73 6574 7469 6e67 732e  rdware_settings.
+0000a900: 6d61 6e69 7075 6c61 746f 725f 656e 6162  manipulator_enab
+0000a910: 6c65 6420 6973 2046 616c 7365 3a0a 2020  led is False:.  
+0000a920: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+0000a930: 4e6f 7449 6d70 6c65 6d65 6e74 6564 4572  NotImplementedEr
+0000a940: 726f 7228 224d 616e 6970 756c 6174 6f72  ror("Manipulator
+0000a950: 206e 6f74 2065 6e61 626c 6564 2e22 290a   not enabled.").
+0000a960: 2020 2020 2020 2020 2320 5265 7472 6163          # Retrac
+0000a970: 7420 7468 6520 6e65 6564 6c65 2c20 7072  t the needle, pr
+0000a980: 6573 6572 7669 6e67 2074 6865 2063 6f72  eserving the cor
+0000a990: 7265 6374 2070 6172 6b69 6e67 2070 6f73  rect parking pos
+0000a9a0: 7469 696f 6e0a 2020 2020 2020 2020 6e65  tiion.        ne
+0000a9b0: 6564 6c65 203d 2073 656c 662e 636f 6e6e  edle = self.conn
+0000a9c0: 6563 7469 6f6e 2e73 7065 6369 6d65 6e2e  ection.specimen.
+0000a9d0: 6d61 6e69 7075 6c61 746f 720a 2020 2020  manipulator.    
+0000a9e0: 2020 2020 7061 726b 5f70 6f73 6974 696f      park_positio
+0000a9f0: 6e20 3d20 6e65 6564 6c65 2e67 6574 5f73  n = needle.get_s
+0000aa00: 6176 6564 5f70 6f73 6974 696f 6e28 0a20  aved_position(. 
+0000aa10: 2020 2020 2020 2020 2020 204d 616e 6970             Manip
+0000aa20: 756c 6174 6f72 5361 7665 6450 6f73 6974  ulatorSavedPosit
+0000aa30: 696f 6e2e 5041 524b 2c20 4d61 6e69 7075  ion.PARK, Manipu
+0000aa40: 6c61 746f 7243 6f6f 7264 696e 6174 6553  latorCoordinateS
+0000aa50: 7973 7465 6d2e 5241 570a 2020 2020 2020  ystem.RAW.      
+0000aa60: 2020 290a 0a20 2020 2020 2020 206c 6f67    )..        log
+0000aa70: 6769 6e67 2e69 6e66 6f28 6622 7265 7472  ging.info(f"retr
+0000aa80: 6163 7469 6e67 206e 6565 646c 6520 746f  acting needle to
+0000aa90: 207b 7061 726b 5f70 6f73 6974 696f 6e7d   {park_position}
+0000aaa0: 2229 0a20 2020 2020 2020 206e 6565 646c  ").        needl
+0000aab0: 652e 6162 736f 6c75 7465 5f6d 6f76 6528  e.absolute_move(
+0000aac0: 7061 726b 5f70 6f73 6974 696f 6e29 0a20  park_position). 
+0000aad0: 2020 2020 2020 2074 696d 652e 736c 6565         time.slee
+0000aae0: 7028 3129 2020 2320 4175 746f 5363 7269  p(1)  # AutoScri
+0000aaf0: 7074 2073 6f6d 6574 696d 6573 2074 6872  pt sometimes thr
+0000ab00: 6f77 7320 6572 726f 7273 2069 6620 796f  ows errors if yo
+0000ab10: 7520 7265 7472 6163 7420 746f 6f20 7175  u retract too qu
+0000ab20: 6963 6b3f 0a20 2020 2020 2020 206c 6f67  ick?.        log
+0000ab30: 6769 6e67 2e69 6e66 6f28 6622 7265 7472  ging.info(f"retr
+0000ab40: 6163 7469 6e67 206e 6565 646c 652e 2e2e  acting needle...
+0000ab50: 2229 0a20 2020 2020 2020 206e 6565 646c  ").        needl
+0000ab60: 652e 7265 7472 6163 7428 290a 2020 2020  e.retract().    
+0000ab70: 2020 2020 6c6f 6767 696e 672e 696e 666f      logging.info
+0000ab80: 2866 2272 6574 7261 6374 206e 6565 646c  (f"retract needl
+0000ab90: 6520 636f 6d70 6c65 7465 2229 0a20 2020  e complete").   
+0000aba0: 200a 2020 2020 6465 6620 6d6f 7665 5f6d   .    def move_m
+0000abb0: 616e 6970 756c 6174 6f72 5f72 656c 6174  anipulator_relat
+0000abc0: 6976 6528 7365 6c66 2c20 706f 7369 7469  ive(self, positi
+0000abd0: 6f6e 3a20 4669 6273 656d 4d61 6e69 7075  on: FibsemManipu
+0000abe0: 6c61 746f 7250 6f73 6974 696f 6e29 3a0a  latorPosition):.
+0000abf0: 2020 2020 2020 2020 6966 206e 6f74 206e          if not n
+0000ac00: 702e 6973 636c 6f73 6528 706f 7369 7469  p.isclose(positi
+0000ac10: 6f6e 2e72 2c20 302e 3029 3a0a 2020 2020  on.r, 0.0):.    
+0000ac20: 2020 2020 2020 2020 726f 7461 7469 6f6e          rotation
+0000ac30: 203d 2054 7275 650a 2020 2020 2020 2020   = True.        
+0000ac40: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+0000ac50: 2020 726f 7461 7469 6f6e 203d 2046 616c    rotation = Fal
+0000ac60: 7365 0a20 2020 2020 2020 2069 6620 6e6f  se.        if no
+0000ac70: 7420 6e70 2e69 7363 6c6f 7365 2870 6f73  t np.isclose(pos
+0000ac80: 6974 696f 6e2e 742c 2030 2e30 293a 0a20  ition.t, 0.0):. 
+0000ac90: 2020 2020 2020 2020 2020 2074 696c 7420             tilt 
+0000aca0: 3d20 5472 7565 0a20 2020 2020 2020 2065  = True.        e
+0000acb0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+0000acc0: 2074 696c 7420 3d20 4661 6c73 650a 2020   tilt = False.  
+0000acd0: 2020 2020 2020 5f63 6865 636b 5f6e 6565        _check_nee
+0000ace0: 646c 6528 7365 6c66 2e68 6172 6477 6172  dle(self.hardwar
+0000acf0: 655f 7365 7474 696e 6773 2c20 726f 7461  e_settings, rota
+0000ad00: 7469 6f6e 2c20 7469 6c74 290a 2020 2020  tion, tilt).    
+0000ad10: 2020 2020 6e65 6564 6c65 203d 2073 656c      needle = sel
+0000ad20: 662e 636f 6e6e 6563 7469 6f6e 2e73 7065  f.connection.spe
+0000ad30: 6369 6d65 6e2e 6d61 6e69 7075 6c61 746f  cimen.manipulato
+0000ad40: 720a 2020 2020 2020 2020 706f 7369 7469  r.        positi
+0000ad50: 6f6e 203d 2070 6f73 6974 696f 6e2e 746f  on = position.to
+0000ad60: 5f61 7574 6f73 6372 6970 745f 706f 7369  _autoscript_posi
+0000ad70: 7469 6f6e 2829 0a20 2020 2020 2020 206c  tion().        l
+0000ad80: 6f67 6769 6e67 2e69 6e66 6f28 6622 6d6f  ogging.info(f"mo
+0000ad90: 7669 6e67 206d 616e 6970 756c 6174 6f72  ving manipulator
+0000ada0: 2062 7920 7b70 6f73 6974 696f 6e7d 2229   by {position}")
+0000adb0: 0a20 2020 2020 2020 206e 6565 646c 652e  .        needle.
+0000adc0: 7265 6c61 7469 7665 5f6d 6f76 6528 706f  relative_move(po
+0000add0: 7369 7469 6f6e 290a 2020 2020 0a20 2020  sition).    .   
+0000ade0: 2064 6566 206d 6f76 655f 6d61 6e69 7075   def move_manipu
+0000adf0: 6c61 746f 725f 6162 736f 6c75 7465 2873  lator_absolute(s
+0000ae00: 656c 662c 2070 6f73 6974 696f 6e3a 2046  elf, position: F
+0000ae10: 6962 7365 6d4d 616e 6970 756c 6174 6f72  ibsemManipulator
+0000ae20: 506f 7369 7469 6f6e 293a 0a20 2020 2020  Position):.     
+0000ae30: 2020 2069 6620 6e6f 7420 6e70 2e69 7363     if not np.isc
+0000ae40: 6c6f 7365 2870 6f73 6974 696f 6e2e 722c  lose(position.r,
+0000ae50: 2030 2e30 293a 0a20 2020 2020 2020 2020   0.0):.         
+0000ae60: 2020 2072 6f74 6174 696f 6e20 3d20 5472     rotation = Tr
+0000ae70: 7565 0a20 2020 2020 2020 2065 6c73 653a  ue.        else:
+0000ae80: 0a20 2020 2020 2020 2020 2020 2072 6f74  .            rot
+0000ae90: 6174 696f 6e20 3d20 4661 6c73 650a 2020  ation = False.  
+0000aea0: 2020 2020 2020 6966 206e 6f74 206e 702e        if not np.
+0000aeb0: 6973 636c 6f73 6528 706f 7369 7469 6f6e  isclose(position
+0000aec0: 2e74 2c20 302e 3029 3a0a 2020 2020 2020  .t, 0.0):.      
+0000aed0: 2020 2020 2020 7469 6c74 203d 2054 7275        tilt = Tru
+0000aee0: 650a 2020 2020 2020 2020 656c 7365 3a0a  e.        else:.
+0000aef0: 2020 2020 2020 2020 2020 2020 7469 6c74              tilt
+0000af00: 203d 2046 616c 7365 0a20 2020 2020 2020   = False.       
+0000af10: 205f 6368 6563 6b5f 6e65 6564 6c65 2873   _check_needle(s
+0000af20: 656c 662e 6861 7264 7761 7265 5f73 6574  elf.hardware_set
+0000af30: 7469 6e67 732c 2072 6f74 6174 696f 6e2c  tings, rotation,
+0000af40: 2074 696c 7429 0a20 2020 2020 2020 206e   tilt).        n
+0000af50: 6565 646c 6520 3d20 7365 6c66 2e63 6f6e  eedle = self.con
+0000af60: 6e65 6374 696f 6e2e 7370 6563 696d 656e  nection.specimen
+0000af70: 2e6d 616e 6970 756c 6174 6f72 0a20 2020  .manipulator.   
+0000af80: 2020 2020 2070 6f73 6974 696f 6e20 3d20       position = 
+0000af90: 706f 7369 7469 6f6e 2e74 6f5f 6175 746f  position.to_auto
+0000afa0: 7363 7269 7074 5f70 6f73 6974 696f 6e28  script_position(
+0000afb0: 290a 2020 2020 2020 2020 6c6f 6767 696e  ).        loggin
+0000afc0: 672e 696e 666f 2866 226d 6f76 696e 6720  g.info(f"moving 
+0000afd0: 6d61 6e69 7075 6c61 746f 7220 746f 207b  manipulator to {
+0000afe0: 706f 7369 7469 6f6e 7d22 290a 2020 2020  position}").    
+0000aff0: 2020 2020 6e65 6564 6c65 2e61 6273 6f6c      needle.absol
+0000b000: 7574 655f 6d6f 7665 2870 6f73 6974 696f  ute_move(positio
+0000b010: 6e29 0a20 2020 2020 2020 200a 0a20 2020  n).        ..   
+0000b020: 2064 6566 205f 785f 636f 7272 6563 7465   def _x_correcte
+0000b030: 645f 6e65 6564 6c65 5f6d 6f76 656d 656e  d_needle_movemen
+0000b040: 7428 7365 6c66 2c20 6578 7065 6374 6564  t(self, expected
+0000b050: 5f78 3a20 666c 6f61 7429 202d 3e20 4669  _x: float) -> Fi
+0000b060: 6273 656d 4d61 6e69 7075 6c61 746f 7250  bsemManipulatorP
+0000b070: 6f73 6974 696f 6e3a 0a20 2020 2020 2020  osition:.       
+0000b080: 2022 2222 4361 6c63 756c 6174 6520 7468   """Calculate th
+0000b090: 6520 636f 7272 6563 7465 6420 6e65 6564  e corrected need
+0000b0a0: 6c65 206d 6f76 656d 656e 7420 746f 206d  le movement to m
+0000b0b0: 6f76 6520 696e 2074 6865 2078 2d61 7869  ove in the x-axi
+0000b0c0: 732e 0a0a 2020 2020 2020 2020 4172 6773  s...        Args
+0000b0d0: 3a0a 2020 2020 2020 2020 2020 2020 6578  :.            ex
+0000b0e0: 7065 6374 6564 5f78 2028 666c 6f61 7429  pected_x (float)
+0000b0f0: 3a20 6469 7374 616e 6365 2061 6c6f 6e67  : distance along
+0000b100: 2074 6865 2078 2d61 7869 7320 2869 6d61   the x-axis (ima
+0000b110: 6765 2063 6f6f 7264 696e 6174 6573 290a  ge coordinates).
+0000b120: 2020 2020 2020 2020 5265 7475 726e 733a          Returns:
+0000b130: 0a20 2020 2020 2020 2020 2020 2046 6962  .            Fib
+0000b140: 7365 6d4d 616e 6970 756c 6174 6f72 506f  semManipulatorPo
+0000b150: 7369 7469 6f6e 3a20 782d 636f 7272 6563  sition: x-correc
+0000b160: 7465 6420 6e65 6564 6c65 206d 6f76 656d  ted needle movem
+0000b170: 656e 7420 2872 656c 6174 6976 6520 706f  ent (relative po
+0000b180: 7369 7469 6f6e 290a 2020 2020 2020 2020  sition).        
+0000b190: 2222 220a 2020 2020 2020 2020 7265 7475  """.        retu
+0000b1a0: 726e 2046 6962 7365 6d4d 616e 6970 756c  rn FibsemManipul
+0000b1b0: 6174 6f72 506f 7369 7469 6f6e 2878 3d65  atorPosition(x=e
+0000b1c0: 7870 6563 7465 645f 782c 2079 3d30 2c20  xpected_x, y=0, 
+0000b1d0: 7a3d 3029 2020 2320 6e6f 2061 646a 7573  z=0)  # no adjus
+0000b1e0: 746d 656e 7420 6e65 6564 6564 0a0a 0a20  tment needed... 
+0000b1f0: 2020 2064 6566 205f 795f 636f 7272 6563     def _y_correc
+0000b200: 7465 645f 6e65 6564 6c65 5f6d 6f76 656d  ted_needle_movem
+0000b210: 656e 7428 7365 6c66 2c20 0a20 2020 2020  ent(self, .     
+0000b220: 2020 2065 7870 6563 7465 645f 793a 2066     expected_y: f
+0000b230: 6c6f 6174 2c20 7374 6167 655f 7469 6c74  loat, stage_tilt
+0000b240: 3a20 666c 6f61 740a 2020 2020 2920 2d3e  : float.    ) ->
+0000b250: 2046 6962 7365 6d4d 616e 6970 756c 6174   FibsemManipulat
+0000b260: 6f72 506f 7369 7469 6f6e 3a0a 2020 2020  orPosition:.    
+0000b270: 2020 2020 2222 2243 616c 6375 6c61 7465      """Calculate
+0000b280: 2074 6865 2063 6f72 7265 6374 6564 206e   the corrected n
+0000b290: 6565 646c 6520 6d6f 7665 6d65 6e74 2074  eedle movement t
+0000b2a0: 6f20 6d6f 7665 2069 6e20 7468 6520 792d  o move in the y-
+0000b2b0: 6178 6973 2e0a 0a20 2020 2020 2020 2041  axis...        A
+0000b2c0: 7267 733a 0a20 2020 2020 2020 2020 2020  rgs:.           
+0000b2d0: 2065 7870 6563 7465 645f 7920 2866 6c6f   expected_y (flo
+0000b2e0: 6174 293a 2064 6973 7461 6e63 6520 616c  at): distance al
+0000b2f0: 6f6e 6720 7468 6520 792d 6178 6973 2028  ong the y-axis (
+0000b300: 696d 6167 6520 636f 6f72 6469 6e61 7465  image coordinate
+0000b310: 7329 0a20 2020 2020 2020 2020 2020 2073  s).            s
+0000b320: 7461 6765 5f74 696c 7420 2866 6c6f 6174  tage_tilt (float
+0000b330: 2c20 6f70 7469 6f6e 616c 293a 2073 7461  , optional): sta
+0000b340: 6765 2074 696c 742e 0a0a 2020 2020 2020  ge tilt...      
+0000b350: 2020 5265 7475 726e 733a 0a20 2020 2020    Returns:.     
+0000b360: 2020 2020 2020 2046 6962 7365 6d4d 616e         FibsemMan
+0000b370: 6970 756c 6174 6f72 506f 7369 7469 6f6e  ipulatorPosition
+0000b380: 3a20 792d 636f 7272 6563 7465 6420 6e65  : y-corrected ne
+0000b390: 6564 6c65 206d 6f76 656d 656e 7420 2872  edle movement (r
+0000b3a0: 656c 6174 6976 6520 706f 7369 7469 6f6e  elative position
+0000b3b0: 290a 2020 2020 2020 2020 2222 220a 2020  ).        """.  
+0000b3c0: 2020 2020 2020 795f 6d6f 7665 203d 202b        y_move = +
+0000b3d0: 6e70 2e63 6f73 2873 7461 6765 5f74 696c  np.cos(stage_til
+0000b3e0: 7429 202a 2065 7870 6563 7465 645f 790a  t) * expected_y.
+0000b3f0: 2020 2020 2020 2020 7a5f 6d6f 7665 203d          z_move =
+0000b400: 202b 6e70 2e73 696e 2873 7461 6765 5f74   +np.sin(stage_t
+0000b410: 696c 7429 202a 2065 7870 6563 7465 645f  ilt) * expected_
+0000b420: 790a 2020 2020 2020 2020 7265 7475 726e  y.        return
+0000b430: 2046 6962 7365 6d4d 616e 6970 756c 6174   FibsemManipulat
+0000b440: 6f72 506f 7369 7469 6f6e 2878 3d30 2c20  orPosition(x=0, 
+0000b450: 793d 795f 6d6f 7665 2c20 7a3d 7a5f 6d6f  y=y_move, z=z_mo
+0000b460: 7665 290a 0a0a 2020 2020 6465 6620 5f7a  ve)...    def _z
+0000b470: 5f63 6f72 7265 6374 6564 5f6e 6565 646c  _corrected_needl
+0000b480: 655f 6d6f 7665 6d65 6e74 2873 656c 662c  e_movement(self,
+0000b490: 200a 2020 2020 2020 2020 6578 7065 6374   .        expect
+0000b4a0: 6564 5f7a 3a20 666c 6f61 742c 2073 7461  ed_z: float, sta
+0000b4b0: 6765 5f74 696c 743a 2066 6c6f 6174 0a20  ge_tilt: float. 
+0000b4c0: 2020 2029 202d 3e20 4669 6273 656d 4d61     ) -> FibsemMa
+0000b4d0: 6e69 7075 6c61 746f 7250 6f73 6974 696f  nipulatorPositio
+0000b4e0: 6e3a 0a20 2020 2020 2020 2022 2222 4361  n:.        """Ca
+0000b4f0: 6c63 756c 6174 6520 7468 6520 636f 7272  lculate the corr
+0000b500: 6563 7465 6420 6e65 6564 6c65 206d 6f76  ected needle mov
+0000b510: 656d 656e 7420 746f 206d 6f76 6520 696e  ement to move in
+0000b520: 2074 6865 207a 2d61 7869 732e 0a0a 2020   the z-axis...  
+0000b530: 2020 2020 2020 4172 6773 3a0a 2020 2020        Args:.    
+0000b540: 2020 2020 2020 2020 6578 7065 6374 6564          expected
+0000b550: 5f7a 2028 666c 6f61 7429 3a20 6469 7374  _z (float): dist
+0000b560: 616e 6365 2061 6c6f 6e67 2074 6865 207a  ance along the z
+0000b570: 2d61 7869 7320 2869 6d61 6765 2063 6f6f  -axis (image coo
+0000b580: 7264 696e 6174 6573 290a 2020 2020 2020  rdinates).      
+0000b590: 2020 2020 2020 7374 6167 655f 7469 6c74        stage_tilt
+0000b5a0: 2028 666c 6f61 742c 206f 7074 696f 6e61   (float, optiona
+0000b5b0: 6c29 3a20 7374 6167 6520 7469 6c74 2e0a  l): stage tilt..
+0000b5c0: 0a20 2020 2020 2020 2052 6574 7572 6e73  .        Returns
+0000b5d0: 3a0a 2020 2020 2020 2020 2020 2020 4669  :.            Fi
+0000b5e0: 6273 656d 4d61 6e69 7075 6c61 746f 7250  bsemManipulatorP
+0000b5f0: 6f73 6974 696f 6e3a 207a 2d63 6f72 7265  osition: z-corre
+0000b600: 6374 6564 206e 6565 646c 6520 6d6f 7665  cted needle move
+0000b610: 6d65 6e74 2028 7265 6c61 7469 7665 2070  ment (relative p
+0000b620: 6f73 6974 696f 6e29 0a20 2020 2020 2020  osition).       
+0000b630: 2022 2222 0a20 2020 2020 2020 2079 5f6d   """.        y_m
+0000b640: 6f76 6520 3d20 2d6e 702e 7369 6e28 7374  ove = -np.sin(st
+0000b650: 6167 655f 7469 6c74 2920 2a20 6578 7065  age_tilt) * expe
+0000b660: 6374 6564 5f7a 0a20 2020 2020 2020 207a  cted_z.        z
+0000b670: 5f6d 6f76 6520 3d20 2b6e 702e 636f 7328  _move = +np.cos(
+0000b680: 7374 6167 655f 7469 6c74 2920 2a20 6578  stage_tilt) * ex
+0000b690: 7065 6374 6564 5f7a 0a20 2020 2020 2020  pected_z.       
+0000b6a0: 2072 6574 7572 6e20 4669 6273 656d 4d61   return FibsemMa
+0000b6b0: 6e69 7075 6c61 746f 7250 6f73 6974 696f  nipulatorPositio
+0000b6c0: 6e28 783d 302c 2079 3d79 5f6d 6f76 652c  n(x=0, y=y_move,
+0000b6d0: 207a 3d7a 5f6d 6f76 6529 0a0a 2020 2020   z=z_move)..    
+0000b6e0: 6465 6620 6d6f 7665 5f6d 616e 6970 756c  def move_manipul
+0000b6f0: 6174 6f72 5f63 6f72 7265 6374 6564 2873  ator_corrected(s
+0000b700: 656c 662c 200a 2020 2020 2020 2020 6478  elf, .        dx
+0000b710: 3a20 666c 6f61 7420 3d20 302c 0a20 2020  : float = 0,.   
+0000b720: 2020 2020 2064 793a 2066 6c6f 6174 203d       dy: float =
+0000b730: 2030 2c0a 2020 2020 2020 2020 6265 616d   0,.        beam
+0000b740: 5f74 7970 653a 2042 6561 6d54 7970 6520  _type: BeamType 
+0000b750: 3d20 4265 616d 5479 7065 2e45 4c45 4354  = BeamType.ELECT
+0000b760: 524f 4e2c 0a20 2020 2029 202d 3e20 4e6f  RON,.    ) -> No
+0000b770: 6e65 3a0a 2020 2020 2020 2020 2222 2243  ne:.        """C
+0000b780: 616c 6375 6c61 7465 2074 6865 2072 6571  alculate the req
+0000b790: 7569 7265 6420 636f 7272 6563 7465 6420  uired corrected 
+0000b7a0: 6e65 6564 6c65 206d 6f76 656d 656e 7473  needle movements
+0000b7b0: 2062 6173 6564 206f 6e20 7468 6520 4265   based on the Be
+0000b7c0: 616d 5479 7065 2074 6f20 6d6f 7665 2069  amType to move i
+0000b7d0: 6e20 7468 6520 6465 7369 7265 6420 696d  n the desired im
+0000b7e0: 6167 6520 636f 6f72 6469 6e61 7465 732e  age coordinates.
+0000b7f0: 0a20 2020 2020 2020 2054 6865 6e20 6d6f  .        Then mo
+0000b800: 7665 2074 6865 206e 6565 646c 6520 7265  ve the needle re
+0000b810: 6c61 7469 7665 6c79 2e0a 0a20 2020 2020  latively...     
+0000b820: 2020 2042 6561 6d54 7970 652e 454c 4543     BeamType.ELEC
+0000b830: 5452 4f4e 3a20 206d 6f76 6520 696e 2078  TRON:  move in x
+0000b840: 2c20 7920 2872 6177 2063 6f6f 7264 696e  , y (raw coordin
+0000b850: 6174 6573 290a 2020 2020 2020 2020 4265  ates).        Be
+0000b860: 616d 5479 7065 2e49 4f4e 3a20 2020 2020  amType.ION:     
+0000b870: 2020 6d6f 7665 2069 6e20 782c 207a 2028    move in x, z (
+0000b880: 7261 7720 636f 6f72 6469 6e61 7465 7329  raw coordinates)
+0000b890: 0a0a 2020 2020 2020 2020 4172 6773 3a0a  ..        Args:.
+0000b8a0: 2020 2020 2020 2020 2020 2020 6d69 6372              micr
+0000b8b0: 6f73 636f 7065 2028 5364 624d 6963 726f  oscope (SdbMicro
+0000b8c0: 7363 6f70 6543 6c69 656e 7429 3a20 6175  scopeClient): au
+0000b8d0: 746f 5363 7269 7074 206d 6963 726f 7363  toScript microsc
+0000b8e0: 6f70 6520 696e 7374 616e 6365 0a20 2020  ope instance.   
+0000b8f0: 2020 2020 2020 2020 2064 7820 2866 6c6f           dx (flo
+0000b900: 6174 293a 2064 6973 7461 6e63 6520 616c  at): distance al
+0000b910: 6f6e 6720 7468 6520 782d 6178 6973 2028  ong the x-axis (
+0000b920: 696d 6167 6520 636f 6f72 6469 6e61 7465  image coordinate
+0000b930: 7329 0a20 2020 2020 2020 2020 2020 2064  s).            d
+0000b940: 7920 2866 6c6f 6174 293a 2064 6973 7461  y (float): dista
+0000b950: 6e63 6520 616c 6f6e 6720 7468 6520 792d  nce along the y-
+0000b960: 6178 6973 2028 696d 6167 6520 636f 726f  axis (image coro
+0000b970: 6469 6e61 7465 7329 0a20 2020 2020 2020  dinates).       
+0000b980: 2020 2020 2062 6561 6d5f 7479 7065 2028       beam_type (
+0000b990: 4265 616d 5479 7065 2c20 6f70 7469 6f6e  BeamType, option
+0000b9a0: 616c 293a 2074 6865 2062 6561 6d20 7479  al): the beam ty
+0000b9b0: 7065 2074 6f20 6d6f 7665 2069 6e2e 2044  pe to move in. D
+0000b9c0: 6566 6175 6c74 7320 746f 2042 6561 6d54  efaults to BeamT
+0000b9d0: 7970 652e 454c 4543 5452 4f4e 2e0a 2020  ype.ELECTRON..  
+0000b9e0: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+0000b9f0: 2020 5f63 6865 636b 5f6e 6565 646c 6528    _check_needle(
+0000ba00: 7365 6c66 2e68 6172 6477 6172 655f 7365  self.hardware_se
+0000ba10: 7474 696e 6773 290a 2020 2020 2020 2020  ttings).        
+0000ba20: 6e65 6564 6c65 203d 2073 656c 662e 636f  needle = self.co
+0000ba30: 6e6e 6563 7469 6f6e 2e73 7065 6369 6d65  nnection.specime
+0000ba40: 6e2e 6d61 6e69 7075 6c61 746f 720a 2020  n.manipulator.  
+0000ba50: 2020 2020 2020 7374 6167 655f 7469 6c74        stage_tilt
+0000ba60: 203d 2073 656c 662e 636f 6e6e 6563 7469   = self.connecti
+0000ba70: 6f6e 2e73 7065 6369 6d65 6e2e 7374 6167  on.specimen.stag
+0000ba80: 652e 6375 7272 656e 745f 706f 7369 7469  e.current_positi
+0000ba90: 6f6e 2e74 0a0a 2020 2020 2020 2020 2320  on.t..        # 
+0000baa0: 7879 0a20 2020 2020 2020 2069 6620 6265  xy.        if be
+0000bab0: 616d 5f74 7970 6520 6973 2042 6561 6d54  am_type is BeamT
+0000bac0: 7970 652e 454c 4543 5452 4f4e 3a0a 2020  ype.ELECTRON:.  
+0000bad0: 2020 2020 2020 2020 2020 785f 6d6f 7665            x_move
+0000bae0: 203d 2073 656c 662e 5f78 5f63 6f72 7265   = self._x_corre
+0000baf0: 6374 6564 5f6e 6565 646c 655f 6d6f 7665  cted_needle_move
+0000bb00: 6d65 6e74 2865 7870 6563 7465 645f 783d  ment(expected_x=
+0000bb10: 6478 290a 2020 2020 2020 2020 2020 2020  dx).            
+0000bb20: 797a 5f6d 6f76 6520 3d20 7365 6c66 2e5f  yz_move = self._
+0000bb30: 795f 636f 7272 6563 7465 645f 6e65 6564  y_corrected_need
+0000bb40: 6c65 5f6d 6f76 656d 656e 7428 6479 2c20  le_movement(dy, 
+0000bb50: 7374 6167 655f 7469 6c74 3d73 7461 6765  stage_tilt=stage
+0000bb60: 5f74 696c 7429 0a0a 2020 2020 2020 2020  _tilt)..        
+0000bb70: 2320 787a 2c0a 2020 2020 2020 2020 6966  # xz,.        if
+0000bb80: 2062 6561 6d5f 7479 7065 2069 7320 4265   beam_type is Be
+0000bb90: 616d 5479 7065 2e49 4f4e 3a0a 0a20 2020  amType.ION:..   
+0000bba0: 2020 2020 2020 2020 2078 5f6d 6f76 6520           x_move 
+0000bbb0: 3d20 7365 6c66 2e5f 785f 636f 7272 6563  = self._x_correc
+0000bbc0: 7465 645f 6e65 6564 6c65 5f6d 6f76 656d  ted_needle_movem
+0000bbd0: 656e 7428 6578 7065 6374 6564 5f78 3d64  ent(expected_x=d
+0000bbe0: 7829 0a20 2020 2020 2020 2020 2020 2079  x).            y
+0000bbf0: 7a5f 6d6f 7665 203d 2073 656c 662e 5f7a  z_move = self._z
+0000bc00: 5f63 6f72 7265 6374 6564 5f6e 6565 646c  _corrected_needl
+0000bc10: 655f 6d6f 7665 6d65 6e74 2865 7870 6563  e_movement(expec
+0000bc20: 7465 645f 7a3d 6479 2c20 7374 6167 655f  ted_z=dy, stage_
+0000bc30: 7469 6c74 3d73 7461 6765 5f74 696c 7429  tilt=stage_tilt)
+0000bc40: 0a0a 2020 2020 2020 2020 2320 6d6f 7665  ..        # move
+0000bc50: 206e 6565 646c 6520 2872 656c 6174 6976   needle (relativ
+0000bc60: 6529 0a20 2020 2020 2020 2023 2065 7870  e).        # exp
+0000bc70: 6c69 6369 746c 7920 7365 7420 7468 6520  licitly set the 
+0000bc80: 636f 6f72 6469 6e61 7465 2073 7973 7465  coordinate syste
+0000bc90: 6d0a 2020 2020 2020 2020 7365 6c66 2e63  m.        self.c
+0000bca0: 6f6e 6e65 6374 696f 6e2e 7370 6563 696d  onnection.specim
+0000bcb0: 656e 2e6d 616e 6970 756c 6174 6f72 2e73  en.manipulator.s
+0000bcc0: 6574 5f64 6566 6175 6c74 5f63 6f6f 7264  et_default_coord
+0000bcd0: 696e 6174 655f 7379 7374 656d 280a 2020  inate_system(.  
+0000bce0: 2020 2020 2020 2020 2020 4d61 6e69 7075            Manipu
+0000bcf0: 6c61 746f 7243 6f6f 7264 696e 6174 6553  latorCoordinateS
+0000bd00: 7973 7465 6d2e 5354 4147 450a 2020 2020  ystem.STAGE.    
+0000bd10: 2020 2020 290a 2020 2020 2020 2020 6e65      ).        ne
+0000bd20: 6564 6c65 5f70 6f73 6974 696f 6e20 3d20  edle_position = 
+0000bd30: 4669 6273 656d 4d61 6e69 7075 6c61 746f  FibsemManipulato
+0000bd40: 7250 6f73 6974 696f 6e28 783d 785f 6d6f  rPosition(x=x_mo
+0000bd50: 7665 2e78 2c20 793d 797a 5f6d 6f76 652e  ve.x, y=yz_move.
+0000bd60: 792c 207a 3d79 7a5f 6d6f 7665 2e7a 2c20  y, z=yz_move.z, 
+0000bd70: 7220 3d20 302e 3020 2c63 6f6f 7264 696e  r = 0.0 ,coordin
+0000bd80: 6174 655f 7379 7374 656d 3d22 5354 4147  ate_system="STAG
+0000bd90: 4522 290a 2020 2020 2020 2020 6e65 6564  E").        need
+0000bda0: 6c65 5f70 6f73 6974 696f 6e20 3d20 6e65  le_position = ne
+0000bdb0: 6564 6c65 5f70 6f73 6974 696f 6e2e 746f  edle_position.to
+0000bdc0: 5f61 7574 6f73 6372 6970 745f 706f 7369  _autoscript_posi
+0000bdd0: 7469 6f6e 2829 0a20 2020 2020 2020 206c  tion().        l
+0000bde0: 6f67 6769 6e67 2e69 6e66 6f28 6622 4d6f  ogging.info(f"Mo
+0000bdf0: 7669 6e67 206d 616e 6970 756c 6174 6f72  ving manipulator
+0000be00: 3a20 7b6e 6565 646c 655f 706f 7369 7469  : {needle_positi
+0000be10: 6f6e 7d2e 2229 0a20 2020 2020 2020 206e  on}.").        n
+0000be20: 6565 646c 652e 7265 6c61 7469 7665 5f6d  eedle.relative_m
+0000be30: 6f76 6528 6e65 6564 6c65 5f70 6f73 6974  ove(needle_posit
+0000be40: 696f 6e29 0a0a 2020 2020 2020 2020 7265  ion)..        re
+0000be50: 7475 726e 0a20 2020 200a 2020 2020 6465  turn.    .    de
+0000be60: 6620 6d6f 7665 5f6d 616e 6970 756c 6174  f move_manipulat
+0000be70: 6f72 5f74 6f5f 706f 7369 7469 6f6e 5f6f  or_to_position_o
+0000be80: 6666 7365 7428 7365 6c66 2c20 6f66 6673  ffset(self, offs
+0000be90: 6574 3a20 4669 6273 656d 4d61 6e69 7075  et: FibsemManipu
+0000bea0: 6c61 746f 7250 6f73 6974 696f 6e2c 206e  latorPosition, n
+0000beb0: 616d 653a 2073 7472 203d 204e 6f6e 6529  ame: str = None)
+0000bec0: 202d 3e20 4e6f 6e65 3a0a 0a20 2020 2020   -> None:..     
+0000bed0: 2020 2023 2054 4f44 4f3a 2072 6573 6f6c     # TODO: resol
+0000bee0: 7665 2046 6962 7365 6d20 506f 7369 7469  ve Fibsem Positi
+0000bef0: 6f6e 7320 616e 6420 5468 6572 6d6f 2050  ons and Thermo P
+0000bf00: 6f73 6974 696f 6e73 0a20 2020 2020 2020  ositions.       
+0000bf10: 2069 6620 6e6f 7420 6e70 2e69 7363 6c6f   if not np.isclo
+0000bf20: 7365 286f 6666 7365 742e 722c 2030 2e30  se(offset.r, 0.0
+0000bf30: 293a 0a20 2020 2020 2020 2020 2020 2072  ):.            r
+0000bf40: 6f74 6174 696f 6e20 3d20 5472 7565 0a20  otation = True. 
+0000bf50: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+0000bf60: 2020 2020 2020 2020 2072 6f74 6174 696f           rotatio
+0000bf70: 6e20 3d20 4661 6c73 650a 2020 2020 2020  n = False.      
+0000bf80: 2020 6966 206e 6f74 206e 702e 6973 636c    if not np.iscl
+0000bf90: 6f73 6528 6f66 6673 6574 2e74 2c20 302e  ose(offset.t, 0.
+0000bfa0: 3029 3a0a 2020 2020 2020 2020 2020 2020  0):.            
+0000bfb0: 7469 6c74 203d 2054 7275 650a 2020 2020  tilt = True.    
+0000bfc0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0000bfd0: 2020 2020 2020 7469 6c74 203d 2046 616c        tilt = Fal
+0000bfe0: 7365 0a20 2020 2020 2020 205f 6368 6563  se.        _chec
+0000bff0: 6b5f 6e65 6564 6c65 2873 656c 662e 6861  k_needle(self.ha
+0000c000: 7264 7761 7265 5f73 6574 7469 6e67 732c  rdware_settings,
+0000c010: 2072 6f74 6174 696f 6e2c 2074 696c 7429   rotation, tilt)
+0000c020: 0a20 2020 2020 2020 2070 6f73 6974 696f  .        positio
+0000c030: 6e20 3d20 7365 6c66 2e5f 6765 745f 7361  n = self._get_sa
+0000c040: 7665 645f 6d61 6e69 7075 6c61 746f 725f  ved_manipulator_
+0000c050: 706f 7369 7469 6f6e 286e 616d 6529 0a0a  position(name)..
+0000c060: 2020 2020 2020 2020 2320 6d6f 7665 2074          # move t
+0000c070: 6f20 7265 6c61 7469 7665 2074 6f20 7468  o relative to th
+0000c080: 6520 6575 6365 6e74 7269 6320 706f 696e  e eucentric poin
+0000c090: 740a 2020 2020 2020 2020 797a 5f6d 6f76  t.        yz_mov
+0000c0a0: 6520 3d20 7365 6c66 2e5f 7a5f 636f 7272  e = self._z_corr
+0000c0b0: 6563 7465 645f 6e65 6564 6c65 5f6d 6f76  ected_needle_mov
+0000c0c0: 656d 656e 7428 0a20 2020 2020 2020 2020  ement(.         
+0000c0d0: 2020 206f 6666 7365 742e 7a2c 2073 656c     offset.z, sel
+0000c0e0: 662e 636f 6e6e 6563 7469 6f6e 2e73 7065  f.connection.spe
+0000c0f0: 6369 6d65 6e2e 7374 6167 652e 6375 7272  cimen.stage.curr
+0000c100: 656e 745f 706f 7369 7469 6f6e 2e74 0a20  ent_position.t. 
+0000c110: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+0000c120: 2070 6f73 6974 696f 6e2e 7820 2b3d 206f   position.x += o
+0000c130: 6666 7365 742e 780a 2020 2020 2020 2020  ffset.x.        
+0000c140: 706f 7369 7469 6f6e 2e79 202b 3d20 797a  position.y += yz
+0000c150: 5f6d 6f76 652e 7920 2b20 6f66 6673 6574  _move.y + offset
+0000c160: 2e79 0a20 2020 2020 2020 2070 6f73 6974  .y.        posit
+0000c170: 696f 6e2e 7a20 2b3d 2079 7a5f 6d6f 7665  ion.z += yz_move
+0000c180: 2e7a 2020 2320 5241 572c 2075 7020 3d20  .z  # RAW, up = 
+0000c190: 6e65 6761 7469 7665 2c20 5354 4147 453a  negative, STAGE:
+0000c1a0: 2064 6f77 6e20 3d20 6e65 6761 7469 7665   down = negative
+0000c1b0: 0a20 2020 2020 2020 2070 6f73 6974 696f  .        positio
+0000c1c0: 6e2e 7220 3d20 4e6f 6e65 2020 2320 726f  n.r = None  # ro
+0000c1d0: 7461 7469 6f6e 2069 7320 6e6f 7420 7375  tation is not su
+0000c1e0: 7070 6f72 7465 640a 2020 2020 2020 2020  pported.        
+0000c1f0: 7468 6572 6d6f 5f70 6f73 6974 696f 6e20  thermo_position 
+0000c200: 3d20 706f 7369 7469 6f6e 2e74 6f5f 6175  = position.to_au
+0000c210: 746f 7363 7269 7074 5f70 6f73 6974 696f  toscript_positio
+0000c220: 6e28 290a 2020 2020 2020 2020 7365 6c66  n().        self
+0000c230: 2e63 6f6e 6e65 6374 696f 6e2e 7370 6563  .connection.spec
+0000c240: 696d 656e 2e6d 616e 6970 756c 6174 6f72  imen.manipulator
+0000c250: 2e61 6273 6f6c 7574 655f 6d6f 7665 2874  .absolute_move(t
+0000c260: 6865 726d 6f5f 706f 7369 7469 6f6e 290a  hermo_position).
+0000c270: 0a20 2020 2064 6566 205f 6765 745f 7361  .    def _get_sa
+0000c280: 7665 645f 6d61 6e69 7075 6c61 746f 725f  ved_manipulator_
+0000c290: 706f 7369 7469 6f6e 2873 656c 662c 206e  position(self, n
+0000c2a0: 616d 653a 2073 7472 203d 2022 5041 524b  ame: str = "PARK
+0000c2b0: 2229 3a0a 2020 2020 2020 2020 0a20 2020  "):.        .   
+0000c2c0: 2020 2020 2069 6620 6e61 6d65 206e 6f74       if name not
+0000c2d0: 2069 6e20 5b22 5041 524b 222c 2022 4555   in ["PARK", "EU
+0000c2e0: 4345 4e54 5249 4322 5d3a 0a20 2020 2020  CENTRIC"]:.     
+0000c2f0: 2020 2020 2020 2072 6169 7365 2056 616c         raise Val
+0000c300: 7565 4572 726f 7228 6622 696e 7365 7274  ueError(f"insert
+0000c310: 2070 6f73 6974 696f 6e20 7b6e 616d 657d   position {name}
+0000c320: 206e 6f74 2073 7570 706f 7274 6564 2e22   not supported."
+0000c330: 290a 2020 2020 2020 2020 0a20 2020 2020  ).        .     
+0000c340: 2020 206e 616d 6564 5f70 6f73 6974 696f     named_positio
+0000c350: 6e20 3d20 4d61 6e69 7075 6c61 746f 7253  n = ManipulatorS
+0000c360: 6176 6564 506f 7369 7469 6f6e 2e50 4152  avedPosition.PAR
+0000c370: 4b20 6966 206e 616d 6520 3d3d 2022 5041  K if name == "PA
+0000c380: 524b 2220 656c 7365 204d 616e 6970 756c  RK" else Manipul
+0000c390: 6174 6f72 5361 7665 6450 6f73 6974 696f  atorSavedPositio
+0000c3a0: 6e2e 4555 4345 4e54 5249 430a 2020 2020  n.EUCENTRIC.    
+0000c3b0: 2020 2020 706f 7369 7469 6f6e 203d 2073      position = s
+0000c3c0: 656c 662e 636f 6e6e 6563 7469 6f6e 2e73  elf.connection.s
+0000c3d0: 7065 6369 6d65 6e2e 6d61 6e69 7075 6c61  pecimen.manipula
+0000c3e0: 746f 722e 6765 745f 7361 7665 645f 706f  tor.get_saved_po
+0000c3f0: 7369 7469 6f6e 280a 2020 2020 2020 2020  sition(.        
+0000c400: 2020 2020 2020 2020 6e61 6d65 645f 706f          named_po
+0000c410: 7369 7469 6f6e 2c20 4d61 6e69 7075 6c61  sition, Manipula
+0000c420: 746f 7243 6f6f 7264 696e 6174 6553 7973  torCoordinateSys
+0000c430: 7465 6d2e 5354 4147 450a 2020 2020 2020  tem.STAGE.      
+0000c440: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+0000c450: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
+0000c460: 2072 6574 7572 6e20 4669 6273 656d 4d61   return FibsemMa
+0000c470: 6e69 7075 6c61 746f 7250 6f73 6974 696f  nipulatorPositio
+0000c480: 6e2e 6672 6f6d 5f61 7574 6f73 6372 6970  n.from_autoscrip
+0000c490: 745f 706f 7369 7469 6f6e 2870 6f73 6974  t_position(posit
+0000c4a0: 696f 6e29 0a0a 2020 2020 6465 6620 7365  ion)..    def se
+0000c4b0: 7475 705f 6d69 6c6c 696e 6728 0a20 2020  tup_milling(.   
+0000c4c0: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
+0000c4d0: 2020 206d 696c 6c5f 7365 7474 696e 6773     mill_settings
+0000c4e0: 3a20 4669 6273 656d 4d69 6c6c 696e 6753  : FibsemMillingS
+0000c4f0: 6574 7469 6e67 732c 0a20 2020 2029 3a0a  ettings,.    ):.
+0000c500: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+0000c510: 2020 2020 436f 6e66 6967 7572 6520 7468      Configure th
+0000c520: 6520 6d69 6372 6f73 636f 7065 2066 6f72  e microscope for
+0000c530: 206d 696c 6c69 6e67 2075 7369 6e67 2074   milling using t
+0000c540: 6865 2069 6f6e 2062 6561 6d2e 0a0a 2020  he ion beam...  
+0000c550: 2020 2020 2020 4172 6773 3a0a 2020 2020        Args:.    
+0000c560: 2020 2020 2020 2020 6170 706c 6963 6174          applicat
+0000c570: 696f 6e5f 6669 6c65 2028 7374 7229 3a20  ion_file (str): 
+0000c580: 5061 7468 2074 6f20 7468 6520 6d69 6c6c  Path to the mill
+0000c590: 696e 6720 6170 706c 6963 6174 696f 6e20  ing application 
+0000c5a0: 6669 6c65 2e0a 2020 2020 2020 2020 2020  file..          
+0000c5b0: 2020 7061 7474 6572 6e69 6e67 5f6d 6f64    patterning_mod
+0000c5c0: 6520 2873 7472 293a 2050 6174 7465 726e  e (str): Pattern
+0000c5d0: 696e 6720 6d6f 6465 2074 6f20 7573 652e  ing mode to use.
+0000c5e0: 0a20 2020 2020 2020 2020 2020 2068 6677  .            hfw
+0000c5f0: 2028 666c 6f61 7429 3a20 4465 7369 7265   (float): Desire
+0000c600: 6420 686f 7269 7a6f 6e74 616c 2066 6965  d horizontal fie
+0000c610: 6c64 2077 6964 7468 2069 6e20 6d65 7465  ld width in mete
+0000c620: 7273 2e0a 2020 2020 2020 2020 2020 2020  rs..            
+0000c630: 6d69 6c6c 5f73 6574 7469 6e67 7320 2846  mill_settings (F
+0000c640: 6962 7365 6d4d 696c 6c69 6e67 5365 7474  ibsemMillingSett
+0000c650: 696e 6773 293a 204d 696c 6c69 6e67 2073  ings): Milling s
+0000c660: 6574 7469 6e67 732e 0a0a 2020 2020 2020  ettings...      
+0000c670: 2020 5265 7475 726e 733a 0a20 2020 2020    Returns:.     
+0000c680: 2020 2020 2020 204e 6f6e 652e 0a0a 2020         None...  
+0000c690: 2020 2020 2020 5261 6973 6573 3a0a 2020        Raises:.  
+0000c6a0: 2020 2020 2020 2020 2020 4e6f 7449 6d70            NotImp
+0000c6b0: 6c65 6d65 6e74 6564 4572 726f 723a 2049  lementedError: I
+0000c6c0: 6620 7468 6520 7370 6563 6966 6965 6420  f the specified 
+0000c6d0: 7061 7474 6572 6e69 6e67 206d 6f64 6520  patterning mode 
+0000c6e0: 6973 206e 6f74 2073 7570 706f 7274 6564  is not supported
+0000c6f0: 2e0a 0a20 2020 2020 2020 204e 6f74 653a  ...        Note:
+0000c700: 0a20 2020 2020 2020 2020 2020 2054 6869  .            Thi
+0000c710: 7320 6d65 7468 6f64 2073 6574 7320 7570  s method sets up
+0000c720: 2074 6865 206d 6963 726f 7363 6f70 6520   the microscope 
+0000c730: 696d 6167 696e 6720 616e 6420 7061 7474  imaging and patt
+0000c740: 6572 6e69 6e67 2066 6f72 206d 696c 6c69  erning for milli
+0000c750: 6e67 2075 7369 6e67 2074 6865 2069 6f6e  ng using the ion
+0000c760: 2062 6561 6d2e 0a20 2020 2020 2020 2020   beam..         
+0000c770: 2020 2049 7420 7365 7473 2074 6865 2061     It sets the a
+0000c780: 6374 6976 6520 7669 6577 2061 6e64 2064  ctive view and d
+0000c790: 6576 6963 6520 746f 2074 6865 2069 6f6e  evice to the ion
+0000c7a0: 2062 6561 6d2c 2074 6865 2064 6566 6175   beam, the defau
+0000c7b0: 6c74 2062 6561 6d20 7479 7065 2074 6f20  lt beam type to 
+0000c7c0: 7468 6520 696f 6e20 6265 616d 2c0a 2020  the ion beam,.  
+0000c7d0: 2020 2020 2020 2020 2020 7468 6520 7370            the sp
+0000c7e0: 6563 6966 6965 6420 6170 706c 6963 6174  ecified applicat
+0000c7f0: 696f 6e20 6669 6c65 2c20 616e 6420 7468  ion file, and th
+0000c800: 6520 7370 6563 6966 6965 6420 7061 7474  e specified patt
+0000c810: 6572 6e69 6e67 206d 6f64 652e 0a20 2020  erning mode..   
+0000c820: 2020 2020 2020 2020 2049 7420 616c 736f           It also
+0000c830: 2063 6c65 6172 7320 616e 7920 6578 6973   clears any exis
+0000c840: 7469 6e67 2070 6174 7465 726e 7320 616e  ting patterns an
+0000c850: 6420 7365 7473 2074 6865 2068 6f72 697a  d sets the horiz
+0000c860: 6f6e 7461 6c20 6669 656c 6420 7769 6474  ontal field widt
+0000c870: 6820 746f 2074 6865 2064 6573 6972 6564  h to the desired
+0000c880: 2076 616c 7565 2e0a 2020 2020 2020 2020   value..        
+0000c890: 2020 2020 5468 6520 6d65 7468 6f64 2064      The method d
+0000c8a0: 6f65 7320 6e6f 7420 7374 6172 7420 7468  oes not start th
+0000c8b0: 6520 6d69 6c6c 696e 6720 7072 6f63 6573  e milling proces
+0000c8c0: 732e 0a20 2020 2020 2020 2022 2222 0a20  s..        """. 
+0000c8d0: 2020 2020 2020 205f 6368 6563 6b5f 6265         _check_be
+0000c8e0: 616d 2842 6561 6d54 7970 652e 494f 4e2c  am(BeamType.ION,
+0000c8f0: 2073 656c 662e 6861 7264 7761 7265 5f73   self.hardware_s
+0000c900: 6574 7469 6e67 7329 0a20 2020 2020 2020  ettings).       
+0000c910: 2073 656c 662e 636f 6e6e 6563 7469 6f6e   self.connection
+0000c920: 2e69 6d61 6769 6e67 2e73 6574 5f61 6374  .imaging.set_act
+0000c930: 6976 655f 7669 6577 2842 6561 6d54 7970  ive_view(BeamTyp
+0000c940: 652e 494f 4e2e 7661 6c75 6529 2020 2320  e.ION.value)  # 
+0000c950: 7468 6520 696f 6e20 6265 616d 2076 6965  the ion beam vie
+0000c960: 770a 2020 2020 2020 2020 7365 6c66 2e63  w.        self.c
+0000c970: 6f6e 6e65 6374 696f 6e2e 696d 6167 696e  onnection.imagin
+0000c980: 672e 7365 745f 6163 7469 7665 5f64 6576  g.set_active_dev
+0000c990: 6963 6528 4265 616d 5479 7065 2e49 4f4e  ice(BeamType.ION
+0000c9a0: 2e76 616c 7565 290a 2020 2020 2020 2020  .value).        
+0000c9b0: 7365 6c66 2e63 6f6e 6e65 6374 696f 6e2e  self.connection.
+0000c9c0: 7061 7474 6572 6e69 6e67 2e73 6574 5f64  patterning.set_d
+0000c9d0: 6566 6175 6c74 5f62 6561 6d5f 7479 7065  efault_beam_type
+0000c9e0: 280a 2020 2020 2020 2020 2020 2020 4265  (.            Be
+0000c9f0: 616d 5479 7065 2e49 4f4e 2e76 616c 7565  amType.ION.value
+0000ca00: 0a20 2020 2020 2020 2029 2020 2320 696f  .        )  # io
+0000ca10: 6e20 6265 616d 2064 6566 6175 6c74 0a20  n beam default. 
+0000ca20: 2020 2020 2020 2073 656c 662e 636f 6e6e         self.conn
+0000ca30: 6563 7469 6f6e 2e70 6174 7465 726e 696e  ection.patternin
+0000ca40: 672e 7365 745f 6465 6661 756c 745f 6170  g.set_default_ap
+0000ca50: 706c 6963 6174 696f 6e5f 6669 6c65 286d  plication_file(m
+0000ca60: 696c 6c5f 7365 7474 696e 6773 2e61 7070  ill_settings.app
+0000ca70: 6c69 6361 7469 6f6e 5f66 696c 6529 0a20  lication_file). 
+0000ca80: 2020 2020 2020 2073 656c 662e 636f 6e6e         self.conn
+0000ca90: 6563 7469 6f6e 2e70 6174 7465 726e 696e  ection.patternin
+0000caa0: 672e 6d6f 6465 203d 206d 696c 6c5f 7365  g.mode = mill_se
+0000cab0: 7474 696e 6773 2e70 6174 7465 726e 696e  ttings.patternin
+0000cac0: 675f 6d6f 6465 0a20 2020 2020 2020 2073  g_mode.        s
+0000cad0: 656c 662e 636f 6e6e 6563 7469 6f6e 2e70  elf.connection.p
+0000cae0: 6174 7465 726e 696e 672e 636c 6561 725f  atterning.clear_
+0000caf0: 7061 7474 6572 6e73 2829 2020 2320 636c  patterns()  # cl
+0000cb00: 6561 7220 616e 7920 6578 6973 7469 6e67  ear any existing
+0000cb10: 2070 6174 7465 726e 730a 2020 2020 2020   patterns.      
+0000cb20: 2020 7365 6c66 2e63 6f6e 6e65 6374 696f    self.connectio
+0000cb30: 6e2e 6265 616d 732e 696f 6e5f 6265 616d  n.beams.ion_beam
+0000cb40: 2e68 6f72 697a 6f6e 7461 6c5f 6669 656c  .horizontal_fiel
+0000cb50: 645f 7769 6474 682e 7661 6c75 6520 3d20  d_width.value = 
+0000cb60: 6d69 6c6c 5f73 6574 7469 6e67 732e 6866  mill_settings.hf
+0000cb70: 770a 0a20 2020 2064 6566 2072 756e 5f6d  w..    def run_m
+0000cb80: 696c 6c69 6e67 2873 656c 662c 206d 696c  illing(self, mil
+0000cb90: 6c69 6e67 5f63 7572 7265 6e74 3a20 666c  ling_current: fl
+0000cba0: 6f61 742c 2061 7379 6e63 683a 2062 6f6f  oat, asynch: boo
+0000cbb0: 6c20 3d20 4661 6c73 6529 3a0a 2020 2020  l = False):.    
+0000cbc0: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+0000cbd0: 5275 6e20 696f 6e20 6265 616d 206d 696c  Run ion beam mil
+0000cbe0: 6c69 6e67 2075 7369 6e67 2074 6865 2073  ling using the s
+0000cbf0: 7065 6369 6669 6564 206d 696c 6c69 6e67  pecified milling
+0000cc00: 2063 7572 7265 6e74 2e0a 0a20 2020 2020   current...     
+0000cc10: 2020 2041 7267 733a 0a20 2020 2020 2020     Args:.       
+0000cc20: 2020 2020 206d 696c 6c69 6e67 5f63 7572       milling_cur
+0000cc30: 7265 6e74 2028 666c 6f61 7429 3a20 5468  rent (float): Th
+0000cc40: 6520 6375 7272 656e 7420 746f 2075 7365  e current to use
+0000cc50: 2066 6f72 206d 696c 6c69 6e67 2069 6e20   for milling in 
+0000cc60: 616d 7073 2e0a 2020 2020 2020 2020 2020  amps..          
+0000cc70: 2020 6173 796e 6368 2028 626f 6f6c 2c20    asynch (bool, 
+0000cc80: 6f70 7469 6f6e 616c 293a 2049 6620 5472  optional): If Tr
+0000cc90: 7565 2c20 7468 6520 6d69 6c6c 696e 6720  ue, the milling 
+0000cca0: 7769 6c6c 2062 6520 7275 6e20 6173 796e  will be run asyn
+0000ccb0: 6368 726f 6e6f 7573 6c79 2e20 0a20 2020  chronously. .   
+0000ccc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ccd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000cce0: 2020 4465 6661 756c 7473 2074 6f20 4661    Defaults to Fa
+0000ccf0: 6c73 652c 2069 6e20 7768 6963 6820 6361  lse, in which ca
+0000cd00: 7365 2069 7420 7769 6c6c 2072 756e 2073  se it will run s
+0000cd10: 796e 6368 726f 6e6f 7573 6c79 2e0a 0a20  ynchronously... 
+0000cd20: 2020 2020 2020 2052 6574 7572 6e73 3a0a         Returns:.
+0000cd30: 2020 2020 2020 2020 2020 2020 4e6f 6e65              None
+0000cd40: 0a0a 2020 2020 2020 2020 5261 6973 6573  ..        Raises
+0000cd50: 3a0a 2020 2020 2020 2020 2020 2020 4e6f  :.            No
+0000cd60: 6e65 0a20 2020 2020 2020 2022 2222 0a20  ne.        """. 
+0000cd70: 2020 2020 2020 205f 6368 6563 6b5f 6265         _check_be
+0000cd80: 616d 2842 6561 6d54 7970 652e 494f 4e2c  am(BeamType.ION,
+0000cd90: 2073 656c 662e 6861 7264 7761 7265 5f73   self.hardware_s
+0000cda0: 6574 7469 6e67 7329 0a20 2020 2020 2020  ettings).       
+0000cdb0: 2023 2063 6861 6e67 6520 746f 206d 696c   # change to mil
+0000cdc0: 6c69 6e67 2063 7572 7265 6e74 0a20 2020  ling current.   
+0000cdd0: 2020 2020 2073 656c 662e 636f 6e6e 6563       self.connec
+0000cde0: 7469 6f6e 2e69 6d61 6769 6e67 2e73 6574  tion.imaging.set
+0000cdf0: 5f61 6374 6976 655f 7669 6577 2842 6561  _active_view(Bea
+0000ce00: 6d54 7970 652e 494f 4e2e 7661 6c75 6529  mType.ION.value)
+0000ce10: 2020 2320 7468 6520 696f 6e20 6265 616d    # the ion beam
+0000ce20: 2076 6965 770a 2020 2020 2020 2020 6966   view.        if
+0000ce30: 2073 656c 662e 636f 6e6e 6563 7469 6f6e   self.connection
+0000ce40: 2e62 6561 6d73 2e69 6f6e 5f62 6561 6d2e  .beams.ion_beam.
+0000ce50: 6265 616d 5f63 7572 7265 6e74 2e76 616c  beam_current.val
+0000ce60: 7565 2021 3d20 6d69 6c6c 696e 675f 6375  ue != milling_cu
+0000ce70: 7272 656e 743a 0a20 2020 2020 2020 2020  rrent:.         
+0000ce80: 2020 206c 6f67 6769 6e67 2e69 6e66 6f28     logging.info(
+0000ce90: 6622 6368 616e 6769 6e67 2074 6f20 6d69  f"changing to mi
+0000cea0: 6c6c 696e 6720 6375 7272 656e 743a 207b  lling current: {
+0000ceb0: 6d69 6c6c 696e 675f 6375 7272 656e 743a  milling_current:
+0000cec0: 2e32 657d 2229 0a20 2020 2020 2020 2020  .2e}").         
+0000ced0: 2020 2073 656c 662e 636f 6e6e 6563 7469     self.connecti
+0000cee0: 6f6e 2e62 6561 6d73 2e69 6f6e 5f62 6561  on.beams.ion_bea
+0000cef0: 6d2e 6265 616d 5f63 7572 7265 6e74 2e76  m.beam_current.v
+0000cf00: 616c 7565 203d 206d 696c 6c69 6e67 5f63  alue = milling_c
+0000cf10: 7572 7265 6e74 0a0a 2020 2020 2020 2020  urrent..        
+0000cf20: 2320 7275 6e20 6d69 6c6c 696e 6720 2861  # run milling (a
+0000cf30: 7379 6e63 6872 6f6e 6f75 736c 7929 0a20  synchronously). 
+0000cf40: 2020 2020 2020 206c 6f67 6769 6e67 2e69         logging.i
+0000cf50: 6e66 6f28 6622 7275 6e6e 696e 6720 696f  nfo(f"running io
+0000cf60: 6e20 6265 616d 206d 696c 6c69 6e67 206e  n beam milling n
+0000cf70: 6f77 2e2e 2e20 6173 796e 6368 726f 6e6f  ow... asynchrono
+0000cf80: 7573 3d7b 6173 796e 6368 7d22 290a 2020  us={asynch}").  
+0000cf90: 2020 2020 2020 6966 2061 7379 6e63 683a        if asynch:
+0000cfa0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+0000cfb0: 662e 636f 6e6e 6563 7469 6f6e 2e70 6174  f.connection.pat
+0000cfc0: 7465 726e 696e 672e 7374 6172 7428 290a  terning.start().
+0000cfd0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+0000cfe0: 2020 2020 2020 2020 2020 7365 6c66 2e63            self.c
+0000cff0: 6f6e 6e65 6374 696f 6e2e 7061 7474 6572  onnection.patter
+0000d000: 6e69 6e67 2e72 756e 2829 0a20 2020 2020  ning.run().     
+0000d010: 2020 2020 2020 2073 656c 662e 636f 6e6e         self.conn
+0000d020: 6563 7469 6f6e 2e70 6174 7465 726e 696e  ection.patternin
+0000d030: 672e 636c 6561 725f 7061 7474 6572 6e73  g.clear_patterns
+0000d040: 2829 0a20 2020 2020 2020 2023 204e 4f54  ().        # NOT
+0000d050: 453a 204d 616b 6520 7465 7363 616e 206c  E: Make tescan l
+0000d060: 6f67 7320 7468 6520 7361 6d65 3f3f 0a0a  ogs the same??..
+0000d070: 2020 2020 6465 6620 7275 6e5f 6d69 6c6c      def run_mill
+0000d080: 696e 675f 6472 6966 745f 636f 7272 6563  ing_drift_correc
+0000d090: 7465 6428 7365 6c66 2c20 6d69 6c6c 696e  ted(self, millin
+0000d0a0: 675f 6375 7272 656e 743a 2066 6c6f 6174  g_current: float
+0000d0b0: 2c20 200a 2020 2020 2020 2020 696d 6167  ,  .        imag
+0000d0c0: 655f 7365 7474 696e 6773 3a20 496d 6167  e_settings: Imag
+0000d0d0: 6553 6574 7469 6e67 732c 200a 2020 2020  eSettings, .    
+0000d0e0: 2020 2020 7265 665f 696d 6167 653a 2046      ref_image: F
+0000d0f0: 6962 7365 6d49 6d61 6765 2c20 0a20 2020  ibsemImage, .   
+0000d100: 2020 2020 2072 6564 7563 6564 5f61 7265       reduced_are
+0000d110: 613a 2046 6962 7365 6d52 6563 7461 6e67  a: FibsemRectang
+0000d120: 6c65 203d 204e 6f6e 652c 0a20 2020 2020  le = None,.     
+0000d130: 2020 2029 3a0a 2020 2020 2020 2020 2222     ):.        ""
+0000d140: 220a 2020 2020 2020 2020 5275 6e20 696f  ".        Run io
+0000d150: 6e20 6265 616d 206d 696c 6c69 6e67 2075  n beam milling u
+0000d160: 7369 6e67 2074 6865 2073 7065 6369 6669  sing the specifi
+0000d170: 6564 206d 696c 6c69 6e67 2063 7572 7265  ed milling curre
+0000d180: 6e74 2e0a 0a20 2020 2020 2020 2041 7267  nt...        Arg
+0000d190: 733a 0a20 2020 2020 2020 2020 2020 206d  s:.            m
+0000d1a0: 696c 6c69 6e67 5f63 7572 7265 6e74 2028  illing_current (
+0000d1b0: 666c 6f61 7429 3a20 5468 6520 6375 7272  float): The curr
+0000d1c0: 656e 7420 746f 2075 7365 2066 6f72 206d  ent to use for m
+0000d1d0: 696c 6c69 6e67 2069 6e20 616d 7073 2e0a  illing in amps..
+0000d1e0: 2020 2020 2020 2020 2020 2020 6173 796e              asyn
+0000d1f0: 6368 2028 626f 6f6c 2c20 6f70 7469 6f6e  ch (bool, option
+0000d200: 616c 293a 2049 6620 5472 7565 2c20 7468  al): If True, th
+0000d210: 6520 6d69 6c6c 696e 6720 7769 6c6c 2062  e milling will b
+0000d220: 6520 7275 6e20 6173 796e 6368 726f 6e6f  e run asynchrono
+0000d230: 7573 6c79 2e20 0a20 2020 2020 2020 2020  usly. .         
+0000d240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d250: 2020 2020 2020 2020 2020 2020 4465 6661              Defa
+0000d260: 756c 7473 2074 6f20 4661 6c73 652c 2069  ults to False, i
+0000d270: 6e20 7768 6963 6820 6361 7365 2069 7420  n which case it 
+0000d280: 7769 6c6c 2072 756e 2073 796e 6368 726f  will run synchro
+0000d290: 6e6f 7573 6c79 2e0a 0a20 2020 2020 2020  nously...       
+0000d2a0: 2052 6574 7572 6e73 3a0a 2020 2020 2020   Returns:.      
+0000d2b0: 2020 2020 2020 4e6f 6e65 0a0a 2020 2020        None..    
+0000d2c0: 2020 2020 5261 6973 6573 3a0a 2020 2020      Raises:.    
+0000d2d0: 2020 2020 2020 2020 4e6f 6e65 0a20 2020          None.   
+0000d2e0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+0000d2f0: 205f 6368 6563 6b5f 6265 616d 2842 6561   _check_beam(Bea
+0000d300: 6d54 7970 652e 494f 4e2c 2073 656c 662e  mType.ION, self.
+0000d310: 6861 7264 7761 7265 5f73 6574 7469 6e67  hardware_setting
+0000d320: 7329 0a20 2020 2020 2020 2023 2063 6861  s).        # cha
+0000d330: 6e67 6520 746f 206d 696c 6c69 6e67 2063  nge to milling c
+0000d340: 7572 7265 6e74 0a20 2020 2020 2020 2073  urrent.        s
+0000d350: 656c 662e 636f 6e6e 6563 7469 6f6e 2e69  elf.connection.i
+0000d360: 6d61 6769 6e67 2e73 6574 5f61 6374 6976  maging.set_activ
+0000d370: 655f 7669 6577 2842 6561 6d54 7970 652e  e_view(BeamType.
+0000d380: 494f 4e2e 7661 6c75 6529 2020 2320 7468  ION.value)  # th
+0000d390: 6520 696f 6e20 6265 616d 2076 6965 770a  e ion beam view.
+0000d3a0: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+0000d3b0: 636f 6e6e 6563 7469 6f6e 2e62 6561 6d73  connection.beams
+0000d3c0: 2e69 6f6e 5f62 6561 6d2e 6265 616d 5f63  .ion_beam.beam_c
+0000d3d0: 7572 7265 6e74 2e76 616c 7565 2021 3d20  urrent.value != 
+0000d3e0: 6d69 6c6c 696e 675f 6375 7272 656e 743a  milling_current:
+0000d3f0: 0a20 2020 2020 2020 2020 2020 206c 6f67  .            log
+0000d400: 6769 6e67 2e69 6e66 6f28 6622 6368 616e  ging.info(f"chan
+0000d410: 6769 6e67 2074 6f20 6d69 6c6c 696e 6720  ging to milling 
+0000d420: 6375 7272 656e 743a 207b 6d69 6c6c 696e  current: {millin
+0000d430: 675f 6375 7272 656e 743a 2e32 657d 2229  g_current:.2e}")
+0000d440: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+0000d450: 662e 636f 6e6e 6563 7469 6f6e 2e62 6561  f.connection.bea
+0000d460: 6d73 2e69 6f6e 5f62 6561 6d2e 6265 616d  ms.ion_beam.beam
+0000d470: 5f63 7572 7265 6e74 2e76 616c 7565 203d  _current.value =
+0000d480: 206d 696c 6c69 6e67 5f63 7572 7265 6e74   milling_current
+0000d490: 0a0a 2020 2020 2020 2020 2320 7275 6e20  ..        # run 
+0000d4a0: 6d69 6c6c 696e 6720 2861 7379 6e63 6872  milling (asynchr
+0000d4b0: 6f6e 6f75 736c 7929 0a20 2020 2020 2020  onously).       
+0000d4c0: 206c 6f67 6769 6e67 2e69 6e66 6f28 6622   logging.info(f"
+0000d4d0: 7275 6e6e 696e 6720 696f 6e20 6265 616d  running ion beam
+0000d4e0: 206d 696c 6c69 6e67 206e 6f77 2e22 290a   milling now.").
+0000d4f0: 0a20 2020 2020 2020 2073 656c 662e 636f  .        self.co
+0000d500: 6e6e 6563 7469 6f6e 2e70 6174 7465 726e  nnection.pattern
+0000d510: 696e 672e 7374 6172 7428 290a 2020 2020  ing.start().    
+0000d520: 2020 2020 2320 4e4f 5445 3a20 4d61 6b65      # NOTE: Make
+0000d530: 2074 6573 6361 6e20 6c6f 6773 2074 6865   tescan logs the
+0000d540: 2073 616d 653f 3f0a 2020 2020 2020 2020   same??.        
+0000d550: 6672 6f6d 2066 6962 7365 6d20 696d 706f  from fibsem impo
+0000d560: 7274 2061 6c69 676e 6d65 6e74 0a20 2020  rt alignment.   
+0000d570: 2020 2020 2077 6869 6c65 2073 656c 662e       while self.
+0000d580: 636f 6e6e 6563 7469 6f6e 2e70 6174 7465  connection.patte
+0000d590: 726e 696e 672e 7374 6174 6520 3d3d 2050  rning.state == P
+0000d5a0: 6174 7465 726e 696e 6753 7461 7465 2e49  atterningState.I
+0000d5b0: 444c 453a 2023 2067 6976 696e 6720 7469  DLE: # giving ti
+0000d5c0: 6d65 2074 6f20 7374 6172 7420 0a20 2020  me to start .   
+0000d5d0: 2020 2020 2020 2020 2074 696d 652e 736c           time.sl
+0000d5e0: 6565 7028 302e 3529 0a20 2020 2020 2020  eep(0.5).       
+0000d5f0: 2077 6869 6c65 2073 656c 662e 636f 6e6e   while self.conn
+0000d600: 6563 7469 6f6e 2e70 6174 7465 726e 696e  ection.patternin
+0000d610: 672e 7374 6174 6520 3d3d 2050 6174 7465  g.state == Patte
+0000d620: 726e 696e 6753 7461 7465 2e52 554e 4e49  rningState.RUNNI
+0000d630: 4e47 3a0a 0a20 2020 2020 2020 2020 2020  NG:..           
+0000d640: 2073 656c 662e 636f 6e6e 6563 7469 6f6e   self.connection
+0000d650: 2e70 6174 7465 726e 696e 672e 7061 7573  .patterning.paus
+0000d660: 6528 290a 2020 2020 2020 2020 2020 2020  e().            
+0000d670: 6c6f 6767 696e 672e 696e 666f 2822 4472  logging.info("Dr
+0000d680: 6966 7420 636f 7272 6563 7469 6f6e 2229  ift correction")
+0000d690: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+0000d6a0: 7265 6475 6365 645f 6172 6561 2069 7320  reduced_area is 
+0000d6b0: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
+0000d6c0: 2020 2020 2020 2020 2020 7265 6475 6365            reduce
+0000d6d0: 645f 6172 6561 203d 2072 6564 7563 6564  d_area = reduced
+0000d6e0: 5f61 7265 612e 5f5f 746f 5f46 4549 5f5f  _area.__to_FEI__
+0000d6f0: 2829 0a20 2020 2020 2020 2020 2020 2069  ().            i
+0000d700: 6d61 6765 5f73 6574 7469 6e67 732e 6265  mage_settings.be
+0000d710: 616d 5f74 7970 6520 3d20 4265 616d 5479  am_type = BeamTy
+0000d720: 7065 2e49 4f4e 0a20 2020 2020 2020 2020  pe.ION.         
+0000d730: 2020 2061 6c69 676e 6d65 6e74 2e62 6561     alignment.bea
+0000d740: 6d5f 7368 6966 745f 616c 6967 6e6d 656e  m_shift_alignmen
+0000d750: 7428 6d69 6372 6f73 636f 7065 203d 2073  t(microscope = s
+0000d760: 656c 662c 2069 6d61 6765 5f73 6574 7469  elf, image_setti
+0000d770: 6e67 733d 2069 6d61 6765 5f73 6574 7469  ngs= image_setti
+0000d780: 6e67 732c 2072 6566 5f69 6d61 6765 3d72  ngs, ref_image=r
+0000d790: 6566 5f69 6d61 6765 2c20 7265 6475 6365  ef_image, reduce
+0000d7a0: 645f 6172 6561 3d72 6564 7563 6564 5f61  d_area=reduced_a
+0000d7b0: 7265 6129 0a20 2020 2020 2020 2020 2020  rea).           
+0000d7c0: 2074 696d 652e 736c 6565 7028 3129 2023   time.sleep(1) #
+0000d7d0: 206e 6565 6420 6465 6c61 7920 746f 2073   need delay to s
+0000d7e0: 7769 7463 6820 6261 636b 2074 6f20 7061  witch back to pa
+0000d7f0: 7474 6572 6e69 6e67 206d 6f64 6520 0a20  tterning mode . 
+0000d800: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0000d810: 636f 6e6e 6563 7469 6f6e 2e69 6d61 6769  connection.imagi
+0000d820: 6e67 2e73 6574 5f61 6374 6976 655f 7669  ng.set_active_vi
+0000d830: 6577 2842 6561 6d54 7970 652e 494f 4e2e  ew(BeamType.ION.
+0000d840: 7661 6c75 6529 0a20 2020 2020 2020 2020  value).         
+0000d850: 2020 2069 6620 7365 6c66 2e63 6f6e 6e65     if self.conne
+0000d860: 6374 696f 6e2e 7061 7474 6572 6e69 6e67  ction.patterning
+0000d870: 2e73 7461 7465 203d 3d20 5061 7474 6572  .state == Patter
+0000d880: 6e69 6e67 5374 6174 652e 5041 5553 4544  ningState.PAUSED
+0000d890: 3a20 2320 6368 6563 6b20 6966 2066 696e  : # check if fin
+0000d8a0: 6973 6865 6420 0a20 2020 2020 2020 2020  ished .         
+0000d8b0: 2020 2020 2020 2073 656c 662e 636f 6e6e         self.conn
+0000d8c0: 6563 7469 6f6e 2e70 6174 7465 726e 696e  ection.patternin
+0000d8d0: 672e 7265 7375 6d65 2829 0a20 2020 2020  g.resume().     
+0000d8e0: 2020 2020 2020 2020 2020 2074 696d 652e             time.
+0000d8f0: 736c 6565 7028 3529 0a20 2020 2020 2020  sleep(5).       
+0000d900: 2020 2020 2070 7269 6e74 2873 656c 662e       print(self.
+0000d910: 636f 6e6e 6563 7469 6f6e 2e70 6174 7465  connection.patte
+0000d920: 726e 696e 672e 7374 6174 6529 0a0a 0a20  rning.state)... 
+0000d930: 2020 2064 6566 2066 696e 6973 685f 6d69     def finish_mi
+0000d940: 6c6c 696e 6728 7365 6c66 2c20 696d 6167  lling(self, imag
+0000d950: 696e 675f 6375 7272 656e 743a 2066 6c6f  ing_current: flo
+0000d960: 6174 293a 0a20 2020 2020 2020 2022 2222  at):.        """
+0000d970: 0a20 2020 2020 2020 2046 696e 616c 6973  .        Finalis
+0000d980: 6573 2074 6865 206d 696c 6c69 6e67 2070  es the milling p
+0000d990: 726f 6365 7373 2062 7920 636c 6561 7269  rocess by cleari
+0000d9a0: 6e67 2074 6865 206d 6963 726f 7363 6f70  ng the microscop
+0000d9b0: 6520 6f66 2061 6e79 2070 6174 7465 726e  e of any pattern
+0000d9c0: 7320 616e 6420 7265 7475 726e 696e 6720  s and returning 
+0000d9d0: 7468 6520 6375 7272 656e 7420 746f 2074  the current to t
+0000d9e0: 6865 2069 6d61 6769 6e67 2063 7572 7265  he imaging curre
+0000d9f0: 6e74 2e0a 0a20 2020 2020 2020 2041 7267  nt...        Arg
+0000da00: 733a 0a20 2020 2020 2020 2020 2020 2069  s:.            i
+0000da10: 6d61 6769 6e67 5f63 7572 7265 6e74 2028  maging_current (
+0000da20: 666c 6f61 7429 3a20 5468 6520 6375 7272  float): The curr
+0000da30: 656e 7420 746f 2075 7365 2066 6f72 2069  ent to use for i
+0000da40: 6d61 6769 6e67 2069 6e20 616d 7073 2e0a  maging in amps..
+0000da50: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+0000da60: 2020 2020 5f63 6865 636b 5f62 6561 6d28      _check_beam(
+0000da70: 4265 616d 5479 7065 2e49 4f4e 2c20 7365  BeamType.ION, se
+0000da80: 6c66 2e68 6172 6477 6172 655f 7365 7474  lf.hardware_sett
+0000da90: 696e 6773 290a 2020 2020 2020 2020 7365  ings).        se
+0000daa0: 6c66 2e63 6f6e 6e65 6374 696f 6e2e 7061  lf.connection.pa
+0000dab0: 7474 6572 6e69 6e67 2e63 6c65 6172 5f70  tterning.clear_p
+0000dac0: 6174 7465 726e 7328 290a 2020 2020 2020  atterns().      
+0000dad0: 2020 7365 6c66 2e63 6f6e 6e65 6374 696f    self.connectio
+0000dae0: 6e2e 6265 616d 732e 696f 6e5f 6265 616d  n.beams.ion_beam
+0000daf0: 2e62 6561 6d5f 6375 7272 656e 742e 7661  .beam_current.va
+0000db00: 6c75 6520 3d20 696d 6167 696e 675f 6375  lue = imaging_cu
+0000db10: 7272 656e 740a 2020 2020 2020 2020 7365  rrent.        se
+0000db20: 6c66 2e63 6f6e 6e65 6374 696f 6e2e 7061  lf.connection.pa
+0000db30: 7474 6572 6e69 6e67 2e6d 6f64 6520 3d20  tterning.mode = 
+0000db40: 2253 6572 6961 6c22 0a0a 2020 2020 6465  "Serial"..    de
+0000db50: 6620 6472 6177 5f72 6563 7461 6e67 6c65  f draw_rectangle
+0000db60: 280a 2020 2020 2020 2020 7365 6c66 2c0a  (.        self,.
+0000db70: 2020 2020 2020 2020 7061 7474 6572 6e5f          pattern_
+0000db80: 7365 7474 696e 6773 3a20 4669 6273 656d  settings: Fibsem
+0000db90: 5061 7474 6572 6e53 6574 7469 6e67 732c  PatternSettings,
+0000dba0: 0a20 2020 2029 3a0a 2020 2020 2020 2020  .    ):.        
+0000dbb0: 2222 220a 2020 2020 2020 2020 4472 6177  """.        Draw
+0000dbc0: 7320 6120 7265 6374 616e 676c 6520 7061  s a rectangle pa
+0000dbd0: 7474 6572 6e20 7573 696e 6720 7468 6520  ttern using the 
+0000dbe0: 6375 7272 656e 7420 696f 6e20 6265 616d  current ion beam
+0000dbf0: 2e0a 0a20 2020 2020 2020 2041 7267 733a  ...        Args:
+0000dc00: 0a20 2020 2020 2020 2020 2020 2070 6174  .            pat
+0000dc10: 7465 726e 5f73 6574 7469 6e67 7320 2846  tern_settings (F
+0000dc20: 6962 7365 6d50 6174 7465 726e 5365 7474  ibsemPatternSett
+0000dc30: 696e 6773 293a 2074 6865 2073 6574 7469  ings): the setti
+0000dc40: 6e67 7320 666f 7220 7468 6520 7061 7474  ngs for the patt
+0000dc50: 6572 6e20 746f 2064 7261 772e 0a0a 2020  ern to draw...  
+0000dc60: 2020 2020 2020 5265 7475 726e 733a 0a20        Returns:. 
+0000dc70: 2020 2020 2020 2020 2020 2050 6174 7465             Patte
+0000dc80: 726e 3a20 7468 6520 6372 6561 7465 6420  rn: the created 
+0000dc90: 7061 7474 6572 6e2e 0a0a 2020 2020 2020  pattern...      
+0000dca0: 2020 5261 6973 6573 3a0a 2020 2020 2020    Raises:.      
+0000dcb0: 2020 2020 2020 4175 746f 7363 7269 7074        Autoscript
+0000dcc0: 4572 726f 723a 2069 6620 616e 2065 7272  Error: if an err
+0000dcd0: 6f72 206f 6363 7572 7320 7768 696c 6520  or occurs while 
+0000dce0: 6372 6561 7469 6e67 2074 6865 2070 6174  creating the pat
+0000dcf0: 7465 726e 2e0a 0a20 2020 2020 2020 204e  tern...        N
+0000dd00: 6f74 6573 3a0a 2020 2020 2020 2020 2020  otes:.          
+0000dd10: 2020 5468 6520 7265 6374 616e 676c 6520    The rectangle 
+0000dd20: 7061 7474 6572 6e20 7769 6c6c 2062 6520  pattern will be 
+0000dd30: 6365 6e74 6572 6564 2061 7420 7468 6520  centered at the 
+0000dd40: 7370 6563 6966 6965 6420 636f 6f72 6469  specified coordi
+0000dd50: 6e61 7465 7320 2863 656e 7472 655f 782c  nates (centre_x,
+0000dd60: 2063 656e 7472 655f 7929 2077 6974 6820   centre_y) with 
+0000dd70: 7468 6520 7370 6563 6966 6965 640a 2020  the specified.  
+0000dd80: 2020 2020 2020 2020 2020 7769 6474 682c            width,
+0000dd90: 2068 6569 6768 7420 616e 6420 6465 7074   height and dept
+0000dda0: 6820 2869 6e20 6e6d 292e 2049 6620 7468  h (in nm). If th
+0000ddb0: 6520 636c 6561 6e69 6e67 5f63 726f 7373  e cleaning_cross
+0000ddc0: 5f73 6563 7469 6f6e 2061 7474 7269 6275  _section attribu
+0000ddd0: 7465 206f 6620 7061 7474 6572 6e5f 7365  te of pattern_se
+0000dde0: 7474 696e 6773 2069 7320 5472 7565 2c20  ttings is True, 
+0000ddf0: 610a 2020 2020 2020 2020 2020 2020 636c  a.            cl
+0000de00: 6561 6e69 6e67 2063 726f 7373 2073 6563  eaning cross sec
+0000de10: 7469 6f6e 2070 6174 7465 726e 2077 696c  tion pattern wil
+0000de20: 6c20 6265 2063 7265 6174 6564 2069 6e73  l be created ins
+0000de30: 7465 6164 206f 6620 6120 7265 6374 616e  tead of a rectan
+0000de40: 676c 6520 7061 7474 6572 6e2e 0a0a 2020  gle pattern...  
+0000de50: 2020 2020 2020 2020 2020 5468 6520 7061            The pa
+0000de60: 7474 6572 6e20 7769 6c6c 2062 6520 726f  ttern will be ro
+0000de70: 7461 7465 6420 6279 2074 6865 2061 6e67  tated by the ang
+0000de80: 6c65 2073 7065 6369 6669 6564 2069 6e20  le specified in 
+0000de90: 7468 6520 726f 7461 7469 6f6e 2061 7474  the rotation att
+0000dea0: 7269 6275 7465 206f 6620 7061 7474 6572  ribute of patter
+0000deb0: 6e5f 7365 7474 696e 6773 2028 696e 2064  n_settings (in d
+0000dec0: 6567 7265 6573 290a 2020 2020 2020 2020  egrees).        
+0000ded0: 2020 2020 616e 6420 7363 616e 6e65 6420      and scanned 
+0000dee0: 696e 2074 6865 2064 6972 6563 7469 6f6e  in the direction
+0000def0: 2073 7065 6369 6669 6564 2069 6e20 7468   specified in th
+0000df00: 6520 7363 616e 5f64 6972 6563 7469 6f6e  e scan_direction
+0000df10: 2061 7474 7269 6275 7465 206f 6620 7061   attribute of pa
+0000df20: 7474 6572 6e5f 7365 7474 696e 6773 2028  ttern_settings (
+0000df30: 2768 6f72 697a 6f6e 7461 6c27 206f 720a  'horizontal' or.
+0000df40: 2020 2020 2020 2020 2020 2020 2776 6572              'ver
+0000df50: 7469 6361 6c27 292e 0a0a 2020 2020 2020  tical')...      
+0000df60: 2020 2020 2020 5468 6520 6372 6561 7465        The create
+0000df70: 6420 7061 7474 6572 6e20 6361 6e20 6265  d pattern can be
+0000df80: 2061 6464 6564 2074 6f20 7468 6520 7061   added to the pa
+0000df90: 7474 6572 6e69 6e67 2071 7565 7565 2061  tterning queue a
+0000dfa0: 6e64 2065 7865 6375 7465 6420 7573 696e  nd executed usin
+0000dfb0: 6720 7468 6520 6d65 7468 6f64 7320 696e  g the methods in
+0000dfc0: 2074 6865 2050 6174 7465 726e 696e 6751   the PatterningQ
+0000dfd0: 7565 7565 0a20 2020 2020 2020 2020 2020  ueue.           
+0000dfe0: 2063 6c61 7373 206f 6620 7468 6520 6175   class of the au
+0000dff0: 746f 7363 7269 7074 5f73 6462 5f6d 6963  toscript_sdb_mic
+0000e000: 726f 7363 6f70 655f 636c 6965 6e74 2070  roscope_client p
+0000e010: 6163 6b61 6765 2e0a 2020 2020 2020 2020  ackage..        
+0000e020: 2222 220a 2020 2020 2020 2020 6966 2070  """.        if p
+0000e030: 6174 7465 726e 5f73 6574 7469 6e67 732e  attern_settings.
+0000e040: 636c 6561 6e69 6e67 5f63 726f 7373 5f73  cleaning_cross_s
+0000e050: 6563 7469 6f6e 3a0a 2020 2020 2020 2020  ection:.        
+0000e060: 2020 2020 7061 7474 6572 6e20 3d20 7365      pattern = se
+0000e070: 6c66 2e63 6f6e 6e65 6374 696f 6e2e 7061  lf.connection.pa
+0000e080: 7474 6572 6e69 6e67 2e63 7265 6174 655f  tterning.create_
+0000e090: 636c 6561 6e69 6e67 5f63 726f 7373 5f73  cleaning_cross_s
+0000e0a0: 6563 7469 6f6e 280a 2020 2020 2020 2020  ection(.        
+0000e0b0: 2020 2020 2020 2020 6365 6e74 6572 5f78          center_x
+0000e0c0: 3d70 6174 7465 726e 5f73 6574 7469 6e67  =pattern_setting
+0000e0d0: 732e 6365 6e74 7265 5f78 2c0a 2020 2020  s.centre_x,.    
+0000e0e0: 2020 2020 2020 2020 2020 2020 6365 6e74              cent
+0000e0f0: 6572 5f79 3d70 6174 7465 726e 5f73 6574  er_y=pattern_set
+0000e100: 7469 6e67 732e 6365 6e74 7265 5f79 2c0a  tings.centre_y,.
+0000e110: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e120: 7769 6474 683d 7061 7474 6572 6e5f 7365  width=pattern_se
+0000e130: 7474 696e 6773 2e77 6964 7468 2c0a 2020  ttings.width,.  
+0000e140: 2020 2020 2020 2020 2020 2020 2020 6865                he
+0000e150: 6967 6874 3d70 6174 7465 726e 5f73 6574  ight=pattern_set
+0000e160: 7469 6e67 732e 6865 6967 6874 2c0a 2020  tings.height,.  
+0000e170: 2020 2020 2020 2020 2020 2020 2020 6465                de
+0000e180: 7074 683d 7061 7474 6572 6e5f 7365 7474  pth=pattern_sett
+0000e190: 696e 6773 2e64 6570 7468 2c0a 2020 2020  ings.depth,.    
+0000e1a0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+0000e1b0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+0000e1c0: 2020 2020 7061 7474 6572 6e20 3d20 7365      pattern = se
+0000e1d0: 6c66 2e63 6f6e 6e65 6374 696f 6e2e 7061  lf.connection.pa
+0000e1e0: 7474 6572 6e69 6e67 2e63 7265 6174 655f  tterning.create_
+0000e1f0: 7265 6374 616e 676c 6528 0a20 2020 2020  rectangle(.     
+0000e200: 2020 2020 2020 2020 2020 2063 656e 7465             cente
+0000e210: 725f 783d 7061 7474 6572 6e5f 7365 7474  r_x=pattern_sett
+0000e220: 696e 6773 2e63 656e 7472 655f 782c 0a20  ings.centre_x,. 
+0000e230: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+0000e240: 656e 7465 725f 793d 7061 7474 6572 6e5f  enter_y=pattern_
+0000e250: 7365 7474 696e 6773 2e63 656e 7472 655f  settings.centre_
+0000e260: 792c 0a20 2020 2020 2020 2020 2020 2020  y,.             
+0000e270: 2020 2077 6964 7468 3d70 6174 7465 726e     width=pattern
+0000e280: 5f73 6574 7469 6e67 732e 7769 6474 682c  _settings.width,
+0000e290: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000e2a0: 2068 6569 6768 743d 7061 7474 6572 6e5f   height=pattern_
+0000e2b0: 7365 7474 696e 6773 2e68 6569 6768 742c  settings.height,
+0000e2c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000e2d0: 2064 6570 7468 3d70 6174 7465 726e 5f73   depth=pattern_s
+0000e2e0: 6574 7469 6e67 732e 6465 7074 682c 0a20  ettings.depth,. 
+0000e2f0: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
+0000e300: 2020 2020 2020 7061 7474 6572 6e2e 726f        pattern.ro
+0000e310: 7461 7469 6f6e 203d 2070 6174 7465 726e  tation = pattern
+0000e320: 5f73 6574 7469 6e67 732e 726f 7461 7469  _settings.rotati
+0000e330: 6f6e 0a20 2020 2020 2020 2070 6174 6873  on.        paths
+0000e340: 203d 2073 656c 662e 6765 745f 7363 616e   = self.get_scan
+0000e350: 5f64 6972 6563 7469 6f6e 7328 290a 2020  _directions().  
+0000e360: 2020 2020 2020 6966 2070 6174 7465 726e        if pattern
+0000e370: 5f73 6574 7469 6e67 732e 7363 616e 5f64  _settings.scan_d
+0000e380: 6972 6563 7469 6f6e 2069 6e20 7061 7468  irection in path
+0000e390: 733a 0a20 2020 2020 2020 2020 2020 2070  s:.            p
+0000e3a0: 6174 7465 726e 2e73 6361 6e5f 6469 7265  attern.scan_dire
+0000e3b0: 6374 696f 6e20 3d20 7061 7474 6572 6e5f  ction = pattern_
+0000e3c0: 7365 7474 696e 6773 2e73 6361 6e5f 6469  settings.scan_di
+0000e3d0: 7265 6374 696f 6e0a 2020 2020 2020 2020  rection.        
+0000e3e0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+0000e3f0: 2020 7061 7474 6572 6e2e 7363 616e 5f64    pattern.scan_d
+0000e400: 6972 6563 7469 6f6e 203d 2022 546f 7054  irection = "TopT
+0000e410: 6f42 6f74 746f 6d22 0a20 2020 2020 2020  oBottom".       
+0000e420: 2020 2020 206c 6f67 6769 6e67 2e69 6e66       logging.inf
+0000e430: 6f28 6622 5363 616e 2064 6972 6563 7469  o(f"Scan directi
+0000e440: 6f6e 207b 7061 7474 6572 6e5f 7365 7474  on {pattern_sett
+0000e450: 696e 6773 2e73 6361 6e5f 6469 7265 6374  ings.scan_direct
+0000e460: 696f 6e7d 206e 6f74 2073 7570 706f 7274  ion} not support
+0000e470: 6564 2e20 5573 696e 6720 546f 7054 6f42  ed. Using TopToB
+0000e480: 6f74 746f 6d20 696e 7374 6561 642e 2229  ottom instead.")
+0000e490: 0a20 2020 2020 2020 2020 2020 206c 6f67  .            log
+0000e4a0: 6769 6e67 2e69 6e66 6f28 6622 5375 7070  ging.info(f"Supp
+0000e4b0: 6f72 7465 6420 7363 616e 2064 6972 6563  orted scan direc
+0000e4c0: 7469 6f6e 7320 6172 653a 2042 6f74 746f  tions are: Botto
+0000e4d0: 6d54 6f54 6f70 2c20 4479 6e61 6d69 6341  mToTop, DynamicA
+0000e4e0: 6c6c 4469 7265 6374 696f 6e73 2c20 4479  llDirections, Dy
+0000e4f0: 6e61 6d69 6349 6e6e 6572 546f 4f75 7465  namicInnerToOute
+0000e500: 722c 2044 796e 616d 6963 4c65 6674 546f  r, DynamicLeftTo
+0000e510: 5269 6768 742c 2044 796e 616d 6963 546f  Right, DynamicTo
+0000e520: 7054 6f42 6f74 746f 6d2c 2049 6e6e 6572  pToBottom, Inner
+0000e530: 546f 4f75 7465 722c 204c 6566 7454 6f52  ToOuter, LeftToR
+0000e540: 6967 6874 2c20 4f75 7465 7254 6f49 6e6e  ight, OuterToInn
+0000e550: 6572 2c20 5269 6768 7454 6f4c 6566 742c  er, RightToLeft,
+0000e560: 2054 6f70 546f 426f 7474 6f6d 2229 2020   TopToBottom")  
+0000e570: 2020 2020 2020 0a20 2020 2020 2020 2069        .        i
+0000e580: 6620 7061 7474 6572 6e5f 7365 7474 696e  f pattern_settin
+0000e590: 6773 2e70 6173 7365 7320 6973 206e 6f74  gs.passes is not
+0000e5a0: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+0000e5b0: 2020 2070 6174 7465 726e 2e70 6173 735f     pattern.pass_
+0000e5c0: 636f 756e 7420 3d20 7061 7474 6572 6e5f  count = pattern_
+0000e5d0: 7365 7474 696e 6773 2e70 6173 7365 730a  settings.passes.
+0000e5e0: 2020 2020 2020 2020 7265 7475 726e 2070          return p
+0000e5f0: 6174 7465 726e 0a0a 2020 2020 6465 6620  attern..    def 
+0000e600: 6472 6177 5f6c 696e 6528 7365 6c66 2c20  draw_line(self, 
+0000e610: 7061 7474 6572 6e5f 7365 7474 696e 6773  pattern_settings
+0000e620: 3a20 4669 6273 656d 5061 7474 6572 6e53  : FibsemPatternS
+0000e630: 6574 7469 6e67 7329 3a0a 2020 2020 2020  ettings):.      
+0000e640: 2020 2222 220a 2020 2020 2020 2020 4472    """.        Dr
+0000e650: 6177 7320 6120 6c69 6e65 2070 6174 7465  aws a line patte
+0000e660: 726e 206f 6e20 7468 6520 6375 7272 656e  rn on the curren
+0000e670: 7420 696d 6167 696e 6720 7669 6577 206f  t imaging view o
+0000e680: 6620 7468 6520 6d69 6372 6f73 636f 7065  f the microscope
+0000e690: 2e0a 0a20 2020 2020 2020 2041 7267 733a  ...        Args:
+0000e6a0: 0a20 2020 2020 2020 2020 2020 2070 6174  .            pat
+0000e6b0: 7465 726e 5f73 6574 7469 6e67 7320 2846  tern_settings (F
+0000e6c0: 6962 7365 6d50 6174 7465 726e 5365 7474  ibsemPatternSett
+0000e6d0: 696e 6773 293a 2041 2064 6174 6120 636c  ings): A data cl
+0000e6e0: 6173 7320 6f62 6a65 6374 2073 7065 6369  ass object speci
+0000e6f0: 6679 696e 6720 7468 6520 7061 7474 6572  fying the patter
+0000e700: 6e20 7061 7261 6d65 7465 7273 2c0a 2020  n parameters,.  
+0000e710: 2020 2020 2020 2020 2020 2020 2020 696e                in
+0000e720: 636c 7564 696e 6720 7468 6520 7374 6172  cluding the star
+0000e730: 7420 616e 6420 656e 6420 706f 696e 7473  t and end points
+0000e740: 2c20 616e 6420 7468 6520 6465 7074 6820  , and the depth 
+0000e750: 6f66 2074 6865 2070 6174 7465 726e 2e0a  of the pattern..
+0000e760: 0a20 2020 2020 2020 2052 6574 7572 6e73  .        Returns
+0000e770: 3a0a 2020 2020 2020 2020 2020 2020 4c69  :.            Li
+0000e780: 6e65 5061 7474 6572 6e3a 2041 206c 696e  nePattern: A lin
+0000e790: 6520 7061 7474 6572 6e20 6f62 6a65 6374  e pattern object
+0000e7a0: 2c20 7768 6963 6820 6361 6e20 6265 2075  , which can be u
+0000e7b0: 7365 6420 746f 2063 6f6e 6669 6775 7265  sed to configure
+0000e7c0: 2066 7572 7468 6572 2070 726f 7065 7274   further propert
+0000e7d0: 6965 7320 6f72 2074 6f20 6164 6420 7468  ies or to add th
+0000e7e0: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
+0000e7f0: 2020 7061 7474 6572 6e20 746f 2074 6865    pattern to the
+0000e800: 206d 696c 6c69 6e67 206c 6973 742e 0a0a   milling list...
+0000e810: 2020 2020 2020 2020 5261 6973 6573 3a0a          Raises:.
+0000e820: 2020 2020 2020 2020 2020 2020 6175 746f              auto
+0000e830: 7363 7269 7074 2e65 7863 6570 7469 6f6e  script.exception
+0000e840: 732e 496e 7661 6c69 6441 7267 756d 656e  s.InvalidArgumen
+0000e850: 7445 7863 6570 7469 6f6e 3a20 6966 2061  tException: if a
+0000e860: 6e79 206f 6620 7468 6520 7061 7474 6572  ny of the patter
+0000e870: 6e20 7061 7261 6d65 7465 7273 2061 7265  n parameters are
+0000e880: 2069 6e76 616c 6964 2e0a 2020 2020 2020   invalid..      
+0000e890: 2020 2222 220a 2020 2020 2020 2020 7061    """.        pa
+0000e8a0: 7474 6572 6e20 3d20 7365 6c66 2e63 6f6e  ttern = self.con
+0000e8b0: 6e65 6374 696f 6e2e 7061 7474 6572 6e69  nection.patterni
+0000e8c0: 6e67 2e63 7265 6174 655f 6c69 6e65 280a  ng.create_line(.
+0000e8d0: 2020 2020 2020 2020 2020 2020 7374 6172              star
+0000e8e0: 745f 783d 7061 7474 6572 6e5f 7365 7474  t_x=pattern_sett
+0000e8f0: 696e 6773 2e73 7461 7274 5f78 2c0a 2020  ings.start_x,.  
+0000e900: 2020 2020 2020 2020 2020 7374 6172 745f            start_
+0000e910: 793d 7061 7474 6572 6e5f 7365 7474 696e  y=pattern_settin
+0000e920: 6773 2e73 7461 7274 5f79 2c0a 2020 2020  gs.start_y,.    
+0000e930: 2020 2020 2020 2020 656e 645f 783d 7061          end_x=pa
+0000e940: 7474 6572 6e5f 7365 7474 696e 6773 2e65  ttern_settings.e
+0000e950: 6e64 5f78 2c0a 2020 2020 2020 2020 2020  nd_x,.          
+0000e960: 2020 656e 645f 793d 7061 7474 6572 6e5f    end_y=pattern_
+0000e970: 7365 7474 696e 6773 2e65 6e64 5f79 2c0a  settings.end_y,.
+0000e980: 2020 2020 2020 2020 2020 2020 6465 7074              dept
+0000e990: 683d 7061 7474 6572 6e5f 7365 7474 696e  h=pattern_settin
+0000e9a0: 6773 2e64 6570 7468 2c0a 2020 2020 2020  gs.depth,.      
+0000e9b0: 2020 290a 0a20 2020 2020 2020 2072 6574    )..        ret
+0000e9c0: 7572 6e20 7061 7474 6572 6e0a 2020 2020  urn pattern.    
+0000e9d0: 0a20 2020 2064 6566 2064 7261 775f 6369  .    def draw_ci
+0000e9e0: 7263 6c65 2873 656c 662c 2070 6174 7465  rcle(self, patte
+0000e9f0: 726e 5f73 6574 7469 6e67 733a 2046 6962  rn_settings: Fib
+0000ea00: 7365 6d50 6174 7465 726e 5365 7474 696e  semPatternSettin
+0000ea10: 6773 293a 0a20 2020 2020 2020 2022 2222  gs):.        """
+0000ea20: 0a20 2020 2020 2020 2044 7261 7773 2061  .        Draws a
+0000ea30: 2063 6972 636c 6520 7061 7474 6572 6e20   circle pattern 
+0000ea40: 6f6e 2074 6865 2063 7572 7265 6e74 2069  on the current i
+0000ea50: 6d61 6769 6e67 2076 6965 7720 6f66 2074  maging view of t
+0000ea60: 6865 206d 6963 726f 7363 6f70 652e 0a0a  he microscope...
+0000ea70: 2020 2020 2020 2020 4172 6773 3a0a 2020          Args:.  
+0000ea80: 2020 2020 2020 2020 2020 7061 7474 6572            patter
+0000ea90: 6e5f 7365 7474 696e 6773 2028 4669 6273  n_settings (Fibs
+0000eaa0: 656d 5061 7474 6572 6e53 6574 7469 6e67  emPatternSetting
+0000eab0: 7329 3a20 4120 6461 7461 2063 6c61 7373  s): A data class
+0000eac0: 206f 626a 6563 7420 7370 6563 6966 7969   object specifyi
+0000ead0: 6e67 2074 6865 2070 6174 7465 726e 2070  ng the pattern p
+0000eae0: 6172 616d 6574 6572 732c 0a20 2020 2020  arameters,.     
+0000eaf0: 2020 2020 2020 2020 2020 2069 6e63 6c75             inclu
+0000eb00: 6469 6e67 2074 6865 2063 656e 7472 6520  ding the centre 
+0000eb10: 706f 696e 742c 2072 6164 6975 7320 616e  point, radius an
+0000eb20: 6420 6465 7074 6820 6f66 2074 6865 2070  d depth of the p
+0000eb30: 6174 7465 726e 2e0a 0a20 2020 2020 2020  attern...       
+0000eb40: 2052 6574 7572 6e73 3a0a 2020 2020 2020   Returns:.      
+0000eb50: 2020 2020 2020 4369 7263 6c65 5061 7474        CirclePatt
+0000eb60: 6572 6e3a 2041 2063 6972 636c 6520 7061  ern: A circle pa
+0000eb70: 7474 6572 6e20 6f62 6a65 6374 2c20 7768  ttern object, wh
+0000eb80: 6963 6820 6361 6e20 6265 2075 7365 6420  ich can be used 
+0000eb90: 746f 2063 6f6e 6669 6775 7265 2066 7572  to configure fur
+0000eba0: 7468 6572 2070 726f 7065 7274 6965 7320  ther properties 
+0000ebb0: 6f72 2074 6f20 6164 6420 7468 650a 2020  or to add the.  
+0000ebc0: 2020 2020 2020 2020 2020 2020 2020 7061                pa
+0000ebd0: 7474 6572 6e20 746f 2074 6865 206d 696c  ttern to the mil
+0000ebe0: 6c69 6e67 206c 6973 742e 0a0a 2020 2020  ling list...    
+0000ebf0: 2020 2020 5261 6973 6573 3a0a 2020 2020      Raises:.    
+0000ec00: 2020 2020 2020 2020 6175 746f 7363 7269          autoscri
+0000ec10: 7074 2e65 7863 6570 7469 6f6e 732e 496e  pt.exceptions.In
+0000ec20: 7661 6c69 6441 7267 756d 656e 7445 7863  validArgumentExc
+0000ec30: 6570 7469 6f6e 3a20 6966 2061 6e79 206f  eption: if any o
+0000ec40: 6620 7468 6520 7061 7474 6572 6e20 7061  f the pattern pa
+0000ec50: 7261 6d65 7465 7273 2061 7265 2069 6e76  rameters are inv
+0000ec60: 616c 6964 2e0a 2020 2020 2020 2020 2222  alid..        ""
+0000ec70: 220a 2020 2020 2020 2020 7061 7474 6572  ".        patter
+0000ec80: 6e20 3d20 7365 6c66 2e63 6f6e 6e65 6374  n = self.connect
+0000ec90: 696f 6e2e 7061 7474 6572 6e69 6e67 2e63  ion.patterning.c
+0000eca0: 7265 6174 655f 6369 7263 6c65 280a 2020  reate_circle(.  
+0000ecb0: 2020 2020 2020 2020 2020 6365 6e74 6572            center
+0000ecc0: 5f78 3d70 6174 7465 726e 5f73 6574 7469  _x=pattern_setti
+0000ecd0: 6e67 732e 6365 6e74 7265 5f78 2c0a 2020  ngs.centre_x,.  
+0000ece0: 2020 2020 2020 2020 2020 6365 6e74 6572            center
+0000ecf0: 5f79 3d70 6174 7465 726e 5f73 6574 7469  _y=pattern_setti
+0000ed00: 6e67 732e 6365 6e74 7265 5f79 2c0a 2020  ngs.centre_y,.  
+0000ed10: 2020 2020 2020 2020 2020 6f75 7465 725f            outer_
+0000ed20: 6469 616d 6574 6572 3d32 2a70 6174 7465  diameter=2*patte
+0000ed30: 726e 5f73 6574 7469 6e67 732e 7261 6469  rn_settings.radi
+0000ed40: 7573 2c0a 2020 2020 2020 2020 2020 2020  us,.            
+0000ed50: 696e 6e65 725f 6469 616d 6574 6572 203d  inner_diameter =
+0000ed60: 2030 2c0a 2020 2020 2020 2020 2020 2020   0,.            
+0000ed70: 6465 7074 683d 7061 7474 6572 6e5f 7365  depth=pattern_se
+0000ed80: 7474 696e 6773 2e64 6570 7468 2c0a 2020  ttings.depth,.  
+0000ed90: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
+0000eda0: 2072 6574 7572 6e20 7061 7474 6572 6e0a   return pattern.
+0000edb0: 0a20 2020 2064 6566 2064 7261 775f 616e  .    def draw_an
+0000edc0: 6e75 6c75 7328 7365 6c66 2c20 7061 7474  nulus(self, patt
+0000edd0: 6572 6e5f 7365 7474 696e 6773 3a20 4669  ern_settings: Fi
+0000ede0: 6273 656d 5061 7474 6572 6e53 6574 7469  bsemPatternSetti
+0000edf0: 6e67 7329 3a0a 0a20 2020 2020 2020 206f  ngs):..        o
+0000ee00: 7574 6572 5f64 6961 6d65 7465 7220 3d20  uter_diameter = 
+0000ee10: 322a 7061 7474 6572 6e5f 7365 7474 696e  2*pattern_settin
+0000ee20: 6773 2e72 6164 6975 730a 2020 2020 2020  gs.radius.      
+0000ee30: 2020 696e 6e65 725f 6469 616d 6574 6572    inner_diameter
+0000ee40: 203d 206f 7574 6572 5f64 6961 6d65 7465   = outer_diamete
+0000ee50: 7220 2d20 322a 7061 7474 6572 6e5f 7365  r - 2*pattern_se
+0000ee60: 7474 696e 6773 2e74 6869 636b 6e65 7373  ttings.thickness
+0000ee70: 0a0a 2020 2020 2020 2020 7061 7474 6572  ..        patter
+0000ee80: 6e20 3d20 7365 6c66 2e63 6f6e 6e65 6374  n = self.connect
+0000ee90: 696f 6e2e 7061 7474 6572 6e69 6e67 2e63  ion.patterning.c
+0000eea0: 7265 6174 655f 6369 7263 6c65 280a 2020  reate_circle(.  
+0000eeb0: 2020 2020 2020 2020 2020 6365 6e74 6572            center
+0000eec0: 5f78 3d70 6174 7465 726e 5f73 6574 7469  _x=pattern_setti
+0000eed0: 6e67 732e 6365 6e74 7265 5f78 2c0a 2020  ngs.centre_x,.  
+0000eee0: 2020 2020 2020 2020 2020 6365 6e74 6572            center
+0000eef0: 5f79 3d70 6174 7465 726e 5f73 6574 7469  _y=pattern_setti
+0000ef00: 6e67 732e 6365 6e74 7265 5f79 2c0a 2020  ngs.centre_y,.  
+0000ef10: 2020 2020 2020 2020 2020 6f75 7465 725f            outer_
+0000ef20: 6469 616d 6574 6572 3d6f 7574 6572 5f64  diameter=outer_d
+0000ef30: 6961 6d65 7465 722c 0a20 2020 2020 2020  iameter,.       
+0000ef40: 2020 2020 2069 6e6e 6572 5f64 6961 6d65       inner_diame
+0000ef50: 7465 7220 3d20 696e 6e65 725f 6469 616d  ter = inner_diam
+0000ef60: 6574 6572 2c0a 2020 2020 2020 2020 2020  eter,.          
+0000ef70: 2020 6465 7074 683d 7061 7474 6572 6e5f    depth=pattern_
+0000ef80: 7365 7474 696e 6773 2e64 6570 7468 2c0a  settings.depth,.
+0000ef90: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
+0000efa0: 2020 2072 6574 7572 6e20 7061 7474 6572     return patter
+0000efb0: 6e0a 2020 2020 0a20 2020 200a 2020 2020  n.    .    .    
+0000efc0: 6465 6620 6472 6177 5f62 6974 6d61 705f  def draw_bitmap_
+0000efd0: 7061 7474 6572 6e28 0a20 2020 2020 2020  pattern(.       
+0000efe0: 2073 656c 662c 0a20 2020 2020 2020 2070   self,.        p
+0000eff0: 6174 7465 726e 5f73 6574 7469 6e67 733a  attern_settings:
+0000f000: 2046 6962 7365 6d50 6174 7465 726e 5365   FibsemPatternSe
+0000f010: 7474 696e 6773 2c0a 2020 2020 2020 2020  ttings,.        
+0000f020: 7061 7468 3a20 7374 722c 0a20 2020 2029  path: str,.    )
+0000f030: 3a0a 0a20 2020 2020 2020 2062 6974 6d61  :..        bitma
+0000f040: 705f 7061 7474 6572 6e20 3d20 4269 746d  p_pattern = Bitm
+0000f050: 6170 5061 7474 6572 6e44 6566 696e 6974  apPatternDefinit
+0000f060: 696f 6e2e 6c6f 6164 2870 6174 6829 0a0a  ion.load(path)..
+0000f070: 2020 2020 2020 2020 7061 7474 6572 6e20          pattern 
+0000f080: 3d20 7365 6c66 2e63 6f6e 6e65 6374 696f  = self.connectio
+0000f090: 6e2e 7061 7474 6572 6e69 6e67 2e63 7265  n.patterning.cre
+0000f0a0: 6174 655f 6269 746d 6170 280a 2020 2020  ate_bitmap(.    
+0000f0b0: 2020 2020 2020 2020 6365 6e74 6572 5f78          center_x
+0000f0c0: 3d70 6174 7465 726e 5f73 6574 7469 6e67  =pattern_setting
+0000f0d0: 732e 6365 6e74 7265 5f78 2c0a 2020 2020  s.centre_x,.    
+0000f0e0: 2020 2020 2020 2020 6365 6e74 6572 5f79          center_y
+0000f0f0: 3d70 6174 7465 726e 5f73 6574 7469 6e67  =pattern_setting
+0000f100: 732e 6365 6e74 7265 5f79 2c0a 2020 2020  s.centre_y,.    
+0000f110: 2020 2020 2020 2020 7769 6474 683d 7061          width=pa
+0000f120: 7474 6572 6e5f 7365 7474 696e 6773 2e77  ttern_settings.w
+0000f130: 6964 7468 2c0a 2020 2020 2020 2020 2020  idth,.          
+0000f140: 2020 6865 6967 6874 3d70 6174 7465 726e    height=pattern
+0000f150: 5f73 6574 7469 6e67 732e 6865 6967 6874  _settings.height
+0000f160: 2c0a 2020 2020 2020 2020 2020 2020 6465  ,.            de
+0000f170: 7074 683d 7061 7474 6572 6e5f 7365 7474  pth=pattern_sett
+0000f180: 696e 6773 2e64 6570 7468 2c0a 2020 2020  ings.depth,.    
+0000f190: 2020 2020 2020 2020 6269 746d 6170 5f70          bitmap_p
+0000f1a0: 6174 7465 726e 5f64 6566 696e 6974 696f  attern_definitio
+0000f1b0: 6e3d 6269 746d 6170 5f70 6174 7465 726e  n=bitmap_pattern
+0000f1c0: 2c0a 2020 2020 2020 2020 290a 0a20 2020  ,.        )..   
+0000f1d0: 2020 2020 2072 6574 7572 6e20 7061 7474       return patt
+0000f1e0: 6572 6e0a 0a20 2020 2064 6566 2067 6574  ern..    def get
+0000f1f0: 5f73 6361 6e5f 6469 7265 6374 696f 6e73  _scan_directions
+0000f200: 2873 656c 6629 202d 3e20 6c69 7374 3a0a  (self) -> list:.
+0000f210: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+0000f220: 2020 2020 5265 7475 726e 7320 7468 6520      Returns the 
+0000f230: 6176 6169 6c61 626c 6520 7363 616e 2064  available scan d
+0000f240: 6972 6563 7469 6f6e 7320 6f66 2074 6865  irections of the
+0000f250: 206d 6963 726f 7363 6f70 652e 0a0a 2020   microscope...  
+0000f260: 2020 2020 2020 5265 7475 726e 733a 0a20        Returns:. 
+0000f270: 2020 2020 2020 2020 2020 206c 6973 743a             list:
+0000f280: 2054 6865 2073 6361 6e20 6469 7265 6374   The scan direct
+0000f290: 696f 6e20 6f66 2074 6865 206d 6963 726f  ion of the micro
+0000f2a0: 7363 6f70 652e 0a0a 2020 2020 2020 2020  scope...        
+0000f2b0: 5261 6973 6573 3a0a 2020 2020 2020 2020  Raises:.        
+0000f2c0: 2020 2020 4e6f 6e65 0a20 2020 2020 2020      None.       
+0000f2d0: 2022 2222 0a20 2020 2020 2020 206c 6973   """.        lis
+0000f2e0: 7420 3d20 5b22 426f 7474 6f6d 546f 546f  t = ["BottomToTo
+0000f2f0: 7022 2c20 0a20 2020 2020 2020 2020 2020  p", .           
+0000f300: 2020 2020 2022 4479 6e61 6d69 6341 6c6c       "DynamicAll
+0000f310: 4469 7265 6374 696f 6e73 222c 200a 2020  Directions", .  
+0000f320: 2020 2020 2020 2020 2020 2020 2020 2244                "D
+0000f330: 796e 616d 6963 496e 6e65 7254 6f4f 7574  ynamicInnerToOut
+0000f340: 6572 222c 200a 2020 2020 2020 2020 2020  er", .          
+0000f350: 2020 2020 2020 2244 796e 616d 6963 4c65        "DynamicLe
+0000f360: 6674 546f 5269 6768 7422 2c20 0a20 2020  ftToRight", .   
+0000f370: 2020 2020 2020 2020 2020 2020 2022 4479               "Dy
+0000f380: 6e61 6d69 6354 6f70 546f 426f 7474 6f6d  namicTopToBottom
+0000f390: 222c 200a 2020 2020 2020 2020 2020 2020  ", .            
+0000f3a0: 2020 2020 2249 6e6e 6572 546f 4f75 7465      "InnerToOute
+0000f3b0: 7222 2c20 090a 2020 2020 2020 2020 2020  r", ..          
+0000f3c0: 2020 2020 2020 224c 6566 7454 6f52 6967        "LeftToRig
+0000f3d0: 6874 222c 2009 0a20 2020 2020 2020 2020  ht", ..         
+0000f3e0: 2020 2020 2020 2022 4f75 7465 7254 6f49         "OuterToI
+0000f3f0: 6e6e 6572 222c 200a 2020 2020 2020 2020  nner", .        
+0000f400: 2020 2020 2020 2020 2252 6967 6874 546f          "RightTo
+0000f410: 4c65 6674 222c 2009 0a20 2020 2020 2020  Left", ..       
+0000f420: 2020 2020 2020 2020 2022 546f 7054 6f42           "TopToB
+0000f430: 6f74 746f 6d22 5d0a 2020 2020 2020 2020  ottom"].        
+0000f440: 7265 7475 726e 206c 6973 7420 0a0a 0a20  return list ... 
+0000f450: 2020 2064 6566 2073 6574 7570 5f73 7075     def setup_spu
+0000f460: 7474 6572 2873 656c 662c 2070 726f 746f  tter(self, proto
+0000f470: 636f 6c3a 2064 6963 7429 3a0a 2020 2020  col: dict):.    
+0000f480: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+0000f490: 5365 7420 7570 2074 6865 2073 7075 7474  Set up the sputt
+0000f4a0: 6572 2063 6f61 7469 6e67 2070 726f 6365  er coating proce
+0000f4b0: 7373 206f 6e20 7468 6520 6d69 6372 6f73  ss on the micros
+0000f4c0: 636f 7065 2e0a 0a20 2020 2020 2020 2041  cope...        A
+0000f4d0: 7267 733a 0a20 2020 2020 2020 2020 2020  rgs:.           
+0000f4e0: 2070 726f 746f 636f 6c20 2864 6963 7429   protocol (dict)
+0000f4f0: 3a20 4469 6374 696f 6e61 7279 2063 6f6e  : Dictionary con
+0000f500: 7461 696e 696e 6720 7468 6520 7072 6f74  taining the prot
+0000f510: 6f63 6f6c 2064 6574 6169 6c73 2066 6f72  ocol details for
+0000f520: 2073 7075 7474 6572 2063 6f61 7469 6e67   sputter coating
+0000f530: 2e0a 0a20 2020 2020 2020 2052 6574 7572  ...        Retur
+0000f540: 6e73 3a0a 2020 2020 2020 2020 2020 2020  ns:.            
+0000f550: 4e6f 6e65 0a0a 2020 2020 2020 2020 5261  None..        Ra
+0000f560: 6973 6573 3a0a 2020 2020 2020 2020 2020  ises:.          
+0000f570: 2020 4e6f 6e65 0a0a 2020 2020 2020 2020    None..        
+0000f580: 4e6f 7465 733a 0a20 2020 2020 2020 2020  Notes:.         
+0000f590: 2020 2054 6869 7320 6675 6e63 7469 6f6e     This function
+0000f5a0: 2073 6574 7320 7570 2074 6865 2073 7075   sets up the spu
+0000f5b0: 7474 6572 2063 6f61 7469 6e67 2070 726f  tter coating pro
+0000f5c0: 6365 7373 206f 6e20 7468 6520 6d69 6372  cess on the micr
+0000f5d0: 6f73 636f 7065 2e20 0a20 2020 2020 2020  oscope. .       
+0000f5e0: 2020 2020 2049 7420 7365 7473 2074 6865       It sets the
+0000f5f0: 2061 6374 6976 6520 7669 6577 2074 6f20   active view to 
+0000f600: 7468 6520 656c 6563 7472 6f6e 2062 6561  the electron bea
+0000f610: 6d2c 2063 6c65 6172 7320 616e 7920 6578  m, clears any ex
+0000f620: 6973 7469 6e67 2070 6174 7465 726e 732c  isting patterns,
+0000f630: 2061 6e64 2073 6574 7320 7468 6520 6465   and sets the de
+0000f640: 6661 756c 7420 6265 616d 2074 7970 6520  fault beam type 
+0000f650: 746f 2074 6865 2065 6c65 6374 726f 6e20  to the electron 
+0000f660: 6265 616d 2e20 0a20 2020 2020 2020 2020  beam. .         
+0000f670: 2020 2049 7420 7468 656e 2069 6e73 6572     It then inser
+0000f680: 7473 2074 6865 206d 756c 7469 6368 656d  ts the multichem
+0000f690: 2061 6e64 2074 7572 6e73 206f 6e20 7468   and turns on th
+0000f6a0: 6520 6865 6174 6572 2066 6f72 2074 6865  e heater for the
+0000f6b0: 2073 7065 6369 6669 6564 2067 6173 2061   specified gas a
+0000f6c0: 6363 6f72 6469 6e67 2074 6f20 7468 6520  ccording to the 
+0000f6d0: 6769 7665 6e20 7072 6f74 6f63 6f6c 2e20  given protocol. 
+0000f6e0: 0a20 2020 2020 2020 2020 2020 2054 6869  .            Thi
+0000f6f0: 7320 6675 6e63 7469 6f6e 2061 6c73 6f20  s function also 
+0000f700: 7761 6974 7320 666f 7220 3320 7365 636f  waits for 3 seco
+0000f710: 6e64 7320 746f 2061 6c6c 6f77 2074 6865  nds to allow the
+0000f720: 2068 6561 7465 7220 746f 2077 6172 6d20   heater to warm 
+0000f730: 7570 2e0a 2020 2020 2020 2020 2222 220a  up..        """.
+0000f740: 2020 2020 2020 2020 5f63 6865 636b 5f73          _check_s
+0000f750: 7075 7474 6572 2873 656c 662e 6861 7264  putter(self.hard
+0000f760: 7761 7265 5f73 6574 7469 6e67 7329 0a20  ware_settings). 
+0000f770: 2020 2020 2020 2073 656c 662e 6f72 6967         self.orig
+0000f780: 696e 616c 5f61 6374 6976 655f 7669 6577  inal_active_view
+0000f790: 203d 2073 656c 662e 636f 6e6e 6563 7469   = self.connecti
+0000f7a0: 6f6e 2e69 6d61 6769 6e67 2e67 6574 5f61  on.imaging.get_a
+0000f7b0: 6374 6976 655f 7669 6577 2829 0a20 2020  ctive_view().   
+0000f7c0: 2020 2020 2073 656c 662e 636f 6e6e 6563       self.connec
+0000f7d0: 7469 6f6e 2e69 6d61 6769 6e67 2e73 6574  tion.imaging.set
+0000f7e0: 5f61 6374 6976 655f 7669 6577 2842 6561  _active_view(Bea
+0000f7f0: 6d54 7970 652e 454c 4543 5452 4f4e 2e76  mType.ELECTRON.v
+0000f800: 616c 7565 290a 2020 2020 2020 2020 7365  alue).        se
+0000f810: 6c66 2e63 6f6e 6e65 6374 696f 6e2e 7061  lf.connection.pa
+0000f820: 7474 6572 6e69 6e67 2e63 6c65 6172 5f70  tterning.clear_p
+0000f830: 6174 7465 726e 7328 290a 2020 2020 2020  atterns().      
+0000f840: 2020 7365 6c66 2e63 6f6e 6e65 6374 696f    self.connectio
+0000f850: 6e2e 7061 7474 6572 6e69 6e67 2e73 6574  n.patterning.set
+0000f860: 5f64 6566 6175 6c74 5f61 7070 6c69 6361  _default_applica
+0000f870: 7469 6f6e 5f66 696c 6528 7072 6f74 6f63  tion_file(protoc
+0000f880: 6f6c 5b22 6170 706c 6963 6174 696f 6e5f  ol["application_
+0000f890: 6669 6c65 225d 290a 2020 2020 2020 2020  file"]).        
+0000f8a0: 7365 6c66 2e63 6f6e 6e65 6374 696f 6e2e  self.connection.
+0000f8b0: 7061 7474 6572 6e69 6e67 2e73 6574 5f64  patterning.set_d
+0000f8c0: 6566 6175 6c74 5f62 6561 6d5f 7479 7065  efault_beam_type
+0000f8d0: 2842 6561 6d54 7970 652e 454c 4543 5452  (BeamType.ELECTR
+0000f8e0: 4f4e 2e76 616c 7565 290a 2020 2020 2020  ON.value).      
+0000f8f0: 2020 7365 6c66 2e6d 756c 7469 6368 656d    self.multichem
+0000f900: 203d 2073 656c 662e 636f 6e6e 6563 7469   = self.connecti
+0000f910: 6f6e 2e67 6173 2e67 6574 5f6d 756c 7469  on.gas.get_multi
+0000f920: 6368 656d 2829 0a20 2020 2020 2020 2073  chem().        s
+0000f930: 656c 662e 6d75 6c74 6963 6865 6d2e 696e  elf.multichem.in
+0000f940: 7365 7274 2870 726f 746f 636f 6c5b 2270  sert(protocol["p
+0000f950: 6f73 6974 696f 6e22 5d29 0a20 2020 2020  osition"]).     
+0000f960: 2020 2073 656c 662e 6d75 6c74 6963 6865     self.multiche
+0000f970: 6d2e 7475 726e 5f68 6561 7465 725f 6f6e  m.turn_heater_on
+0000f980: 2870 726f 746f 636f 6c5b 2267 6173 225d  (protocol["gas"]
+0000f990: 2920 2023 2022 5074 2063 7279 6f22 290a  )  # "Pt cryo").
+0000f9a0: 2020 2020 2020 2020 7469 6d65 2e73 6c65          time.sle
+0000f9b0: 6570 2833 290a 0a20 2020 2064 6566 2064  ep(3)..    def d
+0000f9c0: 7261 775f 7370 7574 7465 725f 7061 7474  raw_sputter_patt
+0000f9d0: 6572 6e28 7365 6c66 2c20 6866 773a 2066  ern(self, hfw: f
+0000f9e0: 6c6f 6174 2c20 6c69 6e65 5f70 6174 7465  loat, line_patte
+0000f9f0: 726e 5f6c 656e 6774 683a 2066 6c6f 6174  rn_length: float
+0000fa00: 2c20 7370 7574 7465 725f 7469 6d65 3a20  , sputter_time: 
+0000fa10: 666c 6f61 7429 3a0a 2020 2020 2020 2020  float):.        
+0000fa20: 2222 220a 2020 2020 2020 2020 4472 6177  """.        Draw
+0000fa30: 7320 6120 6c69 6e65 2070 6174 7465 726e  s a line pattern
+0000fa40: 2066 6f72 2073 7075 7474 6572 696e 6720   for sputtering 
+0000fa50: 7769 7468 2074 6865 2067 6976 656e 2070  with the given p
+0000fa60: 6172 616d 6574 6572 732e 0a0a 2020 2020  arameters...    
+0000fa70: 2020 2020 4172 6773 3a0a 2020 2020 2020      Args:.      
+0000fa80: 2020 2020 2020 6866 7720 2866 6c6f 6174        hfw (float
+0000fa90: 293a 2054 6865 2068 6f72 697a 6f6e 7461  ): The horizonta
+0000faa0: 6c20 6669 656c 6420 7769 6474 6820 6f66  l field width of
+0000fab0: 2074 6865 2065 6c65 6374 726f 6e20 6265   the electron be
+0000fac0: 616d 2e0a 2020 2020 2020 2020 2020 2020  am..            
+0000fad0: 6c69 6e65 5f70 6174 7465 726e 5f6c 656e  line_pattern_len
+0000fae0: 6774 6820 2866 6c6f 6174 293a 2054 6865  gth (float): The
+0000faf0: 206c 656e 6774 6820 6f66 2074 6865 206c   length of the l
+0000fb00: 696e 6520 7061 7474 6572 6e20 746f 2064  ine pattern to d
+0000fb10: 7261 772e 0a20 2020 2020 2020 2020 2020  raw..           
+0000fb20: 2073 7075 7474 6572 5f74 696d 6520 2866   sputter_time (f
+0000fb30: 6c6f 6174 293a 2054 6865 2074 696d 6520  loat): The time 
+0000fb40: 746f 2073 7075 7474 6572 2074 6865 206c  to sputter the l
+0000fb50: 696e 6520 7061 7474 6572 6e2e 0a0a 2020  ine pattern...  
+0000fb60: 2020 2020 2020 5265 7475 726e 733a 0a20        Returns:. 
+0000fb70: 2020 2020 2020 2020 2020 204e 6f6e 650a             None.
+0000fb80: 0a20 2020 2020 2020 204e 6f74 6573 3a0a  .        Notes:.
+0000fb90: 2020 2020 2020 2020 2020 2020 5365 7473              Sets
+0000fba0: 2074 6865 2068 6f72 697a 6f6e 7461 6c20   the horizontal 
+0000fbb0: 6669 656c 6420 7769 6474 6820 6f66 2074  field width of t
+0000fbc0: 6865 2065 6c65 6374 726f 6e20 6265 616d  he electron beam
+0000fbd0: 2074 6f20 7468 6520 6769 7665 6e20 7661   to the given va
+0000fbe0: 6c75 652e 0a20 2020 2020 2020 2020 2020  lue..           
+0000fbf0: 2044 7261 7773 2061 206c 696e 6520 7061   Draws a line pa
+0000fc00: 7474 6572 6e20 666f 7220 7370 7574 7465  ttern for sputte
+0000fc10: 7269 6e67 2077 6974 6820 7468 6520 6769  ring with the gi
+0000fc20: 7665 6e20 6c65 6e67 7468 2061 6e64 206d  ven length and m
+0000fc30: 696c 6c69 6e67 2064 6570 7468 2e0a 2020  illing depth..  
+0000fc40: 2020 2020 2020 2020 2020 5365 7473 2074            Sets t
+0000fc50: 6865 2073 7075 7474 6572 2074 696d 6520  he sputter time 
+0000fc60: 6f66 2074 6865 206c 696e 6520 7061 7474  of the line patt
+0000fc70: 6572 6e20 746f 2074 6865 2067 6976 656e  ern to the given
+0000fc80: 2076 616c 7565 2e0a 0a20 2020 2020 2020   value...       
+0000fc90: 2022 2222 0a20 2020 2020 2020 2073 656c   """.        sel
+0000fca0: 662e 636f 6e6e 6563 7469 6f6e 2e62 6561  f.connection.bea
+0000fcb0: 6d73 2e65 6c65 6374 726f 6e5f 6265 616d  ms.electron_beam
+0000fcc0: 2e68 6f72 697a 6f6e 7461 6c5f 6669 656c  .horizontal_fiel
+0000fcd0: 645f 7769 6474 682e 7661 6c75 6520 3d20  d_width.value = 
+0000fce0: 6866 770a 2020 2020 2020 2020 7061 7474  hfw.        patt
+0000fcf0: 6572 6e20 3d20 7365 6c66 2e63 6f6e 6e65  ern = self.conne
+0000fd00: 6374 696f 6e2e 7061 7474 6572 6e69 6e67  ction.patterning
+0000fd10: 2e63 7265 6174 655f 6c69 6e65 280a 2020  .create_line(.  
+0000fd20: 2020 2020 2020 2020 2020 2d6c 696e 655f            -line_
+0000fd30: 7061 7474 6572 6e5f 6c65 6e67 7468 202f  pattern_length /
+0000fd40: 2032 2c20 2023 2078 5f73 7461 7274 0a20   2,  # x_start. 
+0000fd50: 2020 2020 2020 2020 2020 202b 6c69 6e65             +line
+0000fd60: 5f70 6174 7465 726e 5f6c 656e 6774 682c  _pattern_length,
+0000fd70: 2020 2320 795f 7374 6172 740a 2020 2020    # y_start.    
+0000fd80: 2020 2020 2020 2020 2b6c 696e 655f 7061          +line_pa
+0000fd90: 7474 6572 6e5f 6c65 6e67 7468 202f 2032  ttern_length / 2
+0000fda0: 2c20 2023 2078 5f65 6e64 0a20 2020 2020  ,  # x_end.     
+0000fdb0: 2020 2020 2020 202b 6c69 6e65 5f70 6174         +line_pat
+0000fdc0: 7465 726e 5f6c 656e 6774 682c 2020 2320  tern_length,  # 
+0000fdd0: 795f 656e 640a 2020 2020 2020 2020 2020  y_end.          
+0000fde0: 2020 3265 2d36 2c0a 2020 2020 2020 2020    2e-6,.        
+0000fdf0: 2920 2023 206d 696c 6c69 6e67 2064 6570  )  # milling dep
+0000fe00: 7468 0a20 2020 2020 2020 2070 6174 7465  th.        patte
+0000fe10: 726e 2e74 696d 6520 3d20 7370 7574 7465  rn.time = sputte
+0000fe20: 725f 7469 6d65 202b 2030 2e31 0a0a 2020  r_time + 0.1..  
+0000fe30: 2020 6465 6620 7275 6e5f 7370 7574 7465    def run_sputte
+0000fe40: 7228 7365 6c66 2c20 2a2a 6b77 6172 6773  r(self, **kwargs
+0000fe50: 293a 0a20 2020 2020 2020 2022 2222 0a20  ):.        """. 
+0000fe60: 2020 2020 2020 2052 756e 7320 7468 6520         Runs the 
+0000fe70: 4749 5320 506c 6174 696e 756d 2053 7075  GIS Platinum Spu
+0000fe80: 7474 6572 2e0a 0a20 2020 2020 2020 2041  tter...        A
+0000fe90: 7267 733a 0a20 2020 2020 2020 2020 2020  rgs:.           
+0000fea0: 202a 2a6b 7761 7267 733a 204f 7074 696f   **kwargs: Optio
+0000feb0: 6e61 6c20 6b65 7977 6f72 6420 6172 6775  nal keyword argu
+0000fec0: 6d65 6e74 7320 666f 7220 7468 6520 7370  ments for the sp
+0000fed0: 7574 7465 7220 6675 6e63 7469 6f6e 2e20  utter function. 
+0000fee0: 5468 6520 7265 7175 6972 6564 2061 7267  The required arg
+0000fef0: 756d 656e 7420 666f 720a 2020 2020 2020  ument for.      
+0000ff00: 2020 7468 6520 5468 6572 6d6f 2076 6572    the Thermo ver
+0000ff10: 7369 6f6e 2069 7320 2273 7075 7474 6572  sion is "sputter
+0000ff20: 5f74 696d 6522 2028 696e 7429 2c20 7768  _time" (int), wh
+0000ff30: 6963 6820 7370 6563 6966 6965 7320 7468  ich specifies th
+0000ff40: 6520 7469 6d65 2074 6f20 7370 7574 7465  e time to sputte
+0000ff50: 7220 696e 2073 6563 6f6e 6473 2e20 0a0a  r in seconds. ..
+0000ff60: 2020 2020 2020 2020 5265 7475 726e 733a          Returns:
+0000ff70: 0a20 2020 2020 2020 2020 2020 204e 6f6e  .            Non
+0000ff80: 650a 0a20 2020 2020 2020 204e 6f74 6573  e..        Notes
+0000ff90: 3a0a 2020 2020 2020 2020 2d20 426c 616e  :.        - Blan
+0000ffa0: 6b73 2074 6865 2065 6c65 6374 726f 6e20  ks the electron 
+0000ffb0: 6265 616d 2e0a 2020 2020 2020 2020 2d20  beam..        - 
+0000ffc0: 5374 6172 7473 2073 7075 7474 6572 696e  Starts sputterin
+0000ffd0: 6720 7769 7468 2070 6c61 7469 6e75 6d20  g with platinum 
+0000ffe0: 666f 7220 7468 6520 7370 6563 6966 6965  for the specifie
+0000fff0: 6420 7370 7574 7465 7220 7469 6d65 2c20  d sputter time, 
+00010000: 616e 6420 7761 6974 7320 756e 7469 6c20  and waits until 
+00010010: 7468 6520 7370 7574 7465 7269 6e67 0a20  the sputtering. 
+00010020: 2020 2020 2020 2069 7320 636f 6d70 6c65         is comple
+00010030: 7465 2062 6566 6f72 6520 636f 6e74 696e  te before contin
+00010040: 7569 6e67 2e0a 2020 2020 2020 2020 2d20  uing..        - 
+00010050: 4966 2074 6865 2070 6174 7465 726e 696e  If the patternin
+00010060: 6720 7374 6174 6520 6973 206e 6f74 2072  g state is not r
+00010070: 6561 6479 2c20 7261 6973 6573 2061 2052  eady, raises a R
+00010080: 756e 7469 6d65 4572 726f 722e 0a20 2020  untimeError..   
+00010090: 2020 2020 202d 2049 6620 7468 6520 7061       - If the pa
+000100a0: 7474 6572 6e69 6e67 2073 7461 7465 2069  tterning state i
+000100b0: 7320 7275 6e6e 696e 672c 2073 746f 7073  s running, stops
+000100c0: 2074 6865 2070 6174 7465 726e 696e 672e   the patterning.
+000100d0: 0a20 2020 2020 2020 202d 2049 6620 7468  .        - If th
+000100e0: 6520 7061 7474 6572 6e69 6e67 2073 7461  e patterning sta
+000100f0: 7465 2069 7320 6964 6c65 2c20 6c6f 6773  te is idle, logs
+00010100: 2061 2077 6172 6e69 6e67 206d 6573 7361   a warning messa
+00010110: 6765 2073 7567 6765 7374 696e 6720 746f  ge suggesting to
+00010120: 2061 646a 7573 7420 7468 6520 7061 7474   adjust the patt
+00010130: 6572 6e69 6e67 0a20 2020 2020 2020 206c  erning.        l
+00010140: 696e 6520 6465 7074 682e 0a20 2020 2020  ine depth..     
+00010150: 2020 2022 2222 0a20 2020 2020 2020 205f     """.        _
+00010160: 6368 6563 6b5f 7370 7574 7465 7228 7365  check_sputter(se
+00010170: 6c66 2e68 6172 6477 6172 655f 7365 7474  lf.hardware_sett
+00010180: 696e 6773 290a 2020 2020 2020 2020 7370  ings).        sp
+00010190: 7574 7465 725f 7469 6d65 203d 206b 7761  utter_time = kwa
+000101a0: 7267 735b 2273 7075 7474 6572 5f74 696d  rgs["sputter_tim
+000101b0: 6522 5d0a 0a20 2020 2020 2020 2073 656c  e"]..        sel
+000101c0: 662e 636f 6e6e 6563 7469 6f6e 2e62 6561  f.connection.bea
+000101d0: 6d73 2e65 6c65 6374 726f 6e5f 6265 616d  ms.electron_beam
+000101e0: 2e62 6c61 6e6b 2829 0a20 2020 2020 2020  .blank().       
+000101f0: 2069 6620 7365 6c66 2e63 6f6e 6e65 6374   if self.connect
+00010200: 696f 6e2e 7061 7474 6572 6e69 6e67 2e73  ion.patterning.s
+00010210: 7461 7465 203d 3d20 2249 646c 6522 3a0a  tate == "Idle":.
+00010220: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
+00010230: 696e 672e 696e 666f 2822 5370 7574 7465  ing.info("Sputte
+00010240: 7269 6e67 2077 6974 6820 706c 6174 696e  ring with platin
+00010250: 756d 2066 6f72 207b 7d20 7365 636f 6e64  um for {} second
+00010260: 732e 2e2e 222e 666f 726d 6174 2873 7075  s...".format(spu
+00010270: 7474 6572 5f74 696d 6529 290a 2020 2020  tter_time)).    
+00010280: 2020 2020 2020 2020 7365 6c66 2e63 6f6e          self.con
+00010290: 6e65 6374 696f 6e2e 7061 7474 6572 6e69  nection.patterni
+000102a0: 6e67 2e73 7461 7274 2829 2020 2320 6173  ng.start()  # as
+000102b0: 796e 6368 726f 6e6f 7573 2070 6174 7465  ynchronous patte
+000102c0: 726e 696e 670a 2020 2020 2020 2020 2020  rning.          
+000102d0: 2020 7469 6d65 2e73 6c65 6570 2873 7075    time.sleep(spu
+000102e0: 7474 6572 5f74 696d 6520 2b20 3529 0a20  tter_time + 5). 
+000102f0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00010300: 2020 2020 2020 2020 2072 6169 7365 2052           raise R
+00010310: 756e 7469 6d65 4572 726f 7228 2243 616e  untimeError("Can
+00010320: 2774 2073 7075 7474 6572 2070 6c61 7469  't sputter plati
+00010330: 6e75 6d2c 2070 6174 7465 726e 696e 6720  num, patterning 
+00010340: 7374 6174 6520 6973 206e 6f74 2072 6561  state is not rea
+00010350: 6479 2e22 290a 2020 2020 2020 2020 6966  dy.").        if
+00010360: 2073 656c 662e 636f 6e6e 6563 7469 6f6e   self.connection
+00010370: 2e70 6174 7465 726e 696e 672e 7374 6174  .patterning.stat
+00010380: 6520 3d3d 2022 5275 6e6e 696e 6722 3a0a  e == "Running":.
+00010390: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+000103a0: 2e63 6f6e 6e65 6374 696f 6e2e 7061 7474  .connection.patt
+000103b0: 6572 6e69 6e67 2e73 746f 7028 290a 2020  erning.stop().  
+000103c0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+000103d0: 2020 2020 2020 2020 6c6f 6767 696e 672e          logging.
+000103e0: 7761 726e 696e 6728 2250 6174 7465 726e  warning("Pattern
+000103f0: 696e 6720 7374 6174 6520 6973 207b 7d22  ing state is {}"
+00010400: 2e66 6f72 6d61 7428 7365 6c66 2e63 6f6e  .format(self.con
+00010410: 6e65 6374 696f 6e2e 7061 7474 6572 6e69  nection.patterni
+00010420: 6e67 2e73 7461 7465 2929 0a20 2020 2020  ng.state)).     
+00010430: 2020 2020 2020 206c 6f67 6769 6e67 2e77         logging.w
+00010440: 6172 6e69 6e67 2822 436f 6e73 6964 6572  arning("Consider
+00010450: 2061 646a 7573 7469 6e67 2074 6865 2070   adjusting the p
+00010460: 6174 7465 726e 696e 6720 6c69 6e65 2064  atterning line d
+00010470: 6570 7468 2e22 290a 0a20 2020 2064 6566  epth.")..    def
+00010480: 2066 696e 6973 685f 7370 7574 7465 7228   finish_sputter(
+00010490: 7365 6c66 2c20 6170 706c 6963 6174 696f  self, applicatio
+000104a0: 6e5f 6669 6c65 3a20 7374 7229 202d 3e20  n_file: str) -> 
+000104b0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2222  None:.        ""
+000104c0: 220a 2020 2020 2020 2020 4669 6e69 7368  ".        Finish
+000104d0: 2074 6865 2073 7075 7474 6572 2070 726f   the sputter pro
+000104e0: 6365 7373 2062 7920 636c 6561 7269 6e67  cess by clearing
+000104f0: 2070 6174 7465 726e 7320 616e 6420 7265   patterns and re
+00010500: 7365 7474 696e 6720 6265 616d 2061 6e64  setting beam and
+00010510: 2069 6d61 6769 6e67 2073 6574 7469 6e67   imaging setting
+00010520: 732e 0a0a 2020 2020 2020 2020 4172 6773  s...        Args
+00010530: 3a0a 2020 2020 2020 2020 2020 2020 6170  :.            ap
+00010540: 706c 6963 6174 696f 6e5f 6669 6c65 2028  plication_file (
+00010550: 7374 7229 3a20 5468 6520 7061 7468 2074  str): The path t
+00010560: 6f20 7468 6520 6465 6661 756c 7420 6170  o the default ap
+00010570: 706c 6963 6174 696f 6e20 6669 6c65 2074  plication file t
+00010580: 6f20 7573 652e 0a0a 2020 2020 2020 2020  o use...        
+00010590: 5265 7475 726e 733a 0a20 2020 2020 2020  Returns:.       
+000105a0: 2020 2020 204e 6f6e 650a 0a20 2020 2020       None..     
+000105b0: 2020 2052 6169 7365 733a 0a20 2020 2020     Raises:.     
+000105c0: 2020 2020 2020 204e 6f6e 650a 0a20 2020         None..   
+000105d0: 2020 2020 204e 6f74 6573 3a0a 2020 2020       Notes:.    
+000105e0: 2020 2020 2020 2020 5468 6973 2066 756e          This fun
+000105f0: 6374 696f 6e20 6669 6e69 7368 6573 2074  ction finishes t
+00010600: 6865 2073 7075 7474 6572 2070 726f 6365  he sputter proce
+00010610: 7373 2062 7920 636c 6561 7269 6e67 2061  ss by clearing a
+00010620: 6e79 2072 656d 6169 6e69 6e67 2070 6174  ny remaining pat
+00010630: 7465 726e 7320 616e 6420 7265 7374 6f72  terns and restor
+00010640: 696e 6720 7468 6520 6265 616d 2061 6e64  ing the beam and
+00010650: 2069 6d61 6769 6e67 2073 6574 7469 6e67   imaging setting
+00010660: 7320 746f 2074 6865 6972 0a20 2020 2020  s to their.     
+00010670: 2020 2020 2020 206f 7269 6769 6e61 6c20         original 
+00010680: 7374 6174 652e 2049 7420 7365 7473 2074  state. It sets t
+00010690: 6865 2062 6561 6d20 6375 7272 656e 7420  he beam current 
+000106a0: 6261 636b 2074 6f20 696d 6167 696e 6720  back to imaging 
+000106b0: 6375 7272 656e 7420 616e 6420 7365 7473  current and sets
+000106c0: 2074 6865 2064 6566 6175 6c74 2062 6561   the default bea
+000106d0: 6d20 7479 7065 2074 6f20 696f 6e20 6265  m type to ion be
+000106e0: 616d 2e0a 2020 2020 2020 2020 2020 2020  am..            
+000106f0: 4974 2061 6c73 6f20 7265 7472 6163 7473  It also retracts
+00010700: 2074 6865 206d 756c 7469 6368 656d 2061   the multichem a
+00010710: 6e64 206c 6f67 7320 7468 6174 2074 6865  nd logs that the
+00010720: 2073 7075 7474 6572 696e 6720 7072 6f63   sputtering proc
+00010730: 6573 7320 6861 7320 6669 6e69 7368 6564  ess has finished
+00010740: 2e0a 2020 2020 2020 2020 2222 220a 2020  ..        """.  
+00010750: 2020 2020 2020 5f63 6865 636b 5f73 7075        _check_spu
+00010760: 7474 6572 2873 656c 662e 6861 7264 7761  tter(self.hardwa
+00010770: 7265 5f73 6574 7469 6e67 7329 0a20 2020  re_settings).   
+00010780: 2020 2020 2023 2043 6c65 6172 2061 6e79       # Clear any
+00010790: 2072 656d 6169 6e69 6e67 2070 6174 7465   remaining patte
+000107a0: 726e 730a 2020 2020 2020 2020 7365 6c66  rns.        self
+000107b0: 2e63 6f6e 6e65 6374 696f 6e2e 7061 7474  .connection.patt
+000107c0: 6572 6e69 6e67 2e63 6c65 6172 5f70 6174  erning.clear_pat
+000107d0: 7465 726e 7328 290a 0a20 2020 2020 2020  terns()..       
+000107e0: 2023 2052 6573 746f 7265 2062 6561 6d20   # Restore beam 
+000107f0: 616e 6420 696d 6167 696e 6720 7365 7474  and imaging sett
+00010800: 696e 6773 2074 6f20 7468 6569 7220 6f72  ings to their or
+00010810: 6967 696e 616c 2073 7461 7465 0a20 2020  iginal state.   
+00010820: 2020 2020 2073 656c 662e 636f 6e6e 6563       self.connec
+00010830: 7469 6f6e 2e62 6561 6d73 2e65 6c65 6374  tion.beams.elect
+00010840: 726f 6e5f 6265 616d 2e75 6e62 6c61 6e6b  ron_beam.unblank
+00010850: 2829 0a20 2020 2020 2020 2073 656c 662e  ().        self.
+00010860: 636f 6e6e 6563 7469 6f6e 2e70 6174 7465  connection.patte
+00010870: 726e 696e 672e 7365 745f 6465 6661 756c  rning.set_defaul
+00010880: 745f 6170 706c 6963 6174 696f 6e5f 6669  t_application_fi
+00010890: 6c65 2861 7070 6c69 6361 7469 6f6e 5f66  le(application_f
+000108a0: 696c 6529 0a20 2020 2020 2020 2073 656c  ile).        sel
+000108b0: 662e 636f 6e6e 6563 7469 6f6e 2e69 6d61  f.connection.ima
+000108c0: 6769 6e67 2e73 6574 5f61 6374 6976 655f  ging.set_active_
+000108d0: 7669 6577 2873 656c 662e 6f72 6967 696e  view(self.origin
+000108e0: 616c 5f61 6374 6976 655f 7669 6577 290a  al_active_view).
+000108f0: 2020 2020 2020 2020 7365 6c66 2e63 6f6e          self.con
+00010900: 6e65 6374 696f 6e2e 7061 7474 6572 6e69  nection.patterni
+00010910: 6e67 2e73 6574 5f64 6566 6175 6c74 5f62  ng.set_default_b
+00010920: 6561 6d5f 7479 7065 2842 6561 6d54 7970  eam_type(BeamTyp
+00010930: 652e 494f 4e2e 7661 6c75 6529 2020 2320  e.ION.value)  # 
+00010940: 7365 7420 696f 6e20 6265 616d 0a20 2020  set ion beam.   
+00010950: 2020 2020 2073 656c 662e 6d75 6c74 6963       self.multic
+00010960: 6865 6d2e 7265 7472 6163 7428 290a 0a20  hem.retract().. 
+00010970: 2020 2020 2020 2023 204c 6f67 2074 6861         # Log tha
+00010980: 7420 7468 6520 7370 7574 7465 7269 6e67  t the sputtering
+00010990: 2070 726f 6365 7373 2068 6173 2066 696e   process has fin
+000109a0: 6973 6865 640a 2020 2020 2020 2020 6c6f  ished.        lo
+000109b0: 6767 696e 672e 696e 666f 2822 506c 6174  gging.info("Plat
+000109c0: 696e 756d 2073 7075 7474 6572 696e 6720  inum sputtering 
+000109d0: 7072 6f63 6573 7320 636f 6d70 6c65 7465  process complete
+000109e0: 642e 2229 0a0a 2020 2020 6465 6620 7365  d.")..    def se
+000109f0: 7475 705f 4749 5328 7365 6c66 2c70 726f  tup_GIS(self,pro
+00010a00: 746f 636f 6c29 3a0a 0a20 2020 2020 2020  tocol):..       
+00010a10: 2062 6561 6d74 7970 655f 7661 6c75 6520   beamtype_value 
+00010a20: 3d20 4265 616d 5479 7065 2e45 4c45 4354  = BeamType.ELECT
+00010a30: 524f 4e2e 7661 6c75 6520 6966 2070 726f  RON.value if pro
+00010a40: 746f 636f 6c5b 2262 6561 6d5f 7479 7065  tocol["beam_type
+00010a50: 225d 203d 3d20 2265 6c65 6374 726f 6e22  "] == "electron"
+00010a60: 2065 6c73 6520 4265 616d 5479 7065 2e49   else BeamType.I
+00010a70: 4f4e 2e76 616c 7565 0a0a 2020 2020 2020  ON.value..      
+00010a80: 2020 5f63 6865 636b 5f73 7075 7474 6572    _check_sputter
+00010a90: 2873 656c 662e 6861 7264 7761 7265 5f73  (self.hardware_s
+00010aa0: 6574 7469 6e67 7329 0a20 2020 2020 2020  ettings).       
+00010ab0: 2073 656c 662e 6f72 6967 696e 616c 5f61   self.original_a
+00010ac0: 6374 6976 655f 7669 6577 203d 2073 656c  ctive_view = sel
+00010ad0: 662e 636f 6e6e 6563 7469 6f6e 2e69 6d61  f.connection.ima
+00010ae0: 6769 6e67 2e67 6574 5f61 6374 6976 655f  ging.get_active_
+00010af0: 7669 6577 2829 0a20 2020 2020 2020 2073  view().        s
+00010b00: 656c 662e 636f 6e6e 6563 7469 6f6e 2e69  elf.connection.i
+00010b10: 6d61 6769 6e67 2e73 6574 5f61 6374 6976  maging.set_activ
+00010b20: 655f 7669 6577 2862 6561 6d74 7970 655f  e_view(beamtype_
+00010b30: 7661 6c75 6529 0a20 2020 2020 2020 2073  value).        s
+00010b40: 656c 662e 636f 6e6e 6563 7469 6f6e 2e70  elf.connection.p
+00010b50: 6174 7465 726e 696e 672e 636c 6561 725f  atterning.clear_
+00010b60: 7061 7474 6572 6e73 2829 0a20 2020 2020  patterns().     
+00010b70: 2020 2073 656c 662e 636f 6e6e 6563 7469     self.connecti
+00010b80: 6f6e 2e70 6174 7465 726e 696e 672e 7365  on.patterning.se
+00010b90: 745f 6465 6661 756c 745f 6170 706c 6963  t_default_applic
+00010ba0: 6174 696f 6e5f 6669 6c65 2870 726f 746f  ation_file(proto
+00010bb0: 636f 6c5b 2261 7070 6c69 6361 7469 6f6e  col["application
+00010bc0: 5f66 696c 6522 5d29 0a20 2020 2020 2020  _file"]).       
+00010bd0: 2073 656c 662e 636f 6e6e 6563 7469 6f6e   self.connection
+00010be0: 2e70 6174 7465 726e 696e 672e 7365 745f  .patterning.set_
+00010bf0: 6465 6661 756c 745f 6265 616d 5f74 7970  default_beam_typ
+00010c00: 6528 6265 616d 7479 7065 5f76 616c 7565  e(beamtype_value
+00010c10: 290a 0a20 2020 2020 2020 2067 6973 5f6c  )..        gis_l
+00010c20: 696e 6520 3d20 7072 6f74 6f63 6f6c 5b22  ine = protocol["
+00010c30: 6761 7322 5d0a 2020 2020 2020 2020 706f  gas"].        po
+00010c40: 7274 203d 2073 656c 662e 6769 735f 6c69  rt = self.gis_li
+00010c50: 6e65 735b 6769 735f 6c69 6e65 5d0a 2020  nes[gis_line].  
+00010c60: 2020 2020 2020 6966 2073 656c 662e 4749        if self.GI
+00010c70: 535f 706f 7369 7469 6f6e 2867 6973 5f6c  S_position(gis_l
+00010c80: 696e 6529 203d 3d20 2252 6574 7261 6374  ine) == "Retract
+00010c90: 6564 223a 0a20 2020 2020 2020 2020 2020  ed":.           
+00010ca0: 2070 6f72 742e 696e 7365 7274 2829 0a0a   port.insert()..
+00010cb0: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+00010cc0: 4749 535f 7465 6d70 5f72 6561 6479 2867  GIS_temp_ready(g
+00010cd0: 6973 5f6c 696e 6529 203d 3d20 4661 6c73  is_line) == Fals
+00010ce0: 653a 0a20 2020 2020 2020 2020 2020 2073  e:.            s
+00010cf0: 656c 662e 4749 535f 6865 6174 5f75 7028  elf.GIS_heat_up(
+00010d00: 6769 735f 6c69 6e65 290a 0a0a 2020 2020  gis_line)...    
+00010d10: 6465 6620 7365 7475 705f 4749 535f 7061  def setup_GIS_pa
+00010d20: 7474 6572 6e28 7365 6c66 2c70 726f 746f  ttern(self,proto
+00010d30: 636f 6c29 3a0a 0a20 2020 2020 2020 2068  col):..        h
+00010d40: 6677 203d 2070 726f 746f 636f 6c5b 2268  fw = protocol["h
+00010d50: 6677 225d 0a20 2020 2020 2020 206c 696e  fw"].        lin
+00010d60: 655f 7061 7474 6572 6e5f 6c65 6e67 7468  e_pattern_length
+00010d70: 203d 2070 726f 746f 636f 6c5b 226c 656e   = protocol["len
+00010d80: 6774 6822 5d0a 2020 2020 2020 2020 7370  gth"].        sp
+00010d90: 7574 7465 725f 7469 6d65 203d 2070 726f  utter_time = pro
+00010da0: 746f 636f 6c5b 2273 7075 7474 6572 5f74  tocol["sputter_t
+00010db0: 696d 6522 5d0a 0a20 2020 2020 2020 2073  ime"]..        s
+00010dc0: 656c 662e 636f 6e6e 6563 7469 6f6e 2e62  elf.connection.b
+00010dd0: 6561 6d73 2e65 6c65 6374 726f 6e5f 6265  eams.electron_be
+00010de0: 616d 2e68 6f72 697a 6f6e 7461 6c5f 6669  am.horizontal_fi
+00010df0: 656c 645f 7769 6474 682e 7661 6c75 6520  eld_width.value 
+00010e00: 3d20 6866 770a 2020 2020 2020 2020 7061  = hfw.        pa
+00010e10: 7474 6572 6e20 3d20 7365 6c66 2e63 6f6e  ttern = self.con
+00010e20: 6e65 6374 696f 6e2e 7061 7474 6572 6e69  nection.patterni
+00010e30: 6e67 2e63 7265 6174 655f 6c69 6e65 280a  ng.create_line(.
+00010e40: 2020 2020 2020 2020 2020 2020 2d6c 696e              -lin
+00010e50: 655f 7061 7474 6572 6e5f 6c65 6e67 7468  e_pattern_length
+00010e60: 202f 2032 2c20 2023 2078 5f73 7461 7274   / 2,  # x_start
+00010e70: 0a20 2020 2020 2020 2020 2020 202b 6c69  .            +li
+00010e80: 6e65 5f70 6174 7465 726e 5f6c 656e 6774  ne_pattern_lengt
+00010e90: 682c 2020 2320 795f 7374 6172 740a 2020  h,  # y_start.  
+00010ea0: 2020 2020 2020 2020 2020 2b6c 696e 655f            +line_
+00010eb0: 7061 7474 6572 6e5f 6c65 6e67 7468 202f  pattern_length /
+00010ec0: 2032 2c20 2023 2078 5f65 6e64 0a20 2020   2,  # x_end.   
+00010ed0: 2020 2020 2020 2020 202b 6c69 6e65 5f70           +line_p
+00010ee0: 6174 7465 726e 5f6c 656e 6774 682c 2020  attern_length,  
+00010ef0: 2320 795f 656e 640a 2020 2020 2020 2020  # y_end.        
+00010f00: 2020 2020 3265 2d36 2c0a 2020 2020 2020      2e-6,.      
+00010f10: 2020 2920 2023 206d 696c 6c69 6e67 2064    )  # milling d
+00010f20: 6570 7468 0a20 2020 2020 2020 2070 6174  epth.        pat
+00010f30: 7465 726e 2e74 696d 6520 3d20 7370 7574  tern.time = sput
+00010f40: 7465 725f 7469 6d65 200a 0a20 2020 2064  ter_time ..    d
+00010f50: 6566 2072 756e 5f47 4953 2873 656c 662c  ef run_GIS(self,
+00010f60: 7072 6f74 6f63 6f6c 293a 0a0a 2020 2020  protocol):..    
+00010f70: 2020 2020 6769 735f 6c69 6e65 203d 2070      gis_line = p
+00010f80: 726f 746f 636f 6c5b 2267 6173 225d 0a20  rotocol["gas"]. 
+00010f90: 2020 2020 2020 2073 7075 7474 6572 5f74         sputter_t
+00010fa0: 696d 6520 3d20 7072 6f74 6f63 6f6c 5b22  ime = protocol["
+00010fb0: 7370 7574 7465 725f 7469 6d65 225d 0a0a  sputter_time"]..
+00010fc0: 0a20 2020 2020 2020 2073 656c 662e 636f  .        self.co
+00010fd0: 6e6e 6563 7469 6f6e 2e62 6561 6d73 2e65  nnection.beams.e
+00010fe0: 6c65 6374 726f 6e5f 6265 616d 2e62 6c61  lectron_beam.bla
+00010ff0: 6e6b 2829 0a20 2020 2020 2020 2069 6620  nk().        if 
+00011000: 7365 6c66 2e63 6f6e 6e65 6374 696f 6e2e  self.connection.
+00011010: 7061 7474 6572 6e69 6e67 2e73 7461 7465  patterning.state
+00011020: 203d 3d20 2249 646c 6522 3a0a 2020 2020   == "Idle":.    
+00011030: 2020 2020 2020 2020 6c6f 6767 696e 672e          logging.
+00011040: 696e 666f 2866 2253 7075 7474 6572 696e  info(f"Sputterin
+00011050: 6720 7769 7468 207b 6769 735f 6c69 6e65  g with {gis_line
+00011060: 7d20 666f 7220 7b73 7075 7474 6572 5f74  } for {sputter_t
+00011070: 696d 657d 2073 6563 6f6e 6473 2e2e 2e22  ime} seconds..."
+00011080: 290a 2020 2020 2020 2020 2020 2020 7365  ).            se
+00011090: 6c66 2e63 6f6e 6e65 6374 696f 6e2e 7061  lf.connection.pa
+000110a0: 7474 6572 6e69 6e67 2e73 7461 7274 2829  tterning.start()
+000110b0: 2020 2320 6173 796e 6368 726f 6e6f 7573    # asynchronous
+000110c0: 2070 6174 7465 726e 696e 670a 2020 2020   patterning.    
+000110d0: 2020 2020 2020 2020 7469 6d65 2e73 6c65          time.sle
+000110e0: 6570 2873 7075 7474 6572 5f74 696d 6520  ep(sputter_time 
+000110f0: 2b20 3529 0a20 2020 2020 2020 2065 6c73  + 5).        els
+00011100: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
+00011110: 6169 7365 2052 756e 7469 6d65 4572 726f  aise RuntimeErro
+00011120: 7228 2243 616e 2774 2073 7075 7474 6572  r("Can't sputter
+00011130: 2c20 7061 7474 6572 6e69 6e67 2073 7461  , patterning sta
+00011140: 7465 2069 7320 6e6f 7420 7265 6164 792e  te is not ready.
+00011150: 2229 0a20 2020 2020 2020 2069 6620 7365  ").        if se
+00011160: 6c66 2e63 6f6e 6e65 6374 696f 6e2e 7061  lf.connection.pa
+00011170: 7474 6572 6e69 6e67 2e73 7461 7465 203d  tterning.state =
+00011180: 3d20 2252 756e 6e69 6e67 223a 0a20 2020  = "Running":.   
+00011190: 2020 2020 2020 2020 2073 656c 662e 636f           self.co
+000111a0: 6e6e 6563 7469 6f6e 2e70 6174 7465 726e  nnection.pattern
+000111b0: 696e 672e 7374 6f70 2829 0a20 2020 2020  ing.stop().     
+000111c0: 2020 2020 2020 206c 6f67 6769 6e67 2e69         logging.i
+000111d0: 6e66 6f28 6622 4669 6e69 7368 6564 2073  nfo(f"Finished s
+000111e0: 7075 7474 6572 696e 6720 7769 7468 207b  puttering with {
+000111f0: 6769 735f 6c69 6e65 7d22 290a 2020 2020  gis_line}").    
+00011200: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00011210: 2020 2020 2020 6c6f 6767 696e 672e 7761        logging.wa
+00011220: 726e 696e 6728 6622 5061 7474 6572 6e69  rning(f"Patterni
+00011230: 6e67 2073 7461 7465 2069 7320 7b73 656c  ng state is {sel
+00011240: 662e 636f 6e6e 6563 7469 6f6e 2e70 6174  f.connection.pat
+00011250: 7465 726e 696e 672e 7374 6174 657d 2229  terning.state}")
+00011260: 0a20 2020 2020 2020 2020 2020 206c 6f67  .            log
+00011270: 6769 6e67 2e77 6172 6e69 6e67 2822 436f  ging.warning("Co
+00011280: 6e73 6964 6572 2061 646a 7573 7469 6e67  nsider adjusting
+00011290: 2074 6865 2070 6174 7465 726e 696e 6720   the patterning 
+000112a0: 6c69 6e65 2064 6570 7468 2e22 290a 0a0a  line depth.")...
+000112b0: 2020 2020 6465 6620 7275 6e5f 4d75 6c74      def run_Mult
+000112c0: 6963 6865 6d28 7365 6c66 2c70 726f 746f  ichem(self,proto
+000112d0: 636f 6c29 3a0a 0a20 2020 2020 2020 205f  col):..        _
+000112e0: 6368 6563 6b5f 7370 7574 7465 7228 7365  check_sputter(se
+000112f0: 6c66 2e68 6172 6477 6172 655f 7365 7474  lf.hardware_sett
+00011300: 696e 6773 290a 2020 2020 2020 2020 7365  ings).        se
+00011310: 6c66 2e6f 7269 6769 6e61 6c5f 6163 7469  lf.original_acti
+00011320: 7665 5f76 6965 7720 3d20 7365 6c66 2e63  ve_view = self.c
+00011330: 6f6e 6e65 6374 696f 6e2e 696d 6167 696e  onnection.imagin
+00011340: 672e 6765 745f 6163 7469 7665 5f76 6965  g.get_active_vie
+00011350: 7728 290a 2020 2020 2020 2020 7365 6c66  w().        self
+00011360: 2e63 6f6e 6e65 6374 696f 6e2e 696d 6167  .connection.imag
+00011370: 696e 672e 7365 745f 6163 7469 7665 5f76  ing.set_active_v
+00011380: 6965 7728 4265 616d 5479 7065 2e45 4c45  iew(BeamType.ELE
+00011390: 4354 524f 4e2e 7661 6c75 6529 0a20 2020  CTRON.value).   
+000113a0: 2020 2020 2073 656c 662e 636f 6e6e 6563       self.connec
+000113b0: 7469 6f6e 2e70 6174 7465 726e 696e 672e  tion.patterning.
+000113c0: 636c 6561 725f 7061 7474 6572 6e73 2829  clear_patterns()
+000113d0: 0a20 2020 2020 2020 2073 656c 662e 636f  .        self.co
+000113e0: 6e6e 6563 7469 6f6e 2e70 6174 7465 726e  nnection.pattern
+000113f0: 696e 672e 7365 745f 6465 6661 756c 745f  ing.set_default_
+00011400: 6170 706c 6963 6174 696f 6e5f 6669 6c65  application_file
+00011410: 2870 726f 746f 636f 6c5b 2261 7070 6c69  (protocol["appli
+00011420: 6361 7469 6f6e 5f66 696c 6522 5d29 0a20  cation_file"]). 
+00011430: 2020 2020 2020 2073 656c 662e 636f 6e6e         self.conn
+00011440: 6563 7469 6f6e 2e70 6174 7465 726e 696e  ection.patternin
+00011450: 672e 7365 745f 6465 6661 756c 745f 6265  g.set_default_be
+00011460: 616d 5f74 7970 6528 4265 616d 5479 7065  am_type(BeamType
+00011470: 2e45 4c45 4354 524f 4e2e 7661 6c75 6529  .ELECTRON.value)
+00011480: 0a0a 2020 2020 2020 2020 6d63 5f6c 696e  ..        mc_lin
+00011490: 6520 3d20 7072 6f74 6f63 6f6c 5b22 6761  e = protocol["ga
+000114a0: 7322 5d0a 2020 2020 2020 2020 706f 7274  s"].        port
+000114b0: 203d 2073 656c 662e 6d75 6c74 6963 6865   = self.multiche
+000114c0: 6d0a 2020 2020 2020 2020 6966 2073 656c  m.        if sel
+000114d0: 662e 6d75 6c74 6963 6865 6d5f 706f 7369  f.multichem_posi
+000114e0: 7469 6f6e 2829 203d 3d20 2252 6574 7261  tion() == "Retra
+000114f0: 6374 6564 223a 0a20 2020 2020 2020 2020  cted":.         
+00011500: 2020 2070 6f72 742e 696e 7365 7274 2829     port.insert()
+00011510: 0a0a 2020 2020 2020 2020 6966 2073 656c  ..        if sel
+00011520: 662e 6d75 6c74 6963 6865 6d5f 7465 6d70  f.multichem_temp
+00011530: 5f72 6561 6479 286d 635f 6c69 6e65 2920  _ready(mc_line) 
+00011540: 3d3d 2046 616c 7365 3a0a 2020 2020 2020  == False:.      
+00011550: 2020 2020 2020 7365 6c66 2e6d 756c 7469        self.multi
+00011560: 6368 656d 5f68 6561 745f 7570 286d 635f  chem_heat_up(mc_
+00011570: 6c69 6e65 290a 0a20 2020 2020 2020 2068  line)..        h
+00011580: 6677 203d 2070 726f 746f 636f 6c5b 2268  fw = protocol["h
+00011590: 6677 225d 0a20 2020 2020 2020 206c 696e  fw"].        lin
+000115a0: 655f 7061 7474 6572 6e5f 6c65 6e67 7468  e_pattern_length
+000115b0: 203d 2070 726f 746f 636f 6c5b 226c 656e   = protocol["len
+000115c0: 6774 6822 5d0a 2020 2020 2020 2020 7370  gth"].        sp
+000115d0: 7574 7465 725f 7469 6d65 203d 2070 726f  utter_time = pro
+000115e0: 746f 636f 6c5b 2273 7075 7474 6572 5f74  tocol["sputter_t
+000115f0: 696d 6522 5d0a 0a20 2020 2020 2020 2073  ime"]..        s
+00011600: 656c 662e 636f 6e6e 6563 7469 6f6e 2e62  elf.connection.b
+00011610: 6561 6d73 2e65 6c65 6374 726f 6e5f 6265  eams.electron_be
+00011620: 616d 2e68 6f72 697a 6f6e 7461 6c5f 6669  am.horizontal_fi
+00011630: 656c 645f 7769 6474 682e 7661 6c75 6520  eld_width.value 
+00011640: 3d20 6866 770a 2020 2020 2020 2020 7061  = hfw.        pa
+00011650: 7474 6572 6e20 3d20 7365 6c66 2e63 6f6e  ttern = self.con
+00011660: 6e65 6374 696f 6e2e 7061 7474 6572 6e69  nection.patterni
+00011670: 6e67 2e63 7265 6174 655f 6c69 6e65 280a  ng.create_line(.
+00011680: 2020 2020 2020 2020 2020 2020 2d6c 696e              -lin
+00011690: 655f 7061 7474 6572 6e5f 6c65 6e67 7468  e_pattern_length
+000116a0: 202f 2032 2c20 2023 2078 5f73 7461 7274   / 2,  # x_start
+000116b0: 0a20 2020 2020 2020 2020 2020 202b 6c69  .            +li
+000116c0: 6e65 5f70 6174 7465 726e 5f6c 656e 6774  ne_pattern_lengt
+000116d0: 682c 2020 2320 795f 7374 6172 740a 2020  h,  # y_start.  
+000116e0: 2020 2020 2020 2020 2020 2b6c 696e 655f            +line_
+000116f0: 7061 7474 6572 6e5f 6c65 6e67 7468 202f  pattern_length /
+00011700: 2032 2c20 2023 2078 5f65 6e64 0a20 2020   2,  # x_end.   
+00011710: 2020 2020 2020 2020 202b 6c69 6e65 5f70           +line_p
+00011720: 6174 7465 726e 5f6c 656e 6774 682c 2020  attern_length,  
+00011730: 2320 795f 656e 640a 2020 2020 2020 2020  # y_end.        
+00011740: 2020 2020 3265 2d36 2c0a 2020 2020 2020      2e-6,.      
+00011750: 2020 2920 2023 206d 696c 6c69 6e67 2064    )  # milling d
+00011760: 6570 7468 0a20 2020 2020 2020 2023 2070  epth.        # p
+00011770: 6174 7465 726e 2e74 696d 6520 3d20 7370  attern.time = sp
+00011780: 7574 7465 725f 7469 6d65 202b 2030 2e31  utter_time + 0.1
+00011790: 0a20 2020 2020 2020 2070 6174 7465 726e  .        pattern
+000117a0: 2e74 696d 6520 3d20 7370 7574 7465 725f  .time = sputter_
+000117b0: 7469 6d65 0a0a 2020 2020 2020 2020 7365  time..        se
+000117c0: 6c66 2e63 6f6e 6e65 6374 696f 6e2e 6265  lf.connection.be
+000117d0: 616d 732e 656c 6563 7472 6f6e 5f62 6561  ams.electron_bea
+000117e0: 6d2e 626c 616e 6b28 290a 2020 2020 2020  m.blank().      
+000117f0: 2020 2320 706f 7274 2e6c 696e 652e 6f70    # port.line.op
+00011800: 656e 2829 0a20 2020 2020 2020 2069 6620  en().        if 
+00011810: 7365 6c66 2e63 6f6e 6e65 6374 696f 6e2e  self.connection.
+00011820: 7061 7474 6572 6e69 6e67 2e73 7461 7465  patterning.state
+00011830: 203d 3d20 2249 646c 6522 3a0a 2020 2020   == "Idle":.    
+00011840: 2020 2020 2020 2020 6c6f 6767 696e 672e          logging.
+00011850: 696e 666f 2866 2253 7075 7474 6572 696e  info(f"Sputterin
+00011860: 6720 7769 7468 207b 6d63 5f6c 696e 657d  g with {mc_line}
+00011870: 2066 6f72 207b 7370 7574 7465 725f 7469   for {sputter_ti
+00011880: 6d65 7d20 7365 636f 6e64 732e 2e2e 2229  me} seconds...")
+00011890: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+000118a0: 662e 636f 6e6e 6563 7469 6f6e 2e70 6174  f.connection.pat
+000118b0: 7465 726e 696e 672e 7374 6172 7428 2920  terning.start() 
+000118c0: 2023 2061 7379 6e63 6872 6f6e 6f75 7320   # asynchronous 
+000118d0: 7061 7474 6572 6e69 6e67 0a20 2020 2020  patterning.     
+000118e0: 2020 2020 2020 2074 696d 652e 736c 6565         time.slee
+000118f0: 7028 7370 7574 7465 725f 7469 6d65 202b  p(sputter_time +
+00011900: 2035 290a 2020 2020 2020 2020 656c 7365   5).        else
+00011910: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
+00011920: 6973 6520 5275 6e74 696d 6545 7272 6f72  ise RuntimeError
+00011930: 2822 4361 6e27 7420 7370 7574 7465 7220  ("Can't sputter 
+00011940: 706c 6174 696e 756d 2c20 7061 7474 6572  platinum, patter
+00011950: 6e69 6e67 2073 7461 7465 2069 7320 6e6f  ning state is no
+00011960: 7420 7265 6164 792e 2229 0a20 2020 2020  t ready.").     
+00011970: 2020 2069 6620 7365 6c66 2e63 6f6e 6e65     if self.conne
+00011980: 6374 696f 6e2e 7061 7474 6572 6e69 6e67  ction.patterning
+00011990: 2e73 7461 7465 203d 3d20 2252 756e 6e69  .state == "Runni
+000119a0: 6e67 223a 0a20 2020 2020 2020 2020 2020  ng":.           
+000119b0: 2073 656c 662e 636f 6e6e 6563 7469 6f6e   self.connection
+000119c0: 2e70 6174 7465 726e 696e 672e 7374 6f70  .patterning.stop
+000119d0: 2829 0a20 2020 2020 2020 2065 6c73 653a  ().        else:
+000119e0: 0a20 2020 2020 2020 2020 2020 206c 6f67  .            log
+000119f0: 6769 6e67 2e77 6172 6e69 6e67 2866 2250  ging.warning(f"P
+00011a00: 6174 7465 726e 696e 6720 7374 6174 6520  atterning state 
+00011a10: 6973 207b 7365 6c66 2e63 6f6e 6e65 6374  is {self.connect
+00011a20: 696f 6e2e 7061 7474 6572 6e69 6e67 2e73  ion.patterning.s
+00011a30: 7461 7465 7d22 290a 2020 2020 2020 2020  tate}").        
+00011a40: 2020 2020 6c6f 6767 696e 672e 7761 726e      logging.warn
+00011a50: 696e 6728 2243 6f6e 7369 6465 7220 6164  ing("Consider ad
+00011a60: 6a75 7374 696e 6720 7468 6520 7061 7474  justing the patt
+00011a70: 6572 6e69 6e67 206c 696e 6520 6465 7074  erning line dept
+00011a80: 682e 2229 0a20 2020 2020 2020 2023 2070  h.").        # p
+00011a90: 6f72 742e 6c69 6e65 2e63 6c6f 7365 2829  ort.line.close()
+00011aa0: 0a0a 2020 2020 2020 2020 7365 6c66 2e6d  ..        self.m
+00011ab0: 756c 7469 6368 656d 2e6c 696e 652e 7475  ultichem.line.tu
+00011ac0: 726e 5f68 6561 7465 725f 6f66 6628 6d63  rn_heater_off(mc
+00011ad0: 5f6c 696e 6529 0a0a 0a0a 0a0a 2020 2020  _line)......    
+00011ae0: 6465 6620 4749 535f 6176 6169 6c61 626c  def GIS_availabl
+00011af0: 655f 6c69 6e65 7328 7365 6c66 2920 2d3e  e_lines(self) ->
+00011b00: 206c 6973 745b 7374 725d 3a0a 2020 2020   list[str]:.    
+00011b10: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+00011b20: 5265 7475 726e 7320 6120 6c69 7374 206f  Returns a list o
+00011b30: 6620 6176 6169 6c61 626c 6520 4749 5320  f available GIS 
+00011b40: 6c69 6e65 732e 0a20 2020 2020 2020 2041  lines..        A
+00011b50: 7267 733a 0a20 2020 2020 2020 2020 2020  rgs:.           
+00011b60: 204e 6f6e 650a 2020 2020 2020 2020 5265   None.        Re
+00011b70: 7475 726e 733a 0a20 2020 2020 2020 2020  turns:.         
+00011b80: 2020 2044 6963 7469 6f6e 6172 7920 6f66     Dictionary of
+00011b90: 2061 7661 696c 6162 6c65 2047 4953 206c   available GIS l
+00011ba0: 696e 6573 2e0a 2020 2020 2020 2020 4e6f  ines..        No
+00011bb0: 7465 733a 0a20 2020 2020 2020 2020 2020  tes:.           
+00011bc0: 204e 6f6e 650a 2020 2020 2020 2020 2222   None.        ""
+00011bd0: 220a 2020 2020 2020 2020 5f63 6865 636b  ".        _check
+00011be0: 5f73 7075 7474 6572 2873 656c 662e 6861  _sputter(self.ha
+00011bf0: 7264 7761 7265 5f73 6574 7469 6e67 7329  rdware_settings)
+00011c00: 0a0a 2020 2020 2020 2020 6769 735f 6c69  ..        gis_li
+00011c10: 7374 203d 2073 656c 662e 636f 6e6e 6563  st = self.connec
+00011c20: 7469 6f6e 2e67 6173 2e6c 6973 745f 616c  tion.gas.list_al
+00011c30: 6c5f 6769 735f 706f 7274 7328 290a 0a20  l_gis_ports().. 
+00011c40: 2020 2020 2020 2073 656c 662e 6769 735f         self.gis_
+00011c50: 6c69 6e65 7320 3d20 7b7d 0a0a 0a20 2020  lines = {}...   
+00011c60: 2020 2020 2066 6f72 206c 696e 6520 696e       for line in
+00011c70: 2067 6973 5f6c 6973 743a 0a0a 2020 2020   gis_list:..    
+00011c80: 2020 2020 2020 2020 6769 735f 706f 7274          gis_port
+00011c90: 203d 2054 6865 726d 6f47 4953 4c69 6e65   = ThermoGISLine
+00011ca0: 2873 656c 662e 636f 6e6e 6563 7469 6f6e  (self.connection
+00011cb0: 2e67 6173 2e67 6574 5f67 6973 5f70 6f72  .gas.get_gis_por
+00011cc0: 7428 6c69 6e65 292c 6e61 6d65 3d6c 696e  t(line),name=lin
+00011cd0: 652c 7374 6174 7573 3d22 5265 7472 6163  e,status="Retrac
+00011ce0: 7465 6422 290a 0a20 2020 2020 2020 2020  ted")..         
+00011cf0: 2020 2073 656c 662e 6769 735f 6c69 6e65     self.gis_line
+00011d00: 735b 6c69 6e65 5d20 3d20 6769 735f 706f  s[line] = gis_po
+00011d10: 7274 0a0a 0a0a 2020 2020 2020 2020 7265  rt....        re
+00011d20: 7475 726e 2067 6973 5f6c 6973 740a 0a20  turn gis_list.. 
+00011d30: 2020 2064 6566 2047 4953 5f61 7661 696c     def GIS_avail
+00011d40: 6162 6c65 5f70 6f73 6974 696f 6e73 2873  able_positions(s
+00011d50: 656c 6629 202d 3e20 6c69 7374 5b73 7472  elf) -> list[str
+00011d60: 5d3a 0a20 2020 2020 2020 2022 2222 5265  ]:.        """Re
+00011d70: 7475 726e 7320 6120 6c69 7374 206f 6620  turns a list of 
+00011d80: 6176 6169 6c61 626c 6520 706f 7369 7469  available positi
+00011d90: 6f6e 7320 7468 6520 4749 5320 6361 6e20  ons the GIS can 
+00011da0: 6d6f 7665 2074 6f2e 0a20 2020 2020 2020  move to..       
+00011db0: 2052 6574 7572 6e73 3a0a 2020 2020 2020   Returns:.      
+00011dc0: 2020 2020 2020 6c69 7374 5b73 7472 5d3a        list[str]:
+00011dd0: 2070 6f73 6974 696f 6e73 0a20 2020 2020   positions.     
+00011de0: 2020 2022 2222 0a0a 2020 2020 2020 2020     """..        
+00011df0: 5f63 6865 636b 5f73 7075 7474 6572 2873  _check_sputter(s
+00011e00: 656c 662e 6861 7264 7761 7265 5f73 6574  elf.hardware_set
+00011e10: 7469 6e67 7329 0a0a 2020 2020 2020 2020  tings)..        
+00011e20: 706f 7369 7469 6f6e 7320 3d20 5b22 496e  positions = ["In
+00011e30: 7365 7274 222c 2022 5265 7472 6163 7422  sert", "Retract"
+00011e40: 5d0a 0a20 2020 2020 2020 2072 6574 7572  ]..        retur
+00011e50: 6e20 706f 7369 7469 6f6e 730a 0a20 2020  n positions..   
+00011e60: 2064 6566 2047 4953 5f6d 6f76 655f 746f   def GIS_move_to
+00011e70: 2873 656c 662c 6c69 6e65 5f6e 616d 653a  (self,line_name:
+00011e80: 7374 722c 706f 7369 7469 6f6e 3a73 7472  str,position:str
+00011e90: 2920 2d3e 204e 6f6e 653a 0a0a 2020 2020  ) -> None:..    
+00011ea0: 2020 2020 2222 224d 6f76 6573 2074 6865      """Moves the
+00011eb0: 2047 4953 2074 6f20 6120 7370 6563 6966   GIS to a specif
+00011ec0: 6965 6420 706f 7369 7469 6f6e 2e0a 2020  ied position..  
+00011ed0: 2020 2020 2020 4e65 6564 2074 6f20 7370        Need to sp
+00011ee0: 6563 6966 7920 7468 6520 6c69 6e65 206e  ecify the line n
+00011ef0: 616d 6520 616e 6420 706f 7369 7469 6f6e  ame and position
+00011f00: 2074 6f20 6d6f 7665 2074 6f2e 2045 6163   to move to. Eac
+00011f10: 6820 4749 5320 6c69 6e65 2069 7320 6120  h GIS line is a 
+00011f20: 7365 7065 7261 7465 2070 7974 686f 6e20  seperate python 
+00011f30: 6f62 6a65 6374 0a20 2020 2020 2020 2022  object.        "
+00011f40: 2222 0a0a 2020 2020 2020 2020 5f63 6865  ""..        _che
+00011f50: 636b 5f73 7075 7474 6572 2873 656c 662e  ck_sputter(self.
+00011f60: 6861 7264 7761 7265 5f73 6574 7469 6e67  hardware_setting
+00011f70: 7329 0a0a 2020 2020 2020 2020 706f 7274  s)..        port
+00011f80: 203d 2073 656c 662e 6769 735f 6c69 6e65   = self.gis_line
+00011f90: 735b 6c69 6e65 5f6e 616d 655d 0a0a 2020  s[line_name]..  
+00011fa0: 2020 2020 2020 6966 2070 6f73 6974 696f        if positio
+00011fb0: 6e20 3d3d 2022 496e 7365 7274 223a 0a20  n == "Insert":. 
+00011fc0: 2020 2020 2020 2020 2020 2070 6f72 742e             port.
+00011fd0: 696e 7365 7274 2829 0a20 2020 2020 2020  insert().       
+00011fe0: 2065 6c69 6620 706f 7369 7469 6f6e 203d   elif position =
+00011ff0: 3d20 2252 6574 7261 6374 223a 0a20 2020  = "Retract":.   
+00012000: 2020 2020 2020 2020 2070 6f72 742e 7265           port.re
+00012010: 7472 6163 7428 290a 0a20 2020 2064 6566  tract()..    def
+00012020: 2047 4953 5f70 6f73 6974 696f 6e28 7365   GIS_position(se
+00012030: 6c66 2c6c 696e 6529 202d 3e20 7374 723a  lf,line) -> str:
+00012040: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+00012050: 2020 2020 2052 6574 7572 6e73 2074 6865       Returns the
+00012060: 2063 7572 7265 6e74 2070 6f73 6974 696f   current positio
+00012070: 6e20 6f66 2074 6865 2047 4953 206c 696e  n of the GIS lin
+00012080: 652e 0a20 2020 2020 2020 2022 2222 0a0a  e..        """..
+00012090: 2020 2020 2020 2020 5f63 6865 636b 5f73          _check_s
+000120a0: 7075 7474 6572 2873 656c 662e 6861 7264  putter(self.hard
+000120b0: 7761 7265 5f73 6574 7469 6e67 7329 0a0a  ware_settings)..
+000120c0: 2020 2020 2020 2020 706f 7274 203d 2073          port = s
+000120d0: 656c 662e 6769 735f 6c69 6e65 735b 6c69  elf.gis_lines[li
+000120e0: 6e65 5d0a 0a20 2020 2020 2020 2072 6574  ne]..        ret
+000120f0: 7572 6e20 706f 7274 2e73 7461 7475 730a  urn port.status.
+00012100: 0a20 2020 2064 6566 2047 4953 5f68 6561  .    def GIS_hea
+00012110: 745f 7570 2873 656c 662c 6c69 6e65 293a  t_up(self,line):
+00012120: 0a0a 2020 2020 2020 2020 2222 2248 6561  ..        """Hea
+00012130: 7473 2075 7020 7468 6520 7370 6563 6966  ts up the specif
+00012140: 6965 6420 4749 5320 6c69 6e65 0a20 2020  ied GIS line.   
+00012150: 2020 2020 2044 6f65 7320 7468 6973 2062       Does this b
+00012160: 7920 7475 726e 696e 6720 7468 6520 6865  y turning the he
+00012170: 6174 6572 206f 6e20 666f 7220 3320 7365  ater on for 3 se
+00012180: 636f 6e64 7320 616e 6420 7468 656e 206f  conds and then o
+00012190: 6666 2e0a 2020 2020 2020 2020 4966 2074  ff..        If t
+000121a0: 6869 7320 7072 6f63 6564 7572 6520 6861  his procedure ha
+000121b0: 7320 6265 656e 2064 6f6e 6520 6f6e 6365  s been done once
+000121c0: 2c20 6974 2069 7320 636f 6e73 6964 6572  , it is consider
+000121d0: 6564 2074 656d 705f 7265 6164 790a 2020  ed temp_ready.  
+000121e0: 2020 2020 2020 2222 220a 0a20 2020 2020        """..     
+000121f0: 2020 205f 6368 6563 6b5f 7370 7574 7465     _check_sputte
+00012200: 7228 7365 6c66 2e68 6172 6477 6172 655f  r(self.hardware_
+00012210: 7365 7474 696e 6773 290a 0a20 2020 2020  settings)..     
+00012220: 2020 2070 6f72 7420 3d20 7365 6c66 2e67     port = self.g
+00012230: 6973 5f6c 696e 6573 5b6c 696e 655d 0a0a  is_lines[line]..
+00012240: 2020 2020 2020 2020 706f 7274 2e6c 696e          port.lin
+00012250: 652e 7475 726e 5f68 6561 7465 725f 6f6e  e.turn_heater_on
+00012260: 2829 0a0a 2020 2020 2020 2020 7469 6d65  ()..        time
+00012270: 2e73 6c65 6570 2833 290a 0a20 2020 2020  .sleep(3)..     
+00012280: 2020 2070 6f72 742e 6c69 6e65 2e74 7572     port.line.tur
+00012290: 6e5f 6865 6174 6572 5f6f 6666 2829 0a0a  n_heater_off()..
+000122a0: 2020 2020 2020 2020 706f 7274 2e74 656d          port.tem
+000122b0: 705f 7265 6164 7920 3d20 5472 7565 0a0a  p_ready = True..
+000122c0: 2020 2020 6465 6620 4749 535f 7465 6d70      def GIS_temp
+000122d0: 5f72 6561 6479 2873 656c 662c 6c69 6e65  _ready(self,line
+000122e0: 2920 2d3e 2062 6f6f 6c3a 0a0a 2020 2020  ) -> bool:..    
+000122f0: 2020 2020 2222 2252 6574 7572 6e73 2069      """Returns i
+00012300: 6620 7468 6520 6865 6174 2075 7020 7072  f the heat up pr
+00012310: 6f63 6564 7572 6520 6861 7320 6265 656e  ocedure has been
+00012320: 2064 6f6e 652e 2049 6e74 6572 6e61 6c20   done. Internal 
+00012330: 6675 6e63 7469 6f6e 2c20 6e6f 7420 706f  function, not po
+00012340: 6c6c 6564 2069 6e66 6f72 6d61 7469 6f6e  lled information
+00012350: 0a20 2020 2020 2020 2020 2020 2066 726f  .            fro
+00012360: 6d20 7468 6520 6861 7264 7761 7265 0a20  m the hardware. 
+00012370: 2020 2020 2020 2052 6574 7572 6e73 3a0a         Returns:.
+00012380: 2020 2020 2020 2020 2020 2020 5472 7565              True
+00012390: 2069 6620 7468 6520 6865 6174 2075 7020   if the heat up 
+000123a0: 7072 6f63 6564 7572 6520 6861 7320 6265  procedure has be
+000123b0: 656e 2064 6f6e 652c 2046 616c 7365 2069  en done, False i
+000123c0: 6620 6e6f 740a 2020 2020 2020 2020 2222  f not.        ""
+000123d0: 220a 0a20 2020 2020 2020 205f 6368 6563  "..        _chec
+000123e0: 6b5f 7370 7574 7465 7228 7365 6c66 2e68  k_sputter(self.h
+000123f0: 6172 6477 6172 655f 7365 7474 696e 6773  ardware_settings
+00012400: 290a 0a20 2020 2020 2020 2070 6f72 7420  )..        port 
+00012410: 3d20 7365 6c66 2e67 6973 5f6c 696e 6573  = self.gis_lines
+00012420: 5b6c 696e 655d 0a0a 2020 2020 2020 2020  [line]..        
+00012430: 7265 7475 726e 2070 6f72 742e 7465 6d70  return port.temp
+00012440: 5f72 6561 6479 0a0a 0a20 2020 2064 6566  _ready...    def
+00012450: 206d 756c 7469 6368 656d 5f61 7661 696c   multichem_avail
+00012460: 6162 6c65 5f6c 696e 6573 2873 656c 6629  able_lines(self)
+00012470: 2d3e 206c 6973 745b 7374 725d 3a0a 0a20  -> list[str]:.. 
+00012480: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+00012490: 2020 2052 6574 7572 6e73 2061 206c 6973     Returns a lis
+000124a0: 7420 6f66 2061 7661 696c 6162 6c65 206d  t of available m
+000124b0: 756c 7469 6368 656d 206c 696e 6573 2e0a  ultichem lines..
+000124c0: 2020 2020 2020 2020 4c69 7374 2069 7320          List is 
+000124d0: 6120 7374 7220 6f66 206e 616d 6573 206f  a str of names o
+000124e0: 6620 7468 6520 6c69 6e65 7322 2222 0a0a  f the lines"""..
+000124f0: 2020 2020 2020 2020 5f63 6865 636b 5f73          _check_s
+00012500: 7075 7474 6572 2873 656c 662e 6861 7264  putter(self.hard
+00012510: 7761 7265 5f73 6574 7469 6e67 7329 0a0a  ware_settings)..
+00012520: 2020 2020 2020 2020 7365 6c66 2e6d 756c          self.mul
+00012530: 7469 6368 656d 203d 2054 6865 726d 6f4d  tichem = ThermoM
+00012540: 756c 7469 4368 656d 4c69 6e65 2873 656c  ultiChemLine(sel
+00012550: 662e 636f 6e6e 6563 7469 6f6e 2e67 6173  f.connection.gas
+00012560: 2e67 6574 5f6d 756c 7469 6368 656d 2829  .get_multichem()
+00012570: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
+00012580: 6d63 5f6c 696e 6573 203d 2073 656c 662e  mc_lines = self.
+00012590: 6d75 6c74 6963 6865 6d2e 6c69 6e65 2e6c  multichem.line.l
+000125a0: 6973 745f 616c 6c5f 6761 7365 7328 290a  ist_all_gases().
+000125b0: 0a20 2020 2020 2020 2073 656c 662e 6d63  .        self.mc
+000125c0: 5f6c 696e 6573 5f74 656d 7020 3d7b 7d0a  _lines_temp ={}.
+000125d0: 0a20 2020 2020 2020 2066 6f72 206c 696e  .        for lin
+000125e0: 6520 696e 2073 656c 662e 6d63 5f6c 696e  e in self.mc_lin
+000125f0: 6573 3a0a 0a20 2020 2020 2020 2020 2020  es:..           
+00012600: 2073 656c 662e 6d63 5f6c 696e 6573 5f74   self.mc_lines_t
+00012610: 656d 705b 6c69 6e65 5d20 3d20 4661 6c73  emp[line] = Fals
+00012620: 650a 0a20 2020 2020 2020 2072 6574 7572  e..        retur
+00012630: 6e20 7365 6c66 2e6d 635f 6c69 6e65 730a  n self.mc_lines.
+00012640: 0a20 2020 2064 6566 206d 756c 7469 6368  .    def multich
+00012650: 656d 5f61 7661 696c 6162 6c65 5f70 6f73  em_available_pos
+00012660: 6974 696f 6e73 2873 656c 6629 202d 3e20  itions(self) -> 
+00012670: 6c69 7374 5b73 7472 5d3a 0a0a 2020 2020  list[str]:..    
+00012680: 2020 2020 2222 2241 7661 696c 6162 6c65      """Available
+00012690: 2070 6f73 6974 696f 6e73 2074 6865 206d   positions the m
+000126a0: 756c 7469 6368 656d 206f 626a 6563 7420  ultichem object 
+000126b0: 6361 6e20 6d6f 7665 2074 6f0a 2020 2020  can move to.    
+000126c0: 2020 2020 5265 7475 726e 733a 0a20 2020      Returns:.   
+000126d0: 2020 2020 2020 2020 205f 7479 7065 5f3a           _type_:
+000126e0: 206c 6973 7420 6f66 2073 7472 206f 6620   list of str of 
+000126f0: 706f 7369 7469 6f6e 206e 616d 6573 0a20  position names. 
+00012700: 2020 2020 2020 2022 2222 0a0a 2020 2020         """..    
+00012710: 2020 2020 5f63 6865 636b 5f73 7075 7474      _check_sputt
+00012720: 6572 2873 656c 662e 6861 7264 7761 7265  er(self.hardware
+00012730: 5f73 6574 7469 6e67 7329 0a0a 2020 2020  _settings)..    
+00012740: 2020 2020 706f 7369 7469 6f6e 735f 656e      positions_en
+00012750: 756d 203d 2073 656c 662e 6d75 6c74 6963  um = self.multic
+00012760: 6865 6d2e 706f 7369 7469 6f6e 730a 0a20  hem.positions.. 
+00012770: 2020 2020 2020 2072 6574 7572 6e20 706f         return po
+00012780: 7369 7469 6f6e 735f 656e 756d 0a0a 2020  sitions_enum..  
+00012790: 2020 6465 6620 6d75 6c74 6963 6865 6d5f    def multichem_
+000127a0: 6d6f 7665 5f74 6f28 7365 6c66 2c70 6f73  move_to(self,pos
+000127b0: 6974 696f 6e3a 7374 7229 3a0a 0a20 2020  ition:str):..   
+000127c0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+000127d0: 204d 6f76 6573 2074 6865 206d 756c 7469   Moves the multi
+000127e0: 6368 656d 206f 626a 6563 7420 746f 2061  chem object to a
+000127f0: 2073 7065 6369 6669 6564 2070 6f73 6974   specified posit
+00012800: 696f 6e2e 0a20 2020 2020 2020 2022 2222  ion..        """
+00012810: 0a0a 2020 2020 2020 2020 5f63 6865 636b  ..        _check
+00012820: 5f73 7075 7474 6572 2873 656c 662e 6861  _sputter(self.ha
+00012830: 7264 7761 7265 5f73 6574 7469 6e67 7329  rdware_settings)
+00012840: 0a0a 2020 2020 2020 2020 6966 2070 6f73  ..        if pos
+00012850: 6974 696f 6e20 3d3d 2022 5265 7472 6163  ition == "Retrac
+00012860: 7422 3a0a 2020 2020 2020 2020 2020 2020  t":.            
+00012870: 7365 6c66 2e6d 756c 7469 6368 656d 2e72  self.multichem.r
+00012880: 6574 7261 6374 2829 0a20 2020 2020 2020  etract().       
+00012890: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+000128a0: 2020 2073 656c 662e 6d75 6c74 6963 6865     self.multiche
+000128b0: 6d2e 696e 7365 7274 2870 6f73 6974 696f  m.insert(positio
+000128c0: 6e3d 706f 7369 7469 6f6e 290a 0a0a 2020  n=position)...  
+000128d0: 2020 6465 6620 6d75 6c74 6963 6865 6d5f    def multichem_
+000128e0: 706f 7369 7469 6f6e 2873 656c 6629 202d  position(self) -
+000128f0: 3e20 7374 723a 0a0a 2020 2020 2020 2020  > str:..        
+00012900: 2222 2243 7572 7265 6e74 2070 6f73 6974  """Current posit
+00012910: 696f 6e20 6f66 2074 6865 206d 756c 7469  ion of the multi
+00012920: 6368 656d 206f 626a 6563 740a 2020 2020  chem object.    
+00012930: 2020 2020 5265 7475 726e 733a 0a20 2020      Returns:.   
+00012940: 2020 2020 2020 2020 205f 7479 7065 5f3a           _type_:
+00012950: 2073 7472 206e 616d 6520 6f66 2074 6865   str name of the
+00012960: 2063 7572 7265 6e74 2070 6f73 6974 696f   current positio
+00012970: 6e0a 2020 2020 2020 2020 2222 220a 0a20  n.        """.. 
+00012980: 2020 2020 2020 205f 6368 6563 6b5f 7370         _check_sp
+00012990: 7574 7465 7228 7365 6c66 2e68 6172 6477  utter(self.hardw
+000129a0: 6172 655f 7365 7474 696e 6773 290a 0a20  are_settings).. 
+000129b0: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
+000129c0: 6c66 2e6d 756c 7469 6368 656d 2e63 7572  lf.multichem.cur
+000129d0: 7265 6e74 5f70 6f73 6974 696f 6e0a 0a20  rent_position.. 
+000129e0: 2020 2064 6566 206d 756c 7469 6368 656d     def multichem
+000129f0: 5f68 6561 745f 7570 2873 656c 662c 6c69  _heat_up(self,li
+00012a00: 6e65 3a73 7472 293a 0a0a 2020 2020 2020  ne:str):..      
+00012a10: 2020 2222 2248 6561 7420 7570 2070 726f    """Heat up pro
+00012a20: 6365 6475 7265 206f 6620 7468 6520 6d75  cedure of the mu
+00012a30: 6c74 6963 6865 6d20 6f62 6a65 6374 2c20  ltichem object, 
+00012a40: 6966 2074 6869 7320 7072 6f63 6564 7572  if this procedur
+00012a50: 6520 6861 7320 6265 656e 2064 6f6e 6520  e has been done 
+00012a60: 6f6e 6365 2c0a 2020 2020 2020 2020 6974  once,.        it
+00012a70: 2069 7320 636f 6e73 6964 6572 6564 2074   is considered t
+00012a80: 656d 705f 7265 6164 792e 2050 726f 6365  emp_ready. Proce
+00012a90: 6475 7265 2069 7320 7475 726e 696e 6720  dure is turning 
+00012aa0: 7468 6520 6865 6174 6572 206f 6e20 666f  the heater on fo
+00012ab0: 7220 3320 7365 636f 6e64 7320 616e 6420  r 3 seconds and 
+00012ac0: 7468 656e 206f 6666 0a20 2020 2020 2020  then off.       
+00012ad0: 204d 7573 7420 7370 6563 6966 7920 7468   Must specify th
+00012ae0: 6520 6c69 6e65 2074 6f20 6865 6174 2075  e line to heat u
+00012af0: 700a 2020 2020 2020 2020 2222 220a 0a20  p.        """.. 
+00012b00: 2020 2020 2020 205f 6368 6563 6b5f 7370         _check_sp
+00012b10: 7574 7465 7228 7365 6c66 2e68 6172 6477  utter(self.hardw
+00012b20: 6172 655f 7365 7474 696e 6773 290a 0a20  are_settings).. 
+00012b30: 2020 2020 2020 2061 7373 6572 7420 6c69         assert li
+00012b40: 6e65 2069 6e20 7365 6c66 2e6d 635f 6c69  ne in self.mc_li
+00012b50: 6e65 732c 2022 4c69 6e65 206e 6f74 2061  nes, "Line not a
+00012b60: 7661 696c 6162 6c65 220a 0a20 2020 2020  vailable"..     
+00012b70: 2020 2073 656c 662e 6d75 6c74 6963 6865     self.multiche
+00012b80: 6d2e 6c69 6e65 2e74 7572 6e5f 6865 6174  m.line.turn_heat
+00012b90: 6572 5f6f 6e28 6c69 6e65 290a 0a20 2020  er_on(line)..   
+00012ba0: 2020 2020 2074 696d 652e 736c 6565 7028       time.sleep(
+00012bb0: 3329 0a0a 2020 2020 2020 2020 2320 7365  3)..        # se
+00012bc0: 6c66 2e6d 756c 7469 6368 656d 2e6c 696e  lf.multichem.lin
+00012bd0: 652e 7475 726e 5f68 6561 7465 725f 6f66  e.turn_heater_of
+00012be0: 6628 6c69 6e65 290a 0a20 2020 2020 2020  f(line)..       
+00012bf0: 2073 656c 662e 6d63 5f6c 696e 6573 5f74   self.mc_lines_t
+00012c00: 656d 705b 6c69 6e65 5d20 3d20 5472 7565  emp[line] = True
+00012c10: 0a0a 2020 2020 6465 6620 6d75 6c74 6963  ..    def multic
+00012c20: 6865 6d5f 7465 6d70 5f72 6561 6479 2873  hem_temp_ready(s
+00012c30: 656c 662c 6c69 6e65 3a73 7472 2920 2d3e  elf,line:str) ->
+00012c40: 2062 6f6f 6c3a 0a0a 2020 2020 2020 2020   bool:..        
+00012c50: 2222 2243 6865 636b 7320 6966 2074 6865  """Checks if the
+00012c60: 2068 6561 7420 7570 2070 726f 6365 6475   heat up procedu
+00012c70: 7265 2066 6f72 2061 206c 696e 6520 696e  re for a line in
+00012c80: 2074 6865 206d 756c 7469 6368 656d 206f   the multichem o
+00012c90: 626a 6563 7420 6861 7320 6265 656e 2064  bject has been d
+00012ca0: 6f6e 652c 0a20 2020 2020 2020 200a 2020  one,.        .  
+00012cb0: 2020 2020 2020 5265 7475 726e 733a 0a20        Returns:. 
+00012cc0: 2020 2020 2020 2020 2020 205f 7479 7065             _type
+00012cd0: 5f3a 2052 6574 7572 6e73 2074 7275 6520  _: Returns true 
+00012ce0: 6966 2064 6f6e 652c 2066 616c 7365 2069  if done, false i
+00012cf0: 6620 6e6f 740a 2020 2020 2020 2020 2222  f not.        ""
+00012d00: 220a 0a20 2020 2020 2020 205f 6368 6563  "..        _chec
+00012d10: 6b5f 7370 7574 7465 7228 7365 6c66 2e68  k_sputter(self.h
+00012d20: 6172 6477 6172 655f 7365 7474 696e 6773  ardware_settings
+00012d30: 290a 0a20 2020 2020 2020 2061 7373 6572  )..        asser
+00012d40: 7420 6c69 6e65 2069 6e20 7365 6c66 2e6d  t line in self.m
+00012d50: 635f 6c69 6e65 732c 2022 4c69 6e65 206e  c_lines, "Line n
+00012d60: 6f74 2061 7661 696c 6162 6c65 220a 0a20  ot available".. 
+00012d70: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
+00012d80: 6c66 2e6d 635f 6c69 6e65 735f 7465 6d70  lf.mc_lines_temp
+00012d90: 5b6c 696e 655d 0a0a 2020 2020 6465 6620  [line]..    def 
+00012da0: 7365 745f 6d69 6372 6f73 636f 7065 5f73  set_microscope_s
+00012db0: 7461 7465 2873 656c 662c 206d 6963 726f  tate(self, micro
+00012dc0: 7363 6f70 655f 7374 6174 653a 204d 6963  scope_state: Mic
+00012dd0: 726f 7363 6f70 6553 7461 7465 2920 2d3e  roscopeState) ->
+00012de0: 204e 6f6e 653a 0a20 2020 2020 2020 2022   None:.        "
+00012df0: 2222 5265 7365 7420 7468 6520 6d69 6372  ""Reset the micr
+00012e00: 6f73 636f 7065 2073 7461 7465 2074 6f20  oscope state to 
+00012e10: 7468 6520 7072 6f76 6964 6564 2073 7461  the provided sta
+00012e20: 7465 2e0a 0a20 2020 2020 2020 2041 7267  te...        Arg
+00012e30: 733a 0a20 2020 2020 2020 2020 2020 206d  s:.            m
+00012e40: 6963 726f 7363 6f70 655f 7374 6174 6520  icroscope_state 
+00012e50: 284d 6963 726f 7363 6f70 6553 7461 7465  (MicroscopeState
+00012e60: 293a 2041 2060 4d69 6372 6f73 636f 7065  ): A `Microscope
+00012e70: 5374 6174 6560 206f 626a 6563 7420 7468  State` object th
+00012e80: 6174 2063 6f6e 7461 696e 7320 7468 6520  at contains the 
+00012e90: 6465 7369 7265 6420 7374 6174 6520 6f66  desired state of
+00012ea0: 2074 6865 206d 6963 726f 7363 6f70 652e   the microscope.
+00012eb0: 0a0a 2020 2020 2020 2020 5265 7475 726e  ..        Return
+00012ec0: 733a 0a20 2020 2020 2020 2020 2020 204e  s:.            N
+00012ed0: 6f6e 652e 0a0a 2020 2020 2020 2020 5261  one...        Ra
+00012ee0: 6973 6573 3a0a 2020 2020 2020 2020 2020  ises:.          
+00012ef0: 2020 4e6f 6e65 2e0a 0a20 2020 2020 2020    None...       
+00012f00: 204e 6f74 6573 3a0a 2020 2020 2020 2020   Notes:.        
+00012f10: 2020 2020 5468 6973 2066 756e 6374 696f      This functio
+00012f20: 6e20 7265 7374 6f72 6573 2074 6865 206d  n restores the m
+00012f30: 6963 726f 7363 6f70 6520 7374 6174 6520  icroscope state 
+00012f40: 746f 2074 6865 2070 726f 7669 6465 6420  to the provided 
+00012f50: 7374 6174 652e 2049 7420 6d6f 7665 7320  state. It moves 
+00012f60: 7468 6520 7374 6167 6520 746f 2074 6865  the stage to the
+00012f70: 2061 6273 6f6c 7574 6520 706f 7369 7469   absolute positi
+00012f80: 6f6e 2073 7065 6369 6669 6564 0a20 2020  on specified.   
+00012f90: 2020 2020 2020 2020 2069 6e20 7468 6520           in the 
+00012fa0: 604d 6963 726f 7363 6f70 6553 7461 7465  `MicroscopeState
+00012fb0: 6020 6f62 6a65 6374 2c20 616e 6420 7468  ` object, and th
+00012fc0: 656e 2072 6573 746f 7265 7320 7468 6520  en restores the 
+00012fd0: 656c 6563 7472 6f6e 2061 6e64 2069 6f6e  electron and ion
+00012fe0: 2062 6561 6d20 7365 7474 696e 6773 2074   beam settings t
+00012ff0: 6f20 7468 6569 7220 7661 6c75 6573 2069  o their values i
+00013000: 6e20 7468 6520 604d 6963 726f 7363 6f70  n the `Microscop
+00013010: 6553 7461 7465 600a 2020 2020 2020 2020  eState`.        
+00013020: 2020 2020 6f62 6a65 6374 2e20 4974 2061      object. It a
+00013030: 6c73 6f20 6c6f 6773 206d 6573 7361 6765  lso logs message
+00013040: 7320 696e 6469 6361 7469 6e67 2074 6865  s indicating the
+00013050: 2070 726f 6772 6573 7320 6f66 2074 6865   progress of the
+00013060: 206f 7065 7261 7469 6f6e 2e0a 2020 2020   operation..    
+00013070: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+00013080: 6672 6f6d 2061 7574 6f73 6372 6970 745f  from autoscript_
+00013090: 7364 625f 6d69 6372 6f73 636f 7065 5f63  sdb_microscope_c
+000130a0: 6c69 656e 742e 7374 7275 6374 7572 6573  lient.structures
+000130b0: 2069 6d70 6f72 7420 506f 696e 7420 6173   import Point as
+000130c0: 2054 6865 726d 6f50 6f69 6e74 0a0a 2020   ThermoPoint..  
+000130d0: 2020 2020 2020 7265 736f 6c75 7469 6f6e        resolution
+000130e0: 203d 2066 227b 6d69 6372 6f73 636f 7065   = f"{microscope
+000130f0: 5f73 7461 7465 2e65 625f 7365 7474 696e  _state.eb_settin
+00013100: 6773 2e72 6573 6f6c 7574 696f 6e5b 305d  gs.resolution[0]
+00013110: 7d78 7b6d 6963 726f 7363 6f70 655f 7374  }x{microscope_st
+00013120: 6174 652e 6562 5f73 6574 7469 6e67 732e  ate.eb_settings.
+00013130: 7265 736f 6c75 7469 6f6e 5b31 5d7d 220a  resolution[1]}".
+00013140: 2020 2020 2020 2020 2320 5265 7374 6f72          # Restor
+00013150: 6520 656c 6563 7472 6f6e 2062 6561 6d20  e electron beam 
+00013160: 7365 7474 696e 6773 0a20 2020 2020 2020  settings.       
+00013170: 2069 6620 7365 6c66 2e68 6172 6477 6172   if self.hardwar
+00013180: 655f 7365 7474 696e 6773 2e65 6c65 6374  e_settings.elect
+00013190: 726f 6e5f 6265 616d 2069 7320 4661 6c73  ron_beam is Fals
+000131a0: 653a 0a20 2020 2020 2020 2020 2020 206c  e:.            l
+000131b0: 6f67 6769 6e67 2e77 6172 6e69 6e67 2822  ogging.warning("
+000131c0: 456c 6563 7472 6f6e 2062 6561 6d20 6973  Electron beam is
+000131d0: 206e 6f74 2061 7661 696c 6162 6c65 2e22   not available."
+000131e0: 290a 2020 2020 2020 2020 656c 7365 3a0a  ).        else:.
+000131f0: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
+00013200: 696e 672e 696e 666f 2866 2252 6573 746f  ing.info(f"Resto
+00013210: 7269 6e67 2065 6c65 6374 726f 6e20 6265  ring electron be
+00013220: 616d 2073 6574 7469 6e67 732e 2e2e 2229  am settings...")
+00013230: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00013240: 662e 636f 6e6e 6563 7469 6f6e 2e62 6561  f.connection.bea
+00013250: 6d73 2e65 6c65 6374 726f 6e5f 6265 616d  ms.electron_beam
+00013260: 2e77 6f72 6b69 6e67 5f64 6973 7461 6e63  .working_distanc
+00013270: 652e 7661 6c75 6520 3d20 280a 2020 2020  e.value = (.    
+00013280: 2020 2020 2020 2020 2020 2020 6d69 6372              micr
+00013290: 6f73 636f 7065 5f73 7461 7465 2e65 625f  oscope_state.eb_
+000132a0: 7365 7474 696e 6773 2e77 6f72 6b69 6e67  settings.working
+000132b0: 5f64 6973 7461 6e63 650a 2020 2020 2020  _distance.      
+000132c0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+000132d0: 2020 2020 7365 6c66 2e63 6f6e 6e65 6374      self.connect
+000132e0: 696f 6e2e 6265 616d 732e 656c 6563 7472  ion.beams.electr
+000132f0: 6f6e 5f62 6561 6d2e 6265 616d 5f63 7572  on_beam.beam_cur
+00013300: 7265 6e74 2e76 616c 7565 203d 2028 0a20  rent.value = (. 
+00013310: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+00013320: 6963 726f 7363 6f70 655f 7374 6174 652e  icroscope_state.
+00013330: 6562 5f73 6574 7469 6e67 732e 6265 616d  eb_settings.beam
+00013340: 5f63 7572 7265 6e74 0a20 2020 2020 2020  _current.       
+00013350: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+00013360: 2020 2073 656c 662e 636f 6e6e 6563 7469     self.connecti
+00013370: 6f6e 2e62 6561 6d73 2e65 6c65 6374 726f  on.beams.electro
+00013380: 6e5f 6265 616d 2e68 6f72 697a 6f6e 7461  n_beam.horizonta
+00013390: 6c5f 6669 656c 645f 7769 6474 682e 7661  l_field_width.va
+000133a0: 6c75 6520 3d20 280a 2020 2020 2020 2020  lue = (.        
+000133b0: 2020 2020 2020 2020 6d69 6372 6f73 636f          microsco
+000133c0: 7065 5f73 7461 7465 2e65 625f 7365 7474  pe_state.eb_sett
+000133d0: 696e 6773 2e68 6677 0a20 2020 2020 2020  ings.hfw.       
+000133e0: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+000133f0: 2020 2073 656c 662e 636f 6e6e 6563 7469     self.connecti
+00013400: 6f6e 2e62 6561 6d73 2e65 6c65 6374 726f  on.beams.electro
+00013410: 6e5f 6265 616d 2e73 6361 6e6e 696e 672e  n_beam.scanning.
+00013420: 7265 736f 6c75 7469 6f6e 2e76 616c 7565  resolution.value
+00013430: 203d 2028 0a20 2020 2020 2020 2020 2020   = (.           
+00013440: 2020 2020 2072 6573 6f6c 7574 696f 6e0a       resolution.
+00013450: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+00013460: 2020 2020 2020 2020 2020 7365 6c66 2e63            self.c
+00013470: 6f6e 6e65 6374 696f 6e2e 6265 616d 732e  onnection.beams.
+00013480: 656c 6563 7472 6f6e 5f62 6561 6d2e 7363  electron_beam.sc
+00013490: 616e 6e69 6e67 2e64 7765 6c6c 5f74 696d  anning.dwell_tim
+000134a0: 652e 7661 6c75 6520 3d20 280a 2020 2020  e.value = (.    
+000134b0: 2020 2020 2020 2020 2020 2020 6d69 6372              micr
+000134c0: 6f73 636f 7065 5f73 7461 7465 2e65 625f  oscope_state.eb_
+000134d0: 7365 7474 696e 6773 2e64 7765 6c6c 5f74  settings.dwell_t
+000134e0: 696d 650a 2020 2020 2020 2020 2020 2020  ime.            
+000134f0: 290a 2020 2020 2020 2020 2020 2020 7365  ).            se
+00013500: 6c66 2e63 6f6e 6e65 6374 696f 6e2e 6265  lf.connection.be
+00013510: 616d 732e 656c 6563 7472 6f6e 5f62 6561  ams.electron_bea
+00013520: 6d2e 6869 6768 5f76 6f6c 7461 6765 2e76  m.high_voltage.v
+00013530: 616c 7565 203d 206d 6963 726f 7363 6f70  alue = microscop
+00013540: 655f 7374 6174 652e 6562 5f73 6574 7469  e_state.eb_setti
+00013550: 6e67 732e 766f 6c74 6167 650a 0a20 2020  ngs.voltage..   
+00013560: 2020 2020 2020 2020 2073 656c 662e 636f           self.co
+00013570: 6e6e 6563 7469 6f6e 2e62 6561 6d73 2e65  nnection.beams.e
+00013580: 6c65 6374 726f 6e5f 6265 616d 2e62 6561  lectron_beam.bea
+00013590: 6d5f 7368 6966 742e 7661 6c75 6520 3d20  m_shift.value = 
+000135a0: 5468 6572 6d6f 506f 696e 7428 783d 6d69  ThermoPoint(x=mi
+000135b0: 6372 6f73 636f 7065 5f73 7461 7465 2e65  croscope_state.e
+000135c0: 625f 7365 7474 696e 6773 2e73 6869 6674  b_settings.shift
+000135d0: 2e78 2c20 793d 6d69 6372 6f73 636f 7065  .x, y=microscope
+000135e0: 5f73 7461 7465 2e65 625f 7365 7474 696e  _state.eb_settin
+000135f0: 6773 2e73 6869 6674 2e79 290a 2020 2020  gs.shift.y).    
+00013600: 2020 2020 2020 2020 7365 6c66 2e63 6f6e          self.con
+00013610: 6e65 6374 696f 6e2e 6265 616d 732e 656c  nection.beams.el
+00013620: 6563 7472 6f6e 5f62 6561 6d2e 7374 6967  ectron_beam.stig
+00013630: 6d61 746f 722e 7661 6c75 6520 3d20 5468  mator.value = Th
+00013640: 6572 6d6f 506f 696e 7428 783d 6d69 6372  ermoPoint(x=micr
+00013650: 6f73 636f 7065 5f73 7461 7465 2e65 625f  oscope_state.eb_
+00013660: 7365 7474 696e 6773 2e73 7469 676d 6174  settings.stigmat
+00013670: 696f 6e2e 782c 2079 3d6d 6963 726f 7363  ion.x, y=microsc
+00013680: 6f70 655f 7374 6174 652e 6562 5f73 6574  ope_state.eb_set
+00013690: 7469 6e67 732e 7374 6967 6d61 7469 6f6e  tings.stigmation
+000136a0: 2e79 290a 0a20 2020 2020 2020 2023 2052  .y)..        # R
+000136b0: 6573 746f 7265 2069 6f6e 2062 6561 6d20  estore ion beam 
+000136c0: 7365 7474 696e 6773 0a20 2020 2020 2020  settings.       
+000136d0: 2072 6573 6f6c 7574 696f 6e20 3d20 6622   resolution = f"
+000136e0: 7b6d 6963 726f 7363 6f70 655f 7374 6174  {microscope_stat
+000136f0: 652e 6962 5f73 6574 7469 6e67 732e 7265  e.ib_settings.re
+00013700: 736f 6c75 7469 6f6e 5b30 5d7d 787b 6d69  solution[0]}x{mi
+00013710: 6372 6f73 636f 7065 5f73 7461 7465 2e69  croscope_state.i
+00013720: 625f 7365 7474 696e 6773 2e72 6573 6f6c  b_settings.resol
+00013730: 7574 696f 6e5b 315d 7d22 0a20 2020 2020  ution[1]}".     
+00013740: 2020 2069 6620 7365 6c66 2e68 6172 6477     if self.hardw
+00013750: 6172 655f 7365 7474 696e 6773 2e69 6f6e  are_settings.ion
+00013760: 5f62 6561 6d20 6973 2046 616c 7365 3a0a  _beam is False:.
+00013770: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
+00013780: 696e 672e 7761 726e 696e 6728 2249 6f6e  ing.warning("Ion
+00013790: 2062 6561 6d20 6973 206e 6f74 2061 7661   beam is not ava
+000137a0: 696c 6162 6c65 2e22 290a 2020 2020 2020  ilable.").      
+000137b0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+000137c0: 2020 2020 6c6f 6767 696e 672e 696e 666f      logging.info
+000137d0: 2866 2252 6573 746f 7269 6e67 2069 6f6e  (f"Restoring ion
+000137e0: 2062 6561 6d20 7365 7474 696e 6773 2e2e   beam settings..
+000137f0: 2e22 290a 2020 2020 2020 2020 2020 2020  .").            
+00013800: 7365 6c66 2e63 6f6e 6e65 6374 696f 6e2e  self.connection.
+00013810: 6265 616d 732e 696f 6e5f 6265 616d 2e77  beams.ion_beam.w
+00013820: 6f72 6b69 6e67 5f64 6973 7461 6e63 652e  orking_distance.
+00013830: 7661 6c75 6520 3d20 280a 2020 2020 2020  value = (.      
+00013840: 2020 2020 2020 2020 2020 6d69 6372 6f73            micros
+00013850: 636f 7065 5f73 7461 7465 2e69 625f 7365  cope_state.ib_se
+00013860: 7474 696e 6773 2e77 6f72 6b69 6e67 5f64  ttings.working_d
+00013870: 6973 7461 6e63 650a 2020 2020 2020 2020  istance.        
+00013880: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+00013890: 2020 7365 6c66 2e63 6f6e 6e65 6374 696f    self.connectio
+000138a0: 6e2e 6265 616d 732e 696f 6e5f 6265 616d  n.beams.ion_beam
+000138b0: 2e62 6561 6d5f 6375 7272 656e 742e 7661  .beam_current.va
+000138c0: 6c75 6520 3d20 280a 2020 2020 2020 2020  lue = (.        
+000138d0: 2020 2020 2020 2020 6d69 6372 6f73 636f          microsco
+000138e0: 7065 5f73 7461 7465 2e69 625f 7365 7474  pe_state.ib_sett
+000138f0: 696e 6773 2e62 6561 6d5f 6375 7272 656e  ings.beam_curren
+00013900: 740a 2020 2020 2020 2020 2020 2020 290a  t.            ).
+00013910: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00013920: 2e63 6f6e 6e65 6374 696f 6e2e 6265 616d  .connection.beam
+00013930: 732e 696f 6e5f 6265 616d 2e68 6f72 697a  s.ion_beam.horiz
+00013940: 6f6e 7461 6c5f 6669 656c 645f 7769 6474  ontal_field_widt
+00013950: 682e 7661 6c75 6520 3d20 280a 2020 2020  h.value = (.    
+00013960: 2020 2020 2020 2020 2020 2020 6d69 6372              micr
+00013970: 6f73 636f 7065 5f73 7461 7465 2e69 625f  oscope_state.ib_
+00013980: 7365 7474 696e 6773 2e68 6677 0a20 2020  settings.hfw.   
+00013990: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+000139a0: 2020 2020 2020 2073 656c 662e 636f 6e6e         self.conn
+000139b0: 6563 7469 6f6e 2e62 6561 6d73 2e69 6f6e  ection.beams.ion
+000139c0: 5f62 6561 6d2e 7363 616e 6e69 6e67 2e72  _beam.scanning.r
+000139d0: 6573 6f6c 7574 696f 6e2e 7661 6c75 6520  esolution.value 
+000139e0: 3d20 280a 2020 2020 2020 2020 2020 2020  = (.            
+000139f0: 2020 2020 7265 736f 6c75 7469 6f6e 0a20      resolution. 
+00013a00: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+00013a10: 2020 2020 2020 2020 2073 656c 662e 636f           self.co
+00013a20: 6e6e 6563 7469 6f6e 2e62 6561 6d73 2e69  nnection.beams.i
+00013a30: 6f6e 5f62 6561 6d2e 7363 616e 6e69 6e67  on_beam.scanning
+00013a40: 2e64 7765 6c6c 5f74 696d 652e 7661 6c75  .dwell_time.valu
+00013a50: 6520 3d20 280a 2020 2020 2020 2020 2020  e = (.          
+00013a60: 2020 2020 2020 6d69 6372 6f73 636f 7065        microscope
+00013a70: 5f73 7461 7465 2e69 625f 7365 7474 696e  _state.ib_settin
+00013a80: 6773 2e64 7765 6c6c 5f74 696d 650a 2020  gs.dwell_time.  
+00013a90: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+00013aa0: 2020 2020 2020 2020 7365 6c66 2e63 6f6e          self.con
+00013ab0: 6e65 6374 696f 6e2e 6265 616d 732e 696f  nection.beams.io
+00013ac0: 6e5f 6265 616d 2e68 6967 685f 766f 6c74  n_beam.high_volt
+00013ad0: 6167 652e 7661 6c75 6520 3d20 6d69 6372  age.value = micr
+00013ae0: 6f73 636f 7065 5f73 7461 7465 2e69 625f  oscope_state.ib_
+00013af0: 7365 7474 696e 6773 2e76 6f6c 7461 6765  settings.voltage
+00013b00: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00013b10: 662e 636f 6e6e 6563 7469 6f6e 2e62 6561  f.connection.bea
+00013b20: 6d73 2e69 6f6e 5f62 6561 6d2e 6265 616d  ms.ion_beam.beam
+00013b30: 5f73 6869 6674 2e76 616c 7565 203d 2054  _shift.value = T
+00013b40: 6865 726d 6f50 6f69 6e74 2878 3d6d 6963  hermoPoint(x=mic
+00013b50: 726f 7363 6f70 655f 7374 6174 652e 6962  roscope_state.ib
+00013b60: 5f73 6574 7469 6e67 732e 7368 6966 742e  _settings.shift.
+00013b70: 782c 2079 3d6d 6963 726f 7363 6f70 655f  x, y=microscope_
+00013b80: 7374 6174 652e 6962 5f73 6574 7469 6e67  state.ib_setting
+00013b90: 732e 7368 6966 742e 7929 0a20 2020 2020  s.shift.y).     
+00013ba0: 2020 2020 2020 2073 656c 662e 636f 6e6e         self.conn
+00013bb0: 6563 7469 6f6e 2e62 6561 6d73 2e69 6f6e  ection.beams.ion
+00013bc0: 5f62 6561 6d2e 7374 6967 6d61 746f 722e  _beam.stigmator.
+00013bd0: 7661 6c75 6520 3d20 5468 6572 6d6f 506f  value = ThermoPo
+00013be0: 696e 7428 783d 6d69 6372 6f73 636f 7065  int(x=microscope
+00013bf0: 5f73 7461 7465 2e69 625f 7365 7474 696e  _state.ib_settin
+00013c00: 6773 2e73 7469 676d 6174 696f 6e2e 782c  gs.stigmation.x,
+00013c10: 2079 3d6d 6963 726f 7363 6f70 655f 7374   y=microscope_st
+00013c20: 6174 652e 6962 5f73 6574 7469 6e67 732e  ate.ib_settings.
+00013c30: 7374 6967 6d61 7469 6f6e 2e79 290a 0a0a  stigmation.y)...
+00013c40: 2020 2020 2020 2020 2320 4c69 6e6b 2074          # Link t
+00013c50: 6865 2073 7065 6369 6d65 6e20 7374 6167  he specimen stag
+00013c60: 650a 2020 2020 2020 2020 6966 2073 656c  e.        if sel
+00013c70: 662e 6861 7264 7761 7265 5f73 6574 7469  f.hardware_setti
+00013c80: 6e67 732e 7374 6167 655f 656e 6162 6c65  ngs.stage_enable
+00013c90: 6420 6973 2046 616c 7365 3a0a 2020 2020  d is False:.    
+00013ca0: 2020 2020 2020 2020 6c6f 6767 696e 672e          logging.
+00013cb0: 7761 726e 696e 6728 2253 7065 6369 6d65  warning("Specime
+00013cc0: 6e20 7374 6167 6520 6973 206e 6f74 2061  n stage is not a
+00013cd0: 7661 696c 6162 6c65 2e22 290a 2020 2020  vailable.").    
+00013ce0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00013cf0: 2020 2020 2020 7365 6c66 2e63 6f6e 6e65        self.conne
+00013d00: 6374 696f 6e2e 7370 6563 696d 656e 2e73  ction.specimen.s
+00013d10: 7461 6765 2e6c 696e 6b28 290a 0a20 2020  tage.link()..   
+00013d20: 2020 2020 2073 656c 662e 5f73 6166 655f       self._safe_
+00013d30: 6162 736f 6c75 7465 5f73 7461 6765 5f6d  absolute_stage_m
+00013d40: 6f76 656d 656e 7428 6d69 6372 6f73 636f  ovement(microsco
+00013d50: 7065 5f73 7461 7465 2e61 6273 6f6c 7574  pe_state.absolut
+00013d60: 655f 706f 7369 7469 6f6e 290a 0a20 2020  e_position)..   
+00013d70: 2020 2020 2023 204c 6f67 2074 6865 2063       # Log the c
+00013d80: 6f6d 706c 6574 696f 6e20 6f66 2074 6865  ompletion of the
+00013d90: 206f 7065 7261 7469 6f6e 0a20 2020 2020   operation.     
+00013da0: 2020 206c 6f67 6769 6e67 2e69 6e66 6f28     logging.info(
+00013db0: 6622 4d69 6372 6f73 636f 7065 2073 7461  f"Microscope sta
+00013dc0: 7465 2072 6573 746f 7265 642e 2229 0a20  te restored."). 
+00013dd0: 2020 200a 2020 2020 6465 6620 6765 745f     .    def get_
+00013de0: 6176 6169 6c61 626c 655f 7661 6c75 6573  available_values
+00013df0: 2873 656c 662c 206b 6579 3a20 7374 722c  (self, key: str,
+00013e00: 2062 6561 6d5f 7479 7065 3a20 4265 616d   beam_type: Beam
+00013e10: 5479 7065 203d 204e 6f6e 6529 2d3e 206c  Type = None)-> l
+00013e20: 6973 743a 0a20 2020 2020 2020 2022 2222  ist:.        """
+00013e30: 4765 7420 6120 6c69 7374 206f 6620 6176  Get a list of av
+00013e40: 6169 6c61 626c 6520 7661 6c75 6573 2066  ailable values f
+00013e50: 6f72 2061 2067 6976 656e 206b 6579 2e0a  or a given key..
+00013e60: 2020 2020 2020 2020 4b65 7973 3a20 6170          Keys: ap
+00013e70: 706c 6963 6174 696f 6e5f 6669 6c65 2c20  plication_file, 
+00013e80: 706c 6173 6d61 5f67 6173 2c20 6375 7272  plasma_gas, curr
+00013e90: 656e 742c 2064 6574 6563 746f 725f 7479  ent, detector_ty
+00013ea0: 7065 2c20 6465 7465 6374 6f72 5f6d 6f64  pe, detector_mod
+00013eb0: 650a 2020 2020 2020 2020 2222 220a 0a20  e.        """.. 
+00013ec0: 2020 2020 2020 2076 616c 7565 7320 3d20         values = 
+00013ed0: 5b5d 0a20 2020 2020 2020 2069 6620 6b65  [].        if ke
+00013ee0: 7920 3d3d 2022 6170 706c 6963 6174 696f  y == "applicatio
+00013ef0: 6e5f 6669 6c65 223a 0a20 2020 2020 2020  n_file":.       
+00013f00: 2020 2020 2076 616c 7565 7320 3d20 7365       values = se
+00013f10: 6c66 2e63 6f6e 6e65 6374 696f 6e2e 7061  lf.connection.pa
+00013f20: 7474 6572 6e69 6e67 2e6c 6973 745f 616c  tterning.list_al
+00013f30: 6c5f 6170 706c 6963 6174 696f 6e5f 6669  l_application_fi
+00013f40: 6c65 7328 290a 0a20 2020 2020 2020 2069  les()..        i
+00013f50: 6620 6265 616d 5f74 7970 6520 6973 2042  f beam_type is B
+00013f60: 6561 6d54 7970 652e 494f 4e20 616e 6420  eamType.ION and 
+00013f70: 7365 6c66 2e68 6172 6477 6172 655f 7365  self.hardware_se
+00013f80: 7474 696e 6773 2e69 6f6e 5f62 6561 6d20  ttings.ion_beam 
+00013f90: 6973 2054 7275 653a 0a20 2020 2020 2020  is True:.       
+00013fa0: 2020 2020 2069 6620 6b65 7920 3d3d 2022       if key == "
+00013fb0: 706c 6173 6d61 5f67 6173 223a 0a20 2020  plasma_gas":.   
+00013fc0: 2020 2020 2020 2020 2020 2020 2076 616c               val
+00013fd0: 7565 7320 3d20 7365 6c66 2e63 6f6e 6e65  ues = self.conne
+00013fe0: 6374 696f 6e2e 6265 616d 732e 696f 6e5f  ction.beams.ion_
+00013ff0: 6265 616d 2e73 6f75 7263 652e 706c 6173  beam.source.plas
+00014000: 6d61 5f67 6173 2e61 7661 696c 6162 6c65  ma_gas.available
+00014010: 5f76 616c 7565 730a 0a20 2020 2020 2020  _values..       
+00014020: 2069 6620 6b65 7920 3d3d 2022 6375 7272   if key == "curr
+00014030: 656e 7422 3a0a 2020 2020 2020 2020 2020  ent":.          
+00014040: 2020 6966 2062 6561 6d5f 7479 7065 2069    if beam_type i
+00014050: 7320 4265 616d 5479 7065 2e49 4f4e 2061  s BeamType.ION a
+00014060: 6e64 2073 656c 662e 6861 7264 7761 7265  nd self.hardware
+00014070: 5f73 6574 7469 6e67 732e 696f 6e5f 6265  _settings.ion_be
+00014080: 616d 2069 7320 5472 7565 3a0a 2020 2020  am is True:.    
+00014090: 2020 2020 2020 2020 2020 2020 7661 6c75              valu
+000140a0: 6573 203d 2073 656c 662e 636f 6e6e 6563  es = self.connec
+000140b0: 7469 6f6e 2e62 6561 6d73 2e69 6f6e 5f62  tion.beams.ion_b
+000140c0: 6561 6d2e 6265 616d 5f63 7572 7265 6e74  eam.beam_current
+000140d0: 2e61 7661 696c 6162 6c65 5f76 616c 7565  .available_value
+000140e0: 730a 2020 2020 2020 2020 2020 2020 656c  s.            el
+000140f0: 6966 2062 6561 6d5f 7479 7065 2069 7320  if beam_type is 
+00014100: 4265 616d 5479 7065 2e45 4c45 4354 524f  BeamType.ELECTRO
+00014110: 4e20 616e 6420 7365 6c66 2e68 6172 6477  N and self.hardw
+00014120: 6172 655f 7365 7474 696e 6773 2e65 6c65  are_settings.ele
+00014130: 6374 726f 6e5f 6265 616d 2069 7320 5472  ctron_beam is Tr
+00014140: 7565 3a0a 2020 2020 2020 2020 2020 2020  ue:.            
+00014150: 2020 2020 7661 6c75 6573 203d 2073 656c      values = sel
+00014160: 662e 636f 6e6e 6563 7469 6f6e 2e62 6561  f.connection.bea
+00014170: 6d73 2e65 6c65 6374 726f 6e5f 6265 616d  ms.electron_beam
+00014180: 2e62 6561 6d5f 6375 7272 656e 742e 6c69  .beam_current.li
+00014190: 6d69 7473 0a0a 2020 2020 2020 2020 6966  mits..        if
+000141a0: 206b 6579 203d 3d20 2264 6574 6563 746f   key == "detecto
+000141b0: 725f 7479 7065 223a 0a20 2020 2020 2020  r_type":.       
+000141c0: 2020 2020 2076 616c 7565 7320 3d20 7365       values = se
+000141d0: 6c66 2e63 6f6e 6e65 6374 696f 6e2e 6465  lf.connection.de
+000141e0: 7465 6374 6f72 2e74 7970 652e 6176 6169  tector.type.avai
+000141f0: 6c61 626c 655f 7661 6c75 6573 0a20 2020  lable_values.   
+00014200: 2020 2020 200a 2020 2020 2020 2020 6966       .        if
+00014210: 206b 6579 203d 3d20 2264 6574 6563 746f   key == "detecto
+00014220: 725f 6d6f 6465 223a 0a20 2020 2020 2020  r_mode":.       
+00014230: 2020 2020 2076 616c 7565 7320 3d20 7365       values = se
+00014240: 6c66 2e63 6f6e 6e65 6374 696f 6e2e 6465  lf.connection.de
+00014250: 7465 6374 6f72 2e6d 6f64 652e 6176 6169  tector.mode.avai
+00014260: 6c61 626c 655f 7661 6c75 6573 0a20 2020  lable_values.   
+00014270: 2020 2020 200a 2020 2020 2020 2020 6966       .        if
+00014280: 206b 6579 203d 3d20 2273 6361 6e5f 6469   key == "scan_di
+00014290: 7265 6374 696f 6e22 3a0a 2020 2020 2020  rection":.      
+000142a0: 2020 2020 2020 7661 6c75 6573 203d 205b        values = [
+000142b0: 2242 6f74 746f 6d54 6f54 6f70 222c 200a  "BottomToTop", .
+000142c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000142d0: 2244 796e 616d 6963 416c 6c44 6972 6563  "DynamicAllDirec
+000142e0: 7469 6f6e 7322 2c20 0a20 2020 2020 2020  tions", .       
+000142f0: 2020 2020 2020 2020 2022 4479 6e61 6d69           "Dynami
+00014300: 6349 6e6e 6572 546f 4f75 7465 7222 2c20  cInnerToOuter", 
+00014310: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00014320: 2022 4479 6e61 6d69 634c 6566 7454 6f52   "DynamicLeftToR
+00014330: 6967 6874 222c 200a 2020 2020 2020 2020  ight", .        
+00014340: 2020 2020 2020 2020 2244 796e 616d 6963          "Dynamic
+00014350: 546f 7054 6f42 6f74 746f 6d22 2c20 0a20  TopToBottom", . 
+00014360: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00014370: 496e 6e65 7254 6f4f 7574 6572 222c 2009  InnerToOuter", .
+00014380: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00014390: 2022 4c65 6674 546f 5269 6768 7422 2c20   "LeftToRight", 
+000143a0: 090a 2020 2020 2020 2020 2020 2020 2020  ..              
+000143b0: 2020 224f 7574 6572 546f 496e 6e65 7222    "OuterToInner"
+000143c0: 2c20 0a20 2020 2020 2020 2020 2020 2020  , .             
+000143d0: 2020 2022 5269 6768 7454 6f4c 6566 7422     "RightToLeft"
+000143e0: 2c20 090a 2020 2020 2020 2020 2020 2020  , ..            
+000143f0: 2020 2020 2254 6f70 546f 426f 7474 6f6d      "TopToBottom
+00014400: 225d 0a0a 2020 2020 2020 2020 7265 7475  "]..        retu
+00014410: 726e 2076 616c 7565 730a 0a20 2020 2064  rn values..    d
+00014420: 6566 2067 6574 5f62 6561 6d5f 7365 7474  ef get_beam_sett
+00014430: 696e 6773 2873 656c 662c 2062 6561 6d5f  ings(self, beam_
+00014440: 7479 7065 3a20 4265 616d 5479 7065 203d  type: BeamType =
+00014450: 2042 6561 6d54 7970 652e 454c 4543 5452   BeamType.ELECTR
+00014460: 4f4e 2920 2d3e 2042 6561 6d53 6574 7469  ON) -> BeamSetti
+00014470: 6e67 733a 0a20 2020 2020 2020 2022 2222  ngs:.        """
+00014480: 4765 7420 7468 6520 6375 7272 656e 7420  Get the current 
+00014490: 6265 616d 2073 6574 7469 6e67 7320 666f  beam settings fo
+000144a0: 7220 7468 6520 7370 6563 6966 6965 6420  r the specified 
+000144b0: 6265 616d 2074 7970 652e 0a0a 2020 2020  beam type...    
+000144c0: 2020 2020 4172 6773 3a0a 2020 2020 2020      Args:.      
+000144d0: 2020 2020 2020 6265 616d 5f74 7970 6520        beam_type 
+000144e0: 2842 6561 6d54 7970 652c 206f 7074 696f  (BeamType, optio
+000144f0: 6e61 6c29 3a20 5468 6520 6265 616d 2074  nal): The beam t
+00014500: 7970 6520 746f 2067 6574 2074 6865 2073  ype to get the s
+00014510: 6574 7469 6e67 7320 666f 722e 2044 6566  ettings for. Def
+00014520: 6175 6c74 7320 746f 2042 6561 6d54 7970  aults to BeamTyp
+00014530: 652e 454c 4543 5452 4f4e 2e0a 0a20 2020  e.ELECTRON...   
+00014540: 2020 2020 2052 6574 7572 6e73 3a0a 2020       Returns:.  
+00014550: 2020 2020 2020 2020 2020 4265 616d 5365            BeamSe
+00014560: 7474 696e 6773 3a20 4120 6042 6561 6d53  ttings: A `BeamS
+00014570: 6574 7469 6e67 7360 206f 626a 6563 7420  ettings` object 
+00014580: 636f 6e74 6169 6e69 6e67 2074 6865 2063  containing the c
+00014590: 7572 7265 6e74 2062 6561 6d20 7365 7474  urrent beam sett
+000145a0: 696e 6773 2e0a 0a20 2020 2020 2020 2052  ings...        R
+000145b0: 6169 7365 733a 0a20 2020 2020 2020 2020  aises:.         
+000145c0: 2020 204e 6f6e 652e 0a20 2020 2020 2020     None..       
+000145d0: 2022 2222 0a0a 2020 2020 2020 2020 7265   """..        re
+000145e0: 736f 6c75 7469 6f6e 203d 2073 656c 662e  solution = self.
+000145f0: 636f 6e6e 6563 7469 6f6e 2e62 6561 6d73  connection.beams
+00014600: 2e65 6c65 6374 726f 6e5f 6265 616d 2e73  .electron_beam.s
+00014610: 6361 6e6e 696e 672e 7265 736f 6c75 7469  canning.resoluti
+00014620: 6f6e 2e76 616c 7565 2069 6620 6265 616d  on.value if beam
+00014630: 5f74 7970 6520 3d3d 2042 6561 6d54 7970  _type == BeamTyp
+00014640: 652e 454c 4543 5452 4f4e 2065 6c73 6520  e.ELECTRON else 
+00014650: 7365 6c66 2e63 6f6e 6e65 6374 696f 6e2e  self.connection.
+00014660: 6265 616d 732e 696f 6e5f 6265 616d 2e73  beams.ion_beam.s
+00014670: 6361 6e6e 696e 672e 7265 736f 6c75 7469  canning.resoluti
+00014680: 6f6e 2e76 616c 7565 0a20 2020 2020 2020  on.value.       
+00014690: 2077 6964 7468 2c20 6865 6967 6874 203d   width, height =
+000146a0: 2069 6e74 2872 6573 6f6c 7574 696f 6e2e   int(resolution.
+000146b0: 7370 6c69 7428 2278 2229 5b30 5d29 2c20  split("x")[0]), 
+000146c0: 696e 7428 7265 736f 6c75 7469 6f6e 2e73  int(resolution.s
+000146d0: 706c 6974 2822 7822 295b 2d31 5d29 0a0a  plit("x")[-1])..
+000146e0: 2020 2020 2020 2020 6c6f 6767 696e 672e          logging.
+000146f0: 696e 666f 2866 2247 6574 7469 6e67 207b  info(f"Getting {
+00014700: 6265 616d 5f74 7970 652e 7661 6c75 657d  beam_type.value}
+00014710: 2062 6561 6d20 7365 7474 696e 6773 2e2e   beam settings..
+00014720: 2e22 290a 2020 2020 2020 2020 6265 616d  .").        beam
+00014730: 5f73 6574 7469 6e67 7320 3d20 4265 616d  _settings = Beam
+00014740: 5365 7474 696e 6773 280a 2020 2020 2020  Settings(.      
+00014750: 2020 2020 2020 6265 616d 5f74 7970 653d        beam_type=
+00014760: 6265 616d 5f74 7970 652c 0a20 2020 2020  beam_type,.     
+00014770: 2020 2020 2020 2077 6f72 6b69 6e67 5f64         working_d
+00014780: 6973 7461 6e63 653d 7365 6c66 2e67 6574  istance=self.get
+00014790: 2822 776f 726b 696e 675f 6469 7374 616e  ("working_distan
+000147a0: 6365 222c 2062 6561 6d5f 7479 7065 292c  ce", beam_type),
+000147b0: 0a20 2020 2020 2020 2020 2020 2062 6561  .            bea
+000147c0: 6d5f 6375 7272 656e 743d 7365 6c66 2e67  m_current=self.g
+000147d0: 6574 2822 6375 7272 656e 7422 2c20 6265  et("current", be
+000147e0: 616d 5f74 7970 6529 2c0a 2020 2020 2020  am_type),.      
+000147f0: 2020 2020 2020 766f 6c74 6167 653d 7365        voltage=se
+00014800: 6c66 2e67 6574 2822 766f 6c74 6167 6522  lf.get("voltage"
+00014810: 2c20 6265 616d 5f74 7970 6529 2c0a 2020  , beam_type),.  
+00014820: 2020 2020 2020 2020 2020 6866 773d 7365            hfw=se
+00014830: 6c66 2e67 6574 2822 6866 7722 2c20 6265  lf.get("hfw", be
+00014840: 616d 5f74 7970 6529 2c0a 2020 2020 2020  am_type),.      
+00014850: 2020 2020 2020 7265 736f 6c75 7469 6f6e        resolution
+00014860: 3d5b 7769 6474 682c 2068 6569 6768 745d  =[width, height]
+00014870: 2c0a 2020 2020 2020 2020 2020 2020 6477  ,.            dw
+00014880: 656c 6c5f 7469 6d65 3d73 656c 662e 636f  ell_time=self.co
+00014890: 6e6e 6563 7469 6f6e 2e62 6561 6d73 2e65  nnection.beams.e
+000148a0: 6c65 6374 726f 6e5f 6265 616d 2e73 6361  lectron_beam.sca
+000148b0: 6e6e 696e 672e 6477 656c 6c5f 7469 6d65  nning.dwell_time
+000148c0: 2e76 616c 7565 2069 6620 6265 616d 5f74  .value if beam_t
+000148d0: 7970 6520 3d3d 2042 6561 6d54 7970 652e  ype == BeamType.
+000148e0: 454c 4543 5452 4f4e 2065 6c73 6520 7365  ELECTRON else se
+000148f0: 6c66 2e63 6f6e 6e65 6374 696f 6e2e 6265  lf.connection.be
+00014900: 616d 732e 696f 6e5f 6265 616d 2e73 6361  ams.ion_beam.sca
+00014910: 6e6e 696e 672e 6477 656c 6c5f 7469 6d65  nning.dwell_time
+00014920: 2e76 616c 7565 2c0a 2020 2020 2020 2020  .value,.        
+00014930: 2020 2020 7374 6967 6d61 7469 6f6e 3d73      stigmation=s
+00014940: 656c 662e 6765 7428 2273 7469 676d 6174  elf.get("stigmat
+00014950: 696f 6e22 2c20 6265 616d 5f74 7970 6529  ion", beam_type)
+00014960: 2c0a 2020 2020 2020 2020 2020 2020 6265  ,.            be
+00014970: 616d 5f73 6869 6674 3d73 656c 662e 6765  am_shift=self.ge
+00014980: 7428 2273 6869 6674 222c 2062 6561 6d5f  t("shift", beam_
+00014990: 7479 7065 292c 0a20 2020 2020 2020 2020  type),.         
+000149a0: 2020 2073 6361 6e5f 726f 7461 7469 6f6e     scan_rotation
+000149b0: 3d73 656c 662e 6765 7428 2273 6361 6e5f  =self.get("scan_
+000149c0: 726f 7461 7469 6f6e 222c 2062 6561 6d5f  rotation", beam_
+000149d0: 7479 7065 292c 0a20 2020 2020 2020 2029  type),.        )
+000149e0: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
+000149f0: 2062 6561 6d5f 7365 7474 696e 6773 0a20   beam_settings. 
+00014a00: 2020 200a 2020 2020 6465 6620 7365 745f     .    def set_
+00014a10: 6265 616d 5f73 6574 7469 6e67 7328 7365  beam_settings(se
+00014a20: 6c66 2c20 6265 616d 5f73 6574 7469 6e67  lf, beam_setting
+00014a30: 733a 2042 6561 6d53 7973 7465 6d53 6574  s: BeamSystemSet
+00014a40: 7469 6e67 7329 202d 3e20 4e6f 6e65 3a0a  tings) -> None:.
+00014a50: 2020 2020 2020 2020 2222 2253 6574 2074          """Set t
+00014a60: 6865 2062 6561 6d20 7365 7474 696e 6773  he beam settings
+00014a70: 2066 6f72 2074 6865 2073 7065 6369 6669   for the specifi
+00014a80: 6564 2062 6561 6d20 7479 7065 2e0a 0a20  ed beam type... 
+00014a90: 2020 2020 2020 2041 7267 733a 0a20 2020         Args:.   
+00014aa0: 2020 2020 2020 2020 2062 6561 6d5f 7365           beam_se
+00014ab0: 7474 696e 6773 2028 4265 616d 5365 7474  ttings (BeamSett
+00014ac0: 696e 6773 293a 2041 2060 4265 616d 5365  ings): A `BeamSe
+00014ad0: 7474 696e 6773 6020 6f62 6a65 6374 2063  ttings` object c
+00014ae0: 6f6e 7461 696e 696e 6720 7468 6520 6265  ontaining the be
+00014af0: 616d 2073 6574 7469 6e67 7320 746f 2073  am settings to s
+00014b00: 6574 2e0a 0a20 2020 2020 2020 2052 6574  et...        Ret
+00014b10: 7572 6e73 3a0a 2020 2020 2020 2020 2020  urns:.          
+00014b20: 2020 4e6f 6e65 2e0a 0a20 2020 2020 2020    None...       
+00014b30: 2052 6169 7365 733a 0a20 2020 2020 2020   Raises:.       
+00014b40: 2020 2020 204e 6f6e 652e 0a20 2020 2020       None..     
+00014b50: 2020 2022 2222 0a20 2020 2020 2020 206c     """.        l
+00014b60: 6f67 6769 6e67 2e69 6e66 6f28 6622 5365  ogging.info(f"Se
+00014b70: 7474 696e 6720 7b62 6561 6d5f 7365 7474  tting {beam_sett
+00014b80: 696e 6773 2e62 6561 6d5f 7479 7065 2e6e  ings.beam_type.n
+00014b90: 616d 657d 2062 6561 6d20 7365 7474 696e  ame} beam settin
+00014ba0: 6773 2e2e 2e22 290a 2020 2020 2020 2020  gs...").        
+00014bb0: 7365 6c66 2e73 6574 2822 776f 726b 696e  self.set("workin
+00014bc0: 675f 6469 7374 616e 6365 222c 2062 6561  g_distance", bea
+00014bd0: 6d5f 7365 7474 696e 6773 2e65 7563 656e  m_settings.eucen
+00014be0: 7472 6963 5f68 6569 6768 742c 2062 6561  tric_height, bea
+00014bf0: 6d5f 7365 7474 696e 6773 2e62 6561 6d5f  m_settings.beam_
+00014c00: 7479 7065 290a 2020 2020 2020 2020 7365  type).        se
+00014c10: 6c66 2e73 6574 2822 6375 7272 656e 7422  lf.set("current"
+00014c20: 2c20 6265 616d 5f73 6574 7469 6e67 732e  , beam_settings.
+00014c30: 6375 7272 656e 742c 2062 6561 6d5f 7365  current, beam_se
+00014c40: 7474 696e 6773 2e62 6561 6d5f 7479 7065  ttings.beam_type
+00014c50: 290a 2020 2020 2020 2020 7365 6c66 2e73  ).        self.s
+00014c60: 6574 2822 766f 6c74 6167 6522 2c20 6265  et("voltage", be
+00014c70: 616d 5f73 6574 7469 6e67 732e 766f 6c74  am_settings.volt
+00014c80: 6167 652c 2062 6561 6d5f 7365 7474 696e  age, beam_settin
+00014c90: 6773 2e62 6561 6d5f 7479 7065 290a 2020  gs.beam_type).  
+00014ca0: 2020 2020 2020 7365 6c66 2e73 6574 2822        self.set("
+00014cb0: 6465 7465 6374 6f72 5f74 7970 6522 2c20  detector_type", 
+00014cc0: 6265 616d 5f73 6574 7469 6e67 732e 6465  beam_settings.de
+00014cd0: 7465 6374 6f72 5f74 7970 652c 2062 6561  tector_type, bea
+00014ce0: 6d5f 7365 7474 696e 6773 2e62 6561 6d5f  m_settings.beam_
+00014cf0: 7479 7065 290a 2020 2020 2020 2020 7365  type).        se
+00014d00: 6c66 2e73 6574 2822 6465 7465 6374 6f72  lf.set("detector
+00014d10: 5f6d 6f64 6522 2c20 6265 616d 5f73 6574  _mode", beam_set
+00014d20: 7469 6e67 732e 6465 7465 6374 6f72 5f6d  tings.detector_m
+00014d30: 6f64 652c 2062 6561 6d5f 7365 7474 696e  ode, beam_settin
+00014d40: 6773 2e62 6561 6d5f 7479 7065 290a 2020  gs.beam_type).  
+00014d50: 2020 2020 2020 6966 2062 6561 6d5f 7365        if beam_se
+00014d60: 7474 696e 6773 2e62 6561 6d5f 7479 7065  ttings.beam_type
+00014d70: 203d 3d20 4265 616d 5479 7065 2e49 4f4e   == BeamType.ION
+00014d80: 2061 6e64 2073 656c 662e 6861 7264 7761   and self.hardwa
+00014d90: 7265 5f73 6574 7469 6e67 732e 6361 6e5f  re_settings.can_
+00014da0: 7365 6c65 6374 5f70 6c61 736d 615f 6761  select_plasma_ga
+00014db0: 7320 6973 2054 7275 653a 0a20 2020 2020  s is True:.     
+00014dc0: 2020 2020 2020 2073 656c 662e 7365 7428         self.set(
+00014dd0: 2270 6c61 736d 615f 6761 7322 2c20 6265  "plasma_gas", be
+00014de0: 616d 5f73 6574 7469 6e67 732e 706c 6173  am_settings.plas
+00014df0: 6d61 5f67 6173 2c20 6265 616d 5f73 6574  ma_gas, beam_set
+00014e00: 7469 6e67 732e 6265 616d 5f74 7970 6529  tings.beam_type)
+00014e10: 0a20 2020 200a 2020 2020 6465 6620 6765  .    .    def ge
+00014e20: 745f 6465 7465 6374 6f72 5f73 6574 7469  t_detector_setti
+00014e30: 6e67 7328 7365 6c66 2c20 6265 616d 5f74  ngs(self, beam_t
+00014e40: 7970 653a 2042 6561 6d54 7970 6520 3d20  ype: BeamType = 
+00014e50: 4265 616d 5479 7065 2e45 4c45 4354 524f  BeamType.ELECTRO
+00014e60: 4e29 202d 3e20 4669 6273 656d 4465 7465  N) -> FibsemDete
+00014e70: 6374 6f72 5365 7474 696e 6773 3a0a 2020  ctorSettings:.  
+00014e80: 2020 2020 2020 2222 2247 6574 2074 6865        """Get the
+00014e90: 2063 7572 7265 6e74 2064 6574 6563 746f   current detecto
+00014ea0: 7220 7365 7474 696e 6773 2066 6f72 2074  r settings for t
+00014eb0: 6865 2073 7065 6369 6669 6564 2062 6561  he specified bea
+00014ec0: 6d20 7479 7065 2e0a 0a20 2020 2020 2020  m type...       
+00014ed0: 2041 7267 733a 0a20 2020 2020 2020 2020   Args:.         
+00014ee0: 2020 2062 6561 6d5f 7479 7065 2028 4265     beam_type (Be
+00014ef0: 616d 5479 7065 2c20 6f70 7469 6f6e 616c  amType, optional
+00014f00: 293a 2054 6865 2062 6561 6d20 7479 7065  ): The beam type
+00014f10: 2074 6f20 6765 7420 7468 6520 7365 7474   to get the sett
+00014f20: 696e 6773 2066 6f72 2e20 4465 6661 756c  ings for. Defaul
+00014f30: 7473 2074 6f20 4265 616d 5479 7065 2e45  ts to BeamType.E
+00014f40: 4c45 4354 524f 4e2e 0a0a 2020 2020 2020  LECTRON...      
+00014f50: 2020 5265 7475 726e 733a 0a20 2020 2020    Returns:.     
+00014f60: 2020 2020 2020 2046 6962 7365 6d44 6574         FibsemDet
+00014f70: 6563 746f 7253 6574 7469 6e67 733a 2041  ectorSettings: A
+00014f80: 2060 4669 6273 656d 4465 7465 6374 6f72   `FibsemDetector
+00014f90: 5365 7474 696e 6773 6020 6f62 6a65 6374  Settings` object
+00014fa0: 2063 6f6e 7461 696e 696e 6720 7468 6520   containing the 
+00014fb0: 6375 7272 656e 7420 6465 7465 6374 6f72  current detector
+00014fc0: 2073 6574 7469 6e67 732e 0a0a 2020 2020   settings...    
+00014fd0: 2020 2020 5261 6973 6573 3a0a 2020 2020      Raises:.    
+00014fe0: 2020 2020 2020 2020 4e6f 6e65 2e0a 2020          None..  
+00014ff0: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+00015000: 2020 6c6f 6767 696e 672e 696e 666f 2866    logging.info(f
+00015010: 2247 6574 7469 6e67 207b 6265 616d 5f74  "Getting {beam_t
+00015020: 7970 652e 7661 6c75 657d 2064 6574 6563  ype.value} detec
+00015030: 746f 7220 7365 7474 696e 6773 2e2e 2e22  tor settings..."
+00015040: 290a 2020 2020 2020 2020 6465 7465 6374  ).        detect
+00015050: 6f72 5f73 6574 7469 6e67 7320 3d20 4669  or_settings = Fi
+00015060: 6273 656d 4465 7465 6374 6f72 5365 7474  bsemDetectorSett
+00015070: 696e 6773 280a 2020 2020 2020 2020 2020  ings(.          
+00015080: 2020 7479 7065 3d73 656c 662e 6765 7428    type=self.get(
+00015090: 2264 6574 6563 746f 725f 7479 7065 222c  "detector_type",
+000150a0: 2062 6561 6d5f 7479 7065 292c 0a20 2020   beam_type),.   
+000150b0: 2020 2020 2020 2020 206d 6f64 653d 7365           mode=se
+000150c0: 6c66 2e67 6574 2822 6465 7465 6374 6f72  lf.get("detector
+000150d0: 5f6d 6f64 6522 2c20 6265 616d 5f74 7970  _mode", beam_typ
+000150e0: 6529 2c0a 2020 2020 2020 2020 2020 2020  e),.            
+000150f0: 6272 6967 6874 6e65 7373 3d73 656c 662e  brightness=self.
+00015100: 6765 7428 2264 6574 6563 746f 725f 6272  get("detector_br
+00015110: 6967 6874 6e65 7373 222c 2062 6561 6d5f  ightness", beam_
+00015120: 7479 7065 292c 0a20 2020 2020 2020 2020  type),.         
+00015130: 2020 2063 6f6e 7472 6173 743d 7365 6c66     contrast=self
+00015140: 2e67 6574 2822 6465 7465 6374 6f72 5f63  .get("detector_c
+00015150: 6f6e 7472 6173 7422 2c20 6265 616d 5f74  ontrast", beam_t
+00015160: 7970 6529 2c0a 2020 2020 2020 2020 290a  ype),.        ).
+00015170: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00015180: 6465 7465 6374 6f72 5f73 6574 7469 6e67  detector_setting
+00015190: 730a 0a20 2020 2064 6566 2067 6574 2873  s..    def get(s
+000151a0: 656c 662c 206b 6579 3a20 7374 722c 2062  elf, key: str, b
+000151b0: 6561 6d5f 7479 7065 3a20 4265 616d 5479  eam_type: BeamTy
+000151c0: 7065 203d 2042 6561 6d54 7970 652e 454c  pe = BeamType.EL
+000151d0: 4543 5452 4f4e 2920 2d3e 2055 6e69 6f6e  ECTRON) -> Union
+000151e0: 5b66 6c6f 6174 2c20 7374 722c 204e 6f6e  [float, str, Non
+000151f0: 655d 3a0a 2020 2020 2020 2020 0a20 2020  e]:.        .   
+00015200: 2020 2020 2023 2054 4f44 4f3a 206d 616b       # TODO: mak
+00015210: 6520 7468 6520 6c69 7374 206f 6620 6765  e the list of ge
+00015220: 7420 616e 6420 7365 7420 6b65 7973 2061  t and set keys a
+00015230: 7661 696c 6162 6c65 2074 6f20 7468 6520  vailable to the 
+00015240: 7573 6572 0a0a 2020 2020 2020 2020 6265  user..        be
+00015250: 616d 203d 2073 656c 662e 636f 6e6e 6563  am = self.connec
+00015260: 7469 6f6e 2e62 6561 6d73 2e65 6c65 6374  tion.beams.elect
+00015270: 726f 6e5f 6265 616d 2069 6620 6265 616d  ron_beam if beam
+00015280: 5f74 7970 6520 3d3d 2042 6561 6d54 7970  _type == BeamTyp
+00015290: 652e 454c 4543 5452 4f4e 2065 6c73 6520  e.ELECTRON else 
+000152a0: 7365 6c66 2e63 6f6e 6e65 6374 696f 6e2e  self.connection.
+000152b0: 6265 616d 732e 696f 6e5f 6265 616d 0a20  beams.ion_beam. 
+000152c0: 2020 2020 2020 0a20 2020 2020 2020 2023        .        #
+000152d0: 2062 6561 6d20 7072 6f70 6572 7469 6573   beam properties
+000152e0: 0a20 2020 2020 2020 2069 6620 6b65 7920  .        if key 
+000152f0: 3d3d 2022 6f6e 223a 200a 2020 2020 2020  == "on": .      
+00015300: 2020 2020 2020 5f63 6865 636b 5f62 6561        _check_bea
+00015310: 6d28 6265 616d 5f74 7970 652c 2073 656c  m(beam_type, sel
+00015320: 662e 6861 7264 7761 7265 5f73 6574 7469  f.hardware_setti
+00015330: 6e67 7329 0a20 2020 2020 2020 2020 2020  ngs).           
+00015340: 2072 6574 7572 6e20 6265 616d 2e69 735f   return beam.is_
+00015350: 6f6e 0a20 2020 2020 2020 2069 6620 6b65  on.        if ke
+00015360: 7920 3d3d 2022 626c 616e 6b65 6422 3a0a  y == "blanked":.
+00015370: 2020 2020 2020 2020 2020 2020 5f63 6865              _che
+00015380: 636b 5f62 6561 6d28 6265 616d 5f74 7970  ck_beam(beam_typ
+00015390: 652c 2073 656c 662e 6861 7264 7761 7265  e, self.hardware
+000153a0: 5f73 6574 7469 6e67 7329 0a20 2020 2020  _settings).     
+000153b0: 2020 2020 2020 2072 6574 7572 6e20 6265         return be
+000153c0: 616d 2e69 735f 626c 616e 6b65 640a 2020  am.is_blanked.  
+000153d0: 2020 2020 2020 6966 206b 6579 203d 3d20        if key == 
+000153e0: 2277 6f72 6b69 6e67 5f64 6973 7461 6e63  "working_distanc
+000153f0: 6522 3a0a 2020 2020 2020 2020 2020 2020  e":.            
+00015400: 5f63 6865 636b 5f62 6561 6d28 6265 616d  _check_beam(beam
+00015410: 5f74 7970 652c 2073 656c 662e 6861 7264  _type, self.hard
+00015420: 7761 7265 5f73 6574 7469 6e67 7329 0a20  ware_settings). 
+00015430: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00015440: 6e20 6265 616d 2e77 6f72 6b69 6e67 5f64  n beam.working_d
+00015450: 6973 7461 6e63 652e 7661 6c75 650a 2020  istance.value.  
+00015460: 2020 2020 2020 6966 206b 6579 203d 3d20        if key == 
+00015470: 2263 7572 7265 6e74 223a 0a20 2020 2020  "current":.     
+00015480: 2020 2020 2020 205f 6368 6563 6b5f 6265         _check_be
+00015490: 616d 2862 6561 6d5f 7479 7065 2c20 7365  am(beam_type, se
+000154a0: 6c66 2e68 6172 6477 6172 655f 7365 7474  lf.hardware_sett
+000154b0: 696e 6773 290a 2020 2020 2020 2020 2020  ings).          
+000154c0: 2020 7265 7475 726e 2062 6561 6d2e 6265    return beam.be
+000154d0: 616d 5f63 7572 7265 6e74 2e76 616c 7565  am_current.value
+000154e0: 0a20 2020 2020 2020 2069 6620 6b65 7920  .        if key 
+000154f0: 3d3d 2022 766f 6c74 6167 6522 3a0a 2020  == "voltage":.  
+00015500: 2020 2020 2020 2020 2020 5f63 6865 636b            _check
+00015510: 5f62 6561 6d28 6265 616d 5f74 7970 652c  _beam(beam_type,
+00015520: 2073 656c 662e 6861 7264 7761 7265 5f73   self.hardware_s
+00015530: 6574 7469 6e67 7329 0a20 2020 2020 2020  ettings).       
+00015540: 2020 2020 2072 6574 7572 6e20 6265 616d       return beam
+00015550: 2e68 6967 685f 766f 6c74 6167 652e 7661  .high_voltage.va
+00015560: 6c75 650a 2020 2020 2020 2020 6966 206b  lue.        if k
+00015570: 6579 203d 3d20 2268 6677 223a 0a20 2020  ey == "hfw":.   
+00015580: 2020 2020 2020 2020 205f 6368 6563 6b5f           _check_
+00015590: 6265 616d 2862 6561 6d5f 7479 7065 2c20  beam(beam_type, 
+000155a0: 7365 6c66 2e68 6172 6477 6172 655f 7365  self.hardware_se
+000155b0: 7474 696e 6773 290a 2020 2020 2020 2020  ttings).        
+000155c0: 2020 2020 7265 7475 726e 2062 6561 6d2e      return beam.
+000155d0: 686f 7269 7a6f 6e74 616c 5f66 6965 6c64  horizontal_field
+000155e0: 5f77 6964 7468 2e76 616c 7565 0a20 2020  _width.value.   
+000155f0: 2020 2020 2069 6620 6b65 7920 3d3d 2022       if key == "
+00015600: 7265 736f 6c75 7469 6f6e 223a 0a20 2020  resolution":.   
+00015610: 2020 2020 2020 2020 205f 6368 6563 6b5f           _check_
+00015620: 6265 616d 2862 6561 6d5f 7479 7065 2c20  beam(beam_type, 
+00015630: 7365 6c66 2e68 6172 6477 6172 655f 7365  self.hardware_se
+00015640: 7474 696e 6773 290a 2020 2020 2020 2020  ttings).        
+00015650: 2020 2020 7265 7475 726e 2062 6561 6d2e      return beam.
+00015660: 7363 616e 6e69 6e67 2e72 6573 6f6c 7574  scanning.resolut
+00015670: 696f 6e2e 7661 6c75 650a 2020 2020 2020  ion.value.      
+00015680: 2020 6966 206b 6579 203d 3d20 2264 7765    if key == "dwe
+00015690: 6c6c 5f74 696d 6522 3a0a 2020 2020 2020  ll_time":.      
+000156a0: 2020 2020 2020 5f63 6865 636b 5f62 6561        _check_bea
+000156b0: 6d28 6265 616d 5f74 7970 652c 2073 656c  m(beam_type, sel
+000156c0: 662e 6861 7264 7761 7265 5f73 6574 7469  f.hardware_setti
+000156d0: 6e67 7329 0a20 2020 2020 2020 2020 2020  ngs).           
+000156e0: 2072 6574 7572 6e20 6265 616d 2e73 6361   return beam.sca
+000156f0: 6e6e 696e 672e 6477 656c 6c5f 7469 6d65  nning.dwell_time
+00015700: 2e76 616c 7565 0a20 2020 2020 2020 2069  .value.        i
+00015710: 6620 6b65 7920 3d3d 2022 7363 616e 5f72  f key == "scan_r
+00015720: 6f74 6174 696f 6e22 3a0a 2020 2020 2020  otation":.      
+00015730: 2020 2020 2020 5f63 6865 636b 5f62 6561        _check_bea
+00015740: 6d28 6265 616d 5f74 7970 652c 2073 656c  m(beam_type, sel
+00015750: 662e 6861 7264 7761 7265 5f73 6574 7469  f.hardware_setti
+00015760: 6e67 7329 0a20 2020 2020 2020 2020 2020  ngs).           
+00015770: 2072 6574 7572 6e20 6265 616d 2e73 6361   return beam.sca
+00015780: 6e6e 696e 672e 726f 7461 7469 6f6e 2e76  nning.rotation.v
+00015790: 616c 7565 0a20 2020 2020 2020 2069 6620  alue.        if 
+000157a0: 6b65 7920 3d3d 2022 766f 6c74 6167 655f  key == "voltage_
+000157b0: 6c69 6d69 7473 223a 0a20 2020 2020 2020  limits":.       
+000157c0: 2020 2020 205f 6368 6563 6b5f 6265 616d       _check_beam
+000157d0: 2862 6561 6d5f 7479 7065 2c20 7365 6c66  (beam_type, self
+000157e0: 2e68 6172 6477 6172 655f 7365 7474 696e  .hardware_settin
+000157f0: 6773 290a 2020 2020 2020 2020 2020 2020  gs).            
+00015800: 7265 7475 726e 2062 6561 6d2e 6869 6768  return beam.high
+00015810: 5f76 6f6c 7461 6765 2e6c 696d 6974 730a  _voltage.limits.
+00015820: 2020 2020 2020 2020 6966 206b 6579 203d          if key =
+00015830: 3d20 2276 6f6c 7461 6765 5f63 6f6e 7472  = "voltage_contr
+00015840: 6f6c 6c61 626c 6522 3a0a 2020 2020 2020  ollable":.      
+00015850: 2020 2020 2020 5f63 6865 636b 5f62 6561        _check_bea
+00015860: 6d28 6265 616d 5f74 7970 652c 2073 656c  m(beam_type, sel
+00015870: 662e 6861 7264 7761 7265 5f73 6574 7469  f.hardware_setti
+00015880: 6e67 7329 0a20 2020 2020 2020 2020 2020  ngs).           
+00015890: 2072 6574 7572 6e20 6265 616d 2e68 6967   return beam.hig
+000158a0: 685f 766f 6c74 6167 652e 6973 5f63 6f6e  h_voltage.is_con
+000158b0: 7472 6f6c 6c61 626c 650a 2020 2020 2020  trollable.      
+000158c0: 2020 6966 206b 6579 203d 3d20 2273 6869    if key == "shi
+000158d0: 6674 223a 0a20 2020 2020 2020 2020 2020  ft":.           
+000158e0: 205f 6368 6563 6b5f 6265 616d 2862 6561   _check_beam(bea
+000158f0: 6d5f 7479 7065 2c20 7365 6c66 2e68 6172  m_type, self.har
+00015900: 6477 6172 655f 7365 7474 696e 6773 290a  dware_settings).
+00015910: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00015920: 726e 2050 6f69 6e74 2862 6561 6d2e 6265  rn Point(beam.be
+00015930: 616d 5f73 6869 6674 2e76 616c 7565 2e78  am_shift.value.x
+00015940: 2c20 6265 616d 2e62 6561 6d5f 7368 6966  , beam.beam_shif
+00015950: 742e 7661 6c75 652e 7929 0a20 2020 2020  t.value.y).     
+00015960: 2020 2069 6620 6b65 7920 3d3d 2022 7374     if key == "st
+00015970: 6967 6d61 7469 6f6e 223a 200a 2020 2020  igmation": .    
+00015980: 2020 2020 2020 2020 5f63 6865 636b 5f62          _check_b
+00015990: 6561 6d28 6265 616d 5f74 7970 652c 2073  eam(beam_type, s
+000159a0: 656c 662e 6861 7264 7761 7265 5f73 6574  elf.hardware_set
+000159b0: 7469 6e67 7329 0a20 2020 2020 2020 2020  tings).         
+000159c0: 2020 2072 6574 7572 6e20 506f 696e 7428     return Point(
+000159d0: 6265 616d 2e73 7469 676d 6174 6f72 2e76  beam.stigmator.v
+000159e0: 616c 7565 2e78 2c20 6265 616d 2e73 7469  alue.x, beam.sti
+000159f0: 676d 6174 6f72 2e76 616c 7565 2e79 290a  gmator.value.y).
+00015a00: 0a0a 2020 2020 2020 2020 2320 696f 6e20  ..        # ion 
+00015a10: 6265 616d 2070 726f 7065 7274 6965 730a  beam properties.
+00015a20: 2020 2020 2020 2020 6966 2062 6561 6d5f          if beam_
+00015a30: 7479 7065 2069 7320 4265 616d 5479 7065  type is BeamType
+00015a40: 2e45 4c45 4354 524f 4e3a 0a20 2020 2020  .ELECTRON:.     
+00015a50: 2020 2020 2020 2069 6620 6b65 7920 3d3d         if key ==
+00015a60: 2022 616e 6775 6c61 725f 636f 7272 6563   "angular_correc
+00015a70: 7469 6f6e 5f61 6e67 6c65 223a 0a20 2020  tion_angle":.   
+00015a80: 2020 2020 2020 2020 2020 2020 205f 6368               _ch
+00015a90: 6563 6b5f 6265 616d 2862 6561 6d5f 7479  eck_beam(beam_ty
+00015aa0: 7065 2c20 7365 6c66 2e68 6172 6477 6172  pe, self.hardwar
+00015ab0: 655f 7365 7474 696e 6773 290a 2020 2020  e_settings).    
+00015ac0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00015ad0: 726e 2062 6561 6d2e 616e 6775 6c61 725f  rn beam.angular_
+00015ae0: 636f 7272 6563 7469 6f6e 2e61 6e67 6c65  correction.angle
+00015af0: 2e76 616c 7565 0a0a 2020 2020 2020 2020  .value..        
+00015b00: 6966 2062 6561 6d5f 7479 7065 2069 7320  if beam_type is 
+00015b10: 4265 616d 5479 7065 2e49 4f4e 3a0a 2020  BeamType.ION:.  
+00015b20: 2020 2020 2020 2020 2020 6966 206b 6579            if key
+00015b30: 203d 3d20 2270 6c61 736d 615f 6761 7322   == "plasma_gas"
+00015b40: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00015b50: 2020 5f63 6865 636b 5f62 6561 6d28 6265    _check_beam(be
+00015b60: 616d 5f74 7970 652c 2073 656c 662e 6861  am_type, self.ha
+00015b70: 7264 7761 7265 5f73 6574 7469 6e67 7329  rdware_settings)
+00015b80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00015b90: 2072 6574 7572 6e20 6265 616d 2e73 6f75   return beam.sou
+00015ba0: 7263 652e 706c 6173 6d61 5f67 6173 2e76  rce.plasma_gas.v
+00015bb0: 616c 7565 2023 206d 6967 6874 206e 6565  alue # might nee
+00015bc0: 6420 746f 2063 6865 636b 2069 6620 7468  d to check if th
+00015bd0: 6973 2069 7320 6176 6169 6c61 626c 653f  is is available?
+00015be0: 0a0a 2020 2020 2020 2020 2320 7374 6167  ..        # stag
+00015bf0: 6520 7072 6f70 6572 7469 6573 0a20 2020  e properties.   
+00015c00: 2020 2020 2069 6620 6b65 7920 3d3d 2022       if key == "
+00015c10: 7374 6167 655f 706f 7369 7469 6f6e 223a  stage_position":
+00015c20: 0a20 2020 2020 2020 2020 2020 205f 6368  .            _ch
+00015c30: 6563 6b5f 7374 6167 6528 7365 6c66 2e68  eck_stage(self.h
+00015c40: 6172 6477 6172 655f 7365 7474 696e 6773  ardware_settings
+00015c50: 290a 2020 2020 2020 2020 2020 2020 7265  ).            re
+00015c60: 7475 726e 2073 656c 662e 636f 6e6e 6563  turn self.connec
+00015c70: 7469 6f6e 2e73 7065 6369 6d65 6e2e 7374  tion.specimen.st
+00015c80: 6167 652e 6375 7272 656e 745f 706f 7369  age.current_posi
+00015c90: 7469 6f6e 0a20 2020 2020 2020 2069 6620  tion.        if 
+00015ca0: 6b65 7920 3d3d 2022 7374 6167 655f 686f  key == "stage_ho
+00015cb0: 6d65 6422 3a0a 2020 2020 2020 2020 2020  med":.          
+00015cc0: 2020 5f63 6865 636b 5f73 7461 6765 2873    _check_stage(s
+00015cd0: 656c 662e 6861 7264 7761 7265 5f73 6574  elf.hardware_set
+00015ce0: 7469 6e67 7329 0a20 2020 2020 2020 2020  tings).         
+00015cf0: 2020 2072 6574 7572 6e20 7365 6c66 2e63     return self.c
+00015d00: 6f6e 6e65 6374 696f 6e2e 7370 6563 696d  onnection.specim
+00015d10: 656e 2e73 7461 6765 2e69 735f 686f 6d65  en.stage.is_home
+00015d20: 640a 2020 2020 2020 2020 6966 206b 6579  d.        if key
+00015d30: 203d 3d20 2273 7461 6765 5f6c 696e 6b65   == "stage_linke
+00015d40: 6422 3a0a 2020 2020 2020 2020 2020 2020  d":.            
+00015d50: 5f63 6865 636b 5f73 7461 6765 2873 656c  _check_stage(sel
+00015d60: 662e 6861 7264 7761 7265 5f73 6574 7469  f.hardware_setti
+00015d70: 6e67 7329 0a20 2020 2020 2020 2020 2020  ngs).           
+00015d80: 2072 6574 7572 6e20 7365 6c66 2e63 6f6e   return self.con
+00015d90: 6e65 6374 696f 6e2e 7370 6563 696d 656e  nection.specimen
+00015da0: 2e73 7461 6765 2e69 735f 6c69 6e6b 6564  .stage.is_linked
+00015db0: 0a0a 2020 2020 2020 2020 2320 6368 616d  ..        # cham
+00015dc0: 6265 7220 7072 6f70 6572 7469 6573 0a20  ber properties. 
+00015dd0: 2020 2020 2020 2069 6620 6b65 7920 3d3d         if key ==
+00015de0: 2022 6368 616d 6265 725f 7374 6174 6522   "chamber_state"
+00015df0: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+00015e00: 7475 726e 2073 656c 662e 636f 6e6e 6563  turn self.connec
+00015e10: 7469 6f6e 2e76 6163 7575 6d2e 6368 616d  tion.vacuum.cham
+00015e20: 6265 725f 7374 6174 650a 2020 2020 2020  ber_state.      
+00015e30: 2020 0a20 2020 2020 2020 2069 6620 6b65    .        if ke
+00015e40: 7920 3d3d 2022 6368 616d 6265 725f 7072  y == "chamber_pr
+00015e50: 6573 7375 7265 223a 0a20 2020 2020 2020  essure":.       
+00015e60: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
+00015e70: 2e63 6f6e 6e65 6374 696f 6e2e 7661 6375  .connection.vacu
+00015e80: 756d 2e63 6861 6d62 6572 5f70 7265 7373  um.chamber_press
+00015e90: 7572 652e 7661 6c75 650a 0a20 2020 2020  ure.value..     
+00015ea0: 2020 2023 2064 6574 6563 746f 7220 6d6f     # detector mo
+00015eb0: 6465 2061 6e64 2074 7970 650a 2020 2020  de and type.    
+00015ec0: 2020 2020 6966 206b 6579 2069 6e20 5b22      if key in ["
+00015ed0: 6465 7465 6374 6f72 5f6d 6f64 6522 2c20  detector_mode", 
+00015ee0: 2264 6574 6563 746f 725f 7479 7065 222c  "detector_type",
+00015ef0: 2022 6465 7465 6374 6f72 5f62 7269 6768   "detector_brigh
+00015f00: 746e 6573 7322 2c20 2264 6574 6563 746f  tness", "detecto
+00015f10: 725f 636f 6e74 7261 7374 225d 3a0a 2020  r_contrast"]:.  
+00015f20: 2020 2020 2020 2020 2020 0a20 2020 2020            .     
+00015f30: 2020 2020 2020 2023 2073 6574 2062 6561         # set bea
+00015f40: 6d20 6163 7469 7665 2076 6965 7720 616e  m active view an
+00015f50: 6420 6465 7669 6365 0a20 2020 2020 2020  d device.       
+00015f60: 2020 2020 2073 656c 662e 636f 6e6e 6563       self.connec
+00015f70: 7469 6f6e 2e69 6d61 6769 6e67 2e73 6574  tion.imaging.set
+00015f80: 5f61 6374 6976 655f 7669 6577 2862 6561  _active_view(bea
+00015f90: 6d5f 7479 7065 2e76 616c 7565 290a 2020  m_type.value).  
+00015fa0: 2020 2020 2020 2020 2020 7365 6c66 2e63            self.c
+00015fb0: 6f6e 6e65 6374 696f 6e2e 696d 6167 696e  onnection.imagin
+00015fc0: 672e 7365 745f 6163 7469 7665 5f64 6576  g.set_active_dev
+00015fd0: 6963 6528 6265 616d 5f74 7970 652e 7661  ice(beam_type.va
+00015fe0: 6c75 6529 0a0a 2020 2020 2020 2020 2020  lue)..          
+00015ff0: 2020 6966 206b 6579 203d 3d20 2264 6574    if key == "det
+00016000: 6563 746f 725f 7479 7065 223a 0a20 2020  ector_type":.   
+00016010: 2020 2020 2020 2020 2020 2020 2072 6574               ret
+00016020: 7572 6e20 7365 6c66 2e63 6f6e 6e65 6374  urn self.connect
+00016030: 696f 6e2e 6465 7465 6374 6f72 2e74 7970  ion.detector.typ
+00016040: 652e 7661 6c75 650a 2020 2020 2020 2020  e.value.        
+00016050: 2020 2020 6966 206b 6579 203d 3d20 2264      if key == "d
+00016060: 6574 6563 746f 725f 6d6f 6465 223a 0a20  etector_mode":. 
+00016070: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00016080: 6574 7572 6e20 7365 6c66 2e63 6f6e 6e65  eturn self.conne
+00016090: 6374 696f 6e2e 6465 7465 6374 6f72 2e6d  ction.detector.m
+000160a0: 6f64 652e 7661 6c75 650a 2020 2020 2020  ode.value.      
+000160b0: 2020 2020 2020 6966 206b 6579 203d 3d20        if key == 
+000160c0: 2264 6574 6563 746f 725f 6272 6967 6874  "detector_bright
+000160d0: 6e65 7373 223a 0a20 2020 2020 2020 2020  ness":.         
+000160e0: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
+000160f0: 6c66 2e63 6f6e 6e65 6374 696f 6e2e 6465  lf.connection.de
+00016100: 7465 6374 6f72 2e62 7269 6768 746e 6573  tector.brightnes
+00016110: 732e 7661 6c75 650a 2020 2020 2020 2020  s.value.        
+00016120: 2020 2020 6966 206b 6579 203d 3d20 2264      if key == "d
+00016130: 6574 6563 746f 725f 636f 6e74 7261 7374  etector_contrast
+00016140: 223a 0a20 2020 2020 2020 2020 2020 2020  ":.             
+00016150: 2020 2072 6574 7572 6e20 7365 6c66 2e63     return self.c
+00016160: 6f6e 6e65 6374 696f 6e2e 6465 7465 6374  onnection.detect
+00016170: 6f72 2e63 6f6e 7472 6173 742e 7661 6c75  or.contrast.valu
+00016180: 650a 0a20 2020 2020 2020 2023 206d 616e  e..        # man
+00016190: 6970 756c 6174 6f72 2070 726f 7065 7274  ipulator propert
+000161a0: 6965 730a 2020 2020 2020 2020 6966 206b  ies.        if k
+000161b0: 6579 203d 3d20 226d 616e 6970 756c 6174  ey == "manipulat
+000161c0: 6f72 5f70 6f73 6974 696f 6e22 3a0a 2020  or_position":.  
+000161d0: 2020 2020 2020 2020 2020 5f63 6865 636b            _check
+000161e0: 5f6e 6565 646c 6528 7365 6c66 2e68 6172  _needle(self.har
+000161f0: 6477 6172 655f 7365 7474 696e 6773 290a  dware_settings).
+00016200: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00016210: 726e 2073 656c 662e 636f 6e6e 6563 7469  rn self.connecti
+00016220: 6f6e 2e73 7065 6369 6d65 6e2e 6d61 6e69  on.specimen.mani
+00016230: 7075 6c61 746f 722e 6375 7272 656e 745f  pulator.current_
+00016240: 706f 7369 7469 6f6e 0a20 2020 2020 2020  position.       
+00016250: 2069 6620 6b65 7920 3d3d 2022 6d61 6e69   if key == "mani
+00016260: 7075 6c61 746f 725f 7374 6174 6522 3a0a  pulator_state":.
+00016270: 2020 2020 2020 2020 2020 2020 5f63 6865              _che
+00016280: 636b 5f6e 6565 646c 6528 7365 6c66 2e68  ck_needle(self.h
+00016290: 6172 6477 6172 655f 7365 7474 696e 6773  ardware_settings
+000162a0: 290a 2020 2020 2020 2020 2020 2020 7265  ).            re
+000162b0: 7475 726e 2073 656c 662e 636f 6e6e 6563  turn self.connec
+000162c0: 7469 6f6e 2e73 7065 6369 6d65 6e2e 6d61  tion.specimen.ma
+000162d0: 6e69 7075 6c61 746f 722e 7374 6174 650a  nipulator.state.
+000162e0: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
+000162f0: 2023 206c 6f67 6769 6e67 2e77 6172 6e69   # logging.warni
+00016300: 6e67 2866 2255 6e6b 6e6f 776e 206b 6579  ng(f"Unknown key
+00016310: 3a20 7b6b 6579 7d20 287b 6265 616d 5f74  : {key} ({beam_t
+00016320: 7970 657d 2922 290a 2020 2020 2020 2020  ype})").        
+00016330: 7265 7475 726e 204e 6f6e 6520 2020 200a  return None    .
+00016340: 0a20 2020 2064 6566 2073 6574 2873 656c  .    def set(sel
+00016350: 662c 206b 6579 3a20 7374 722c 2076 616c  f, key: str, val
+00016360: 7565 2c20 6265 616d 5f74 7970 653a 2042  ue, beam_type: B
+00016370: 6561 6d54 7970 6520 3d20 4265 616d 5479  eamType = BeamTy
+00016380: 7065 2e45 4c45 4354 524f 4e29 202d 3e20  pe.ELECTRON) -> 
+00016390: 4e6f 6e65 3a0a 0a20 2020 2020 2020 2023  None:..        #
+000163a0: 2067 6574 2062 6561 6d0a 2020 2020 2020   get beam.      
+000163b0: 2020 6265 616d 203d 2073 656c 662e 636f    beam = self.co
+000163c0: 6e6e 6563 7469 6f6e 2e62 6561 6d73 2e65  nnection.beams.e
+000163d0: 6c65 6374 726f 6e5f 6265 616d 2069 6620  lectron_beam if 
+000163e0: 6265 616d 5f74 7970 6520 3d3d 2042 6561  beam_type == Bea
+000163f0: 6d54 7970 652e 454c 4543 5452 4f4e 2065  mType.ELECTRON e
+00016400: 6c73 6520 7365 6c66 2e63 6f6e 6e65 6374  lse self.connect
+00016410: 696f 6e2e 6265 616d 732e 696f 6e5f 6265  ion.beams.ion_be
+00016420: 616d 0a0a 2020 2020 2020 2020 2320 6265  am..        # be
+00016430: 616d 2070 726f 7065 7274 6965 730a 2020  am properties.  
+00016440: 2020 2020 2020 6966 206b 6579 203d 3d20        if key == 
+00016450: 2277 6f72 6b69 6e67 5f64 6973 7461 6e63  "working_distanc
+00016460: 6522 3a0a 2020 2020 2020 2020 2020 2020  e":.            
+00016470: 5f63 6865 636b 5f62 6561 6d28 6265 616d  _check_beam(beam
+00016480: 5f74 7970 652c 2073 656c 662e 6861 7264  _type, self.hard
+00016490: 7761 7265 5f73 6574 7469 6e67 7329 0a20  ware_settings). 
+000164a0: 2020 2020 2020 2020 2020 2062 6561 6d2e             beam.
+000164b0: 776f 726b 696e 675f 6469 7374 616e 6365  working_distance
+000164c0: 2e76 616c 7565 203d 2076 616c 7565 0a20  .value = value. 
+000164d0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+000164e0: 636f 6e6e 6563 7469 6f6e 2e73 7065 6369  connection.speci
+000164f0: 6d65 6e2e 7374 6167 652e 6c69 6e6b 2829  men.stage.link()
+00016500: 2023 204c 696e 6b20 7468 6520 7370 6563   # Link the spec
+00016510: 696d 656e 2073 7461 6765 0a20 2020 2020  imen stage.     
+00016520: 2020 2020 2020 206c 6f67 6769 6e67 2e69         logging.i
+00016530: 6e66 6f28 6622 7b62 6561 6d5f 7479 7065  nfo(f"{beam_type
+00016540: 2e6e 616d 657d 2077 6f72 6b69 6e67 2064  .name} working d
+00016550: 6973 7461 6e63 6520 7365 7420 746f 207b  istance set to {
+00016560: 7661 6c75 657d 206d 2e22 290a 2020 2020  value} m.").    
+00016570: 2020 2020 2020 2020 7265 7475 726e 200a          return .
+00016580: 2020 2020 2020 2020 6966 206b 6579 203d          if key =
+00016590: 3d20 2263 7572 7265 6e74 223a 0a20 2020  = "current":.   
+000165a0: 2020 2020 2020 2020 205f 6368 6563 6b5f           _check_
+000165b0: 6265 616d 2862 6561 6d5f 7479 7065 2c20  beam(beam_type, 
+000165c0: 7365 6c66 2e68 6172 6477 6172 655f 7365  self.hardware_se
+000165d0: 7474 696e 6773 290a 2020 2020 2020 2020  ttings).        
+000165e0: 2020 2020 6265 616d 2e62 6561 6d5f 6375      beam.beam_cu
+000165f0: 7272 656e 742e 7661 6c75 6520 3d20 7661  rrent.value = va
+00016600: 6c75 650a 2020 2020 2020 2020 2020 2020  lue.            
+00016610: 6c6f 6767 696e 672e 696e 666f 2866 227b  logging.info(f"{
+00016620: 6265 616d 5f74 7970 652e 6e61 6d65 7d20  beam_type.name} 
+00016630: 6375 7272 656e 7420 7365 7420 746f 207b  current set to {
+00016640: 7661 6c75 657d 2041 2e22 290a 2020 2020  value} A.").    
+00016650: 2020 2020 2020 2020 7265 7475 726e 0a20          return. 
+00016660: 2020 2020 2020 2069 6620 6b65 7920 3d3d         if key ==
+00016670: 2022 766f 6c74 6167 6522 3a0a 2020 2020   "voltage":.    
+00016680: 2020 2020 2020 2020 5f63 6865 636b 5f62          _check_b
+00016690: 6561 6d28 6265 616d 5f74 7970 652c 2073  eam(beam_type, s
+000166a0: 656c 662e 6861 7264 7761 7265 5f73 6574  elf.hardware_set
+000166b0: 7469 6e67 7329 0a20 2020 2020 2020 2020  tings).         
+000166c0: 2020 2062 6561 6d2e 6869 6768 5f76 6f6c     beam.high_vol
+000166d0: 7461 6765 2e76 616c 7565 203d 2076 616c  tage.value = val
+000166e0: 7565 0a20 2020 2020 2020 2020 2020 206c  ue.            l
+000166f0: 6f67 6769 6e67 2e69 6e66 6f28 6622 7b62  ogging.info(f"{b
+00016700: 6561 6d5f 7479 7065 2e6e 616d 657d 2076  eam_type.name} v
+00016710: 6f6c 7461 6765 2073 6574 2074 6f20 7b76  oltage set to {v
+00016720: 616c 7565 7d20 562e 2229 0a20 2020 2020  alue} V.").     
+00016730: 2020 2020 2020 2072 6574 7572 6e0a 2020         return.  
+00016740: 2020 2020 2020 6966 206b 6579 203d 3d20        if key == 
+00016750: 2268 6677 223a 0a20 2020 2020 2020 2020  "hfw":.         
+00016760: 2020 205f 6368 6563 6b5f 6265 616d 2862     _check_beam(b
+00016770: 6561 6d5f 7479 7065 2c20 7365 6c66 2e68  eam_type, self.h
+00016780: 6172 6477 6172 655f 7365 7474 696e 6773  ardware_settings
+00016790: 290a 2020 2020 2020 2020 2020 2020 6265  ).            be
+000167a0: 616d 2e68 6f72 697a 6f6e 7461 6c5f 6669  am.horizontal_fi
+000167b0: 656c 645f 7769 6474 682e 7661 6c75 6520  eld_width.value 
+000167c0: 3d20 7661 6c75 650a 2020 2020 2020 2020  = value.        
+000167d0: 2020 2020 6c6f 6767 696e 672e 696e 666f      logging.info
+000167e0: 2866 227b 6265 616d 5f74 7970 652e 6e61  (f"{beam_type.na
+000167f0: 6d65 7d20 4846 5720 7365 7420 746f 207b  me} HFW set to {
+00016800: 7661 6c75 657d 206d 2e22 290a 2020 2020  value} m.").    
+00016810: 2020 2020 2020 2020 7265 7475 726e 0a20          return. 
+00016820: 2020 2020 2020 2069 6620 6b65 7920 3d3d         if key ==
+00016830: 2022 7265 736f 6c75 7469 6f6e 223a 0a20   "resolution":. 
+00016840: 2020 2020 2020 2020 2020 205f 6368 6563             _chec
+00016850: 6b5f 6265 616d 2862 6561 6d5f 7479 7065  k_beam(beam_type
+00016860: 2c20 7365 6c66 2e68 6172 6477 6172 655f  , self.hardware_
+00016870: 7365 7474 696e 6773 290a 2020 2020 2020  settings).      
+00016880: 2020 2020 2020 6265 616d 2e73 6361 6e6e        beam.scann
+00016890: 696e 672e 7265 736f 6c75 7469 6f6e 2e76  ing.resolution.v
+000168a0: 616c 7565 203d 2076 616c 7565 0a20 2020  alue = value.   
+000168b0: 2020 2020 2020 2020 206c 6f67 6769 6e67           logging
+000168c0: 2e69 6e66 6f28 6622 7b62 6561 6d5f 7479  .info(f"{beam_ty
+000168d0: 7065 2e6e 616d 657d 2072 6573 6f6c 7574  pe.name} resolut
+000168e0: 696f 6e20 7365 7420 746f 207b 7661 6c75  ion set to {valu
+000168f0: 657d 206d 2e22 290a 2020 2020 2020 2020  e} m.").        
+00016900: 2020 2020 7265 7475 726e 0a20 2020 2020      return.     
+00016910: 2020 2069 6620 6b65 7920 3d3d 2022 6477     if key == "dw
+00016920: 656c 6c5f 7469 6d65 223a 0a20 2020 2020  ell_time":.     
+00016930: 2020 2020 2020 205f 6368 6563 6b5f 6265         _check_be
+00016940: 616d 2862 6561 6d5f 7479 7065 2c20 7365  am(beam_type, se
+00016950: 6c66 2e68 6172 6477 6172 655f 7365 7474  lf.hardware_sett
+00016960: 696e 6773 290a 2020 2020 2020 2020 2020  ings).          
+00016970: 2020 6265 616d 2e73 6361 6e6e 696e 672e    beam.scanning.
+00016980: 6477 656c 6c5f 7469 6d65 2e76 616c 7565  dwell_time.value
+00016990: 203d 2076 616c 7565 0a20 2020 2020 2020   = value.       
+000169a0: 2020 2020 206c 6f67 6769 6e67 2e69 6e66       logging.inf
+000169b0: 6f28 6622 7b62 6561 6d5f 7479 7065 2e6e  o(f"{beam_type.n
+000169c0: 616d 657d 2064 7765 6c6c 2074 696d 6520  ame} dwell time 
+000169d0: 7365 7420 746f 207b 7661 6c75 657d 2073  set to {value} s
+000169e0: 2e22 290a 2020 2020 2020 2020 2020 2020  .").            
+000169f0: 7265 7475 726e 0a20 2020 2020 2020 2069  return.        i
+00016a00: 6620 6b65 7920 3d3d 2022 7363 616e 5f72  f key == "scan_r
+00016a10: 6f74 6174 696f 6e22 3a0a 2020 2020 2020  otation":.      
+00016a20: 2020 2020 2020 5f63 6865 636b 5f62 6561        _check_bea
+00016a30: 6d28 6265 616d 5f74 7970 652c 2073 656c  m(beam_type, sel
+00016a40: 662e 6861 7264 7761 7265 5f73 6574 7469  f.hardware_setti
+00016a50: 6e67 7329 0a20 2020 2020 2020 2020 2020  ngs).           
+00016a60: 2062 6561 6d2e 7363 616e 6e69 6e67 2e72   beam.scanning.r
+00016a70: 6f74 6174 696f 6e2e 7661 6c75 6520 3d20  otation.value = 
+00016a80: 7661 6c75 650a 2020 2020 2020 2020 2020  value.          
+00016a90: 2020 6c6f 6767 696e 672e 696e 666f 2866    logging.info(f
+00016aa0: 227b 6265 616d 5f74 7970 652e 6e61 6d65  "{beam_type.name
+00016ab0: 7d20 7363 616e 2072 6f74 6174 696f 6e20  } scan rotation 
+00016ac0: 7365 7420 746f 207b 7661 6c75 657d 2064  set to {value} d
+00016ad0: 6567 7265 6573 2e22 290a 2020 2020 2020  egrees.").      
+00016ae0: 2020 2020 2020 7265 7475 726e 0a20 2020        return.   
+00016af0: 2020 2020 2069 6620 6b65 7920 3d3d 2022       if key == "
+00016b00: 7368 6966 7422 3a0a 2020 2020 2020 2020  shift":.        
+00016b10: 2020 2020 5f63 6865 636b 5f62 6561 6d28      _check_beam(
+00016b20: 6265 616d 5f74 7970 652c 2073 656c 662e  beam_type, self.
+00016b30: 6861 7264 7761 7265 5f73 6574 7469 6e67  hardware_setting
+00016b40: 7329 0a20 2020 2020 2020 2020 2020 2062  s).            b
+00016b50: 6561 6d2e 6265 616d 5f73 6869 6674 2e76  eam.beam_shift.v
+00016b60: 616c 7565 2e78 203d 2076 616c 7565 2e78  alue.x = value.x
+00016b70: 0a20 2020 2020 2020 2020 2020 2062 6561  .            bea
+00016b80: 6d2e 6265 616d 5f73 6869 6674 2e76 616c  m.beam_shift.val
+00016b90: 7565 2e78 203d 2076 616c 7565 2e79 0a20  ue.x = value.y. 
+00016ba0: 2020 2020 2020 2020 2020 206c 6f67 6769             loggi
+00016bb0: 6e67 2e69 6e66 6f28 6622 7b62 6561 6d5f  ng.info(f"{beam_
+00016bc0: 7479 7065 2e6e 616d 657d 2073 6869 6674  type.name} shift
+00016bd0: 2073 6574 2074 6f20 7b76 616c 7565 7d2e   set to {value}.
+00016be0: 2229 0a20 2020 2020 2020 2020 2020 2072  ").            r
+00016bf0: 6574 7572 6e0a 2020 2020 2020 2020 6966  eturn.        if
+00016c00: 206b 6579 203d 3d20 2273 7469 676d 6174   key == "stigmat
+00016c10: 696f 6e22 3a0a 2020 2020 2020 2020 2020  ion":.          
+00016c20: 2020 5f63 6865 636b 5f62 6561 6d28 6265    _check_beam(be
+00016c30: 616d 5f74 7970 652c 2073 656c 662e 6861  am_type, self.ha
+00016c40: 7264 7761 7265 5f73 6574 7469 6e67 7329  rdware_settings)
+00016c50: 0a20 2020 2020 2020 2020 2020 2062 6561  .            bea
+00016c60: 6d2e 7374 6967 6d61 746f 722e 7661 6c75  m.stigmator.valu
+00016c70: 652e 7820 3d20 7661 6c75 652e 780a 2020  e.x = value.x.  
+00016c80: 2020 2020 2020 2020 2020 6265 616d 2e73            beam.s
+00016c90: 7469 676d 6174 6f72 2e76 616c 7565 2e79  tigmator.value.y
+00016ca0: 203d 2076 616c 7565 2e79 0a20 2020 2020   = value.y.     
+00016cb0: 2020 2020 2020 206c 6f67 6769 6e67 2e69         logging.i
+00016cc0: 6e66 6f28 6622 7b62 6561 6d5f 7479 7065  nfo(f"{beam_type
+00016cd0: 2e6e 616d 657d 2073 7469 676d 6174 696f  .name} stigmatio
+00016ce0: 6e20 7365 7420 746f 207b 7661 6c75 657d  n set to {value}
+00016cf0: 2e22 290a 2020 2020 2020 2020 2020 2020  .").            
+00016d00: 7265 7475 726e 0a0a 2020 2020 2020 2020  return..        
+00016d10: 2320 6265 616d 2063 6f6e 7472 6f6c 0a20  # beam control. 
+00016d20: 2020 2020 2020 2069 6620 6b65 7920 3d3d         if key ==
+00016d30: 2022 6f6e 223a 0a20 2020 2020 2020 2020   "on":.         
+00016d40: 2020 205f 6368 6563 6b5f 6265 616d 2862     _check_beam(b
+00016d50: 6561 6d5f 7479 7065 2c20 7365 6c66 2e68  eam_type, self.h
+00016d60: 6172 6477 6172 655f 7365 7474 696e 6773  ardware_settings
+00016d70: 290a 2020 2020 2020 2020 2020 2020 6265  ).            be
+00016d80: 616d 2e74 7572 6e5f 6f6e 2829 2069 6620  am.turn_on() if 
+00016d90: 7661 6c75 6520 656c 7365 2062 6561 6d2e  value else beam.
+00016da0: 7475 726e 5f6f 6666 2829 0a20 2020 2020  turn_off().     
+00016db0: 2020 2020 2020 206c 6f67 6769 6e67 2e69         logging.i
+00016dc0: 6e66 6f28 6622 7b62 6561 6d5f 7479 7065  nfo(f"{beam_type
+00016dd0: 2e6e 616d 657d 2062 6561 6d20 7475 726e  .name} beam turn
+00016de0: 6564 207b 276f 6e27 2069 6620 7661 6c75  ed {'on' if valu
+00016df0: 6520 656c 7365 2027 6f66 6627 7d2e 2229  e else 'off'}.")
+00016e00: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+00016e10: 7572 6e0a 2020 2020 2020 2020 6966 206b  urn.        if k
+00016e20: 6579 203d 3d20 2262 6c61 6e6b 6564 223a  ey == "blanked":
+00016e30: 0a20 2020 2020 2020 2020 2020 205f 6368  .            _ch
+00016e40: 6563 6b5f 6265 616d 2862 6561 6d5f 7479  eck_beam(beam_ty
+00016e50: 7065 2c20 7365 6c66 2e68 6172 6477 6172  pe, self.hardwar
+00016e60: 655f 7365 7474 696e 6773 290a 2020 2020  e_settings).    
+00016e70: 2020 2020 2020 2020 6265 616d 2e62 6c61          beam.bla
+00016e80: 6e6b 2829 2069 6620 7661 6c75 6520 656c  nk() if value el
+00016e90: 7365 2062 6561 6d2e 756e 626c 616e 6b28  se beam.unblank(
+00016ea0: 290a 2020 2020 2020 2020 2020 2020 6c6f  ).            lo
+00016eb0: 6767 696e 672e 696e 666f 2866 227b 6265  gging.info(f"{be
+00016ec0: 616d 5f74 7970 652e 6e61 6d65 7d20 6265  am_type.name} be
+00016ed0: 616d 207b 2762 6c61 6e6b 6564 2720 6966  am {'blanked' if
+00016ee0: 2076 616c 7565 2065 6c73 6520 2775 6e62   value else 'unb
+00016ef0: 6c61 6e6b 6564 277d 2e22 290a 2020 2020  lanked'}.").    
+00016f00: 2020 2020 2020 2020 7265 7475 726e 0a0a          return..
+00016f10: 2020 2020 2020 2020 2320 6465 7465 6374          # detect
+00016f20: 6f72 2070 726f 7065 7274 6965 730a 2020  or properties.  
+00016f30: 2020 2020 2020 6966 206b 6579 2069 6e20        if key in 
+00016f40: 5b22 6465 7465 6374 6f72 5f6d 6f64 6522  ["detector_mode"
+00016f50: 2c20 2264 6574 6563 746f 725f 7479 7065  , "detector_type
+00016f60: 222c 2022 6465 7465 6374 6f72 5f62 7269  ", "detector_bri
+00016f70: 6768 746e 6573 7322 2c20 2264 6574 6563  ghtness", "detec
+00016f80: 746f 725f 636f 6e74 7261 7374 225d 3a0a  tor_contrast"]:.
+00016f90: 2020 2020 2020 2020 2020 2020 2320 7365              # se
+00016fa0: 7420 6265 616d 2061 6374 6976 6520 7669  t beam active vi
+00016fb0: 6577 2061 6e64 2064 6576 6963 650a 2020  ew and device.  
+00016fc0: 2020 2020 2020 2020 2020 7365 6c66 2e63            self.c
+00016fd0: 6f6e 6e65 6374 696f 6e2e 696d 6167 696e  onnection.imagin
+00016fe0: 672e 7365 745f 6163 7469 7665 5f76 6965  g.set_active_vie
+00016ff0: 7728 6265 616d 5f74 7970 652e 7661 6c75  w(beam_type.valu
+00017000: 6529 0a20 2020 2020 2020 2020 2020 2073  e).            s
+00017010: 656c 662e 636f 6e6e 6563 7469 6f6e 2e69  elf.connection.i
+00017020: 6d61 6769 6e67 2e73 6574 5f61 6374 6976  maging.set_activ
+00017030: 655f 6465 7669 6365 2862 6561 6d5f 7479  e_device(beam_ty
+00017040: 7065 2e76 616c 7565 290a 0a20 2020 2020  pe.value)..     
+00017050: 2020 2020 2020 2069 6620 6b65 7920 3d3d         if key ==
+00017060: 2022 6465 7465 6374 6f72 5f6d 6f64 6522   "detector_mode"
+00017070: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00017080: 2020 6966 2076 616c 7565 2069 6e20 7365    if value in se
+00017090: 6c66 2e63 6f6e 6e65 6374 696f 6e2e 6465  lf.connection.de
+000170a0: 7465 6374 6f72 2e6d 6f64 652e 6176 6169  tector.mode.avai
+000170b0: 6c61 626c 655f 7661 6c75 6573 3a0a 2020  lable_values:.  
+000170c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000170d0: 2020 7365 6c66 2e63 6f6e 6e65 6374 696f    self.connectio
+000170e0: 6e2e 6465 7465 6374 6f72 2e6d 6f64 652e  n.detector.mode.
+000170f0: 7661 6c75 6520 3d20 7661 6c75 650a 2020  value = value.  
+00017100: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017110: 2020 6c6f 6767 696e 672e 696e 666f 2866    logging.info(f
+00017120: 2244 6574 6563 746f 7220 6d6f 6465 2073  "Detector mode s
+00017130: 6574 2074 6f20 7b76 616c 7565 7d2e 2229  et to {value}.")
+00017140: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00017150: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00017160: 2020 2020 2020 2020 2020 206c 6f67 6769             loggi
+00017170: 6e67 2e77 6172 6e69 6e67 2866 2244 6574  ng.warning(f"Det
+00017180: 6563 746f 7220 6d6f 6465 207b 7661 6c75  ector mode {valu
+00017190: 657d 206e 6f74 2061 7661 696c 6162 6c65  e} not available
+000171a0: 2e22 290a 2020 2020 2020 2020 2020 2020  .").            
+000171b0: 2020 2020 7265 7475 726e 0a20 2020 2020      return.     
+000171c0: 2020 2020 2020 2069 6620 6b65 7920 3d3d         if key ==
+000171d0: 2022 6465 7465 6374 6f72 5f74 7970 6522   "detector_type"
+000171e0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000171f0: 2020 6966 2076 616c 7565 2069 6e20 7365    if value in se
+00017200: 6c66 2e63 6f6e 6e65 6374 696f 6e2e 6465  lf.connection.de
+00017210: 7465 6374 6f72 2e74 7970 652e 6176 6169  tector.type.avai
+00017220: 6c61 626c 655f 7661 6c75 6573 3a0a 2020  lable_values:.  
+00017230: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017240: 2020 7365 6c66 2e63 6f6e 6e65 6374 696f    self.connectio
+00017250: 6e2e 6465 7465 6374 6f72 2e74 7970 652e  n.detector.type.
+00017260: 7661 6c75 6520 3d20 7661 6c75 650a 2020  value = value.  
+00017270: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017280: 2020 6c6f 6767 696e 672e 696e 666f 2866    logging.info(f
+00017290: 2244 6574 6563 746f 7220 7479 7065 2073  "Detector type s
+000172a0: 6574 2074 6f20 7b76 616c 7565 7d2e 2229  et to {value}.")
+000172b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000172c0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+000172d0: 2020 2020 2020 2020 2020 206c 6f67 6769             loggi
+000172e0: 6e67 2e77 6172 6e69 6e67 2866 2244 6574  ng.warning(f"Det
+000172f0: 6563 746f 7220 7479 7065 207b 7661 6c75  ector type {valu
+00017300: 657d 206e 6f74 2061 7661 696c 6162 6c65  e} not available
+00017310: 2e22 290a 2020 2020 2020 2020 2020 2020  .").            
+00017320: 2020 2020 7265 7475 726e 0a20 2020 2020      return.     
+00017330: 2020 2020 2020 2069 6620 6b65 7920 3d3d         if key ==
+00017340: 2022 6465 7465 6374 6f72 5f62 7269 6768   "detector_brigh
+00017350: 746e 6573 7322 3a0a 2020 2020 2020 2020  tness":.        
+00017360: 2020 2020 2020 2020 6966 2030 203c 3d20          if 0 <= 
+00017370: 7661 6c75 6520 3c3d 2031 203a 0a20 2020  value <= 1 :.   
+00017380: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017390: 2073 656c 662e 636f 6e6e 6563 7469 6f6e   self.connection
+000173a0: 2e64 6574 6563 746f 722e 6272 6967 6874  .detector.bright
+000173b0: 6e65 7373 2e76 616c 7565 203d 2076 616c  ness.value = val
+000173c0: 7565 0a20 2020 2020 2020 2020 2020 2020  ue.             
+000173d0: 2020 2020 2020 206c 6f67 6769 6e67 2e69         logging.i
+000173e0: 6e66 6f28 6622 4465 7465 6374 6f72 2062  nfo(f"Detector b
+000173f0: 7269 6768 746e 6573 7320 7365 7420 746f  rightness set to
+00017400: 207b 7661 6c75 657d 2e22 290a 2020 2020   {value}.").    
+00017410: 2020 2020 2020 2020 2020 2020 656c 7365              else
+00017420: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00017430: 2020 2020 2020 6c6f 6767 696e 672e 7761        logging.wa
+00017440: 726e 696e 6728 6622 4465 7465 6374 6f72  rning(f"Detector
+00017450: 2062 7269 6768 746e 6573 7320 7b76 616c   brightness {val
+00017460: 7565 7d20 6e6f 7420 6176 6169 6c61 626c  ue} not availabl
+00017470: 652c 206d 7573 7420 6265 2062 6574 7765  e, must be betwe
+00017480: 656e 2030 2061 6e64 2031 2e22 290a 2020  en 0 and 1.").  
+00017490: 2020 2020 2020 2020 2020 2020 2020 7265                re
+000174a0: 7475 726e 0a20 2020 2020 2020 2020 2020  turn.           
+000174b0: 2069 6620 6b65 7920 3d3d 2022 6465 7465   if key == "dete
+000174c0: 6374 6f72 5f63 6f6e 7472 6173 7422 3a0a  ctor_contrast":.
+000174d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000174e0: 6966 2030 203c 3d20 7661 6c75 6520 3c3d  if 0 <= value <=
+000174f0: 2031 203a 0a20 2020 2020 2020 2020 2020   1 :.           
+00017500: 2020 2020 2020 2020 2073 656c 662e 636f           self.co
+00017510: 6e6e 6563 7469 6f6e 2e64 6574 6563 746f  nnection.detecto
+00017520: 722e 636f 6e74 7261 7374 2e76 616c 7565  r.contrast.value
+00017530: 203d 2076 616c 7565 0a20 2020 2020 2020   = value.       
+00017540: 2020 2020 2020 2020 2020 2020 206c 6f67               log
+00017550: 6769 6e67 2e69 6e66 6f28 6622 4465 7465  ging.info(f"Dete
+00017560: 6374 6f72 2063 6f6e 7472 6173 7420 7365  ctor contrast se
+00017570: 7420 746f 207b 7661 6c75 657d 2e22 290a  t to {value}.").
+00017580: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017590: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+000175a0: 2020 2020 2020 2020 2020 6c6f 6767 696e            loggin
+000175b0: 672e 7761 726e 696e 6728 6622 4465 7465  g.warning(f"Dete
+000175c0: 6374 6f72 2063 6f6e 7472 6173 7420 7b76  ctor contrast {v
+000175d0: 616c 7565 7d20 6e6f 7420 6176 6169 6c61  alue} not availa
+000175e0: 626c 652c 206d 7574 2062 6520 6265 7477  ble, mut be betw
+000175f0: 6565 6e20 3020 616e 6420 312e 2229 0a20  een 0 and 1."). 
+00017600: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00017610: 6574 7572 6e0a 0a20 2020 2020 2020 2023  eturn..        #
+00017620: 206f 6e6c 7920 7375 7070 6f72 7465 6420   only supported 
+00017630: 666f 7220 456c 6563 7472 6f6e 0a20 2020  for Electron.   
+00017640: 2020 2020 2069 6620 6265 616d 5f74 7970       if beam_typ
+00017650: 6520 6973 2042 6561 6d54 7970 652e 454c  e is BeamType.EL
+00017660: 4543 5452 4f4e 3a0a 2020 2020 2020 2020  ECTRON:.        
+00017670: 2020 2020 6966 206b 6579 203d 3d20 2261      if key == "a
+00017680: 6e67 756c 6172 5f63 6f72 7265 6374 696f  ngular_correctio
+00017690: 6e5f 616e 676c 6522 3a0a 2020 2020 2020  n_angle":.      
+000176a0: 2020 2020 2020 2020 2020 5f63 6865 636b            _check
+000176b0: 5f62 6561 6d28 6265 616d 5f74 7970 652c  _beam(beam_type,
+000176c0: 2073 656c 662e 6861 7264 7761 7265 5f73   self.hardware_s
+000176d0: 6574 7469 6e67 7329 0a20 2020 2020 2020  ettings).       
+000176e0: 2020 2020 2020 2020 2062 6561 6d2e 616e           beam.an
+000176f0: 6775 6c61 725f 636f 7272 6563 7469 6f6e  gular_correction
+00017700: 2e61 6e67 6c65 2e76 616c 7565 203d 2076  .angle.value = v
+00017710: 616c 7565 0a20 2020 2020 2020 2020 2020  alue.           
+00017720: 2020 2020 206c 6f67 6769 6e67 2e69 6e66       logging.inf
+00017730: 6f28 6622 416e 6775 6c61 7220 636f 7272  o(f"Angular corr
+00017740: 6563 7469 6f6e 2061 6e67 6c65 2073 6574  ection angle set
+00017750: 2074 6f20 7b76 616c 7565 7d20 7261 6469   to {value} radi
+00017760: 616e 732e 2229 0a20 2020 2020 2020 2020  ans.").         
+00017770: 2020 2020 2020 2072 6574 7572 6e0a 0a20         return.. 
+00017780: 2020 2020 2020 2020 2020 2069 6620 6b65             if ke
+00017790: 7920 3d3d 2022 616e 6775 6c61 725f 636f  y == "angular_co
+000177a0: 7272 6563 7469 6f6e 5f74 696c 745f 636f  rrection_tilt_co
+000177b0: 7272 6563 7469 6f6e 223a 0a20 2020 2020  rrection":.     
+000177c0: 2020 2020 2020 2020 2020 205f 6368 6563             _chec
+000177d0: 6b5f 6265 616d 2862 6561 6d5f 7479 7065  k_beam(beam_type
+000177e0: 2c20 7365 6c66 2e68 6172 6477 6172 655f  , self.hardware_
+000177f0: 7365 7474 696e 6773 290a 2020 2020 2020  settings).      
+00017800: 2020 2020 2020 2020 2020 6265 616d 2e61            beam.a
+00017810: 6e67 756c 6172 5f63 6f72 7265 6374 696f  ngular_correctio
+00017820: 6e2e 7469 6c74 5f63 6f72 7265 6374 696f  n.tilt_correctio
+00017830: 6e2e 7475 726e 5f6f 6e28 2920 6966 2076  n.turn_on() if v
+00017840: 616c 7565 2065 6c73 6520 6265 616d 2e61  alue else beam.a
+00017850: 6e67 756c 6172 5f63 6f72 7265 6374 696f  ngular_correctio
+00017860: 6e2e 7469 6c74 5f63 6f72 7265 6374 696f  n.tilt_correctio
+00017870: 6e2e 7475 726e 5f6f 6666 2829 0a20 2020  n.turn_off().   
+00017880: 2020 2020 2020 2020 2020 2020 2072 6574               ret
+00017890: 7572 6e0a 2020 2020 2020 2020 6966 2062  urn.        if b
+000178a0: 6561 6d5f 7479 7065 2069 7320 4265 616d  eam_type is Beam
+000178b0: 5479 7065 2e49 4f4e 3a0a 2020 2020 2020  Type.ION:.      
+000178c0: 2020 2020 2020 6966 206b 6579 203d 3d20        if key == 
+000178d0: 2270 6c61 736d 615f 6761 7322 3a0a 2020  "plasma_gas":.  
+000178e0: 2020 2020 2020 2020 2020 2020 2020 5f63                _c
+000178f0: 6865 636b 5f62 6561 6d28 6265 616d 5f74  heck_beam(beam_t
+00017900: 7970 652c 2073 656c 662e 6861 7264 7761  ype, self.hardwa
+00017910: 7265 5f73 6574 7469 6e67 7329 0a20 2020  re_settings).   
+00017920: 2020 2020 2020 2020 2020 2020 205f 6368               _ch
+00017930: 6563 6b5f 7370 7574 7465 7228 7365 6c66  eck_sputter(self
+00017940: 2e68 6172 6477 6172 655f 7365 7474 696e  .hardware_settin
+00017950: 6773 290a 2020 2020 2020 2020 2020 2020  gs).            
+00017960: 2020 2020 6966 2073 656c 662e 6861 7264      if self.hard
+00017970: 7761 7265 5f73 6574 7469 6e67 732e 6361  ware_settings.ca
+00017980: 6e5f 7365 6c65 6374 5f70 6c61 736d 615f  n_select_plasma_
+00017990: 6761 733a 0a20 2020 2020 2020 2020 2020  gas:.           
+000179a0: 2020 2020 2020 2020 2062 6561 6d2e 736f           beam.so
+000179b0: 7572 6365 2e70 6c61 736d 615f 6761 732e  urce.plasma_gas.
+000179c0: 7661 6c75 6520 3d20 7661 6c75 650a 2020  value = value.  
+000179d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000179e0: 2020 6c6f 6767 696e 672e 696e 666f 2866    logging.info(f
+000179f0: 2250 6c61 736d 6120 6761 7320 7365 7420  "Plasma gas set 
+00017a00: 746f 207b 7661 6c75 657d 2e22 290a 2020  to {value}.").  
+00017a10: 2020 2020 2020 2020 2020 2020 2020 656c                el
+00017a20: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00017a30: 2020 2020 2020 2020 6c6f 6767 696e 672e          logging.
+00017a40: 7761 726e 696e 6728 6622 506c 6173 6d61  warning(f"Plasma
+00017a50: 2067 6173 2063 616e 6e6f 7420 6265 2073   gas cannot be s
+00017a60: 6574 206f 6e20 7468 6973 206d 6963 726f  et on this micro
+00017a70: 7363 6f70 652e 2229 0a20 2020 2020 2020  scope.").       
+00017a80: 2020 2020 2072 6574 7572 6e0a 2020 2020       return.    
+00017a90: 2020 2020 2320 6368 616d 6265 7220 636f      # chamber co
+00017aa0: 6e74 726f 6c20 284e 4f54 453a 2064 6f6e  ntrol (NOTE: don
+00017ab0: 7420 696d 706c 6d65 6e74 2075 6e74 696c  t implment until
+00017ac0: 2061 626c 6520 746f 2074 6573 7420 6f6e   able to test on
+00017ad0: 2068 6172 6477 6172 6529 0a20 2020 2020   hardware).     
+00017ae0: 2020 2069 6620 6b65 7920 3d3d 2022 7075     if key == "pu
+00017af0: 6d70 223a 0a20 2020 2020 2020 2020 2020  mp":.           
+00017b00: 206c 6f67 6769 6e67 2e69 6e66 6f28 6622   logging.info(f"
+00017b10: 4e6f 7420 496d 706c 656d 656e 7465 6420  Not Implemented 
+00017b20: 5965 7422 290a 2020 2020 2020 2020 2020  Yet").          
+00017b30: 2020 7365 6c66 2e63 6f6e 6e65 6374 696f    self.connectio
+00017b40: 6e2e 7661 6375 756d 2e70 756d 7028 290a  n.vacuum.pump().
+00017b50: 2020 2020 2020 2020 2020 2020 2320 6c6f              # lo
+00017b60: 6767 696e 672e 696e 666f 2866 2256 6163  gging.info(f"Vac
+00017b70: 7575 6d20 7075 6d70 206f 6e2e 2229 0a20  uum pump on."). 
+00017b80: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00017b90: 6e0a 2020 2020 2020 2020 6966 206b 6579  n.        if key
+00017ba0: 203d 3d20 2276 656e 7422 3a0a 2020 2020   == "vent":.    
+00017bb0: 2020 2020 2020 2020 6c6f 6767 696e 672e          logging.
+00017bc0: 696e 666f 2866 224e 6f74 2049 6d70 6c65  info(f"Not Imple
+00017bd0: 6d65 6e74 6564 2059 6574 2229 0a20 2020  mented Yet").   
+00017be0: 2020 2020 2020 2020 2023 2073 656c 662e           # self.
+00017bf0: 636f 6e6e 6563 7469 6f6e 2e76 6163 7575  connection.vacuu
+00017c00: 6d2e 7665 6e74 2829 0a20 2020 2020 2020  m.vent().       
+00017c10: 2020 2020 206c 6f67 6769 6e67 2e69 6e66       logging.inf
+00017c20: 6f28 6622 5661 6375 756d 2076 656e 7420  o(f"Vacuum vent 
+00017c30: 6f6e 2e22 290a 2020 2020 2020 2020 2020  on.").          
+00017c40: 2020 7265 7475 726e 0a0a 0a20 2020 2020    return...     
+00017c50: 2020 2023 2073 7461 6765 2070 726f 7065     # stage prope
+00017c60: 7274 6965 730a 2020 2020 2020 2020 6966  rties.        if
+00017c70: 206b 6579 203d 3d20 2273 7461 6765 5f68   key == "stage_h
+00017c80: 6f6d 6522 3a0a 2020 2020 2020 2020 2020  ome":.          
+00017c90: 2020 5f63 6865 636b 5f73 7461 6765 2873    _check_stage(s
+00017ca0: 656c 662e 6861 7264 7761 7265 5f73 6574  elf.hardware_set
+00017cb0: 7469 6e67 7329 0a20 2020 2020 2020 2020  tings).         
+00017cc0: 2020 2073 656c 662e 636f 6e6e 6563 7469     self.connecti
+00017cd0: 6f6e 2e73 7065 6369 6d65 6e2e 7374 6167  on.specimen.stag
+00017ce0: 652e 686f 6d65 2829 0a20 2020 2020 2020  e.home().       
+00017cf0: 2020 2020 206c 6f67 6769 6e67 2e69 6e66       logging.inf
+00017d00: 6f28 6622 5374 6167 6520 686f 6d65 642e  o(f"Stage homed.
+00017d10: 2229 0a20 2020 2020 2020 2020 2020 2072  ").            r
+00017d20: 6574 7572 6e0a 2020 2020 2020 2020 6966  eturn.        if
+00017d30: 206b 6579 203d 3d20 2273 7461 6765 5f6c   key == "stage_l
+00017d40: 696e 6b22 3a0a 2020 2020 2020 2020 2020  ink":.          
+00017d50: 2020 5f63 6865 636b 5f73 7461 6765 2873    _check_stage(s
+00017d60: 656c 662e 6861 7264 7761 7265 5f73 6574  elf.hardware_set
+00017d70: 7469 6e67 7329 0a20 2020 2020 2020 2020  tings).         
+00017d80: 2020 2073 656c 662e 636f 6e6e 6563 7469     self.connecti
+00017d90: 6f6e 2e73 7065 6369 6d65 6e2e 7374 6167  on.specimen.stag
+00017da0: 652e 6c69 6e6b 2829 2069 6620 7661 6c75  e.link() if valu
+00017db0: 6520 656c 7365 2073 656c 662e 636f 6e6e  e else self.conn
+00017dc0: 6563 7469 6f6e 2e73 7065 6369 6d65 6e2e  ection.specimen.
+00017dd0: 7374 6167 652e 756e 6c69 6e6b 2829 0a20  stage.unlink(). 
+00017de0: 2020 2020 2020 2020 2020 206c 6f67 6769             loggi
+00017df0: 6e67 2e69 6e66 6f28 6622 5374 6167 6520  ng.info(f"Stage 
+00017e00: 7b27 6c69 6e6b 6564 2720 6966 2076 616c  {'linked' if val
+00017e10: 7565 2065 6c73 6520 2775 6e6c 696e 6b65  ue else 'unlinke
+00017e20: 6427 7d2e 2229 2020 2020 0a20 2020 2020  d'}.")    .     
+00017e30: 2020 2020 2020 2072 6574 7572 6e0a 0a20         return.. 
+00017e40: 2020 2020 2020 200a 2020 2020 2020 2020         .        
+00017e50: 6c6f 6767 696e 672e 7761 726e 696e 6728  logging.warning(
+00017e60: 6622 556e 6b6e 6f77 6e20 6b65 793a 207b  f"Unknown key: {
+00017e70: 6b65 797d 2028 7b62 6561 6d5f 7479 7065  key} ({beam_type
+00017e80: 7d29 2229 0a20 2020 2020 2020 2072 6574  })").        ret
+00017e90: 7572 6e0a 2020 2020 0a20 2020 2064 6566  urn.    .    def
+00017ea0: 2063 6865 636b 5f61 7661 696c 6162 6c65   check_available
+00017eb0: 5f76 616c 7565 7328 7365 6c66 2c20 6b65  _values(self, ke
+00017ec0: 793a 7374 722c 2076 616c 7565 733a 206c  y:str, values: l
+00017ed0: 6973 742c 2062 6561 6d5f 7479 7065 3a20  ist, beam_type: 
+00017ee0: 4265 616d 5479 7065 203d 204e 6f6e 6529  BeamType = None)
+00017ef0: 202d 3e20 626f 6f6c 3a0a 0a20 2020 2020   -> bool:..     
+00017f00: 2020 2061 7661 696c 6162 6c65 5f76 616c     available_val
+00017f10: 7565 7320 3d20 7365 6c66 2e67 6574 5f61  ues = self.get_a
+00017f20: 7661 696c 6162 6c65 5f76 616c 7565 7328  vailable_values(
+00017f30: 6b65 792c 2062 6561 6d5f 7479 7065 290a  key, beam_type).
+00017f40: 0a20 2020 2020 2020 2069 6620 6176 6169  .        if avai
+00017f50: 6c61 626c 655f 7661 6c75 6573 2069 7320  lable_values is 
+00017f60: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+00017f70: 2020 7265 7475 726e 2046 616c 7365 0a20    return False. 
+00017f80: 2020 2020 2020 200a 2020 2020 2020 2020         .        
+00017f90: 666f 7220 7661 6c75 6520 696e 2076 616c  for value in val
+00017fa0: 7565 733a 0a20 2020 2020 2020 2020 2020  ues:.           
+00017fb0: 2069 6620 7661 6c75 6520 6e6f 7420 696e   if value not in
+00017fc0: 2061 7661 696c 6162 6c65 5f76 616c 7565   available_value
+00017fd0: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
+00017fe0: 2020 2072 6574 7572 6e20 4661 6c73 650a     return False.
+00017ff0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00018000: 6973 696e 7374 616e 6365 2876 616c 7565  isinstance(value
+00018010: 2c20 666c 6f61 7429 3a0a 2020 2020 2020  , float):.      
+00018020: 2020 2020 2020 2020 2020 6966 2076 616c            if val
+00018030: 7565 203c 206d 696e 2861 7661 696c 6162  ue < min(availab
+00018040: 6c65 5f76 616c 7565 7329 206f 7220 7661  le_values) or va
+00018050: 6c75 6520 3e20 6d61 7828 6176 6169 6c61  lue > max(availa
+00018060: 626c 655f 7661 6c75 6573 293a 0a20 2020  ble_values):.   
+00018070: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018080: 2072 6574 7572 6e20 4661 6c73 650a 2020   return False.  
+00018090: 2020 2020 2020 7265 7475 726e 2054 7275        return Tru
+000180a0: 650a 2020 2020 0a20 2020 2064 6566 2068  e.    .    def h
+000180b0: 6f6d 6528 7365 6c66 2920 2d3e 204e 6f6e  ome(self) -> Non
+000180c0: 653a 0a20 2020 2020 2020 2069 6620 7365  e:.        if se
+000180d0: 6c66 2e68 6172 6477 6172 655f 7365 7474  lf.hardware_sett
+000180e0: 696e 6773 2e73 7461 6765 5f65 6e61 626c  ings.stage_enabl
+000180f0: 6564 2069 7320 4661 6c73 653a 0a20 2020  ed is False:.   
+00018100: 2020 2020 2020 2020 2072 6169 7365 204e           raise N
+00018110: 6f74 496d 706c 656d 656e 7465 6445 7272  otImplementedErr
+00018120: 6f72 2822 5374 6167 6520 6e6f 7420 656e  or("Stage not en
+00018130: 6162 6c65 642e 2229 0a20 2020 2020 2020  abled.").       
+00018140: 206c 6f67 6769 6e67 2e69 6e66 6f28 6622   logging.info(f"
+00018150: 486f 6d69 6e67 2073 7461 6765 2e22 290a  Homing stage.").
+00018160: 2020 2020 2020 2020 7365 6c66 2e63 6f6e          self.con
+00018170: 6e65 6374 696f 6e2e 7370 6563 696d 656e  nection.specimen
+00018180: 2e73 7461 6765 2e68 6f6d 6528 290a 2020  .stage.home().  
+00018190: 2020 2020 2020 6c6f 6767 696e 672e 696e        logging.in
+000181a0: 666f 2866 2253 7461 6765 2068 6f6d 6564  fo(f"Stage homed
+000181b0: 2e22 290a 0a0a 636c 6173 7320 5465 7363  .")...class Tesc
+000181c0: 616e 4d69 6372 6f73 636f 7065 2846 6962  anMicroscope(Fib
+000181d0: 7365 6d4d 6963 726f 7363 6f70 6529 3a0a  semMicroscope):.
+000181e0: 2020 2020 2222 220a 2020 2020 4120 636c      """.    A cl
+000181f0: 6173 7320 7265 7072 6573 656e 7469 6e67  ass representing
+00018200: 2061 2054 4553 4341 4e20 4649 422d 5345   a TESCAN FIB-SE
+00018210: 4d20 6d69 6372 6f73 636f 7065 2e0a 0a20  M microscope... 
+00018220: 2020 2054 6869 7320 636c 6173 7320 696e     This class in
+00018230: 6865 7269 7473 2066 726f 6d20 7468 6520  herits from the 
+00018240: 6162 7374 7261 6374 2062 6173 6520 636c  abstract base cl
+00018250: 6173 7320 6046 6962 7365 6d4d 6963 726f  ass `FibsemMicro
+00018260: 7363 6f70 6560 2c20 7768 6963 6820 6465  scope`, which de
+00018270: 6669 6e65 7320 7468 6520 636f 7265 2066  fines the core f
+00018280: 756e 6374 696f 6e61 6c69 7479 206f 6620  unctionality of 
+00018290: 610a 2020 2020 6d69 6372 6f73 636f 7065  a.    microscope
+000182a0: 2e20 496e 2061 6464 6974 696f 6e20 746f  . In addition to
+000182b0: 2074 6865 206d 6574 686f 6473 2064 6566   the methods def
+000182c0: 696e 6564 2069 6e20 7468 6520 6261 7365  ined in the base
+000182d0: 2063 6c61 7373 2c20 7468 6973 2063 6c61   class, this cla
+000182e0: 7373 2070 726f 7669 6465 7320 6164 6469  ss provides addi
+000182f0: 7469 6f6e 616c 206d 6574 686f 6473 2073  tional methods s
+00018300: 7065 6369 6669 630a 2020 2020 746f 2074  pecific.    to t
+00018310: 6865 2054 4553 4341 4e20 4649 422d 5345  he TESCAN FIB-SE
+00018320: 4d20 6d69 6372 6f73 636f 7065 2e0a 0a20  M microscope... 
+00018330: 2020 2041 7474 7269 6275 7465 733a 0a20     Attributes:. 
+00018340: 2020 2020 2020 2063 6f6e 6e65 6374 696f         connectio
+00018350: 6e20 2841 7574 6f6d 6174 696f 6e29 3a20  n (Automation): 
+00018360: 5468 6520 6d69 6372 6f73 636f 7065 2063  The microscope c
+00018370: 6c69 656e 7420 636f 6e6e 6563 7469 6f6e  lient connection
+00018380: 2e0a 2020 2020 2020 2020 696f 6e5f 6465  ..        ion_de
+00018390: 7465 6374 6f72 5f61 6374 6976 6520 2841  tector_active (A
+000183a0: 7574 6f6d 6174 696f 6e2e 4649 422e 4465  utomation.FIB.De
+000183b0: 7465 6374 6f72 293a 2054 6865 2061 6374  tector): The act
+000183c0: 6976 6520 696f 6e20 6265 616d 2064 6574  ive ion beam det
+000183d0: 6563 746f 722e 0a20 2020 2020 2020 206c  ector..        l
+000183e0: 6173 745f 696d 6167 655f 6562 2028 4669  ast_image_eb (Fi
+000183f0: 6273 656d 496d 6167 6529 3a20 4120 7361  bsemImage): A sa
+00018400: 7665 6420 636f 7079 206f 6620 7468 6520  ved copy of the 
+00018410: 6d6f 7374 2072 6563 656e 7420 656c 6563  most recent elec
+00018420: 7472 6f6e 2062 6561 6d20 696d 6167 652e  tron beam image.
+00018430: 0a20 2020 2020 2020 206c 6173 745f 696d  .        last_im
+00018440: 6167 655f 6962 2028 4669 6273 656d 496d  age_ib (FibsemIm
+00018450: 6167 6529 3a20 4120 7361 7665 6420 636f  age): A saved co
+00018460: 7079 206f 6620 7468 6520 6d6f 7374 2072  py of the most r
+00018470: 6563 656e 7420 696f 6e20 6265 616d 2069  ecent ion beam i
+00018480: 6d61 6765 2e0a 0a20 2020 2049 6e68 6572  mage...    Inher
+00018490: 6974 6564 204d 6574 686f 6473 3a0a 2020  ited Methods:.  
+000184a0: 2020 2020 2020 636f 6e6e 6563 745f 746f        connect_to
+000184b0: 5f6d 6963 726f 7363 6f70 6528 7365 6c66  _microscope(self
+000184c0: 2c20 6970 5f61 6464 7265 7373 3a20 7374  , ip_address: st
+000184d0: 722c 2070 6f72 743a 2069 6e74 203d 2037  r, port: int = 7
+000184e0: 3532 3029 202d 3e20 4e6f 6e65 3a20 0a20  520) -> None: . 
+000184f0: 2020 2020 2020 2020 2020 2043 6f6e 6e65             Conne
+00018500: 6374 2074 6f20 6120 5468 6572 6d6f 2046  ct to a Thermo F
+00018510: 6973 6865 7220 6d69 6372 6f73 636f 7065  isher microscope
+00018520: 2061 7420 7468 6520 7370 6563 6966 6965   at the specifie
+00018530: 6420 4950 2061 6464 7265 7373 2061 6e64  d IP address and
+00018540: 2070 6f72 742e 0a0a 2020 2020 2020 2020   port...        
+00018550: 6469 7363 6f6e 6e65 6374 2873 656c 6629  disconnect(self)
+00018560: 202d 3e20 4e6f 6e65 3a20 0a20 2020 2020   -> None: .     
+00018570: 2020 2020 2020 2044 6973 636f 6e6e 6563         Disconnec
+00018580: 7473 2074 6865 206d 6963 726f 7363 6f70  ts the microscop
+00018590: 6520 636c 6965 6e74 2063 6f6e 6e65 6374  e client connect
+000185a0: 696f 6e2e 0a0a 2020 2020 2020 2020 6163  ion...        ac
+000185b0: 7175 6972 655f 696d 6167 6528 7365 6c66  quire_image(self
+000185c0: 2c20 696d 6167 655f 7365 7474 696e 6773  , image_settings
+000185d0: 3a20 496d 6167 6553 6574 7469 6e67 7329  : ImageSettings)
+000185e0: 202d 3e20 4669 6273 656d 496d 6167 653a   -> FibsemImage:
+000185f0: 200a 2020 2020 2020 2020 2020 2020 4163   .            Ac
+00018600: 7175 6972 6520 6120 6e65 7720 696d 6167  quire a new imag
+00018610: 6520 7769 7468 2074 6865 2073 7065 6369  e with the speci
+00018620: 6669 6564 2073 6574 7469 6e67 732e 0a0a  fied settings...
+00018630: 2020 2020 2020 2020 6c61 7374 5f69 6d61          last_ima
+00018640: 6765 2873 656c 662c 2062 6561 6d5f 7479  ge(self, beam_ty
+00018650: 7065 3a20 4265 616d 5479 7065 203d 2042  pe: BeamType = B
+00018660: 6561 6d54 7970 652e 454c 4543 5452 4f4e  eamType.ELECTRON
+00018670: 2920 2d3e 2046 6962 7365 6d49 6d61 6765  ) -> FibsemImage
+00018680: 3a20 0a20 2020 2020 2020 2020 2020 2047  : .            G
+00018690: 6574 2074 6865 206c 6173 7420 7072 6576  et the last prev
+000186a0: 696f 7573 6c79 2061 6371 7569 7265 6420  iously acquired 
+000186b0: 696d 6167 652e 0a0a 2020 2020 2020 2020  image...        
+000186c0: 6175 746f 636f 6e74 7261 7374 2873 656c  autocontrast(sel
+000186d0: 662c 2062 6561 6d5f 7479 7065 3d42 6561  f, beam_type=Bea
+000186e0: 6d54 7970 652e 454c 4543 5452 4f4e 2920  mType.ELECTRON) 
+000186f0: 2d3e 204e 6f6e 653a 200a 2020 2020 2020  -> None: .      
+00018700: 2020 2020 2020 4175 746f 6d61 7469 6361        Automatica
+00018710: 6c6c 7920 6164 6a75 7374 2074 6865 206d  lly adjust the m
+00018720: 6963 726f 7363 6f70 6520 696d 6167 6520  icroscope image 
+00018730: 636f 6e74 7261 7374 2066 6f72 2074 6865  contrast for the
+00018740: 2073 7065 6369 6669 6564 2062 6561 6d20   specified beam 
+00018750: 7479 7065 2e0a 0a20 2020 2020 2020 2061  type...        a
+00018760: 7574 6f5f 666f 6375 7328 7365 6c66 2c20  uto_focus(self, 
+00018770: 6265 616d 5f74 7970 653a 2042 6561 6d54  beam_type: BeamT
+00018780: 7970 6529 202d 3e20 4e6f 6e65 3a0a 2020  ype) -> None:.  
+00018790: 2020 2020 2020 2020 2020 4175 746f 6d61            Automa
+000187a0: 7469 6361 6c6c 7920 6164 6a75 7374 2074  tically adjust t
+000187b0: 6865 206d 6963 726f 7363 6f70 6520 666f  he microscope fo
+000187c0: 6375 7320 666f 7220 7468 6520 7370 6563  cus for the spec
+000187d0: 6966 6965 6420 6265 616d 2074 7970 652e  ified beam type.
+000187e0: 0a0a 2020 2020 2020 2020 7265 7365 745f  ..        reset_
+000187f0: 6265 616d 5f73 6869 6674 7328 7365 6c66  beam_shifts(self
+00018800: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
+00018810: 2020 2020 2020 2053 6574 2074 6865 2062         Set the b
+00018820: 6561 6d20 7368 6966 7420 746f 207a 6572  eam shift to zer
+00018830: 6f20 666f 7220 7468 6520 656c 6563 7472  o for the electr
+00018840: 6f6e 2061 6e64 2069 6f6e 2062 6561 6d73  on and ion beams
+00018850: 2e0a 2020 2020 2020 2020 0a20 2020 2020  ..        .     
+00018860: 2020 2062 6561 6d5f 7368 6966 7428 7365     beam_shift(se
+00018870: 6c66 2c20 6478 3a20 666c 6f61 742c 2064  lf, dx: float, d
+00018880: 793a 2066 6c6f 6174 2c20 2062 6561 6d5f  y: float,  beam_
+00018890: 7479 7065 3a20 4265 616d 5479 7065 2920  type: BeamType) 
+000188a0: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
+000188b0: 2020 2020 2041 646a 7573 7473 2074 6865       Adjusts the
+000188c0: 2062 6561 6d20 7368 6966 7420 6f66 2067   beam shift of g
+000188d0: 6976 656e 2062 6561 6d20 6261 7365 6420  iven beam based 
+000188e0: 6f6e 2072 656c 6174 6976 6520 7661 6c75  on relative valu
+000188f0: 6573 2074 6861 7420 6172 6520 7072 6f76  es that are prov
+00018900: 6964 6564 2e0a 0a20 2020 2020 2020 2067  ided...        g
+00018910: 6574 5f73 7461 6765 5f70 6f73 6974 696f  et_stage_positio
+00018920: 6e28 7365 6c66 2920 2d3e 2046 6962 7365  n(self) -> Fibse
+00018930: 6d53 7461 6765 506f 7369 7469 6f6e 3a0a  mStagePosition:.
+00018940: 2020 2020 2020 2020 2020 2020 4765 7420              Get 
+00018950: 7468 6520 6375 7272 656e 7420 7374 6167  the current stag
+00018960: 6520 706f 7369 7469 6f6e 2e0a 0a20 2020  e position...   
+00018970: 2020 2020 2067 6574 5f63 7572 7265 6e74       get_current
+00018980: 5f6d 6963 726f 7363 6f70 655f 7374 6174  _microscope_stat
+00018990: 6528 7365 6c66 2920 2d3e 204d 6963 726f  e(self) -> Micro
+000189a0: 7363 6f70 6553 7461 7465 3a0a 2020 2020  scopeState:.    
+000189b0: 2020 2020 2020 2020 4765 7420 7468 6520          Get the 
+000189c0: 6375 7272 656e 7420 6d69 6372 6f73 636f  current microsco
+000189d0: 7065 2073 7461 7465 0a0a 2020 2020 2020  pe state..      
+000189e0: 2020 6d6f 7665 5f73 7461 6765 5f61 6273    move_stage_abs
+000189f0: 6f6c 7574 6528 7365 6c66 2c20 706f 7369  olute(self, posi
+00018a00: 7469 6f6e 3a20 4669 6273 656d 5374 6167  tion: FibsemStag
+00018a10: 6550 6f73 6974 696f 6e29 3a0a 2020 2020  ePosition):.    
+00018a20: 2020 2020 2020 2020 4d6f 7665 2074 6865          Move the
+00018a30: 2073 7461 6765 2074 6f20 7468 6520 7370   stage to the sp
+00018a40: 6563 6966 6965 6420 636f 6f72 6469 6e61  ecified coordina
+00018a50: 7465 732e 0a0a 2020 2020 2020 2020 6d6f  tes...        mo
+00018a60: 7665 5f73 7461 6765 5f72 656c 6174 6976  ve_stage_relativ
+00018a70: 6528 7365 6c66 2c20 706f 7369 7469 6f6e  e(self, position
+00018a80: 3a20 4669 6273 656d 5374 6167 6550 6f73  : FibsemStagePos
+00018a90: 6974 696f 6e29 3a0a 2020 2020 2020 2020  ition):.        
+00018aa0: 2020 2020 4d6f 7665 2074 6865 2073 7461      Move the sta
+00018ab0: 6765 2062 7920 7468 6520 7370 6563 6966  ge by the specif
+00018ac0: 6965 6420 7265 6c61 7469 7665 206d 6f76  ied relative mov
+00018ad0: 652e 0a0a 2020 2020 2020 2020 7374 6162  e...        stab
+00018ae0: 6c65 5f6d 6f76 6528 7365 6c66 2c20 7365  le_move(self, se
+00018af0: 7474 696e 6773 3a20 4d69 6372 6f73 636f  ttings: Microsco
+00018b00: 7065 5365 7474 696e 6773 2c20 6478 3a20  peSettings, dx: 
+00018b10: 666c 6f61 742c 2064 793a 2066 6c6f 6174  float, dy: float
+00018b20: 2c20 6265 616d 5f74 7970 653a 2042 6561  , beam_type: Bea
+00018b30: 6d54 7970 652c 2920 2d3e 204e 6f6e 653a  mType,) -> None:
+00018b40: 0a20 2020 2020 2020 2020 2020 2043 616c  .            Cal
+00018b50: 6375 6c61 7465 2074 6865 2063 6f72 7265  culate the corre
+00018b60: 6374 6564 2073 7461 6765 206d 6f76 656d  cted stage movem
+00018b70: 656e 7473 2062 6173 6564 206f 6e20 7468  ents based on th
+00018b80: 6520 6265 616d 5f74 7970 652c 2061 6e64  e beam_type, and
+00018b90: 2074 6865 6e20 6d6f 7665 2074 6865 2073   then move the s
+00018ba0: 7461 6765 2072 656c 6174 6976 656c 792e  tage relatively.
+00018bb0: 0a0a 2020 2020 2020 2020 6575 6365 6e74  ..        eucent
+00018bc0: 7269 635f 6d6f 7665 2873 656c 662c 2073  ric_move(self, s
+00018bd0: 6574 7469 6e67 733a 204d 6963 726f 7363  ettings: Microsc
+00018be0: 6f70 6553 6574 7469 6e67 732c 2064 793a  opeSettings, dy:
+00018bf0: 2066 6c6f 6174 2c20 7374 6174 6963 5f77   float, static_w
+00018c00: 643a 2062 6f6f 6c20 3d20 5472 7565 2920  d: bool = True) 
+00018c10: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
+00018c20: 2020 2020 204d 6f76 6520 7468 6520 7374       Move the st
+00018c30: 6167 6520 7665 7274 6963 616c 6c79 2074  age vertically t
+00018c40: 6f20 636f 7272 6563 7420 6575 6365 6e74  o correct eucent
+00018c50: 7269 6320 706f 696e 740a 2020 2020 2020  ric point.      
+00018c60: 2020 0a20 2020 2020 2020 206d 6f76 655f    .        move_
+00018c70: 666c 6174 5f74 6f5f 6265 616d 2873 656c  flat_to_beam(sel
+00018c80: 662c 2073 6574 7469 6e67 733a 204d 6963  f, settings: Mic
+00018c90: 726f 7363 6f70 6553 6574 7469 6e67 732c  roscopeSettings,
+00018ca0: 2062 6561 6d5f 7479 7065 3a20 4265 616d   beam_type: Beam
+00018cb0: 5479 7065 203d 2042 6561 6d54 7970 652e  Type = BeamType.
+00018cc0: 454c 4543 5452 4f4e 293a 0a20 2020 2020  ELECTRON):.     
+00018cd0: 2020 2020 2020 204d 616b 6520 7468 6520         Make the 
+00018ce0: 7361 6d70 6c65 2073 7572 6661 6365 2066  sample surface f
+00018cf0: 6c61 7420 746f 2074 6865 2065 6c65 6374  lat to the elect
+00018d00: 726f 6e20 6f72 2069 6f6e 2062 6561 6d2e  ron or ion beam.
+00018d10: 0a20 2020 2020 2020 2067 6574 5f6d 616e  .        get_man
+00018d20: 6970 756c 6174 6f72 5f70 6f73 6974 696f  ipulator_positio
+00018d30: 6e28 7365 6c66 2920 2d3e 2046 6962 7365  n(self) -> Fibse
+00018d40: 6d4d 616e 6970 756c 6174 6f72 506f 7369  mManipulatorPosi
+00018d50: 7469 6f6e 3a0a 2020 2020 2020 2020 2020  tion:.          
+00018d60: 2020 4765 7420 7468 6520 6375 7272 656e    Get the curren
+00018d70: 7420 6d61 6e69 7075 6c61 746f 7220 706f  t manipulator po
+00018d80: 7369 7469 6f6e 2e0a 2020 2020 2020 2020  sition..        
+00018d90: 0a20 2020 2020 2020 2069 6e73 6572 745f  .        insert_
+00018da0: 6d61 6e69 7075 6c61 746f 7228 7365 6c66  manipulator(self
+00018db0: 2c20 6e61 6d65 3a20 7374 7229 202d 3e20  , name: str) -> 
+00018dc0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+00018dd0: 2020 496e 7365 7274 2074 6865 206d 616e    Insert the man
+00018de0: 6970 756c 6174 6f72 2069 6e74 6f20 7468  ipulator into th
+00018df0: 6520 7361 6d70 6c65 2e0a 2020 2020 2020  e sample..      
+00018e00: 2020 0a20 2020 2020 2020 2072 6574 7261    .        retra
+00018e10: 6374 5f6d 616e 6970 756c 6174 6f72 2873  ct_manipulator(s
+00018e20: 656c 6629 202d 3e20 4e6f 6e65 3a0a 2020  elf) -> None:.  
+00018e30: 2020 2020 2020 2020 2020 5265 7472 6163            Retrac
+00018e40: 7420 7468 6520 6d61 6e69 7075 6c61 746f  t the manipulato
+00018e50: 7220 6672 6f6d 2074 6865 2073 616d 706c  r from the sampl
+00018e60: 652e 0a0a 2020 2020 2020 2020 6d6f 7665  e...        move
+00018e70: 5f6d 616e 6970 756c 6174 6f72 5f72 656c  _manipulator_rel
+00018e80: 6174 6976 6528 7365 6c66 2c20 706f 7369  ative(self, posi
+00018e90: 7469 6f6e 3a20 4669 6273 656d 4d61 6e69  tion: FibsemMani
+00018ea0: 7075 6c61 746f 7250 6f73 6974 696f 6e29  pulatorPosition)
+00018eb0: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
+00018ec0: 2020 2020 2020 4d6f 7665 2074 6865 206d        Move the m
+00018ed0: 616e 6970 756c 6174 6f72 2062 7920 7468  anipulator by th
+00018ee0: 6520 7370 6563 6966 6965 6420 7265 6c61  e specified rela
+00018ef0: 7469 7665 206d 6f76 652e 0a20 2020 2020  tive move..     
+00018f00: 2020 200a 2020 2020 2020 2020 6d6f 7665     .        move
+00018f10: 5f6d 616e 6970 756c 6174 6f72 5f61 6273  _manipulator_abs
+00018f20: 6f6c 7574 6528 7365 6c66 2c20 706f 7369  olute(self, posi
+00018f30: 7469 6f6e 3a20 4669 6273 656d 4d61 6e69  tion: FibsemMani
+00018f40: 7075 6c61 746f 7250 6f73 6974 696f 6e29  pulatorPosition)
+00018f50: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
+00018f60: 2020 2020 2020 4d6f 7665 2074 6865 206d        Move the m
+00018f70: 616e 6970 756c 6174 6f72 2074 6f20 7468  anipulator to th
+00018f80: 6520 7370 6563 6966 6965 6420 636f 6f72  e specified coor
+00018f90: 6469 6e61 7465 732e 0a0a 2020 2020 2020  dinates...      
+00018fa0: 2020 6d6f 7665 5f6d 616e 6970 756c 6174    move_manipulat
+00018fb0: 6f72 5f63 6f72 7265 6374 6564 2873 656c  or_corrected(sel
+00018fc0: 662c 2064 783a 2066 6c6f 6174 2c20 6479  f, dx: float, dy
+00018fd0: 3a20 666c 6f61 742c 2062 6561 6d5f 7479  : float, beam_ty
+00018fe0: 7065 3a20 4265 616d 5479 7065 2920 2d3e  pe: BeamType) ->
+00018ff0: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+00019000: 2020 204d 6f76 6520 7468 6520 6d61 6e69     Move the mani
+00019010: 7075 6c61 746f 7220 6279 2074 6865 2073  pulator by the s
+00019020: 7065 6369 6669 6564 2072 656c 6174 6976  pecified relativ
+00019030: 6520 6d6f 7665 2c20 636f 7272 6563 7469  e move, correcti
+00019040: 6e67 2066 6f72 2074 6865 2062 6561 6d20  ng for the beam 
+00019050: 7479 7065 2e20 2020 2020 200a 0a20 2020  type.      ..   
+00019060: 2020 2020 206d 6f76 655f 6d61 6e69 7075       move_manipu
+00019070: 6c61 746f 725f 746f 5f70 6f73 6974 696f  lator_to_positio
+00019080: 6e5f 6f66 6673 6574 2873 656c 662c 206f  n_offset(self, o
+00019090: 6666 7365 743a 2046 6962 7365 6d4d 616e  ffset: FibsemMan
+000190a0: 6970 756c 6174 6f72 506f 7369 7469 6f6e  ipulatorPosition
+000190b0: 2c20 6e61 6d65 3a20 7374 7229 202d 3e20  , name: str) -> 
+000190c0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+000190d0: 2020 4d6f 7665 2074 6865 206d 616e 6970    Move the manip
+000190e0: 756c 6174 6f72 2074 6f20 7468 6520 7370  ulator to the sp
+000190f0: 6563 6966 6965 6420 706f 7369 7469 6f6e  ecified position
+00019100: 206f 6666 7365 742e 0a0a 2020 2020 2020   offset...      
+00019110: 2020 5f67 6574 5f73 6176 6564 5f6d 616e    _get_saved_man
+00019120: 6970 756c 6174 6f72 5f70 6f73 6974 696f  ipulator_positio
+00019130: 6e28 7365 6c66 2c20 6e61 6d65 3a20 7374  n(self, name: st
+00019140: 7229 202d 3e20 4669 6273 656d 4d61 6e69  r) -> FibsemMani
+00019150: 7075 6c61 746f 7250 6f73 6974 696f 6e3a  pulatorPosition:
+00019160: 0a20 2020 2020 2020 2020 2020 2047 6574  .            Get
+00019170: 2074 6865 2073 6176 6564 206d 616e 6970   the saved manip
+00019180: 756c 6174 6f72 2070 6f73 6974 696f 6e20  ulator position 
+00019190: 7769 7468 2074 6865 2073 7065 6369 6669  with the specifi
+000191a0: 6564 206e 616d 652e 0a20 2020 2020 2020  ed name..       
+000191b0: 2073 6574 7570 5f6d 696c 6c69 6e67 2873   setup_milling(s
+000191c0: 656c 662c 206d 696c 6c5f 7365 7474 696e  elf, mill_settin
+000191d0: 6773 3a20 4669 6273 656d 4d69 6c6c 696e  gs: FibsemMillin
+000191e0: 6753 6574 7469 6e67 7329 3a0a 2020 2020  gSettings):.    
+000191f0: 2020 2020 2020 2020 436f 6e66 6967 7572          Configur
+00019200: 6520 7468 6520 6d69 6372 6f73 636f 7065  e the microscope
+00019210: 2066 6f72 206d 696c 6c69 6e67 2075 7369   for milling usi
+00019220: 6e67 2074 6865 2069 6f6e 2062 6561 6d2e  ng the ion beam.
+00019230: 0a0a 2020 2020 2020 2020 7275 6e5f 6d69  ..        run_mi
+00019240: 6c6c 696e 6728 7365 6c66 2c20 6d69 6c6c  lling(self, mill
+00019250: 696e 675f 6375 7272 656e 743a 2066 6c6f  ing_current: flo
+00019260: 6174 2c20 6173 796e 6368 3a20 626f 6f6c  at, asynch: bool
+00019270: 203d 2046 616c 7365 293a 0a20 2020 2020   = False):.     
+00019280: 2020 2020 2020 2052 756e 2069 6f6e 2062         Run ion b
+00019290: 6561 6d20 6d69 6c6c 696e 6720 7573 696e  eam milling usin
+000192a0: 6720 7468 6520 7370 6563 6966 6965 6420  g the specified 
+000192b0: 6d69 6c6c 696e 6720 6375 7272 656e 742e  milling current.
+000192c0: 0a0a 2020 2020 2020 2020 6465 6620 7275  ..        def ru
+000192d0: 6e5f 6d69 6c6c 696e 675f 6472 6966 745f  n_milling_drift_
+000192e0: 636f 7272 6563 7465 6428 7365 6c66 2c20  corrected(self, 
+000192f0: 6d69 6c6c 696e 675f 6375 7272 656e 743a  milling_current:
+00019300: 2066 6c6f 6174 2c20 696d 6167 655f 7365   float, image_se
+00019310: 7474 696e 6773 3a20 496d 6167 6553 6574  ttings: ImageSet
+00019320: 7469 6e67 732c 2072 6566 5f69 6d61 6765  tings, ref_image
+00019330: 3a20 4669 6273 656d 496d 6167 652c 2072  : FibsemImage, r
+00019340: 6564 7563 6564 5f61 7265 613a 2046 6962  educed_area: Fib
+00019350: 7365 6d52 6563 7461 6e67 6c65 203d 204e  semRectangle = N
+00019360: 6f6e 652c 2061 7379 6e63 683a 2062 6f6f  one, asynch: boo
+00019370: 6c20 3d20 4661 6c73 6529 3a0a 2020 2020  l = False):.    
+00019380: 2020 2020 5275 6e20 696f 6e20 6265 616d      Run ion beam
+00019390: 206d 696c 6c69 6e67 2075 7369 6e67 2074   milling using t
+000193a0: 6865 2073 7065 6369 6669 6564 206d 696c  he specified mil
+000193b0: 6c69 6e67 2063 7572 7265 6e74 2c20 616e  ling current, an
+000193c0: 6420 636f 7272 6563 7420 666f 7220 6472  d correct for dr
+000193d0: 6966 7420 7573 696e 6720 7468 6520 7072  ift using the pr
+000193e0: 6f76 6964 6564 2072 6566 6572 656e 6365  ovided reference
+000193f0: 2069 6d61 6765 2e0a 0a20 2020 2020 2020   image...       
+00019400: 2066 696e 6973 685f 6d69 6c6c 696e 6728   finish_milling(
+00019410: 7365 6c66 2c20 696d 6167 696e 675f 6375  self, imaging_cu
+00019420: 7272 656e 743a 2066 6c6f 6174 293a 0a20  rrent: float):. 
+00019430: 2020 2020 2020 2020 2020 2046 696e 616c             Final
+00019440: 6973 6573 2074 6865 206d 696c 6c69 6e67  ises the milling
+00019450: 2070 726f 6365 7373 2062 7920 636c 6561   process by clea
+00019460: 7269 6e67 2074 6865 206d 6963 726f 7363  ring the microsc
+00019470: 6f70 6520 6f66 2061 6e79 2070 6174 7465  ope of any patte
+00019480: 726e 7320 616e 6420 7265 7475 726e 696e  rns and returnin
+00019490: 6720 7468 6520 6375 7272 656e 7420 746f  g the current to
+000194a0: 2074 6865 2069 6d61 6769 6e67 2063 7572   the imaging cur
+000194b0: 7265 6e74 2e0a 0a20 2020 2020 2020 2064  rent...        d
+000194c0: 7261 775f 7265 6374 616e 676c 6528 7365  raw_rectangle(se
+000194d0: 6c66 2c20 7061 7474 6572 6e5f 7365 7474  lf, pattern_sett
+000194e0: 696e 6773 3a20 4669 6273 656d 5061 7474  ings: FibsemPatt
+000194f0: 6572 6e53 6574 7469 6e67 7329 3a0a 2020  ernSettings):.  
+00019500: 2020 2020 2020 2020 2020 4472 6177 7320            Draws 
+00019510: 6120 7265 6374 616e 676c 6520 7061 7474  a rectangle patt
+00019520: 6572 6e20 7573 696e 6720 7468 6520 6375  ern using the cu
+00019530: 7272 656e 7420 696f 6e20 6265 616d 2e0a  rrent ion beam..
+00019540: 0a20 2020 2020 2020 2064 7261 775f 6c69  .        draw_li
+00019550: 6e65 2873 656c 662c 2070 6174 7465 726e  ne(self, pattern
+00019560: 5f73 6574 7469 6e67 733a 2046 6962 7365  _settings: Fibse
+00019570: 6d50 6174 7465 726e 5365 7474 696e 6773  mPatternSettings
+00019580: 293a 0a20 2020 2020 2020 2020 2020 2044  ):.            D
+00019590: 7261 7773 2061 206c 696e 6520 7061 7474  raws a line patt
+000195a0: 6572 6e20 6f6e 2074 6865 2063 7572 7265  ern on the curre
+000195b0: 6e74 2069 6d61 6769 6e67 2076 6965 7720  nt imaging view 
+000195c0: 6f66 2074 6865 206d 6963 726f 7363 6f70  of the microscop
+000195d0: 652e 0a20 2020 2020 2020 200a 2020 2020  e..        .    
+000195e0: 2020 2020 6472 6177 5f63 6972 636c 6528      draw_circle(
+000195f0: 7365 6c66 2c20 7061 7474 6572 6e5f 7365  self, pattern_se
+00019600: 7474 696e 6773 3a20 4669 6273 656d 5061  ttings: FibsemPa
+00019610: 7474 6572 6e53 6574 7469 6e67 7329 3a0a  tternSettings):.
+00019620: 2020 2020 2020 2020 2020 2020 4472 6177              Draw
+00019630: 7320 6120 6369 7263 756c 6172 2070 6174  s a circular pat
+00019640: 7465 726e 206f 6e20 7468 6520 6375 7272  tern on the curr
+00019650: 656e 7420 696d 6167 696e 6720 7669 6577  ent imaging view
+00019660: 206f 6620 7468 6520 6d69 6372 6f73 636f   of the microsco
+00019670: 7065 2e0a 0a20 2020 2020 2020 2067 6574  pe...        get
+00019680: 5f73 6361 6e5f 6469 7265 6374 696f 6e73  _scan_directions
+00019690: 2873 656c 6629 202d 3e20 6c69 7374 3a0a  (self) -> list:.
+000196a0: 2020 2020 2020 2020 2020 2020 4765 7420              Get 
+000196b0: 7468 6520 6176 6169 6c61 626c 6520 7363  the available sc
+000196c0: 616e 2064 6972 6563 7469 6f6e 7320 666f  an directions fo
+000196d0: 7220 6d69 6c6c 696e 672e 2020 2020 0a0a  r milling.    ..
+000196e0: 2020 2020 2020 2020 7365 7475 705f 7370          setup_sp
+000196f0: 7574 7465 7228 7365 6c66 2c20 7072 6f74  utter(self, prot
+00019700: 6f63 6f6c 3a20 6469 6374 293a 0a20 2020  ocol: dict):.   
+00019710: 2020 2020 2020 2020 2053 6574 2075 7020           Set up 
+00019720: 7468 6520 7370 7574 7465 7220 636f 6174  the sputter coat
+00019730: 696e 6720 7072 6f63 6573 7320 6f6e 2074  ing process on t
+00019740: 6865 206d 6963 726f 7363 6f70 652e 0a0a  he microscope...
+00019750: 2020 2020 2020 2020 6472 6177 5f73 7075          draw_spu
+00019760: 7474 6572 5f70 6174 7465 726e 2873 656c  tter_pattern(sel
+00019770: 662c 2068 6677 3a20 666c 6f61 742c 206c  f, hfw: float, l
+00019780: 696e 655f 7061 7474 6572 6e5f 6c65 6e67  ine_pattern_leng
+00019790: 7468 3a20 666c 6f61 742c 2073 7075 7474  th: float, sputt
+000197a0: 6572 5f74 696d 653a 2066 6c6f 6174 293a  er_time: float):
+000197b0: 0a20 2020 2020 2020 2020 2020 2044 7261  .            Dra
+000197c0: 7773 2061 206c 696e 6520 7061 7474 6572  ws a line patter
+000197d0: 6e20 666f 7220 7370 7574 7465 7269 6e67  n for sputtering
+000197e0: 2077 6974 6820 7468 6520 6769 7665 6e20   with the given 
+000197f0: 7061 7261 6d65 7465 7273 2e0a 0a20 2020  parameters...   
+00019800: 2020 2020 2072 756e 5f73 7075 7474 6572       run_sputter
+00019810: 2873 656c 662c 202a 2a6b 7761 7267 7329  (self, **kwargs)
+00019820: 3a0a 2020 2020 2020 2020 2020 2020 5275  :.            Ru
+00019830: 6e73 2074 6865 2047 4953 2050 6c61 7469  ns the GIS Plati
+00019840: 6e75 6d20 5370 7574 7465 722e 0a0a 2020  num Sputter...  
+00019850: 2020 2020 2020 6669 6e69 7368 5f73 7075        finish_spu
+00019860: 7474 6572 2873 656c 662c 2061 7070 6c69  tter(self, appli
+00019870: 6361 7469 6f6e 5f66 696c 653a 2073 7472  cation_file: str
+00019880: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
+00019890: 2020 2020 2020 2046 696e 6973 6820 7468         Finish th
+000198a0: 6520 7370 7574 7465 7220 7072 6f63 6573  e sputter proces
+000198b0: 7320 6279 2063 6c65 6172 696e 6720 7061  s by clearing pa
+000198c0: 7474 6572 6e73 2061 6e64 2072 6573 6574  tterns and reset
+000198d0: 7469 6e67 2062 6561 6d20 616e 6420 696d  ting beam and im
+000198e0: 6167 696e 6720 7365 7474 696e 6773 2e0a  aging settings..
+000198f0: 0a20 2020 2020 2020 2073 6574 5f6d 6963  .        set_mic
+00019900: 726f 7363 6f70 655f 7374 6174 6528 7365  roscope_state(se
+00019910: 6c66 2c20 6d69 6372 6f73 636f 7065 5f73  lf, microscope_s
+00019920: 7461 7465 3a20 4d69 6372 6f73 636f 7065  tate: Microscope
+00019930: 5374 6174 6529 202d 3e20 4e6f 6e65 3a0a  State) -> None:.
+00019940: 2020 2020 2020 2020 2020 2020 5265 7365              Rese
+00019950: 7420 7468 6520 6d69 6372 6f73 636f 7065  t the microscope
+00019960: 2073 7461 7465 2074 6f20 7468 6520 7072   state to the pr
+00019970: 6f76 6964 6564 2073 7461 7465 2e0a 2020  ovided state..  
+00019980: 2020 2020 2020 0a20 2020 2020 2020 2067        .        g
+00019990: 6574 2873 656c 662c 206b 6579 3a73 7472  et(self, key:str
+000199a0: 2c20 6265 616d 5f74 7970 653a 2042 6561  , beam_type: Bea
+000199b0: 6d54 7970 6520 3d20 4e6f 6e65 293a 0a20  mType = None):. 
+000199c0: 2020 2020 2020 2020 2020 2052 6574 7572             Retur
+000199d0: 6e73 2074 6865 2076 616c 7565 206f 6620  ns the value of 
+000199e0: 7468 6520 7370 6563 6966 6965 6420 6b65  the specified ke
+000199f0: 792e 0a0a 2020 2020 2020 2020 7365 7428  y...        set(
+00019a00: 7365 6c66 2c20 6b65 793a 2073 7472 2c20  self, key: str, 
+00019a10: 7661 6c75 652c 2062 6561 6d5f 7479 7065  value, beam_type
+00019a20: 3a20 4265 616d 5479 7065 203d 204e 6f6e  : BeamType = Non
+00019a30: 6529 202d 3e20 4e6f 6e65 3a0a 2020 2020  e) -> None:.    
+00019a40: 2020 2020 2020 2020 5365 7473 2074 6865          Sets the
+00019a50: 2076 616c 7565 206f 6620 7468 6520 7370   value of the sp
+00019a60: 6563 6966 6965 6420 6b65 792e 0a0a 2020  ecified key...  
+00019a70: 2020 4e65 7720 6d65 7468 6f64 733a 0a20    New methods:. 
+00019a80: 2020 2020 2020 205f 5f69 6e69 745f 5f28         __init__(
+00019a90: 7365 6c66 293a 200a 2020 2020 2020 2020  self): .        
+00019aa0: 2020 2020 496e 6974 6961 6c69 7a65 7320      Initializes 
+00019ab0: 6120 6e65 7720 696e 7374 616e 6365 206f  a new instance o
+00019ac0: 6620 7468 6520 636c 6173 732e 0a0a 2020  f the class...  
+00019ad0: 2020 2020 2020 5f67 6574 5f65 625f 696d        _get_eb_im
+00019ae0: 6167 6528 7365 6c66 2c20 696d 6167 655f  age(self, image_
+00019af0: 7365 7474 696e 6773 3d49 6d61 6765 5365  settings=ImageSe
+00019b00: 7474 696e 6773 2920 2d3e 2046 6962 7365  ttings) -> Fibse
+00019b10: 6d49 6d61 6765 3a0a 2020 2020 2020 2020  mImage:.        
+00019b20: 2020 2020 4163 7175 6972 6573 2061 6e20      Acquires an 
+00019b30: 656c 6563 7472 6f6e 2062 6561 6d20 2845  electron beam (E
+00019b40: 4229 2069 6d61 6765 2077 6974 6820 7468  B) image with th
+00019b50: 6520 6769 7665 6e20 7365 7474 696e 6773  e given settings
+00019b60: 2061 6e64 2072 6574 7572 6e73 2061 2046   and returns a F
+00019b70: 6962 7365 6d49 6d61 6765 206f 626a 6563  ibsemImage objec
+00019b80: 742e 0a0a 2020 2020 2020 2020 5f67 6574  t...        _get
+00019b90: 5f69 625f 696d 6167 6528 7365 6c66 2c20  _ib_image(self, 
+00019ba0: 696d 6167 655f 7365 7474 696e 6773 3d49  image_settings=I
+00019bb0: 6d61 6765 5365 7474 696e 6773 293a 0a20  mageSettings):. 
+00019bc0: 2020 2020 2020 2020 2020 2041 6371 7569             Acqui
+00019bd0: 7265 7320 616e 2069 6f6e 2062 6561 6d20  res an ion beam 
+00019be0: 2849 4229 2069 6d61 6765 2077 6974 6820  (IB) image with 
+00019bf0: 7468 6520 6769 7665 6e20 7365 7474 696e  the given settin
+00019c00: 6773 2061 6e64 2072 6574 7572 6e73 2061  gs and returns a
+00019c10: 2046 6962 7365 6d49 6d61 6765 206f 626a   FibsemImage obj
+00019c20: 6563 742e 0a0a 2020 2020 2020 2020 5f79  ect...        _y
+00019c30: 5f63 6f72 7265 6374 6564 5f73 7461 6765  _corrected_stage
+00019c40: 5f6d 6f76 656d 656e 7428 7365 6c66 2c20  _movement(self, 
+00019c50: 7365 7474 696e 6773 3a20 4d69 6372 6f73  settings: Micros
+00019c60: 636f 7065 5365 7474 696e 6773 2c20 6578  copeSettings, ex
+00019c70: 7065 6374 6564 5f79 3a20 666c 6f61 742c  pected_y: float,
+00019c80: 2062 6561 6d5f 7479 7065 3a20 4265 616d   beam_type: Beam
+00019c90: 5479 7065 203d 2042 6561 6d54 7970 652e  Type = BeamType.
+00019ca0: 454c 4543 5452 4f4e 2920 2d3e 2046 6962  ELECTRON) -> Fib
+00019cb0: 7365 6d53 7461 6765 506f 7369 7469 6f6e  semStagePosition
+00019cc0: 3a0a 2020 2020 2020 2020 2020 2020 4361  :.            Ca
+00019cd0: 6c63 756c 6174 6520 7468 6520 7920 636f  lculate the y co
+00019ce0: 7272 6563 7465 6420 7374 6167 6520 6d6f  rrected stage mo
+00019cf0: 7665 6d65 6e74 2c20 636f 7272 6563 7465  vement, correcte
+00019d00: 6420 666f 7220 7468 6520 6164 6469 7469  d for the additi
+00019d10: 6f6e 616c 2074 696c 7420 6f66 2074 6865  onal tilt of the
+00019d20: 2073 616d 706c 6520 686f 6c64 6572 2028   sample holder (
+00019d30: 7072 652d 7469 6c74 2061 6e67 6c65 292e  pre-tilt angle).
+00019d40: 0a20 2020 2022 2222 0a0a 2020 2020 6465  .    """..    de
+00019d50: 6620 5f5f 696e 6974 5f5f 2873 656c 662c  f __init__(self,
+00019d60: 2069 705f 6164 6472 6573 733a 2073 7472   ip_address: str
+00019d70: 203d 2022 6c6f 6361 6c68 6f73 7422 2c20   = "localhost", 
+00019d80: 6861 7264 7761 7265 5f73 6574 7469 6e67  hardware_setting
+00019d90: 733a 2046 6962 7365 6d48 6172 6477 6172  s: FibsemHardwar
+00019da0: 6520 3d20 4e6f 6e65 2c20 7374 6167 655f  e = None, stage_
+00019db0: 7365 7474 696e 6773 3a20 5374 6167 6553  settings: StageS
+00019dc0: 6574 7469 6e67 7320 3d20 4e6f 6e65 293a  ettings = None):
+00019dd0: 0a20 2020 2020 2020 2073 656c 662e 636f  .        self.co
+00019de0: 6e6e 6563 7469 6f6e 203d 2041 7574 6f6d  nnection = Autom
+00019df0: 6174 696f 6e28 6970 5f61 6464 7265 7373  ation(ip_address
+00019e00: 290a 2020 2020 2020 2020 6465 7465 6374  ).        detect
+00019e10: 6f72 7320 3d20 7365 6c66 2e63 6f6e 6e65  ors = self.conne
+00019e20: 6374 696f 6e2e 4649 422e 4465 7465 6374  ction.FIB.Detect
+00019e30: 6f72 2e45 6e75 6d28 290a 2020 2020 2020  or.Enum().      
+00019e40: 2020 7365 6c66 2e69 6f6e 5f64 6574 6563    self.ion_detec
+00019e50: 746f 725f 6163 7469 7665 203d 2064 6574  tor_active = det
+00019e60: 6563 746f 7273 5b30 5d0a 2020 2020 2020  ectors[0].      
+00019e70: 2020 7365 6c66 2e63 6f6e 6e65 6374 696f    self.connectio
+00019e80: 6e2e 4649 422e 4465 7465 6374 6f72 2e53  n.FIB.Detector.S
+00019e90: 6574 2843 6861 6e6e 656c 203d 2030 2c20  et(Channel = 0, 
+00019ea0: 4465 7465 6374 6f72 3d20 7365 6c66 2e69  Detector= self.i
+00019eb0: 6f6e 5f64 6574 6563 746f 725f 6163 7469  on_detector_acti
+00019ec0: 7665 290a 2020 2020 2020 2020 7365 6c66  ve).        self
+00019ed0: 2e65 6c65 6374 726f 6e5f 6465 7465 6374  .electron_detect
+00019ee0: 6f72 5f61 6374 6976 6520 3d20 7365 6c66  or_active = self
+00019ef0: 2e63 6f6e 6e65 6374 696f 6e2e 5345 4d2e  .connection.SEM.
+00019f00: 4465 7465 6374 6f72 2e53 4553 7569 7461  Detector.SESuita
+00019f10: 626c 6528 290a 2020 2020 2020 2020 7365  ble().        se
+00019f20: 6c66 2e63 6f6e 6e65 6374 696f 6e2e 5345  lf.connection.SE
+00019f30: 4d2e 4465 7465 6374 6f72 2e53 6574 2843  M.Detector.Set(C
+00019f40: 6861 6e6e 656c 203d 2030 2c20 4465 7465  hannel = 0, Dete
+00019f50: 6374 6f72 203d 2073 656c 662e 656c 6563  ctor = self.elec
+00019f60: 7472 6f6e 5f64 6574 6563 746f 725f 6163  tron_detector_ac
+00019f70: 7469 7665 290a 0a20 2020 2020 2020 2073  tive)..        s
+00019f80: 656c 662e 6c61 7374 5f69 6d61 6765 5f65  elf.last_image_e
+00019f90: 6220 3d20 4e6f 6e65 0a20 2020 2020 2020  b = None.       
+00019fa0: 2073 656c 662e 6c61 7374 5f69 6d61 6765   self.last_image
+00019fb0: 5f69 6220 3d20 4e6f 6e65 0a0a 2020 2020  _ib = None..    
+00019fc0: 2020 2020 696d 706f 7274 2066 6962 7365      import fibse
+00019fd0: 6d2e 636f 6e66 6967 2061 7320 6366 670a  m.config as cfg.
+00019fe0: 2020 2020 2020 2020 6672 6f6d 2066 6962          from fib
+00019ff0: 7365 6d2e 7574 696c 7320 696d 706f 7274  sem.utils import
+0001a000: 206c 6f61 645f 7072 6f74 6f63 6f6c 0a20   load_protocol. 
+0001a010: 2020 2020 2020 2069 6620 6861 7264 7761         if hardwa
+0001a020: 7265 5f73 6574 7469 6e67 7320 6973 204e  re_settings is N
+0001a030: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+0001a040: 2064 6963 745f 7379 7374 656d 203d 206c   dict_system = l
+0001a050: 6f61 645f 7072 6f74 6f63 6f6c 286f 732e  oad_protocol(os.
+0001a060: 7061 7468 2e6a 6f69 6e28 6366 672e 434f  path.join(cfg.CO
+0001a070: 4e46 4947 5f50 4154 482c 2022 7379 7374  NFIG_PATH, "syst
+0001a080: 656d 2e79 616d 6c22 2929 0a20 2020 2020  em.yaml")).     
+0001a090: 2020 2020 2020 2073 656c 662e 6861 7264         self.hard
+0001a0a0: 7761 7265 5f73 6574 7469 6e67 7320 3d20  ware_settings = 
+0001a0b0: 4669 6273 656d 4861 7264 7761 7265 2e5f  FibsemHardware._
+0001a0c0: 5f66 726f 6d5f 6469 6374 5f5f 2864 6963  _from_dict__(dic
+0001a0d0: 745f 7379 7374 656d 5b22 6d6f 6465 6c22  t_system["model"
+0001a0e0: 5d29 0a20 2020 2020 2020 2065 6c73 653a  ]).        else:
+0001a0f0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+0001a100: 662e 6861 7264 7761 7265 5f73 6574 7469  f.hardware_setti
+0001a110: 6e67 7320 3d20 6861 7264 7761 7265 5f73  ngs = hardware_s
+0001a120: 6574 7469 6e67 730a 2020 2020 2020 2020  ettings.        
+0001a130: 6966 2073 7461 6765 5f73 6574 7469 6e67  if stage_setting
+0001a140: 7320 6973 204e 6f6e 653a 0a20 2020 2020  s is None:.     
+0001a150: 2020 2020 2020 2064 6963 745f 7374 6167         dict_stag
+0001a160: 6520 3d20 6c6f 6164 5f70 726f 746f 636f  e = load_protoco
+0001a170: 6c28 6f73 2e70 6174 682e 6a6f 696e 2863  l(os.path.join(c
+0001a180: 6667 2e43 4f4e 4649 475f 5041 5448 2c20  fg.CONFIG_PATH, 
+0001a190: 2273 7973 7465 6d2e 7961 6d6c 2229 290a  "system.yaml")).
+0001a1a0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0001a1b0: 2e73 7461 6765 5f73 6574 7469 6e67 7320  .stage_settings 
+0001a1c0: 3d20 5374 6167 6553 6574 7469 6e67 732e  = StageSettings.
+0001a1d0: 5f5f 6672 6f6d 5f64 6963 745f 5f28 6469  __from_dict__(di
+0001a1e0: 6374 5f73 7461 6765 5b22 7379 7374 656d  ct_stage["system
+0001a1f0: 225d 5b22 7374 6167 6522 5d29 0a20 2020  "]["stage"]).   
+0001a200: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+0001a210: 2020 2020 2020 2073 656c 662e 7374 6167         self.stag
+0001a220: 655f 7365 7474 696e 6773 203d 2073 7461  e_settings = sta
+0001a230: 6765 5f73 6574 7469 6e67 730a 0a20 2020  ge_settings..   
+0001a240: 2064 6566 2064 6973 636f 6e6e 6563 7428   def disconnect(
+0001a250: 7365 6c66 293a 0a20 2020 2020 2020 2073  self):.        s
+0001a260: 656c 662e 636f 6e6e 6563 7469 6f6e 2e44  elf.connection.D
+0001a270: 6973 636f 6e6e 6563 7428 290a 2020 2020  isconnect().    
+0001a280: 2020 2020 6465 6c20 7365 6c66 2e63 6f6e      del self.con
+0001a290: 6e65 6374 696f 6e0a 2020 2020 2020 2020  nection.        
+0001a2a0: 7365 6c66 2e63 6f6e 6e65 6374 696f 6e20  self.connection 
+0001a2b0: 3d20 4e6f 6e65 0a0a 2020 2020 2320 4063  = None..    # @c
+0001a2c0: 6c61 7373 6d65 7468 6f64 0a20 2020 2064  lassmethod.    d
+0001a2d0: 6566 2063 6f6e 6e65 6374 5f74 6f5f 6d69  ef connect_to_mi
+0001a2e0: 6372 6f73 636f 7065 2873 656c 662c 2069  croscope(self, i
+0001a2f0: 705f 6164 6472 6573 733a 2073 7472 2c20  p_address: str, 
+0001a300: 706f 7274 3a20 696e 7420 3d20 3833 3030  port: int = 8300
+0001a310: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
+0001a320: 2020 2022 2222 0a20 2020 2020 2020 2020     """.         
+0001a330: 2020 2043 6f6e 6e65 6374 7320 746f 2061     Connects to a
+0001a340: 206d 6963 726f 7363 6f70 6520 7769 7468   microscope with
+0001a350: 2074 6865 2073 7065 6369 6669 6564 2049   the specified I
+0001a360: 5020 6164 6472 6573 7320 616e 6420 706f  P address and po
+0001a370: 7274 2e0a 0a20 2020 2020 2020 2020 2020  rt...           
+0001a380: 2041 7267 733a 0a20 2020 2020 2020 2020   Args:.         
+0001a390: 2020 2020 2020 2069 705f 6164 6472 6573         ip_addres
+0001a3a0: 733a 2041 2073 7472 696e 6720 7468 6174  s: A string that
+0001a3b0: 2072 6570 7265 7365 6e74 7320 7468 6520   represents the 
+0001a3c0: 4950 2061 6464 7265 7373 206f 6620 7468  IP address of th
+0001a3d0: 6520 6d69 6372 6f73 636f 7065 2e0a 2020  e microscope..  
+0001a3e0: 2020 2020 2020 2020 2020 2020 2020 706f                po
+0001a3f0: 7274 3a20 416e 2069 6e74 6567 6572 2074  rt: An integer t
+0001a400: 6861 7420 7265 7072 6573 656e 7473 2074  hat represents t
+0001a410: 6865 2070 6f72 7420 6e75 6d62 6572 2074  he port number t
+0001a420: 6f20 7573 6520 2864 6566 6175 6c74 2038  o use (default 8
+0001a430: 3330 3029 2e0a 0a20 2020 2020 2020 2020  300)...         
+0001a440: 2020 2052 6574 7572 6e73 3a0a 2020 2020     Returns:.    
+0001a450: 2020 2020 2020 2020 2020 2020 4e6f 6e65              None
+0001a460: 2e0a 2020 2020 2020 2020 2222 220a 2020  ..        """.  
+0001a470: 2020 2020 2020 6c6f 6767 696e 672e 696e        logging.in
+0001a480: 666f 2866 224d 6963 726f 7363 6f70 6520  fo(f"Microscope 
+0001a490: 636c 6965 6e74 2063 6f6e 6e65 6374 696e  client connectin
+0001a4a0: 6720 746f 205b 7b69 705f 6164 6472 6573  g to [{ip_addres
+0001a4b0: 737d 3a7b 706f 7274 7d5d 2229 0a20 2020  s}:{port}]").   
+0001a4c0: 2020 2020 2073 656c 662e 636f 6e6e 6563       self.connec
+0001a4d0: 7469 6f6e 203d 2041 7574 6f6d 6174 696f  tion = Automatio
+0001a4e0: 6e28 6970 5f61 6464 7265 7373 2c20 706f  n(ip_address, po
+0001a4f0: 7274 290a 2020 2020 2020 2020 6c6f 6767  rt).        logg
+0001a500: 696e 672e 696e 666f 2866 224d 6963 726f  ing.info(f"Micro
+0001a510: 7363 6f70 6520 636c 6965 6e74 2063 6f6e  scope client con
+0001a520: 6e65 6374 6564 2074 6f20 5b7b 6970 5f61  nected to [{ip_a
+0001a530: 6464 7265 7373 7d3a 7b70 6f72 747d 5d22  ddress}:{port}]"
+0001a540: 290a 2020 2020 2020 2020 7365 6c66 2e63  ).        self.c
+0001a550: 6f6e 6e65 6374 696f 6e2e 5345 4d2e 4465  onnection.SEM.De
+0001a560: 7465 6374 6f72 2e53 6574 2830 2c20 7365  tector.Set(0, se
+0001a570: 6c66 2e65 6c65 6374 726f 6e5f 6465 7465  lf.electron_dete
+0001a580: 6374 6f72 5f61 6374 6976 652c 2042 7070  ctor_active, Bpp
+0001a590: 2e47 7261 7973 6361 6c65 5f38 5f62 6974  .Grayscale_8_bit
+0001a5a0: 290a 2020 2020 2020 2020 696d 6167 6520  ).        image 
+0001a5b0: 3d20 7365 6c66 2e63 6f6e 6e65 6374 696f  = self.connectio
+0001a5c0: 6e2e 5345 4d2e 5363 616e 2e41 6371 7569  n.SEM.Scan.Acqui
+0001a5d0: 7265 496d 6167 6546 726f 6d43 6861 6e6e  reImageFromChann
+0001a5e0: 656c 2830 2c20 312c 2031 2c20 3130 3029  el(0, 1, 1, 100)
+0001a5f0: 0a20 2020 2020 2020 2073 656c 662e 7365  .        self.se
+0001a600: 7269 616c 5f6e 756d 6265 7220 3d20 696d  rial_number = im
+0001a610: 6167 652e 4865 6164 6572 5b22 4d41 494e  age.Header["MAIN
+0001a620: 225d 5b22 5365 7269 616c 4e75 6d62 6572  "]["SerialNumber
+0001a630: 225d 0a20 2020 2020 2020 2073 656c 662e  "].        self.
+0001a640: 6d6f 6465 6c20 3d20 696d 6167 652e 4865  model = image.He
+0001a650: 6164 6572 5b22 4d41 494e 225d 5b22 4465  ader["MAIN"]["De
+0001a660: 7669 6365 4d6f 6465 6c22 5d0a 2020 2020  viceModel"].    
+0001a670: 2020 2020 7365 6c66 2e73 6f66 7477 6172      self.softwar
+0001a680: 655f 7665 7273 696f 6e20 3d20 696d 6167  e_version = imag
+0001a690: 652e 4865 6164 6572 5b22 4d41 494e 225d  e.Header["MAIN"]
+0001a6a0: 5b22 536f 6674 7761 7265 5665 7273 696f  ["SoftwareVersio
+0001a6b0: 6e22 5d0a 2020 2020 2020 2020 6c6f 6767  n"].        logg
+0001a6c0: 696e 672e 696e 666f 2866 224d 6963 726f  ing.info(f"Micro
+0001a6d0: 7363 6f70 6520 636c 6965 6e74 2063 6f6e  scope client con
+0001a6e0: 6e65 6374 6564 2074 6f20 6d6f 6465 6c20  nected to model 
+0001a6f0: 7b73 656c 662e 6d6f 6465 6c7d 2077 6974  {self.model} wit
+0001a700: 6820 7365 7269 616c 206e 756d 6265 7220  h serial number 
+0001a710: 7b73 656c 662e 7365 7269 616c 5f6e 756d  {self.serial_num
+0001a720: 6265 727d 2061 6e64 2073 6f66 7477 6172  ber} and softwar
+0001a730: 6520 7665 7273 696f 6e20 7b73 656c 662e  e version {self.
+0001a740: 736f 6674 7761 7265 5f76 6572 7369 6f6e  software_version
+0001a750: 7d2e 2229 0a0a 2020 2020 6465 6620 6163  }.")..    def ac
+0001a760: 7175 6972 655f 696d 6167 6528 7365 6c66  quire_image(self
+0001a770: 2c20 696d 6167 655f 7365 7474 696e 6773  , image_settings
+0001a780: 3d49 6d61 6765 5365 7474 696e 6773 2920  =ImageSettings) 
+0001a790: 2d3e 2046 6962 7365 6d49 6d61 6765 3a0a  -> FibsemImage:.
+0001a7a0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+0001a7b0: 2020 2020 2020 2020 4163 7175 6972 6573          Acquires
+0001a7c0: 2061 6e20 696d 6167 6520 7573 696e 6720   an image using 
+0001a7d0: 7468 6520 7370 6563 6966 6965 6420 696d  the specified im
+0001a7e0: 6167 6520 7365 7474 696e 6773 2e0a 0a20  age settings... 
+0001a7f0: 2020 2020 2020 2020 2020 2041 7267 733a             Args:
+0001a800: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001a810: 2069 6d61 6765 5f73 6574 7469 6e67 733a   image_settings:
+0001a820: 2041 6e20 696e 7374 616e 6365 206f 6620   An instance of 
+0001a830: 7468 6520 6049 6d61 6765 5365 7474 696e  the `ImageSettin
+0001a840: 6773 6020 636c 6173 7320 7468 6174 2072  gs` class that r
+0001a850: 6570 7265 7365 6e74 7320 7468 6520 696d  epresents the im
+0001a860: 6167 6520 7365 7474 696e 6773 2074 6f20  age settings to 
+0001a870: 7573 6520 2864 6566 6175 6c74 2060 496d  use (default `Im
+0001a880: 6167 6553 6574 7469 6e67 7360 292e 0a0a  ageSettings`)...
+0001a890: 2020 2020 2020 2020 2020 2020 5265 7475              Retu
+0001a8a0: 726e 733a 0a20 2020 2020 2020 2020 2020  rns:.           
+0001a8b0: 2020 2020 2041 2060 4669 6273 656d 496d       A `FibsemIm
+0001a8c0: 6167 6560 206f 626a 6563 7420 7468 6174  age` object that
+0001a8d0: 2072 6570 7265 7365 6e74 7320 7468 6520   represents the 
+0001a8e0: 6163 7175 6972 6564 2069 6d61 6765 2e0a  acquired image..
+0001a8f0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+0001a900: 2020 2020 6c6f 6767 696e 672e 696e 666f      logging.info
+0001a910: 2866 2261 6371 7569 7269 6e67 206e 6577  (f"acquiring new
+0001a920: 207b 696d 6167 655f 7365 7474 696e 6773   {image_settings
+0001a930: 2e62 6561 6d5f 7479 7065 2e6e 616d 657d  .beam_type.name}
+0001a940: 2069 6d61 6765 2e22 290a 2020 2020 2020   image.").      
+0001a950: 2020 6966 2069 6d61 6765 5f73 6574 7469    if image_setti
+0001a960: 6e67 732e 6265 616d 5f74 7970 652e 6e61  ngs.beam_type.na
+0001a970: 6d65 203d 3d20 2245 4c45 4354 524f 4e22  me == "ELECTRON"
+0001a980: 3a0a 2020 2020 2020 2020 2020 2020 5f63  :.            _c
+0001a990: 6865 636b 5f62 6561 6d28 4265 616d 5479  heck_beam(BeamTy
+0001a9a0: 7065 2e45 4c45 4354 524f 4e2c 2073 656c  pe.ELECTRON, sel
+0001a9b0: 662e 6861 7264 7761 7265 5f73 6574 7469  f.hardware_setti
+0001a9c0: 6e67 7329 0a20 2020 2020 2020 2020 2020  ngs).           
+0001a9d0: 2069 6d61 6765 203d 2073 656c 662e 5f67   image = self._g
+0001a9e0: 6574 5f65 625f 696d 6167 6528 696d 6167  et_eb_image(imag
+0001a9f0: 655f 7365 7474 696e 6773 290a 2020 2020  e_settings).    
+0001aa00: 2020 2020 2020 2020 7365 6c66 2e6c 6173          self.las
+0001aa10: 745f 696d 6167 655f 6562 203d 2069 6d61  t_image_eb = ima
+0001aa20: 6765 0a20 2020 2020 2020 2069 6620 696d  ge.        if im
+0001aa30: 6167 655f 7365 7474 696e 6773 2e62 6561  age_settings.bea
+0001aa40: 6d5f 7479 7065 2e6e 616d 6520 3d3d 2022  m_type.name == "
+0001aa50: 494f 4e22 3a0a 2020 2020 2020 2020 2020  ION":.          
+0001aa60: 2020 5f63 6865 636b 5f62 6561 6d28 4265    _check_beam(Be
+0001aa70: 616d 5479 7065 2e49 4f4e 2c20 7365 6c66  amType.ION, self
+0001aa80: 2e68 6172 6477 6172 655f 7365 7474 696e  .hardware_settin
+0001aa90: 6773 290a 2020 2020 2020 2020 2020 2020  gs).            
+0001aaa0: 696d 6167 6520 3d20 7365 6c66 2e5f 6765  image = self._ge
+0001aab0: 745f 6962 5f69 6d61 6765 2869 6d61 6765  t_ib_image(image
+0001aac0: 5f73 6574 7469 6e67 7329 0a20 2020 2020  _settings).     
+0001aad0: 2020 2020 2020 2073 656c 662e 6c61 7374         self.last
+0001aae0: 5f69 6d61 6765 5f69 6220 3d20 696d 6167  _image_ib = imag
+0001aaf0: 650a 0a20 2020 2020 2020 2072 6574 7572  e..        retur
+0001ab00: 6e20 696d 6167 650a 0a20 2020 2064 6566  n image..    def
+0001ab10: 205f 6765 745f 6562 5f69 6d61 6765 2873   _get_eb_image(s
+0001ab20: 656c 662c 2069 6d61 6765 5f73 6574 7469  elf, image_setti
+0001ab30: 6e67 733a 2049 6d61 6765 5365 7474 696e  ngs: ImageSettin
+0001ab40: 6773 2920 2d3e 2046 6962 7365 6d49 6d61  gs) -> FibsemIma
+0001ab50: 6765 3a0a 2020 2020 2020 2020 2222 220a  ge:.        """.
+0001ab60: 2020 2020 2020 2020 4163 7175 6972 6573          Acquires
+0001ab70: 2061 6e20 656c 6563 7472 6f6e 2062 6561   an electron bea
+0001ab80: 6d20 2845 4229 2069 6d61 6765 2077 6974  m (EB) image wit
+0001ab90: 6820 7468 6520 6769 7665 6e20 7365 7474  h the given sett
+0001aba0: 696e 6773 2061 6e64 2072 6574 7572 6e73  ings and returns
+0001abb0: 2061 2046 6962 7365 6d49 6d61 6765 206f   a FibsemImage o
+0001abc0: 626a 6563 742e 0a0a 2020 2020 2020 2020  bject...        
+0001abd0: 4172 6773 3a0a 2020 2020 2020 2020 2020  Args:.          
+0001abe0: 2020 696d 6167 655f 7365 7474 696e 6773    image_settings
+0001abf0: 2028 496d 6167 6553 6574 7469 6e67 7329   (ImageSettings)
+0001ac00: 3a20 416e 206f 626a 6563 7420 636f 6e74  : An object cont
+0001ac10: 6169 6e69 6e67 2074 6865 2073 6574 7469  aining the setti
+0001ac20: 6e67 7320 666f 7220 7468 6520 6163 7175  ngs for the acqu
+0001ac30: 6972 6564 2069 6d61 6765 2e20 0a0a 2020  ired image. ..  
+0001ac40: 2020 2020 2020 5265 7475 726e 733a 0a20        Returns:. 
+0001ac50: 2020 2020 2020 2020 2020 2046 6962 7365             Fibse
+0001ac60: 6d49 6d61 6765 3a20 5468 6520 6163 7175  mImage: The acqu
+0001ac70: 6972 6564 2069 6d61 6765 2061 7320 6120  ired image as a 
+0001ac80: 4669 6273 656d 496d 6167 6520 6f62 6a65  FibsemImage obje
+0001ac90: 6374 2e0a 0a20 2020 2020 2020 204e 6f74  ct...        Not
+0001aca0: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
+0001acb0: 5468 6973 2066 756e 6374 696f 6e20 6163  This function ac
+0001acc0: 7175 6972 6573 2061 6e20 656c 6563 7472  quires an electr
+0001acd0: 6f6e 2062 6561 6d20 2845 4229 2069 6d61  on beam (EB) ima
+0001ace0: 6765 2077 6974 6820 7468 6520 6769 7665  ge with the give
+0001acf0: 6e20 7365 7474 696e 6773 2061 6e64 2072  n settings and r
+0001ad00: 6574 7572 6e73 2069 7420 6173 2061 2046  eturns it as a F
+0001ad10: 6962 7365 6d49 6d61 6765 206f 626a 6563  ibsemImage objec
+0001ad20: 742e 200a 2020 2020 2020 2020 2020 2020  t. .            
+0001ad30: 5468 6520 6675 6e63 7469 6f6e 2073 6574  The function set
+0001ad40: 7320 7570 2074 6865 206d 6963 726f 7363  s up the microsc
+0001ad50: 6f70 6520 7061 7261 6d65 7465 7273 2c20  ope parameters, 
+0001ad60: 696e 636c 7564 696e 6720 7468 6520 656c  including the el
+0001ad70: 6563 7472 6f6e 2062 6561 6d20 6477 656c  ectron beam dwel
+0001ad80: 6c20 7469 6d65 2c20 696d 6167 6520 7265  l time, image re
+0001ad90: 736f 6c75 7469 6f6e 2c20 616e 6420 0a20  solution, and . 
+0001ada0: 2020 2020 2020 2020 2020 2072 6567 696f             regio
+0001adb0: 6e20 6f66 2069 6e74 6572 6573 7420 2852  n of interest (R
+0001adc0: 4f49 292c 2069 6620 7370 6563 6966 6965  OI), if specifie
+0001add0: 642e 2049 7420 7468 656e 2061 6371 7569  d. It then acqui
+0001ade0: 7265 7320 7468 6520 696d 6167 6520 616e  res the image an
+0001adf0: 6420 6372 6561 7465 7320 6120 4669 6273  d creates a Fibs
+0001ae00: 656d 496d 6167 6520 6f62 6a65 6374 2066  emImage object f
+0001ae10: 726f 6d20 6974 2c20 0a20 2020 2020 2020  rom it, .       
+0001ae20: 2020 2020 2069 6e63 6c75 6469 6e67 206d       including m
+0001ae30: 6574 6164 6174 6120 6f6e 2074 6865 206d  etadata on the m
+0001ae40: 6963 726f 7363 6f70 6520 7374 6174 6520  icroscope state 
+0001ae50: 616e 6420 7468 6520 6265 616d 2061 6e64  and the beam and
+0001ae60: 2069 6f6e 2073 6574 7469 6e67 732e 0a0a   ion settings...
+0001ae70: 2020 2020 2020 2020 2020 2020 4265 666f              Befo
+0001ae80: 7265 2061 6371 7569 7269 6e67 2074 6865  re acquiring the
+0001ae90: 2069 6d61 6765 2c20 7468 6520 6675 6e63   image, the func
+0001aea0: 7469 6f6e 2065 6e73 7572 6573 2074 6861  tion ensures tha
+0001aeb0: 7420 7468 6520 656c 6563 7472 6f6e 2062  t the electron b
+0001aec0: 6561 6d20 6973 2074 7572 6e65 6420 6f6e  eam is turned on
+0001aed0: 2061 6e64 2074 6861 7420 7468 6520 5345   and that the SE
+0001aee0: 4d20 7363 616e 2069 7320 7374 6f70 7065  M scan is stoppe
+0001aef0: 642e 200a 2020 2020 2020 2020 2020 2020  d. .            
+0001af00: 4974 2073 656c 6563 7473 2074 6865 206d  It selects the m
+0001af10: 6f73 7420 7375 6974 6162 6c65 2064 6574  ost suitable det
+0001af20: 6563 746f 7220 666f 7220 7468 6520 696d  ector for the im
+0001af30: 6167 652c 2061 7373 6967 6e73 2069 7420  age, assigns it 
+0001af40: 746f 2061 2063 6861 6e6e 656c 2c20 616e  to a channel, an
+0001af50: 6420 656e 6162 6c65 7320 7468 6520 6368  d enables the ch
+0001af60: 616e 6e65 6c20 666f 7220 6163 7175 6973  annel for acquis
+0001af70: 6974 696f 6e2e 200a 2020 2020 2020 2020  ition. .        
+0001af80: 2020 2020 5468 6520 6675 6e63 7469 6f6e      The function
+0001af90: 2074 6865 6e20 6163 7175 6972 6573 2074   then acquires t
+0001afa0: 6865 2069 6d61 6765 2066 726f 6d20 7468  he image from th
+0001afb0: 6520 6368 616e 6e65 6c20 7573 696e 6720  e channel using 
+0001afc0: 7468 6520 7370 6563 6966 6965 6420 6477  the specified dw
+0001afd0: 656c 6c20 7469 6d65 2061 6e64 2072 6573  ell time and res
+0001afe0: 6f6c 7574 696f 6e2e 0a0a 2020 2020 2020  olution...      
+0001aff0: 2020 2020 2020 5468 6520 6675 6e63 7469        The functi
+0001b000: 6f6e 2061 6c73 6f20 7265 636f 7264 7320  on also records 
+0001b010: 7468 6520 6d69 6372 6f73 636f 7065 2073  the microscope s
+0001b020: 7461 7465 2061 7420 7468 6520 7469 6d65  tate at the time
+0001b030: 206f 6620 696d 6167 6520 6163 7175 6973   of image acquis
+0001b040: 6974 696f 6e2c 2069 6e63 6c75 6469 6e67  ition, including
+0001b050: 2074 6865 2073 7461 6765 2070 6f73 6974   the stage posit
+0001b060: 696f 6e2c 2062 6561 6d20 0a20 2020 2020  ion, beam .     
+0001b070: 2020 2020 2020 2073 6574 7469 6e67 732c         settings,
+0001b080: 2061 6e64 2069 6f6e 2062 6561 6d20 7365   and ion beam se
+0001b090: 7474 696e 6773 2e20 5468 6520 6163 7175  ttings. The acqu
+0001b0a0: 6972 6564 2069 6d61 6765 2069 7320 7265  ired image is re
+0001b0b0: 7475 726e 6564 2061 7320 6120 4669 6273  turned as a Fibs
+0001b0c0: 656d 496d 6167 6520 6f62 6a65 6374 2c20  emImage object, 
+0001b0d0: 7768 6963 6820 696e 636c 7564 6573 2074  which includes t
+0001b0e0: 6865 2069 6d61 6765 200a 2020 2020 2020  he image .      
+0001b0f0: 2020 2020 2020 6461 7461 2061 6e64 206d        data and m
+0001b100: 6574 6164 6174 6120 6f6e 2074 6865 206d  etadata on the m
+0001b110: 6963 726f 7363 6f70 6520 7374 6174 6520  icroscope state 
+0001b120: 616e 6420 7468 6520 696d 6167 6520 7365  and the image se
+0001b130: 7474 696e 6773 2e0a 2020 2020 2020 2020  ttings..        
+0001b140: 2222 220a 2020 2020 2020 2020 2320 4174  """.        # At
+0001b150: 2066 6972 7374 206d 616b 6520 7375 7265   first make sure
+0001b160: 2074 6865 2062 6561 6d20 6973 204f 4e0a   the beam is ON.
+0001b170: 2020 2020 2020 2020 7374 6174 7573 203d          status =
+0001b180: 2073 656c 662e 636f 6e6e 6563 7469 6f6e   self.connection
+0001b190: 2e53 454d 2e42 6561 6d2e 4765 7453 7461  .SEM.Beam.GetSta
+0001b1a0: 7475 7328 290a 2020 2020 2020 2020 6966  tus().        if
+0001b1b0: 2073 7461 7475 7320 213d 2041 7574 6f6d   status != Autom
+0001b1c0: 6174 696f 6e2e 5345 4d2e 4265 616d 2e53  ation.SEM.Beam.S
+0001b1d0: 7461 7475 732e 4265 616d 4f6e 3a0a 2020  tatus.BeamOn:.  
+0001b1e0: 2020 2020 2020 2020 2020 7365 6c66 2e63            self.c
+0001b1f0: 6f6e 6e65 6374 696f 6e2e 5345 4d2e 4265  onnection.SEM.Be
+0001b200: 616d 2e4f 6e28 290a 2020 2020 2020 2020  am.On().        
+0001b210: 2320 696d 706f 7274 616e 743a 2073 746f  # important: sto
+0001b220: 7020 7468 6520 7363 616e 6e69 6e67 2062  p the scanning b
+0001b230: 6566 6f72 6520 7765 2073 7461 7274 2073  efore we start s
+0001b240: 6361 6e6e 696e 6720 6f72 2062 6566 6f72  canning or befor
+0001b250: 6520 6175 746f 6d61 7469 6320 7072 6f63  e automatic proc
+0001b260: 6564 7572 6573 2c0a 2020 2020 2020 2020  edures,.        
+0001b270: 2320 6576 656e 2062 6566 6f72 6520 7765  # even before we
+0001b280: 2063 6f6e 6669 6775 7265 2074 6865 2064   configure the d
+0001b290: 6574 6563 746f 7273 0a20 2020 2020 2020  etectors.       
+0001b2a0: 2073 656c 662e 636f 6e6e 6563 7469 6f6e   self.connection
+0001b2b0: 2e53 454d 2e53 6361 6e2e 5374 6f70 2829  .SEM.Scan.Stop()
+0001b2c0: 0a20 2020 2020 2020 2023 2053 656c 6563  .        # Selec
+0001b2d0: 7420 7468 6520 6465 7465 6374 6f72 2066  t the detector f
+0001b2e0: 6f72 2069 6d61 6765 2069 2e65 2e3a 0a20  or image i.e.:. 
+0001b2f0: 2020 2020 2020 2023 2031 2e20 6173 7369         # 1. assi
+0001b300: 676e 2074 6865 2064 6574 6563 746f 7220  gn the detector 
+0001b310: 746f 2061 2063 6861 6e6e 656c 0a20 2020  to a channel.   
+0001b320: 2020 2020 2023 2032 2e20 656e 6162 6c65       # 2. enable
+0001b330: 2074 6865 2063 6861 6e6e 656c 2066 6f72   the channel for
+0001b340: 2061 6371 7569 7369 7469 6f6e 0a20 2020   acquisition.   
+0001b350: 2020 2020 200a 2020 2020 2020 2020 7365       .        se
+0001b360: 6c66 2e63 6f6e 6e65 6374 696f 6e2e 5345  lf.connection.SE
+0001b370: 4d2e 4465 7465 6374 6f72 2e53 6574 2830  M.Detector.Set(0
+0001b380: 2c20 7365 6c66 2e65 6c65 6374 726f 6e5f  , self.electron_
+0001b390: 6465 7465 6374 6f72 5f61 6374 6976 652c  detector_active,
+0001b3a0: 2042 7070 2e47 7261 7973 6361 6c65 5f38   Bpp.Grayscale_8
+0001b3b0: 5f62 6974 290a 0a20 2020 2020 2020 2064  _bit)..        d
+0001b3c0: 7765 6c6c 5f74 696d 6520 3d20 696d 6167  well_time = imag
+0001b3d0: 655f 7365 7474 696e 6773 2e64 7765 6c6c  e_settings.dwell
+0001b3e0: 5f74 696d 6520 2a20 636f 6e73 7461 6e74  _time * constant
+0001b3f0: 732e 5349 5f54 4f5f 4e41 4e4f 0a20 2020  s.SI_TO_NANO.   
+0001b400: 2020 2020 2023 2072 6573 6f6c 7574 696f       # resolutio
+0001b410: 6e0a 2020 2020 2020 2020 696d 6167 6557  n.        imageW
+0001b420: 6964 7468 203d 2069 6d61 6765 5f73 6574  idth = image_set
+0001b430: 7469 6e67 732e 7265 736f 6c75 7469 6f6e  tings.resolution
+0001b440: 5b30 5d0a 2020 2020 2020 2020 696d 6167  [0].        imag
+0001b450: 6548 6569 6768 7420 3d20 696d 6167 655f  eHeight = image_
+0001b460: 7365 7474 696e 6773 2e72 6573 6f6c 7574  settings.resolut
+0001b470: 696f 6e5b 315d 0a0a 2020 2020 2020 2020  ion[1]..        
+0001b480: 7365 6c66 2e63 6f6e 6e65 6374 696f 6e2e  self.connection.
+0001b490: 5345 4d2e 4f70 7469 6373 2e53 6574 5669  SEM.Optics.SetVi
+0001b4a0: 6577 6669 656c 6428 0a20 2020 2020 2020  ewfield(.       
+0001b4b0: 2020 2020 2069 6d61 6765 5f73 6574 7469       image_setti
+0001b4c0: 6e67 732e 6866 7720 2a20 636f 6e73 7461  ngs.hfw * consta
+0001b4d0: 6e74 732e 4d45 5452 455f 544f 5f4d 494c  nts.METRE_TO_MIL
+0001b4e0: 4c49 4d45 5452 450a 2020 2020 2020 2020  LIMETRE.        
+0001b4f0: 290a 2020 2020 2020 2020 6966 2069 6d61  ).        if ima
+0001b500: 6765 5f73 6574 7469 6e67 732e 7265 6475  ge_settings.redu
+0001b510: 6365 645f 6172 6561 2069 7320 6e6f 7420  ced_area is not 
+0001b520: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+0001b530: 2020 6c65 6674 203d 2020 696e 7428 696d    left =  int(im
+0001b540: 6167 655f 7365 7474 696e 6773 2e72 6564  age_settings.red
+0001b550: 7563 6564 5f61 7265 612e 6c65 6674 202a  uced_area.left *
+0001b560: 2069 6d61 6765 5769 6474 6829 0a20 2020   imageWidth).   
+0001b570: 2020 2020 2020 2020 2074 6f70 203d 2069           top = i
+0001b580: 6e74 2869 6d61 6765 5f73 6574 7469 6e67  nt(image_setting
+0001b590: 732e 7265 6475 6365 645f 6172 6561 2e74  s.reduced_area.t
+0001b5a0: 6f70 202a 2069 6d61 6765 4865 6967 6874  op * imageHeight
+0001b5b0: 2920 0a20 2020 2020 2020 2020 2020 2077  ) .            w
+0001b5c0: 6964 7468 203d 2069 6e74 2869 6d61 6765  idth = int(image
+0001b5d0: 5f73 6574 7469 6e67 732e 7265 6475 6365  _settings.reduce
+0001b5e0: 645f 6172 6561 2e77 6964 7468 202a 2069  d_area.width * i
+0001b5f0: 6d61 6765 5769 6474 6829 0a20 2020 2020  mageWidth).     
+0001b600: 2020 2020 2020 2068 6569 6768 7420 3d20         height = 
+0001b610: 696e 7428 696d 6167 655f 7365 7474 696e  int(image_settin
+0001b620: 6773 2e72 6564 7563 6564 5f61 7265 612e  gs.reduced_area.
+0001b630: 6865 6967 6874 202a 2069 6d61 6765 4865  height * imageHe
+0001b640: 6967 6874 290a 2020 2020 2020 2020 2020  ight).          
+0001b650: 2020 696d 6167 6520 3d20 7365 6c66 2e63    image = self.c
+0001b660: 6f6e 6e65 6374 696f 6e2e 5345 4d2e 5363  onnection.SEM.Sc
+0001b670: 616e 2e41 6371 7569 7265 524f 4946 726f  an.AcquireROIFro
+0001b680: 6d43 6861 6e6e 656c 280a 2020 2020 2020  mChannel(.      
+0001b690: 2020 2020 2020 2020 2020 4368 616e 6e65            Channe
+0001b6a0: 6c3d 2030 2c0a 2020 2020 2020 2020 2020  l= 0,.          
+0001b6b0: 2020 2020 2020 5769 6474 683d 2069 6d61        Width= ima
+0001b6c0: 6765 5769 6474 682c 0a20 2020 2020 2020  geWidth,.       
+0001b6d0: 2020 2020 2020 2020 2048 6569 6768 743d           Height=
+0001b6e0: 2069 6d61 6765 4865 6967 6874 2c0a 2020   imageHeight,.  
+0001b6f0: 2020 2020 2020 2020 2020 2020 2020 4c65                Le
+0001b700: 6674 3d20 6c65 6674 2c0a 2020 2020 2020  ft= left,.      
+0001b710: 2020 2020 2020 2020 2020 546f 703d 2074            Top= t
+0001b720: 6f70 2c0a 2020 2020 2020 2020 2020 2020  op,.            
+0001b730: 2020 2020 5269 6768 743d 206c 6566 7420      Right= left 
+0001b740: 2b20 7769 6474 6820 2d31 202c 0a20 2020  + width -1 ,.   
+0001b750: 2020 2020 2020 2020 2020 2020 2042 6f74               Bot
+0001b760: 746f 6d3d 2074 6f70 202b 2068 6569 6768  tom= top + heigh
+0001b770: 7420 2d20 312c 0a20 2020 2020 2020 2020  t - 1,.         
+0001b780: 2020 2020 2020 2044 7765 6c6c 5469 6d65         DwellTime
+0001b790: 3d20 6477 656c 6c5f 7469 6d65 0a20 2020  = dwell_time.   
+0001b7a0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+0001b7b0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+0001b7c0: 2020 2020 2069 6d61 6765 203d 2073 656c       image = sel
+0001b7d0: 662e 636f 6e6e 6563 7469 6f6e 2e53 454d  f.connection.SEM
+0001b7e0: 2e53 6361 6e2e 4163 7175 6972 6549 6d61  .Scan.AcquireIma
+0001b7f0: 6765 4672 6f6d 4368 616e 6e65 6c28 0a20  geFromChannel(. 
+0001b800: 2020 2020 2020 2020 2020 2020 2020 2030                 0
+0001b810: 2c20 696d 6167 6557 6964 7468 2c20 696d  , imageWidth, im
+0001b820: 6167 6548 6569 6768 742c 2064 7765 6c6c  ageHeight, dwell
+0001b830: 5f74 696d 650a 2020 2020 2020 2020 2020  _time.          
+0001b840: 2020 290a 0a20 2020 2020 2020 206d 6963    )..        mic
+0001b850: 726f 7363 6f70 655f 7374 6174 6520 3d20  roscope_state = 
+0001b860: 4d69 6372 6f73 636f 7065 5374 6174 6528  MicroscopeState(
+0001b870: 0a20 2020 2020 2020 2020 2020 2074 696d  .            tim
+0001b880: 6573 7461 6d70 3d64 6174 6574 696d 652e  estamp=datetime.
+0001b890: 6461 7465 7469 6d65 2e74 696d 6573 7461  datetime.timesta
+0001b8a0: 6d70 2864 6174 6574 696d 652e 6461 7465  mp(datetime.date
+0001b8b0: 7469 6d65 2e6e 6f77 2829 292c 0a20 2020  time.now()),.   
+0001b8c0: 2020 2020 2020 2020 2061 6273 6f6c 7574           absolut
+0001b8d0: 655f 706f 7369 7469 6f6e 3d46 6962 7365  e_position=Fibse
+0001b8e0: 6d53 7461 6765 506f 7369 7469 6f6e 280a  mStagePosition(.
+0001b8f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b900: 783d 666c 6f61 7428 696d 6167 652e 4865  x=float(image.He
+0001b910: 6164 6572 5b22 5345 4d22 5d5b 2253 7461  ader["SEM"]["Sta
+0001b920: 6765 5822 5d29 2c0a 2020 2020 2020 2020  geX"]),.        
+0001b930: 2020 2020 2020 2020 793d 666c 6f61 7428          y=float(
+0001b940: 696d 6167 652e 4865 6164 6572 5b22 5345  image.Header["SE
+0001b950: 4d22 5d5b 2253 7461 6765 5922 5d29 2c0a  M"]["StageY"]),.
+0001b960: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b970: 7a3d 666c 6f61 7428 696d 6167 652e 4865  z=float(image.He
+0001b980: 6164 6572 5b22 5345 4d22 5d5b 2253 7461  ader["SEM"]["Sta
+0001b990: 6765 5a22 5d29 2c0a 2020 2020 2020 2020  geZ"]),.        
+0001b9a0: 2020 2020 2020 2020 723d 666c 6f61 7428          r=float(
+0001b9b0: 696d 6167 652e 4865 6164 6572 5b22 5345  image.Header["SE
+0001b9c0: 4d22 5d5b 2253 7461 6765 526f 7461 7469  M"]["StageRotati
+0001b9d0: 6f6e 225d 292c 0a20 2020 2020 2020 2020  on"]),.         
+0001b9e0: 2020 2020 2020 2074 3d66 6c6f 6174 2869         t=float(i
+0001b9f0: 6d61 6765 2e48 6561 6465 725b 2253 454d  mage.Header["SEM
+0001ba00: 225d 5b22 5374 6167 6554 696c 7422 5d29  "]["StageTilt"])
+0001ba10: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0001ba20: 2020 636f 6f72 6469 6e61 7465 5f73 7973    coordinate_sys
+0001ba30: 7465 6d3d 2252 4157 222c 0a20 2020 2020  tem="RAW",.     
+0001ba40: 2020 2020 2020 2029 2c0a 2020 2020 2020         ),.      
+0001ba50: 2020 2020 2020 6562 5f73 6574 7469 6e67        eb_setting
+0001ba60: 733d 4265 616d 5365 7474 696e 6773 280a  s=BeamSettings(.
+0001ba70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ba80: 6265 616d 5f74 7970 653d 4265 616d 5479  beam_type=BeamTy
+0001ba90: 7065 2e45 4c45 4354 524f 4e2c 0a20 2020  pe.ELECTRON,.   
+0001baa0: 2020 2020 2020 2020 2020 2020 2077 6f72               wor
+0001bab0: 6b69 6e67 5f64 6973 7461 6e63 653d 666c  king_distance=fl
+0001bac0: 6f61 7428 696d 6167 652e 4865 6164 6572  oat(image.Header
+0001bad0: 5b22 5345 4d22 5d5b 2257 4422 5d29 2c0a  ["SEM"]["WD"]),.
+0001bae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001baf0: 6265 616d 5f63 7572 7265 6e74 3d66 6c6f  beam_current=flo
+0001bb00: 6174 2869 6d61 6765 2e48 6561 6465 725b  at(image.Header[
+0001bb10: 2253 454d 225d 5b22 5072 6564 6963 7465  "SEM"]["Predicte
+0001bb20: 6442 6561 6d43 7572 7265 6e74 225d 292c  dBeamCurrent"]),
+0001bb30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001bb40: 2072 6573 6f6c 7574 696f 6e3d 5b69 6d61   resolution=[ima
+0001bb50: 6765 5769 6474 682c 2069 6d61 6765 4865  geWidth, imageHe
+0001bb60: 6967 6874 5d2c 2023 227b 7d78 7b7d 222e  ight], #"{}x{}".
+0001bb70: 666f 726d 6174 2869 6d61 6765 5769 6474  format(imageWidt
+0001bb80: 682c 2069 6d61 6765 4865 6967 6874 292c  h, imageHeight),
+0001bb90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001bba0: 2064 7765 6c6c 5f74 696d 653d 666c 6f61   dwell_time=floa
+0001bbb0: 7428 696d 6167 652e 4865 6164 6572 5b22  t(image.Header["
+0001bbc0: 5345 4d22 5d5b 2244 7765 6c6c 5469 6d65  SEM"]["DwellTime
+0001bbd0: 225d 292c 0a20 2020 2020 2020 2020 2020  "]),.           
+0001bbe0: 2020 2020 2073 7469 676d 6174 696f 6e3d       stigmation=
+0001bbf0: 506f 696e 7428 0a20 2020 2020 2020 2020  Point(.         
+0001bc00: 2020 2020 2020 2020 2020 2066 6c6f 6174             float
+0001bc10: 2869 6d61 6765 2e48 6561 6465 725b 2253  (image.Header["S
+0001bc20: 454d 225d 5b22 5374 6967 6d61 746f 7258  EM"]["StigmatorX
+0001bc30: 225d 292c 0a20 2020 2020 2020 2020 2020  "]),.           
+0001bc40: 2020 2020 2020 2020 2066 6c6f 6174 2869           float(i
+0001bc50: 6d61 6765 2e48 6561 6465 725b 2253 454d  mage.Header["SEM
+0001bc60: 225d 5b22 5374 6967 6d61 746f 7259 225d  "]["StigmatorY"]
+0001bc70: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+0001bc80: 2020 2029 2c0a 2020 2020 2020 2020 2020     ),.          
+0001bc90: 2020 2020 2020 7368 6966 743d 506f 696e        shift=Poin
+0001bca0: 7428 0a20 2020 2020 2020 2020 2020 2020  t(.             
+0001bcb0: 2020 2020 2020 2066 6c6f 6174 2869 6d61         float(ima
+0001bcc0: 6765 2e48 6561 6465 725b 2253 454d 225d  ge.Header["SEM"]
+0001bcd0: 5b22 496d 6167 6553 6869 6674 5822 5d29  ["ImageShiftX"])
+0001bce0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0001bcf0: 2020 2020 2020 666c 6f61 7428 696d 6167        float(imag
+0001bd00: 652e 4865 6164 6572 5b22 5345 4d22 5d5b  e.Header["SEM"][
+0001bd10: 2249 6d61 6765 5368 6966 7459 225d 292c  "ImageShiftY"]),
+0001bd20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001bd30: 2029 2c0a 2020 2020 2020 2020 2020 2020   ),.            
+0001bd40: 2020 2020 7363 616e 5f72 6f74 6174 696f      scan_rotatio
+0001bd50: 6e3d 7365 6c66 2e63 6f6e 6e65 6374 696f  n=self.connectio
+0001bd60: 6e2e 5345 4d2e 4f70 7469 6373 2e47 6574  n.SEM.Optics.Get
+0001bd70: 496d 6167 6552 6f74 6174 696f 6e28 292c  ImageRotation(),
+0001bd80: 0a20 2020 2020 2020 2020 2020 2029 2c0a  .            ),.
+0001bd90: 2020 2020 2020 2020 2020 2020 6962 5f73              ib_s
+0001bda0: 6574 7469 6e67 733d 4265 616d 5365 7474  ettings=BeamSett
+0001bdb0: 696e 6773 2862 6561 6d5f 7479 7065 3d42  ings(beam_type=B
+0001bdc0: 6561 6d54 7970 652e 494f 4e29 2c0a 2020  eamType.ION),.  
+0001bdd0: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
+0001bde0: 2064 6574 6563 746f 7220 3d20 4669 6273   detector = Fibs
+0001bdf0: 656d 4465 7465 6374 6f72 5365 7474 696e  emDetectorSettin
+0001be00: 6773 280a 2020 2020 2020 2020 2020 2020  gs(.            
+0001be10: 2020 2020 7479 7065 203d 2073 656c 662e      type = self.
+0001be20: 6765 7428 2264 6574 6563 746f 725f 7479  get("detector_ty
+0001be30: 7065 222c 2069 6d61 6765 5f73 6574 7469  pe", image_setti
+0001be40: 6e67 732e 6265 616d 5f74 7970 6529 2c0a  ngs.beam_type),.
+0001be50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001be60: 6d6f 6465 203d 2022 4e2f 4122 2c0a 2020  mode = "N/A",.  
+0001be70: 2020 2020 2020 2020 2020 2020 2020 636f                co
+0001be80: 6e74 7261 7374 203d 2073 656c 662e 6765  ntrast = self.ge
+0001be90: 7428 2264 6574 6563 746f 725f 636f 6e74  t("detector_cont
+0001bea0: 7261 7374 222c 2069 6d61 6765 5f73 6574  rast", image_set
+0001beb0: 7469 6e67 732e 6265 616d 5f74 7970 6529  tings.beam_type)
+0001bec0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0001bed0: 2020 6272 6967 6874 6e65 7373 3d20 7365    brightness= se
+0001bee0: 6c66 2e67 6574 2822 6465 7465 6374 6f72  lf.get("detector
+0001bef0: 5f62 7269 6768 746e 6573 7322 2c20 696d  _brightness", im
+0001bf00: 6167 655f 7365 7474 696e 6773 2e62 6561  age_settings.bea
+0001bf10: 6d5f 7479 7065 292c 0a0a 2020 2020 2020  m_type),..      
+0001bf20: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
+0001bf30: 2069 6d61 6765 5f73 6574 7469 6e67 732e   image_settings.
+0001bf40: 7265 736f 6c75 7469 6f6e 203d 205b 696d  resolution = [im
+0001bf50: 6167 6557 6964 7468 2c20 696d 6167 6548  ageWidth, imageH
+0001bf60: 6569 6768 745d 0a20 2020 2020 2020 2066  eight].        f
+0001bf70: 6962 7365 6d5f 696d 6167 6520 3d20 4669  ibsem_image = Fi
+0001bf80: 6273 656d 496d 6167 652e 6672 6f6d 5465  bsemImage.fromTe
+0001bf90: 7363 616e 496d 6167 6528 0a20 2020 2020  scanImage(.     
+0001bfa0: 2020 2020 2020 2069 6d61 6765 2c20 6465         image, de
+0001bfb0: 6570 636f 7079 2869 6d61 6765 5f73 6574  epcopy(image_set
+0001bfc0: 7469 6e67 7329 2c20 6465 6570 636f 7079  tings), deepcopy
+0001bfd0: 286d 6963 726f 7363 6f70 655f 7374 6174  (microscope_stat
+0001bfe0: 6529 2c20 6465 7465 6374 6f72 3d20 6465  e), detector= de
+0001bff0: 7465 6374 6f72 0a20 2020 2020 2020 2029  tector.        )
+0001c000: 0a0a 2020 2020 2020 2020 2366 6962 7365  ..        #fibse
+0001c010: 6d5f 696d 6167 652e 6d65 7461 6461 7461  m_image.metadata
+0001c020: 2e69 6d61 6765 5f73 6574 7469 6e67 732e  .image_settings.
+0001c030: 7265 736f 6c75 7469 6f6e 203d 205b 696d  resolution = [im
+0001c040: 6167 6557 6964 7468 2c20 696d 6167 6548  ageWidth, imageH
+0001c050: 6569 6768 745d 0a0a 2020 2020 2020 2020  eight]..        
+0001c060: 7265 7475 726e 2066 6962 7365 6d5f 696d  return fibsem_im
+0001c070: 6167 650a 0a20 2020 2064 6566 205f 6765  age..    def _ge
+0001c080: 745f 6962 5f69 6d61 6765 2873 656c 662c  t_ib_image(self,
+0001c090: 2069 6d61 6765 5f73 6574 7469 6e67 733a   image_settings:
+0001c0a0: 2049 6d61 6765 5365 7474 696e 6773 293a   ImageSettings):
+0001c0b0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+0001c0c0: 2020 2020 2041 6371 7569 7265 7320 616e       Acquires an
+0001c0d0: 2069 6f6e 2062 6561 6d20 2849 4229 2069   ion beam (IB) i
+0001c0e0: 6d61 6765 2077 6974 6820 7468 6520 6769  mage with the gi
+0001c0f0: 7665 6e20 7365 7474 696e 6773 2061 6e64  ven settings and
+0001c100: 2072 6574 7572 6e73 2061 2046 6962 7365   returns a Fibse
+0001c110: 6d49 6d61 6765 206f 626a 6563 742e 0a0a  mImage object...
+0001c120: 2020 2020 2020 2020 4172 6773 3a0a 2020          Args:.  
+0001c130: 2020 2020 2020 2020 2020 696d 6167 655f            image_
+0001c140: 7365 7474 696e 6773 2028 496d 6167 6553  settings (ImageS
+0001c150: 6574 7469 6e67 7329 3a20 5468 6520 7365  ettings): The se
+0001c160: 7474 696e 6773 2066 6f72 2074 6865 2061  ttings for the a
+0001c170: 6371 7569 7265 6420 696d 6167 652e 0a0a  cquired image...
+0001c180: 2020 2020 2020 2020 5265 7475 726e 733a          Returns:
+0001c190: 0a20 2020 2020 2020 2020 2020 2046 6962  .            Fib
+0001c1a0: 7365 6d49 6d61 6765 3a20 5468 6520 6163  semImage: The ac
+0001c1b0: 7175 6972 6564 2069 6d61 6765 2061 7320  quired image as 
+0001c1c0: 6120 4669 6273 656d 496d 6167 6520 6f62  a FibsemImage ob
+0001c1d0: 6a65 6374 2e0a 0a20 2020 2020 2020 204e  ject...        N
+0001c1e0: 6f74 6573 3a0a 2020 2020 2020 2020 2020  otes:.          
+0001c1f0: 2020 2d20 5468 6520 6675 6e63 7469 6f6e    - The function
+0001c200: 2061 6371 7569 7265 7320 616e 2049 4220   acquires an IB 
+0001c210: 696d 6167 6520 7769 7468 2074 6865 2067  image with the g
+0001c220: 6976 656e 2073 6574 7469 6e67 7320 6279  iven settings by
+0001c230: 2063 6f6e 6669 6775 7269 6e67 2074 6865   configuring the
+0001c240: 2064 6574 6563 746f 7273 2c20 7363 616e   detectors, scan
+0001c250: 6e69 6e67 2c20 616e 6420 7365 6c65 6374  ning, and select
+0001c260: 696e 6720 7468 6520 6477 656c 6c20 7469  ing the dwell ti
+0001c270: 6d65 2c20 7265 736f 6c75 7469 6f6e 2c20  me, resolution, 
+0001c280: 616e 6420 7669 6577 6669 656c 642e 0a20  and viewfield.. 
+0001c290: 2020 2020 2020 2020 2020 202d 2049 6620             - If 
+0001c2a0: 7468 6520 696d 6167 6520 7365 7474 696e  the image settin
+0001c2b0: 6773 2069 6e63 6c75 6465 2061 2072 6564  gs include a red
+0001c2c0: 7563 6564 2061 7265 612c 2074 6865 2066  uced area, the f
+0001c2d0: 756e 6374 696f 6e20 7769 6c6c 2061 6371  unction will acq
+0001c2e0: 7569 7265 2061 6e20 696d 6167 6520 7769  uire an image wi
+0001c2f0: 7468 696e 2074 6865 2072 6564 7563 6564  thin the reduced
+0001c300: 2061 7265 612e 0a20 2020 2020 2020 2020   area..         
+0001c310: 2020 202d 2054 6865 2066 756e 6374 696f     - The functio
+0001c320: 6e20 616c 736f 2063 6170 7475 7265 7320  n also captures 
+0001c330: 7468 6520 6d69 6372 6f73 636f 7065 2073  the microscope s
+0001c340: 7461 7465 2061 7420 7468 6520 7469 6d65  tate at the time
+0001c350: 206f 6620 6163 7175 6973 6974 696f 6e20   of acquisition 
+0001c360: 616e 6420 696e 636c 7564 6573 2074 6869  and includes thi
+0001c370: 7320 696e 666f 726d 6174 696f 6e20 696e  s information in
+0001c380: 2074 6865 206d 6574 6164 6174 6120 6f66   the metadata of
+0001c390: 2074 6865 2061 6371 7569 7265 6420 696d   the acquired im
+0001c3a0: 6167 652e 0a20 2020 2020 2020 2022 2222  age..        """
+0001c3b0: 0a20 2020 2020 2020 2023 2041 7420 6669  .        # At fi
+0001c3c0: 7273 7420 6d61 6b65 2073 7572 6520 7468  rst make sure th
+0001c3d0: 6520 6265 616d 2069 7320 4f4e 0a20 2020  e beam is ON.   
+0001c3e0: 2020 2020 2073 7461 7475 7320 3d20 7365       status = se
+0001c3f0: 6c66 2e63 6f6e 6e65 6374 696f 6e2e 4649  lf.connection.FI
+0001c400: 422e 4265 616d 2e47 6574 5374 6174 7573  B.Beam.GetStatus
+0001c410: 2829 0a20 2020 2020 2020 2069 6620 7374  ().        if st
+0001c420: 6174 7573 2021 3d20 4175 746f 6d61 7469  atus != Automati
+0001c430: 6f6e 2e46 4942 2e42 6561 6d2e 5374 6174  on.FIB.Beam.Stat
+0001c440: 7573 2e42 6561 6d4f 6e3a 0a20 2020 2020  us.BeamOn:.     
+0001c450: 2020 2020 2020 2073 656c 662e 636f 6e6e         self.conn
+0001c460: 6563 7469 6f6e 2e46 4942 2e42 6561 6d2e  ection.FIB.Beam.
+0001c470: 4f6e 2829 0a20 2020 2020 2020 2023 2069  On().        # i
+0001c480: 6d70 6f72 7461 6e74 3a20 7374 6f70 2074  mportant: stop t
+0001c490: 6865 2073 6361 6e6e 696e 6720 6265 666f  he scanning befo
+0001c4a0: 7265 2077 6520 7374 6172 7420 7363 616e  re we start scan
+0001c4b0: 6e69 6e67 206f 7220 6265 666f 7265 2061  ning or before a
+0001c4c0: 7574 6f6d 6174 6963 2070 726f 6365 6475  utomatic procedu
+0001c4d0: 7265 732c 0a20 2020 2020 2020 2023 2065  res,.        # e
+0001c4e0: 7665 6e20 6265 666f 7265 2077 6520 636f  ven before we co
+0001c4f0: 6e66 6967 7572 6520 7468 6520 6465 7465  nfigure the dete
+0001c500: 6374 6f72 730a 2020 2020 2020 2020 7365  ctors.        se
+0001c510: 6c66 2e63 6f6e 6e65 6374 696f 6e2e 4649  lf.connection.FI
+0001c520: 422e 5363 616e 2e53 746f 7028 290a 2020  B.Scan.Stop().  
+0001c530: 2020 2020 2020 2320 5365 6c65 6374 2074        # Select t
+0001c540: 6865 2064 6574 6563 746f 7220 666f 7220  he detector for 
+0001c550: 696d 6167 6520 692e 652e 3a0a 2020 2020  image i.e.:.    
+0001c560: 2020 2020 2320 312e 2061 7373 6967 6e20      # 1. assign 
+0001c570: 7468 6520 6465 7465 6374 6f72 2074 6f20  the detector to 
+0001c580: 6120 6368 616e 6e65 6c0a 2020 2020 2020  a channel.      
+0001c590: 2020 2320 322e 2065 6e61 626c 6520 7468    # 2. enable th
+0001c5a0: 6520 6368 616e 6e65 6c20 666f 7220 6163  e channel for ac
+0001c5b0: 7175 6973 6974 696f 6e0a 2020 2020 2020  quisition.      
+0001c5c0: 2020 7365 6c66 2e63 6f6e 6e65 6374 696f    self.connectio
+0001c5d0: 6e2e 4649 422e 4465 7465 6374 6f72 2e53  n.FIB.Detector.S
+0001c5e0: 6574 280a 2020 2020 2020 2020 2020 2020  et(.            
+0001c5f0: 302c 2073 656c 662e 696f 6e5f 6465 7465  0, self.ion_dete
+0001c600: 6374 6f72 5f61 6374 6976 652c 2042 7070  ctor_active, Bpp
+0001c610: 2e47 7261 7973 6361 6c65 5f38 5f62 6974  .Grayscale_8_bit
+0001c620: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
+0001c630: 2020 2020 6477 656c 6c5f 7469 6d65 203d      dwell_time =
+0001c640: 2069 6d61 6765 5f73 6574 7469 6e67 732e   image_settings.
+0001c650: 6477 656c 6c5f 7469 6d65 202a 2063 6f6e  dwell_time * con
+0001c660: 7374 616e 7473 2e53 495f 544f 5f4e 414e  stants.SI_TO_NAN
+0001c670: 4f0a 0a20 2020 2020 2020 2023 2072 6573  O..        # res
+0001c680: 6f6c 7574 696f 6e0a 2020 2020 2020 2020  olution.        
+0001c690: 696d 6167 6557 6964 7468 203d 2069 6d61  imageWidth = ima
+0001c6a0: 6765 5f73 6574 7469 6e67 732e 7265 736f  ge_settings.reso
+0001c6b0: 6c75 7469 6f6e 5b30 5d0a 2020 2020 2020  lution[0].      
+0001c6c0: 2020 696d 6167 6548 6569 6768 7420 3d20    imageHeight = 
+0001c6d0: 696d 6167 655f 7365 7474 696e 6773 2e72  image_settings.r
+0001c6e0: 6573 6f6c 7574 696f 6e5b 315d 0a0a 2020  esolution[1]..  
+0001c6f0: 2020 2020 2020 7365 6c66 2e63 6f6e 6e65        self.conne
+0001c700: 6374 696f 6e2e 4649 422e 4f70 7469 6373  ction.FIB.Optics
+0001c710: 2e53 6574 5669 6577 6669 656c 6428 0a20  .SetViewfield(. 
+0001c720: 2020 2020 2020 2020 2020 2069 6d61 6765             image
+0001c730: 5f73 6574 7469 6e67 732e 6866 7720 2a20  _settings.hfw * 
+0001c740: 636f 6e73 7461 6e74 732e 4d45 5452 455f  constants.METRE_
+0001c750: 544f 5f4d 494c 4c49 4d45 5452 450a 2020  TO_MILLIMETRE.  
+0001c760: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+0001c770: 0a20 2020 2020 2020 200a 2020 2020 2020  .        .      
+0001c780: 2020 6966 2069 6d61 6765 5f73 6574 7469    if image_setti
+0001c790: 6e67 732e 7265 6475 6365 645f 6172 6561  ngs.reduced_area
+0001c7a0: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
+0001c7b0: 2020 2020 2020 2020 2020 6c65 6674 203d            left =
+0001c7c0: 2020 696e 7428 696d 6167 655f 7365 7474    int(image_sett
+0001c7d0: 696e 6773 2e72 6564 7563 6564 5f61 7265  ings.reduced_are
+0001c7e0: 612e 6c65 6674 202a 2069 6d61 6765 5769  a.left * imageWi
+0001c7f0: 6474 6829 0a20 2020 2020 2020 2020 2020  dth).           
+0001c800: 2074 6f70 203d 2069 6e74 2869 6d61 6765   top = int(image
+0001c810: 5f73 6574 7469 6e67 732e 7265 6475 6365  _settings.reduce
+0001c820: 645f 6172 6561 2e74 6f70 202a 2069 6d61  d_area.top * ima
+0001c830: 6765 4865 6967 6874 2920 0a20 2020 2020  geHeight) .     
+0001c840: 2020 2020 2020 2077 6964 7468 203d 2069         width = i
+0001c850: 6e74 2869 6d61 6765 5f73 6574 7469 6e67  nt(image_setting
+0001c860: 732e 7265 6475 6365 645f 6172 6561 2e77  s.reduced_area.w
+0001c870: 6964 7468 202a 2069 6d61 6765 5769 6474  idth * imageWidt
+0001c880: 6829 0a20 2020 2020 2020 2020 2020 2068  h).            h
+0001c890: 6569 6768 7420 3d20 696e 7428 696d 6167  eight = int(imag
+0001c8a0: 655f 7365 7474 696e 6773 2e72 6564 7563  e_settings.reduc
+0001c8b0: 6564 5f61 7265 612e 6865 6967 6874 202a  ed_area.height *
+0001c8c0: 2069 6d61 6765 4865 6967 6874 290a 2020   imageHeight).  
+0001c8d0: 2020 2020 2020 2020 2020 696d 6167 6520            image 
+0001c8e0: 3d20 7365 6c66 2e63 6f6e 6e65 6374 696f  = self.connectio
+0001c8f0: 6e2e 4649 422e 5363 616e 2e41 6371 7569  n.FIB.Scan.Acqui
+0001c900: 7265 524f 4946 726f 6d43 6861 6e6e 656c  reROIFromChannel
+0001c910: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0001c920: 2020 4368 616e 6e65 6c3d 2030 2c0a 2020    Channel= 0,.  
+0001c930: 2020 2020 2020 2020 2020 2020 2020 5769                Wi
+0001c940: 6474 683d 2069 6d61 6765 5769 6474 682c  dth= imageWidth,
+0001c950: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001c960: 2048 6569 6768 743d 2069 6d61 6765 4865   Height= imageHe
+0001c970: 6967 6874 2c0a 2020 2020 2020 2020 2020  ight,.          
+0001c980: 2020 2020 2020 4c65 6674 3d20 6c65 6674        Left= left
+0001c990: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0001c9a0: 2020 546f 703d 2074 6f70 2c0a 2020 2020    Top= top,.    
+0001c9b0: 2020 2020 2020 2020 2020 2020 5269 6768              Righ
+0001c9c0: 743d 206c 6566 7420 2b20 7769 6474 6820  t= left + width 
+0001c9d0: 2d31 202c 0a20 2020 2020 2020 2020 2020  -1 ,.           
+0001c9e0: 2020 2020 2042 6f74 746f 6d3d 2074 6f70       Bottom= top
+0001c9f0: 202b 2068 6569 6768 7420 2d20 312c 0a20   + height - 1,. 
+0001ca00: 2020 2020 2020 2020 2020 2020 2020 2044                 D
+0001ca10: 7765 6c6c 5469 6d65 3d20 6477 656c 6c5f  wellTime= dwell_
+0001ca20: 7469 6d65 0a20 2020 2020 2020 2020 2020  time.           
+0001ca30: 2029 0a20 2020 2020 2020 2065 6c73 653a   ).        else:
+0001ca40: 0a20 2020 2020 2020 2020 2020 2069 6d61  .            ima
+0001ca50: 6765 203d 2073 656c 662e 636f 6e6e 6563  ge = self.connec
+0001ca60: 7469 6f6e 2e46 4942 2e53 6361 6e2e 4163  tion.FIB.Scan.Ac
+0001ca70: 7175 6972 6549 6d61 6765 4672 6f6d 4368  quireImageFromCh
+0001ca80: 616e 6e65 6c28 0a20 2020 2020 2020 2020  annel(.         
+0001ca90: 2020 2020 2020 2030 2c20 696d 6167 6557         0, imageW
+0001caa0: 6964 7468 2c20 696d 6167 6548 6569 6768  idth, imageHeigh
+0001cab0: 742c 2064 7765 6c6c 5f74 696d 650a 2020  t, dwell_time.  
+0001cac0: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
+0001cad0: 2020 2020 206d 6963 726f 7363 6f70 655f       microscope_
+0001cae0: 7374 6174 6520 3d20 4d69 6372 6f73 636f  state = Microsco
+0001caf0: 7065 5374 6174 6528 0a20 2020 2020 2020  peState(.       
+0001cb00: 2020 2020 2074 696d 6573 7461 6d70 3d64       timestamp=d
+0001cb10: 6174 6574 696d 652e 6461 7465 7469 6d65  atetime.datetime
+0001cb20: 2e74 696d 6573 7461 6d70 2864 6174 6574  .timestamp(datet
+0001cb30: 696d 652e 6461 7465 7469 6d65 2e6e 6f77  ime.datetime.now
+0001cb40: 2829 292c 0a20 2020 2020 2020 2020 2020  ()),.           
+0001cb50: 2061 6273 6f6c 7574 655f 706f 7369 7469   absolute_positi
+0001cb60: 6f6e 3d46 6962 7365 6d53 7461 6765 506f  on=FibsemStagePo
+0001cb70: 7369 7469 6f6e 280a 2020 2020 2020 2020  sition(.        
+0001cb80: 2020 2020 2020 2020 783d 666c 6f61 7428          x=float(
+0001cb90: 696d 6167 652e 4865 6164 6572 5b22 4649  image.Header["FI
+0001cba0: 4222 5d5b 2253 7461 6765 5822 5d29 2c0a  B"]["StageX"]),.
+0001cbb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cbc0: 793d 666c 6f61 7428 696d 6167 652e 4865  y=float(image.He
+0001cbd0: 6164 6572 5b22 4649 4222 5d5b 2253 7461  ader["FIB"]["Sta
+0001cbe0: 6765 5922 5d29 2c0a 2020 2020 2020 2020  geY"]),.        
+0001cbf0: 2020 2020 2020 2020 7a3d 666c 6f61 7428          z=float(
+0001cc00: 696d 6167 652e 4865 6164 6572 5b22 4649  image.Header["FI
+0001cc10: 4222 5d5b 2253 7461 6765 5a22 5d29 2c0a  B"]["StageZ"]),.
+0001cc20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cc30: 723d 666c 6f61 7428 696d 6167 652e 4865  r=float(image.He
+0001cc40: 6164 6572 5b22 4649 4222 5d5b 2253 7461  ader["FIB"]["Sta
+0001cc50: 6765 526f 7461 7469 6f6e 225d 292c 0a20  geRotation"]),. 
+0001cc60: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+0001cc70: 3d66 6c6f 6174 2869 6d61 6765 2e48 6561  =float(image.Hea
+0001cc80: 6465 725b 2246 4942 225d 5b22 5374 6167  der["FIB"]["Stag
+0001cc90: 6554 696c 7422 5d29 2c0a 2020 2020 2020  eTilt"]),.      
+0001cca0: 2020 2020 2020 2020 2020 636f 6f72 6469            coordi
+0001ccb0: 6e61 7465 5f73 7973 7465 6d3d 2252 4157  nate_system="RAW
+0001ccc0: 222c 0a20 2020 2020 2020 2020 2020 2029  ",.            )
+0001ccd0: 2c0a 2020 2020 2020 2020 2020 2020 6562  ,.            eb
+0001cce0: 5f73 6574 7469 6e67 733d 4265 616d 5365  _settings=BeamSe
+0001ccf0: 7474 696e 6773 2862 6561 6d5f 7479 7065  ttings(beam_type
+0001cd00: 3d42 6561 6d54 7970 652e 454c 4543 5452  =BeamType.ELECTR
+0001cd10: 4f4e 292c 0a20 2020 2020 2020 2020 2020  ON),.           
+0001cd20: 2069 625f 7365 7474 696e 6773 3d42 6561   ib_settings=Bea
+0001cd30: 6d53 6574 7469 6e67 7328 0a20 2020 2020  mSettings(.     
+0001cd40: 2020 2020 2020 2020 2020 2062 6561 6d5f             beam_
+0001cd50: 7479 7065 3d42 6561 6d54 7970 652e 494f  type=BeamType.IO
+0001cd60: 4e2c 0a20 2020 2020 2020 2020 2020 2020  N,.             
+0001cd70: 2020 2077 6f72 6b69 6e67 5f64 6973 7461     working_dista
+0001cd80: 6e63 653d 666c 6f61 7428 696d 6167 652e  nce=float(image.
+0001cd90: 4865 6164 6572 5b22 4649 4222 5d5b 2257  Header["FIB"]["W
+0001cda0: 4422 5d29 2c0a 2020 2020 2020 2020 2020  D"]),.          
+0001cdb0: 2020 2020 2020 6265 616d 5f63 7572 7265        beam_curre
+0001cdc0: 6e74 3d66 6c6f 6174 2873 656c 662e 636f  nt=float(self.co
+0001cdd0: 6e6e 6563 7469 6f6e 2e46 4942 2e42 6561  nnection.FIB.Bea
+0001cde0: 6d2e 5265 6164 5072 6f62 6543 7572 7265  m.ReadProbeCurre
+0001cdf0: 6e74 2829 292c 0a20 2020 2020 2020 2020  nt()),.         
+0001ce00: 2020 2020 2020 2072 6573 6f6c 7574 696f         resolutio
+0001ce10: 6e3d 5b69 6d61 6765 5769 6474 682c 2069  n=[imageWidth, i
+0001ce20: 6d61 6765 4865 6967 6874 5d2c 2023 227b  mageHeight], #"{
+0001ce30: 7d78 7b7d 222e 666f 726d 6174 2869 6d61  }x{}".format(ima
+0001ce40: 6765 5769 6474 682c 2069 6d61 6765 4865  geWidth, imageHe
+0001ce50: 6967 6874 292c 0a20 2020 2020 2020 2020  ight),.         
+0001ce60: 2020 2020 2020 2064 7765 6c6c 5f74 696d         dwell_tim
+0001ce70: 653d 666c 6f61 7428 696d 6167 652e 4865  e=float(image.He
+0001ce80: 6164 6572 5b22 4649 4222 5d5b 2244 7765  ader["FIB"]["Dwe
+0001ce90: 6c6c 5469 6d65 225d 292c 0a20 2020 2020  llTime"]),.     
+0001cea0: 2020 2020 2020 2020 2020 2073 7469 676d             stigm
+0001ceb0: 6174 696f 6e3d 506f 696e 7428 0a20 2020  ation=Point(.   
+0001cec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ced0: 2066 6c6f 6174 2869 6d61 6765 2e48 6561   float(image.Hea
+0001cee0: 6465 725b 2246 4942 225d 5b22 5374 6967  der["FIB"]["Stig
+0001cef0: 6d61 746f 7258 225d 292c 0a20 2020 2020  matorX"]),.     
+0001cf00: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0001cf10: 6c6f 6174 2869 6d61 6765 2e48 6561 6465  loat(image.Heade
+0001cf20: 725b 2246 4942 225d 5b22 5374 6967 6d61  r["FIB"]["Stigma
+0001cf30: 746f 7259 225d 292c 0a20 2020 2020 2020  torY"]),.       
+0001cf40: 2020 2020 2020 2020 2029 2c0a 2020 2020           ),.    
+0001cf50: 2020 2020 2020 2020 2020 2020 7368 6966              shif
+0001cf60: 743d 506f 696e 7428 0a20 2020 2020 2020  t=Point(.       
+0001cf70: 2020 2020 2020 2020 2020 2020 2066 6c6f               flo
+0001cf80: 6174 2869 6d61 6765 2e48 6561 6465 725b  at(image.Header[
+0001cf90: 2246 4942 225d 5b22 496d 6167 6553 6869  "FIB"]["ImageShi
+0001cfa0: 6674 5822 5d29 2c0a 2020 2020 2020 2020  ftX"]),.        
+0001cfb0: 2020 2020 2020 2020 2020 2020 666c 6f61              floa
+0001cfc0: 7428 696d 6167 652e 4865 6164 6572 5b22  t(image.Header["
+0001cfd0: 4649 4222 5d5b 2249 6d61 6765 5368 6966  FIB"]["ImageShif
+0001cfe0: 7459 225d 292c 0a20 2020 2020 2020 2020  tY"]),.         
+0001cff0: 2020 2020 2020 2029 2c0a 2020 2020 2020         ),.      
+0001d000: 2020 2020 2020 2020 2020 7363 616e 5f72            scan_r
+0001d010: 6f74 6174 696f 6e3d 7365 6c66 2e63 6f6e  otation=self.con
+0001d020: 6e65 6374 696f 6e2e 4649 422e 4f70 7469  nection.FIB.Opti
+0001d030: 6373 2e47 6574 496d 6167 6552 6f74 6174  cs.GetImageRotat
+0001d040: 696f 6e28 292c 0a20 2020 2020 2020 2020  ion(),.         
+0001d050: 2020 2029 2c0a 2020 2020 2020 2020 290a     ),.        ).
+0001d060: 0a20 2020 2020 2020 2064 6574 6563 746f  .        detecto
+0001d070: 7220 3d20 4669 6273 656d 4465 7465 6374  r = FibsemDetect
+0001d080: 6f72 5365 7474 696e 6773 280a 2020 2020  orSettings(.    
+0001d090: 2020 2020 2020 2020 2020 2020 7479 7065              type
+0001d0a0: 203d 2073 656c 662e 6765 7428 2264 6574   = self.get("det
+0001d0b0: 6563 746f 725f 7479 7065 222c 2069 6d61  ector_type", ima
+0001d0c0: 6765 5f73 6574 7469 6e67 732e 6265 616d  ge_settings.beam
+0001d0d0: 5f74 7970 6529 2c0a 2020 2020 2020 2020  _type),.        
+0001d0e0: 2020 2020 2020 2020 6d6f 6465 203d 2022          mode = "
+0001d0f0: 4e2f 4122 2c0a 2020 2020 2020 2020 2020  N/A",.          
+0001d100: 2020 2020 2020 636f 6e74 7261 7374 203d        contrast =
+0001d110: 2073 656c 662e 6765 7428 2264 6574 6563   self.get("detec
+0001d120: 746f 725f 636f 6e74 7261 7374 222c 2069  tor_contrast", i
+0001d130: 6d61 6765 5f73 6574 7469 6e67 732e 6265  mage_settings.be
+0001d140: 616d 5f74 7970 6529 2c0a 2020 2020 2020  am_type),.      
+0001d150: 2020 2020 2020 2020 2020 6272 6967 6874            bright
+0001d160: 6e65 7373 3d20 7365 6c66 2e67 6574 2822  ness= self.get("
+0001d170: 6465 7465 6374 6f72 5f62 7269 6768 746e  detector_brightn
+0001d180: 6573 7322 2c20 696d 6167 655f 7365 7474  ess", image_sett
+0001d190: 696e 6773 2e62 6561 6d5f 7479 7065 292c  ings.beam_type),
+0001d1a0: 0a0a 2020 2020 2020 2020 2020 2020 290a  ..            ).
+0001d1b0: 2020 2020 2020 2020 696d 6167 655f 7365          image_se
+0001d1c0: 7474 696e 6773 2e72 6573 6f6c 7574 696f  ttings.resolutio
+0001d1d0: 6e20 3d20 5b69 6d61 6765 5769 6474 682c  n = [imageWidth,
+0001d1e0: 2069 6d61 6765 4865 6967 6874 5d0a 2020   imageHeight].  
+0001d1f0: 2020 2020 2020 6669 6273 656d 5f69 6d61        fibsem_ima
+0001d200: 6765 203d 2046 6962 7365 6d49 6d61 6765  ge = FibsemImage
+0001d210: 2e66 726f 6d54 6573 6361 6e49 6d61 6765  .fromTescanImage
+0001d220: 280a 2020 2020 2020 2020 2020 2020 696d  (.            im
+0001d230: 6167 652c 2064 6565 7063 6f70 7928 696d  age, deepcopy(im
+0001d240: 6167 655f 7365 7474 696e 6773 292c 2064  age_settings), d
+0001d250: 6565 7063 6f70 7928 6d69 6372 6f73 636f  eepcopy(microsco
+0001d260: 7065 5f73 7461 7465 292c 2064 6574 6563  pe_state), detec
+0001d270: 746f 723d 2064 6574 6563 746f 720a 2020  tor= detector.  
+0001d280: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
+0001d290: 2023 2066 6962 7365 6d5f 696d 6167 652e   # fibsem_image.
+0001d2a0: 6d65 7461 6461 7461 2e69 6d61 6765 5f73  metadata.image_s
+0001d2b0: 6574 7469 6e67 732e 7265 736f 6c75 7469  ettings.resoluti
+0001d2c0: 6f6e 203d 205b 696d 6167 6557 6964 7468  on = [imageWidth
+0001d2d0: 2c20 696d 6167 6548 6569 6768 745d 0a0a  , imageHeight]..
+0001d2e0: 2020 2020 2020 2020 7265 7475 726e 2066          return f
+0001d2f0: 6962 7365 6d5f 696d 6167 650a 0a20 2020  ibsem_image..   
+0001d300: 2064 6566 206c 6173 745f 696d 6167 6528   def last_image(
+0001d310: 7365 6c66 2c20 6265 616d 5f74 7970 653a  self, beam_type:
+0001d320: 2042 6561 6d54 7970 652e 454c 4543 5452   BeamType.ELECTR
+0001d330: 4f4e 2920 2d3e 2046 6962 7365 6d49 6d61  ON) -> FibsemIma
+0001d340: 6765 3a0a 2020 2020 2020 2020 2222 2220  ge:.        """ 
+0001d350: 2020 200a 2020 2020 2020 2020 5265 7475     .        Retu
+0001d360: 726e 7320 7468 6520 6c61 7374 2061 6371  rns the last acq
+0001d370: 7569 7265 6420 696d 6167 6520 666f 7220  uired image for 
+0001d380: 7468 6520 7370 6563 6966 6965 6420 6265  the specified be
+0001d390: 616d 2074 7970 652e 0a0a 2020 2020 2020  am type...      
+0001d3a0: 2020 4172 6773 3a0a 2020 2020 2020 2020    Args:.        
+0001d3b0: 2020 2020 6265 616d 5f74 7970 6520 2842      beam_type (B
+0001d3c0: 6561 6d54 7970 652e 454c 4543 5452 4f4e  eamType.ELECTRON
+0001d3d0: 206f 7220 4265 616d 5479 7065 2e49 4f4e   or BeamType.ION
+0001d3e0: 293a 2054 6865 2074 7970 6520 6f66 2062  ): The type of b
+0001d3f0: 6561 6d20 7573 6564 2074 6f20 6163 7175  eam used to acqu
+0001d400: 6972 6520 7468 6520 696d 6167 652e 0a0a  ire the image...
+0001d410: 2020 2020 2020 2020 5265 7475 726e 733a          Returns:
+0001d420: 0a20 2020 2020 2020 2020 2020 2046 6962  .            Fib
+0001d430: 7365 6d49 6d61 6765 3a20 5468 6520 6c61  semImage: The la
+0001d440: 7374 2061 6371 7569 7265 6420 696d 6167  st acquired imag
+0001d450: 6520 6f66 2074 6865 2073 7065 6369 6669  e of the specifi
+0001d460: 6564 2062 6561 6d20 7479 7065 2e0a 0a20  ed beam type... 
+0001d470: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+0001d480: 2020 2069 6620 6265 616d 5f74 7970 6520     if beam_type 
+0001d490: 3d3d 2042 6561 6d54 7970 652e 454c 4543  == BeamType.ELEC
+0001d4a0: 5452 4f4e 3a0a 2020 2020 2020 2020 2020  TRON:.          
+0001d4b0: 2020 5f63 6865 636b 5f62 6561 6d28 4265    _check_beam(Be
+0001d4c0: 616d 5479 7065 2e45 4c45 4354 524f 4e2c  amType.ELECTRON,
+0001d4d0: 2073 656c 662e 6861 7264 7761 7265 5f73   self.hardware_s
+0001d4e0: 6574 7469 6e67 7329 0a20 2020 2020 2020  ettings).       
+0001d4f0: 2020 2020 2069 6d61 6765 203d 2073 656c       image = sel
+0001d500: 662e 6c61 7374 5f69 6d61 6765 5f65 620a  f.last_image_eb.
+0001d510: 2020 2020 2020 2020 656c 6966 2062 6561          elif bea
+0001d520: 6d5f 7479 7065 203d 3d20 4265 616d 5479  m_type == BeamTy
+0001d530: 7065 2e49 4f4e 3a0a 2020 2020 2020 2020  pe.ION:.        
+0001d540: 2020 2020 5f63 6865 636b 5f62 6561 6d28      _check_beam(
+0001d550: 4265 616d 5479 7065 2e49 4f4e 2c20 7365  BeamType.ION, se
+0001d560: 6c66 2e68 6172 6477 6172 655f 7365 7474  lf.hardware_sett
+0001d570: 696e 6773 290a 2020 2020 2020 2020 2020  ings).          
+0001d580: 2020 696d 6167 6520 3d20 7365 6c66 2e6c    image = self.l
+0001d590: 6173 745f 696d 6167 655f 6962 0a20 2020  ast_image_ib.   
+0001d5a0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+0001d5b0: 2020 2020 2020 2072 6169 7365 2045 7863         raise Exc
+0001d5c0: 6570 7469 6f6e 2822 4265 616d 2074 7970  eption("Beam typ
+0001d5d0: 6520 6572 726f 7222 290a 2020 2020 2020  e error").      
+0001d5e0: 2020 7265 7475 726e 2069 6d61 6765 0a0a    return image..
+0001d5f0: 2020 2020 6465 6620 5f67 6574 5f70 7265      def _get_pre
+0001d600: 7365 7473 2873 656c 6629 3a0a 2020 2020  sets(self):.    
+0001d610: 2020 2020 7072 6573 6574 7320 3d20 7365      presets = se
+0001d620: 6c66 2e63 6f6e 6e65 6374 696f 6e2e 4649  lf.connection.FI
+0001d630: 422e 5072 6573 6574 2e45 6e75 6d28 2909  B.Preset.Enum().
+0001d640: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0001d650: 7072 6573 6574 730a 0a20 2020 2064 6566  presets..    def
+0001d660: 2061 7574 6f63 6f6e 7472 6173 7428 7365   autocontrast(se
+0001d670: 6c66 2c20 6265 616d 5f74 7970 653a 2042  lf, beam_type: B
+0001d680: 6561 6d54 7970 6529 202d 3e20 4e6f 6e65  eamType) -> None
+0001d690: 3a0a 2020 2020 2020 2020 2222 2241 7574  :.        """Aut
+0001d6a0: 6f6d 6174 6963 616c 6c79 2061 646a 7573  omatically adjus
+0001d6b0: 7420 7468 6520 6d69 6372 6f73 636f 7065  t the microscope
+0001d6c0: 2069 6d61 6765 2063 6f6e 7472 6173 7420   image contrast 
+0001d6d0: 666f 7220 7468 6520 7370 6563 6966 6965  for the specifie
+0001d6e0: 6420 6265 616d 2074 7970 652e 0a0a 2020  d beam type...  
+0001d6f0: 2020 2020 2020 4172 6773 3a0a 2020 2020        Args:.    
+0001d700: 2020 2020 2020 2020 6265 616d 5f74 7970          beam_typ
+0001d710: 6520 2842 6561 6d54 7970 652c 206f 7074  e (BeamType, opt
+0001d720: 696f 6e61 6c29 3a20 5468 6520 696d 6167  ional): The imag
+0001d730: 696e 6720 6265 616d 2074 7970 6520 666f  ing beam type fo
+0001d740: 7220 7768 6963 6820 746f 2061 646a 7573  r which to adjus
+0001d750: 7420 7468 6520 636f 6e74 7261 7374 2e0a  t the contrast..
+0001d760: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d770: 4465 6661 756c 7473 2074 6f20 4265 616d  Defaults to Beam
+0001d780: 5479 7065 2e45 4c45 4354 524f 4e2e 0a0a  Type.ELECTRON...
+0001d790: 2020 2020 2020 2020 5265 7475 726e 733a          Returns:
+0001d7a0: 0a20 2020 2020 2020 2020 2020 204e 6f6e  .            Non
+0001d7b0: 650a 0a20 2020 2020 2020 2045 7861 6d70  e..        Examp
+0001d7c0: 6c65 3a0a 2020 2020 2020 2020 2020 2020  le:.            
+0001d7d0: 546f 2061 7574 6f6d 6174 6963 616c 6c79  To automatically
+0001d7e0: 2061 646a 7573 7420 7468 6520 696d 6167   adjust the imag
+0001d7f0: 6520 636f 6e74 7261 7374 2066 6f72 2061  e contrast for a
+0001d800: 6e20 696f 6e20 6265 616d 2074 7970 653a  n ion beam type:
+0001d810: 0a0a 2020 2020 2020 2020 2020 2020 3e3e  ..            >>
+0001d820: 3e20 6d69 6372 6f73 636f 7065 203d 2054  > microscope = T
+0001d830: 6573 6361 6e4d 6963 726f 7363 6f70 6528  escanMicroscope(
+0001d840: 290a 2020 2020 2020 2020 2020 2020 3e3e  ).            >>
+0001d850: 3e20 6d69 6372 6f73 636f 7065 2e63 6f6e  > microscope.con
+0001d860: 6e65 6374 5f74 6f5f 6d69 6372 6f73 636f  nect_to_microsco
+0001d870: 7065 2829 0a20 2020 2020 2020 2023 2020  pe().        #  
+0001d880: 2020 203e 3e3e 206d 6963 726f 7363 6f70     >>> microscop
+0001d890: 652e 6175 746f 636f 6e74 7261 7374 2862  e.autocontrast(b
+0001d8a0: 6561 6d5f 7479 7065 3d42 6561 6d54 7970  eam_type=BeamTyp
+0001d8b0: 652e 494f 4e29 0a0a 0a20 2020 2020 2020  e.ION)...       
+0001d8c0: 2023 2022 2222 0a20 2020 2020 2020 205f   # """.        _
+0001d8d0: 6368 6563 6b5f 6265 616d 2862 6561 6d5f  check_beam(beam_
+0001d8e0: 7479 7065 2c20 7365 6c66 2e68 6172 6477  type, self.hardw
+0001d8f0: 6172 655f 7365 7474 696e 6773 290a 2020  are_settings).  
+0001d900: 2020 2020 2020 6c6f 6767 696e 672e 696e        logging.in
+0001d910: 666f 2866 2252 756e 6e69 6e67 2061 7574  fo(f"Running aut
+0001d920: 6f63 6f6e 7472 6173 7420 6f6e 207b 6265  ocontrast on {be
+0001d930: 616d 5f74 7970 652e 6e61 6d65 7d2e 2229  am_type.name}.")
+0001d940: 0a20 2020 2020 2020 2069 6620 6265 616d  .        if beam
+0001d950: 5f74 7970 6520 3d3d 2042 6561 6d54 7970  _type == BeamTyp
+0001d960: 652e 454c 4543 5452 4f4e 3a0a 2020 2020  e.ELECTRON:.    
+0001d970: 2020 2020 2020 2020 7365 6c66 2e63 6f6e          self.con
+0001d980: 6e65 6374 696f 6e2e 5345 4d2e 4465 7465  nection.SEM.Dete
+0001d990: 6374 6f72 2e41 7574 6f53 6967 6e61 6c28  ctor.AutoSignal(
+0001d9a0: 4465 7465 6374 6f72 3d73 656c 662e 656c  Detector=self.el
+0001d9b0: 6563 7472 6f6e 5f64 6574 6563 746f 725f  ectron_detector_
+0001d9c0: 6163 7469 7665 290a 2020 2020 2020 2020  active).        
+0001d9d0: 6966 2062 6561 6d5f 7479 7065 203d 3d20  if beam_type == 
+0001d9e0: 4265 616d 5479 7065 2e49 4f4e 3a0a 2020  BeamType.ION:.  
+0001d9f0: 2020 2020 2020 2020 2020 7365 6c66 2e63            self.c
+0001da00: 6f6e 6e65 6374 696f 6e2e 4649 422e 4465  onnection.FIB.De
+0001da10: 7465 6374 6f72 2e41 7574 6f53 6967 6e61  tector.AutoSigna
+0001da20: 6c28 4465 7465 6374 6f72 3d73 656c 662e  l(Detector=self.
+0001da30: 696f 6e5f 6465 7465 6374 6f72 5f61 6374  ion_detector_act
+0001da40: 6976 6529 0a0a 2020 2020 0a20 2020 2064  ive)..    .    d
+0001da50: 6566 2061 7574 6f5f 666f 6375 7328 7365  ef auto_focus(se
+0001da60: 6c66 2c20 6265 616d 5f74 7970 653a 2042  lf, beam_type: B
+0001da70: 6561 6d54 7970 6529 202d 3e20 4e6f 6e65  eamType) -> None
+0001da80: 3a0a 2020 2020 2020 2020 5f63 6865 636b  :.        _check
+0001da90: 5f62 6561 6d28 6265 616d 5f74 7970 652c  _beam(beam_type,
+0001daa0: 2073 656c 662e 6861 7264 7761 7265 5f73   self.hardware_s
+0001dab0: 6574 7469 6e67 7329 0a20 2020 2020 2020  ettings).       
+0001dac0: 2069 6620 6265 616d 5f74 7970 6520 3d3d   if beam_type ==
+0001dad0: 2042 6561 6d54 7970 652e 454c 4543 5452   BeamType.ELECTR
+0001dae0: 4f4e 3a0a 2020 2020 2020 2020 2020 2020  ON:.            
+0001daf0: 6c6f 6767 696e 672e 696e 666f 2822 5275  logging.info("Ru
+0001db00: 6e6e 696e 6720 6175 746f 666f 6375 7320  nning autofocus 
+0001db10: 6f6e 2065 6c65 6374 726f 6e20 6265 616d  on electron beam
+0001db20: 2e22 290a 2020 2020 2020 2020 2020 2020  .").            
+0001db30: 7365 6c66 2e63 6f6e 6e65 6374 696f 6e2e  self.connection.
+0001db40: 5345 4d2e 4175 746f 5744 4669 6e65 2873  SEM.AutoWDFine(s
+0001db50: 656c 662e 656c 6563 7472 6f6e 5f64 6574  elf.electron_det
+0001db60: 6563 746f 725f 6163 7469 7665 290a 2020  ector_active).  
+0001db70: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+0001db80: 2020 2020 2020 2020 6c6f 6767 696e 672e          logging.
+0001db90: 696e 666f 2822 4175 746f 2066 6f63 7573  info("Auto focus
+0001dba0: 2069 7320 6e6f 7420 7375 7070 6f72 7465   is not supporte
+0001dbb0: 6420 666f 7220 696f 6e20 6265 616d 2074  d for ion beam t
+0001dbc0: 7970 652e 2229 0a20 2020 2020 2020 2072  ype.").        r
+0001dbd0: 6574 7572 6e20 0a0a 2020 2020 6465 6620  eturn ..    def 
+0001dbe0: 7265 7365 745f 6265 616d 5f73 6869 6674  reset_beam_shift
+0001dbf0: 7328 7365 6c66 293a 0a20 2020 2020 2020  s(self):.       
+0001dc00: 2022 2222 0a20 2020 2020 2020 2053 6574   """.        Set
+0001dc10: 2074 6865 2062 6561 6d20 7368 6966 7420   the beam shift 
+0001dc20: 746f 207a 6572 6f20 666f 7220 7468 6520  to zero for the 
+0001dc30: 656c 6563 7472 6f6e 2061 6e64 2069 6f6e  electron and ion
+0001dc40: 2062 6561 6d73 2e0a 0a20 2020 2020 2020   beams...       
+0001dc50: 2052 6573 6574 7320 7468 6520 6265 616d   Resets the beam
+0001dc60: 2073 6869 6674 2066 6f72 2062 6f74 6820   shift for both 
+0001dc70: 7468 6520 656c 6563 7472 6f6e 2061 6e64  the electron and
+0001dc80: 2069 6f6e 2062 6561 6d73 2074 6f20 2830   ion beams to (0
+0001dc90: 2c30 292c 2065 6666 6563 7469 7665 6c79  ,0), effectively
+0001dca0: 2063 656e 7465 7269 6e67 2074 6865 2062   centering the b
+0001dcb0: 6561 6d73 206f 6e20 7468 6520 7361 6d70  eams on the samp
+0001dcc0: 6c65 2e0a 0a20 2020 2020 2020 2041 7267  le...        Arg
+0001dcd0: 733a 0a20 2020 2020 2020 2020 2020 2073  s:.            s
+0001dce0: 656c 6620 2846 6962 7365 6d4d 6963 726f  elf (FibsemMicro
+0001dcf0: 7363 6f70 6529 3a20 696e 7374 616e 6365  scope): instance
+0001dd00: 206f 6620 7468 6520 4669 6273 656d 4d69   of the FibsemMi
+0001dd10: 6372 6f73 636f 7065 206f 626a 6563 740a  croscope object.
+0001dd20: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+0001dd30: 2020 2020 5f63 6865 636b 5f62 6561 6d28      _check_beam(
+0001dd40: 4265 616d 5479 7065 2e45 4c45 4354 524f  BeamType.ELECTRO
+0001dd50: 4e2c 2073 656c 662e 6861 7264 7761 7265  N, self.hardware
+0001dd60: 5f73 6574 7469 6e67 7329 0a20 2020 2020  _settings).     
+0001dd70: 2020 206c 6f67 6769 6e67 2e64 6562 7567     logging.debug
+0001dd80: 280a 2020 2020 2020 2020 2020 2020 6622  (.            f"
+0001dd90: 7265 7365 7469 6e67 2065 6265 616d 2073  reseting ebeam s
+0001dda0: 6869 6674 2074 6f20 2830 2c20 3029 2066  hift to (0, 0) f
+0001ddb0: 726f 6d3a 207b 7365 6c66 2e63 6f6e 6e65  rom: {self.conne
+0001ddc0: 6374 696f 6e2e 4649 422e 4f70 7469 6373  ction.FIB.Optics
+0001ddd0: 2e47 6574 496d 6167 6553 6869 6674 2829  .GetImageShift()
+0001dde0: 7d20 286d 6d29 220a 2020 2020 2020 2020  } (mm)".        
+0001ddf0: 290a 2020 2020 2020 2020 7365 6c66 2e63  ).        self.c
+0001de00: 6f6e 6e65 6374 696f 6e2e 4649 422e 4f70  onnection.FIB.Op
+0001de10: 7469 6373 2e53 6574 496d 6167 6553 6869  tics.SetImageShi
+0001de20: 6674 2830 2c20 3029 0a20 2020 2020 2020  ft(0, 0).       
+0001de30: 205f 6368 6563 6b5f 6265 616d 2842 6561   _check_beam(Bea
+0001de40: 6d54 7970 652e 494f 4e2c 2073 656c 662e  mType.ION, self.
+0001de50: 6861 7264 7761 7265 5f73 6574 7469 6e67  hardware_setting
+0001de60: 7329 0a20 2020 2020 2020 206c 6f67 6769  s).        loggi
+0001de70: 6e67 2e64 6562 7567 280a 2020 2020 2020  ng.debug(.      
+0001de80: 2020 2020 2020 6622 7265 7365 7469 6e67        f"reseting
+0001de90: 2065 6265 616d 2073 6869 6674 2074 6f20   ebeam shift to 
+0001dea0: 2830 2c20 3029 2066 726f 6d3a 207b 7365  (0, 0) from: {se
+0001deb0: 6c66 2e63 6f6e 6e65 6374 696f 6e2e 5345  lf.connection.SE
+0001dec0: 4d2e 4f70 7469 6373 2e47 6574 496d 6167  M.Optics.GetImag
+0001ded0: 6553 6869 6674 2829 7d20 286d 6d29 220a  eShift()} (mm)".
+0001dee0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+0001def0: 2020 7365 6c66 2e63 6f6e 6e65 6374 696f    self.connectio
+0001df00: 6e2e 5345 4d2e 4f70 7469 6373 2e53 6574  n.SEM.Optics.Set
+0001df10: 496d 6167 6553 6869 6674 2830 2c20 3029  ImageShift(0, 0)
+0001df20: 0a0a 0a20 2020 2064 6566 2062 6561 6d5f  ...    def beam_
+0001df30: 7368 6966 7428 7365 6c66 2c20 6478 3a20  shift(self, dx: 
+0001df40: 666c 6f61 742c 2064 793a 2066 6c6f 6174  float, dy: float
+0001df50: 2c20 6265 616d 5f74 7970 653a 2042 6561  , beam_type: Bea
+0001df60: 6d54 7970 6520 3d20 4265 616d 5479 7065  mType = BeamType
+0001df70: 2e49 4f4e 293a 0a20 2020 2020 2020 2022  .ION):.        "
+0001df80: 2222 4164 6a75 7374 7320 7468 6520 6265  ""Adjusts the be
+0001df90: 616d 2073 6869 6674 2062 6173 6564 206f  am shift based o
+0001dfa0: 6e20 7265 6c61 7469 7665 2076 616c 7565  n relative value
+0001dfb0: 7320 7468 6174 2061 7265 2070 726f 7669  s that are provi
+0001dfc0: 6465 642e 0a20 2020 2020 2020 200a 2020  ded..        .  
+0001dfd0: 2020 2020 2020 4172 6773 3a0a 2020 2020        Args:.    
+0001dfe0: 2020 2020 2020 2020 7365 6c66 2028 4669          self (Fi
+0001dff0: 6273 656d 4d69 6372 6f73 636f 7065 293a  bsemMicroscope):
+0001e000: 2046 6962 7365 6d20 6d69 6372 6f73 636f   Fibsem microsco
+0001e010: 7065 206f 626a 6563 740a 2020 2020 2020  pe object.      
+0001e020: 2020 2020 2020 6478 2028 666c 6f61 7429        dx (float)
+0001e030: 3a20 7468 6520 7265 6c61 7469 7665 2078  : the relative x
+0001e040: 2074 6572 6d0a 2020 2020 2020 2020 2020   term.          
+0001e050: 2020 6479 2028 666c 6f61 7429 3a20 7468    dy (float): th
+0001e060: 6520 7265 6c61 7469 7665 2079 2074 6572  e relative y ter
+0001e070: 6d0a 2020 2020 2020 2020 2222 220a 2020  m.        """.  
+0001e080: 2020 2020 2020 5f63 6865 636b 5f62 6561        _check_bea
+0001e090: 6d28 6265 616d 5f74 7970 652c 2073 656c  m(beam_type, sel
+0001e0a0: 662e 6861 7264 7761 7265 5f73 6574 7469  f.hardware_setti
+0001e0b0: 6e67 7329 0a20 2020 2020 2020 2069 6620  ngs).        if 
+0001e0c0: 6265 616d 5f74 7970 6520 3d3d 2042 6561  beam_type == Bea
+0001e0d0: 6d54 7970 652e 494f 4e3a 0a20 2020 2020  mType.ION:.     
+0001e0e0: 2020 2020 2020 2062 6561 6d20 3d20 7365         beam = se
+0001e0f0: 6c66 2e63 6f6e 6e65 6374 696f 6e2e 4649  lf.connection.FI
+0001e100: 422e 4f70 7469 6373 0a20 2020 2020 2020  B.Optics.       
+0001e110: 2065 6c69 6620 6265 616d 5f74 7970 6520   elif beam_type 
+0001e120: 3d3d 2042 6561 6d54 7970 652e 454c 4543  == BeamType.ELEC
+0001e130: 5452 4f4e 3a0a 2020 2020 2020 2020 2020  TRON:.          
+0001e140: 2020 6265 616d 203d 2073 656c 662e 636f    beam = self.co
+0001e150: 6e6e 6563 7469 6f6e 2e53 454d 2e4f 7074  nnection.SEM.Opt
+0001e160: 6963 730a 2020 2020 2020 2020 6c6f 6767  ics.        logg
+0001e170: 696e 672e 696e 666f 2866 227b 6265 616d  ing.info(f"{beam
+0001e180: 5f74 7970 652e 6e61 6d65 7d20 7368 6966  _type.name} shif
+0001e190: 7469 6e67 2062 7920 287b 6478 7d2c 207b  ting by ({dx}, {
+0001e1a0: 6479 7d29 2229 0a20 2020 2020 2020 206c  dy})").        l
+0001e1b0: 6f67 6769 6e67 2e64 6562 7567 2866 227b  ogging.debug(f"{
+0001e1c0: 6265 616d 5f74 7970 652e 6e61 6d65 7d20  beam_type.name} 
+0001e1d0: 7c20 7b64 787d 7c7b 6479 7d22 2920 0a20  | {dx}|{dy}") . 
+0001e1e0: 2020 2020 2020 2078 2c20 7920 3d20 6265         x, y = be
+0001e1f0: 616d 2e47 6574 496d 6167 6553 6869 6674  am.GetImageShift
+0001e200: 2829 0a20 2020 2020 2020 2064 7820 2a3d  ().        dx *=
+0001e210: 2020 636f 6e73 7461 6e74 732e 4d45 5452    constants.METR
+0001e220: 455f 544f 5f4d 494c 4c49 4d45 5452 4520  E_TO_MILLIMETRE 
+0001e230: 2320 436f 6e76 6572 7420 746f 206d 6d20  # Convert to mm 
+0001e240: 6672 6f6d 206d 2e0a 2020 2020 2020 2020  from m..        
+0001e250: 6479 202a 3d20 2063 6f6e 7374 616e 7473  dy *=  constants
+0001e260: 2e4d 4554 5245 5f54 4f5f 4d49 4c4c 494d  .METRE_TO_MILLIM
+0001e270: 4554 5245 0a20 2020 2020 2020 2078 202b  ETRE.        x +
+0001e280: 3d20 6478 200a 2020 2020 2020 2020 7920  = dx .        y 
+0001e290: 2b3d 2064 790a 2020 2020 2020 2020 6265  += dy.        be
+0001e2a0: 616d 2e53 6574 496d 6167 6553 6869 6674  am.SetImageShift
+0001e2b0: 2878 2c79 2920 0a20 2020 2020 2020 200a  (x,y) .        .
+0001e2c0: 2020 2020 6465 6620 6765 745f 7374 6167      def get_stag
+0001e2d0: 655f 706f 7369 7469 6f6e 2873 656c 6629  e_position(self)
+0001e2e0: 3a0a 2020 2020 2020 2020 2222 220a 2020  :.        """.  
+0001e2f0: 2020 2020 2020 4765 7420 7468 6520 6375        Get the cu
+0001e300: 7272 656e 7420 7374 6167 6520 706f 7369  rrent stage posi
+0001e310: 7469 6f6e 2e0a 0a20 2020 2020 2020 2054  tion...        T
+0001e320: 6869 7320 6d65 7468 6f64 2072 6574 7269  his method retri
+0001e330: 6576 6573 2074 6865 2063 7572 7265 6e74  eves the current
+0001e340: 2073 7461 6765 2070 6f73 6974 696f 6e20   stage position 
+0001e350: 6672 6f6d 2074 6865 206d 6963 726f 7363  from the microsc
+0001e360: 6f70 6520 616e 6420 7265 7475 726e 7320  ope and returns 
+0001e370: 6974 2061 730a 2020 2020 2020 2020 6120  it as.        a 
+0001e380: 4669 6273 656d 5374 6167 6550 6f73 6974  FibsemStagePosit
+0001e390: 696f 6e20 6f62 6a65 6374 2e0a 0a20 2020  ion object...   
+0001e3a0: 2020 2020 2052 6574 7572 6e73 3a0a 2020       Returns:.  
+0001e3b0: 2020 2020 2020 2020 2020 4669 6273 656d            Fibsem
+0001e3c0: 5374 6167 6550 6f73 6974 696f 6e3a 2054  StagePosition: T
+0001e3d0: 6865 2063 7572 7265 6e74 2073 7461 6765  he current stage
+0001e3e0: 2070 6f73 6974 696f 6e2e 0a20 2020 2020   position..     
+0001e3f0: 2020 2022 2222 0a20 2020 2020 2020 2069     """.        i
+0001e400: 6620 7365 6c66 2e68 6172 6477 6172 655f  f self.hardware_
+0001e410: 7365 7474 696e 6773 2e73 7461 6765 5f65  settings.stage_e
+0001e420: 6e61 626c 6564 2069 7320 4661 6c73 653a  nabled is False:
+0001e430: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
+0001e440: 7365 204e 6f74 496d 706c 656d 656e 7465  se NotImplemente
+0001e450: 6445 7272 6f72 2822 5374 6167 6520 6973  dError("Stage is
+0001e460: 206e 6f74 2065 6e61 626c 6564 2e22 290a   not enabled.").
+0001e470: 2020 2020 2020 2020 782c 2079 2c20 7a2c          x, y, z,
+0001e480: 2072 2c20 7420 3d20 7365 6c66 2e63 6f6e   r, t = self.con
+0001e490: 6e65 6374 696f 6e2e 5374 6167 652e 4765  nection.Stage.Ge
+0001e4a0: 7450 6f73 6974 696f 6e28 290a 2020 2020  tPosition().    
+0001e4b0: 2020 2020 7374 6167 655f 706f 7369 7469      stage_positi
+0001e4c0: 6f6e 203d 2046 6962 7365 6d53 7461 6765  on = FibsemStage
+0001e4d0: 506f 7369 7469 6f6e 280a 2020 2020 2020  Position(.      
+0001e4e0: 2020 2020 2020 7820 3d20 7820 2a20 636f        x = x * co
+0001e4f0: 6e73 7461 6e74 732e 4d49 4c4c 494d 4554  nstants.MILLIMET
+0001e500: 5245 5f54 4f5f 4d45 5452 452c 0a20 2020  RE_TO_METRE,.   
+0001e510: 2020 2020 2020 2020 2079 203d 2079 202a           y = y *
+0001e520: 2063 6f6e 7374 616e 7473 2e4d 494c 4c49   constants.MILLI
+0001e530: 4d45 5452 455f 544f 5f4d 4554 5245 2c0a  METRE_TO_METRE,.
+0001e540: 2020 2020 2020 2020 2020 2020 7a20 3d20              z = 
+0001e550: 7a20 2a20 636f 6e73 7461 6e74 732e 4d49  z * constants.MI
+0001e560: 4c4c 494d 4554 5245 5f54 4f5f 4d45 5452  LLIMETRE_TO_METR
+0001e570: 452c 0a20 2020 2020 2020 2020 2020 2072  E,.            r
+0001e580: 203d 2072 202a 2063 6f6e 7374 616e 7473   = r * constants
+0001e590: 2e44 4547 5245 4553 5f54 4f5f 5241 4449  .DEGREES_TO_RADI
+0001e5a0: 414e 532c 0a20 2020 2020 2020 2020 2020  ANS,.           
+0001e5b0: 2074 203d 2074 202a 2063 6f6e 7374 616e   t = t * constan
+0001e5c0: 7473 2e44 4547 5245 4553 5f54 4f5f 5241  ts.DEGREES_TO_RA
+0001e5d0: 4449 414e 532c 0a20 2020 2020 2020 2020  DIANS,.         
+0001e5e0: 2020 2063 6f6f 7264 696e 6174 655f 7379     coordinate_sy
+0001e5f0: 7374 656d 3d20 2252 4157 222c 0a20 2020  stem= "RAW",.   
+0001e600: 2020 2020 2029 0a20 2020 2020 2020 2072       ).        r
+0001e610: 6574 7572 6e20 7374 6167 655f 706f 7369  eturn stage_posi
+0001e620: 7469 6f6e 0a0a 2020 2020 6465 6620 6765  tion..    def ge
+0001e630: 745f 6375 7272 656e 745f 6d69 6372 6f73  t_current_micros
+0001e640: 636f 7065 5f73 7461 7465 2873 656c 6629  cope_state(self)
+0001e650: 202d 3e20 4d69 6372 6f73 636f 7065 5374   -> MicroscopeSt
+0001e660: 6174 653a 0a20 2020 2020 2020 2022 2222  ate:.        """
+0001e670: 0a20 2020 2020 2020 2047 6574 2074 6865  .        Get the
+0001e680: 2063 7572 7265 6e74 206d 6963 726f 7363   current microsc
+0001e690: 6f70 6520 7374 6174 650a 0a20 2020 2020  ope state..     
+0001e6a0: 2020 2054 6869 7320 6d65 7468 6f64 2072     This method r
+0001e6b0: 6574 7269 6576 6573 2074 6865 2063 7572  etrieves the cur
+0001e6c0: 7265 6e74 206d 6963 726f 7363 6f70 6520  rent microscope 
+0001e6d0: 7374 6174 6520 6672 6f6d 2074 6865 206d  state from the m
+0001e6e0: 6963 726f 7363 6f70 6520 616e 6420 7265  icroscope and re
+0001e6f0: 7475 726e 7320 6974 2061 730a 2020 2020  turns it as.    
+0001e700: 2020 2020 6120 4d69 6372 6f73 636f 7065      a Microscope
+0001e710: 5374 6174 6520 6f62 6a65 6374 2e0a 0a20  State object... 
+0001e720: 2020 2020 2020 2052 6574 7572 6e73 3a0a         Returns:.
+0001e730: 2020 2020 2020 2020 2020 2020 4d69 6372              Micr
+0001e740: 6f73 636f 7065 5374 6174 653a 2063 7572  oscopeState: cur
+0001e750: 7265 6e74 206d 6963 726f 7363 6f70 6520  rent microscope 
+0001e760: 7374 6174 650a 2020 2020 2020 2020 2222  state.        ""
+0001e770: 220a 0a20 2020 2020 2020 2069 6620 7365  "..        if se
+0001e780: 6c66 2e68 6172 6477 6172 655f 7365 7474  lf.hardware_sett
+0001e790: 696e 6773 2e65 6c65 6374 726f 6e5f 6265  ings.electron_be
+0001e7a0: 616d 2069 7320 5472 7565 3a0a 2020 2020  am is True:.    
+0001e7b0: 2020 2020 2020 2020 696d 6167 655f 6562          image_eb
+0001e7c0: 203d 2073 656c 662e 6c61 7374 5f69 6d61   = self.last_ima
+0001e7d0: 6765 2842 6561 6d54 7970 652e 454c 4543  ge(BeamType.ELEC
+0001e7e0: 5452 4f4e 290a 2020 2020 2020 2020 2020  TRON).          
+0001e7f0: 2020 6966 2069 6d61 6765 5f65 6220 6973    if image_eb is
+0001e800: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
+0001e810: 2020 2020 2020 2020 2020 2065 625f 7365             eb_se
+0001e820: 7474 696e 6773 203d 2042 6561 6d53 6574  ttings = BeamSet
+0001e830: 7469 6e67 7328 0a20 2020 2020 2020 2020  tings(.         
+0001e840: 2020 2020 2020 2062 6561 6d5f 7479 7065         beam_type
+0001e850: 3d42 6561 6d54 7970 652e 454c 4543 5452  =BeamType.ELECTR
+0001e860: 4f4e 2c0a 2020 2020 2020 2020 2020 2020  ON,.            
+0001e870: 2020 2020 776f 726b 696e 675f 6469 7374      working_dist
+0001e880: 616e 6365 3d73 656c 662e 636f 6e6e 6563  ance=self.connec
+0001e890: 7469 6f6e 2e53 454d 2e4f 7074 6963 732e  tion.SEM.Optics.
+0001e8a0: 4765 7457 4428 2920 2a20 636f 6e73 7461  GetWD() * consta
+0001e8b0: 6e74 732e 4d49 4c4c 494d 4554 5245 5f54  nts.MILLIMETRE_T
+0001e8c0: 4f5f 4d45 5452 452c 0a20 2020 2020 2020  O_METRE,.       
+0001e8d0: 2020 2020 2020 2020 2062 6561 6d5f 6375           beam_cu
+0001e8e0: 7272 656e 743d 7365 6c66 2e63 6f6e 6e65  rrent=self.conne
+0001e8f0: 6374 696f 6e2e 5345 4d2e 4265 616d 2e47  ction.SEM.Beam.G
+0001e900: 6574 4375 7272 656e 7428 2920 2a20 636f  etCurrent() * co
+0001e910: 6e73 7461 6e74 732e 5049 434f 5f54 4f5f  nstants.PICO_TO_
+0001e920: 5349 2c0a 2020 2020 2020 2020 2020 2020  SI,.            
+0001e930: 2020 2020 766f 6c74 6167 653d 7365 6c66      voltage=self
+0001e940: 2e63 6f6e 6e65 6374 696f 6e2e 5345 4d2e  .connection.SEM.
+0001e950: 4265 616d 2e47 6574 566f 6c74 6167 6528  Beam.GetVoltage(
+0001e960: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+0001e970: 2020 2068 6677 3d73 656c 662e 636f 6e6e     hfw=self.conn
+0001e980: 6563 7469 6f6e 2e53 454d 2e4f 7074 6963  ection.SEM.Optic
+0001e990: 732e 4765 7456 6965 7766 6965 6c64 2829  s.GetViewfield()
+0001e9a0: 202a 2063 6f6e 7374 616e 7473 2e4d 494c   * constants.MIL
+0001e9b0: 4c49 4d45 5452 455f 544f 5f4d 4554 5245  LIMETRE_TO_METRE
+0001e9c0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0001e9d0: 2020 7265 736f 6c75 7469 6f6e 3d69 6d61    resolution=ima
+0001e9e0: 6765 5f65 622e 6d65 7461 6461 7461 2e69  ge_eb.metadata.i
+0001e9f0: 6d61 6765 5f73 6574 7469 6e67 732e 7265  mage_settings.re
+0001ea00: 736f 6c75 7469 6f6e 2c20 2023 2054 4f44  solution,  # TOD
+0001ea10: 4f20 6669 7820 7468 6573 6520 656d 7074  O fix these empt
+0001ea20: 7920 7061 7261 6d65 7465 7273 0a20 2020  y parameters.   
+0001ea30: 2020 2020 2020 2020 2020 2020 2064 7765               dwe
+0001ea40: 6c6c 5f74 696d 653d 696d 6167 655f 6562  ll_time=image_eb
+0001ea50: 2e6d 6574 6164 6174 612e 696d 6167 655f  .metadata.image_
+0001ea60: 7365 7474 696e 6773 2e64 7765 6c6c 5f74  settings.dwell_t
+0001ea70: 696d 652c 0a20 2020 2020 2020 2020 2020  ime,.           
+0001ea80: 2020 2020 2073 7469 676d 6174 696f 6e3d       stigmation=
+0001ea90: 696d 6167 655f 6562 2e6d 6574 6164 6174  image_eb.metadat
+0001eaa0: 612e 6d69 6372 6f73 636f 7065 5f73 7461  a.microscope_sta
+0001eab0: 7465 2e65 625f 7365 7474 696e 6773 2e73  te.eb_settings.s
+0001eac0: 7469 676d 6174 696f 6e2c 0a20 2020 2020  tigmation,.     
+0001ead0: 2020 2020 2020 2020 2020 2073 6869 6674             shift
+0001eae0: 3d69 6d61 6765 5f65 622e 6d65 7461 6461  =image_eb.metada
+0001eaf0: 7461 2e6d 6963 726f 7363 6f70 655f 7374  ta.microscope_st
+0001eb00: 6174 652e 6562 5f73 6574 7469 6e67 732e  ate.eb_settings.
+0001eb10: 7368 6966 742c 0a20 2020 2020 2020 2020  shift,.         
+0001eb20: 2020 2020 2020 2073 6361 6e5f 726f 7461         scan_rota
+0001eb30: 7469 6f6e 3d73 656c 662e 636f 6e6e 6563  tion=self.connec
+0001eb40: 7469 6f6e 2e53 454d 2e4f 7074 6963 732e  tion.SEM.Optics.
+0001eb50: 4765 7449 6d61 6765 526f 7461 7469 6f6e  GetImageRotation
+0001eb60: 2829 0a20 2020 2020 2020 2020 2020 2029  ().            )
+0001eb70: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
+0001eb80: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+0001eb90: 2020 2065 625f 7365 7474 696e 6773 203d     eb_settings =
+0001eba0: 2042 6561 6d53 6574 7469 6e67 7328 4265   BeamSettings(Be
+0001ebb0: 616d 5479 7065 2e45 4c45 4354 524f 4e29  amType.ELECTRON)
+0001ebc0: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+0001ebd0: 2020 2020 2020 2020 2020 2065 625f 7365             eb_se
+0001ebe0: 7474 696e 6773 203d 2042 6561 6d53 6574  ttings = BeamSet
+0001ebf0: 7469 6e67 7328 4265 616d 5479 7065 2e45  tings(BeamType.E
+0001ec00: 4c45 4354 524f 4e29 0a20 2020 2020 2020  LECTRON).       
+0001ec10: 200a 2020 2020 2020 2020 6966 2073 656c   .        if sel
+0001ec20: 662e 6861 7264 7761 7265 5f73 6574 7469  f.hardware_setti
+0001ec30: 6e67 732e 696f 6e5f 6265 616d 2069 7320  ngs.ion_beam is 
+0001ec40: 5472 7565 3a0a 2020 2020 2020 2020 2020  True:.          
+0001ec50: 2020 696d 6167 655f 6962 203d 2073 656c    image_ib = sel
+0001ec60: 662e 6c61 7374 5f69 6d61 6765 2842 6561  f.last_image(Bea
+0001ec70: 6d54 7970 652e 494f 4e29 0a20 2020 2020  mType.ION).     
+0001ec80: 2020 2020 2020 2069 6620 696d 6167 655f         if image_
+0001ec90: 6962 2069 7320 6e6f 7420 4e6f 6e65 3a0a  ib is not None:.
+0001eca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ecb0: 6962 5f73 6574 7469 6e67 7320 3d20 4265  ib_settings = Be
+0001ecc0: 616d 5365 7474 696e 6773 280a 2020 2020  amSettings(.    
+0001ecd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ece0: 2020 2020 6265 616d 5f74 7970 653d 4265      beam_type=Be
+0001ecf0: 616d 5479 7065 2e49 4f4e 2c0a 2020 2020  amType.ION,.    
+0001ed00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ed10: 2020 2020 776f 726b 696e 675f 6469 7374      working_dist
+0001ed20: 616e 6365 3d69 6d61 6765 5f69 622e 6d65  ance=image_ib.me
+0001ed30: 7461 6461 7461 2e6d 6963 726f 7363 6f70  tadata.microscop
+0001ed40: 655f 7374 6174 652e 6962 5f73 6574 7469  e_state.ib_setti
+0001ed50: 6e67 732e 776f 726b 696e 675f 6469 7374  ngs.working_dist
+0001ed60: 616e 6365 2c0a 2020 2020 2020 2020 2020  ance,.          
+0001ed70: 2020 2020 2020 2020 2020 2020 2020 6265                be
+0001ed80: 616d 5f63 7572 7265 6e74 3d73 656c 662e  am_current=self.
+0001ed90: 636f 6e6e 6563 7469 6f6e 2e46 4942 2e42  connection.FIB.B
+0001eda0: 6561 6d2e 5265 6164 5072 6f62 6543 7572  eam.ReadProbeCur
+0001edb0: 7265 6e74 2829 202a 2063 6f6e 7374 616e  rent() * constan
+0001edc0: 7473 2e50 4943 4f5f 544f 5f53 492c 0a20  ts.PICO_TO_SI,. 
+0001edd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ede0: 2020 2020 2020 2076 6f6c 7461 6765 3d73         voltage=s
+0001edf0: 656c 662e 636f 6e6e 6563 7469 6f6e 2e46  elf.connection.F
+0001ee00: 4942 2e42 6561 6d2e 4765 7456 6f6c 7461  IB.Beam.GetVolta
+0001ee10: 6765 2829 2c0a 2020 2020 2020 2020 2020  ge(),.          
+0001ee20: 2020 2020 2020 2020 2020 2020 2020 6866                hf
+0001ee30: 773d 7365 6c66 2e63 6f6e 6e65 6374 696f  w=self.connectio
+0001ee40: 6e2e 4649 422e 4f70 7469 6373 2e47 6574  n.FIB.Optics.Get
+0001ee50: 5669 6577 6669 656c 6428 2920 2a20 636f  Viewfield() * co
+0001ee60: 6e73 7461 6e74 732e 4d49 4c4c 494d 4554  nstants.MILLIMET
+0001ee70: 5245 5f54 4f5f 4d45 5452 452c 0a20 2020  RE_TO_METRE,.   
+0001ee80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ee90: 2020 2020 2072 6573 6f6c 7574 696f 6e3d       resolution=
+0001eea0: 696d 6167 655f 6962 2e6d 6574 6164 6174  image_ib.metadat
+0001eeb0: 612e 696d 6167 655f 7365 7474 696e 6773  a.image_settings
+0001eec0: 2e72 6573 6f6c 7574 696f 6e2c 0a20 2020  .resolution,.   
+0001eed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001eee0: 2020 2020 2064 7765 6c6c 5f74 696d 653d       dwell_time=
+0001eef0: 696d 6167 655f 6962 2e6d 6574 6164 6174  image_ib.metadat
+0001ef00: 612e 696d 6167 655f 7365 7474 696e 6773  a.image_settings
+0001ef10: 2e64 7765 6c6c 5f74 696d 652c 0a20 2020  .dwell_time,.   
+0001ef20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ef30: 2020 2020 2073 7469 676d 6174 696f 6e3d       stigmation=
+0001ef40: 696d 6167 655f 6962 2e6d 6574 6164 6174  image_ib.metadat
+0001ef50: 612e 6d69 6372 6f73 636f 7065 5f73 7461  a.microscope_sta
+0001ef60: 7465 2e69 625f 7365 7474 696e 6773 2e73  te.ib_settings.s
+0001ef70: 7469 676d 6174 696f 6e2c 0a20 2020 2020  tigmation,.     
+0001ef80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ef90: 2020 2073 6869 6674 3d69 6d61 6765 5f69     shift=image_i
+0001efa0: 622e 6d65 7461 6461 7461 2e6d 6963 726f  b.metadata.micro
+0001efb0: 7363 6f70 655f 7374 6174 652e 6962 5f73  scope_state.ib_s
+0001efc0: 6574 7469 6e67 732e 7368 6966 742c 0a20  ettings.shift,. 
+0001efd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001efe0: 2020 2020 2020 2073 6361 6e5f 726f 7461         scan_rota
+0001eff0: 7469 6f6e 3d73 656c 662e 636f 6e6e 6563  tion=self.connec
+0001f000: 7469 6f6e 2e46 4942 2e4f 7074 6963 732e  tion.FIB.Optics.
+0001f010: 4765 7449 6d61 6765 526f 7461 7469 6f6e  GetImageRotation
+0001f020: 2829 0a20 2020 2020 2020 2020 2020 2020  ().             
+0001f030: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+0001f040: 2020 2020 2020 2020 200a 2020 2020 2020           .      
+0001f050: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+0001f060: 2020 2020 2020 2020 2020 2020 6962 5f73              ib_s
+0001f070: 6574 7469 6e67 7320 3d20 4265 616d 5365  ettings = BeamSe
+0001f080: 7474 696e 6773 2842 6561 6d54 7970 652e  ttings(BeamType.
+0001f090: 494f 4e29 0a20 2020 2020 2020 2065 6c73  ION).        els
+0001f0a0: 653a 0a20 2020 2020 2020 2020 2020 2069  e:.            i
+0001f0b0: 625f 7365 7474 696e 6773 203d 2042 6561  b_settings = Bea
+0001f0c0: 6d53 6574 7469 6e67 7328 4265 616d 5479  mSettings(BeamTy
+0001f0d0: 7065 2e49 4f4e 290a 2020 2020 2020 2020  pe.ION).        
+0001f0e0: 6375 7272 656e 745f 6d69 6372 6f73 636f  current_microsco
+0001f0f0: 7065 5f73 7461 7465 203d 204d 6963 726f  pe_state = Micro
+0001f100: 7363 6f70 6553 7461 7465 280a 2020 2020  scopeState(.    
+0001f110: 2020 2020 2020 2020 7469 6d65 7374 616d          timestam
+0001f120: 703d 6461 7465 7469 6d65 2e64 6174 6574  p=datetime.datet
+0001f130: 696d 652e 7469 6d65 7374 616d 7028 6461  ime.timestamp(da
+0001f140: 7465 7469 6d65 2e64 6174 6574 696d 652e  tetime.datetime.
+0001f150: 6e6f 7728 2929 2c0a 2020 2020 2020 2020  now()),.        
+0001f160: 2020 2020 2320 6765 7420 6162 736f 6c75      # get absolu
+0001f170: 7465 2073 7461 6765 2063 6f6f 7264 696e  te stage coordin
+0001f180: 6174 6573 2028 5241 5729 0a20 2020 2020  ates (RAW).     
+0001f190: 2020 2020 2020 2061 6273 6f6c 7574 655f         absolute_
+0001f1a0: 706f 7369 7469 6f6e 3d73 656c 662e 6765  position=self.ge
+0001f1b0: 745f 7374 6167 655f 706f 7369 7469 6f6e  t_stage_position
+0001f1c0: 2829 2c0a 2020 2020 2020 2020 2020 2020  (),.            
+0001f1d0: 2320 656c 6563 7472 6f6e 2062 6561 6d20  # electron beam 
+0001f1e0: 7365 7474 696e 6773 0a20 2020 2020 2020  settings.       
+0001f1f0: 2020 2020 2065 625f 7365 7474 696e 6773       eb_settings
+0001f200: 3d65 625f 7365 7474 696e 6773 2c0a 2020  =eb_settings,.  
+0001f210: 2020 2020 2020 2020 2020 2320 696f 6e20            # ion 
+0001f220: 6265 616d 2073 6574 7469 6e67 730a 2020  beam settings.  
+0001f230: 2020 2020 2020 2020 2020 6962 5f73 6574            ib_set
+0001f240: 7469 6e67 733d 6962 5f73 6574 7469 6e67  tings=ib_setting
+0001f250: 732c 0a20 2020 2020 2020 2029 0a0a 2020  s,.        )..  
+0001f260: 2020 2020 2020 7265 7475 726e 2063 7572        return cur
+0001f270: 7265 6e74 5f6d 6963 726f 7363 6f70 655f  rent_microscope_
+0001f280: 7374 6174 650a 0a20 2020 2064 6566 205f  state..    def _
+0001f290: 7361 6665 5f61 6273 6f6c 7574 655f 7374  safe_absolute_st
+0001f2a0: 6167 655f 6d6f 7665 6d65 6e74 2873 656c  age_movement(sel
+0001f2b0: 662c 2073 7461 6765 5f70 6f73 6974 696f  f, stage_positio
+0001f2c0: 6e3a 2046 6962 7365 6d53 7461 6765 506f  n: FibsemStagePo
+0001f2d0: 7369 7469 6f6e 0a20 2020 2020 2020 2029  sition.        )
+0001f2e0: 202d 3e20 4e6f 6e65 3a0a 0a20 2020 2020   -> None:..     
+0001f2f0: 2020 2023 2054 4f44 4f3a 2069 6d70 6c65     # TODO: imple
+0001f300: 6d65 6e74 2069 6620 7265 7175 6972 6564  ment if required
+0001f310: 2e0a 2020 2020 2020 2020 7365 6c66 2e6d  ..        self.m
+0001f320: 6f76 655f 7374 6167 655f 6162 736f 6c75  ove_stage_absolu
+0001f330: 7465 2873 7461 6765 5f70 6f73 6974 696f  te(stage_positio
+0001f340: 6e29 0a20 2020 200a 2020 2020 6465 6620  n).    .    def 
+0001f350: 5f63 616c 6375 6c61 7465 5f6e 6577 5f70  _calculate_new_p
+0001f360: 6f73 6974 696f 6e28 7365 6c66 2c20 7365  osition(self, se
+0001f370: 7474 696e 6773 3a20 4d69 6372 6f73 636f  ttings: Microsco
+0001f380: 7065 5365 7474 696e 6773 2c20 6478 3a66  peSettings, dx:f
+0001f390: 6c6f 6174 2c20 6479 3a66 6c6f 6174 2c20  loat, dy:float, 
+0001f3a0: 6265 616d 5f74 7970 653a 4265 616d 5479  beam_type:BeamTy
+0001f3b0: 7065 2c20 6261 7365 5f70 6f73 6974 696f  pe, base_positio
+0001f3c0: 6e3a 4669 6273 656d 5374 6167 6550 6f73  n:FibsemStagePos
+0001f3d0: 6974 696f 6e29 202d 3e20 4669 6273 656d  ition) -> Fibsem
+0001f3e0: 5374 6167 6550 6f73 6974 696f 6e3a 0a0a  StagePosition:..
+0001f3f0: 2020 2020 2020 2020 7265 7475 726e 2062          return b
+0001f400: 6173 655f 706f 7369 7469 6f6e 2023 2054  ase_position # T
+0001f410: 4f44 4f3a 2069 6d70 6c65 6d65 6e74 0a0a  ODO: implement..
+0001f420: 2020 2020 6465 6620 6d6f 7665 5f73 7461      def move_sta
+0001f430: 6765 5f61 6273 6f6c 7574 6528 7365 6c66  ge_absolute(self
+0001f440: 2c20 706f 7369 7469 6f6e 3a20 4669 6273  , position: Fibs
+0001f450: 656d 5374 6167 6550 6f73 6974 696f 6e29  emStagePosition)
+0001f460: 3a0a 2020 2020 2020 2020 2222 220a 2020  :.        """.  
+0001f470: 2020 2020 2020 4d6f 7665 2074 6865 2073        Move the s
+0001f480: 7461 6765 2074 6f20 7468 6520 7370 6563  tage to the spec
+0001f490: 6966 6965 6420 636f 6f72 6469 6e61 7465  ified coordinate
+0001f4a0: 732e 0a0a 2020 2020 2020 2020 4172 6773  s...        Args
+0001f4b0: 3a0a 2020 2020 2020 2020 2020 2020 7820  :.            x 
+0001f4c0: 2866 6c6f 6174 293a 2054 6865 2078 2d63  (float): The x-c
+0001f4d0: 6f6f 7264 696e 6174 6520 746f 206d 6f76  oordinate to mov
+0001f4e0: 6520 746f 2028 696e 206d 6574 6572 7329  e to (in meters)
+0001f4f0: 2e0a 2020 2020 2020 2020 2020 2020 7920  ..            y 
+0001f500: 2866 6c6f 6174 293a 2054 6865 2079 2d63  (float): The y-c
+0001f510: 6f6f 7264 696e 6174 6520 746f 206d 6f76  oordinate to mov
+0001f520: 6520 746f 2028 696e 206d 6574 6572 7329  e to (in meters)
+0001f530: 2e0a 2020 2020 2020 2020 2020 2020 7a20  ..            z 
+0001f540: 2866 6c6f 6174 293a 2054 6865 207a 2d63  (float): The z-c
+0001f550: 6f6f 7264 696e 6174 6520 746f 206d 6f76  oordinate to mov
+0001f560: 6520 746f 2028 696e 206d 6574 6572 7329  e to (in meters)
+0001f570: 2e0a 2020 2020 2020 2020 2020 2020 7220  ..            r 
+0001f580: 2866 6c6f 6174 293a 2054 6865 2072 6f74  (float): The rot
+0001f590: 6174 696f 6e20 746f 2061 7070 6c79 2028  ation to apply (
+0001f5a0: 696e 2072 6164 6961 6e73 292e 0a20 2020  in radians)..   
+0001f5b0: 2020 2020 2020 2020 2074 7820 2866 6c6f           tx (flo
+0001f5c0: 6174 293a 2054 6865 2078 2d61 7869 7320  at): The x-axis 
+0001f5d0: 7469 6c74 2074 6f20 6170 706c 7920 2869  tilt to apply (i
+0001f5e0: 6e20 7261 6469 616e 7329 2e0a 0a20 2020  n radians)...   
+0001f5f0: 2020 2020 2052 6574 7572 6e73 3a0a 2020       Returns:.  
+0001f600: 2020 2020 2020 2020 2020 4e6f 6e65 0a20            None. 
+0001f610: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+0001f620: 2020 2069 6620 706f 7369 7469 6f6e 2e72     if position.r
+0001f630: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
+0001f640: 2020 2020 2020 2020 2020 726f 7461 7469            rotati
+0001f650: 6f6e 203d 2054 7275 650a 2020 2020 2020  on = True.      
+0001f660: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+0001f670: 2020 2020 726f 7461 7469 6f6e 203d 2046      rotation = F
+0001f680: 616c 7365 0a20 2020 2020 2020 2069 6620  alse.        if 
+0001f690: 706f 7369 7469 6f6e 2e74 2069 7320 6e6f  position.t is no
+0001f6a0: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
+0001f6b0: 2020 2020 7469 6c74 203d 2054 7275 650a      tilt = True.
+0001f6c0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+0001f6d0: 2020 2020 2020 2020 2020 7469 6c74 203d            tilt =
+0001f6e0: 2046 616c 7365 0a20 2020 2020 2020 205f   False.        _
+0001f6f0: 6368 6563 6b5f 7374 6167 6528 7365 6c66  check_stage(self
+0001f700: 2e68 6172 6477 6172 655f 7365 7474 696e  .hardware_settin
+0001f710: 6773 2c20 726f 7461 7469 6f6e 3d72 6f74  gs, rotation=rot
+0001f720: 6174 696f 6e2c 2074 696c 743d 7469 6c74  ation, tilt=tilt
+0001f730: 290a 2020 2020 2020 2020 6c6f 6767 696e  ).        loggin
+0001f740: 672e 696e 666f 2866 224d 6f76 696e 6720  g.info(f"Moving 
+0001f750: 7374 6167 6520 746f 207b 706f 7369 7469  stage to {positi
+0001f760: 6f6e 7d2e 2229 0a20 2020 2020 2020 2073  on}.").        s
+0001f770: 656c 662e 636f 6e6e 6563 7469 6f6e 2e53  elf.connection.S
+0001f780: 7461 6765 2e4d 6f76 6554 6f28 0a20 2020  tage.MoveTo(.   
+0001f790: 2020 2020 2020 2020 2070 6f73 6974 696f           positio
+0001f7a0: 6e2e 7820 2a20 636f 6e73 7461 6e74 732e  n.x * constants.
+0001f7b0: 4d45 5452 455f 544f 5f4d 494c 4c49 4d45  METRE_TO_MILLIME
+0001f7c0: 5452 4520 6966 2070 6f73 6974 696f 6e2e  TRE if position.
+0001f7d0: 7820 6973 206e 6f74 204e 6f6e 6520 656c  x is not None el
+0001f7e0: 7365 204e 6f6e 652c 0a20 2020 2020 2020  se None,.       
+0001f7f0: 2020 2020 2070 6f73 6974 696f 6e2e 7920       position.y 
+0001f800: 2a20 636f 6e73 7461 6e74 732e 4d45 5452  * constants.METR
+0001f810: 455f 544f 5f4d 494c 4c49 4d45 5452 4520  E_TO_MILLIMETRE 
+0001f820: 6966 2070 6f73 6974 696f 6e2e 7920 6973  if position.y is
+0001f830: 206e 6f74 204e 6f6e 6520 656c 7365 204e   not None else N
+0001f840: 6f6e 652c 0a20 2020 2020 2020 2020 2020  one,.           
+0001f850: 2070 6f73 6974 696f 6e2e 7a20 2a20 636f   position.z * co
+0001f860: 6e73 7461 6e74 732e 4d45 5452 455f 544f  nstants.METRE_TO
+0001f870: 5f4d 494c 4c49 4d45 5452 4520 6966 2070  _MILLIMETRE if p
+0001f880: 6f73 6974 696f 6e2e 7a20 6973 206e 6f74  osition.z is not
+0001f890: 204e 6f6e 6520 656c 7365 204e 6f6e 652c   None else None,
+0001f8a0: 0a20 2020 2020 2020 2020 2020 2070 6f73  .            pos
+0001f8b0: 6974 696f 6e2e 7220 2a20 636f 6e73 7461  ition.r * consta
+0001f8c0: 6e74 732e 5241 4449 414e 535f 544f 5f44  nts.RADIANS_TO_D
+0001f8d0: 4547 5245 4553 2069 6620 706f 7369 7469  EGREES if positi
+0001f8e0: 6f6e 2e72 2069 7320 6e6f 7420 4e6f 6e65  on.r is not None
+0001f8f0: 2065 6c73 6520 4e6f 6e65 2c0a 2020 2020   else None,.    
+0001f900: 2020 2020 2020 2020 706f 7369 7469 6f6e          position
+0001f910: 2e74 202a 2063 6f6e 7374 616e 7473 2e52  .t * constants.R
+0001f920: 4144 4941 4e53 5f54 4f5f 4445 4752 4545  ADIANS_TO_DEGREE
+0001f930: 5320 6966 2070 6f73 6974 696f 6e2e 7420  S if position.t 
+0001f940: 6973 206e 6f74 204e 6f6e 6520 656c 7365  is not None else
+0001f950: 204e 6f6e 652c 0a20 2020 2020 2020 2029   None,.        )
+0001f960: 0a0a 2020 2020 6465 6620 6d6f 7665 5f73  ..    def move_s
+0001f970: 7461 6765 5f72 656c 6174 6976 6528 0a20  tage_relative(. 
+0001f980: 2020 2020 2020 2073 656c 662c 0a20 2020         self,.   
+0001f990: 2020 2020 2070 6f73 6974 696f 6e3a 2046       position: F
+0001f9a0: 6962 7365 6d53 7461 6765 506f 7369 7469  ibsemStagePositi
+0001f9b0: 6f6e 2c0a 2020 2020 293a 0a20 2020 2020  on,.    ):.     
+0001f9c0: 2020 2022 2222 0a20 2020 2020 2020 204d     """.        M
+0001f9d0: 6f76 6520 7468 6520 7374 6167 6520 6279  ove the stage by
+0001f9e0: 2074 6865 2073 7065 6369 6669 6564 2072   the specified r
+0001f9f0: 656c 6174 6976 6520 6d6f 7665 2e0a 0a20  elative move... 
+0001fa00: 2020 2020 2020 2041 7267 733a 0a20 2020         Args:.   
+0001fa10: 2020 2020 2020 2020 2078 2028 666c 6f61           x (floa
+0001fa20: 7429 3a20 5468 6520 782d 636f 6f72 6469  t): The x-coordi
+0001fa30: 6e61 7465 2074 6f20 6d6f 7665 2074 6f20  nate to move to 
+0001fa40: 2869 6e20 6d65 7465 7273 292e 0a20 2020  (in meters)..   
+0001fa50: 2020 2020 2020 2020 2079 2028 666c 6f61           y (floa
+0001fa60: 7429 3a20 5468 6520 792d 636f 6f72 6469  t): The y-coordi
+0001fa70: 6e61 7465 2074 6f20 6d6f 7665 2074 6f20  nate to move to 
+0001fa80: 2869 6e20 6d65 7465 7273 292e 0a20 2020  (in meters)..   
+0001fa90: 2020 2020 2020 2020 207a 2028 666c 6f61           z (floa
+0001faa0: 7429 3a20 5468 6520 7a2d 636f 6f72 6469  t): The z-coordi
+0001fab0: 6e61 7465 2074 6f20 6d6f 7665 2074 6f20  nate to move to 
+0001fac0: 2869 6e20 6d65 7465 7273 292e 0a20 2020  (in meters)..   
+0001fad0: 2020 2020 2020 2020 2072 2028 666c 6f61           r (floa
+0001fae0: 7429 3a20 5468 6520 726f 7461 7469 6f6e  t): The rotation
+0001faf0: 2074 6f20 6170 706c 7920 2869 6e20 6465   to apply (in de
+0001fb00: 6772 6565 7329 2e0a 2020 2020 2020 2020  grees)..        
+0001fb10: 2020 2020 7478 2028 666c 6f61 7429 3a20      tx (float): 
+0001fb20: 5468 6520 782d 6178 6973 2074 696c 7420  The x-axis tilt 
+0001fb30: 746f 2061 7070 6c79 2028 696e 2064 6567  to apply (in deg
+0001fb40: 7265 6573 292e 0a0a 2020 2020 2020 2020  rees)...        
+0001fb50: 5265 7475 726e 733a 0a20 2020 2020 2020  Returns:.       
+0001fb60: 2020 2020 204e 6f6e 650a 2020 2020 2020       None.      
+0001fb70: 2020 2222 220a 2020 2020 2020 2020 6966    """.        if
+0001fb80: 2070 6f73 6974 696f 6e2e 7220 6973 206e   position.r is n
+0001fb90: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
+0001fba0: 2020 2020 2072 6f74 6174 696f 6e20 3d20       rotation = 
+0001fbb0: 5472 7565 0a20 2020 2020 2020 2065 6c73  True.        els
+0001fbc0: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
+0001fbd0: 6f74 6174 696f 6e20 3d20 4661 6c73 650a  otation = False.
+0001fbe0: 2020 2020 2020 2020 6966 2070 6f73 6974          if posit
+0001fbf0: 696f 6e2e 7420 6973 206e 6f74 204e 6f6e  ion.t is not Non
+0001fc00: 653a 0a20 2020 2020 2020 2020 2020 2074  e:.            t
+0001fc10: 696c 7420 3d20 5472 7565 0a20 2020 2020  ilt = True.     
+0001fc20: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+0001fc30: 2020 2020 2074 696c 7420 3d20 4661 6c73       tilt = Fals
+0001fc40: 650a 2020 2020 2020 2020 5f63 6865 636b  e.        _check
+0001fc50: 5f73 7461 6765 2873 656c 662e 6861 7264  _stage(self.hard
+0001fc60: 7761 7265 5f73 6574 7469 6e67 732c 2072  ware_settings, r
+0001fc70: 6f74 6174 696f 6e3d 726f 7461 7469 6f6e  otation=rotation
+0001fc80: 2c20 7469 6c74 3d74 696c 7429 0a20 2020  , tilt=tilt).   
+0001fc90: 2020 2020 206c 6f67 6769 6e67 2e69 6e66       logging.inf
+0001fca0: 6f28 6622 4d6f 7669 6e67 2073 7461 6765  o(f"Moving stage
+0001fcb0: 2062 7920 7b70 6f73 6974 696f 6e7d 2e22   by {position}."
+0001fcc0: 290a 2020 2020 2020 2020 2320 6375 7272  ).        # curr
+0001fcd0: 656e 745f 706f 7369 7469 6f6e 203d 2073  ent_position = s
+0001fce0: 656c 662e 6765 745f 7374 6167 655f 706f  elf.get_stage_po
+0001fcf0: 7369 7469 6f6e 2829 0a20 2020 2020 2020  sition().       
+0001fd00: 2023 2078 322c 7932 2c7a 3220 3d20 7365   # x2,y2,z2 = se
+0001fd10: 6c66 2e63 6f6e 6e65 6374 696f 6e2e 5374  lf.connection.St
+0001fd20: 6167 652e 4b56 462e 436f 6d70 7574 6528  age.KVF.Compute(
+0001fd30: 0a20 2020 2020 2020 2023 2020 2020 2077  .        #     w
+0001fd40: 643d 2073 656c 662e 6765 7428 2277 6f72  d= self.get("wor
+0001fd50: 6b69 6e67 5f64 6973 7461 6e63 6522 2c20  king_distance", 
+0001fd60: 6265 616d 5f74 7970 653d 4265 616d 5479  beam_type=BeamTy
+0001fd70: 7065 2e45 4c45 4354 524f 4e29 2c0a 2020  pe.ELECTRON),.  
+0001fd80: 2020 2020 2020 2320 2020 2020 7831 3d20        #     x1= 
+0001fd90: 6375 7272 656e 745f 706f 7369 7469 6f6e  current_position
+0001fda0: 2e78 202a 2063 6f6e 7374 616e 7473 2e4d  .x * constants.M
+0001fdb0: 4554 5245 5f54 4f5f 4d49 4c4c 494d 4554  ETRE_TO_MILLIMET
+0001fdc0: 5245 2c0a 2020 2020 2020 2020 2320 2020  RE,.        #   
+0001fdd0: 2020 7931 3d20 6375 7272 656e 745f 706f    y1= current_po
+0001fde0: 7369 7469 6f6e 2e79 202a 2063 6f6e 7374  sition.y * const
+0001fdf0: 616e 7473 2e4d 4554 5245 5f54 4f5f 4d49  ants.METRE_TO_MI
+0001fe00: 4c4c 494d 4554 5245 2c0a 2020 2020 2020  LLIMETRE,.      
+0001fe10: 2020 2320 2020 2020 7a31 3d20 6375 7272    #     z1= curr
+0001fe20: 656e 745f 706f 7369 7469 6f6e 2e7a 202a  ent_position.z *
+0001fe30: 2063 6f6e 7374 616e 7473 2e4d 4554 5245   constants.METRE
+0001fe40: 5f54 4f5f 4d49 4c4c 494d 4554 5245 2c0a  _TO_MILLIMETRE,.
+0001fe50: 2020 2020 2020 2020 2320 2020 2020 7231          #     r1
+0001fe60: 3d20 6375 7272 656e 745f 706f 7369 7469  = current_positi
+0001fe70: 6f6e 2e72 202a 2063 6f6e 7374 616e 7473  on.r * constants
+0001fe80: 2e52 4144 4941 4e53 5f54 4f5f 4445 4752  .RADIANS_TO_DEGR
+0001fe90: 4545 532c 0a20 2020 2020 2020 2023 2020  EES,.        #  
+0001fea0: 2020 2074 7831 3d20 6375 7272 656e 745f     tx1= current_
+0001feb0: 706f 7369 7469 6f6e 2e74 202a 2063 6f6e  position.t * con
+0001fec0: 7374 616e 7473 2e52 4144 4941 4e53 5f54  stants.RADIANS_T
+0001fed0: 4f5f 4445 4752 4545 532c 0a20 2020 2020  O_DEGREES,.     
+0001fee0: 2020 2023 2020 2020 2074 7931 203d 2030     #     ty1 = 0
+0001fef0: 2c0a 2020 2020 2020 2020 2320 2020 2020  ,.        #     
+0001ff00: 7232 203d 2070 6f73 6974 696f 6e2e 7220  r2 = position.r 
+0001ff10: 2a20 636f 6e73 7461 6e74 732e 5241 4449  * constants.RADI
+0001ff20: 414e 535f 544f 5f44 4547 5245 4553 202b  ANS_TO_DEGREES +
+0001ff30: 2063 7572 7265 6e74 5f70 6f73 6974 696f   current_positio
+0001ff40: 6e2e 7220 2a20 636f 6e73 7461 6e74 732e  n.r * constants.
+0001ff50: 5241 4449 414e 535f 544f 5f44 4547 5245  RADIANS_TO_DEGRE
+0001ff60: 4553 2c0a 2020 2020 2020 2020 2320 2020  ES,.        #   
+0001ff70: 2020 7478 3220 3d20 706f 7369 7469 6f6e    tx2 = position
+0001ff80: 2e74 202a 2063 6f6e 7374 616e 7473 2e52  .t * constants.R
+0001ff90: 4144 4941 4e53 5f54 4f5f 4445 4752 4545  ADIANS_TO_DEGREE
+0001ffa0: 5320 2b20 6375 7272 656e 745f 706f 7369  S + current_posi
+0001ffb0: 7469 6f6e 2e74 202a 2063 6f6e 7374 616e  tion.t * constan
+0001ffc0: 7473 2e52 4144 4941 4e53 5f54 4f5f 4445  ts.RADIANS_TO_DE
+0001ffd0: 4752 4545 532c 0a20 2020 2020 2020 2023  GREES,.        #
+0001ffe0: 2020 2020 2074 7932 203d 2030 2c0a 2020       ty2 = 0,.  
+0001fff0: 2020 2020 2020 2320 290a 2020 2020 2020        # ).      
+00020000: 2020 2320 7365 6c66 2e6d 6f76 655f 7374    # self.move_st
+00020010: 6167 655f 6162 736f 6c75 7465 2846 6962  age_absolute(Fib
+00020020: 7365 6d53 7461 6765 506f 7369 7469 6f6e  semStagePosition
+00020030: 2878 322c 7932 2c7a 3229 290a 2020 2020  (x2,y2,z2)).    
+00020040: 2020 2020 6375 7272 656e 745f 706f 7369      current_posi
+00020050: 7469 6f6e 203d 2073 656c 662e 6765 745f  tion = self.get_
+00020060: 7374 6167 655f 706f 7369 7469 6f6e 2829  stage_position()
+00020070: 0a20 2020 2020 2020 2078 5f6d 203d 2063  .        x_m = c
+00020080: 7572 7265 6e74 5f70 6f73 6974 696f 6e2e  urrent_position.
+00020090: 780a 2020 2020 2020 2020 795f 6d20 3d20  x.        y_m = 
+000200a0: 6375 7272 656e 745f 706f 7369 7469 6f6e  current_position
+000200b0: 2e79 0a20 2020 2020 2020 207a 5f6d 203d  .y.        z_m =
+000200c0: 2063 7572 7265 6e74 5f70 6f73 6974 696f   current_positio
+000200d0: 6e2e 7a0a 2020 2020 2020 2020 6e65 775f  n.z.        new_
+000200e0: 706f 7369 7469 6f6e 203d 2046 6962 7365  position = Fibse
+000200f0: 6d53 7461 6765 506f 7369 7469 6f6e 280a  mStagePosition(.
+00020100: 2020 2020 2020 2020 2020 2020 7820 3d20              x = 
+00020110: 2878 5f6d 202b 2070 6f73 6974 696f 6e2e  (x_m + position.
+00020120: 7829 2069 6620 706f 7369 7469 6f6e 2e78  x) if position.x
+00020130: 2069 7320 6e6f 7420 4e6f 6e65 2065 6c73   is not None els
+00020140: 6520 785f 6d2c 0a20 2020 2020 2020 2020  e x_m,.         
+00020150: 2020 2079 203d 2028 795f 6d20 2b20 706f     y = (y_m + po
+00020160: 7369 7469 6f6e 2e79 2029 6966 2070 6f73  sition.y )if pos
+00020170: 6974 696f 6e2e 7920 6973 206e 6f74 204e  ition.y is not N
+00020180: 6f6e 6520 656c 7365 2079 5f6d 2c0a 2020  one else y_m,.  
+00020190: 2020 2020 2020 2020 2020 7a20 3d20 287a            z = (z
+000201a0: 5f6d 202b 2070 6f73 6974 696f 6e2e 7a20  _m + position.z 
+000201b0: 2969 6620 706f 7369 7469 6f6e 2e7a 2069  )if position.z i
+000201c0: 7320 6e6f 7420 4e6f 6e65 2065 6c73 6520  s not None else 
+000201d0: 7a5f 6d2c 0a20 2020 2020 2020 2020 2020  z_m,.           
+000201e0: 2072 203d 2028 6375 7272 656e 745f 706f   r = (current_po
+000201f0: 7369 7469 6f6e 2e72 202b 2070 6f73 6974  sition.r + posit
+00020200: 696f 6e2e 7229 2069 6620 706f 7369 7469  ion.r) if positi
+00020210: 6f6e 2e72 2069 7320 6e6f 7420 4e6f 6e65  on.r is not None
+00020220: 2065 6c73 6520 6375 7272 656e 745f 706f   else current_po
+00020230: 7369 7469 6f6e 2e72 2c0a 2020 2020 2020  sition.r,.      
+00020240: 2020 2020 2020 7420 3d20 2863 7572 7265        t = (curre
+00020250: 6e74 5f70 6f73 6974 696f 6e2e 7420 2b20  nt_position.t + 
+00020260: 706f 7369 7469 6f6e 2e74 2920 6966 2070  position.t) if p
+00020270: 6f73 6974 696f 6e2e 7420 6973 206e 6f74  osition.t is not
+00020280: 204e 6f6e 6520 656c 7365 2063 7572 7265   None else curre
+00020290: 6e74 5f70 6f73 6974 696f 6e2e 742c 0a20  nt_position.t,. 
+000202a0: 2020 2020 2020 2020 2020 2063 6f6f 7264             coord
+000202b0: 696e 6174 655f 7379 7374 656d 203d 2020  inate_system =  
+000202c0: 2252 4157 222c 0a20 2020 2020 2020 2029  "RAW",.        )
+000202d0: 0a20 2020 2020 2020 2073 656c 662e 6d6f  .        self.mo
+000202e0: 7665 5f73 7461 6765 5f61 6273 6f6c 7574  ve_stage_absolut
+000202f0: 6528 6e65 775f 706f 7369 7469 6f6e 290a  e(new_position).
+00020300: 0a20 2020 2064 6566 2073 7461 626c 655f  .    def stable_
+00020310: 6d6f 7665 280a 2020 2020 2020 2020 7365  move(.        se
+00020320: 6c66 2c0a 2020 2020 2020 2020 7365 7474  lf,.        sett
+00020330: 696e 6773 3a20 4d69 6372 6f73 636f 7065  ings: Microscope
+00020340: 5365 7474 696e 6773 2c0a 2020 2020 2020  Settings,.      
+00020350: 2020 6478 3a20 666c 6f61 742c 0a20 2020    dx: float,.   
+00020360: 2020 2020 2064 793a 2066 6c6f 6174 2c0a       dy: float,.
+00020370: 2020 2020 2020 2020 6265 616d 5f74 7970          beam_typ
+00020380: 653a 2042 6561 6d54 7970 652c 0a20 2020  e: BeamType,.   
+00020390: 2020 2020 205f 6669 7865 643a 2062 6f6f       _fixed: boo
+000203a0: 6c20 3d20 4661 6c73 652c 0a20 2020 2029  l = False,.    )
+000203b0: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
+000203c0: 2020 2222 220a 2020 2020 2020 2020 4361    """.        Ca
+000203d0: 6c63 756c 6174 6520 7468 6520 636f 7272  lculate the corr
+000203e0: 6563 7465 6420 7374 6167 6520 6d6f 7665  ected stage move
+000203f0: 6d65 6e74 7320 6261 7365 6420 6f6e 2074  ments based on t
+00020400: 6865 2062 6561 6d5f 7479 7065 2c20 616e  he beam_type, an
+00020410: 6420 7468 656e 206d 6f76 6520 7468 6520  d then move the 
+00020420: 7374 6167 6520 7265 6c61 7469 7665 6c79  stage relatively
+00020430: 2e0a 0a20 2020 2020 2020 2041 7267 733a  ...        Args:
+00020440: 0a20 2020 2020 2020 2020 2020 2073 6574  .            set
+00020450: 7469 6e67 7320 284d 6963 726f 7363 6f70  tings (Microscop
+00020460: 6553 6574 7469 6e67 7329 3a20 6d69 6372  eSettings): micr
+00020470: 6f73 636f 7065 2073 6574 7469 6e67 730a  oscope settings.
+00020480: 2020 2020 2020 2020 2020 2020 6478 2028              dx (
+00020490: 666c 6f61 7429 3a20 6469 7374 616e 6365  float): distance
+000204a0: 2061 6c6f 6e67 2074 6865 2078 2d61 7869   along the x-axi
+000204b0: 7320 2869 6d61 6765 2063 6f6f 7264 696e  s (image coordin
+000204c0: 6174 6573 290a 2020 2020 2020 2020 2020  ates).          
+000204d0: 2020 6479 2028 666c 6f61 7429 3a20 6469    dy (float): di
+000204e0: 7374 616e 6365 2061 6c6f 6e67 2074 6865  stance along the
+000204f0: 2079 2d61 7869 7320 2869 6d61 6765 2063   y-axis (image c
+00020500: 6f6f 7264 696e 6174 6573 290a 2020 2020  oordinates).    
+00020510: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+00020520: 5f63 6865 636b 5f73 7461 6765 2873 656c  _check_stage(sel
+00020530: 662e 6861 7264 7761 7265 5f73 6574 7469  f.hardware_setti
+00020540: 6e67 7329 0a20 2020 2020 2020 2077 6420  ngs).        wd 
+00020550: 3d20 7365 6c66 2e63 6f6e 6e65 6374 696f  = self.connectio
+00020560: 6e2e 5345 4d2e 4f70 7469 6373 2e47 6574  n.SEM.Optics.Get
+00020570: 5744 2829 0a0a 2020 2020 2020 2020 6966  WD()..        if
+00020580: 2062 6561 6d5f 7479 7065 203d 3d20 4265   beam_type == Be
+00020590: 616d 5479 7065 2e45 4c45 4354 524f 4e3a  amType.ELECTRON:
+000205a0: 0a20 2020 2020 2020 2020 2020 2069 6d61  .            ima
+000205b0: 6765 5f72 6f74 6174 696f 6e20 3d20 7365  ge_rotation = se
+000205c0: 6c66 2e63 6f6e 6e65 6374 696f 6e2e 5345  lf.connection.SE
+000205d0: 4d2e 4f70 7469 6373 2e47 6574 496d 6167  M.Optics.GetImag
+000205e0: 6552 6f74 6174 696f 6e28 290a 2020 2020  eRotation().    
+000205f0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00020600: 2020 2020 2020 696d 6167 655f 726f 7461        image_rota
+00020610: 7469 6f6e 203d 2073 656c 662e 636f 6e6e  tion = self.conn
+00020620: 6563 7469 6f6e 2e46 4942 2e4f 7074 6963  ection.FIB.Optic
+00020630: 732e 4765 7449 6d61 6765 526f 7461 7469  s.GetImageRotati
+00020640: 6f6e 2829 0a0a 2020 2020 2020 2020 2320  on()..        # 
+00020650: 6966 2069 6d61 6765 5f72 6f74 6174 696f  if image_rotatio
+00020660: 6e20 3d3d 2030 3a0a 2020 2020 2020 2020  n == 0:.        
+00020670: 2320 2020 2020 6478 5f6d 6f76 6520 3d20  #     dx_move = 
+00020680: 2d64 780a 2020 2020 2020 2020 2320 2020  -dx.        #   
+00020690: 2020 6479 5f6d 6f76 6520 3d20 6479 0a20    dy_move = dy. 
+000206a0: 2020 2020 2020 2023 2065 6c69 6620 696d         # elif im
+000206b0: 6167 655f 726f 7461 7469 6f6e 203d 3d20  age_rotation == 
+000206c0: 3138 303a 0a20 2020 2020 2020 2023 2020  180:.        #  
+000206d0: 2020 2064 785f 6d6f 7665 203d 2064 780a     dx_move = dx.
+000206e0: 2020 2020 2020 2020 2320 2020 2020 6479          #     dy
+000206f0: 5f6d 6f76 6520 3d20 2d64 790a 0a20 2020  _move = -dy..   
+00020700: 2020 2020 2064 785f 6d6f 7665 203d 2020       dx_move =  
+00020710: 2d28 6478 2a6e 702e 636f 7328 696d 6167  -(dx*np.cos(imag
+00020720: 655f 726f 7461 7469 6f6e 2a6e 702e 7069  e_rotation*np.pi
+00020730: 2f31 3830 2920 2b20 6479 2a6e 702e 7369  /180) + dy*np.si
+00020740: 6e28 696d 6167 655f 726f 7461 7469 6f6e  n(image_rotation
+00020750: 2a6e 702e 7069 2f31 3830 2929 0a20 2020  *np.pi/180)).   
+00020760: 2020 2020 2064 795f 6d6f 7665 203d 202d       dy_move = -
+00020770: 2864 792a 6e70 2e63 6f73 2869 6d61 6765  (dy*np.cos(image
+00020780: 5f72 6f74 6174 696f 6e2a 6e70 2e70 692f  _rotation*np.pi/
+00020790: 3138 3029 202d 2064 782a 6e70 2e73 696e  180) - dx*np.sin
+000207a0: 2869 6d61 6765 5f72 6f74 6174 696f 6e2a  (image_rotation*
+000207b0: 6e70 2e70 692f 3138 3029 290a 0a20 2020  np.pi/180))..   
+000207c0: 2020 2020 2023 2063 616c 6375 6c61 7465       # calculate
+000207d0: 2073 7461 6765 206d 6f76 656d 656e 740a   stage movement.
+000207e0: 2020 2020 2020 2020 785f 6d6f 7665 203d          x_move =
+000207f0: 2046 6962 7365 6d53 7461 6765 506f 7369   FibsemStagePosi
+00020800: 7469 6f6e 2878 3d64 785f 6d6f 7665 2c20  tion(x=dx_move, 
+00020810: 793d 302c 207a 3d30 2920 0a20 2020 2020  y=0, z=0) .     
+00020820: 2020 2079 7a5f 6d6f 7665 203d 2073 656c     yz_move = sel
+00020830: 662e 5f79 5f63 6f72 7265 6374 6564 5f73  f._y_corrected_s
+00020840: 7461 6765 5f6d 6f76 656d 656e 7428 0a20  tage_movement(. 
+00020850: 2020 2020 2020 2020 2020 2073 6574 7469             setti
+00020860: 6e67 733d 7365 7474 696e 6773 2c0a 2020  ngs=settings,.  
+00020870: 2020 2020 2020 2020 2020 6578 7065 6374            expect
+00020880: 6564 5f79 3d64 795f 6d6f 7665 2c0a 2020  ed_y=dy_move,.  
+00020890: 2020 2020 2020 2020 2020 6265 616d 5f74            beam_t
+000208a0: 7970 653d 6265 616d 5f74 7970 652c 0a20  ype=beam_type,. 
+000208b0: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
+000208c0: 2020 2320 6d6f 7665 2073 7461 6765 0a20    # move stage. 
+000208d0: 2020 2020 2020 2073 7461 6765 5f70 6f73         stage_pos
+000208e0: 6974 696f 6e20 3d20 4669 6273 656d 5374  ition = FibsemSt
+000208f0: 6167 6550 6f73 6974 696f 6e28 0a20 2020  agePosition(.   
+00020900: 2020 2020 2020 2020 2078 3d78 5f6d 6f76           x=x_mov
+00020910: 652e 782c 2079 3d79 7a5f 6d6f 7665 2e79  e.x, y=yz_move.y
+00020920: 2c20 7a3d 797a 5f6d 6f76 652e 7a2c 2072  , z=yz_move.z, r
+00020930: 3d30 2c20 743d 300a 2020 2020 2020 2020  =0, t=0.        
+00020940: 290a 2020 2020 2020 2020 6c6f 6767 696e  ).        loggin
+00020950: 672e 696e 666f 2866 226d 6f76 696e 6720  g.info(f"moving 
+00020960: 7374 6167 6520 287b 6265 616d 5f74 7970  stage ({beam_typ
+00020970: 652e 6e61 6d65 7d29 3a20 7b73 7461 6765  e.name}): {stage
+00020980: 5f70 6f73 6974 696f 6e7d 2229 0a20 2020  _position}").   
+00020990: 2020 2020 2073 656c 662e 6d6f 7665 5f73       self.move_s
+000209a0: 7461 6765 5f72 656c 6174 6976 6528 7374  tage_relative(st
+000209b0: 6167 655f 706f 7369 7469 6f6e 290a 0a20  age_position).. 
+000209c0: 2020 2020 2020 2023 2061 646a 7573 7420         # adjust 
+000209d0: 776f 726b 696e 6720 6469 7374 616e 6365  working distance
+000209e0: 2074 6f20 636f 6d70 656e 7361 7465 2066   to compensate f
+000209f0: 6f72 2073 7461 6765 206d 6f76 656d 656e  or stage movemen
+00020a00: 740a 2020 2020 2020 2020 7365 6c66 2e63  t.        self.c
+00020a10: 6f6e 6e65 6374 696f 6e2e 5345 4d2e 4f70  onnection.SEM.Op
+00020a20: 7469 6373 2e53 6574 5744 2877 6429 0a20  tics.SetWD(wd). 
+00020a30: 2020 2020 2020 2023 2073 656c 662e 636f         # self.co
+00020a40: 6e6e 6563 7469 6f6e 2e73 7065 6369 6d65  nnection.specime
+00020a50: 6e2e 7374 6167 652e 6c69 6e6b 2829 2023  n.stage.link() #
+00020a60: 2054 4f44 4f20 686f 7720 746f 206c 696e   TODO how to lin
+00020a70: 6b20 666f 7220 5445 5343 414e 3f0a 0a20  k for TESCAN?.. 
+00020a80: 2020 2020 2020 2072 6574 7572 6e0a 0a20         return.. 
+00020a90: 2020 2064 6566 2065 7563 656e 7472 6963     def eucentric
+00020aa0: 5f6d 6f76 6528 0a20 2020 2020 2020 2073  _move(.        s
+00020ab0: 656c 662c 0a20 2020 2020 2020 2073 6574  elf,.        set
+00020ac0: 7469 6e67 733a 204d 6963 726f 7363 6f70  tings: Microscop
+00020ad0: 6553 6574 7469 6e67 732c 0a20 2020 2020  eSettings,.     
+00020ae0: 2020 2064 793a 2066 6c6f 6174 2c0a 2020     dy: float,.  
+00020af0: 2020 2020 2020 7374 6174 6963 5f77 643a        static_wd:
+00020b00: 2062 6f6f 6c20 3d20 5472 7565 2c0a 2020   bool = True,.  
+00020b10: 2020 2920 2d3e 204e 6f6e 653a 0a20 2020    ) -> None:.   
+00020b20: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+00020b30: 204d 6f76 6520 7468 6520 7374 6167 6520   Move the stage 
+00020b40: 7665 7274 6963 616c 6c79 2074 6f20 636f  vertically to co
+00020b50: 7272 6563 7420 6575 6365 6e74 7269 6320  rrect eucentric 
+00020b60: 706f 696e 740a 0a20 2020 2020 2020 2041  point..        A
+00020b70: 7267 733a 0a20 2020 2020 2020 2020 2020  rgs:.           
+00020b80: 2073 6574 7469 6e67 7320 284d 6963 726f   settings (Micro
+00020b90: 7363 6f70 6553 6574 7469 6e67 7329 3a20  scopeSettings): 
+00020ba0: 6d69 6372 6f73 636f 7065 2073 6574 7469  microscope setti
+00020bb0: 6e67 730a 2020 2020 2020 2020 2020 2020  ngs.            
+00020bc0: 6479 2028 666c 6f61 7429 3a20 6469 7374  dy (float): dist
+00020bd0: 616e 6365 2069 6e20 792d 6178 6973 2028  ance in y-axis (
+00020be0: 696d 6167 6520 636f 6f72 6469 6e61 7465  image coordinate
+00020bf0: 7329 0a20 2020 2020 2020 2022 2222 0a20  s).        """. 
+00020c00: 2020 2020 2020 205f 6368 6563 6b5f 7374         _check_st
+00020c10: 6167 6528 7365 6c66 2e68 6172 6477 6172  age(self.hardwar
+00020c20: 655f 7365 7474 696e 6773 290a 2020 2020  e_settings).    
+00020c30: 2020 2020 7764 203d 2073 656c 662e 636f      wd = self.co
+00020c40: 6e6e 6563 7469 6f6e 2e53 454d 2e4f 7074  nnection.SEM.Opt
+00020c50: 6963 732e 4765 7457 4428 290a 2020 2020  ics.GetWD().    
+00020c60: 2020 2020 696d 6167 655f 726f 7461 7469      image_rotati
+00020c70: 6f6e 203d 2073 656c 662e 636f 6e6e 6563  on = self.connec
+00020c80: 7469 6f6e 2e46 4942 2e4f 7074 6963 732e  tion.FIB.Optics.
+00020c90: 4765 7449 6d61 6765 526f 7461 7469 6f6e  GetImageRotation
+00020ca0: 2829 0a20 2020 2020 2020 2020 2020 200a  ().            .
+00020cb0: 2020 2020 2020 2020 6966 206e 702e 6973          if np.is
+00020cc0: 636c 6f73 6528 696d 6167 655f 726f 7461  close(image_rota
+00020cd0: 7469 6f6e 2c20 302e 3029 3a0a 2020 2020  tion, 0.0):.    
+00020ce0: 2020 2020 2020 2020 6479 5f6d 6f76 6520          dy_move 
+00020cf0: 3d20 6479 0a20 2020 2020 2020 2065 6c69  = dy.        eli
+00020d00: 6620 6e70 2e69 7363 6c6f 7365 2869 6d61  f np.isclose(ima
+00020d10: 6765 5f72 6f74 6174 696f 6e2c 2031 3830  ge_rotation, 180
+00020d20: 293a 0a20 2020 2020 2020 2020 2020 2064  ):.            d
+00020d30: 795f 6d6f 7665 203d 202d 6479 0a0a 0a20  y_move = -dy... 
+00020d40: 2020 2020 2020 2020 2020 200a 2020 2020             .    
+00020d50: 2020 2020 5052 4554 494c 545f 5349 474e      PRETILT_SIGN
+00020d60: 203d 2031 2e30 0a20 2020 2020 2020 2066   = 1.0.        f
+00020d70: 726f 6d20 6669 6273 656d 2069 6d70 6f72  rom fibsem impor
+00020d80: 7420 6d6f 7665 6d65 6e74 0a20 2020 2020  t movement.     
+00020d90: 2020 2023 2063 7572 7265 6e74 2073 7461     # current sta
+00020da0: 6765 2070 6f73 6974 696f 6e0a 2020 2020  ge position.    
+00020db0: 2020 2020 6375 7272 656e 745f 7374 6167      current_stag
+00020dc0: 655f 706f 7369 7469 6f6e 203d 2073 656c  e_position = sel
+00020dd0: 662e 6765 745f 7374 6167 655f 706f 7369  f.get_stage_posi
+00020de0: 7469 6f6e 2829 0a20 2020 2020 2020 2073  tion().        s
+00020df0: 7461 6765 5f72 6f74 6174 696f 6e20 3d20  tage_rotation = 
+00020e00: 6375 7272 656e 745f 7374 6167 655f 706f  current_stage_po
+00020e10: 7369 7469 6f6e 2e72 2025 2028 3220 2a20  sition.r % (2 * 
+00020e20: 6e70 2e70 6929 0a20 2020 2020 2020 2073  np.pi).        s
+00020e30: 7461 6765 5f74 696c 7420 3d20 6375 7272  tage_tilt = curr
+00020e40: 656e 745f 7374 6167 655f 706f 7369 7469  ent_stage_positi
+00020e50: 6f6e 2e74 0a20 2020 2020 2020 2073 7461  on.t.        sta
+00020e60: 6765 5f74 696c 745f 666c 6174 5f74 6f5f  ge_tilt_flat_to_
+00020e70: 656c 6563 7472 6f6e 203d 206e 702e 6465  electron = np.de
+00020e80: 6732 7261 6428 0a20 2020 2020 2020 2020  g2rad(.         
+00020e90: 2020 2073 656c 662e 7374 6167 655f 7365     self.stage_se
+00020ea0: 7474 696e 6773 2e74 696c 745f 666c 6174  ttings.tilt_flat
+00020eb0: 5f74 6f5f 656c 6563 7472 6f6e 0a20 2020  _to_electron.   
+00020ec0: 2020 2020 2029 0a20 2020 2020 2020 2073       ).        s
+00020ed0: 7461 6765 5f74 696c 745f 666c 6174 5f74  tage_tilt_flat_t
+00020ee0: 6f5f 696f 6e20 3d20 6e70 2e64 6567 3272  o_ion = np.deg2r
+00020ef0: 6164 2873 656c 662e 7374 6167 655f 7365  ad(self.stage_se
+00020f00: 7474 696e 6773 2e74 696c 745f 666c 6174  ttings.tilt_flat
+00020f10: 5f74 6f5f 696f 6e29 0a0a 2020 2020 2020  _to_ion)..      
+00020f20: 2020 7374 6167 655f 726f 7461 7469 6f6e    stage_rotation
+00020f30: 5f66 6c61 745f 746f 5f69 6f6e 203d 206e  _flat_to_ion = n
+00020f40: 702e 6465 6732 7261 6428 0a20 2020 2020  p.deg2rad(.     
+00020f50: 2020 2020 2020 2073 656c 662e 7374 6167         self.stag
+00020f60: 655f 7365 7474 696e 6773 2e72 6f74 6174  e_settings.rotat
+00020f70: 696f 6e5f 666c 6174 5f74 6f5f 696f 6e0a  ion_flat_to_ion.
+00020f80: 2020 2020 2020 2020 2920 2520 2832 202a          ) % (2 *
+00020f90: 206e 702e 7069 290a 0a20 2020 2020 2020   np.pi)..       
+00020fa0: 2069 6620 6d6f 7665 6d65 6e74 2e72 6f74   if movement.rot
+00020fb0: 6174 696f 6e5f 616e 676c 655f 6973 5f73  ation_angle_is_s
+00020fc0: 6d61 6c6c 6572 280a 2020 2020 2020 2020  maller(.        
+00020fd0: 2020 2020 7374 6167 655f 726f 7461 7469      stage_rotati
+00020fe0: 6f6e 2c20 7374 6167 655f 726f 7461 7469  on, stage_rotati
+00020ff0: 6f6e 5f66 6c61 745f 746f 5f69 6f6e 2c20  on_flat_to_ion, 
+00021000: 6174 6f6c 3d35 0a20 2020 2020 2020 2029  atol=5.        )
+00021010: 3a0a 2020 2020 2020 2020 2020 2020 5052  :.            PR
+00021020: 4554 494c 545f 5349 474e 203d 202d 312e  ETILT_SIGN = -1.
+00021030: 300a 0a20 2020 2020 2020 2023 2054 4f44  0..        # TOD
+00021040: 4f3a 2063 6865 636b 2074 6869 7320 7072  O: check this pr
+00021050: 652d 7469 6c74 2061 6e67 6c65 2063 616c  e-tilt angle cal
+00021060: 6375 6c61 7469 6f6e 0a20 2020 2020 2020  culation.       
+00021070: 2063 6f72 7265 6374 6564 5f70 7265 7469   corrected_preti
+00021080: 6c74 5f61 6e67 6c65 203d 2050 5245 5449  lt_angle = PRETI
+00021090: 4c54 5f53 4947 4e20 2a20 2873 7461 6765  LT_SIGN * (stage
+000210a0: 5f74 696c 745f 666c 6174 5f74 6f5f 656c  _tilt_flat_to_el
+000210b0: 6563 7472 6f6e 202d 2073 656c 662e 7374  ectron - self.st
+000210c0: 6167 655f 7365 7474 696e 6773 2e70 7265  age_settings.pre
+000210d0: 5f74 696c 742a 636f 6e73 7461 6e74 732e  _tilt*constants.
+000210e0: 4445 4752 4545 535f 544f 5f52 4144 4941  DEGREES_TO_RADIA
+000210f0: 4e53 290a 2020 2020 2020 2020 7065 7273  NS).        pers
+00021100: 7065 6374 6976 655f 7469 6c74 203d 2028  pective_tilt = (
+00021110: 2d20 636f 7272 6563 7465 645f 7072 6574  - corrected_pret
+00021120: 696c 745f 616e 676c 6520 2d20 7374 6167  ilt_angle - stag
+00021130: 655f 7469 6c74 5f66 6c61 745f 746f 5f69  e_tilt_flat_to_i
+00021140: 6f6e 290a 2020 2020 2020 2020 7a5f 7065  on).        z_pe
+00021150: 7273 7065 6374 6976 6520 3d20 2d20 6479  rspective = - dy
+00021160: 5f6d 6f76 652f 6e70 2e63 6f73 2828 7374  _move/np.cos((st
+00021170: 6167 655f 7469 6c74 202b 2063 6f72 7265  age_tilt + corre
+00021180: 6374 6564 5f70 7265 7469 6c74 5f61 6e67  cted_pretilt_ang
+00021190: 6c65 202b 2070 6572 7370 6563 7469 7665  le + perspective
+000211a0: 5f74 696c 7429 290a 2020 2020 2020 2020  _tilt)).        
+000211b0: 7a5f 6d6f 7665 203d 207a 5f70 6572 7370  z_move = z_persp
+000211c0: 6563 7469 7665 2a6e 702e 7369 6e28 3930  ective*np.sin(90
+000211d0: 2a63 6f6e 7374 616e 7473 2e44 4547 5245  *constants.DEGRE
+000211e0: 4553 5f54 4f5f 5241 4449 414e 5320 2d20  ES_TO_RADIANS - 
+000211f0: 7374 6167 655f 7469 6c74 5f66 6c61 745f  stage_tilt_flat_
+00021200: 746f 5f69 6f6e 2920 0a20 2020 2020 2020  to_ion) .       
+00021210: 2023 207a 5f6d 6f76 6520 3d20 6479 202f   # z_move = dy /
+00021220: 206e 702e 636f 7328 0a20 2020 2020 2020   np.cos(.       
+00021230: 2023 2020 2020 206e 702e 6465 6732 7261   #     np.deg2ra
+00021240: 6428 3930 202d 2073 656c 662e 7374 6167  d(90 - self.stag
+00021250: 655f 7365 7474 696e 6773 652e 7469 6c74  e_settingse.tilt
+00021260: 5f66 6c61 745f 746f 5f69 6f6e 202b 2073  _flat_to_ion + s
+00021270: 656c 662e 7374 6167 655f 7365 7474 696e  elf.stage_settin
+00021280: 6773 2e70 7265 5f74 696c 7429 0a20 2020  gs.pre_tilt).   
+00021290: 2020 2020 2023 2029 2020 2320 544f 444f       # )  # TODO
+000212a0: 3a20 4d41 4749 4320 4e55 4d42 4552 2c20  : MAGIC NUMBER, 
+000212b0: 3930 202d 2066 6962 2074 696c 740a 2020  90 - fib tilt.  
+000212c0: 2020 2020 2020 6c6f 6767 696e 672e 696e        logging.in
+000212d0: 666f 2866 2265 7563 656e 7472 6963 206d  fo(f"eucentric m
+000212e0: 6f76 656d 656e 743a 207b 7a5f 6d6f 7665  ovement: {z_move
+000212f0: 7d22 290a 2020 2020 2020 2020 7a5f 6d6f  }").        z_mo
+00021300: 7665 203d 2046 6962 7365 6d53 7461 6765  ve = FibsemStage
+00021310: 506f 7369 7469 6f6e 2878 3d30 2c20 793d  Position(x=0, y=
+00021320: 302c 207a 3d7a 5f6d 6f76 652c 2072 3d30  0, z=z_move, r=0
+00021330: 2c20 743d 3029 0a20 2020 2020 2020 2073  , t=0).        s
+00021340: 656c 662e 6d6f 7665 5f73 7461 6765 5f72  elf.move_stage_r
+00021350: 656c 6174 6976 6528 7a5f 6d6f 7665 290a  elative(z_move).
+00021360: 0a20 2020 2020 2020 2073 656c 662e 636f  .        self.co
+00021370: 6e6e 6563 7469 6f6e 2e53 454d 2e4f 7074  nnection.SEM.Opt
+00021380: 6963 732e 5365 7457 4428 7764 290a 0a20  ics.SetWD(wd).. 
+00021390: 2020 2064 6566 205f 795f 636f 7272 6563     def _y_correc
+000213a0: 7465 645f 7374 6167 655f 6d6f 7665 6d65  ted_stage_moveme
+000213b0: 6e74 280a 2020 2020 2020 2020 7365 6c66  nt(.        self
+000213c0: 2c0a 2020 2020 2020 2020 7365 7474 696e  ,.        settin
+000213d0: 6773 3a20 4d69 6372 6f73 636f 7065 5365  gs: MicroscopeSe
+000213e0: 7474 696e 6773 2c0a 2020 2020 2020 2020  ttings,.        
+000213f0: 6578 7065 6374 6564 5f79 3a20 666c 6f61  expected_y: floa
+00021400: 742c 0a20 2020 2020 2020 2062 6561 6d5f  t,.        beam_
+00021410: 7479 7065 3a20 4265 616d 5479 7065 203d  type: BeamType =
+00021420: 2042 6561 6d54 7970 652e 454c 4543 5452   BeamType.ELECTR
+00021430: 4f4e 2c0a 2020 2020 2920 2d3e 2046 6962  ON,.    ) -> Fib
+00021440: 7365 6d53 7461 6765 506f 7369 7469 6f6e  semStagePosition
+00021450: 3a0a 2020 2020 2020 2020 2222 220a 2020  :.        """.  
+00021460: 2020 2020 2020 4361 6c63 756c 6174 6520        Calculate 
+00021470: 7468 6520 7920 636f 7272 6563 7465 6420  the y corrected 
+00021480: 7374 6167 6520 6d6f 7665 6d65 6e74 2c20  stage movement, 
+00021490: 636f 7272 6563 7465 6420 666f 7220 7468  corrected for th
+000214a0: 6520 6164 6469 7469 6f6e 616c 2074 696c  e additional til
+000214b0: 7420 6f66 2074 6865 2073 616d 706c 6520  t of the sample 
+000214c0: 686f 6c64 6572 2028 7072 652d 7469 6c74  holder (pre-tilt
+000214d0: 2061 6e67 6c65 292e 0a0a 2020 2020 2020   angle)...      
+000214e0: 2020 4172 6773 3a0a 2020 2020 2020 2020    Args:.        
+000214f0: 2020 2020 7365 7474 696e 6773 2028 4d69      settings (Mi
+00021500: 6372 6f73 636f 7065 5365 7474 696e 6773  croscopeSettings
+00021510: 293a 206d 6963 726f 7363 6f70 6520 7365  ): microscope se
+00021520: 7474 696e 6773 0a20 2020 2020 2020 2020  ttings.         
+00021530: 2020 2065 7870 6563 7465 645f 7920 2866     expected_y (f
+00021540: 6c6f 6174 2c20 6f70 7469 6f6e 616c 293a  loat, optional):
+00021550: 2064 6973 7461 6e63 6520 616c 6f6e 6720   distance along 
+00021560: 792d 6178 6973 2e0a 2020 2020 2020 2020  y-axis..        
+00021570: 2020 2020 6265 616d 5f74 7970 6520 2842      beam_type (B
+00021580: 6561 6d54 7970 652c 206f 7074 696f 6e61  eamType, optiona
+00021590: 6c29 3a20 6265 616d 5f74 7970 6520 746f  l): beam_type to
+000215a0: 206d 6f76 6520 696e 2e20 4465 6661 756c   move in. Defaul
+000215b0: 7473 2074 6f20 4265 616d 5479 7065 2e45  ts to BeamType.E
+000215c0: 4c45 4354 524f 4e2e 0a0a 2020 2020 2020  LECTRON...      
+000215d0: 2020 5265 7475 726e 733a 0a20 2020 2020    Returns:.     
+000215e0: 2020 2020 2020 2053 7461 6765 506f 7369         StagePosi
+000215f0: 7469 6f6e 3a20 7920 636f 7272 6563 7465  tion: y correcte
+00021600: 6420 7374 6167 6520 6d6f 7665 6d65 6e74  d stage movement
+00021610: 2028 7265 6c61 7469 7665 2070 6f73 6974   (relative posit
+00021620: 696f 6e29 0a20 2020 2020 2020 2022 2222  ion).        """
+00021630: 0a0a 2020 2020 2020 2020 2320 544f 444f  ..        # TODO
+00021640: 3a20 7265 706c 6163 6520 7769 7468 2063  : replace with c
+00021650: 616d 6572 6120 6d61 7472 6978 202a 2069  amera matrix * i
+00021660: 6e76 6572 7365 206b 696e 656d 6174 6963  nverse kinematic
+00021670: 730a 2020 2020 2020 2020 2320 544f 444f  s.        # TODO
+00021680: 3a20 7265 706c 6163 6520 7374 6167 655f  : replace stage_
+00021690: 7469 6c74 5f66 6c61 745f 746f 5f65 6c65  tilt_flat_to_ele
+000216a0: 6374 726f 6e20 7769 7468 2070 7265 2d74  ctron with pre-t
+000216b0: 696c 740a 0a20 2020 2020 2020 2023 2061  ilt..        # a
+000216c0: 6c6c 2061 6e67 6c65 7320 696e 2072 6164  ll angles in rad
+000216d0: 6961 6e73 0a20 2020 2020 2020 2073 7461  ians.        sta
+000216e0: 6765 5f74 696c 745f 666c 6174 5f74 6f5f  ge_tilt_flat_to_
+000216f0: 656c 6563 7472 6f6e 203d 206e 702e 6465  electron = np.de
+00021700: 6732 7261 6428 0a20 2020 2020 2020 2020  g2rad(.         
+00021710: 2020 2073 656c 662e 7374 6167 655f 7365     self.stage_se
+00021720: 7474 696e 6773 2e74 696c 745f 666c 6174  ttings.tilt_flat
+00021730: 5f74 6f5f 656c 6563 7472 6f6e 0a20 2020  _to_electron.   
+00021740: 2020 2020 2029 0a20 2020 2020 2020 2073       ).        s
+00021750: 7461 6765 5f74 696c 745f 666c 6174 5f74  tage_tilt_flat_t
+00021760: 6f5f 696f 6e20 3d20 6e70 2e64 6567 3272  o_ion = np.deg2r
+00021770: 6164 2873 656c 662e 7374 6167 655f 7365  ad(self.stage_se
+00021780: 7474 696e 6773 2e74 696c 745f 666c 6174  ttings.tilt_flat
+00021790: 5f74 6f5f 696f 6e29 0a0a 2020 2020 2020  _to_ion)..      
+000217a0: 2020 2320 7374 6167 655f 726f 7461 7469    # stage_rotati
+000217b0: 6f6e 5f66 6c61 745f 746f 5f65 6220 3d20  on_flat_to_eb = 
+000217c0: 6e70 2e64 6567 3272 6164 280a 2020 2020  np.deg2rad(.    
+000217d0: 2020 2020 2320 2020 2020 7365 6c66 2e73      #     self.s
+000217e0: 7461 6765 5f73 6574 7469 6e67 732e 726f  tage_settings.ro
+000217f0: 7461 7469 6f6e 5f66 6c61 745f 746f 5f65  tation_flat_to_e
+00021800: 6c65 6374 726f 6e0a 2020 2020 2020 2020  lectron.        
+00021810: 2320 2920 2520 2832 202a 206e 702e 7069  # ) % (2 * np.pi
+00021820: 290a 2020 2020 2020 2020 7374 6167 655f  ).        stage_
+00021830: 726f 7461 7469 6f6e 5f66 6c61 745f 746f  rotation_flat_to
+00021840: 5f69 6f6e 203d 206e 702e 6465 6732 7261  _ion = np.deg2ra
+00021850: 6428 0a20 2020 2020 2020 2020 2020 2073  d(.            s
+00021860: 656c 662e 7374 6167 655f 7365 7474 696e  elf.stage_settin
+00021870: 6773 2e72 6f74 6174 696f 6e5f 666c 6174  gs.rotation_flat
+00021880: 5f74 6f5f 696f 6e0a 2020 2020 2020 2020  _to_ion.        
+00021890: 2920 2520 2832 202a 206e 702e 7069 290a  ) % (2 * np.pi).
+000218a0: 0a20 2020 2020 2020 2023 2063 7572 7265  .        # curre
+000218b0: 6e74 2073 7461 6765 2070 6f73 6974 696f  nt stage positio
+000218c0: 6e0a 2020 2020 2020 2020 6375 7272 656e  n.        curren
+000218d0: 745f 7374 6167 655f 706f 7369 7469 6f6e  t_stage_position
+000218e0: 203d 2073 656c 662e 6765 745f 7374 6167   = self.get_stag
+000218f0: 655f 706f 7369 7469 6f6e 2829 0a20 2020  e_position().   
+00021900: 2020 2020 2073 7461 6765 5f72 6f74 6174       stage_rotat
+00021910: 696f 6e20 3d20 6375 7272 656e 745f 7374  ion = current_st
+00021920: 6167 655f 706f 7369 7469 6f6e 2e72 2025  age_position.r %
+00021930: 2028 3220 2a20 6e70 2e70 6929 0a20 2020   (2 * np.pi).   
+00021940: 2020 2020 2073 7461 6765 5f74 696c 7420       stage_tilt 
+00021950: 3d20 6375 7272 656e 745f 7374 6167 655f  = current_stage_
+00021960: 706f 7369 7469 6f6e 2e74 0a0a 2020 2020  position.t..    
+00021970: 2020 2020 5052 4554 494c 545f 5349 474e      PRETILT_SIGN
+00021980: 203d 2031 2e30 0a20 2020 2020 2020 2066   = 1.0.        f
+00021990: 726f 6d20 6669 6273 656d 2069 6d70 6f72  rom fibsem impor
+000219a0: 7420 6d6f 7665 6d65 6e74 0a20 2020 2020  t movement.     
+000219b0: 2020 2023 2070 7265 7469 6c74 2061 6e67     # pretilt ang
+000219c0: 6c65 2064 6570 656e 6473 206f 6e20 726f  le depends on ro
+000219d0: 7461 7469 6f6e 0a20 2020 2020 2020 2023  tation.        #
+000219e0: 2069 6620 726f 7461 7469 6f6e 5f61 6e67   if rotation_ang
+000219f0: 6c65 5f69 735f 736d 616c 6c65 7228 7374  le_is_smaller(st
+00021a00: 6167 655f 726f 7461 7469 6f6e 2c20 7374  age_rotation, st
+00021a10: 6167 655f 726f 7461 7469 6f6e 5f66 6c61  age_rotation_fla
+00021a20: 745f 746f 5f65 622c 2061 746f 6c3d 3529  t_to_eb, atol=5)
+00021a30: 3a0a 2020 2020 2020 2020 2320 2020 2020  :.        #     
+00021a40: 5052 4554 494c 545f 5349 474e 203d 2031  PRETILT_SIGN = 1
+00021a50: 2e30 0a20 2020 2020 2020 2069 6620 6d6f  .0.        if mo
+00021a60: 7665 6d65 6e74 2e72 6f74 6174 696f 6e5f  vement.rotation_
+00021a70: 616e 676c 655f 6973 5f73 6d61 6c6c 6572  angle_is_smaller
+00021a80: 280a 2020 2020 2020 2020 2020 2020 7374  (.            st
+00021a90: 6167 655f 726f 7461 7469 6f6e 2c20 7374  age_rotation, st
+00021aa0: 6167 655f 726f 7461 7469 6f6e 5f66 6c61  age_rotation_fla
+00021ab0: 745f 746f 5f69 6f6e 2c20 6174 6f6c 3d35  t_to_ion, atol=5
+00021ac0: 0a20 2020 2020 2020 2029 3a0a 2020 2020  .        ):.    
+00021ad0: 2020 2020 2020 2020 5052 4554 494c 545f          PRETILT_
+00021ae0: 5349 474e 203d 202d 312e 300a 0a20 2020  SIGN = -1.0..   
+00021af0: 2020 2020 2063 6f72 7265 6374 6564 5f70       corrected_p
+00021b00: 7265 7469 6c74 5f61 6e67 6c65 203d 2050  retilt_angle = P
+00021b10: 5245 5449 4c54 5f53 4947 4e20 2a20 2873  RETILT_SIGN * (s
+00021b20: 7461 6765 5f74 696c 745f 666c 6174 5f74  tage_tilt_flat_t
+00021b30: 6f5f 656c 6563 7472 6f6e 202d 2073 656c  o_electron - sel
+00021b40: 662e 7374 6167 655f 7365 7474 696e 6773  f.stage_settings
+00021b50: 2e70 7265 5f74 696c 742a 636f 6e73 7461  .pre_tilt*consta
+00021b60: 6e74 732e 4445 4752 4545 535f 544f 5f52  nts.DEGREES_TO_R
+00021b70: 4144 4941 4e53 290a 2020 2020 2020 2020  ADIANS).        
+00021b80: 0a20 2020 2020 2020 2070 6572 7370 6563  .        perspec
+00021b90: 7469 7665 5f74 696c 7420 3d20 2d20 636f  tive_tilt = - co
+00021ba0: 7272 6563 7465 645f 7072 6574 696c 745f  rrected_pretilt_
+00021bb0: 616e 676c 6520 6966 2062 6561 6d5f 7479  angle if beam_ty
+00021bc0: 7065 2069 7320 4265 616d 5479 7065 2e45  pe is BeamType.E
+00021bd0: 4c45 4354 524f 4e20 656c 7365 2028 2d20  LECTRON else (- 
+00021be0: 636f 7272 6563 7465 645f 7072 6574 696c  corrected_pretil
+00021bf0: 745f 616e 676c 6520 2d20 7374 6167 655f  t_angle - stage_
+00021c00: 7469 6c74 5f66 6c61 745f 746f 5f69 6f6e  tilt_flat_to_ion
+00021c10: 290a 0a20 2020 2020 2020 2079 5f6d 6f76  )..        y_mov
+00021c20: 6520 3d20 6578 7065 6374 6564 5f79 2f6e  e = expected_y/n
+00021c30: 702e 636f 7328 2873 7461 6765 5f74 696c  p.cos((stage_til
+00021c40: 7420 2b20 636f 7272 6563 7465 645f 7072  t + corrected_pr
+00021c50: 6574 696c 745f 616e 676c 6520 2b20 7065  etilt_angle + pe
+00021c60: 7273 7065 6374 6976 655f 7469 6c74 2929  rspective_tilt))
+00021c70: 0a20 2020 2020 2020 2020 0a20 2020 2020  .         .     
+00021c80: 2020 207a 5f6d 6f76 6520 3d20 795f 6d6f     z_move = y_mo
+00021c90: 7665 2a6e 702e 7369 6e28 2863 6f72 7265  ve*np.sin((corre
+00021ca0: 6374 6564 5f70 7265 7469 6c74 5f61 6e67  cted_pretilt_ang
+00021cb0: 6c65 2929 200a 2020 2020 2020 2020 7072  le)) .        pr
+00021cc0: 696e 7428 6627 5374 6167 6520 7469 6c74  int(f'Stage tilt
+00021cd0: 3a20 7b73 7461 6765 5f74 696c 747d 2c20  : {stage_tilt}, 
+00021ce0: 636f 7272 6563 7465 6420 7072 6574 696c  corrected pretil
+00021cf0: 743a 207b 636f 7272 6563 7465 645f 7072  t: {corrected_pr
+00021d00: 6574 696c 745f 616e 676c 657d 2c20 795f  etilt_angle}, y_
+00021d10: 6d6f 7665 3a20 7b79 5f6d 6f76 657d 207a  move: {y_move} z
+00021d20: 5f6d 6f76 653a 207b 7a5f 6d6f 7665 7d27  _move: {z_move}'
+00021d30: 290a 0a20 2020 2020 2020 2072 6574 7572  )..        retur
+00021d40: 6e20 4669 6273 656d 5374 6167 6550 6f73  n FibsemStagePos
+00021d50: 6974 696f 6e28 783d 302c 2079 3d79 5f6d  ition(x=0, y=y_m
+00021d60: 6f76 652c 207a 3d7a 5f6d 6f76 6529 0a0a  ove, z=z_move)..
+00021d70: 2020 2020 6465 6620 6d6f 7665 5f66 6c61      def move_fla
+00021d80: 745f 746f 5f62 6561 6d28 0a20 2020 2020  t_to_beam(.     
+00021d90: 2020 2073 656c 662c 2073 6574 7469 6e67     self, setting
+00021da0: 733d 4d69 6372 6f73 636f 7065 5365 7474  s=MicroscopeSett
+00021db0: 696e 6773 2c20 6265 616d 5f74 7970 653a  ings, beam_type:
+00021dc0: 2042 6561 6d54 7970 6520 3d20 4265 616d   BeamType = Beam
+00021dd0: 5479 7065 2e45 4c45 4354 524f 4e0a 2020  Type.ELECTRON.  
+00021de0: 2020 293a 0a20 2020 2020 2020 2022 2222    ):.        """
+00021df0: 0a20 2020 2020 2020 204d 6f76 6573 2074  .        Moves t
+00021e00: 6865 206d 6963 726f 7363 6f70 6520 7374  he microscope st
+00021e10: 6167 6520 746f 2074 6865 2074 696c 7420  age to the tilt 
+00021e20: 616e 676c 6520 636f 7272 6573 706f 6e64  angle correspond
+00021e30: 696e 6720 746f 2074 6865 2067 6976 656e  ing to the given
+00021e40: 2062 6561 6d20 7479 7065 2c0a 2020 2020   beam type,.    
+00021e50: 2020 2020 736f 2074 6861 7420 7468 6520      so that the 
+00021e60: 7374 6167 6520 6973 2066 6c61 7420 7769  stage is flat wi
+00021e70: 7468 2072 6573 7065 6374 2074 6f20 7468  th respect to th
+00021e80: 6520 6265 616d 2e0a 0a20 2020 2020 2020  e beam...       
+00021e90: 2041 7267 733a 0a20 2020 2020 2020 2020   Args:.         
+00021ea0: 2020 2073 6574 7469 6e67 7320 284d 6963     settings (Mic
+00021eb0: 726f 7363 6f70 6553 6574 7469 6e67 7329  roscopeSettings)
+00021ec0: 3a20 5468 6520 6375 7272 656e 7420 6d69  : The current mi
+00021ed0: 6372 6f73 636f 7065 2073 6574 7469 6e67  croscope setting
+00021ee0: 732e 0a20 2020 2020 2020 2020 2020 2062  s..            b
+00021ef0: 6561 6d5f 7479 7065 2028 4265 616d 5479  eam_type (BeamTy
+00021f00: 7065 293a 2054 6865 2074 7970 6520 6f66  pe): The type of
+00021f10: 2062 6561 6d20 746f 2077 6869 6368 2074   beam to which t
+00021f20: 6865 2073 7461 6765 2073 686f 756c 6420  he stage should 
+00021f30: 6265 206d 6164 6520 666c 6174 2e0a 2020  be made flat..  
+00021f40: 2020 2020 2020 2020 2020 2020 2020 4d75                Mu
+00021f50: 7374 2062 6520 6f6e 6520 6f66 2042 6561  st be one of Bea
+00021f60: 6d54 7970 652e 454c 4543 5452 4f4e 206f  mType.ELECTRON o
+00021f70: 7220 4265 616d 5479 7065 2e49 4f4e 2e0a  r BeamType.ION..
+00021f80: 0a20 2020 2020 2020 2052 6574 7572 6e73  .        Returns
+00021f90: 3a0a 2020 2020 2020 2020 2020 2020 4e6f  :.            No
+00021fa0: 6e65 2e0a 2020 2020 2020 2020 2222 220a  ne..        """.
+00021fb0: 2020 2020 2020 2020 5f63 6865 636b 5f62          _check_b
+00021fc0: 6561 6d28 6265 616d 5f74 7970 652c 2073  eam(beam_type, s
+00021fd0: 656c 662e 6861 7264 7761 7265 5f73 6574  elf.hardware_set
+00021fe0: 7469 6e67 7329 0a20 2020 2020 2020 2023  tings).        #
+00021ff0: 2042 5547 2069 6620 4920 7365 7420 6f72   BUG if I set or
+00022000: 2070 6173 7320 4265 616d 5479 7065 2e49   pass BeamType.I
+00022010: 4f4e 2069 7420 7374 696c 6c20 7365 6573  ON it still sees
+00022020: 2062 6561 6d5f 7479 7065 2061 7320 4265   beam_type as Be
+00022030: 616d 5479 7065 2e45 4c45 4354 524f 4e0a  amType.ELECTRON.
+00022040: 2020 2020 2020 2020 7374 6167 655f 7365          stage_se
+00022050: 7474 696e 6773 203d 2073 656c 662e 7374  ttings = self.st
+00022060: 6167 655f 7365 7474 696e 6773 0a0a 2020  age_settings..  
+00022070: 2020 2020 2020 6966 2062 6561 6d5f 7479        if beam_ty
+00022080: 7065 2069 7320 4265 616d 5479 7065 2e49  pe is BeamType.I
+00022090: 4f4e 3a0a 2020 2020 2020 2020 2020 2020  ON:.            
+000220a0: 7469 6c74 203d 2073 7461 6765 5f73 6574  tilt = stage_set
+000220b0: 7469 6e67 732e 7469 6c74 5f66 6c61 745f  tings.tilt_flat_
+000220c0: 746f 5f69 6f6e 0a20 2020 2020 2020 2065  to_ion.        e
+000220d0: 6c69 6620 6265 616d 5f74 7970 6520 6973  lif beam_type is
+000220e0: 2042 6561 6d54 7970 652e 454c 4543 5452   BeamType.ELECTR
+000220f0: 4f4e 3a0a 2020 2020 2020 2020 2020 2020  ON:.            
+00022100: 7469 6c74 203d 2073 7461 6765 5f73 6574  tilt = stage_set
+00022110: 7469 6e67 732e 7469 6c74 5f66 6c61 745f  tings.tilt_flat_
+00022120: 746f 5f65 6c65 6374 726f 6e0a 0a20 2020  to_electron..   
+00022130: 2020 2020 206c 6f67 6769 6e67 2e69 6e66       logging.inf
+00022140: 6f28 6622 4d6f 7669 6e67 2053 7461 6765  o(f"Moving Stage
+00022150: 2046 6c61 7420 746f 207b 6265 616d 5f74   Flat to {beam_t
+00022160: 7970 652e 6e61 6d65 7d20 4265 616d 2229  ype.name} Beam")
+00022170: 0a20 2020 2020 2020 2073 656c 662e 636f  .        self.co
+00022180: 6e6e 6563 7469 6f6e 2e53 7461 6765 2e4d  nnection.Stage.M
+00022190: 6f76 6554 6f28 7469 6c74 783d 7469 6c74  oveTo(tiltx=tilt
+000221a0: 290a 0a0a 2020 2020 6465 6620 6765 745f  )...    def get_
+000221b0: 6d61 6e69 7075 6c61 746f 725f 7374 6174  manipulator_stat
+000221c0: 6528 7365 6c66 2c73 6574 7469 6e67 733d  e(self,settings=
+000221d0: 4d69 6372 6f73 636f 7065 5365 7474 696e  MicroscopeSettin
+000221e0: 6773 2920 2d3e 2062 6f6f 6c3a 0a0a 2020  gs) -> bool:..  
+000221f0: 2020 2020 2020 2222 2272 6574 7572 6e73        """returns
+00022200: 2074 7275 6520 6966 206e 616e 6f6d 616e   true if nanoman
+00022210: 6970 756c 6174 6f72 2069 7320 696e 7365  ipulator is inse
+00022220: 7274 6564 2e20 4d61 6e69 7075 6c61 746f  rted. Manipulato
+00022230: 7220 706f 7369 7469 6f6e 7320 6d75 7374  r positions must
+00022240: 2062 6520 6361 6c69 6272 6174 6564 2061   be calibrated a
+00022250: 6e64 2073 746f 7265 6420 696e 206d 6f64  nd stored in mod
+00022260: 656c 2e79 616d 6c20 6669 6c65 2069 6620  el.yaml file if 
+00022270: 6e6f 7420 646f 6e65 2073 6f0a 0a20 2020  not done so..   
+00022280: 2020 2020 2052 6169 7365 733a 0a20 2020       Raises:.   
+00022290: 2020 2020 2020 2020 2056 616c 7565 4572           ValueEr
+000222a0: 726f 723a 205f 6465 7363 7269 7074 696f  ror: _descriptio
+000222b0: 6e5f 0a0a 2020 2020 2020 2020 5265 7475  n_..        Retu
+000222c0: 726e 733a 0a20 2020 2020 2020 2020 2020  rns:.           
+000222d0: 205f 7479 7065 5f3a 2054 7275 6520 6966   _type_: True if
+000222e0: 2049 6e73 6572 7465 642c 2046 616c 7365   Inserted, False
+000222f0: 2069 6620 7265 7472 6163 7465 640a 2020   if retracted.  
+00022300: 2020 2020 2020 2222 220a 0a20 2020 2020        """..     
+00022310: 2020 206d 616e 6970 756c 6174 6f72 5f70     manipulator_p
+00022320: 6f73 6974 696f 6e73 203d 2073 6574 7469  ositions = setti
+00022330: 6e67 732e 6861 7264 7761 7265 2e6d 616e  ngs.hardware.man
+00022340: 6970 756c 6174 6f72 5f70 6f73 6974 696f  ipulator_positio
+00022350: 6e73 0a0a 2020 2020 2020 2020 6966 206e  ns..        if n
+00022360: 6f74 206d 616e 6970 756c 6174 6f72 5f70  ot manipulator_p
+00022370: 6f73 6974 696f 6e73 5b22 6361 6c69 6272  ositions["calibr
+00022380: 6174 6564 225d 3a0a 2020 2020 2020 2020  ated"]:.        
+00022390: 2020 2020 6c6f 6767 696e 672e 7761 726e      logging.warn
+000223a0: 696e 6728 224d 616e 6970 756c 6174 6f72  ing("Manipulator
+000223b0: 2070 6f73 6974 696f 6e73 206e 6f74 2063   positions not c
+000223c0: 616c 6962 7261 7465 642c 2063 616e 6e6f  alibrated, canno
+000223d0: 7420 6765 7420 7374 6174 6522 290a 2020  t get state").  
+000223e0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+000223f0: 2046 616c 7365 0a0a 2020 2020 2020 2020   False..        
+00022400: 7265 7472 6163 7465 645f 706f 7369 7469  retracted_positi
+00022410: 6f6e 5f78 203d 206d 616e 6970 756c 6174  on_x = manipulat
+00022420: 6f72 5f70 6f73 6974 696f 6e73 5b22 7061  or_positions["pa
+00022430: 726b 696e 6722 5d5b 2278 225d 2a63 6f6e  rking"]["x"]*con
+00022440: 7374 616e 7473 2e4d 4554 5245 5f54 4f5f  stants.METRE_TO_
+00022450: 4d49 4c4c 494d 4554 5245 0a20 2020 2020  MILLIMETRE.     
+00022460: 2020 2072 6574 7261 6374 6564 5f70 6f73     retracted_pos
+00022470: 6974 696f 6e5f 7920 3d20 6d61 6e69 7075  ition_y = manipu
+00022480: 6c61 746f 725f 706f 7369 7469 6f6e 735b  lator_positions[
+00022490: 2270 6172 6b69 6e67 225d 5b22 7922 5d2a  "parking"]["y"]*
+000224a0: 636f 6e73 7461 6e74 732e 4d45 5452 455f  constants.METRE_
+000224b0: 544f 5f4d 494c 4c49 4d45 5452 450a 2020  TO_MILLIMETRE.  
+000224c0: 2020 2020 2020 7265 7472 6163 7465 645f        retracted_
+000224d0: 706f 7369 7469 6f6e 5f7a 203d 206d 616e  position_z = man
+000224e0: 6970 756c 6174 6f72 5f70 6f73 6974 696f  ipulator_positio
+000224f0: 6e73 5b22 7061 726b 696e 6722 5d5b 227a  ns["parking"]["z
+00022500: 225d 2a63 6f6e 7374 616e 7473 2e4d 4554  "]*constants.MET
+00022510: 5245 5f54 4f5f 4d49 4c4c 494d 4554 5245  RE_TO_MILLIMETRE
+00022520: 0a0a 2020 2020 2020 2020 6375 7272 656e  ..        curren
+00022530: 745f 706f 7369 7469 6f6e 203d 2073 656c  t_position = sel
+00022540: 662e 6765 745f 6d61 6e69 7075 6c61 746f  f.get_manipulato
+00022550: 725f 706f 7369 7469 6f6e 2829 0a0a 2020  r_position()..  
+00022560: 2020 2020 2020 6375 7272 656e 745f 706f        current_po
+00022570: 7369 7469 6f6e 5f61 7272 6179 203d 205b  sition_array = [
+00022580: 6375 7272 656e 745f 706f 7369 7469 6f6e  current_position
+00022590: 2e78 2a63 6f6e 7374 616e 7473 2e4d 4554  .x*constants.MET
+000225a0: 5245 5f54 4f5f 4d49 4c4c 494d 4554 5245  RE_TO_MILLIMETRE
+000225b0: 2c20 6375 7272 656e 745f 706f 7369 7469  , current_positi
+000225c0: 6f6e 2e79 2a63 6f6e 7374 616e 7473 2e4d  on.y*constants.M
+000225d0: 4554 5245 5f54 4f5f 4d49 4c4c 494d 4554  ETRE_TO_MILLIMET
+000225e0: 5245 2c20 6375 7272 656e 745f 706f 7369  RE, current_posi
+000225f0: 7469 6f6e 2e7a 2a63 6f6e 7374 616e 7473  tion.z*constants
+00022600: 2e4d 4554 5245 5f54 4f5f 4d49 4c4c 494d  .METRE_TO_MILLIM
+00022610: 4554 5245 5d0a 0a20 2020 2020 2020 2063  ETRE]..        c
+00022620: 6865 636b 5f63 6f6d 7061 7265 203d 206e  heck_compare = n
+00022630: 702e 6973 636c 6f73 6528 6375 7272 656e  p.isclose(curren
+00022640: 745f 706f 7369 7469 6f6e 5f61 7272 6179  t_position_array
+00022650: 2c20 5b72 6574 7261 6374 6564 5f70 6f73  , [retracted_pos
+00022660: 6974 696f 6e5f 782c 2072 6574 7261 6374  ition_x, retract
+00022670: 6564 5f70 6f73 6974 696f 6e5f 792c 2072  ed_position_y, r
+00022680: 6574 7261 6374 6564 5f70 6f73 6974 696f  etracted_positio
+00022690: 6e5f 7a5d 2c20 6174 6f6c 3d30 2e31 290a  n_z], atol=0.1).
+000226a0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+000226b0: 5472 7565 2069 6620 4661 6c73 6520 696e  True if False in
+000226c0: 2063 6865 636b 5f63 6f6d 7061 7265 2065   check_compare e
+000226d0: 6c73 6520 4661 6c73 650a 2020 2020 2020  lse False.      
+000226e0: 2020 2020 2020 0a0a 2020 2020 6465 6620        ..    def 
+000226f0: 6765 745f 6d61 6e69 7075 6c61 746f 725f  get_manipulator_
+00022700: 706f 7369 7469 6f6e 2873 656c 6629 202d  position(self) -
+00022710: 3e20 4669 6273 656d 4d61 6e69 7075 6c61  > FibsemManipula
+00022720: 746f 7250 6f73 6974 696f 6e3a 0a20 2020  torPosition:.   
+00022730: 2020 2020 2023 2070 6173 730a 2020 2020       # pass.    
+00022740: 2020 2020 5f63 6865 636b 5f6e 6565 646c      _check_needl
+00022750: 6528 7365 6c66 2e68 6172 6477 6172 655f  e(self.hardware_
+00022760: 7365 7474 696e 6773 290a 2020 2020 2020  settings).      
+00022770: 2020 696e 6465 7820 3d20 300a 2020 2020    index = 0.    
+00022780: 2020 2020 6f75 7470 7574 5f70 6f73 6974      output_posit
+00022790: 696f 6e20 3d20 7365 6c66 2e63 6f6e 6e65  ion = self.conne
+000227a0: 6374 696f 6e2e 4e61 6e6f 6d61 6e69 7075  ction.Nanomanipu
+000227b0: 6c61 746f 722e 4765 7450 6f73 6974 696f  lator.GetPositio
+000227c0: 6e28 496e 6465 783d 696e 6465 7829 0a0a  n(Index=index)..
+000227d0: 2020 2020 2020 2020 2320 4765 7450 6f73          # GetPos
+000227e0: 6974 696f 6e20 7265 7475 726e 7320 7475  ition returns tu
+000227f0: 706c 6520 696e 2074 6865 2066 6f72 6d20  ple in the form 
+00022800: 2878 2c20 792c 207a 2c20 7229 0a20 2020  (x, y, z, r).   
+00022810: 2020 2020 2023 2078 2c79 2c7a 2069 6e20       # x,y,z in 
+00022820: 6d6d 2061 6e64 2072 2069 6e20 6465 6772  mm and r in degr
+00022830: 6565 732c 206e 6f20 7469 6c74 2069 6e66  ees, no tilt inf
+00022840: 6f72 6d61 7469 6f6e 0a0a 2020 2020 2020  ormation..      
+00022850: 2020 7820 3d20 6f75 7470 7574 5f70 6f73    x = output_pos
+00022860: 6974 696f 6e5b 305d 2a63 6f6e 7374 616e  ition[0]*constan
+00022870: 7473 2e4d 494c 4c49 4d45 5452 455f 544f  ts.MILLIMETRE_TO
+00022880: 5f4d 4554 5245 0a20 2020 2020 2020 2079  _METRE.        y
+00022890: 203d 206f 7574 7075 745f 706f 7369 7469   = output_positi
+000228a0: 6f6e 5b31 5d2a 636f 6e73 7461 6e74 732e  on[1]*constants.
+000228b0: 4d49 4c4c 494d 4554 5245 5f54 4f5f 4d45  MILLIMETRE_TO_ME
+000228c0: 5452 450a 2020 2020 2020 2020 7a20 3d20  TRE.        z = 
+000228d0: 6f75 7470 7574 5f70 6f73 6974 696f 6e5b  output_position[
+000228e0: 325d 2a63 6f6e 7374 616e 7473 2e4d 494c  2]*constants.MIL
+000228f0: 4c49 4d45 5452 455f 544f 5f4d 4554 5245  LIMETRE_TO_METRE
+00022900: 0a20 2020 2020 2020 2072 203d 206f 7574  .        r = out
+00022910: 7075 745f 706f 7369 7469 6f6e 5b33 5d2a  put_position[3]*
+00022920: 636f 6e73 7461 6e74 732e 4445 4752 4545  constants.DEGREE
+00022930: 535f 544f 5f52 4144 4941 4e53 0a0a 2020  S_TO_RADIANS..  
+00022940: 2020 2020 2020 7265 7475 726e 2046 6962        return Fib
+00022950: 7365 6d4d 616e 6970 756c 6174 6f72 506f  semManipulatorPo
+00022960: 7369 7469 6f6e 2878 3d78 2c20 793d 792c  sition(x=x, y=y,
+00022970: 207a 3d7a 2c20 723d 7229 0a0a 0a0a 2020   z=z, r=r)....  
+00022980: 2020 6465 6620 696e 7365 7274 5f6d 616e    def insert_man
+00022990: 6970 756c 6174 6f72 2873 656c 662c 206e  ipulator(self, n
+000229a0: 616d 653a 2073 7472 203d 2022 5374 616e  ame: str = "Stan
+000229b0: 6462 7922 293a 0a20 2020 2020 2020 205f  dby"):.        _
+000229c0: 6368 6563 6b5f 6e65 6564 6c65 2873 656c  check_needle(sel
+000229d0: 662e 6861 7264 7761 7265 5f73 6574 7469  f.hardware_setti
+000229e0: 6e67 7329 0a20 2020 2020 2020 2070 7265  ngs).        pre
+000229f0: 7365 745f 706f 7369 7469 6f6e 7320 3d20  set_positions = 
+00022a00: 5b22 5061 726b 696e 6722 2c22 5374 616e  ["Parking","Stan
+00022a10: 6462 7922 2c22 576f 726b 696e 6722 2c5d  dby","Working",]
+00022a20: 0a0a 2020 2020 2020 2020 6966 206e 616d  ..        if nam
+00022a30: 6520 3d3d 2022 5041 524b 223a 0a20 2020  e == "PARK":.   
+00022a40: 2020 2020 2020 2020 206e 616d 6520 3d20           name = 
+00022a50: 2250 6172 6b69 6e67 220a 0a20 2020 2020  "Parking"..     
+00022a60: 2020 2066 6f72 2070 6f73 6974 696f 6e20     for position 
+00022a70: 696e 2070 7265 7365 745f 706f 7369 7469  in preset_positi
+00022a80: 6f6e 733a 0a20 2020 2020 2020 2020 2020  ons:.           
+00022a90: 2069 6620 6e61 6d65 2e6c 6f77 6572 2829   if name.lower()
+00022aa0: 203d 3d20 706f 7369 7469 6f6e 2e6c 6f77   == position.low
+00022ab0: 6572 2829 3a0a 2020 2020 2020 2020 2020  er():.          
+00022ac0: 2020 2020 2020 6e61 6d65 203d 2070 6f73        name = pos
+00022ad0: 6974 696f 6e0a 2020 2020 0a0a 2020 2020  ition.    ..    
+00022ae0: 2020 2020 6966 206e 616d 6520 6e6f 7420      if name not 
+00022af0: 696e 2070 7265 7365 745f 706f 7369 7469  in preset_positi
+00022b00: 6f6e 733a 0a20 2020 2020 2020 2020 2020  ons:.           
+00022b10: 2072 6169 7365 2056 616c 7565 4572 726f   raise ValueErro
+00022b20: 7228 6622 506f 7369 7469 6f6e 207b 6e61  r(f"Position {na
+00022b30: 6d65 7d20 6973 206e 6f74 2061 2076 616c  me} is not a val
+00022b40: 6964 2070 7265 7365 7420 706f 7369 7469  id preset positi
+00022b50: 6f6e 2e20 5661 6c69 6420 706f 7369 7469  on. Valid positi
+00022b60: 6f6e 7320 6172 6520 7b70 7265 7365 745f  ons are {preset_
+00022b70: 706f 7369 7469 6f6e 737d 2e22 290a 0a0a  positions}.")...
+00022b80: 2020 2020 2020 2020 696e 7365 7274 5f70          insert_p
+00022b90: 6f73 6974 696f 6e20 3d20 6765 7461 7474  osition = getatt
+00022ba0: 7228 7365 6c66 2e63 6f6e 6e65 6374 696f  r(self.connectio
+00022bb0: 6e2e 4e61 6e6f 6d61 6e69 7075 6c61 746f  n.Nanomanipulato
+00022bc0: 722e 506f 7369 7469 6f6e 2c6e 616d 6529  r.Position,name)
+00022bd0: 0a0a 2020 2020 2020 2020 696e 6465 7820  ..        index 
+00022be0: 3d20 300a 2020 2020 2020 2020 6c6f 6767  = 0.        logg
+00022bf0: 696e 672e 696e 666f 2866 2249 6e73 6572  ing.info(f"Inser
+00022c00: 7469 6e67 204e 616e 6f6d 616e 6970 756c  ting Nanomanipul
+00022c10: 6174 6f72 2074 6f20 7b6e 616d 657d 2070  ator to {name} p
+00022c20: 6f73 6974 696f 6e22 290a 2020 2020 2020  osition").      
+00022c30: 2020 7365 6c66 2e63 6f6e 6e65 6374 696f    self.connectio
+00022c40: 6e2e 4e61 6e6f 6d61 6e69 7075 6c61 746f  n.Nanomanipulato
+00022c50: 722e 4d6f 7665 546f 506f 7369 7469 6f6e  r.MoveToPosition
+00022c60: 2849 6e64 6578 3d69 6e64 6578 2c50 6f73  (Index=index,Pos
+00022c70: 6974 696f 6e3d 696e 7365 7274 5f70 6f73  ition=insert_pos
+00022c80: 6974 696f 6e29 0a0a 2020 2020 6465 6620  ition)..    def 
+00022c90: 5f63 6865 636b 5f6d 616e 6970 756c 6174  _check_manipulat
+00022ca0: 6f72 5f6c 696d 6974 7328 7365 6c66 2c78  or_limits(self,x
+00022cb0: 2c79 2c7a 2c72 293a 0a0a 2020 2020 2020  ,y,z,r):..      
+00022cc0: 2020 6c69 6d69 7473 203d 2073 656c 662e    limits = self.
+00022cd0: 636f 6e6e 6563 7469 6f6e 2e4e 616e 6f6d  connection.Nanom
+00022ce0: 616e 6970 756c 6174 6f72 2e47 6574 4c69  anipulator.GetLi
+00022cf0: 6d69 7473 2849 6e64 6578 3d30 2c54 7970  mits(Index=0,Typ
+00022d00: 653d 3029 0a0a 2020 2020 2020 2020 786d  e=0)..        xm
+00022d10: 696e 203d 206c 696d 6974 735b 305d 0a20  in = limits[0]. 
+00022d20: 2020 2020 2020 2078 6d61 7820 3d20 6c69         xmax = li
+00022d30: 6d69 7473 5b31 5d0a 2020 2020 2020 2020  mits[1].        
+00022d40: 796d 696e 203d 206c 696d 6974 735b 325d  ymin = limits[2]
+00022d50: 0a20 2020 2020 2020 2079 6d61 7820 3d20  .        ymax = 
+00022d60: 6c69 6d69 7473 5b33 5d0a 2020 2020 2020  limits[3].      
+00022d70: 2020 7a6d 696e 203d 206c 696d 6974 735b    zmin = limits[
+00022d80: 345d 0a20 2020 2020 2020 207a 6d61 7820  4].        zmax 
+00022d90: 3d20 6c69 6d69 7473 5b35 5d0a 2020 2020  = limits[5].    
+00022da0: 2020 2020 726d 696e 203d 206c 696d 6974      rmin = limit
+00022db0: 735b 365d 0a20 2020 2020 2020 2072 6d61  s[6].        rma
+00022dc0: 7820 3d20 6c69 6d69 7473 5b37 5d0a 0a20  x = limits[7].. 
+00022dd0: 2020 2020 2020 2061 7373 6572 7420 7820         assert x 
+00022de0: 3e3d 2078 6d69 6e20 616e 6420 7820 3c3d  >= xmin and x <=
+00022df0: 2078 6d61 782c 2066 2258 2070 6f73 6974   xmax, f"X posit
+00022e00: 696f 6e20 7b78 7d20 6973 206f 7574 7369  ion {x} is outsi
+00022e10: 6465 206f 6620 6d61 6e69 7075 6c61 746f  de of manipulato
+00022e20: 7220 6c69 6d69 7473 207b 786d 696e 7d20  r limits {xmin} 
+00022e30: 746f 207b 786d 6178 7d22 0a20 2020 2020  to {xmax}".     
+00022e40: 2020 2061 7373 6572 7420 7920 3e3d 2079     assert y >= y
+00022e50: 6d69 6e20 616e 6420 7920 3c3d 2079 6d61  min and y <= yma
+00022e60: 782c 2066 2259 2070 6f73 6974 696f 6e20  x, f"Y position 
+00022e70: 7b79 7d20 6973 206f 7574 7369 6465 206f  {y} is outside o
+00022e80: 6620 6d61 6e69 7075 6c61 746f 7220 6c69  f manipulator li
+00022e90: 6d69 7473 207b 796d 696e 7d20 746f 207b  mits {ymin} to {
+00022ea0: 796d 6178 7d22 0a20 2020 2020 2020 2061  ymax}".        a
+00022eb0: 7373 6572 7420 7a20 3e3d 207a 6d69 6e20  ssert z >= zmin 
+00022ec0: 616e 6420 7a20 3c3d 207a 6d61 782c 2066  and z <= zmax, f
+00022ed0: 225a 2070 6f73 6974 696f 6e20 7b7a 7d20  "Z position {z} 
+00022ee0: 6973 206f 7574 7369 6465 206f 6620 6d61  is outside of ma
+00022ef0: 6e69 7075 6c61 746f 7220 6c69 6d69 7473  nipulator limits
+00022f00: 207b 7a6d 696e 7d20 746f 207b 7a6d 6178   {zmin} to {zmax
+00022f10: 7d22 0a20 2020 2020 2020 2061 7373 6572  }".        asser
+00022f20: 7420 7220 3e3d 2072 6d69 6e20 616e 6420  t r >= rmin and 
+00022f30: 7220 3c3d 2072 6d61 782c 2066 2252 2070  r <= rmax, f"R p
+00022f40: 6f73 6974 696f 6e20 7b72 7d20 6973 206f  osition {r} is o
+00022f50: 7574 7369 6465 206f 6620 6d61 6e69 7075  utside of manipu
+00022f60: 6c61 746f 7220 6c69 6d69 7473 207b 726d  lator limits {rm
+00022f70: 696e 7d20 746f 207b 726d 6178 7d22 0a20  in} to {rmax}". 
+00022f80: 2020 200a 2020 2020 6465 6620 7265 7472     .    def retr
+00022f90: 6163 745f 6d61 6e69 7075 6c61 746f 7228  act_manipulator(
+00022fa0: 7365 6c66 293a 0a20 2020 2020 2020 2072  self):.        r
+00022fb0: 6574 7261 6374 5f70 6f73 6974 696f 6e20  etract_position 
+00022fc0: 3d20 6765 7461 7474 7228 7365 6c66 2e63  = getattr(self.c
+00022fd0: 6f6e 6e65 6374 696f 6e2e 4e61 6e6f 6d61  onnection.Nanoma
+00022fe0: 6e69 7075 6c61 746f 722e 506f 7369 7469  nipulator.Positi
+00022ff0: 6f6e 2c22 5061 726b 696e 6722 290a 2020  on,"Parking").  
+00023000: 2020 2020 2020 696e 6465 7820 3d20 300a        index = 0.
+00023010: 2020 2020 2020 2020 7365 6c66 2e63 6f6e          self.con
+00023020: 6e65 6374 696f 6e2e 4e61 6e6f 6d61 6e69  nection.Nanomani
+00023030: 7075 6c61 746f 722e 4d6f 7665 546f 506f  pulator.MoveToPo
+00023040: 7369 7469 6f6e 2849 6e64 6578 3d69 6e64  sition(Index=ind
+00023050: 6578 2c50 6f73 6974 696f 6e3d 7265 7472  ex,Position=retr
+00023060: 6163 745f 706f 7369 7469 6f6e 290a 2020  act_position).  
+00023070: 2020 2020 2020 0a0a 2020 2020 0a20 2020        ..    .   
+00023080: 2064 6566 206d 6f76 655f 6d61 6e69 7075   def move_manipu
+00023090: 6c61 746f 725f 7265 6c61 7469 7665 2873  lator_relative(s
+000230a0: 656c 662c 706f 7369 7469 6f6e 3a20 4669  elf,position: Fi
+000230b0: 6273 656d 4d61 6e69 7075 6c61 746f 7250  bsemManipulatorP
+000230c0: 6f73 6974 696f 6e2c 206e 616d 653a 2073  osition, name: s
+000230d0: 7472 203d 204e 6f6e 6529 3a0a 2020 2020  tr = None):.    
+000230e0: 2020 2020 6966 206e 6f74 206e 702e 6973      if not np.is
+000230f0: 636c 6f73 6528 706f 7369 7469 6f6e 2e72  close(position.r
+00023100: 2c20 302e 3029 3a0a 2020 2020 2020 2020  , 0.0):.        
+00023110: 2020 2020 726f 7461 7469 6f6e 203d 2054      rotation = T
+00023120: 7275 650a 2020 2020 2020 2020 656c 7365  rue.        else
+00023130: 3a0a 2020 2020 2020 2020 2020 2020 726f  :.            ro
+00023140: 7461 7469 6f6e 203d 2046 616c 7365 0a20  tation = False. 
+00023150: 2020 2020 2020 2069 6620 6e6f 7420 6e70         if not np
+00023160: 2e69 7363 6c6f 7365 2870 6f73 6974 696f  .isclose(positio
+00023170: 6e2e 742c 2030 2e30 293a 0a20 2020 2020  n.t, 0.0):.     
+00023180: 2020 2020 2020 2074 696c 7420 3d20 5472         tilt = Tr
+00023190: 7565 0a20 2020 2020 2020 2065 6c73 653a  ue.        else:
+000231a0: 0a20 2020 2020 2020 2020 2020 2074 696c  .            til
+000231b0: 7420 3d20 4661 6c73 650a 2020 2020 2020  t = False.      
+000231c0: 2020 5f63 6865 636b 5f6e 6565 646c 6528    _check_needle(
+000231d0: 7365 6c66 2e68 6172 6477 6172 655f 7365  self.hardware_se
+000231e0: 7474 696e 6773 2c20 726f 7461 7469 6f6e  ttings, rotation
+000231f0: 2c20 7469 6c74 290a 2020 2020 2020 2020  , tilt).        
+00023200: 6966 2073 656c 662e 636f 6e6e 6563 7469  if self.connecti
+00023210: 6f6e 2e4e 616e 6f6d 616e 6970 756c 6174  on.Nanomanipulat
+00023220: 6f72 2e49 7343 616c 6962 7261 7465 6428  or.IsCalibrated(
+00023230: 3029 203d 3d20 4661 6c73 653a 0a20 2020  0) == False:.   
+00023240: 2020 2020 2020 2020 206c 6f67 6769 6e67           logging
+00023250: 2e69 6e66 6f28 2243 616c 6962 7261 7469  .info("Calibrati
+00023260: 6e67 206d 616e 6970 756c 6174 6f72 2229  ng manipulator")
+00023270: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00023280: 662e 636f 6e6e 6563 7469 6f6e 2e4e 616e  f.connection.Nan
+00023290: 6f6d 616e 6970 756c 6174 6f72 2e43 616c  omanipulator.Cal
+000232a0: 6962 7261 7465 2830 290a 0a20 2020 2020  ibrate(0)..     
+000232b0: 2020 2063 7572 7265 6e74 5f70 6f73 6974     current_posit
+000232c0: 696f 6e20 3d20 7365 6c66 2e67 6574 5f6d  ion = self.get_m
+000232d0: 616e 6970 756c 6174 6f72 5f70 6f73 6974  anipulator_posit
+000232e0: 696f 6e28 290a 2020 2020 2020 2020 0a20  ion().        . 
+000232f0: 2020 2020 2020 2078 203d 2028 6375 7272         x = (curr
+00023300: 656e 745f 706f 7369 7469 6f6e 2e78 202b  ent_position.x +
+00023310: 2070 6f73 6974 696f 6e2e 7829 2a63 6f6e   position.x)*con
+00023320: 7374 616e 7473 2e4d 4554 5245 5f54 4f5f  stants.METRE_TO_
+00023330: 4d49 4c4c 494d 4554 5245 0a20 2020 2020  MILLIMETRE.     
+00023340: 2020 2079 203d 2028 6375 7272 656e 745f     y = (current_
+00023350: 706f 7369 7469 6f6e 2e79 202b 2070 6f73  position.y + pos
+00023360: 6974 696f 6e2e 7929 2a63 6f6e 7374 616e  ition.y)*constan
+00023370: 7473 2e4d 4554 5245 5f54 4f5f 4d49 4c4c  ts.METRE_TO_MILL
+00023380: 494d 4554 5245 0a20 2020 2020 2020 207a  IMETRE.        z
+00023390: 203d 2028 6375 7272 656e 745f 706f 7369   = (current_posi
+000233a0: 7469 6f6e 2e7a 202b 2070 6f73 6974 696f  tion.z + positio
+000233b0: 6e2e 7a29 2a63 6f6e 7374 616e 7473 2e4d  n.z)*constants.M
+000233c0: 4554 5245 5f54 4f5f 4d49 4c4c 494d 4554  ETRE_TO_MILLIMET
+000233d0: 5245 0a20 2020 2020 2020 2072 203d 2028  RE.        r = (
+000233e0: 6375 7272 656e 745f 706f 7369 7469 6f6e  current_position
+000233f0: 2e72 202b 2070 6f73 6974 696f 6e2e 7229  .r + position.r)
+00023400: 2a63 6f6e 7374 616e 7473 2e52 4144 4941  *constants.RADIA
+00023410: 4e53 5f54 4f5f 4445 4752 4545 530a 2020  NS_TO_DEGREES.  
+00023420: 2020 2020 2020 696e 6465 7820 3d20 300a        index = 0.
+00023430: 0a20 2020 2020 2020 2023 2073 656c 662e  .        # self.
+00023440: 5f63 6865 636b 5f6d 616e 6970 756c 6174  _check_manipulat
+00023450: 6f72 5f6c 696d 6974 7328 782c 792c 7a2c  or_limits(x,y,z,
+00023460: 7229 0a0a 2020 2020 2020 2020 6c6f 6767  r)..        logg
+00023470: 696e 672e 696e 666f 2866 226d 6f76 696e  ing.info(f"movin
+00023480: 6720 6d61 6e69 7075 6c61 746f 7220 6279  g manipulator by
+00023490: 207b 706f 7369 7469 6f6e 7d22 290a 2020   {position}").  
+000234a0: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
+000234b0: 2020 2020 2020 2073 656c 662e 636f 6e6e         self.conn
+000234c0: 6563 7469 6f6e 2e4e 616e 6f6d 616e 6970  ection.Nanomanip
+000234d0: 756c 6174 6f72 2e4d 6f76 6554 6f28 496e  ulator.MoveTo(In
+000234e0: 6465 783d 696e 6465 782c 583d 782c 2059  dex=index,X=x, Y
+000234f0: 3d79 2c20 5a3d 7a2c 2052 6f74 3d72 290a  =y, Z=z, Rot=r).
+00023500: 2020 2020 2020 2020 6578 6365 7074 2045          except E
+00023510: 7863 6570 7469 6f6e 2061 7320 653a 0a20  xception as e:. 
+00023520: 2020 2020 2020 2020 2020 206c 6f67 6769             loggi
+00023530: 6e67 2e65 7272 6f72 2865 290a 2020 2020  ng.error(e).    
+00023540: 2020 2020 2020 2020 7265 7475 726e 2065          return e
+00023550: 0a0a 2020 2020 0a20 2020 2064 6566 206d  ..    .    def m
+00023560: 6f76 655f 6d61 6e69 7075 6c61 746f 725f  ove_manipulator_
+00023570: 6162 736f 6c75 7465 2873 656c 662c 2070  absolute(self, p
+00023580: 6f73 6974 696f 6e3a 2046 6962 7365 6d4d  osition: FibsemM
+00023590: 616e 6970 756c 6174 6f72 506f 7369 7469  anipulatorPositi
+000235a0: 6f6e 2c20 6e61 6d65 3a20 7374 7220 3d20  on, name: str = 
+000235b0: 4e6f 6e65 293a 0a20 2020 2020 2020 2069  None):.        i
+000235c0: 6620 6e6f 7420 6e70 2e69 7363 6c6f 7365  f not np.isclose
+000235d0: 2870 6f73 6974 696f 6e2e 722c 2030 2e30  (position.r, 0.0
+000235e0: 293a 0a20 2020 2020 2020 2020 2020 2072  ):.            r
+000235f0: 6f74 6174 696f 6e20 3d20 5472 7565 0a20  otation = True. 
+00023600: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00023610: 2020 2020 2020 2020 2072 6f74 6174 696f           rotatio
+00023620: 6e20 3d20 4661 6c73 650a 2020 2020 2020  n = False.      
+00023630: 2020 6966 206e 6f74 206e 702e 6973 636c    if not np.iscl
+00023640: 6f73 6528 706f 7369 7469 6f6e 2e74 2c20  ose(position.t, 
+00023650: 302e 3029 3a0a 2020 2020 2020 2020 2020  0.0):.          
+00023660: 2020 7469 6c74 203d 2054 7275 650a 2020    tilt = True.  
+00023670: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00023680: 2020 2020 2020 2020 7469 6c74 203d 2046          tilt = F
+00023690: 616c 7365 0a20 2020 2020 2020 205f 6368  alse.        _ch
+000236a0: 6563 6b5f 6e65 6564 6c65 2873 656c 662e  eck_needle(self.
+000236b0: 6861 7264 7761 7265 5f73 6574 7469 6e67  hardware_setting
+000236c0: 732c 2072 6f74 6174 696f 6e2c 2074 696c  s, rotation, til
+000236d0: 7429 0a20 2020 2020 2020 2069 6620 7365  t).        if se
+000236e0: 6c66 2e63 6f6e 6e65 6374 696f 6e2e 4e61  lf.connection.Na
+000236f0: 6e6f 6d61 6e69 7075 6c61 746f 722e 4973  nomanipulator.Is
+00023700: 4361 6c69 6272 6174 6564 2830 2920 3d3d  Calibrated(0) ==
+00023710: 2046 616c 7365 3a0a 2020 2020 2020 2020   False:.        
+00023720: 2020 2020 6c6f 6767 696e 672e 696e 666f      logging.info
+00023730: 2822 4361 6c69 6272 6174 696e 6720 6d61  ("Calibrating ma
+00023740: 6e69 7075 6c61 746f 7222 290a 2020 2020  nipulator").    
+00023750: 2020 2020 2020 2020 7365 6c66 2e63 6f6e          self.con
+00023760: 6e65 6374 696f 6e2e 4e61 6e6f 6d61 6e69  nection.Nanomani
+00023770: 7075 6c61 746f 722e 4361 6c69 6272 6174  pulator.Calibrat
+00023780: 6528 3029 0a20 2020 2020 2020 200a 2020  e(0).        .  
+00023790: 2020 2020 2020 7820 3d20 706f 7369 7469        x = positi
+000237a0: 6f6e 2e78 2a63 6f6e 7374 616e 7473 2e4d  on.x*constants.M
+000237b0: 4554 5245 5f54 4f5f 4d49 4c4c 494d 4554  ETRE_TO_MILLIMET
+000237c0: 5245 0a20 2020 2020 2020 2079 203d 2070  RE.        y = p
+000237d0: 6f73 6974 696f 6e2e 792a 636f 6e73 7461  osition.y*consta
+000237e0: 6e74 732e 4d45 5452 455f 544f 5f4d 494c  nts.METRE_TO_MIL
+000237f0: 4c49 4d45 5452 450a 2020 2020 2020 2020  LIMETRE.        
+00023800: 7a20 3d20 706f 7369 7469 6f6e 2e7a 2a63  z = position.z*c
+00023810: 6f6e 7374 616e 7473 2e4d 4554 5245 5f54  onstants.METRE_T
+00023820: 4f5f 4d49 4c4c 494d 4554 5245 0a20 2020  O_MILLIMETRE.   
+00023830: 2020 2020 2072 203d 2070 6f73 6974 696f       r = positio
+00023840: 6e2e 722a 636f 6e73 7461 6e74 732e 5241  n.r*constants.RA
+00023850: 4449 414e 535f 544f 5f44 4547 5245 4553  DIANS_TO_DEGREES
+00023860: 0a20 2020 2020 2020 2069 6e64 6578 203d  .        index =
+00023870: 2030 0a0a 2020 2020 2020 2020 2320 7365   0..        # se
+00023880: 6c66 2e5f 6368 6563 6b5f 6d61 6e69 7075  lf._check_manipu
+00023890: 6c61 746f 725f 6c69 6d69 7473 2878 2c79  lator_limits(x,y
+000238a0: 2c7a 2c72 290a 0a20 2020 2020 2020 206c  ,z,r)..        l
+000238b0: 6f67 6769 6e67 2e69 6e66 6f28 6622 6d6f  ogging.info(f"mo
+000238c0: 7669 6e67 206d 616e 6970 756c 6174 6f72  ving manipulator
+000238d0: 2074 6f20 7b70 6f73 6974 696f 6e7d 2229   to {position}")
+000238e0: 0a0a 2020 2020 2020 2020 7365 6c66 2e63  ..        self.c
+000238f0: 6f6e 6e65 6374 696f 6e2e 4e61 6e6f 6d61  onnection.Nanoma
+00023900: 6e69 7075 6c61 746f 722e 4d6f 7665 546f  nipulator.MoveTo
+00023910: 2849 6e64 6578 3d69 6e64 6578 2c20 583d  (Index=index, X=
+00023920: 782c 2059 3d79 2c20 5a3d 7a2c 2052 6f74  x, Y=y, Z=z, Rot
+00023930: 3d72 290a 0a20 2020 2064 6566 2063 616c  =r)..    def cal
+00023940: 6962 7261 7465 5f6d 616e 6970 756c 6174  ibrate_manipulat
+00023950: 6f72 2873 656c 6629 3a0a 2020 2020 2020  or(self):.      
+00023960: 2020 5f63 6865 636b 5f6e 6565 646c 6528    _check_needle(
+00023970: 7365 6c66 2e68 6172 6477 6172 655f 7365  self.hardware_se
+00023980: 7474 696e 6773 290a 2020 2020 2020 2020  ttings).        
+00023990: 6c6f 6767 696e 672e 696e 666f 2822 4361  logging.info("Ca
+000239a0: 6c69 6272 6174 696e 6720 6d61 6e69 7075  librating manipu
+000239b0: 6c61 746f 7222 290a 2020 2020 2020 2020  lator").        
+000239c0: 7365 6c66 2e63 6f6e 6e65 6374 696f 6e2e  self.connection.
+000239d0: 4e61 6e6f 6d61 6e69 7075 6c61 746f 722e  Nanomanipulator.
+000239e0: 4361 6c69 6272 6174 6528 3029 0a0a 2020  Calibrate(0)..  
+000239f0: 2020 6465 6620 5f78 5f63 6f72 7265 6374    def _x_correct
+00023a00: 6564 5f6e 6565 646c 655f 6d6f 7665 6d65  ed_needle_moveme
+00023a10: 6e74 2873 656c 662c 2065 7870 6563 7465  nt(self, expecte
+00023a20: 645f 783a 2066 6c6f 6174 2920 2d3e 2046  d_x: float) -> F
+00023a30: 6962 7365 6d4d 616e 6970 756c 6174 6f72  ibsemManipulator
+00023a40: 506f 7369 7469 6f6e 3a0a 2020 2020 2020  Position:.      
+00023a50: 2020 2222 2243 616c 6375 6c61 7465 2074    """Calculate t
+00023a60: 6865 2063 6f72 7265 6374 6564 206e 6565  he corrected nee
+00023a70: 646c 6520 6d6f 7665 6d65 6e74 2074 6f20  dle movement to 
+00023a80: 6d6f 7665 2069 6e20 7468 6520 782d 6178  move in the x-ax
+00023a90: 6973 2e0a 0a20 2020 2020 2020 2041 7267  is...        Arg
+00023aa0: 733a 0a20 2020 2020 2020 2020 2020 2065  s:.            e
+00023ab0: 7870 6563 7465 645f 7820 2866 6c6f 6174  xpected_x (float
+00023ac0: 293a 2064 6973 7461 6e63 6520 616c 6f6e  ): distance alon
+00023ad0: 6720 7468 6520 782d 6178 6973 2028 696d  g the x-axis (im
+00023ae0: 6167 6520 636f 6f72 6469 6e61 7465 7329  age coordinates)
+00023af0: 0a20 2020 2020 2020 2052 6574 7572 6e73  .        Returns
+00023b00: 3a0a 2020 2020 2020 2020 2020 2020 4669  :.            Fi
+00023b10: 6273 656d 4d61 6e69 7075 6c61 746f 7250  bsemManipulatorP
+00023b20: 6f73 6974 696f 6e3a 2078 2d63 6f72 7265  osition: x-corre
+00023b30: 6374 6564 206e 6565 646c 6520 6d6f 7665  cted needle move
+00023b40: 6d65 6e74 2028 7265 6c61 7469 7665 2070  ment (relative p
+00023b50: 6f73 6974 696f 6e29 0a20 2020 2020 2020  osition).       
+00023b60: 2022 2222 0a20 2020 2020 2020 2072 6574   """.        ret
+00023b70: 7572 6e20 4669 6273 656d 4d61 6e69 7075  urn FibsemManipu
+00023b80: 6c61 746f 7250 6f73 6974 696f 6e28 783d  latorPosition(x=
+00023b90: 6578 7065 6374 6564 5f78 2c20 793d 302c  expected_x, y=0,
+00023ba0: 207a 3d30 2920 2023 206e 6f20 6164 6a75   z=0)  # no adju
+00023bb0: 7374 6d65 6e74 206e 6565 6465 640a 0a0a  stment needed...
+00023bc0: 2020 2020 6465 6620 5f79 5f63 6f72 7265      def _y_corre
+00023bd0: 6374 6564 5f6e 6565 646c 655f 6d6f 7665  cted_needle_move
+00023be0: 6d65 6e74 2873 656c 662c 200a 2020 2020  ment(self, .    
+00023bf0: 2020 2020 6578 7065 6374 6564 5f79 3a20      expected_y: 
+00023c00: 666c 6f61 742c 2073 7461 6765 5f74 696c  float, stage_til
+00023c10: 743a 2066 6c6f 6174 0a20 2020 2029 202d  t: float.    ) -
+00023c20: 3e20 4669 6273 656d 4d61 6e69 7075 6c61  > FibsemManipula
+00023c30: 746f 7250 6f73 6974 696f 6e3a 0a20 2020  torPosition:.   
+00023c40: 2020 2020 2022 2222 4361 6c63 756c 6174       """Calculat
+00023c50: 6520 7468 6520 636f 7272 6563 7465 6420  e the corrected 
+00023c60: 6e65 6564 6c65 206d 6f76 656d 656e 7420  needle movement 
+00023c70: 746f 206d 6f76 6520 696e 2074 6865 2079  to move in the y
+00023c80: 2d61 7869 732e 0a0a 2020 2020 2020 2020  -axis...        
+00023c90: 4172 6773 3a0a 2020 2020 2020 2020 2020  Args:.          
+00023ca0: 2020 6578 7065 6374 6564 5f79 2028 666c    expected_y (fl
+00023cb0: 6f61 7429 3a20 6469 7374 616e 6365 2061  oat): distance a
+00023cc0: 6c6f 6e67 2074 6865 2079 2d61 7869 7320  long the y-axis 
+00023cd0: 2869 6d61 6765 2063 6f6f 7264 696e 6174  (image coordinat
+00023ce0: 6573 290a 2020 2020 2020 2020 2020 2020  es).            
+00023cf0: 7374 6167 655f 7469 6c74 2028 666c 6f61  stage_tilt (floa
+00023d00: 742c 206f 7074 696f 6e61 6c29 3a20 7374  t, optional): st
+00023d10: 6167 6520 7469 6c74 2e0a 0a20 2020 2020  age tilt...     
+00023d20: 2020 2052 6574 7572 6e73 3a0a 2020 2020     Returns:.    
+00023d30: 2020 2020 2020 2020 4669 6273 656d 4d61          FibsemMa
+00023d40: 6e69 7075 6c61 746f 7250 6f73 6974 696f  nipulatorPositio
+00023d50: 6e3a 2079 2d63 6f72 7265 6374 6564 206e  n: y-corrected n
+00023d60: 6565 646c 6520 6d6f 7665 6d65 6e74 2028  eedle movement (
+00023d70: 7265 6c61 7469 7665 2070 6f73 6974 696f  relative positio
+00023d80: 6e29 0a20 2020 2020 2020 2022 2222 0a20  n).        """. 
+00023d90: 2020 2020 2020 2079 5f6d 6f76 6520 3d20         y_move = 
+00023da0: 2b6e 702e 636f 7328 7374 6167 655f 7469  +np.cos(stage_ti
+00023db0: 6c74 2920 2a20 6578 7065 6374 6564 5f79  lt) * expected_y
+00023dc0: 0a20 2020 2020 2020 207a 5f6d 6f76 6520  .        z_move 
+00023dd0: 3d20 2b6e 702e 7369 6e28 7374 6167 655f  = +np.sin(stage_
+00023de0: 7469 6c74 2920 2a20 6578 7065 6374 6564  tilt) * expected
+00023df0: 5f79 0a20 2020 2020 2020 2072 6574 7572  _y.        retur
+00023e00: 6e20 4669 6273 656d 4d61 6e69 7075 6c61  n FibsemManipula
+00023e10: 746f 7250 6f73 6974 696f 6e28 783d 302c  torPosition(x=0,
+00023e20: 2079 3d79 5f6d 6f76 652c 207a 3d7a 5f6d   y=y_move, z=z_m
+00023e30: 6f76 6529 0a0a 0a20 2020 2064 6566 205f  ove)...    def _
+00023e40: 7a5f 636f 7272 6563 7465 645f 6e65 6564  z_corrected_need
+00023e50: 6c65 5f6d 6f76 656d 656e 7428 7365 6c66  le_movement(self
+00023e60: 2c20 0a20 2020 2020 2020 2065 7870 6563  , .        expec
+00023e70: 7465 645f 7a3a 2066 6c6f 6174 2c20 7374  ted_z: float, st
+00023e80: 6167 655f 7469 6c74 3a20 666c 6f61 740a  age_tilt: float.
+00023e90: 2020 2020 2920 2d3e 2046 6962 7365 6d4d      ) -> FibsemM
+00023ea0: 616e 6970 756c 6174 6f72 506f 7369 7469  anipulatorPositi
+00023eb0: 6f6e 3a0a 2020 2020 2020 2020 2222 2243  on:.        """C
+00023ec0: 616c 6375 6c61 7465 2074 6865 2063 6f72  alculate the cor
+00023ed0: 7265 6374 6564 206e 6565 646c 6520 6d6f  rected needle mo
+00023ee0: 7665 6d65 6e74 2074 6f20 6d6f 7665 2069  vement to move i
+00023ef0: 6e20 7468 6520 7a2d 6178 6973 2e0a 0a20  n the z-axis... 
+00023f00: 2020 2020 2020 2041 7267 733a 0a20 2020         Args:.   
+00023f10: 2020 2020 2020 2020 2065 7870 6563 7465           expecte
+00023f20: 645f 7a20 2866 6c6f 6174 293a 2064 6973  d_z (float): dis
+00023f30: 7461 6e63 6520 616c 6f6e 6720 7468 6520  tance along the 
+00023f40: 7a2d 6178 6973 2028 696d 6167 6520 636f  z-axis (image co
+00023f50: 6f72 6469 6e61 7465 7329 0a20 2020 2020  ordinates).     
+00023f60: 2020 2020 2020 2073 7461 6765 5f74 696c         stage_til
+00023f70: 7420 2866 6c6f 6174 2c20 6f70 7469 6f6e  t (float, option
+00023f80: 616c 293a 2073 7461 6765 2074 696c 742e  al): stage tilt.
+00023f90: 0a0a 2020 2020 2020 2020 5265 7475 726e  ..        Return
+00023fa0: 733a 0a20 2020 2020 2020 2020 2020 2046  s:.            F
+00023fb0: 6962 7365 6d4d 616e 6970 756c 6174 6f72  ibsemManipulator
+00023fc0: 506f 7369 7469 6f6e 3a20 7a2d 636f 7272  Position: z-corr
+00023fd0: 6563 7465 6420 6e65 6564 6c65 206d 6f76  ected needle mov
+00023fe0: 656d 656e 7420 2872 656c 6174 6976 6520  ement (relative 
+00023ff0: 706f 7369 7469 6f6e 290a 2020 2020 2020  position).      
+00024000: 2020 2222 220a 2020 2020 2020 2020 795f    """.        y_
+00024010: 6d6f 7665 203d 202d 6e70 2e73 696e 2873  move = -np.sin(s
+00024020: 7461 6765 5f74 696c 7429 202a 2065 7870  tage_tilt) * exp
+00024030: 6563 7465 645f 7a0a 2020 2020 2020 2020  ected_z.        
+00024040: 7a5f 6d6f 7665 203d 202b 6e70 2e63 6f73  z_move = +np.cos
+00024050: 2873 7461 6765 5f74 696c 7429 202a 2065  (stage_tilt) * e
+00024060: 7870 6563 7465 645f 7a0a 2020 2020 2020  xpected_z.      
+00024070: 2020 7265 7475 726e 2046 6962 7365 6d4d    return FibsemM
+00024080: 616e 6970 756c 6174 6f72 506f 7369 7469  anipulatorPositi
+00024090: 6f6e 2878 3d30 2c20 793d 795f 6d6f 7665  on(x=0, y=y_move
+000240a0: 2c20 7a3d 7a5f 6d6f 7665 290a 0a20 2020  , z=z_move)..   
+000240b0: 2064 6566 206d 6f76 655f 6d61 6e69 7075   def move_manipu
+000240c0: 6c61 746f 725f 636f 7272 6563 7465 6428  lator_corrected(
+000240d0: 7365 6c66 2c20 0a20 2020 2020 2020 2064  self, .        d
+000240e0: 783a 2066 6c6f 6174 203d 2030 2c0a 2020  x: float = 0,.  
+000240f0: 2020 2020 2020 6479 3a20 666c 6f61 7420        dy: float 
+00024100: 3d20 302c 0a20 2020 2020 2020 2062 6561  = 0,.        bea
+00024110: 6d5f 7479 7065 3a20 4265 616d 5479 7065  m_type: BeamType
+00024120: 203d 2042 6561 6d54 7970 652e 454c 4543   = BeamType.ELEC
+00024130: 5452 4f4e 2c0a 2020 2020 2920 2d3e 204e  TRON,.    ) -> N
+00024140: 6f6e 653a 0a20 2020 2020 2020 2022 2222  one:.        """
+00024150: 4361 6c63 756c 6174 6520 7468 6520 7265  Calculate the re
+00024160: 7175 6972 6564 2063 6f72 7265 6374 6564  quired corrected
+00024170: 206e 6565 646c 6520 6d6f 7665 6d65 6e74   needle movement
+00024180: 7320 6261 7365 6420 6f6e 2074 6865 2042  s based on the B
+00024190: 6561 6d54 7970 6520 746f 206d 6f76 6520  eamType to move 
+000241a0: 696e 2074 6865 2064 6573 6972 6564 2069  in the desired i
+000241b0: 6d61 6765 2063 6f6f 7264 696e 6174 6573  mage coordinates
+000241c0: 2e0a 2020 2020 2020 2020 5468 656e 206d  ..        Then m
+000241d0: 6f76 6520 7468 6520 6e65 6564 6c65 2072  ove the needle r
+000241e0: 656c 6174 6976 656c 792e 0a0a 2020 2020  elatively...    
+000241f0: 2020 2020 4265 616d 5479 7065 2e45 4c45      BeamType.ELE
+00024200: 4354 524f 4e3a 2020 6d6f 7665 2069 6e20  CTRON:  move in 
+00024210: 782c 2079 2028 7261 7720 636f 6f72 6469  x, y (raw coordi
+00024220: 6e61 7465 7329 0a20 2020 2020 2020 2042  nates).        B
+00024230: 6561 6d54 7970 652e 494f 4e3a 2020 2020  eamType.ION:    
+00024240: 2020 206d 6f76 6520 696e 2078 2c20 7a20     move in x, z 
+00024250: 2872 6177 2063 6f6f 7264 696e 6174 6573  (raw coordinates
+00024260: 290a 0a20 2020 2020 2020 2041 7267 733a  )..        Args:
+00024270: 0a20 2020 2020 2020 2020 2020 206d 6963  .            mic
+00024280: 726f 7363 6f70 6520 2853 6462 4d69 6372  roscope (SdbMicr
+00024290: 6f73 636f 7065 436c 6965 6e74 293a 2061  oscopeClient): a
+000242a0: 7574 6f53 6372 6970 7420 6d69 6372 6f73  utoScript micros
+000242b0: 636f 7065 2069 6e73 7461 6e63 650a 2020  cope instance.  
+000242c0: 2020 2020 2020 2020 2020 6478 2028 666c            dx (fl
+000242d0: 6f61 7429 3a20 6469 7374 616e 6365 2061  oat): distance a
+000242e0: 6c6f 6e67 2074 6865 2078 2d61 7869 7320  long the x-axis 
+000242f0: 2869 6d61 6765 2063 6f6f 7264 696e 6174  (image coordinat
+00024300: 6573 290a 2020 2020 2020 2020 2020 2020  es).            
+00024310: 6479 2028 666c 6f61 7429 3a20 6469 7374  dy (float): dist
+00024320: 616e 6365 2061 6c6f 6e67 2074 6865 2079  ance along the y
+00024330: 2d61 7869 7320 2869 6d61 6765 2063 6f72  -axis (image cor
+00024340: 6f64 696e 6174 6573 290a 2020 2020 2020  odinates).      
+00024350: 2020 2020 2020 6265 616d 5f74 7970 6520        beam_type 
+00024360: 2842 6561 6d54 7970 652c 206f 7074 696f  (BeamType, optio
+00024370: 6e61 6c29 3a20 7468 6520 6265 616d 2074  nal): the beam t
+00024380: 7970 6520 746f 206d 6f76 6520 696e 2e20  ype to move in. 
+00024390: 4465 6661 756c 7473 2074 6f20 4265 616d  Defaults to Beam
+000243a0: 5479 7065 2e45 4c45 4354 524f 4e2e 0a20  Type.ELECTRON.. 
+000243b0: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+000243c0: 2020 205f 6368 6563 6b5f 6e65 6564 6c65     _check_needle
+000243d0: 2873 656c 662e 6861 7264 7761 7265 5f73  (self.hardware_s
+000243e0: 6574 7469 6e67 7329 0a0a 2020 2020 2020  ettings)..      
+000243f0: 2020 6966 2073 656c 662e 636f 6e6e 6563    if self.connec
+00024400: 7469 6f6e 2e4e 616e 6f6d 616e 6970 756c  tion.Nanomanipul
+00024410: 6174 6f72 2e49 7343 616c 6962 7261 7465  ator.IsCalibrate
+00024420: 6428 3029 203d 3d20 4661 6c73 653a 0a20  d(0) == False:. 
+00024430: 2020 2020 2020 2020 2020 206c 6f67 6769             loggi
+00024440: 6e67 2e69 6e66 6f28 2243 616c 6962 7261  ng.info("Calibra
+00024450: 7469 6e67 206d 616e 6970 756c 6174 6f72  ting manipulator
+00024460: 2229 0a20 2020 2020 2020 2020 2020 2073  ").            s
+00024470: 656c 662e 636f 6e6e 6563 7469 6f6e 2e4e  elf.connection.N
+00024480: 616e 6f6d 616e 6970 756c 6174 6f72 2e43  anomanipulator.C
+00024490: 616c 6962 7261 7465 2830 290a 2020 2020  alibrate(0).    
+000244a0: 2020 2020 7374 6167 655f 7469 6c74 203d      stage_tilt =
+000244b0: 2073 656c 662e 6765 745f 7374 6167 655f   self.get_stage_
+000244c0: 706f 7369 7469 6f6e 2829 2e74 0a0a 0a20  position().t... 
+000244d0: 2020 2020 2020 2023 2023 2078 790a 2020         # # xy.  
+000244e0: 2020 2020 2020 2320 6966 2062 6561 6d5f        # if beam_
+000244f0: 7479 7065 2069 7320 4265 616d 5479 7065  type is BeamType
+00024500: 2e45 4c45 4354 524f 4e3a 0a20 2020 2020  .ELECTRON:.     
+00024510: 2020 2023 2020 2020 2078 5f6d 6f76 6520     #     x_move 
+00024520: 3d20 7365 6c66 2e5f 785f 636f 7272 6563  = self._x_correc
+00024530: 7465 645f 6e65 6564 6c65 5f6d 6f76 656d  ted_needle_movem
+00024540: 656e 7428 6578 7065 6374 6564 5f78 3d64  ent(expected_x=d
+00024550: 7829 0a20 2020 2020 2020 2023 2020 2020  x).        #    
+00024560: 2079 7a5f 6d6f 7665 203d 2073 656c 662e   yz_move = self.
+00024570: 5f79 5f63 6f72 7265 6374 6564 5f6e 6565  _y_corrected_nee
+00024580: 646c 655f 6d6f 7665 6d65 6e74 2864 792c  dle_movement(dy,
+00024590: 2073 7461 6765 5f74 696c 743d 7374 6167   stage_tilt=stag
+000245a0: 655f 7469 6c74 290a 0a20 2020 2020 2020  e_tilt)..       
+000245b0: 2023 2023 2078 7a2c 0a20 2020 2020 2020   # # xz,.       
+000245c0: 2023 2069 6620 6265 616d 5f74 7970 6520   # if beam_type 
+000245d0: 6973 2042 6561 6d54 7970 652e 494f 4e3a  is BeamType.ION:
+000245e0: 0a0a 2020 2020 2020 2020 2320 2020 2020  ..        #     
+000245f0: 785f 6d6f 7665 203d 2073 656c 662e 5f78  x_move = self._x
+00024600: 5f63 6f72 7265 6374 6564 5f6e 6565 646c  _corrected_needl
+00024610: 655f 6d6f 7665 6d65 6e74 2865 7870 6563  e_movement(expec
+00024620: 7465 645f 783d 6478 290a 2020 2020 2020  ted_x=dx).      
+00024630: 2020 2320 2020 2020 797a 5f6d 6f76 6520    #     yz_move 
+00024640: 3d20 7365 6c66 2e5f 7a5f 636f 7272 6563  = self._z_correc
+00024650: 7465 645f 6e65 6564 6c65 5f6d 6f76 656d  ted_needle_movem
+00024660: 656e 7428 6578 7065 6374 6564 5f7a 3d64  ent(expected_z=d
+00024670: 792c 2073 7461 6765 5f74 696c 743d 7374  y, stage_tilt=st
+00024680: 6167 655f 7469 6c74 290a 0a20 2020 2020  age_tilt)..     
+00024690: 2020 2023 206d 6f76 6520 6e65 6564 6c65     # move needle
+000246a0: 2028 7265 6c61 7469 7665 290a 2020 2020   (relative).    
+000246b0: 2020 2020 2373 656c 662e 636f 6e6e 6563      #self.connec
+000246c0: 7469 6f6e 2e4e 616e 6f6d 616e 6970 756c  tion.Nanomanipul
+000246d0: 6174 6f72 2e4d 6f76 6554 6f28 496e 6465  ator.MoveTo(Inde
+000246e0: 783d 302c 2058 3d78 5f6d 6f76 652e 782c  x=0, X=x_move.x,
+000246f0: 2059 3d79 7a5f 6d6f 7665 2e79 2c20 5a3d   Y=yz_move.y, Z=
+00024700: 797a 5f6d 6f76 652e 7a29 0a20 2020 2020  yz_move.z).     
+00024710: 2020 2073 656c 662e 6d6f 7665 5f6d 616e     self.move_man
+00024720: 6970 756c 6174 6f72 5f72 656c 6174 6976  ipulator_relativ
+00024730: 6528 4669 6273 656d 4d61 6e69 7075 6c61  e(FibsemManipula
+00024740: 746f 7250 6f73 6974 696f 6e28 783d 6478  torPosition(x=dx
+00024750: 2c20 793d 6479 2c20 7a3d 3029 290a 0a20  , y=dy, z=0)).. 
+00024760: 2020 2020 2020 2072 6574 7572 6e0a 0a20         return.. 
+00024770: 2020 2064 6566 206d 6f76 655f 6d61 6e69     def move_mani
+00024780: 7075 6c61 746f 725f 746f 5f70 6f73 6974  pulator_to_posit
+00024790: 696f 6e5f 6f66 6673 6574 2873 656c 662c  ion_offset(self,
+000247a0: 206f 6666 7365 743a 2046 6962 7365 6d4d   offset: FibsemM
+000247b0: 616e 6970 756c 6174 6f72 506f 7369 7469  anipulatorPositi
+000247c0: 6f6e 2c20 6e61 6d65 3a20 7374 7220 3d20  on, name: str = 
+000247d0: 4e6f 6e65 2920 2d3e 204e 6f6e 653a 0a20  None) -> None:. 
+000247e0: 2020 2020 2020 2069 6620 6e6f 7420 6e70         if not np
+000247f0: 2e69 7363 6c6f 7365 286f 6666 7365 742e  .isclose(offset.
+00024800: 722c 2030 2e30 293a 0a20 2020 2020 2020  r, 0.0):.       
+00024810: 2020 2020 2072 6f74 6174 696f 6e20 3d20       rotation = 
+00024820: 5472 7565 0a20 2020 2020 2020 2065 6c73  True.        els
+00024830: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
+00024840: 6f74 6174 696f 6e20 3d20 4661 6c73 650a  otation = False.
+00024850: 2020 2020 2020 2020 6966 206e 6f74 206e          if not n
+00024860: 702e 6973 636c 6f73 6528 6f66 6673 6574  p.isclose(offset
+00024870: 2e74 2c20 302e 3029 3a0a 2020 2020 2020  .t, 0.0):.      
+00024880: 2020 2020 2020 7469 6c74 203d 2054 7275        tilt = Tru
+00024890: 650a 2020 2020 2020 2020 656c 7365 3a0a  e.        else:.
+000248a0: 2020 2020 2020 2020 2020 2020 7469 6c74              tilt
+000248b0: 203d 2046 616c 7365 0a20 2020 2020 2020   = False.       
+000248c0: 205f 6368 6563 6b5f 6e65 6564 6c65 2873   _check_needle(s
+000248d0: 656c 662e 6861 7264 7761 7265 5f73 6574  elf.hardware_set
+000248e0: 7469 6e67 732c 2072 6f74 6174 696f 6e2c  tings, rotation,
+000248f0: 2074 696c 7429 0a20 2020 2020 2020 206c   tilt).        l
+00024900: 6f67 6769 6e67 2e77 6172 6e69 6e67 2822  ogging.warning("
+00024910: 4e6f 7420 7375 7070 6f72 7465 6420 6279  Not supported by
+00024920: 2054 4553 4341 4e20 4150 4922 290a 2020   TESCAN API").  
+00024930: 2020 2020 2020 2320 7261 6973 6520 4e6f        # raise No
+00024940: 7449 6d70 6c65 6d65 6e74 6564 4572 726f  tImplementedErro
+00024950: 7228 224e 6f74 2073 7570 706f 7274 6564  r("Not supported
+00024960: 2062 7920 5445 5343 414e 2041 5049 2229   by TESCAN API")
+00024970: 0a20 2020 2020 2020 2070 6173 730a 0a20  .        pass.. 
+00024980: 2020 2064 6566 205f 6765 745f 7361 7665     def _get_save
+00024990: 645f 6d61 6e69 7075 6c61 746f 725f 706f  d_manipulator_po
+000249a0: 7369 7469 6f6e 2873 656c 6629 3a0a 2020  sition(self):.  
+000249b0: 2020 2020 2020 5f63 6865 636b 5f6e 6565        _check_nee
+000249c0: 646c 6528 7365 6c66 2e68 6172 6477 6172  dle(self.hardwar
+000249d0: 655f 7365 7474 696e 6773 290a 2020 2020  e_settings).    
+000249e0: 2020 2020 7061 7373 0a0a 2020 2020 6465      pass..    de
+000249f0: 6620 7365 7475 705f 6d69 6c6c 696e 6728  f setup_milling(
+00024a00: 0a20 2020 2020 2020 2073 656c 662c 0a20  .        self,. 
+00024a10: 2020 2020 2020 206d 696c 6c5f 7365 7474         mill_sett
+00024a20: 696e 6773 3a20 4669 6273 656d 4d69 6c6c  ings: FibsemMill
+00024a30: 696e 6753 6574 7469 6e67 732c 0a20 2020  ingSettings,.   
+00024a40: 2029 3a0a 2020 2020 2020 2020 2222 220a   ):.        """.
+00024a50: 2020 2020 2020 2020 436f 6e66 6967 7572          Configur
+00024a60: 6520 7468 6520 6d69 6372 6f73 636f 7065  e the microscope
+00024a70: 2066 6f72 206d 696c 6c69 6e67 2075 7369   for milling usi
+00024a80: 6e67 2074 6865 2069 6f6e 2062 6561 6d2e  ng the ion beam.
+00024a90: 0a0a 2020 2020 2020 2020 4172 6773 3a0a  ..        Args:.
+00024aa0: 2020 2020 2020 2020 2020 2020 6170 706c              appl
+00024ab0: 6963 6174 696f 6e5f 6669 6c65 2028 7374  ication_file (st
+00024ac0: 7229 3a20 5061 7468 2074 6f20 7468 6520  r): Path to the 
+00024ad0: 6d69 6c6c 696e 6720 6170 706c 6963 6174  milling applicat
+00024ae0: 696f 6e20 6669 6c65 2e0a 2020 2020 2020  ion file..      
+00024af0: 2020 2020 2020 7061 7474 6572 6e69 6e67        patterning
+00024b00: 5f6d 6f64 6520 2873 7472 293a 2050 6174  _mode (str): Pat
+00024b10: 7465 726e 696e 6720 6d6f 6465 2074 6f20  terning mode to 
+00024b20: 7573 652e 0a20 2020 2020 2020 2020 2020  use..           
+00024b30: 2068 6677 2028 666c 6f61 7429 3a20 4465   hfw (float): De
+00024b40: 7369 7265 6420 686f 7269 7a6f 6e74 616c  sired horizontal
+00024b50: 2066 6965 6c64 2077 6964 7468 2069 6e20   field width in 
+00024b60: 6d65 7465 7273 2e0a 2020 2020 2020 2020  meters..        
+00024b70: 2020 2020 6d69 6c6c 5f73 6574 7469 6e67      mill_setting
+00024b80: 7320 2846 6962 7365 6d4d 696c 6c69 6e67  s (FibsemMilling
+00024b90: 5365 7474 696e 6773 293a 204d 696c 6c69  Settings): Milli
+00024ba0: 6e67 2073 6574 7469 6e67 732e 0a0a 2020  ng settings...  
+00024bb0: 2020 2020 2020 5265 7475 726e 733a 0a20        Returns:. 
+00024bc0: 2020 2020 2020 2020 2020 204e 6f6e 652e             None.
+00024bd0: 0a0a 2020 2020 2020 2020 5261 6973 6573  ..        Raises
+00024be0: 3a0a 2020 2020 2020 2020 2020 2020 4e6f  :.            No
+00024bf0: 7449 6d70 6c65 6d65 6e74 6564 4572 726f  tImplementedErro
+00024c00: 723a 2049 6620 7468 6520 7370 6563 6966  r: If the specif
+00024c10: 6965 6420 7061 7474 6572 6e69 6e67 206d  ied patterning m
+00024c20: 6f64 6520 6973 206e 6f74 2073 7570 706f  ode is not suppo
+00024c30: 7274 6564 2e0a 0a20 2020 2020 2020 204e  rted...        N
+00024c40: 6f74 653a 0a20 2020 2020 2020 2020 2020  ote:.           
+00024c50: 2054 6869 7320 6d65 7468 6f64 2073 6574   This method set
+00024c60: 7320 7570 2074 6865 206d 6963 726f 7363  s up the microsc
+00024c70: 6f70 6520 696d 6167 696e 6720 616e 6420  ope imaging and 
+00024c80: 7061 7474 6572 6e69 6e67 2066 6f72 206d  patterning for m
+00024c90: 696c 6c69 6e67 2075 7369 6e67 2074 6865  illing using the
+00024ca0: 2069 6f6e 2062 6561 6d2e 0a20 2020 2020   ion beam..     
+00024cb0: 2020 2020 2020 2049 7420 7365 7473 2074         It sets t
+00024cc0: 6865 2061 6374 6976 6520 7669 6577 2061  he active view a
+00024cd0: 6e64 2064 6576 6963 6520 746f 2074 6865  nd device to the
+00024ce0: 2069 6f6e 2062 6561 6d2c 2074 6865 2064   ion beam, the d
+00024cf0: 6566 6175 6c74 2062 6561 6d20 7479 7065  efault beam type
+00024d00: 2074 6f20 7468 6520 696f 6e20 6265 616d   to the ion beam
+00024d10: 2c0a 2020 2020 2020 2020 2020 2020 7468  ,.            th
+00024d20: 6520 7370 6563 6966 6965 6420 6170 706c  e specified appl
+00024d30: 6963 6174 696f 6e20 6669 6c65 2c20 616e  ication file, an
+00024d40: 6420 7468 6520 7370 6563 6966 6965 6420  d the specified 
+00024d50: 7061 7474 6572 6e69 6e67 206d 6f64 652e  patterning mode.
+00024d60: 0a20 2020 2020 2020 2020 2020 2049 7420  .            It 
+00024d70: 616c 736f 2063 6c65 6172 7320 616e 7920  also clears any 
+00024d80: 6578 6973 7469 6e67 2070 6174 7465 726e  existing pattern
+00024d90: 7320 616e 6420 7365 7473 2074 6865 2068  s and sets the h
+00024da0: 6f72 697a 6f6e 7461 6c20 6669 656c 6420  orizontal field 
+00024db0: 7769 6474 6820 746f 2074 6865 2064 6573  width to the des
+00024dc0: 6972 6564 2076 616c 7565 2e0a 2020 2020  ired value..    
+00024dd0: 2020 2020 2020 2020 5468 6520 6d65 7468          The meth
+00024de0: 6f64 2064 6f65 7320 6e6f 7420 7374 6172  od does not star
+00024df0: 7420 7468 6520 6d69 6c6c 696e 6720 7072  t the milling pr
+00024e00: 6f63 6573 732e 0a20 2020 2020 2020 2022  ocess..        "
+00024e10: 2222 0a20 2020 2020 2020 205f 6368 6563  "".        _chec
+00024e20: 6b5f 6265 616d 2842 6561 6d54 7970 652e  k_beam(BeamType.
+00024e30: 494f 4e2c 2073 656c 662e 6861 7264 7761  ION, self.hardwa
+00024e40: 7265 5f73 6574 7469 6e67 7329 0a0a 2020  re_settings)..  
+00024e50: 2020 2020 2020 7370 6f74 5f73 697a 6520        spot_size 
+00024e60: 3d20 6d69 6c6c 5f73 6574 7469 6e67 732e  = mill_settings.
+00024e70: 7370 6f74 5f73 697a 6520 2023 2061 7070  spot_size  # app
+00024e80: 6c69 6361 7469 6f6e 5f66 696c 650a 2020  lication_file.  
+00024e90: 2020 2020 2020 7261 7465 203d 206d 696c        rate = mil
+00024ea0: 6c5f 7365 7474 696e 6773 2e72 6174 6520  l_settings.rate 
+00024eb0: 2023 2320 696e 2061 7070 6c69 6361 7469   ## in applicati
+00024ec0: 6f6e 2066 696c 6520 6361 6c6c 6564 2056  on file called V
+00024ed0: 6f6c 756d 6520 7065 7220 446f 7365 2028  olume per Dose (
+00024ee0: 6d33 2f43 290a 2020 2020 2020 2020 6477  m3/C).        dw
+00024ef0: 656c 6c5f 7469 6d65 203d 206d 696c 6c5f  ell_time = mill_
+00024f00: 7365 7474 696e 6773 2e64 7765 6c6c 5f74  settings.dwell_t
+00024f10: 696d 6520 2023 2069 6e20 7365 636f 6e64  ime  # in second
+00024f20: 7320 2323 2069 6e20 6170 706c 6963 6174  s ## in applicat
+00024f30: 696f 6e20 6669 6c65 0a0a 2020 2020 2020  ion file..      
+00024f40: 2020 6966 206d 696c 6c5f 7365 7474 696e    if mill_settin
+00024f50: 6773 2e70 6174 7465 726e 696e 675f 6d6f  gs.patterning_mo
+00024f60: 6465 203d 3d20 2253 6572 6961 6c22 3a0a  de == "Serial":.
+00024f70: 2020 2020 2020 2020 2020 2020 7061 7261              para
+00024f80: 6c6c 656c 5f6d 6f64 6520 3d20 4661 6c73  llel_mode = Fals
+00024f90: 650a 2020 2020 2020 2020 656c 7365 3a0a  e.        else:.
+00024fa0: 2020 2020 2020 2020 2020 2020 7061 7261              para
+00024fb0: 6c6c 656c 5f6d 6f64 6520 3d20 5472 7565  llel_mode = True
+00024fc0: 0a0a 2020 2020 2020 2020 7072 696e 7428  ..        print(
+00024fd0: 6622 7370 6163 696e 673a 207b 6d69 6c6c  f"spacing: {mill
+00024fe0: 5f73 6574 7469 6e67 732e 7370 6163 696e  _settings.spacin
+00024ff0: 677d 2229 0a0a 2020 2020 2020 2020 7365  g}")..        se
+00025000: 6c66 2e73 6574 2822 7072 6573 6574 222c  lf.set("preset",
+00025010: 206d 696c 6c5f 7365 7474 696e 6773 2e70   mill_settings.p
+00025020: 7265 7365 742c 2042 6561 6d54 7970 652e  reset, BeamType.
+00025030: 494f 4e29 0a20 2020 2020 2020 2062 6561  ION).        bea
+00025040: 6d5f 6375 7272 656e 7420 3d20 7365 6c66  m_current = self
+00025050: 2e63 6f6e 6e65 6374 696f 6e2e 4649 422e  .connection.FIB.
+00025060: 4265 616d 2e52 6561 6450 726f 6265 4375  Beam.ReadProbeCu
+00025070: 7272 656e 7428 292a 636f 6e73 7461 6e74  rrent()*constant
+00025080: 732e 5049 434f 5f54 4f5f 5349 0a20 2020  s.PICO_TO_SI.   
+00025090: 2020 2020 2070 7269 6e74 2866 2262 6561       print(f"bea
+000250a0: 6d5f 6375 7272 656e 743a 207b 6265 616d  m_current: {beam
+000250b0: 5f63 7572 7265 6e74 7d22 290a 2020 2020  _current}").    
+000250c0: 2020 2020 6c61 7965 725f 7365 7474 696e      layer_settin
+000250d0: 6773 203d 2049 4574 6368 696e 6728 0a20  gs = IEtching(. 
+000250e0: 2020 2020 2020 2020 2020 2073 796e 6357             syncW
+000250f0: 7269 7465 4669 656c 643d 4661 6c73 652c  riteField=False,
+00025100: 0a20 2020 2020 2020 2020 2020 2077 7269  .            wri
+00025110: 7465 4669 656c 6453 697a 653d 6d69 6c6c  teFieldSize=mill
+00025120: 5f73 6574 7469 6e67 732e 6866 772c 0a20  _settings.hfw,. 
+00025130: 2020 2020 2020 2020 2020 2062 6561 6d43             beamC
+00025140: 7572 7265 6e74 3d62 6561 6d5f 6375 7272  urrent=beam_curr
+00025150: 656e 742c 0a20 2020 2020 2020 2020 2020  ent,.           
+00025160: 2073 706f 7453 697a 653d 7370 6f74 5f73   spotSize=spot_s
+00025170: 697a 652c 0a20 2020 2020 2020 2020 2020  ize,.           
+00025180: 2072 6174 653d 7261 7465 2c0a 2020 2020   rate=rate,.    
+00025190: 2020 2020 2020 2020 6477 656c 6c54 696d          dwellTim
+000251a0: 653d 6477 656c 6c5f 7469 6d65 2c0a 2020  e=dwell_time,.  
+000251b0: 2020 2020 2020 2020 2020 7061 7261 6c6c            parall
+000251c0: 656c 3d70 6172 616c 6c65 6c5f 6d6f 6465  el=parallel_mode
+000251d0: 2c0a 2020 2020 2020 2020 2020 2020 7072  ,.            pr
+000251e0: 6573 6574 203d 206d 696c 6c5f 7365 7474  eset = mill_sett
+000251f0: 696e 6773 2e70 7265 7365 742c 0a20 2020  ings.preset,.   
+00025200: 2020 2020 2020 2020 2073 7061 6369 6e67           spacing
+00025210: 203d 206d 696c 6c5f 7365 7474 696e 6773   = mill_settings
+00025220: 2e73 7061 6369 6e67 2c0a 2020 2020 2020  .spacing,.      
+00025230: 2020 290a 0a20 2020 2020 2020 2073 656c    )..        sel
+00025240: 662e 6c61 7965 7220 3d20 7365 6c66 2e63  f.layer = self.c
+00025250: 6f6e 6e65 6374 696f 6e2e 4472 6177 4265  onnection.DrawBe
+00025260: 616d 2e4c 6179 6572 2822 4c61 7965 7231  am.Layer("Layer1
+00025270: 222c 206c 6179 6572 5f73 6574 7469 6e67  ", layer_setting
+00025280: 7329 0a20 2020 2020 2020 200a 0a20 2020  s).        ..   
+00025290: 2064 6566 2072 756e 5f6d 696c 6c69 6e67   def run_milling
+000252a0: 2873 656c 662c 206d 696c 6c69 6e67 5f63  (self, milling_c
+000252b0: 7572 7265 6e74 3a20 666c 6f61 742c 2061  urrent: float, a
+000252c0: 7379 6e63 683a 2062 6f6f 6c20 3d20 4661  synch: bool = Fa
+000252d0: 6c73 6529 3a0a 2020 2020 2020 2020 2222  lse):.        ""
+000252e0: 220a 2020 2020 2020 2020 5275 6e73 2074  ".        Runs t
+000252f0: 6865 2069 6f6e 2062 6561 6d20 6d69 6c6c  he ion beam mill
+00025300: 696e 6720 7072 6f63 6573 7320 7573 696e  ing process usin
+00025310: 6720 7468 6520 7370 6563 6966 6965 6420  g the specified 
+00025320: 6d69 6c6c 696e 6720 6375 7272 656e 742e  milling current.
+00025330: 0a0a 2020 2020 2020 2020 4172 6773 3a0a  ..        Args:.
+00025340: 2020 2020 2020 2020 2020 2020 6d69 6c6c              mill
+00025350: 696e 675f 6375 7272 656e 7420 2866 6c6f  ing_current (flo
+00025360: 6174 293a 2054 6865 206d 696c 6c69 6e67  at): The milling
+00025370: 2063 7572 7265 6e74 2074 6f20 7573 652c   current to use,
+00025380: 2069 6e20 616d 7073 2e0a 2020 2020 2020   in amps..      
+00025390: 2020 2020 2020 6173 796e 6368 2028 626f        asynch (bo
+000253a0: 6f6c 2c20 6f70 7469 6f6e 616c 293a 2057  ol, optional): W
+000253b0: 6865 7468 6572 2074 6f20 7275 6e20 7468  hether to run th
+000253c0: 6520 6d69 6c6c 696e 6720 6173 796e 6368  e milling asynch
+000253d0: 726f 6e6f 7573 6c79 2e20 4465 6661 756c  ronously. Defaul
+000253e0: 7473 2074 6f20 4661 6c73 652e 0a0a 2020  ts to False...  
+000253f0: 2020 2020 2020 5265 7475 726e 733a 0a20        Returns:. 
+00025400: 2020 2020 2020 2020 2020 204e 6f6e 650a             None.
+00025410: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+00025420: 2020 2020 5f63 6865 636b 5f62 6561 6d28      _check_beam(
+00025430: 4265 616d 5479 7065 2e49 4f4e 2c20 7365  BeamType.ION, se
+00025440: 6c66 2e68 6172 6477 6172 655f 7365 7474  lf.hardware_sett
+00025450: 696e 6773 290a 2020 2020 2020 2020 7374  ings).        st
+00025460: 6174 7573 203d 2073 656c 662e 636f 6e6e  atus = self.conn
+00025470: 6563 7469 6f6e 2e46 4942 2e42 6561 6d2e  ection.FIB.Beam.
+00025480: 4765 7453 7461 7475 7328 290a 2020 2020  GetStatus().    
+00025490: 2020 2020 6966 2073 7461 7475 7320 213d      if status !=
+000254a0: 2041 7574 6f6d 6174 696f 6e2e 4649 422e   Automation.FIB.
+000254b0: 4265 616d 2e53 7461 7475 732e 4265 616d  Beam.Status.Beam
+000254c0: 4f6e 3a0a 2020 2020 2020 2020 2020 2020  On:.            
+000254d0: 7365 6c66 2e63 6f6e 6e65 6374 696f 6e2e  self.connection.
+000254e0: 4649 422e 4265 616d 2e4f 6e28 290a 2020  FIB.Beam.On().  
+000254f0: 2020 2020 2020 7365 6c66 2e63 6f6e 6e65        self.conne
+00025500: 6374 696f 6e2e 4472 6177 4265 616d 2e4c  ction.DrawBeam.L
+00025510: 6f61 644c 6179 6572 2873 656c 662e 6c61  oadLayer(self.la
+00025520: 7965 7229 0a20 2020 2020 2020 206c 6f67  yer).        log
+00025530: 6769 6e67 2e69 6e66 6f28 6622 7275 6e6e  ging.info(f"runn
+00025540: 696e 6720 696f 6e20 6265 616d 206d 696c  ing ion beam mil
+00025550: 6c69 6e67 206e 6f77 2e2e 2e22 290a 2020  ling now...").  
+00025560: 2020 2020 2020 7365 6c66 2e63 6f6e 6e65        self.conne
+00025570: 6374 696f 6e2e 4472 6177 4265 616d 2e53  ction.DrawBeam.S
+00025580: 7461 7274 2829 0a20 2020 2020 2020 2073  tart().        s
+00025590: 656c 662e 636f 6e6e 6563 7469 6f6e 2e50  elf.connection.P
+000255a0: 726f 6772 6573 732e 5368 6f77 280a 2020  rogress.Show(.  
+000255b0: 2020 2020 2020 2020 2020 2244 7261 7742            "DrawB
+000255c0: 6561 6d22 2c20 224c 6179 6572 2031 2069  eam", "Layer 1 i
+000255d0: 6e20 7072 6f67 7265 7373 222c 2046 616c  n progress", Fal
+000255e0: 7365 2c20 4661 6c73 652c 2030 2c20 3130  se, False, 0, 10
+000255f0: 300a 2020 2020 2020 2020 290a 2020 2020  0.        ).    
+00025600: 2020 2020 7768 696c 6520 5472 7565 3a0a      while True:.
+00025610: 2020 2020 2020 2020 2020 2020 7374 6174              stat
+00025620: 7573 203d 2073 656c 662e 636f 6e6e 6563  us = self.connec
+00025630: 7469 6f6e 2e44 7261 7742 6561 6d2e 4765  tion.DrawBeam.Ge
+00025640: 7453 7461 7475 7328 290a 2020 2020 2020  tStatus().      
+00025650: 2020 2020 2020 7275 6e6e 696e 6720 3d20        running = 
+00025660: 7374 6174 7573 5b30 5d20 3d3d 2044 4253  status[0] == DBS
+00025670: 7461 7475 732e 5072 6f6a 6563 744c 6f61  tatus.ProjectLoa
+00025680: 6465 6445 7870 6f73 6974 696f 6e49 6e50  dedExpositionInP
+00025690: 726f 6772 6573 730a 2020 2020 2020 2020  rogress.        
+000256a0: 2020 2020 6966 2072 756e 6e69 6e67 3a0a      if running:.
+000256b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000256c0: 7072 6f67 7265 7373 203d 2030 0a20 2020  progress = 0.   
+000256d0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+000256e0: 7374 6174 7573 5b31 5d20 3e20 303a 0a20  status[1] > 0:. 
+000256f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025700: 2020 2070 726f 6772 6573 7320 3d20 6d69     progress = mi
+00025710: 6e28 3130 302c 2073 7461 7475 735b 325d  n(100, status[2]
+00025720: 202f 2073 7461 7475 735b 315d 202a 2031   / status[1] * 1
+00025730: 3030 290a 2020 2020 2020 2020 2020 2020  00).            
+00025740: 2020 2020 7072 696e 7450 726f 6772 6573      printProgres
+00025750: 7342 6172 2870 726f 6772 6573 732c 2031  sBar(progress, 1
+00025760: 3030 290a 2020 2020 2020 2020 2020 2020  00).            
+00025770: 2020 2020 7365 6c66 2e63 6f6e 6e65 6374      self.connect
+00025780: 696f 6e2e 5072 6f67 7265 7373 2e53 6574  ion.Progress.Set
+00025790: 5065 7263 656e 7473 2870 726f 6772 6573  Percents(progres
+000257a0: 7329 0a20 2020 2020 2020 2020 2020 2020  s).             
+000257b0: 2020 2074 696d 652e 736c 6565 7028 3129     time.sleep(1)
+000257c0: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
+000257d0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+000257e0: 2020 2069 6620 7374 6174 7573 5b30 5d20     if status[0] 
+000257f0: 3d3d 2044 4253 7461 7475 732e 5072 6f6a  == DBStatus.Proj
+00025800: 6563 744c 6f61 6465 6445 7870 6f73 6974  ectLoadedExposit
+00025810: 696f 6e49 646c 653a 0a20 2020 2020 2020  ionIdle:.       
+00025820: 2020 2020 2020 2020 2020 2020 2070 7269               pri
+00025830: 6e74 5072 6f67 7265 7373 4261 7228 3130  ntProgressBar(10
+00025840: 302c 2031 3030 2c20 7375 6666 6978 3d22  0, 100, suffix="
+00025850: 4669 6e69 7368 6564 2229 0a20 2020 2020  Finished").     
+00025860: 2020 2020 2020 2020 2020 2062 7265 616b             break
+00025870: 0a0a 2020 2020 2020 2020 7072 696e 7428  ..        print(
+00025880: 2920 2023 206e 6577 206c 696e 6520 6f6e  )  # new line on
+00025890: 2063 6f6d 706c 6574 650a 2020 2020 2020   complete.      
+000258a0: 2020 7365 6c66 2e63 6f6e 6e65 6374 696f    self.connectio
+000258b0: 6e2e 5072 6f67 7265 7373 2e48 6964 6528  n.Progress.Hide(
+000258c0: 290a 0a20 2020 2064 6566 2072 756e 5f6d  )..    def run_m
+000258d0: 696c 6c69 6e67 5f64 7269 6674 5f63 6f72  illing_drift_cor
+000258e0: 7265 6374 6564 2873 656c 662c 206d 696c  rected(self, mil
+000258f0: 6c69 6e67 5f63 7572 7265 6e74 3a20 666c  ling_current: fl
+00025900: 6f61 742c 2020 0a20 2020 2020 2020 2069  oat,  .        i
+00025910: 6d61 6765 5f73 6574 7469 6e67 733a 2049  mage_settings: I
+00025920: 6d61 6765 5365 7474 696e 6773 2c20 0a20  mageSettings, . 
+00025930: 2020 2020 2020 2072 6566 5f69 6d61 6765         ref_image
+00025940: 3a20 4669 6273 656d 496d 6167 652c 200a  : FibsemImage, .
+00025950: 2020 2020 2020 2020 7265 6475 6365 645f          reduced_
+00025960: 6172 6561 3a20 4669 6273 656d 5265 6374  area: FibsemRect
+00025970: 616e 676c 6520 3d20 4e6f 6e65 2c0a 2020  angle = None,.  
+00025980: 2020 2020 2020 6173 796e 6368 3a20 626f        asynch: bo
+00025990: 6f6c 203d 2046 616c 7365 0a20 2020 2020  ol = False.     
+000259a0: 2020 2029 3a0a 2020 2020 2020 2020 2222     ):.        ""
+000259b0: 220a 2020 2020 2020 2020 5275 6e20 696f  ".        Run io
+000259c0: 6e20 6265 616d 206d 696c 6c69 6e67 2075  n beam milling u
+000259d0: 7369 6e67 2074 6865 2073 7065 6369 6669  sing the specifi
+000259e0: 6564 206d 696c 6c69 6e67 2063 7572 7265  ed milling curre
+000259f0: 6e74 2e0a 0a20 2020 2020 2020 2041 7267  nt...        Arg
+00025a00: 733a 0a20 2020 2020 2020 2020 2020 206d  s:.            m
+00025a10: 696c 6c69 6e67 5f63 7572 7265 6e74 2028  illing_current (
+00025a20: 666c 6f61 7429 3a20 5468 6520 6375 7272  float): The curr
+00025a30: 656e 7420 746f 2075 7365 2066 6f72 206d  ent to use for m
+00025a40: 696c 6c69 6e67 2069 6e20 616d 7073 2e0a  illing in amps..
+00025a50: 2020 2020 2020 2020 2020 2020 6173 796e              asyn
+00025a60: 6368 2028 626f 6f6c 2c20 6f70 7469 6f6e  ch (bool, option
+00025a70: 616c 293a 2049 6620 5472 7565 2c20 7468  al): If True, th
+00025a80: 6520 6d69 6c6c 696e 6720 7769 6c6c 2062  e milling will b
+00025a90: 6520 7275 6e20 6173 796e 6368 726f 6e6f  e run asynchrono
+00025aa0: 7573 6c79 2e20 0a20 2020 2020 2020 2020  usly. .         
+00025ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025ac0: 2020 2020 2020 2020 2020 2020 4465 6661              Defa
+00025ad0: 756c 7473 2074 6f20 4661 6c73 652c 2069  ults to False, i
+00025ae0: 6e20 7768 6963 6820 6361 7365 2069 7420  n which case it 
+00025af0: 7769 6c6c 2072 756e 2073 796e 6368 726f  will run synchro
+00025b00: 6e6f 7573 6c79 2e0a 0a20 2020 2020 2020  nously...       
+00025b10: 2052 6574 7572 6e73 3a0a 2020 2020 2020   Returns:.      
+00025b20: 2020 2020 2020 4e6f 6e65 0a0a 2020 2020        None..    
+00025b30: 2020 2020 5261 6973 6573 3a0a 2020 2020      Raises:.    
+00025b40: 2020 2020 2020 2020 4e6f 6e65 0a20 2020          None.   
+00025b50: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+00025b60: 205f 6368 6563 6b5f 6265 616d 2842 6561   _check_beam(Bea
+00025b70: 6d54 7970 652e 494f 4e2c 2073 656c 662e  mType.ION, self.
+00025b80: 6861 7264 7761 7265 5f73 6574 7469 6e67  hardware_setting
+00025b90: 7329 0a20 2020 2020 2020 2073 7461 7475  s).        statu
+00025ba0: 7320 3d20 7365 6c66 2e63 6f6e 6e65 6374  s = self.connect
+00025bb0: 696f 6e2e 4649 422e 4265 616d 2e47 6574  ion.FIB.Beam.Get
+00025bc0: 5374 6174 7573 2829 0a20 2020 2020 2020  Status().       
+00025bd0: 2069 6620 7374 6174 7573 2021 3d20 4175   if status != Au
+00025be0: 746f 6d61 7469 6f6e 2e46 4942 2e42 6561  tomation.FIB.Bea
+00025bf0: 6d2e 5374 6174 7573 2e42 6561 6d4f 6e3a  m.Status.BeamOn:
+00025c00: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00025c10: 662e 636f 6e6e 6563 7469 6f6e 2e46 4942  f.connection.FIB
+00025c20: 2e42 6561 6d2e 4f6e 2829 0a20 2020 2020  .Beam.On().     
+00025c30: 2020 2073 656c 662e 636f 6e6e 6563 7469     self.connecti
+00025c40: 6f6e 2e44 7261 7742 6561 6d2e 4c6f 6164  on.DrawBeam.Load
+00025c50: 4c61 7965 7228 7365 6c66 2e6c 6179 6572  Layer(self.layer
+00025c60: 290a 2020 2020 2020 2020 6c6f 6767 696e  ).        loggin
+00025c70: 672e 696e 666f 2866 2272 756e 6e69 6e67  g.info(f"running
+00025c80: 2069 6f6e 2062 6561 6d20 6d69 6c6c 696e   ion beam millin
+00025c90: 6720 6e6f 772e 2e2e 2229 0a20 2020 2020  g now...").     
+00025ca0: 2020 2073 656c 662e 636f 6e6e 6563 7469     self.connecti
+00025cb0: 6f6e 2e44 7261 7742 6561 6d2e 5374 6172  on.DrawBeam.Star
+00025cc0: 7428 290a 2020 2020 2020 2020 7365 6c66  t().        self
+00025cd0: 2e63 6f6e 6e65 6374 696f 6e2e 5072 6f67  .connection.Prog
+00025ce0: 7265 7373 2e53 686f 7728 0a20 2020 2020  ress.Show(.     
+00025cf0: 2020 2020 2020 2022 4472 6177 4265 616d         "DrawBeam
+00025d00: 222c 2022 4c61 7965 7220 3120 696e 2070  ", "Layer 1 in p
+00025d10: 726f 6772 6573 7322 2c20 4661 6c73 652c  rogress", False,
+00025d20: 2046 616c 7365 2c20 302c 2031 3030 0a20   False, 0, 100. 
+00025d30: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00025d40: 2066 726f 6d20 6669 6273 656d 2069 6d70   from fibsem imp
+00025d50: 6f72 7420 616c 6967 6e6d 656e 740a 2020  ort alignment.  
+00025d60: 2020 2020 2020 7768 696c 6520 5472 7565        while True
+00025d70: 3a0a 2020 2020 2020 2020 2020 2020 7374  :.            st
+00025d80: 6174 7573 203d 2073 656c 662e 636f 6e6e  atus = self.conn
+00025d90: 6563 7469 6f6e 2e44 7261 7742 6561 6d2e  ection.DrawBeam.
+00025da0: 4765 7453 7461 7475 7328 290a 2020 2020  GetStatus().    
+00025db0: 2020 2020 2020 2020 7275 6e6e 696e 6720          running 
+00025dc0: 3d20 7374 6174 7573 5b30 5d20 3d3d 2044  = status[0] == D
+00025dd0: 4253 7461 7475 732e 5072 6f6a 6563 744c  BStatus.ProjectL
+00025de0: 6f61 6465 6445 7870 6f73 6974 696f 6e49  oadedExpositionI
+00025df0: 6e50 726f 6772 6573 730a 2020 2020 2020  nProgress.      
+00025e00: 2020 2020 2020 6966 2072 756e 6e69 6e67        if running
+00025e10: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00025e20: 2020 7072 6f67 7265 7373 203d 2030 0a20    progress = 0. 
+00025e30: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00025e40: 6620 7374 6174 7573 5b31 5d20 3e20 303a  f status[1] > 0:
+00025e50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00025e60: 2020 2020 2070 726f 6772 6573 7320 3d20       progress = 
+00025e70: 6d69 6e28 3130 302c 2073 7461 7475 735b  min(100, status[
+00025e80: 325d 202f 2073 7461 7475 735b 315d 202a  2] / status[1] *
+00025e90: 2031 3030 290a 2020 2020 2020 2020 2020   100).          
+00025ea0: 2020 2020 2020 7072 696e 7450 726f 6772        printProgr
+00025eb0: 6573 7342 6172 2870 726f 6772 6573 732c  essBar(progress,
+00025ec0: 2031 3030 290a 2020 2020 2020 2020 2020   100).          
+00025ed0: 2020 2020 2020 7365 6c66 2e63 6f6e 6e65        self.conne
+00025ee0: 6374 696f 6e2e 5072 6f67 7265 7373 2e53  ction.Progress.S
+00025ef0: 6574 5065 7263 656e 7473 2870 726f 6772  etPercents(progr
+00025f00: 6573 7329 0a20 2020 2020 2020 2020 2020  ess).           
+00025f10: 2020 2020 2073 7461 7475 7320 3d20 7365       status = se
+00025f20: 6c66 2e63 6f6e 6e65 6374 696f 6e2e 4472  lf.connection.Dr
+00025f30: 6177 4265 616d 2e47 6574 5374 6174 7573  awBeam.GetStatus
+00025f40: 2829 0a20 2020 2020 2020 2020 2020 2020  ().             
+00025f50: 2020 2069 6620 7374 6174 7573 5b30 5d20     if status[0] 
+00025f60: 3d3d 2044 4253 7461 7475 732e 5072 6f6a  == DBStatus.Proj
+00025f70: 6563 744c 6f61 6465 6445 7870 6f73 6974  ectLoadedExposit
+00025f80: 696f 6e49 6e50 726f 6772 6573 733a 0a20  ionInProgress:. 
+00025f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025fa0: 2020 2073 656c 662e 636f 6e6e 6563 7469     self.connecti
+00025fb0: 6f6e 2e44 7261 7742 6561 6d2e 5061 7573  on.DrawBeam.Paus
+00025fc0: 6528 290a 2020 2020 2020 2020 2020 2020  e().            
+00025fd0: 2020 2020 656c 6966 2073 7461 7475 735b      elif status[
+00025fe0: 305d 203d 3d20 4442 5374 6174 7573 2e50  0] == DBStatus.P
+00025ff0: 726f 6a65 6374 4c6f 6164 6564 4578 706f  rojectLoadedExpo
+00026000: 7369 7469 6f6e 4964 6c65 3a0a 2020 2020  sitionIdle:.    
+00026010: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026020: 7072 696e 7450 726f 6772 6573 7342 6172  printProgressBar
+00026030: 2831 3030 2c20 3130 302c 2073 7566 6669  (100, 100, suffi
+00026040: 783d 2246 696e 6973 6865 6422 290a 2020  x="Finished").  
+00026050: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026060: 2020 7365 6c66 2e63 6f6e 6e65 6374 696f    self.connectio
+00026070: 6e2e 4472 6177 4265 616d 2e53 746f 7028  n.DrawBeam.Stop(
+00026080: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00026090: 2020 2020 2020 7365 6c66 2e63 6f6e 6e65        self.conne
+000260a0: 6374 696f 6e2e 4472 6177 4265 616d 2e55  ction.DrawBeam.U
+000260b0: 6e6c 6f61 644c 6179 6572 2829 0a20 2020  nloadLayer().   
+000260c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000260d0: 2062 7265 616b 0a20 2020 2020 2020 2020   break.         
+000260e0: 2020 2020 2020 206c 6f67 6769 6e67 2e69         logging.i
+000260f0: 6e66 6f28 2244 7269 6674 2063 6f72 7265  nfo("Drift corre
+00026100: 6374 696f 6e20 696e 2070 726f 6772 6573  ction in progres
+00026110: 732e 2e2e 2229 0a20 2020 2020 2020 2020  s...").         
+00026120: 2020 2020 2020 2069 6d61 6765 5f73 6574         image_set
+00026130: 7469 6e67 732e 6265 616d 5f74 7970 6520  tings.beam_type 
+00026140: 3d20 4265 616d 5479 7065 2e49 4f4e 0a20  = BeamType.ION. 
+00026150: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+00026160: 6c69 676e 6d65 6e74 2e62 6561 6d5f 7368  lignment.beam_sh
+00026170: 6966 745f 616c 6967 6e6d 656e 7428 0a20  ift_alignment(. 
+00026180: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026190: 2020 2073 656c 662c 0a20 2020 2020 2020     self,.       
+000261a0: 2020 2020 2020 2020 2020 2020 2069 6d61               ima
+000261b0: 6765 5f73 6574 7469 6e67 732c 0a20 2020  ge_settings,.   
+000261c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000261d0: 2072 6566 5f69 6d61 6765 2c0a 2020 2020   ref_image,.    
+000261e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000261f0: 7265 6475 6365 645f 6172 6561 2c0a 2020  reduced_area,.  
+00026200: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+00026210: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026220: 7469 6d65 2e73 6c65 6570 2831 290a 2020  time.sleep(1).  
+00026230: 2020 2020 2020 2020 2020 2020 2020 7374                st
+00026240: 6174 7573 203d 2073 656c 662e 636f 6e6e  atus = self.conn
+00026250: 6563 7469 6f6e 2e44 7261 7742 6561 6d2e  ection.DrawBeam.
+00026260: 4765 7453 7461 7475 7328 290a 2020 2020  GetStatus().    
+00026270: 2020 2020 2020 2020 2020 2020 6966 2073              if s
+00026280: 7461 7475 735b 305d 203d 3d20 4442 5374  tatus[0] == DBSt
+00026290: 6174 7573 2e50 726f 6a65 6374 4c6f 6164  atus.ProjectLoad
+000262a0: 6564 4578 706f 7369 7469 6f6e 5061 7573  edExpositionPaus
+000262b0: 6564 203a 0a20 2020 2020 2020 2020 2020  ed :.           
+000262c0: 2020 2020 2020 2020 2073 656c 662e 636f           self.co
+000262d0: 6e6e 6563 7469 6f6e 2e44 7261 7742 6561  nnection.DrawBea
+000262e0: 6d2e 5265 7375 6d65 2829 0a20 2020 2020  m.Resume().     
+000262f0: 2020 2020 2020 2020 2020 206c 6f67 6769             loggi
+00026300: 6e67 2e69 6e66 6f28 2244 7269 6674 2063  ng.info("Drift c
+00026310: 6f72 7265 6374 696f 6e20 636f 6d70 6c65  orrection comple
+00026320: 7465 2e22 290a 2020 2020 2020 2020 2020  te.").          
+00026330: 2020 2020 2020 7469 6d65 2e73 6c65 6570        time.sleep
+00026340: 2835 290a 2020 2020 2020 2020 2020 2020  (5).            
+00026350: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00026360: 2020 2020 2020 6966 2073 7461 7475 735b        if status[
+00026370: 305d 203d 3d20 4442 5374 6174 7573 2e50  0] == DBStatus.P
+00026380: 726f 6a65 6374 4c6f 6164 6564 4578 706f  rojectLoadedExpo
+00026390: 7369 7469 6f6e 4964 6c65 3a0a 2020 2020  sitionIdle:.    
+000263a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000263b0: 7072 696e 7450 726f 6772 6573 7342 6172  printProgressBar
+000263c0: 2831 3030 2c20 3130 302c 2073 7566 6669  (100, 100, suffi
+000263d0: 783d 2246 696e 6973 6865 6422 290a 2020  x="Finished").  
+000263e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000263f0: 2020 7365 6c66 2e63 6f6e 6e65 6374 696f    self.connectio
+00026400: 6e2e 4472 6177 4265 616d 2e53 746f 7028  n.DrawBeam.Stop(
+00026410: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00026420: 2020 2020 2020 7365 6c66 2e63 6f6e 6e65        self.conne
+00026430: 6374 696f 6e2e 4472 6177 4265 616d 2e55  ction.DrawBeam.U
+00026440: 6e6c 6f61 644c 6179 6572 2829 0a20 2020  nloadLayer().   
+00026450: 2020 2020 2020 2020 2020 2020 2062 7265               bre
+00026460: 616b 0a0a 2020 2020 2020 2020 7072 696e  ak..        prin
+00026470: 7428 2920 2023 206e 6577 206c 696e 6520  t()  # new line 
+00026480: 6f6e 2063 6f6d 706c 6574 650a 2020 2020  on complete.    
+00026490: 2020 2020 7365 6c66 2e63 6f6e 6e65 6374      self.connect
+000264a0: 696f 6e2e 5072 6f67 7265 7373 2e48 6964  ion.Progress.Hid
+000264b0: 6528 290a 0a20 2020 2064 6566 2066 696e  e()..    def fin
+000264c0: 6973 685f 6d69 6c6c 696e 6728 7365 6c66  ish_milling(self
+000264d0: 2c20 696d 6167 696e 675f 6375 7272 656e  , imaging_curren
+000264e0: 743a 2066 6c6f 6174 293a 0a20 2020 2020  t: float):.     
+000264f0: 2020 2022 2222 0a20 2020 2020 2020 2046     """.        F
+00026500: 696e 616c 6973 6573 2074 6865 206d 696c  inalises the mil
+00026510: 6c69 6e67 2070 726f 6365 7373 2062 7920  ling process by 
+00026520: 636c 6561 7269 6e67 2074 6865 206d 6963  clearing the mic
+00026530: 726f 7363 6f70 6520 6f66 2061 6e79 2070  roscope of any p
+00026540: 6174 7465 726e 7320 616e 6420 7265 7475  atterns and retu
+00026550: 726e 696e 6720 7468 6520 6375 7272 656e  rning the curren
+00026560: 7420 746f 2074 6865 2069 6d61 6769 6e67  t to the imaging
+00026570: 2063 7572 7265 6e74 2e0a 0a20 2020 2020   current...     
+00026580: 2020 2041 7267 733a 0a20 2020 2020 2020     Args:.       
+00026590: 2020 2020 2069 6d61 6769 6e67 5f63 7572       imaging_cur
+000265a0: 7265 6e74 2028 666c 6f61 7429 3a20 5468  rent (float): Th
+000265b0: 6520 6375 7272 656e 7420 746f 2075 7365  e current to use
+000265c0: 2066 6f72 2069 6d61 6769 6e67 2069 6e20   for imaging in 
+000265d0: 616d 7073 2e0a 2020 2020 2020 2020 2320  amps..        # 
+000265e0: 2222 220a 2020 2020 2020 2020 7472 793a  """.        try:
+000265f0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00026600: 662e 636f 6e6e 6563 7469 6f6e 2e46 4942  f.connection.FIB
+00026610: 2e50 7265 7365 742e 4163 7469 7661 7465  .Preset.Activate
+00026620: 2822 3330 206b 6556 3b20 3135 3020 7041  ("30 keV; 150 pA
+00026630: 2229 0a20 2020 2020 2020 2020 2020 2073  ").            s
+00026640: 656c 662e 636f 6e6e 6563 7469 6f6e 2e44  elf.connection.D
+00026650: 7261 7742 6561 6d2e 556e 6c6f 6164 4c61  rawBeam.UnloadLa
+00026660: 7965 7228 290a 2020 2020 2020 2020 2020  yer().          
+00026670: 2020 7072 696e 7428 2268 656c 6c6f 2229    print("hello")
+00026680: 0a20 2020 2020 2020 2065 7863 6570 743a  .        except:
+00026690: 0a20 2020 2020 2020 2020 2020 2070 6173  .            pas
+000266a0: 730a 0a20 2020 2064 6566 2064 7261 775f  s..    def draw_
+000266b0: 7265 6374 616e 676c 6528 0a20 2020 2020  rectangle(.     
+000266c0: 2020 2073 656c 662c 0a20 2020 2020 2020     self,.       
+000266d0: 2070 6174 7465 726e 5f73 6574 7469 6e67   pattern_setting
+000266e0: 733a 2046 6962 7365 6d50 6174 7465 726e  s: FibsemPattern
+000266f0: 5365 7474 696e 6773 2c0a 2020 2020 293a  Settings,.    ):
+00026700: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+00026710: 2020 2020 2044 7261 7773 2061 2072 6563       Draws a rec
+00026720: 7461 6e67 6c65 2070 6174 7465 726e 2075  tangle pattern u
+00026730: 7369 6e67 2074 6865 2063 7572 7265 6e74  sing the current
+00026740: 2069 6f6e 2062 6561 6d2e 0a0a 2020 2020   ion beam...    
+00026750: 2020 2020 4172 6773 3a0a 2020 2020 2020      Args:.      
+00026760: 2020 2020 2020 7061 7474 6572 6e5f 7365        pattern_se
+00026770: 7474 696e 6773 2028 4669 6273 656d 5061  ttings (FibsemPa
+00026780: 7474 6572 6e53 6574 7469 6e67 7329 3a20  tternSettings): 
+00026790: 7468 6520 7365 7474 696e 6773 2066 6f72  the settings for
+000267a0: 2074 6865 2070 6174 7465 726e 2074 6f20   the pattern to 
+000267b0: 6472 6177 2e0a 0a20 2020 2020 2020 2052  draw...        R
+000267c0: 6574 7572 6e73 3a0a 2020 2020 2020 2020  eturns:.        
+000267d0: 2020 2020 5061 7474 6572 6e3a 2074 6865      Pattern: the
+000267e0: 2063 7265 6174 6564 2070 6174 7465 726e   created pattern
+000267f0: 2e0a 0a20 2020 2020 2020 2052 6169 7365  ...        Raise
+00026800: 733a 0a20 2020 2020 2020 2020 2020 2041  s:.            A
+00026810: 7574 6f6d 6174 696f 6e45 7272 6f72 3a20  utomationError: 
+00026820: 6966 2061 6e20 6572 726f 7220 6f63 6375  if an error occu
+00026830: 7273 2077 6869 6c65 2063 7265 6174 696e  rs while creatin
+00026840: 6720 7468 6520 7061 7474 6572 6e2e 0a0a  g the pattern...
+00026850: 2020 2020 2020 2020 4e6f 7465 733a 0a20          Notes:. 
+00026860: 2020 2020 2020 2020 2020 2054 6865 2072             The r
+00026870: 6563 7461 6e67 6c65 2070 6174 7465 726e  ectangle pattern
+00026880: 2077 696c 6c20 6265 2063 656e 7465 7265   will be centere
+00026890: 6420 6174 2074 6865 2073 7065 6369 6669  d at the specifi
+000268a0: 6564 2063 6f6f 7264 696e 6174 6573 2028  ed coordinates (
+000268b0: 6365 6e74 7265 5f78 2c20 6365 6e74 7265  centre_x, centre
+000268c0: 5f79 2920 7769 7468 2074 6865 2073 7065  _y) with the spe
+000268d0: 6369 6669 6564 0a20 2020 2020 2020 2020  cified.         
+000268e0: 2020 2077 6964 7468 2c20 6865 6967 6874     width, height
+000268f0: 2061 6e64 2064 6570 7468 2028 696e 206e   and depth (in n
+00026900: 6d29 2e20 4966 2074 6865 2063 6c65 616e  m). If the clean
+00026910: 696e 675f 6372 6f73 735f 7365 6374 696f  ing_cross_sectio
+00026920: 6e20 6174 7472 6962 7574 6520 6f66 2070  n attribute of p
+00026930: 6174 7465 726e 5f73 6574 7469 6e67 7320  attern_settings 
+00026940: 6973 2054 7275 652c 2061 0a20 2020 2020  is True, a.     
+00026950: 2020 2020 2020 2063 6c65 616e 696e 6720         cleaning 
+00026960: 6372 6f73 7320 7365 6374 696f 6e20 7061  cross section pa
+00026970: 7474 6572 6e20 7769 6c6c 2062 6520 6372  ttern will be cr
+00026980: 6561 7465 6420 696e 7374 6561 6420 6f66  eated instead of
+00026990: 2061 2072 6563 7461 6e67 6c65 2070 6174   a rectangle pat
+000269a0: 7465 726e 2e0a 0a20 2020 2020 2020 2020  tern...         
+000269b0: 2020 2054 6865 2070 6174 7465 726e 2077     The pattern w
+000269c0: 696c 6c20 6265 2072 6f74 6174 6564 2062  ill be rotated b
+000269d0: 7920 7468 6520 616e 676c 6520 7370 6563  y the angle spec
+000269e0: 6966 6965 6420 696e 2074 6865 2072 6f74  ified in the rot
+000269f0: 6174 696f 6e20 6174 7472 6962 7574 6520  ation attribute 
+00026a00: 6f66 2070 6174 7465 726e 5f73 6574 7469  of pattern_setti
+00026a10: 6e67 7320 2869 6e20 6465 6772 6565 7329  ngs (in degrees)
+00026a20: 0a20 2020 2020 2020 2020 2020 2061 6e64  .            and
+00026a30: 2073 6361 6e6e 6564 2069 6e20 7468 6520   scanned in the 
+00026a40: 6469 7265 6374 696f 6e20 7370 6563 6966  direction specif
+00026a50: 6965 6420 696e 2074 6865 2073 6361 6e5f  ied in the scan_
+00026a60: 6469 7265 6374 696f 6e20 6174 7472 6962  direction attrib
+00026a70: 7574 6520 6f66 2070 6174 7465 726e 5f73  ute of pattern_s
+00026a80: 6574 7469 6e67 7320 2827 686f 7269 7a6f  ettings ('horizo
+00026a90: 6e74 616c 2720 6f72 0a20 2020 2020 2020  ntal' or.       
+00026aa0: 2020 2020 2027 7665 7274 6963 616c 2729       'vertical')
+00026ab0: 2e0a 0a20 2020 2020 2020 2020 2020 2054  ...            T
+00026ac0: 6865 2063 7265 6174 6564 2070 6174 7465  he created patte
+00026ad0: 726e 2063 616e 2062 6520 6164 6465 6420  rn can be added 
+00026ae0: 746f 2074 6865 2070 6174 7465 726e 696e  to the patternin
+00026af0: 6720 7175 6575 6520 616e 6420 6578 6563  g queue and exec
+00026b00: 7574 6564 2075 7369 6e67 2074 6865 206c  uted using the l
+00026b10: 6179 6572 206d 6574 686f 6473 2069 6e20  ayer methods in 
+00026b20: 4175 746f 6d61 7469 6f6e 2e0a 2020 2020  Automation..    
+00026b30: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+00026b40: 6365 6e74 7265 5f78 203d 2070 6174 7465  centre_x = patte
+00026b50: 726e 5f73 6574 7469 6e67 732e 6365 6e74  rn_settings.cent
+00026b60: 7265 5f78 0a20 2020 2020 2020 2063 656e  re_x.        cen
+00026b70: 7472 655f 7920 3d20 7061 7474 6572 6e5f  tre_y = pattern_
+00026b80: 7365 7474 696e 6773 2e63 656e 7472 655f  settings.centre_
+00026b90: 790a 2020 2020 2020 2020 6465 7074 6820  y.        depth 
+00026ba0: 3d20 7061 7474 6572 6e5f 7365 7474 696e  = pattern_settin
+00026bb0: 6773 2e64 6570 7468 0a20 2020 2020 2020  gs.depth.       
+00026bc0: 2077 6964 7468 203d 2070 6174 7465 726e   width = pattern
+00026bd0: 5f73 6574 7469 6e67 732e 7769 6474 680a  _settings.width.
+00026be0: 2020 2020 2020 2020 6865 6967 6874 203d          height =
+00026bf0: 2070 6174 7465 726e 5f73 6574 7469 6e67   pattern_setting
+00026c00: 732e 6865 6967 6874 0a20 2020 2020 2020  s.height.       
+00026c10: 2072 6f74 6174 696f 6e20 3d20 7061 7474   rotation = patt
+00026c20: 6572 6e5f 7365 7474 696e 6773 2e72 6f74  ern_settings.rot
+00026c30: 6174 696f 6e20 2a20 636f 6e73 7461 6e74  ation * constant
+00026c40: 732e 5241 4449 414e 535f 544f 5f44 4547  s.RADIANS_TO_DEG
+00026c50: 5245 4553 2023 2043 4845 434b 2055 4e49  REES # CHECK UNI
+00026c60: 5453 2028 5445 5343 414e 2054 616b 6573  TS (TESCAN Takes
+00026c70: 2044 6567 7265 6573 290a 2020 2020 2020   Degrees).      
+00026c80: 2020 7061 7468 7320 3d20 7365 6c66 2e67    paths = self.g
+00026c90: 6574 5f61 7661 696c 6162 6c65 5f76 616c  et_available_val
+00026ca0: 7565 7328 6b65 793d 2273 6361 6e5f 6469  ues(key="scan_di
+00026cb0: 7265 6374 696f 6e22 290a 2020 2020 2020  rection").      
+00026cc0: 2020 7061 7373 6573 203d 2070 6174 7465    passes = patte
+00026cd0: 726e 5f73 6574 7469 6e67 732e 7061 7373  rn_settings.pass
+00026ce0: 6573 2069 6620 7061 7474 6572 6e5f 7365  es if pattern_se
+00026cf0: 7474 696e 6773 2e70 6173 7365 7320 6973  ttings.passes is
+00026d00: 206e 6f74 204e 6f6e 6520 656c 7365 2031   not None else 1
+00026d10: 2e30 0a20 2020 2020 2020 2069 6620 7061  .0.        if pa
+00026d20: 7474 6572 6e5f 7365 7474 696e 6773 2e73  ttern_settings.s
+00026d30: 6361 6e5f 6469 7265 6374 696f 6e20 696e  can_direction in
+00026d40: 2070 6174 6873 3a0a 2020 2020 2020 2020   paths:.        
+00026d50: 2020 2020 7061 7468 203d 2070 6174 7465      path = patte
+00026d60: 726e 5f73 6574 7469 6e67 732e 7363 616e  rn_settings.scan
+00026d70: 5f64 6972 6563 7469 6f6e 0a20 2020 2020  _direction.     
+00026d80: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00026d90: 2020 2020 2070 6174 6820 3d20 2246 6c79       path = "Fly
+00026da0: 6261 636b 220a 2020 2020 2020 2020 2020  back".          
+00026db0: 2020 6c6f 6767 696e 672e 696e 666f 2866    logging.info(f
+00026dc0: 2253 6361 6e20 6469 7265 6374 696f 6e20  "Scan direction 
+00026dd0: 7b70 6174 7465 726e 5f73 6574 7469 6e67  {pattern_setting
+00026de0: 732e 7363 616e 5f64 6972 6563 7469 6f6e  s.scan_direction
+00026df0: 7d20 6e6f 7420 7375 7070 6f72 7465 642e  } not supported.
+00026e00: 2055 7369 6e67 2046 6c79 6261 636b 2069   Using Flyback i
+00026e10: 6e73 7465 6164 2e22 290a 2020 2020 2020  nstead.").      
+00026e20: 2020 2020 2020 6c6f 6767 696e 672e 696e        logging.in
+00026e30: 666f 2866 2253 7570 706f 7274 6564 2073  fo(f"Supported s
+00026e40: 6361 6e20 6469 7265 6374 696f 6e73 2061  can directions a
+00026e50: 7265 3a20 466c 7962 6163 6b2c 2052 4c45  re: Flyback, RLE
+00026e60: 2c20 5370 6972 616c 496e 7369 6465 4f75  , SpiralInsideOu
+00026e70: 742c 2053 7069 7261 6c4f 7574 7369 6465  t, SpiralOutside
+00026e80: 496e 2c20 5a69 675a 6167 2229 0a20 2020  In, ZigZag").   
+00026e90: 2020 2020 2073 656c 662e 636f 6e6e 6563       self.connec
+00026ea0: 7469 6f6e 2e44 7261 7742 6561 6d2e 5363  tion.DrawBeam.Sc
+00026eb0: 616e 6e69 6e67 5061 7468 203d 2070 6174  anningPath = pat
+00026ec0: 7465 726e 5f73 6574 7469 6e67 732e 7363  tern_settings.sc
+00026ed0: 616e 5f64 6972 6563 7469 6f6e 0a0a 2020  an_direction..  
+00026ee0: 2020 2020 2020 6966 2070 6174 7465 726e        if pattern
+00026ef0: 5f73 6574 7469 6e67 732e 636c 6561 6e69  _settings.cleani
+00026f00: 6e67 5f63 726f 7373 5f73 6563 7469 6f6e  ng_cross_section
+00026f10: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
+00026f20: 6c66 2e6c 6179 6572 2e61 6464 5265 6374  lf.layer.addRect
+00026f30: 616e 676c 6550 6f6c 6973 6828 0a20 2020  anglePolish(.   
+00026f40: 2020 2020 2020 2020 2020 2020 2043 656e               Cen
+00026f50: 7465 7258 3d63 656e 7472 655f 782c 0a20  terX=centre_x,. 
+00026f60: 2020 2020 2020 2020 2020 2020 2020 2043                 C
+00026f70: 656e 7465 7259 3d63 656e 7472 655f 792c  enterY=centre_y,
+00026f80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00026f90: 2044 6570 7468 3d64 6570 7468 2c0a 2020   Depth=depth,.  
+00026fa0: 2020 2020 2020 2020 2020 2020 2020 4465                De
+00026fb0: 7074 6855 6e69 743d 276d 272c 0a20 2020  pthUnit='m',.   
+00026fc0: 2020 2020 2020 2020 2020 2020 2057 6964               Wid
+00026fd0: 7468 3d77 6964 7468 2c0a 2020 2020 2020  th=width,.      
+00026fe0: 2020 2020 2020 2020 2020 4865 6967 6874            Height
+00026ff0: 3d68 6569 6768 742c 0a20 2020 2020 2020  =height,.       
+00027000: 2020 2020 2020 2020 2041 6e67 6c65 3d72           Angle=r
+00027010: 6f74 6174 696f 6e2c 0a20 2020 2020 2020  otation,.       
+00027020: 2020 2020 2020 2020 2053 6361 6e6e 696e           Scannin
+00027030: 6750 6174 683d 7061 7468 2c0a 2020 2020  gPath=path,.    
+00027040: 2020 2020 2020 2020 2020 2020 4578 706f              Expo
+00027050: 7369 7469 6f6e 4661 6374 6f72 3d70 6173  sitionFactor=pas
+00027060: 7365 730a 2020 2020 2020 2020 2020 2020  ses.            
+00027070: 290a 2020 2020 2020 2020 656c 7365 3a0a  ).        else:.
+00027080: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00027090: 2e6c 6179 6572 2e61 6464 5265 6374 616e  .layer.addRectan
+000270a0: 676c 6546 696c 6c65 6428 0a20 2020 2020  gleFilled(.     
+000270b0: 2020 2020 2020 2020 2020 2043 656e 7465             Cente
+000270c0: 7258 3d63 656e 7472 655f 782c 0a20 2020  rX=centre_x,.   
+000270d0: 2020 2020 2020 2020 2020 2020 2043 656e               Cen
+000270e0: 7465 7259 3d63 656e 7472 655f 792c 0a20  terY=centre_y,. 
+000270f0: 2020 2020 2020 2020 2020 2020 2020 2044                 D
+00027100: 6570 7468 3d64 6570 7468 2c0a 2020 2020  epth=depth,.    
+00027110: 2020 2020 2020 2020 2020 2020 4465 7074              Dept
+00027120: 6855 6e69 743d 276d 272c 0a20 2020 2020  hUnit='m',.     
+00027130: 2020 2020 2020 2020 2020 2057 6964 7468             Width
+00027140: 3d77 6964 7468 2c0a 2020 2020 2020 2020  =width,.        
+00027150: 2020 2020 2020 2020 4865 6967 6874 3d68          Height=h
+00027160: 6569 6768 742c 0a20 2020 2020 2020 2020  eight,.         
+00027170: 2020 2020 2020 2041 6e67 6c65 3d72 6f74         Angle=rot
+00027180: 6174 696f 6e2c 0a20 2020 2020 2020 2020  ation,.         
+00027190: 2020 2020 2020 2053 6361 6e6e 696e 6750         ScanningP
+000271a0: 6174 683d 7061 7468 2c0a 2020 2020 2020  ath=path,.      
+000271b0: 2020 2020 2020 2020 2020 4578 706f 7369            Exposi
+000271c0: 7469 6f6e 4661 6374 6f72 3d70 6173 7365  tionFactor=passe
+000271d0: 730a 2020 2020 2020 2020 2020 2020 290a  s.            ).
+000271e0: 0a20 2020 2020 2020 2070 6174 7465 726e  .        pattern
+000271f0: 203d 2073 656c 662e 6c61 7965 720a 2020   = self.layer.  
+00027200: 2020 2020 2020 0a20 2020 2020 2020 2072        .        r
+00027210: 6574 7572 6e20 7061 7474 6572 6e0a 0a20  eturn pattern.. 
+00027220: 2020 2064 6566 2064 7261 775f 6c69 6e65     def draw_line
+00027230: 2873 656c 662c 2070 6174 7465 726e 5f73  (self, pattern_s
+00027240: 6574 7469 6e67 733a 2046 6962 7365 6d50  ettings: FibsemP
+00027250: 6174 7465 726e 5365 7474 696e 6773 293a  atternSettings):
+00027260: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+00027270: 2020 2020 2044 7261 7773 2061 206c 696e       Draws a lin
+00027280: 6520 7061 7474 6572 6e20 6f6e 2074 6865  e pattern on the
+00027290: 2063 7572 7265 6e74 2069 6d61 6769 6e67   current imaging
+000272a0: 2076 6965 7720 6f66 2074 6865 206d 6963   view of the mic
+000272b0: 726f 7363 6f70 652e 0a0a 2020 2020 2020  roscope...      
+000272c0: 2020 4172 6773 3a0a 2020 2020 2020 2020    Args:.        
+000272d0: 2020 2020 7061 7474 6572 6e5f 7365 7474      pattern_sett
+000272e0: 696e 6773 2028 4669 6273 656d 5061 7474  ings (FibsemPatt
+000272f0: 6572 6e53 6574 7469 6e67 7329 3a20 4120  ernSettings): A 
+00027300: 6461 7461 2063 6c61 7373 206f 626a 6563  data class objec
+00027310: 7420 7370 6563 6966 7969 6e67 2074 6865  t specifying the
+00027320: 2070 6174 7465 726e 2070 6172 616d 6574   pattern paramet
+00027330: 6572 732c 0a20 2020 2020 2020 2020 2020  ers,.           
+00027340: 2020 2020 2069 6e63 6c75 6469 6e67 2074       including t
+00027350: 6865 2073 7461 7274 2061 6e64 2065 6e64  he start and end
+00027360: 2070 6f69 6e74 732c 2061 6e64 2074 6865   points, and the
+00027370: 2064 6570 7468 206f 6620 7468 6520 7061   depth of the pa
+00027380: 7474 6572 6e2e 0a0a 2020 2020 2020 2020  ttern...        
+00027390: 5265 7475 726e 733a 0a20 2020 2020 2020  Returns:.       
+000273a0: 2020 2020 204c 696e 6550 6174 7465 726e       LinePattern
+000273b0: 3a20 4120 6c69 6e65 2070 6174 7465 726e  : A line pattern
+000273c0: 206f 626a 6563 742c 2077 6869 6368 2063   object, which c
+000273d0: 616e 2062 6520 7573 6564 2074 6f20 636f  an be used to co
+000273e0: 6e66 6967 7572 6520 6675 7274 6865 7220  nfigure further 
+000273f0: 7072 6f70 6572 7469 6573 206f 7220 746f  properties or to
+00027400: 2061 6464 2074 6865 0a20 2020 2020 2020   add the.       
+00027410: 2020 2020 2020 2020 2070 6174 7465 726e           pattern
+00027420: 2074 6f20 7468 6520 6d69 6c6c 696e 6720   to the milling 
+00027430: 6c69 7374 2e0a 2020 2020 2020 2020 2222  list..        ""
+00027440: 220a 2020 2020 2020 2020 7374 6172 745f  ".        start_
+00027450: 7820 3d20 7061 7474 6572 6e5f 7365 7474  x = pattern_sett
+00027460: 696e 6773 2e73 7461 7274 5f78 0a20 2020  ings.start_x.   
+00027470: 2020 2020 2073 7461 7274 5f79 203d 2070       start_y = p
+00027480: 6174 7465 726e 5f73 6574 7469 6e67 732e  attern_settings.
+00027490: 7374 6172 745f 790a 2020 2020 2020 2020  start_y.        
+000274a0: 656e 645f 7820 3d20 7061 7474 6572 6e5f  end_x = pattern_
+000274b0: 7365 7474 696e 6773 2e65 6e64 5f78 0a20  settings.end_x. 
+000274c0: 2020 2020 2020 2065 6e64 5f79 203d 2070         end_y = p
+000274d0: 6174 7465 726e 5f73 6574 7469 6e67 732e  attern_settings.
+000274e0: 656e 645f 790a 2020 2020 2020 2020 6465  end_y.        de
+000274f0: 7074 6820 3d20 7061 7474 6572 6e5f 7365  pth = pattern_se
+00027500: 7474 696e 6773 2e64 6570 7468 0a0a 2020  ttings.depth..  
+00027510: 2020 2020 2020 7365 6c66 2e6c 6179 6572        self.layer
+00027520: 2e61 6464 4c69 6e65 280a 2020 2020 2020  .addLine(.      
+00027530: 2020 2020 2020 4265 6769 6e58 3d73 7461        BeginX=sta
+00027540: 7274 5f78 2c20 4265 6769 6e59 3d73 7461  rt_x, BeginY=sta
+00027550: 7274 5f79 2c20 456e 6458 3d65 6e64 5f78  rt_y, EndX=end_x
+00027560: 2c20 456e 6459 3d65 6e64 5f79 2c20 4465  , EndY=end_y, De
+00027570: 7074 683d 6465 7074 682c 2044 6570 7468  pth=depth, Depth
+00027580: 556e 6974 3d27 6d27 2c0a 2020 2020 2020  Unit='m',.      
+00027590: 2020 290a 0a20 2020 2020 2020 2070 6174    )..        pat
+000275a0: 7465 726e 203d 2073 656c 662e 6c61 7965  tern = self.laye
+000275b0: 720a 2020 2020 2020 2020 7265 7475 726e  r.        return
+000275c0: 2070 6174 7465 726e 0a0a 2020 2020 6465   pattern..    de
+000275d0: 6620 6472 6177 5f63 6972 636c 6528 7365  f draw_circle(se
+000275e0: 6c66 2c20 7061 7474 6572 6e5f 7365 7474  lf, pattern_sett
+000275f0: 696e 6773 3a20 4669 6273 656d 5061 7474  ings: FibsemPatt
+00027600: 6572 6e53 6574 7469 6e67 7329 3a0a 2020  ernSettings):.  
+00027610: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+00027620: 2020 4472 6177 7320 6120 6369 7263 6c65    Draws a circle
+00027630: 2070 6174 7465 726e 206f 6e20 7468 6520   pattern on the 
+00027640: 6375 7272 656e 7420 696d 6167 696e 6720  current imaging 
+00027650: 7669 6577 206f 6620 7468 6520 6d69 6372  view of the micr
+00027660: 6f73 636f 7065 2e0a 0a20 2020 2020 2020  oscope...       
+00027670: 2041 7267 733a 0a20 2020 2020 2020 2020   Args:.         
+00027680: 2020 2070 6174 7465 726e 5f73 6574 7469     pattern_setti
+00027690: 6e67 7320 2846 6962 7365 6d50 6174 7465  ngs (FibsemPatte
+000276a0: 726e 5365 7474 696e 6773 293a 2041 2064  rnSettings): A d
+000276b0: 6174 6120 636c 6173 7320 6f62 6a65 6374  ata class object
+000276c0: 2073 7065 6369 6679 696e 6720 7468 6520   specifying the 
+000276d0: 7061 7474 6572 6e20 7061 7261 6d65 7465  pattern paramete
+000276e0: 7273 2c0a 2020 2020 2020 2020 2020 2020  rs,.            
+000276f0: 2020 2020 696e 636c 7564 696e 6720 7468      including th
+00027700: 6520 6365 6e74 7265 2070 6f69 6e74 2c20  e centre point, 
+00027710: 7261 6469 7573 2061 6e64 2064 6570 7468  radius and depth
+00027720: 206f 6620 7468 6520 7061 7474 6572 6e2e   of the pattern.
+00027730: 0a0a 2020 2020 2020 2020 5265 7475 726e  ..        Return
+00027740: 733a 0a20 2020 2020 2020 2020 2020 2043  s:.            C
+00027750: 6972 636c 6550 6174 7465 726e 3a20 4120  irclePattern: A 
+00027760: 6369 7263 6c65 2070 6174 7465 726e 206f  circle pattern o
+00027770: 626a 6563 742c 2077 6869 6368 2063 616e  bject, which can
+00027780: 2062 6520 7573 6564 2074 6f20 636f 6e66   be used to conf
+00027790: 6967 7572 6520 6675 7274 6865 7220 7072  igure further pr
+000277a0: 6f70 6572 7469 6573 206f 7220 746f 2061  operties or to a
+000277b0: 6464 2074 6865 0a20 2020 2020 2020 2020  dd the.         
+000277c0: 2020 2020 2020 2070 6174 7465 726e 2074         pattern t
+000277d0: 6f20 7468 6520 6d69 6c6c 696e 6720 6c69  o the milling li
+000277e0: 7374 2e0a 0a20 2020 2020 2020 2020 2020  st...           
+000277f0: 200a 2020 2020 2020 2020 2222 220a 2020   .        """.  
+00027800: 2020 2020 2020 6966 2070 6174 7465 726e        if pattern
+00027810: 5f73 6574 7469 6e67 732e 636c 6561 6e69  _settings.cleani
+00027820: 6e67 5f63 726f 7373 5f73 6563 7469 6f6e  ng_cross_section
+00027830: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
+00027840: 6c66 2e6c 6179 6572 2e61 6464 416e 6e75  lf.layer.addAnnu
+00027850: 6c75 7350 6f6c 6973 6828 0a20 2020 2020  lusPolish(.     
+00027860: 2020 2020 2020 2020 2020 2043 656e 7465             Cente
+00027870: 7258 3d70 6174 7465 726e 5f73 6574 7469  rX=pattern_setti
+00027880: 6e67 732e 6365 6e74 7265 5f78 2c0a 2020  ngs.centre_x,.  
+00027890: 2020 2020 2020 2020 2020 2020 2020 4365                Ce
+000278a0: 6e74 6572 593d 7061 7474 6572 6e5f 7365  nterY=pattern_se
+000278b0: 7474 696e 6773 2e63 656e 7472 655f 792c  ttings.centre_y,
+000278c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000278d0: 2052 6164 6975 7341 3d70 6174 7465 726e   RadiusA=pattern
+000278e0: 5f73 6574 7469 6e67 732e 7261 6469 7573  _settings.radius
+000278f0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00027900: 2020 5261 6469 7573 423d 302c 0a20 2020    RadiusB=0,.   
+00027910: 2020 2020 2020 2020 2020 2020 2044 6570               Dep
+00027920: 7468 3d70 6174 7465 726e 5f73 6574 7469  th=pattern_setti
+00027930: 6e67 732e 6465 7074 682c 0a20 2020 2020  ngs.depth,.     
+00027940: 2020 2020 2020 2020 2020 2044 6570 7468             Depth
+00027950: 556e 6974 3d27 6d27 2c0a 2020 2020 2020  Unit='m',.      
+00027960: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
+00027970: 2070 6174 7465 726e 203d 2073 656c 662e   pattern = self.
+00027980: 6c61 7965 722e 6164 6441 6e6e 756c 7573  layer.addAnnulus
+00027990: 4669 6c6c 6564 280a 2020 2020 2020 2020  Filled(.        
+000279a0: 2020 2020 4365 6e74 6572 583d 7061 7474      CenterX=patt
+000279b0: 6572 6e5f 7365 7474 696e 6773 2e63 656e  ern_settings.cen
+000279c0: 7472 655f 782c 0a20 2020 2020 2020 2020  tre_x,.         
+000279d0: 2020 2043 656e 7465 7259 3d70 6174 7465     CenterY=patte
+000279e0: 726e 5f73 6574 7469 6e67 732e 6365 6e74  rn_settings.cent
+000279f0: 7265 5f79 2c0a 2020 2020 2020 2020 2020  re_y,.          
+00027a00: 2020 5261 6469 7573 413d 7061 7474 6572    RadiusA=patter
+00027a10: 6e5f 7365 7474 696e 6773 2e72 6164 6975  n_settings.radiu
+00027a20: 732c 0a20 2020 2020 2020 2020 2020 2052  s,.            R
+00027a30: 6164 6975 7342 3d30 2c0a 2020 2020 2020  adiusB=0,.      
+00027a40: 2020 2020 2020 4465 7074 683d 7061 7474        Depth=patt
+00027a50: 6572 6e5f 7365 7474 696e 6773 2e64 6570  ern_settings.dep
+00027a60: 7468 2c0a 2020 2020 2020 2020 2020 2020  th,.            
+00027a70: 4465 7074 6855 6e69 743d 276d 272c 0a20  DepthUnit='m',. 
+00027a80: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
+00027a90: 2020 7265 7475 726e 2070 6174 7465 726e    return pattern
+00027aa0: 0a20 2020 200a 2020 2020 6465 6620 6472  .    .    def dr
+00027ab0: 6177 5f61 6e6e 756c 7573 2873 656c 662c  aw_annulus(self,
+00027ac0: 7061 7474 6572 6e5f 7365 7474 696e 6773  pattern_settings
+00027ad0: 3a20 4669 6273 656d 5061 7474 6572 6e53  : FibsemPatternS
+00027ae0: 6574 7469 6e67 7329 3a0a 0a20 2020 2020  ettings):..     
+00027af0: 2020 2022 2222 4472 6177 7320 616e 2061     """Draws an a
+00027b00: 6e6e 756c 7573 2028 646f 6e75 7429 2070  nnulus (donut) p
+00027b10: 6174 7465 726e 206f 6e20 7468 6520 6375  attern on the cu
+00027b20: 7272 656e 7420 696d 6167 696e 6720 7669  rrent imaging vi
+00027b30: 6577 206f 6620 7468 6520 6d69 6372 6f73  ew of the micros
+00027b40: 636f 7065 2e0a 0a20 2020 2020 2020 2041  cope...        A
+00027b50: 7267 733a 200a 2020 2020 2020 2020 2020  rgs: .          
+00027b60: 2020 7061 7474 6572 6e5f 7365 7474 696e    pattern_settin
+00027b70: 6773 2028 4669 6273 656d 5061 7474 6572  gs (FibsemPatter
+00027b80: 6e53 6574 7469 6e67 7329 3a20 4120 6461  nSettings): A da
+00027b90: 7461 2063 6c61 7373 206f 626a 6563 7420  ta class object 
+00027ba0: 7370 6563 6966 7969 6e67 2074 6865 2070  specifying the p
+00027bb0: 6174 7465 726e 2070 6172 616d 6574 6572  attern parameter
+00027bc0: 732c 0a20 2020 2020 2020 2020 2020 2069  s,.            i
+00027bd0: 6e63 6c75 6469 6e67 2074 6865 2063 656e  ncluding the cen
+00027be0: 7472 6520 706f 696e 742c 206f 7574 6572  tre point, outer
+00027bf0: 2072 6164 6975 7320 616e 6420 7468 6963   radius and thic
+00027c00: 6b6e 6573 7320 6f66 2074 6865 2061 6e6e  kness of the ann
+00027c10: 756c 7573 2c20 616e 6420 7468 6520 6465  ulus, and the de
+00027c20: 7074 6820 6f66 2074 6865 2070 6174 7465  pth of the patte
+00027c30: 726e 2e0a 0a20 2020 2020 2020 2052 6574  rn...        Ret
+00027c40: 7572 6e73 3a0a 2020 2020 2020 2020 2020  urns:.          
+00027c50: 2020 616e 6e75 6c75 7320 7061 7474 6572    annulus patter
+00027c60: 6e20 6f62 6a65 6374 0a20 2020 2020 2020  n object.       
+00027c70: 2022 2222 0a20 2020 2020 2020 206f 7574   """.        out
+00027c80: 6572 5f72 6164 6975 7320 3d20 7061 7474  er_radius = patt
+00027c90: 6572 6e5f 7365 7474 696e 6773 2e72 6164  ern_settings.rad
+00027ca0: 6975 730a 2020 2020 2020 2020 696e 6e65  ius.        inne
+00027cb0: 725f 7261 6469 7573 203d 2070 6174 7465  r_radius = patte
+00027cc0: 726e 5f73 6574 7469 6e67 732e 7261 6469  rn_settings.radi
+00027cd0: 7573 202d 2070 6174 7465 726e 5f73 6574  us - pattern_set
+00027ce0: 7469 6e67 732e 7468 6963 6b6e 6573 730a  tings.thickness.
+00027cf0: 0a0a 2020 2020 2020 2020 7061 7474 6572  ..        patter
+00027d00: 6e20 3d20 7365 6c66 2e6c 6179 6572 2e61  n = self.layer.a
+00027d10: 6464 416e 6e75 6c75 7346 696c 6c65 6428  ddAnnulusFilled(
+00027d20: 0a20 2020 2020 2020 2020 2020 2043 656e  .            Cen
+00027d30: 7465 7258 3d70 6174 7465 726e 5f73 6574  terX=pattern_set
+00027d40: 7469 6e67 732e 6365 6e74 7265 5f78 2c0a  tings.centre_x,.
+00027d50: 2020 2020 2020 2020 2020 2020 4365 6e74              Cent
+00027d60: 6572 593d 7061 7474 6572 6e5f 7365 7474  erY=pattern_sett
+00027d70: 696e 6773 2e63 656e 7472 655f 792c 0a20  ings.centre_y,. 
+00027d80: 2020 2020 2020 2020 2020 2052 6164 6975             Radiu
+00027d90: 7341 3d6f 7574 6572 5f72 6164 6975 732c  sA=outer_radius,
+00027da0: 0a20 2020 2020 2020 2020 2020 2052 6164  .            Rad
+00027db0: 6975 7342 3d69 6e6e 6572 5f72 6164 6975  iusB=inner_radiu
+00027dc0: 732c 0a20 2020 2020 2020 2020 2020 2044  s,.            D
+00027dd0: 6570 7468 3d70 6174 7465 726e 5f73 6574  epth=pattern_set
+00027de0: 7469 6e67 732e 6465 7074 682c 0a20 2020  tings.depth,.   
+00027df0: 2020 2020 2020 2020 2044 6570 7468 556e           DepthUn
+00027e00: 6974 3d27 6d27 2c0a 2020 2020 2020 2020  it='m',.        
+00027e10: 290a 0a20 2020 2020 2020 2072 6574 7572  )..        retur
+00027e20: 6e20 7061 7474 6572 6e0a 2020 2020 0a20  n pattern.    . 
+00027e30: 2020 2064 6566 2064 7261 775f 6269 746d     def draw_bitm
+00027e40: 6170 5f70 6174 7465 726e 280a 2020 2020  ap_pattern(.    
+00027e50: 2020 2020 7365 6c66 2c0a 2020 2020 2020      self,.      
+00027e60: 2020 7061 7474 6572 6e5f 7365 7474 696e    pattern_settin
+00027e70: 6773 3a20 4669 6273 656d 5061 7474 6572  gs: FibsemPatter
+00027e80: 6e53 6574 7469 6e67 732c 0a20 2020 2020  nSettings,.     
+00027e90: 2020 2070 6174 683a 2073 7472 2c0a 2020     path: str,.  
+00027ea0: 2020 293a 0a20 2020 2020 2020 2072 6574    ):.        ret
+00027eb0: 7572 6e20 4e6f 7449 6d70 6c65 6d65 6e74  urn NotImplement
+00027ec0: 6564 0a20 2020 200a 2020 2020 6465 6620  ed.    .    def 
+00027ed0: 6765 745f 7363 616e 5f64 6972 6563 7469  get_scan_directi
+00027ee0: 6f6e 7328 7365 6c66 293a 0a20 2020 2020  ons(self):.     
+00027ef0: 2020 200a 2020 2020 2020 2020 6c69 7374     .        list
+00027f00: 203d 205b 2246 6c79 6261 636b 222c 2022   = ["Flyback", "
+00027f10: 524c 4522 2c20 2253 7069 7261 6c49 6e73  RLE", "SpiralIns
+00027f20: 6964 654f 7574 222c 2022 5370 6972 616c  ideOut", "Spiral
+00027f30: 4f75 7473 6964 6549 6e22 2c20 225a 6967  OutsideIn", "Zig
+00027f40: 5a61 6722 5d0a 2020 2020 2020 2020 7265  Zag"].        re
+00027f50: 7475 726e 206c 6973 740a 0a20 2020 2064  turn list..    d
+00027f60: 6566 2073 6574 7570 5f73 7075 7474 6572  ef setup_sputter
+00027f70: 2873 656c 662c 2070 726f 746f 636f 6c3a  (self, protocol:
+00027f80: 2064 6963 7429 3a0a 2020 2020 2020 2020   dict):.        
+00027f90: 2222 220a 2020 2020 2020 2020 5365 7420  """.        Set 
+00027fa0: 7570 2074 6865 2073 7075 7474 6572 2063  up the sputter c
+00027fb0: 6f61 7469 6e67 2070 726f 6365 7373 206f  oating process o
+00027fc0: 6e20 7468 6520 6d69 6372 6f73 636f 7065  n the microscope
+00027fd0: 2e0a 0a20 2020 2020 2020 2041 7267 733a  ...        Args:
+00027fe0: 0a20 2020 2020 2020 2020 2020 2070 726f  .            pro
+00027ff0: 746f 636f 6c20 2864 6963 7429 3a20 436f  tocol (dict): Co
+00028000: 6e74 6169 6e73 2061 6c6c 206f 6620 7468  ntains all of th
+00028010: 6520 6e65 6365 7373 6172 7920 7661 6c75  e necessary valu
+00028020: 6573 2074 6f20 7365 7475 7020 7570 2070  es to setup up p
+00028030: 6c61 7469 6e75 6d20 7370 7574 7465 7269  latinum sputteri
+00028040: 6e67 2e0a 2020 2020 2020 2020 2020 2020  ng..            
+00028050: 2020 2020 466f 7220 5445 5343 414e 3a0a      For TESCAN:.
+00028060: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028070: 2020 2020 2d20 6866 773a 2048 6f72 697a      - hfw: Horiz
+00028080: 6f6e 7461 6c20 6669 656c 6420 7769 6474  ontal field widt
+00028090: 6820 286d 292e 0a20 2020 2020 2020 2020  h (m)..         
+000280a0: 2020 2020 2020 2020 2020 202d 2062 6561             - bea
+000280b0: 6d5f 6375 7272 656e 743a 2049 6f6e 2062  m_current: Ion b
+000280c0: 6561 6d20 6375 7272 656e 7420 696e 205b  eam current in [
+000280d0: 415d 2e0a 2020 2020 2020 2020 2020 2020  A]..            
+000280e0: 2020 2020 2020 2020 2d20 7370 6f74 5f73          - spot_s
+000280f0: 697a 653a 2049 6f6e 2062 6561 6d20 7370  ize: Ion beam sp
+00028100: 6f74 2073 697a 6520 696e 205b 6d5d 2e0a  ot size in [m]..
+00028110: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028120: 2020 2020 2d20 7261 7465 3a20 496f 6e2f      - rate: Ion/
+00028130: 656c 6563 7472 6f6e 2065 7463 6869 6e67  electron etching
+00028140: 2072 6174 6520 2864 6570 6f73 6974 696f   rate (depositio
+00028150: 6e20 7261 7465 2920 696e 205b 6d33 2f41  n rate) in [m3/A
+00028160: 2f73 5d2e 2045 2e67 2e20 666f 7220 7369  /s]. E.g. for si
+00028170: 6c69 636f 6e65 2034 2e37 652d 3130 206d  licone 4.7e-10 m
+00028180: 332f 412f 732e 0a20 2020 2020 2020 2020  3/A/s..         
+00028190: 2020 2020 2020 2020 2020 202d 2064 7765             - dwe
+000281a0: 6c6c 2074 696d 653a 2050 6978 656c 2064  ll time: Pixel d
+000281b0: 7765 6c6c 2074 696d 6520 696e 205b 735d  well time in [s]
+000281c0: 2e0a 0a20 2020 2020 2020 2052 6574 7572  ...        Retur
+000281d0: 6e73 3a0a 2020 2020 2020 2020 2020 2020  ns:.            
+000281e0: 4e6f 6e65 0a0a 2020 2020 2020 2020 5261  None..        Ra
+000281f0: 6973 6573 3a0a 2020 2020 2020 2020 2020  ises:.          
+00028200: 2020 4e6f 6e65 0a0a 2020 2020 2020 2020    None..        
+00028210: 4e6f 7465 733a 0a20 2020 2020 2020 2020  Notes:.         
+00028220: 2020 2054 6869 7320 6675 6e63 7469 6f6e     This function
+00028230: 2073 6574 7320 7570 2074 6865 2073 7075   sets up the spu
+00028240: 7474 6572 2063 6f61 7469 6e67 2070 726f  tter coating pro
+00028250: 6365 7373 206f 6e20 7468 6520 6d69 6372  cess on the micr
+00028260: 6f73 636f 7065 2e20 0a20 2020 2020 2020  oscope. .       
+00028270: 2020 2020 2049 7420 7365 7473 2074 6865       It sets the
+00028280: 2061 6374 6976 6520 7669 6577 2074 6f20   active view to 
+00028290: 7468 6520 656c 6563 7472 6f6e 2062 6561  the electron bea
+000282a0: 6d2c 2063 6c65 6172 7320 616e 7920 6578  m, clears any ex
+000282b0: 6973 7469 6e67 2070 6174 7465 726e 732c  isting patterns,
+000282c0: 2061 6e64 2073 6574 7320 7468 6520 6465   and sets the de
+000282d0: 6661 756c 7420 6265 616d 2074 7970 6520  fault beam type 
+000282e0: 746f 2074 6865 2065 6c65 6374 726f 6e20  to the electron 
+000282f0: 6265 616d 2e20 0a20 2020 2020 2020 2020  beam. .         
+00028300: 2020 2049 7420 7468 656e 2069 6e73 6572     It then inser
+00028310: 7473 2074 6865 206d 756c 7469 6368 656d  ts the multichem
+00028320: 2061 6e64 2074 7572 6e73 206f 6e20 7468   and turns on th
+00028330: 6520 6865 6174 6572 2066 6f72 2074 6865  e heater for the
+00028340: 2073 7065 6369 6669 6564 2067 6173 2061   specified gas a
+00028350: 6363 6f72 6469 6e67 2074 6f20 7468 6520  ccording to the 
+00028360: 6769 7665 6e20 7072 6f74 6f63 6f6c 2e20  given protocol. 
+00028370: 0a20 2020 2020 2020 2020 2020 2054 6869  .            Thi
+00028380: 7320 6675 6e63 7469 6f6e 2061 6c73 6f20  s function also 
+00028390: 7761 6974 7320 666f 7220 3320 7365 636f  waits for 3 seco
+000283a0: 6e64 7320 746f 2061 6c6c 6f77 2074 6865  nds to allow the
+000283b0: 2068 6561 7465 7220 746f 2077 6172 6d20   heater to warm 
+000283c0: 7570 2e0a 2020 2020 2020 2020 2222 220a  up..        """.
+000283d0: 2020 2020 2020 2020 5f63 6865 636b 5f73          _check_s
+000283e0: 7075 7474 6572 2873 656c 662e 6861 7264  putter(self.hard
+000283f0: 7761 7265 5f73 6574 7469 6e67 7329 0a20  ware_settings). 
+00028400: 2020 2020 2020 2073 656c 662e 636f 6e6e         self.conn
+00028410: 6563 7469 6f6e 2e46 4942 2e42 6561 6d2e  ection.FIB.Beam.
+00028420: 4f6e 2829 0a20 2020 2020 2020 206c 696e  On().        lin
+00028430: 6573 203d 2073 656c 662e 636f 6e6e 6563  es = self.connec
+00028440: 7469 6f6e 2e47 4953 2e45 6e75 6d28 290a  tion.GIS.Enum().
+00028450: 2020 2020 2020 2020 666f 7220 6c69 6e65          for line
+00028460: 2069 6e20 6c69 6e65 733a 0a20 2020 2020   in lines:.     
+00028470: 2020 2020 2020 2069 6620 6c69 6e65 2e6e         if line.n
+00028480: 616d 6520 3d3d 2022 506c 6174 696e 756d  ame == "Platinum
+00028490: 223a 0a20 2020 2020 2020 2020 2020 2020  ":.             
+000284a0: 2020 2073 656c 662e 6c69 6e65 203d 206c     self.line = l
+000284b0: 696e 650a 0a20 2020 2020 2020 2020 2020  ine..           
+000284c0: 2020 2020 2023 2053 7461 7274 2047 4953       # Start GIS
+000284d0: 2068 6561 7469 6e67 0a20 2020 2020 2020   heating.       
+000284e0: 2020 2020 2020 2020 2073 656c 662e 636f           self.co
+000284f0: 6e6e 6563 7469 6f6e 2e47 4953 2e50 7265  nnection.GIS.Pre
+00028500: 7061 7265 5465 6d70 6572 6174 7572 6528  pareTemperature(
+00028510: 6c69 6e65 2c20 5472 7565 290a 0a20 2020  line, True)..   
+00028520: 2020 2020 2020 2020 2020 2020 2023 2049               # I
+00028530: 6e73 6572 7420 4749 5320 696e 746f 2077  nsert GIS into w
+00028540: 6f72 6b69 6e67 2070 6f73 6974 696f 6e0a  orking position.
+00028550: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028560: 7365 6c66 2e63 6f6e 6e65 6374 696f 6e2e  self.connection.
+00028570: 4749 532e 4d6f 7665 546f 286c 696e 652c  GIS.MoveTo(line,
+00028580: 2041 7574 6f6d 6174 696f 6e2e 4749 532e   Automation.GIS.
+00028590: 506f 7369 7469 6f6e 2e57 6f72 6b69 6e67  Position.Working
+000285a0: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
+000285b0: 2020 2023 2057 6169 7420 666f 7220 4749     # Wait for GI
+000285c0: 5320 6865 6174 6564 0a20 2020 2020 2020  S heated.       
+000285d0: 2020 2020 2020 2020 2073 656c 662e 636f           self.co
+000285e0: 6e6e 6563 7469 6f6e 2e47 4953 2e57 6169  nnection.GIS.Wai
+000285f0: 7446 6f72 5465 6d70 6572 6174 7572 6552  tForTemperatureR
+00028600: 6561 6479 286c 696e 6529 0a0a 2020 2020  eady(line)..    
+00028610: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+00028620: 2020 2020 206c 6179 6572 5365 7474 696e       layerSettin
+00028630: 6773 203d 2073 656c 662e 636f 6e6e 6563  gs = self.connec
+00028640: 7469 6f6e 2e44 7261 7742 6561 6d2e 4c61  tion.DrawBeam.La
+00028650: 7965 7253 6574 7469 6e67 732e 4944 6570  yerSettings.IDep
+00028660: 6f73 6974 696f 6e28 0a20 2020 2020 2020  osition(.       
+00028670: 2020 2020 2020 2020 2073 796e 6357 7269           syncWri
+00028680: 7465 4669 656c 643d 5472 7565 2c0a 2020  teField=True,.  
+00028690: 2020 2020 2020 2020 2020 2020 2020 7772                wr
+000286a0: 6974 6546 6965 6c64 5369 7a65 3d70 726f  iteFieldSize=pro
+000286b0: 746f 636f 6c5b 2268 6677 225d 2c0a 2020  tocol["hfw"],.  
+000286c0: 2020 2020 2020 2020 2020 2020 2020 6265                be
+000286d0: 616d 4375 7272 656e 743d 7072 6f74 6f63  amCurrent=protoc
+000286e0: 6f6c 5b22 6265 616d 5f63 7572 7265 6e74  ol["beam_current
+000286f0: 225d 2c0a 2020 2020 2020 2020 2020 2020  "],.            
+00028700: 2020 2020 7370 6f74 5369 7a65 3d70 726f      spotSize=pro
+00028710: 746f 636f 6c5b 2273 706f 745f 7369 7a65  tocol["spot_size
+00028720: 225d 2c0a 2020 2020 2020 2020 2020 2020  "],.            
+00028730: 2020 2020 7261 7465 3d33 652d 3130 2c20      rate=3e-10, 
+00028740: 2320 5661 6c75 6520 666f 7220 706c 6174  # Value for plat
+00028750: 696e 756d 0a20 2020 2020 2020 2020 2020  inum.           
+00028760: 2020 2020 2064 7765 6c6c 5469 6d65 3d70       dwellTime=p
+00028770: 726f 746f 636f 6c5b 2264 7765 6c6c 5f74  rotocol["dwell_t
+00028780: 696d 6522 5d2c 0a20 2020 2020 2020 2020  ime"],.         
+00028790: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+000287a0: 2073 656c 662e 6c61 7965 7220 3d20 7365   self.layer = se
+000287b0: 6c66 2e63 6f6e 6e65 6374 696f 6e2e 4472  lf.connection.Dr
+000287c0: 6177 4265 616d 2e4c 6179 6572 2822 4c61  awBeam.Layer("La
+000287d0: 7965 7231 222c 206c 6179 6572 5365 7474  yer1", layerSett
+000287e0: 696e 6773 290a 2020 2020 2020 2020 2020  ings).          
+000287f0: 2020 7365 6c66 2e63 6f6e 6e65 6374 696f    self.connectio
+00028800: 6e2e 4472 6177 4265 616d 2e4c 6f61 644c  n.DrawBeam.LoadL
+00028810: 6179 6572 2873 656c 662e 6c61 7965 7229  ayer(self.layer)
+00028820: 0a0a 2020 2020 2020 2020 6578 6365 7074  ..        except
+00028830: 3a0a 2020 2020 2020 2020 2020 2020 696d  :.            im
+00028840: 706f 7274 2066 6962 7365 6d0a 2020 2020  port fibsem.    
+00028850: 2020 2020 2020 2020 6261 7365 5f70 6174          base_pat
+00028860: 6820 3d20 6f73 2e70 6174 682e 6469 726e  h = os.path.dirn
+00028870: 616d 6528 6669 6273 656d 2e5f 5f70 6174  ame(fibsem.__pat
+00028880: 685f 5f5b 305d 290a 2020 2020 2020 2020  h__[0]).        
+00028890: 2020 2020 6c61 7965 725f 7061 7468 203d      layer_path =
+000288a0: 206f 732e 7061 7468 2e6a 6f69 6e28 6261   os.path.join(ba
+000288b0: 7365 5f70 6174 682c 2266 6962 7365 6d22  se_path,"fibsem"
+000288c0: 2c20 2263 6f6e 6669 6722 2c20 2264 6570  , "config", "dep
+000288d0: 6f73 6974 696f 6e2e 6462 7022 290a 2020  osition.dbp").  
+000288e0: 2020 2020 2020 2020 2020 7365 6c66 2e6c            self.l
+000288f0: 6179 6572 203d 2073 656c 662e 636f 6e6e  ayer = self.conn
+00028900: 6563 7469 6f6e 2e44 7261 7742 6561 6d2e  ection.DrawBeam.
+00028910: 4c61 7965 722e 6672 6f6d 4462 7028 6c61  Layer.fromDbp(la
+00028920: 7965 725f 7061 7468 295b 305d 0a20 2020  yer_path)[0].   
+00028930: 2020 2020 2020 2020 2023 2073 656c 662e           # self.
+00028940: 6c61 7965 7220 3d20 7365 6c66 2e63 6f6e  layer = self.con
+00028950: 6e65 6374 696f 6e2e 4472 6177 4265 616d  nection.DrawBeam
+00028960: 2e4c 6f61 644c 6179 6572 2864 6566 6175  .LoadLayer(defau
+00028970: 6c74 4c61 7965 7253 6574 7469 6e67 735b  ltLayerSettings[
+00028980: 305d 290a 0a20 2020 2064 6566 2064 7261  0])..    def dra
+00028990: 775f 7370 7574 7465 725f 7061 7474 6572  w_sputter_patter
+000289a0: 6e28 7365 6c66 2c20 6866 772c 206c 696e  n(self, hfw, lin
+000289b0: 655f 7061 7474 6572 6e5f 6c65 6e67 7468  e_pattern_length
+000289c0: 2c20 2a61 7267 732c 202a 2a6b 7761 7267  , *args, **kwarg
+000289d0: 7329 3a0a 2020 2020 2020 2020 2222 220a  s):.        """.
+000289e0: 2020 2020 2020 2020 4472 6177 7320 6120          Draws a 
+000289f0: 6c69 6e65 2070 6174 7465 726e 2066 6f72  line pattern for
+00028a00: 2073 7075 7474 6572 696e 6720 7769 7468   sputtering with
+00028a10: 2074 6865 2067 6976 656e 2070 6172 616d   the given param
+00028a20: 6574 6572 732e 0a0a 2020 2020 2020 2020  eters...        
+00028a30: 4172 6773 3a0a 2020 2020 2020 2020 2020  Args:.          
+00028a40: 2020 6866 7720 2866 6c6f 6174 293a 2054    hfw (float): T
+00028a50: 6865 2068 6f72 697a 6f6e 7461 6c20 6669  he horizontal fi
+00028a60: 656c 6420 7769 6474 6820 6f66 2074 6865  eld width of the
+00028a70: 2065 6c65 6374 726f 6e20 6265 616d 2e0a   electron beam..
+00028a80: 2020 2020 2020 2020 2020 2020 6c69 6e65              line
+00028a90: 5f70 6174 7465 726e 5f6c 656e 6774 6820  _pattern_length 
+00028aa0: 2866 6c6f 6174 293a 2054 6865 206c 656e  (float): The len
+00028ab0: 6774 6820 6f66 2074 6865 206c 696e 6520  gth of the line 
+00028ac0: 7061 7474 6572 6e20 746f 2064 7261 772e  pattern to draw.
+00028ad0: 0a20 2020 2020 2020 2020 2020 202a 6172  .            *ar
+00028ae0: 6773 2c20 2a2a 6b77 6172 6773 3a20 5468  gs, **kwargs: Th
+00028af0: 6973 2072 6570 7265 7365 6e74 7320 7468  is represents th
+00028b00: 6520 6172 6775 6d65 6e74 7320 7573 6564  e arguments used
+00028b10: 2062 7920 5468 6572 6d6f 4d69 6372 6f73   by ThermoMicros
+00028b20: 636f 7065 2074 6861 7420 6172 6520 6e6f  cope that are no
+00028b30: 7420 7265 7175 6972 6564 2066 6f72 2074  t required for t
+00028b40: 6865 2054 6573 6361 6e4d 6963 726f 7363  he TescanMicrosc
+00028b50: 6f70 652e 0a0a 2020 2020 2020 2020 5265  ope...        Re
+00028b60: 7475 726e 733a 0a20 2020 2020 2020 2020  turns:.         
+00028b70: 2020 204e 6f6e 650a 0a20 2020 2020 2020     None..       
+00028b80: 204e 6f74 6573 3a0a 2020 2020 2020 2020   Notes:.        
+00028b90: 2020 2020 5365 7473 2074 6865 2068 6f72      Sets the hor
+00028ba0: 697a 6f6e 7461 6c20 6669 656c 6420 7769  izontal field wi
+00028bb0: 6474 6820 6f66 2074 6865 2065 6c65 6374  dth of the elect
+00028bc0: 726f 6e20 6265 616d 2074 6f20 7468 6520  ron beam to the 
+00028bd0: 6769 7665 6e20 7661 6c75 652e 0a20 2020  given value..   
+00028be0: 2020 2020 2020 2020 2044 7261 7773 2061           Draws a
+00028bf0: 206c 696e 6520 7061 7474 6572 6e20 666f   line pattern fo
+00028c00: 7220 7370 7574 7465 7269 6e67 2077 6974  r sputtering wit
+00028c10: 6820 7468 6520 6769 7665 6e20 6c65 6e67  h the given leng
+00028c20: 7468 2061 6e64 206d 696c 6c69 6e67 2064  th and milling d
+00028c30: 6570 7468 2e0a 2020 2020 2020 2020 2020  epth..          
+00028c40: 2020 5365 7473 2074 6865 2073 7075 7474    Sets the sputt
+00028c50: 6572 2074 696d 6520 6f66 2074 6865 206c  er time of the l
+00028c60: 696e 6520 7061 7474 6572 6e20 746f 2074  ine pattern to t
+00028c70: 6865 2067 6976 656e 2076 616c 7565 2e0a  he given value..
+00028c80: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+00028c90: 2020 2020 2073 656c 662e 636f 6e6e 6563       self.connec
+00028ca0: 7469 6f6e 2e46 4942 2e4f 7074 6963 732e  tion.FIB.Optics.
+00028cb0: 5365 7456 6965 7766 6965 6c64 280a 2020  SetViewfield(.  
+00028cc0: 2020 2020 2020 2020 2020 6866 7720 2a20            hfw * 
+00028cd0: 636f 6e73 7461 6e74 732e 4d45 5452 455f  constants.METRE_
+00028ce0: 544f 5f4d 494c 4c49 4d45 5452 450a 2020  TO_MILLIMETRE.  
+00028cf0: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
+00028d00: 2073 7461 7274 5f78 3d2d 6c69 6e65 5f70   start_x=-line_p
+00028d10: 6174 7465 726e 5f6c 656e 6774 682f 322c  attern_length/2,
+00028d20: 200a 2020 2020 2020 2020 7374 6172 745f   .        start_
+00028d30: 793d 2b6c 696e 655f 7061 7474 6572 6e5f  y=+line_pattern_
+00028d40: 6c65 6e67 7468 2c0a 2020 2020 2020 2020  length,.        
+00028d50: 656e 645f 783d 2b6c 696e 655f 7061 7474  end_x=+line_patt
+00028d60: 6572 6e5f 6c65 6e67 7468 2f32 2c0a 2020  ern_length/2,.  
+00028d70: 2020 2020 2020 656e 645f 793d 2b6c 696e        end_y=+lin
+00028d80: 655f 7061 7474 6572 6e5f 6c65 6e67 7468  e_pattern_length
+00028d90: 2c0a 2020 2020 2020 2020 6465 7074 683d  ,.        depth=
+00028da0: 3265 2d36 0a20 2020 2020 2020 200a 2020  2e-6.        .  
+00028db0: 2020 2020 2020 7061 7474 6572 6e20 3d20        pattern = 
+00028dc0: 7365 6c66 2e6c 6179 6572 2e61 6464 4c69  self.layer.addLi
+00028dd0: 6e65 280a 2020 2020 2020 2020 2020 2020  ne(.            
+00028de0: 4265 6769 6e58 3d73 7461 7274 5f78 2c20  BeginX=start_x, 
+00028df0: 4265 6769 6e59 3d73 7461 7274 5f79 2c20  BeginY=start_y, 
+00028e00: 456e 6458 3d65 6e64 5f78 2c20 456e 6459  EndX=end_x, EndY
+00028e10: 3d65 6e64 5f79 2c20 4465 7074 683d 6465  =end_y, Depth=de
+00028e20: 7074 680a 2020 2020 2020 2020 290a 2020  pth.        ).  
+00028e30: 2020 2020 2020 0a20 2020 2020 2020 2072        .        r
+00028e40: 6574 7572 6e20 7061 7474 6572 6e0a 0a20  eturn pattern.. 
+00028e50: 2020 2064 6566 2072 756e 5f73 7075 7474     def run_sputt
+00028e60: 6572 2873 656c 662c 202a 6172 6773 2c20  er(self, *args, 
+00028e70: 2a2a 6b77 6172 6773 293a 0a20 2020 2020  **kwargs):.     
+00028e80: 2020 2022 2222 0a20 2020 2020 2020 2052     """.        R
+00028e90: 756e 7320 7468 6520 4749 5320 506c 6174  uns the GIS Plat
+00028ea0: 696e 756d 2053 7075 7474 6572 2e0a 0a20  inum Sputter... 
+00028eb0: 2020 2020 2020 2041 7267 733a 0a20 2020         Args:.   
+00028ec0: 2020 2020 2020 2020 202a 6172 6773 2c20           *args, 
+00028ed0: 2a2a 6b77 6172 6773 3a20 5573 6564 2074  **kwargs: Used t
+00028ee0: 6f20 6d61 696e 7461 696e 2066 756e 6374  o maintain funct
+00028ef0: 696f 6e61 6c69 7479 2061 6e64 2063 6f6d  ionality and com
+00028f00: 7061 7461 6269 6c69 7479 2062 6574 7765  patability betwe
+00028f10: 656e 206d 6963 726f 7363 6f70 6573 2e20  en microscopes. 
+00028f20: 4e6f 2061 7267 756d 656e 7473 2072 6571  No arguments req
+00028f30: 7569 7265 642e 0a20 2020 2020 2020 2020  uired..         
+00028f40: 2020 200a 2020 2020 2020 2020 5275 6e73     .        Runs
+00028f50: 2074 6865 2047 4953 2050 6c61 7469 6e75   the GIS Platinu
+00028f60: 6d20 5370 7574 7465 722e 0a0a 2020 2020  m Sputter...    
+00028f70: 2020 2020 5265 7475 726e 733a 0a20 2020      Returns:.   
+00028f80: 2020 2020 2020 2020 204e 6f6e 650a 2020           None.  
+00028f90: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+00028fa0: 2020 5f63 6865 636b 5f73 7075 7474 6572    _check_sputter
+00028fb0: 2873 656c 662e 6861 7264 7761 7265 5f73  (self.hardware_s
+00028fc0: 6574 7469 6e67 7329 0a20 2020 2020 2020  ettings).       
+00028fd0: 2023 204f 7065 6e20 4749 5320 7661 6c76   # Open GIS valv
+00028fe0: 6520 746f 206c 6574 2074 6865 2067 6173  e to let the gas
+00028ff0: 2066 6c6f 7720 6f6e 746f 2074 6865 2073   flow onto the s
+00029000: 616d 706c 650a 2020 2020 2020 2020 7365  ample.        se
+00029010: 6c66 2e63 6f6e 6e65 6374 696f 6e2e 4749  lf.connection.GI
+00029020: 532e 4f70 656e 5661 6c76 6528 7365 6c66  S.OpenValve(self
+00029030: 2e6c 696e 6529 0a0a 2020 2020 2020 2020  .line)..        
+00029040: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
+00029050: 2023 2052 756e 2070 7265 6465 6669 6e65   # Run predefine
+00029060: 6420 6465 706f 7369 7469 6f6e 2070 726f  d deposition pro
+00029070: 6365 7373 0a20 2020 2020 2020 2020 2020  cess.           
+00029080: 2073 656c 662e 636f 6e6e 6563 7469 6f6e   self.connection
+00029090: 2e44 7261 7742 6561 6d2e 5374 6172 7428  .DrawBeam.Start(
+000290a0: 290a 2020 2020 2020 2020 2020 2020 7365  ).            se
+000290b0: 6c66 2e63 6f6e 6e65 6374 696f 6e2e 5072  lf.connection.Pr
+000290c0: 6f67 7265 7373 2e53 686f 7728 2244 7261  ogress.Show("Dra
+000290d0: 7742 6561 6d22 2c20 224c 6179 6572 2031  wBeam", "Layer 1
+000290e0: 2069 6e20 7072 6f67 7265 7373 222c 2046   in progress", F
+000290f0: 616c 7365 2c20 4661 6c73 652c 2030 2c20  alse, False, 0, 
+00029100: 3130 3029 0a20 2020 2020 2020 2020 2020  100).           
+00029110: 206c 6f67 6769 6e67 2e69 6e66 6f28 2253   logging.info("S
+00029120: 7075 7474 6572 696e 6720 7769 7468 2070  puttering with p
+00029130: 6c61 7469 6e75 6d20 7374 6172 7465 642e  latinum started.
+00029140: 2229 0a20 2020 2020 2020 2020 2020 2077  ").            w
+00029150: 6869 6c65 2054 7275 653a 0a20 2020 2020  hile True:.     
+00029160: 2020 2020 2020 2020 2020 2073 7461 7475             statu
+00029170: 7320 3d20 7365 6c66 2e63 6f6e 6e65 6374  s = self.connect
+00029180: 696f 6e2e 4472 6177 4265 616d 2e47 6574  ion.DrawBeam.Get
+00029190: 5374 6174 7573 2829 0a20 2020 2020 2020  Status().       
+000291a0: 2020 2020 2020 2020 2072 756e 6e69 6e67           running
+000291b0: 203d 2073 7461 7475 735b 305d 203d 3d20   = status[0] == 
+000291c0: 7365 6c66 2e63 6f6e 6e65 6374 696f 6e2e  self.connection.
+000291d0: 4472 6177 4265 616d 2e53 7461 7475 732e  DrawBeam.Status.
+000291e0: 5072 6f6a 6563 744c 6f61 6465 6445 7870  ProjectLoadedExp
+000291f0: 6f73 6974 696f 6e49 6e50 726f 6772 6573  ositionInProgres
+00029200: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
+00029210: 2020 6966 2072 756e 6e69 6e67 3a0a 2020    if running:.  
+00029220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029230: 2020 7072 6f67 7265 7373 203d 2030 0a20    progress = 0. 
+00029240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029250: 2020 2069 6620 7374 6174 7573 5b31 5d20     if status[1] 
+00029260: 3e20 303a 0a20 2020 2020 2020 2020 2020  > 0:.           
+00029270: 2020 2020 2020 2020 2020 2020 2070 726f               pro
+00029280: 6772 6573 7320 3d20 6d69 6e28 3130 302c  gress = min(100,
+00029290: 2073 7461 7475 735b 325d 202f 2073 7461   status[2] / sta
+000292a0: 7475 735b 315d 202a 2031 3030 290a 2020  tus[1] * 100).  
+000292b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000292c0: 2020 7072 696e 7450 726f 6772 6573 7342    printProgressB
+000292d0: 6172 2870 726f 6772 6573 732c 2031 3030  ar(progress, 100
+000292e0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+000292f0: 2020 2020 2020 7365 6c66 2e63 6f6e 6e65        self.conne
+00029300: 6374 696f 6e2e 5072 6f67 7265 7373 2e53  ction.Progress.S
+00029310: 6574 5065 7263 656e 7473 2870 726f 6772  etPercents(progr
+00029320: 6573 7329 0a20 2020 2020 2020 2020 2020  ess).           
+00029330: 2020 2020 2020 2020 2074 696d 652e 736c           time.sl
+00029340: 6565 7028 3129 0a20 2020 2020 2020 2020  eep(1).         
+00029350: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00029360: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029370: 2069 6620 7374 6174 7573 5b30 5d20 3d3d   if status[0] ==
+00029380: 2073 656c 662e 636f 6e6e 6563 7469 6f6e   self.connection
+00029390: 2e44 7261 7742 6561 6d2e 5374 6174 7573  .DrawBeam.Status
+000293a0: 2e50 726f 6a65 6374 4c6f 6164 6564 4578  .ProjectLoadedEx
+000293b0: 706f 7369 7469 6f6e 4964 6c65 3a0a 2020  positionIdle:.  
+000293c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000293d0: 2020 2020 2020 7072 696e 7450 726f 6772        printProgr
+000293e0: 6573 7342 6172 2831 3030 2c20 3130 302c  essBar(100, 100,
+000293f0: 2073 7566 6669 783d 2746 696e 6973 6865   suffix='Finishe
+00029400: 6427 290a 2020 2020 2020 2020 2020 2020  d').            
+00029410: 2020 2020 2020 2020 2020 2020 7072 696e              prin
+00029420: 7428 2727 290a 2020 2020 2020 2020 2020  t('').          
+00029430: 2020 2020 2020 2020 2020 6272 6561 6b0a            break.
+00029440: 2020 2020 2020 2020 6669 6e61 6c6c 793a          finally:
+00029450: 0a20 2020 2020 2020 2020 2020 2023 2043  .            # C
+00029460: 6c6f 7365 2047 4953 2056 616c 7665 2069  lose GIS Valve i
+00029470: 6e20 626f 7468 202d 2073 7563 6365 7373  n both - success
+00029480: 2061 6e64 2066 6169 6c75 7265 0a20 2020   and failure.   
+00029490: 2020 2020 2020 2020 2073 656c 662e 636f           self.co
+000294a0: 6e6e 6563 7469 6f6e 2e47 4953 2e43 6c6f  nnection.GIS.Clo
+000294b0: 7365 5661 6c76 6528 7365 6c66 2e6c 696e  seValve(self.lin
+000294c0: 6529 0a20 2020 2020 2020 200a 2020 2020  e).        .    
+000294d0: 6465 6620 6669 6e69 7368 5f73 7075 7474  def finish_sputt
+000294e0: 6572 2873 656c 662c 202a 6172 6773 2c20  er(self, *args, 
+000294f0: 2a2a 6b77 6172 6773 293a 0a20 2020 2020  **kwargs):.     
+00029500: 2020 2022 2222 0a20 2020 2020 2020 2046     """.        F
+00029510: 696e 6973 6820 7468 6520 7370 7574 7465  inish the sputte
+00029520: 7220 7072 6f63 6573 7320 6279 2072 6574  r process by ret
+00029530: 7261 6374 696e 6720 7468 6520 4749 5320  racting the GIS 
+00029540: 6368 616d 6265 7220 616e 6420 7475 726e  chamber and turn
+00029550: 696e 6720 6f66 6620 7468 6520 6865 6174  ing off the heat
+00029560: 696e 672e 0a0a 2020 2020 2020 2020 4172  ing...        Ar
+00029570: 6773 3a0a 2020 2020 2020 2020 2020 2020  gs:.            
+00029580: 2a61 7267 732c 202a 2a6b 7761 7267 733a  *args, **kwargs:
+00029590: 2054 6869 7320 7265 7072 6573 656e 7473   This represents
+000295a0: 2074 6865 2061 7267 756d 656e 7473 2075   the arguments u
+000295b0: 7365 6420 6279 2054 6865 726d 6f4d 6963  sed by ThermoMic
+000295c0: 726f 7363 6f70 6520 7468 6174 2061 7265  roscope that are
+000295d0: 206e 6f74 2072 6571 7569 7265 6420 666f   not required fo
+000295e0: 7220 7468 6520 5465 7363 616e 4d69 6372  r the TescanMicr
+000295f0: 6f73 636f 7065 2e0a 0a20 2020 2020 2020  oscope...       
+00029600: 2052 6574 7572 6e73 3a0a 2020 2020 2020   Returns:.      
+00029610: 2020 2020 2020 4e6f 6e65 0a0a 2020 2020        None..    
+00029620: 2020 2020 5261 6973 6573 3a0a 2020 2020      Raises:.    
+00029630: 2020 2020 2020 2020 4e6f 6e65 0a20 2020          None.   
+00029640: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+00029650: 205f 6368 6563 6b5f 7370 7574 7465 7228   _check_sputter(
+00029660: 7365 6c66 2e68 6172 6477 6172 655f 7365  self.hardware_se
+00029670: 7474 696e 6773 290a 2020 2020 2020 2020  ttings).        
+00029680: 2320 4d6f 7665 2047 4953 206f 7574 2066  # Move GIS out f
+00029690: 726f 6d20 6368 616d 6265 7220 616e 6420  rom chamber and 
+000296a0: 7475 726e 206f 6666 2068 6561 7469 6e67  turn off heating
+000296b0: 0a20 2020 2020 2020 2073 656c 662e 636f  .        self.co
+000296c0: 6e6e 6563 7469 6f6e 2e47 4953 2e4d 6f76  nnection.GIS.Mov
+000296d0: 6554 6f28 7365 6c66 2e6c 696e 652c 2041  eTo(self.line, A
+000296e0: 7574 6f6d 6174 696f 6e2e 4749 532e 506f  utomation.GIS.Po
+000296f0: 7369 7469 6f6e 2e48 6f6d 6529 0a20 2020  sition.Home).   
+00029700: 2020 2020 2073 656c 662e 636f 6e6e 6563       self.connec
+00029710: 7469 6f6e 2e47 4953 2e50 7265 7061 7265  tion.GIS.Prepare
+00029720: 5465 6d70 6572 6174 7572 6528 7365 6c66  Temperature(self
+00029730: 2e6c 696e 652c 2046 616c 7365 290a 2020  .line, False).  
+00029740: 2020 2020 2020 7365 6c66 2e63 6f6e 6e65        self.conne
+00029750: 6374 696f 6e2e 4472 6177 4265 616d 2e55  ction.DrawBeam.U
+00029760: 6e6c 6f61 644c 6179 6572 2829 0a20 2020  nloadLayer().   
+00029770: 2020 2020 206c 6f67 6769 6e67 2e69 6e66       logging.inf
+00029780: 6f28 2250 6c61 7469 6e75 6d20 7370 7574  o("Platinum sput
+00029790: 7465 7269 6e67 2070 726f 6365 7373 2063  tering process c
+000297a0: 6f6d 706c 6574 6564 2e22 290a 0a20 2020  ompleted.")..   
+000297b0: 2064 6566 2073 6574 7570 5f47 4953 2873   def setup_GIS(s
+000297c0: 656c 662c 7072 6f74 6f63 6f6c 2920 2d3e  elf,protocol) ->
+000297d0: 204e 6f6e 653a 0a0a 2020 2020 2020 2020   None:..        
+000297e0: 6265 616d 5f74 7970 6520 3d20 7072 6f74  beam_type = prot
+000297f0: 6f63 6f6c 5b22 6265 616d 5f74 7970 6522  ocol["beam_type"
+00029800: 5d0a 0a20 2020 2020 2020 2069 6620 6265  ]..        if be
+00029810: 616d 5f74 7970 6520 3d3d 2022 494f 4e22  am_type == "ION"
+00029820: 3a0a 0a0a 2020 2020 2020 2020 2020 2020  :...            
+00029830: 6c61 7965 7253 6574 7469 6e67 7320 3d20  layerSettings = 
+00029840: 7365 6c66 2e63 6f6e 6e65 6374 696f 6e2e  self.connection.
+00029850: 4472 6177 4265 616d 2e4c 6179 6572 5365  DrawBeam.LayerSe
+00029860: 7474 696e 6773 2e49 4465 706f 7369 7469  ttings.IDepositi
+00029870: 6f6e 280a 2020 2020 2020 2020 2020 2020  on(.            
+00029880: 2020 2020 7379 6e63 5772 6974 6546 6965      syncWriteFie
+00029890: 6c64 3d54 7275 652c 0a20 2020 2020 2020  ld=True,.       
+000298a0: 2020 2020 2020 2020 2077 7269 7465 4669           writeFi
+000298b0: 656c 6453 697a 653d 7072 6f74 6f63 6f6c  eldSize=protocol
+000298c0: 2e67 6574 2822 6866 7722 2c30 2e30 3030  .get("hfw",0.000
+000298d0: 3529 2c0a 2020 2020 2020 2020 2020 2020  5),.            
+000298e0: 2020 2020 6265 616d 4375 7272 656e 743d      beamCurrent=
+000298f0: 7072 6f74 6f63 6f6c 2e67 6574 2822 6265  protocol.get("be
+00029900: 616d 5f63 7572 7265 6e74 222c 3565 2d31  am_current",5e-1
+00029910: 3029 2c0a 2020 2020 2020 2020 2020 2020  0),.            
+00029920: 2020 2020 7370 6f74 5369 7a65 3d70 726f      spotSize=pro
+00029930: 746f 636f 6c2e 6765 7428 2273 706f 745f  tocol.get("spot_
+00029940: 7369 7a65 222c 352e 3065 2d38 292c 0a20  size",5.0e-8),. 
+00029950: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00029960: 7061 6369 6e67 3d31 2e30 2c0a 2020 2020  pacing=1.0,.    
+00029970: 2020 2020 2020 2020 2020 2020 7261 7465              rate
+00029980: 3d33 652d 3130 2c20 2320 5661 6c75 6520  =3e-10, # Value 
+00029990: 666f 7220 706c 6174 696e 756d 0a20 2020  for platinum.   
+000299a0: 2020 2020 2020 2020 2020 2020 2064 7765               dwe
+000299b0: 6c6c 5469 6d65 3d70 726f 746f 636f 6c2e  llTime=protocol.
+000299c0: 6765 7428 2264 7765 6c6c 5f74 696d 6522  get("dwell_time"
+000299d0: 2c31 2e30 652d 3629 2c0a 2020 2020 2020  ,1.0e-6),.      
+000299e0: 2020 2020 2020 2020 2020 7072 6573 6574            preset
+000299f0: 3d4e 6f6e 652c 0a20 2020 2020 2020 2020  =None,.         
+00029a00: 2020 2020 2020 2070 6172 616c 6c65 6c3d         parallel=
+00029a10: 4661 6c73 652c 0a20 2020 2020 2020 2020  False,.         
+00029a20: 2020 2020 2020 206d 6174 6572 6961 6c3d         material=
+00029a30: 2744 6566 6175 6c74 204d 6174 6572 6961  'Default Materia
+00029a40: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
+00029a50: 2020 2020 6769 7350 7265 6375 7273 6f72      gisPrecursor
+00029a60: 3d4e 6f6e 652c 0a0a 2020 2020 2020 2020  =None,..        
+00029a70: 2020 2020 290a 0a20 2020 2020 2020 2065      )..        e
+00029a80: 6c73 653a 0a0a 0a20 2020 2020 2020 2020  lse:...         
+00029a90: 2020 206c 6179 6572 5365 7474 696e 6773     layerSettings
+00029aa0: 203d 2073 656c 662e 636f 6e6e 6563 7469   = self.connecti
+00029ab0: 6f6e 2e44 7261 7742 6561 6d2e 4c61 7965  on.DrawBeam.Laye
+00029ac0: 7253 6574 7469 6e67 732e 4544 6570 6f73  rSettings.EDepos
+00029ad0: 6974 696f 6e28 0a20 2020 2020 2020 2020  ition(.         
+00029ae0: 2020 2020 2020 2073 796e 6357 7269 7465         syncWrite
+00029af0: 4669 656c 643d 5472 7565 2c0a 2020 2020  Field=True,.    
+00029b00: 2020 2020 2020 2020 2020 2020 7772 6974              writ
+00029b10: 6546 6965 6c64 5369 7a65 3d70 726f 746f  eFieldSize=proto
+00029b20: 636f 6c2e 6765 7428 2268 6677 222c 302e  col.get("hfw",0.
+00029b30: 3030 3035 292c 0a20 2020 2020 2020 2020  0005),.         
+00029b40: 2020 2020 2020 2062 6561 6d43 7572 7265         beamCurre
+00029b50: 6e74 3d70 726f 746f 636f 6c2e 6765 7428  nt=protocol.get(
+00029b60: 2262 6561 6d5f 6375 7272 656e 7422 2c35  "beam_current",5
+00029b70: 652d 3130 292c 0a20 2020 2020 2020 2020  e-10),.         
+00029b80: 2020 2020 2020 2073 706f 7453 697a 653d         spotSize=
+00029b90: 7072 6f74 6f63 6f6c 2e67 6574 2822 7370  protocol.get("sp
+00029ba0: 6f74 5f73 697a 6522 2c35 2e30 652d 3829  ot_size",5.0e-8)
+00029bb0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00029bc0: 2020 7261 7465 3d33 652d 3130 2c20 2320    rate=3e-10, # 
+00029bd0: 5661 6c75 6520 666f 7220 706c 6174 696e  Value for platin
+00029be0: 756d 0a20 2020 2020 2020 2020 2020 2020  um.             
+00029bf0: 2020 2073 7061 6369 6e67 3d31 2e30 2c0a     spacing=1.0,.
+00029c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029c10: 6477 656c 6c54 696d 653d 7072 6f74 6f63  dwellTime=protoc
+00029c20: 6f6c 2e67 6574 2822 6477 656c 6c5f 7469  ol.get("dwell_ti
+00029c30: 6d65 222c 312e 3065 2d36 292c 0a20 2020  me",1.0e-6),.   
+00029c40: 2020 2020 2020 2020 2020 2020 2070 7265               pre
+00029c50: 7365 743d 4e6f 6e65 2c0a 2020 2020 2020  set=None,.      
+00029c60: 2020 2020 2020 2020 2020 7061 7261 6c6c            parall
+00029c70: 656c 3d46 616c 7365 2c0a 2020 2020 2020  el=False,.      
+00029c80: 2020 2020 2020 2020 2020 6d61 7465 7269            materi
+00029c90: 616c 3d27 4465 6661 756c 7420 4d61 7465  al='Default Mate
+00029ca0: 7269 616c 272c 0a20 2020 2020 2020 2020  rial',.         
+00029cb0: 2020 2020 2020 2067 6973 5072 6563 7572         gisPrecur
+00029cc0: 736f 723d 4e6f 6e65 2c0a 2020 2020 2020  sor=None,.      
+00029cd0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00029ce0: 7365 6c66 2e67 6973 5f6c 6179 6572 203d  self.gis_layer =
+00029cf0: 2073 656c 662e 636f 6e6e 6563 7469 6f6e   self.connection
+00029d00: 2e44 7261 7742 6561 6d2e 4c61 7965 7228  .DrawBeam.Layer(
+00029d10: 224c 6179 6572 5f47 4953 222c 206c 6179  "Layer_GIS", lay
+00029d20: 6572 5365 7474 696e 6773 290a 0a0a 2020  erSettings)...  
+00029d30: 2020 2020 2020 6c6f 6767 696e 672e 696e        logging.in
+00029d40: 666f 2866 2247 4953 2053 6574 7570 2043  fo(f"GIS Setup C
+00029d50: 6f6d 706c 6574 652c 207b 6265 616d 5f74  omplete, {beam_t
+00029d60: 7970 657d 206c 6179 6572 2073 6574 7469  ype} layer setti
+00029d70: 6e67 7320 6c6f 6164 6564 2229 0a0a 2020  ngs loaded")..  
+00029d80: 2020 6465 6620 7365 7475 705f 4749 535f    def setup_GIS_
+00029d90: 7061 7474 6572 6e28 7365 6c66 2c70 726f  pattern(self,pro
+00029da0: 746f 636f 6c29 3a0a 0a20 2020 2020 2020  tocol):..       
+00029db0: 2068 6677 203d 2070 726f 746f 636f 6c5b   hfw = protocol[
+00029dc0: 2268 6677 225d 0a20 2020 2020 2020 206c  "hfw"].        l
+00029dd0: 696e 655f 7061 7474 6572 6e5f 6c65 6e67  ine_pattern_leng
+00029de0: 7468 203d 2070 726f 746f 636f 6c5b 226c  th = protocol["l
+00029df0: 656e 6774 6822 5d0a 0a0a 2020 2020 2020  ength"]...      
+00029e00: 2020 7374 6172 745f 783d 2d6c 696e 655f    start_x=-line_
+00029e10: 7061 7474 6572 6e5f 6c65 6e67 7468 2f32  pattern_length/2
+00029e20: 200a 2020 2020 2020 2020 7374 6172 745f   .        start_
+00029e30: 793d 2b6c 696e 655f 7061 7474 6572 6e5f  y=+line_pattern_
+00029e40: 6c65 6e67 7468 0a20 2020 2020 2020 2065  length.        e
+00029e50: 6e64 5f78 3d2b 6c69 6e65 5f70 6174 7465  nd_x=+line_patte
+00029e60: 726e 5f6c 656e 6774 682f 320a 2020 2020  rn_length/2.    
+00029e70: 2020 2020 656e 645f 793d 2b6c 696e 655f      end_y=+line_
+00029e80: 7061 7474 6572 6e5f 6c65 6e67 7468 0a20  pattern_length. 
+00029e90: 2020 2020 2020 2064 6570 7468 3d32 652d         depth=2e-
+00029ea0: 360a 0a20 2020 2020 2020 2073 656c 662e  6..        self.
+00029eb0: 6769 735f 6c61 7965 722e 6164 644c 696e  gis_layer.addLin
+00029ec0: 6528 0a20 2020 2020 2020 2020 2020 2042  e(.            B
+00029ed0: 6567 696e 583d 7374 6172 745f 782c 0a20  eginX=start_x,. 
+00029ee0: 2020 2020 2020 2020 2020 2042 6567 696e             Begin
+00029ef0: 593d 7374 6172 745f 792c 0a20 2020 2020  Y=start_y,.     
+00029f00: 2020 2020 2020 2045 6e64 583d 656e 645f         EndX=end_
+00029f10: 782c 0a20 2020 2020 2020 2020 2020 2045  x,.            E
+00029f20: 6e64 593d 656e 645f 792c 0a20 2020 2020  ndY=end_y,.     
+00029f30: 2020 2020 2020 2044 6570 7468 3d33 652d         Depth=3e-
+00029f40: 3036 2c0a 0a20 2020 2020 2020 2029 0a0a  06,..        )..
+00029f50: 2020 2020 2020 2020 7365 6c66 2e63 6f6e          self.con
+00029f60: 6e65 6374 696f 6e2e 4472 6177 4265 616d  nection.DrawBeam
+00029f70: 2e4c 6f61 644c 6179 6572 2873 656c 662e  .LoadLayer(self.
+00029f80: 6769 735f 6c61 7965 7229 0a20 2020 2020  gis_layer).     
+00029f90: 2020 206c 6f67 6769 6e67 2e69 6e66 6f28     logging.info(
+00029fa0: 6622 4749 5320 5061 7474 6572 6e20 5365  f"GIS Pattern Se
+00029fb0: 7475 7020 436f 6d70 6c65 7465 2229 0a0a  tup Complete")..
+00029fc0: 2020 2020 6465 6620 7275 6e5f 4749 5328      def run_GIS(
+00029fd0: 7365 6c66 2c70 726f 746f 636f 6c29 202d  self,protocol) -
+00029fe0: 3e20 4e6f 6e65 3a0a 0a0a 2020 2020 2020  > None:...      
+00029ff0: 2020 6761 735f 6c69 6e65 203d 2073 656c    gas_line = sel
+0002a000: 662e 6c69 6e65 735b 7072 6f74 6f63 6f6c  f.lines[protocol
+0002a010: 5b27 6761 7327 5d5d 0a0a 2020 2020 2020  ['gas']]..      
+0002a020: 2020 7472 793a 0a0a 2020 2020 2020 2020    try:..        
+0002a030: 2020 2020 7365 6c66 2e63 6f6e 6e65 6374      self.connect
+0002a040: 696f 6e2e 4749 532e 4f70 656e 5661 6c76  ion.GIS.OpenValv
+0002a050: 6528 6761 735f 6c69 6e65 290a 0a20 2020  e(gas_line)..   
+0002a060: 2020 2020 2065 7863 6570 7420 4578 6365       except Exce
+0002a070: 7074 696f 6e20 6173 2065 3a0a 2020 2020  ption as e:.    
+0002a080: 2020 2020 2020 2020 6966 2065 2e61 7267          if e.arg
+0002a090: 735b 305d 203d 3d20 2745 7272 6f72 2e4f  s[0] == 'Error.O
+0002a0a0: 7574 6761 7352 6571 7569 7265 6427 3a0a  utgasRequired':.
+0002a0b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a0c0: 6c6f 6767 696e 672e 696e 666f 2822 4f75  logging.info("Ou
+0002a0d0: 7467 6173 7369 6e67 2072 6571 7569 7265  tgassing require
+0002a0e0: 642e 2229 0a20 2020 2020 2020 2020 2020  d.").           
+0002a0f0: 2020 2020 206c 6f67 6769 6e67 2e69 6e66       logging.inf
+0002a100: 6f28 6622 4f75 7467 6173 7369 6e67 207b  o(f"Outgassing {
+0002a110: 7072 6f74 6f63 6f6c 5b27 6761 7327 5d7d  protocol['gas']}
+0002a120: 204c 696e 6522 290a 2020 2020 2020 2020   Line").        
+0002a130: 2020 2020 2020 2020 7365 6c66 2e63 6f6e          self.con
+0002a140: 6e65 6374 696f 6e2e 4749 532e 4f75 7467  nection.GIS.Outg
+0002a150: 6173 2867 6173 5f6c 696e 6529 0a20 2020  as(gas_line).   
+0002a160: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+0002a170: 662e 636f 6e6e 6563 7469 6f6e 2e47 4953  f.connection.GIS
+0002a180: 2e4f 7065 6e56 616c 7665 2867 6173 5f6c  .OpenValve(gas_l
+0002a190: 696e 6529 0a0a 2020 2020 2020 2020 7661  ine)..        va
+0002a1a0: 6c76 655f 6f70 656e 203d 2073 656c 662e  lve_open = self.
+0002a1b0: 636f 6e6e 6563 7469 6f6e 2e47 4953 2e47  connection.GIS.G
+0002a1c0: 6574 5661 6c76 6553 7461 7475 7328 6761  etValveStatus(ga
+0002a1d0: 735f 6c69 6e65 290a 0a20 2020 2020 2020  s_line)..       
+0002a1e0: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
+0002a1f0: 2020 2320 5275 6e20 7072 6564 6566 696e    # Run predefin
+0002a200: 6564 2064 6570 6f73 6974 696f 6e20 7072  ed deposition pr
+0002a210: 6f63 6573 730a 2020 2020 2020 2020 2020  ocess.          
+0002a220: 2020 7365 6c66 2e63 6f6e 6e65 6374 696f    self.connectio
+0002a230: 6e2e 4472 6177 4265 616d 2e53 7461 7274  n.DrawBeam.Start
+0002a240: 2829 0a20 2020 2020 2020 2020 2020 2073  ().            s
+0002a250: 656c 662e 636f 6e6e 6563 7469 6f6e 2e50  elf.connection.P
+0002a260: 726f 6772 6573 732e 5368 6f77 2822 4472  rogress.Show("Dr
+0002a270: 6177 4265 616d 222c 2022 4c61 7965 7220  awBeam", "Layer 
+0002a280: 3120 696e 2070 726f 6772 6573 7322 2c20  1 in progress", 
+0002a290: 4661 6c73 652c 2046 616c 7365 2c20 302c  False, False, 0,
+0002a2a0: 2031 3030 290a 2020 2020 2020 2020 2020   100).          
+0002a2b0: 2020 6c6f 6767 696e 672e 696e 666f 2822    logging.info("
+0002a2c0: 5370 7574 7465 7269 6e67 2073 7461 7274  Sputtering start
+0002a2d0: 6564 2e22 290a 2020 2020 2020 2020 2020  ed.").          
+0002a2e0: 2020 7768 696c 6520 5472 7565 3a0a 2020    while True:.  
+0002a2f0: 2020 2020 2020 2020 2020 2020 2020 7374                st
+0002a300: 6174 7573 203d 2073 656c 662e 636f 6e6e  atus = self.conn
+0002a310: 6563 7469 6f6e 2e44 7261 7742 6561 6d2e  ection.DrawBeam.
+0002a320: 4765 7453 7461 7475 7328 290a 2020 2020  GetStatus().    
+0002a330: 2020 2020 2020 2020 2020 2020 7275 6e6e              runn
+0002a340: 696e 6720 3d20 7374 6174 7573 5b30 5d20  ing = status[0] 
+0002a350: 3d3d 2073 656c 662e 636f 6e6e 6563 7469  == self.connecti
+0002a360: 6f6e 2e44 7261 7742 6561 6d2e 5374 6174  on.DrawBeam.Stat
+0002a370: 7573 2e50 726f 6a65 6374 4c6f 6164 6564  us.ProjectLoaded
+0002a380: 4578 706f 7369 7469 6f6e 496e 5072 6f67  ExpositionInProg
+0002a390: 7265 7373 0a20 2020 2020 2020 2020 2020  ress.           
+0002a3a0: 2020 2020 2069 6620 7275 6e6e 696e 673a       if running:
+0002a3b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002a3c0: 2020 2020 2070 726f 6772 6573 7320 3d20       progress = 
+0002a3d0: 300a 2020 2020 2020 2020 2020 2020 2020  0.              
+0002a3e0: 2020 2020 2020 6966 2073 7461 7475 735b        if status[
+0002a3f0: 315d 203e 2030 3a0a 2020 2020 2020 2020  1] > 0:.        
+0002a400: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a410: 7072 6f67 7265 7373 203d 206d 696e 2831  progress = min(1
+0002a420: 3030 2c20 7374 6174 7573 5b32 5d20 2f20  00, status[2] / 
+0002a430: 7374 6174 7573 5b31 5d20 2a20 3130 3029  status[1] * 100)
+0002a440: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002a450: 2020 2020 2070 7269 6e74 5072 6f67 7265       printProgre
+0002a460: 7373 4261 7228 7072 6f67 7265 7373 2c20  ssBar(progress, 
+0002a470: 3130 3029 0a20 2020 2020 2020 2020 2020  100).           
+0002a480: 2020 2020 2020 2020 2073 656c 662e 636f           self.co
+0002a490: 6e6e 6563 7469 6f6e 2e50 726f 6772 6573  nnection.Progres
+0002a4a0: 732e 5365 7450 6572 6365 6e74 7328 7072  s.SetPercents(pr
+0002a4b0: 6f67 7265 7373 290a 2020 2020 2020 2020  ogress).        
+0002a4c0: 2020 2020 2020 2020 2020 2020 7469 6d65              time
+0002a4d0: 2e73 6c65 6570 2831 290a 2020 2020 2020  .sleep(1).      
+0002a4e0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+0002a4f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a500: 2020 2020 6966 2073 7461 7475 735b 305d      if status[0]
+0002a510: 203d 3d20 7365 6c66 2e63 6f6e 6e65 6374   == self.connect
+0002a520: 696f 6e2e 4472 6177 4265 616d 2e53 7461  ion.DrawBeam.Sta
+0002a530: 7475 732e 5072 6f6a 6563 744c 6f61 6465  tus.ProjectLoade
+0002a540: 6445 7870 6f73 6974 696f 6e49 646c 653a  dExpositionIdle:
+0002a550: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002a560: 2020 2020 2020 2020 2070 7269 6e74 5072           printPr
+0002a570: 6f67 7265 7373 4261 7228 3130 302c 2031  ogressBar(100, 1
+0002a580: 3030 2c20 7375 6666 6978 3d27 4669 6e69  00, suffix='Fini
+0002a590: 7368 6564 2729 0a20 2020 2020 2020 2020  shed').         
+0002a5a0: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+0002a5b0: 7269 6e74 2827 2729 0a20 2020 2020 2020  rint('').       
+0002a5c0: 2020 2020 2020 2020 2020 2020 2062 7265               bre
+0002a5d0: 616b 0a20 2020 2020 2020 2066 696e 616c  ak.        final
+0002a5e0: 6c79 3a0a 2020 2020 2020 2020 2020 2020  ly:.            
+0002a5f0: 2320 436c 6f73 6520 4749 5320 5661 6c76  # Close GIS Valv
+0002a600: 6520 696e 2062 6f74 6820 2d20 7375 6363  e in both - succ
+0002a610: 6573 7320 616e 6420 6661 696c 7572 650a  ess and failure.
+0002a620: 2020 2020 2020 2020 2020 2020 6966 2076              if v
+0002a630: 616c 7665 5f6f 7065 6e3a 0a20 2020 2020  alve_open:.     
+0002a640: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0002a650: 636f 6e6e 6563 7469 6f6e 2e47 4953 2e43  connection.GIS.C
+0002a660: 6c6f 7365 5661 6c76 6528 6761 735f 6c69  loseValve(gas_li
+0002a670: 6e65 290a 0a20 2020 2020 2020 2073 656c  ne)..        sel
+0002a680: 662e 636f 6e6e 6563 7469 6f6e 2e47 4953  f.connection.GIS
+0002a690: 2e4d 6f76 6554 6f28 6761 735f 6c69 6e65  .MoveTo(gas_line
+0002a6a0: 2c20 4175 746f 6d61 7469 6f6e 2e47 4953  , Automation.GIS
+0002a6b0: 2e50 6f73 6974 696f 6e2e 486f 6d65 290a  .Position.Home).
+0002a6c0: 2020 2020 2020 2020 2320 7365 6c66 2e63          # self.c
+0002a6d0: 6f6e 6e65 6374 696f 6e2e 4749 532e 5072  onnection.GIS.Pr
+0002a6e0: 6570 6172 6554 656d 7065 7261 7475 7265  epareTemperature
+0002a6f0: 2867 6173 5f6c 696e 652c 2046 616c 7365  (gas_line, False
+0002a700: 290a 2020 2020 2020 2020 7365 6c66 2e63  ).        self.c
+0002a710: 6f6e 6e65 6374 696f 6e2e 4472 6177 4265  onnection.DrawBe
+0002a720: 616d 2e55 6e6c 6f61 644c 6179 6572 2829  am.UnloadLayer()
+0002a730: 0a20 2020 2020 2020 206c 6f67 6769 6e67  .        logging
+0002a740: 2e69 6e66 6f28 2270 726f 6365 7373 2063  .info("process c
+0002a750: 6f6d 706c 6574 6564 2e22 290a 0a0a 2020  ompleted.")...  
+0002a760: 2020 6465 6620 4749 535f 6176 6169 6c61    def GIS_availa
+0002a770: 626c 655f 6c69 6e65 7328 7365 6c66 2920  ble_lines(self) 
+0002a780: 2d3e 206c 6973 745b 7374 725d 3a0a 2020  -> list[str]:.  
+0002a790: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+0002a7a0: 2020 5265 7475 726e 7320 6120 6c69 7374    Returns a list
+0002a7b0: 206f 6620 6176 6169 6c61 626c 6520 4749   of available GI
+0002a7c0: 5320 6c69 6e65 732e 0a20 2020 2020 2020  S lines..       
+0002a7d0: 2041 7267 733a 0a20 2020 2020 2020 2020   Args:.         
+0002a7e0: 2020 204e 6f6e 650a 2020 2020 2020 2020     None.        
+0002a7f0: 5265 7475 726e 733a 0a20 2020 2020 2020  Returns:.       
+0002a800: 2020 2020 2041 2064 6963 7469 6f6e 6172       A dictionar
+0002a810: 7920 6f66 2061 7661 696c 6162 6c65 2047  y of available G
+0002a820: 4953 206c 696e 6573 2e0a 2020 2020 2020  IS lines..      
+0002a830: 2020 2222 220a 2020 2020 2020 2020 5f63    """.        _c
+0002a840: 6865 636b 5f73 7075 7474 6572 2873 656c  heck_sputter(sel
+0002a850: 662e 6861 7264 7761 7265 5f73 6574 7469  f.hardware_setti
+0002a860: 6e67 7329 0a20 2020 2020 2020 2047 4953  ngs).        GIS
+0002a870: 5f6c 696e 6573 203d 2073 656c 662e 636f  _lines = self.co
+0002a880: 6e6e 6563 7469 6f6e 2e47 4953 2e45 6e75  nnection.GIS.Enu
+0002a890: 6d28 290a 2020 2020 2020 2020 7365 6c66  m().        self
+0002a8a0: 2e6c 696e 6573 203d 207b 7d0a 2020 2020  .lines = {}.    
+0002a8b0: 2020 2020 6c69 6e65 5f6e 616d 6573 203d      line_names =
+0002a8c0: 205b 5d0a 2020 2020 2020 2020 666f 7220   [].        for 
+0002a8d0: 6c69 6e65 2069 6e20 4749 535f 6c69 6e65  line in GIS_line
+0002a8e0: 733a 0a20 2020 2020 2020 2020 2020 2073  s:.            s
+0002a8f0: 656c 662e 6c69 6e65 735b 6c69 6e65 2e6e  elf.lines[line.n
+0002a900: 616d 655d 203d 206c 696e 650a 2020 2020  ame] = line.    
+0002a910: 2020 2020 2020 2020 6c69 6e65 5f6e 616d          line_nam
+0002a920: 6573 2e61 7070 656e 6428 6c69 6e65 2e6e  es.append(line.n
+0002a930: 616d 6529 0a0a 2020 2020 2020 2020 7265  ame)..        re
+0002a940: 7475 726e 206c 696e 655f 6e61 6d65 730a  turn line_names.
+0002a950: 0a20 2020 2064 6566 2047 4953 5f70 6f73  .    def GIS_pos
+0002a960: 6974 696f 6e28 7365 6c66 2c6c 696e 655f  ition(self,line_
+0002a970: 6e61 6d65 3a73 7472 2920 2d3e 2073 7472  name:str) -> str
+0002a980: 3a0a 2020 2020 2020 2020 5f63 6865 636b  :.        _check
+0002a990: 5f73 7075 7474 6572 2873 656c 662e 6861  _sputter(self.ha
+0002a9a0: 7264 7761 7265 5f73 6574 7469 6e67 7329  rdware_settings)
+0002a9b0: 0a0a 2020 2020 2020 2020 6c69 6e65 203d  ..        line =
+0002a9c0: 2073 656c 662e 6c69 6e65 735b 6c69 6e65   self.lines[line
+0002a9d0: 5f6e 616d 655d 0a0a 2020 2020 2020 2020  _name]..        
+0002a9e0: 706f 7369 7469 6f6e 203d 2073 656c 662e  position = self.
+0002a9f0: 636f 6e6e 6563 7469 6f6e 2e47 4953 2e47  connection.GIS.G
+0002aa00: 6574 506f 7369 7469 6f6e 286c 696e 6529  etPosition(line)
+0002aa10: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
+0002aa20: 2070 6f73 6974 696f 6e2e 6e61 6d65 0a0a   position.name..
+0002aa30: 2020 2020 6465 6620 4749 535f 6176 6169      def GIS_avai
+0002aa40: 6c61 626c 655f 706f 7369 7469 6f6e 7328  lable_positions(
+0002aa50: 7365 6c66 2920 2d3e 206c 6973 745b 7374  self) -> list[st
+0002aa60: 725d 3a0a 0a20 2020 2020 2020 205f 6368  r]:..        _ch
+0002aa70: 6563 6b5f 7370 7574 7465 7228 7365 6c66  eck_sputter(self
+0002aa80: 2e68 6172 6477 6172 655f 7365 7474 696e  .hardware_settin
+0002aa90: 6773 290a 2020 2020 2020 2020 7365 6c66  gs).        self
+0002aaa0: 2e47 4953 5f70 6f73 6974 696f 6e73 203d  .GIS_positions =
+0002aab0: 2073 656c 662e 636f 6e6e 6563 7469 6f6e   self.connection
+0002aac0: 2e47 4953 2e50 6f73 6974 696f 6e0a 0a20  .GIS.Position.. 
+0002aad0: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
+0002aae0: 6c66 2e47 4953 5f70 6f73 6974 696f 6e73  lf.GIS_positions
+0002aaf0: 2e5f 5f6d 656d 6265 7273 5f5f 2e6b 6579  .__members__.key
+0002ab00: 7328 290a 0a20 2020 2064 6566 2047 4953  s()..    def GIS
+0002ab10: 5f6d 6f76 655f 746f 2873 656c 662c 6c69  _move_to(self,li
+0002ab20: 6e65 5f6e 616d 652c 706f 7369 7469 6f6e  ne_name,position
+0002ab30: 2920 2d3e 204e 6f6e 653a 0a0a 2020 2020  ) -> None:..    
+0002ab40: 2020 2020 5f63 6865 636b 5f73 7075 7474      _check_sputt
+0002ab50: 6572 2873 656c 662e 6861 7264 7761 7265  er(self.hardware
+0002ab60: 5f73 6574 7469 6e67 7329 0a0a 2020 2020  _settings)..    
+0002ab70: 2020 2020 6c69 6e65 203d 2073 656c 662e      line = self.
+0002ab80: 6c69 6e65 735b 6c69 6e65 5f6e 616d 655d  lines[line_name]
+0002ab90: 0a0a 2020 2020 2020 2020 7365 6c66 2e63  ..        self.c
+0002aba0: 6f6e 6e65 6374 696f 6e2e 4749 532e 4d6f  onnection.GIS.Mo
+0002abb0: 7665 546f 286c 696e 652c 7365 6c66 2e47  veTo(line,self.G
+0002abc0: 4953 5f70 6f73 6974 696f 6e73 5b70 6f73  IS_positions[pos
+0002abd0: 6974 696f 6e5d 290a 0a20 2020 2064 6566  ition])..    def
+0002abe0: 2047 4953 5f68 6561 745f 7570 2873 656c   GIS_heat_up(sel
+0002abf0: 662c 6c69 6e65 5f6e 616d 6529 3a0a 0a20  f,line_name):.. 
+0002ac00: 2020 2020 2020 205f 6368 6563 6b5f 7370         _check_sp
+0002ac10: 7574 7465 7228 7365 6c66 2e68 6172 6477  utter(self.hardw
+0002ac20: 6172 655f 7365 7474 696e 6773 290a 0a20  are_settings).. 
+0002ac30: 2020 2020 2020 206c 696e 6520 3d20 7365         line = se
+0002ac40: 6c66 2e6c 696e 6573 5b6c 696e 655f 6e61  lf.lines[line_na
+0002ac50: 6d65 5d0a 0a20 2020 2020 2020 2073 656c  me]..        sel
+0002ac60: 662e 636f 6e6e 6563 7469 6f6e 2e47 4953  f.connection.GIS
+0002ac70: 2e50 7265 7061 7265 5465 6d70 6572 6174  .PrepareTemperat
+0002ac80: 7572 6528 6c69 6e65 2c54 7275 6529 0a0a  ure(line,True)..
+0002ac90: 2020 2020 2020 2020 7365 6c66 2e63 6f6e          self.con
+0002aca0: 6e65 6374 696f 6e2e 4749 532e 5761 6974  nection.GIS.Wait
+0002acb0: 466f 7254 656d 7065 7261 7475 7265 5265  ForTemperatureRe
+0002acc0: 6164 7928 6c69 6e65 290a 0a20 2020 2020  ady(line)..     
+0002acd0: 2020 2074 696d 652e 736c 6565 7028 3529     time.sleep(5)
+0002ace0: 0a0a 2020 2020 6465 6620 4749 535f 7465  ..    def GIS_te
+0002acf0: 6d70 5f72 6561 6479 2873 656c 662c 6c69  mp_ready(self,li
+0002ad00: 6e65 5f6e 616d 6529 3a0a 0a20 2020 2020  ne_name):..     
+0002ad10: 2020 205f 6368 6563 6b5f 7370 7574 7465     _check_sputte
+0002ad20: 7228 7365 6c66 2e68 6172 6477 6172 655f  r(self.hardware_
+0002ad30: 7365 7474 696e 6773 290a 0a20 2020 2020  settings)..     
+0002ad40: 2020 206c 696e 6520 3d20 7365 6c66 2e6c     line = self.l
+0002ad50: 696e 6573 5b6c 696e 655f 6e61 6d65 5d0a  ines[line_name].
+0002ad60: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0002ad70: 7365 6c66 2e63 6f6e 6e65 6374 696f 6e2e  self.connection.
+0002ad80: 4749 532e 4765 7454 656d 7065 7261 7475  GIS.GetTemperatu
+0002ad90: 7265 5265 6164 7928 6c69 6e65 290a 0a20  reReady(line).. 
+0002ada0: 2020 2064 6566 2073 6574 5f6d 6963 726f     def set_micro
+0002adb0: 7363 6f70 655f 7374 6174 6528 7365 6c66  scope_state(self
+0002adc0: 2c20 6d69 6372 6f73 636f 7065 5f73 7461  , microscope_sta
+0002add0: 7465 3a20 4d69 6372 6f73 636f 7065 5374  te: MicroscopeSt
+0002ade0: 6174 6529 3a0a 2020 2020 2020 2020 2222  ate):.        ""
+0002adf0: 2252 6573 6574 2074 6865 206d 6963 726f  "Reset the micro
+0002ae00: 7363 6f70 6520 7374 6174 6520 746f 2074  scope state to t
+0002ae10: 6865 2070 726f 7669 6465 6420 7374 6174  he provided stat
+0002ae20: 652e 0a0a 2020 2020 2020 2020 4172 6773  e...        Args
+0002ae30: 3a0a 2020 2020 2020 2020 2020 2020 6d69  :.            mi
+0002ae40: 6372 6f73 636f 7065 5f73 7461 7465 2028  croscope_state (
+0002ae50: 4d69 6372 6f73 636f 7065 5374 6174 6529  MicroscopeState)
+0002ae60: 3a20 4120 604d 6963 726f 7363 6f70 6553  : A `MicroscopeS
+0002ae70: 7461 7465 6020 6f62 6a65 6374 2074 6861  tate` object tha
+0002ae80: 7420 636f 6e74 6169 6e73 2074 6865 2064  t contains the d
+0002ae90: 6573 6972 6564 2073 7461 7465 206f 6620  esired state of 
+0002aea0: 7468 6520 6d69 6372 6f73 636f 7065 2e0a  the microscope..
+0002aeb0: 0a20 2020 2020 2020 2052 6574 7572 6e73  .        Returns
+0002aec0: 3a0a 2020 2020 2020 2020 2020 2020 4e6f  :.            No
+0002aed0: 6e65 2e0a 0a20 2020 2020 2020 2052 6169  ne...        Rai
+0002aee0: 7365 733a 0a20 2020 2020 2020 2020 2020  ses:.           
+0002aef0: 204e 6f6e 652e 0a0a 2020 2020 2020 2020   None...        
+0002af00: 4e6f 7465 733a 0a20 2020 2020 2020 2020  Notes:.         
+0002af10: 2020 2054 6869 7320 6675 6e63 7469 6f6e     This function
+0002af20: 2072 6573 746f 7265 7320 7468 6520 6d69   restores the mi
+0002af30: 6372 6f73 636f 7065 2073 7461 7465 2074  croscope state t
+0002af40: 6f20 7468 6520 7072 6f76 6964 6564 2073  o the provided s
+0002af50: 7461 7465 2e20 5468 6973 2066 756e 6374  tate. This funct
+0002af60: 696f 6e20 6361 6e6e 6f74 2062 6520 6675  ion cannot be fu
+0002af70: 6c6c 7920 696d 706c 656d 656e 7465 6420  lly implemented 
+0002af80: 6173 2074 6865 6972 2061 7265 2063 6572  as their are cer
+0002af90: 7461 696e 2061 7370 6563 7473 206f 660a  tain aspects of.
+0002afa0: 2020 2020 2020 2020 2020 2020 7468 6520              the 
+0002afb0: 7374 6174 6520 7468 6174 2063 616e 6e6f  state that canno
+0002afc0: 7420 6265 2073 6574 2066 6f72 2074 6865  t be set for the
+0002afd0: 2054 4553 4341 4e20 6d69 6372 6f73 636f   TESCAN microsco
+0002afe0: 7065 2062 7920 7468 6520 5445 5343 414e  pe by the TESCAN
+0002aff0: 2041 7574 6f6d 6174 696f 6e20 4150 492e   Automation API.
+0002b000: 0a20 2020 2020 2020 2022 2222 0a0a 2020  .        """..  
+0002b010: 2020 2020 2020 6c6f 6767 696e 672e 696e        logging.in
+0002b020: 666f 2866 2272 6573 746f 7269 6e67 206d  fo(f"restoring m
+0002b030: 6963 726f 7363 6f70 6520 7374 6174 652e  icroscope state.
+0002b040: 2e2e 2229 0a0a 2020 2020 2020 2020 2320  ..")..        # 
+0002b050: 6d6f 7665 2074 6f20 706f 7369 7469 6f6e  move to position
+0002b060: 0a20 2020 2020 2020 2023 205f 6368 6563  .        # _chec
+0002b070: 6b5f 7374 6167 6528 7365 6c66 2e68 6172  k_stage(self.har
+0002b080: 6477 6172 655f 7365 7474 696e 6773 290a  dware_settings).
+0002b090: 2020 2020 2020 2020 2320 7365 6c66 2e6d          # self.m
+0002b0a0: 6f76 655f 7374 6167 655f 6162 736f 6c75  ove_stage_absolu
+0002b0b0: 7465 2870 6f73 6974 696f 6e3d 6d69 6372  te(position=micr
+0002b0c0: 6f73 636f 7065 5f73 7461 7465 2e61 6273  oscope_state.abs
+0002b0d0: 6f6c 7574 655f 706f 7369 7469 6f6e 290a  olute_position).
+0002b0e0: 0a20 2020 2020 2020 2023 2072 6573 746f  .        # resto
+0002b0f0: 7265 2065 6c65 6374 726f 6e20 6265 616d  re electron beam
+0002b100: 0a20 2020 2020 2020 205f 6368 6563 6b5f  .        _check_
+0002b110: 6265 616d 2842 6561 6d54 7970 652e 454c  beam(BeamType.EL
+0002b120: 4543 5452 4f4e 2c20 7365 6c66 2e68 6172  ECTRON, self.har
+0002b130: 6477 6172 655f 7365 7474 696e 6773 290a  dware_settings).
+0002b140: 2020 2020 2020 2020 6c6f 6767 696e 672e          logging.
+0002b150: 696e 666f 2866 2272 6573 746f 7269 6e67  info(f"restoring
+0002b160: 2065 6c65 6374 726f 6e20 6265 616d 2073   electron beam s
+0002b170: 6574 7469 6e67 732e 2e2e 2229 0a20 2020  ettings...").   
+0002b180: 2020 2020 2073 656c 662e 636f 6e6e 6563       self.connec
+0002b190: 7469 6f6e 2e53 454d 2e4f 7074 6963 732e  tion.SEM.Optics.
+0002b1a0: 5365 7457 4428 0a20 2020 2020 2020 2020  SetWD(.         
+0002b1b0: 2020 206d 6963 726f 7363 6f70 655f 7374     microscope_st
+0002b1c0: 6174 652e 6562 5f73 6574 7469 6e67 732e  ate.eb_settings.
+0002b1d0: 776f 726b 696e 675f 6469 7374 616e 6365  working_distance
+0002b1e0: 0a20 2020 2020 2020 2020 2020 202a 2063  .            * c
+0002b1f0: 6f6e 7374 616e 7473 2e4d 4554 5245 5f54  onstants.METRE_T
+0002b200: 4f5f 4d49 4c4c 494d 4554 5245 0a20 2020  O_MILLIMETRE.   
+0002b210: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
+0002b220: 7365 6c66 2e63 6f6e 6e65 6374 696f 6e2e  self.connection.
+0002b230: 5345 4d2e 4265 616d 2e53 6574 4375 7272  SEM.Beam.SetCurr
+0002b240: 656e 7428 0a20 2020 2020 2020 2020 2020  ent(.           
+0002b250: 206d 6963 726f 7363 6f70 655f 7374 6174   microscope_stat
+0002b260: 652e 6562 5f73 6574 7469 6e67 732e 6265  e.eb_settings.be
+0002b270: 616d 5f63 7572 7265 6e74 202a 2063 6f6e  am_current * con
+0002b280: 7374 616e 7473 2e53 495f 544f 5f50 4943  stants.SI_TO_PIC
+0002b290: 4f0a 2020 2020 2020 2020 290a 0a20 2020  O.        )..   
+0002b2a0: 2020 2020 2073 656c 662e 636f 6e6e 6563       self.connec
+0002b2b0: 7469 6f6e 2e53 454d 2e4f 7074 6963 732e  tion.SEM.Optics.
+0002b2c0: 5365 7456 6965 7766 6965 6c64 280a 2020  SetViewfield(.  
+0002b2d0: 2020 2020 2020 2020 2020 6d69 6372 6f73            micros
+0002b2e0: 636f 7065 5f73 7461 7465 2e65 625f 7365  cope_state.eb_se
+0002b2f0: 7474 696e 6773 2e68 6677 202a 2063 6f6e  ttings.hfw * con
+0002b300: 7374 616e 7473 2e4d 4554 5245 5f54 4f5f  stants.METRE_TO_
+0002b310: 4d49 4c4c 494d 4554 5245 0a20 2020 2020  MILLIMETRE.     
+0002b320: 2020 2029 0a0a 2020 2020 2020 2020 7365     )..        se
+0002b330: 6c66 2e63 6f6e 6e65 6374 696f 6e2e 5345  lf.connection.SE
+0002b340: 4d2e 4f70 7469 6373 2e53 6574 496d 6167  M.Optics.SetImag
+0002b350: 6553 6869 6674 286d 6963 726f 7363 6f70  eShift(microscop
+0002b360: 655f 7374 6174 652e 6562 5f73 6574 7469  e_state.eb_setti
+0002b370: 6e67 732e 7368 6966 742e 782c 206d 6963  ngs.shift.x, mic
+0002b380: 726f 7363 6f70 655f 7374 6174 652e 6562  roscope_state.eb
+0002b390: 5f73 6574 7469 6e67 732e 7368 6966 742e  _settings.shift.
+0002b3a0: 7929 0a20 2020 2020 2020 2073 656c 662e  y).        self.
+0002b3b0: 636f 6e6e 6563 7469 6f6e 2e53 454d 2e4f  connection.SEM.O
+0002b3c0: 7074 6963 732e 5365 7449 6d61 6765 526f  ptics.SetImageRo
+0002b3d0: 7461 7469 6f6e 286d 6963 726f 7363 6f70  tation(microscop
+0002b3e0: 655f 7374 6174 652e 6562 5f73 6574 7469  e_state.eb_setti
+0002b3f0: 6e67 732e 7363 616e 5f72 6f74 6174 696f  ngs.scan_rotatio
+0002b400: 6e29 0a20 2020 2020 2020 2023 206d 6963  n).        # mic
+0002b410: 726f 7363 6f70 652e 6265 616d 732e 656c  roscope.beams.el
+0002b420: 6563 7472 6f6e 5f62 6561 6d2e 7374 6967  ectron_beam.stig
+0002b430: 6d61 746f 722e 7661 6c75 6520 3d20 280a  mator.value = (.
+0002b440: 2020 2020 2020 2020 2320 2020 2020 6d69          #     mi
+0002b450: 6372 6f73 636f 7065 5f73 7461 7465 2e65  croscope_state.e
+0002b460: 625f 7365 7474 696e 6773 2e73 7469 676d  b_settings.stigm
+0002b470: 6174 696f 6e0a 2020 2020 2020 2020 2320  ation.        # 
+0002b480: 290a 0a20 2020 2020 2020 2023 2072 6573  )..        # res
+0002b490: 746f 7265 2069 6f6e 2062 6561 6d0a 2020  tore ion beam.  
+0002b4a0: 2020 2020 2020 5f63 6865 636b 5f62 6561        _check_bea
+0002b4b0: 6d28 4265 616d 5479 7065 2e49 4f4e 2c20  m(BeamType.ION, 
+0002b4c0: 7365 6c66 2e68 6172 6477 6172 655f 7365  self.hardware_se
+0002b4d0: 7474 696e 6773 290a 2020 2020 2020 2020  ttings).        
+0002b4e0: 6c6f 6767 696e 672e 696e 666f 2866 2272  logging.info(f"r
+0002b4f0: 6573 746f 7269 6e67 2069 6f6e 2062 6561  estoring ion bea
+0002b500: 6d20 7365 7474 696e 6773 2e2e 2e22 290a  m settings...").
+0002b510: 0a20 2020 2020 2020 2073 656c 662e 636f  .        self.co
+0002b520: 6e6e 6563 7469 6f6e 2e46 4942 2e4f 7074  nnection.FIB.Opt
+0002b530: 6963 732e 5365 7456 6965 7766 6965 6c64  ics.SetViewfield
+0002b540: 280a 2020 2020 2020 2020 2020 2020 6d69  (.            mi
+0002b550: 6372 6f73 636f 7065 5f73 7461 7465 2e69  croscope_state.i
+0002b560: 625f 7365 7474 696e 6773 2e68 6677 202a  b_settings.hfw *
+0002b570: 2063 6f6e 7374 616e 7473 2e4d 4554 5245   constants.METRE
+0002b580: 5f54 4f5f 4d49 4c4c 494d 4554 5245 0a20  _TO_MILLIMETRE. 
+0002b590: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+0002b5a0: 2073 656c 662e 636f 6e6e 6563 7469 6f6e   self.connection
+0002b5b0: 2e46 4942 2e4f 7074 6963 732e 5365 7449  .FIB.Optics.SetI
+0002b5c0: 6d61 6765 5368 6966 7428 6d69 6372 6f73  mageShift(micros
+0002b5d0: 636f 7065 5f73 7461 7465 2e65 625f 7365  cope_state.eb_se
+0002b5e0: 7474 696e 6773 2e73 6869 6674 2e78 2c20  ttings.shift.x, 
+0002b5f0: 6d69 6372 6f73 636f 7065 5f73 7461 7465  microscope_state
+0002b600: 2e65 625f 7365 7474 696e 6773 2e73 6869  .eb_settings.shi
+0002b610: 6674 2e79 290a 2020 2020 2020 2020 7365  ft.y).        se
+0002b620: 6c66 2e63 6f6e 6e65 6374 696f 6e2e 4649  lf.connection.FI
+0002b630: 422e 4f70 7469 6373 2e53 6574 496d 6167  B.Optics.SetImag
+0002b640: 6552 6f74 6174 696f 6e28 6d69 6372 6f73  eRotation(micros
+0002b650: 636f 7065 5f73 7461 7465 2e65 625f 7365  cope_state.eb_se
+0002b660: 7474 696e 6773 2e73 6361 6e5f 726f 7461  ttings.scan_rota
+0002b670: 7469 6f6e 290a 2020 2020 2020 2020 7469  tion).        ti
+0002b680: 6d65 2e73 6c65 6570 2833 290a 2020 2020  me.sleep(3).    
+0002b690: 2020 2020 2320 6d69 6372 6f73 636f 7065      # microscope
+0002b6a0: 2e62 6561 6d73 2e69 6f6e 5f62 6561 6d2e  .beams.ion_beam.
+0002b6b0: 7374 6967 6d61 746f 722e 7661 6c75 6520  stigmator.value 
+0002b6c0: 3d20 6d69 6372 6f73 636f 7065 5f73 7461  = microscope_sta
+0002b6d0: 7465 2e69 625f 7365 7474 696e 6773 2e73  te.ib_settings.s
+0002b6e0: 7469 676d 6174 696f 6e0a 2020 2020 2020  tigmation.      
+0002b6f0: 2020 7365 6c66 2e6d 6f76 655f 7374 6167    self.move_stag
+0002b700: 655f 6162 736f 6c75 7465 286d 6963 726f  e_absolute(micro
+0002b710: 7363 6f70 655f 7374 6174 652e 6162 736f  scope_state.abso
+0002b720: 6c75 7465 5f70 6f73 6974 696f 6e29 0a20  lute_position). 
+0002b730: 2020 2020 2020 206c 6f67 6769 6e67 2e69         logging.i
+0002b740: 6e66 6f28 6622 6d69 6372 6f73 636f 7065  nfo(f"microscope
+0002b750: 2073 7461 7465 2072 6573 746f 7265 6422   state restored"
+0002b760: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
+0002b770: 0a0a 2020 2020 6465 6620 6765 745f 6176  ..    def get_av
+0002b780: 6169 6c61 626c 655f 7661 6c75 6573 2873  ailable_values(s
+0002b790: 656c 662c 206b 6579 3a20 7374 722c 2062  elf, key: str, b
+0002b7a0: 6561 6d5f 7479 7065 3a20 4265 616d 5479  eam_type: BeamTy
+0002b7b0: 7065 203d 204e 6f6e 6529 2d3e 206c 6973  pe = None)-> lis
+0002b7c0: 743a 0a20 2020 2020 2020 2022 2222 4765  t:.        """Ge
+0002b7d0: 7420 6120 6c69 7374 206f 6620 6176 6169  t a list of avai
+0002b7e0: 6c61 626c 6520 7661 6c75 6573 2066 6f72  lable values for
+0002b7f0: 2061 2067 6976 656e 206b 6579 2e0a 2020   a given key..  
+0002b800: 2020 2020 2020 4b65 7973 3a20 706c 6173        Keys: plas
+0002b810: 6d61 5f67 6173 2c20 6375 7272 656e 742c  ma_gas, current,
+0002b820: 2064 6574 6563 746f 725f 7479 7065 0a20   detector_type. 
+0002b830: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+0002b840: 2020 2076 616c 7565 7320 3d20 5b5d 0a20     values = []. 
+0002b850: 2020 2020 2020 2069 6620 6265 616d 5f74         if beam_t
+0002b860: 7970 6520 6973 2042 6561 6d54 7970 652e  ype is BeamType.
+0002b870: 494f 4e3a 0a20 2020 2020 2020 2020 2020  ION:.           
+0002b880: 2069 6620 6b65 7920 3d3d 2022 706c 6173   if key == "plas
+0002b890: 6d61 5f67 6173 223a 0a20 2020 2020 2020  ma_gas":.       
+0002b8a0: 2020 2020 2020 2020 2076 616c 7565 7320           values 
+0002b8b0: 3d20 7365 6c66 2e63 6f6e 6e65 6374 696f  = self.connectio
+0002b8c0: 6e2e 4749 532e 456e 756d 2829 0a0a 2020  n.GIS.Enum()..  
+0002b8d0: 2020 2020 2020 6966 206b 6579 203d 3d20        if key == 
+0002b8e0: 2263 7572 7265 6e74 223a 0a20 2020 2020  "current":.     
+0002b8f0: 2020 2020 2020 2069 6620 6265 616d 5f74         if beam_t
+0002b900: 7970 6520 3d3d 2042 6561 6d54 7970 652e  ype == BeamType.
+0002b910: 454c 4543 5452 4f4e 3a0a 2020 2020 2020  ELECTRON:.      
+0002b920: 2020 2020 2020 2020 2020 7661 6c75 6573            values
+0002b930: 203d 205b 312e 3065 2d31 325d 0a20 2020   = [1.0e-12].   
+0002b940: 2020 2020 2020 2020 2069 6620 6265 616d           if beam
+0002b950: 5f74 7970 6520 3d3d 2042 6561 6d54 7970  _type == BeamTyp
+0002b960: 652e 494f 4e3a 0a20 2020 2020 2020 2020  e.ION:.         
+0002b970: 2020 2020 2020 2076 616c 7565 7320 3d20         values = 
+0002b980: 5b32 3065 2d31 322c 2036 3065 2d31 322c  [20e-12, 60e-12,
+0002b990: 2030 2e32 652d 392c 2030 2e37 3465 2d39   0.2e-9, 0.74e-9
+0002b9a0: 2c20 322e 3065 2d39 2c20 372e 3665 2d39  , 2.0e-9, 7.6e-9
+0002b9b0: 2c20 3238 2e30 652d 392c 2031 3230 652d  , 28.0e-9, 120e-
+0002b9c0: 395d 0a0a 2020 2020 2020 2020 6966 206b  9]..        if k
+0002b9d0: 6579 203d 3d20 2264 6574 6563 746f 725f  ey == "detector_
+0002b9e0: 7479 7065 2220 616e 6420 6265 616d 5f74  type" and beam_t
+0002b9f0: 7970 6520 3d3d 2042 6561 6d54 7970 652e  ype == BeamType.
+0002ba00: 454c 4543 5452 4f4e 3a0a 2020 2020 2020  ELECTRON:.      
+0002ba10: 2020 2020 2020 7661 6c75 6573 203d 2073        values = s
+0002ba20: 656c 662e 636f 6e6e 6563 7469 6f6e 2e53  elf.connection.S
+0002ba30: 454d 2e44 6574 6563 746f 722e 456e 756d  EM.Detector.Enum
+0002ba40: 2829 0a20 2020 2020 2020 2020 2020 2066  ().            f
+0002ba50: 6f72 2069 2069 6e20 7261 6e67 6528 6c65  or i in range(le
+0002ba60: 6e28 7661 6c75 6573 2929 3a0a 2020 2020  n(values)):.    
+0002ba70: 2020 2020 2020 2020 2020 2020 7661 6c75              valu
+0002ba80: 6573 5b69 2d31 5d20 3d20 7661 6c75 6573  es[i-1] = values
+0002ba90: 5b69 2d31 5d2e 6e61 6d65 200a 2020 2020  [i-1].name .    
+0002baa0: 2020 2020 6966 206b 6579 203d 3d20 2264      if key == "d
+0002bab0: 6574 6563 746f 725f 7479 7065 2220 616e  etector_type" an
+0002bac0: 6420 6265 616d 5f74 7970 6520 3d3d 2042  d beam_type == B
+0002bad0: 6561 6d54 7970 652e 494f 4e3a 0a20 2020  eamType.ION:.   
+0002bae0: 2020 2020 2020 2020 2076 616c 7565 7320           values 
+0002baf0: 3d20 7365 6c66 2e63 6f6e 6e65 6374 696f  = self.connectio
+0002bb00: 6e2e 4649 422e 4465 7465 6374 6f72 2e45  n.FIB.Detector.E
+0002bb10: 6e75 6d28 290a 2020 2020 2020 2020 2020  num().          
+0002bb20: 2020 666f 7220 6920 696e 2072 616e 6765    for i in range
+0002bb30: 286c 656e 2876 616c 7565 7329 293a 0a20  (len(values)):. 
+0002bb40: 2020 2020 2020 2020 2020 2020 2020 2076                 v
+0002bb50: 616c 7565 735b 692d 315d 203d 2076 616c  alues[i-1] = val
+0002bb60: 7565 735b 692d 315d 2e6e 616d 650a 2020  ues[i-1].name.  
+0002bb70: 2020 2020 2020 0a20 2020 2020 2020 2069        .        i
+0002bb80: 6620 6b65 7920 3d3d 2022 6465 7465 6374  f key == "detect
+0002bb90: 6f72 5f6d 6f64 6522 3a20 0a20 2020 2020  or_mode": .     
+0002bba0: 2020 2020 2020 2076 616c 7565 7320 3d20         values = 
+0002bbb0: 4e6f 6e65 200a 0a20 2020 2020 2020 2069  None ..        i
+0002bbc0: 6620 6b65 7920 3d3d 2022 7072 6573 6574  f key == "preset
+0002bbd0: 7322 3a0a 2020 2020 2020 2020 2020 2020  s":.            
+0002bbe0: 7265 7475 726e 2073 656c 662e 5f67 6574  return self._get
+0002bbf0: 5f70 7265 7365 7473 2829 0a0a 2020 2020  _presets()..    
+0002bc00: 2020 2020 6966 206b 6579 203d 3d20 2273      if key == "s
+0002bc10: 6361 6e5f 6469 7265 6374 696f 6e22 3a0a  can_direction":.
+0002bc20: 2020 2020 2020 2020 2020 2020 7661 6c75              valu
+0002bc30: 6573 203d 205b 2246 6c79 6261 636b 222c  es = ["Flyback",
+0002bc40: 2022 524c 4522 2c20 2253 7069 7261 6c49   "RLE", "SpiralI
+0002bc50: 6e73 6964 654f 7574 222c 2022 5370 6972  nsideOut", "Spir
+0002bc60: 616c 4f75 7473 6964 6549 6e22 2c20 225a  alOutsideIn", "Z
+0002bc70: 6967 5a61 6722 5d0a 2020 2020 2020 2020  igZag"].        
+0002bc80: 2020 2020 0a0a 2020 2020 2020 2020 7265      ..        re
+0002bc90: 7475 726e 2076 616c 7565 730a 0a20 2020  turn values..   
+0002bca0: 2064 6566 2067 6574 5f62 6561 6d5f 7365   def get_beam_se
+0002bcb0: 7474 696e 6773 2873 656c 662c 2062 6561  ttings(self, bea
+0002bcc0: 6d5f 7479 7065 3a20 4265 616d 5479 7065  m_type: BeamType
+0002bcd0: 203d 2042 6561 6d54 7970 652e 454c 4543   = BeamType.ELEC
+0002bce0: 5452 4f4e 2920 2d3e 2042 6561 6d53 6574  TRON) -> BeamSet
+0002bcf0: 7469 6e67 733a 0a20 2020 2020 2020 2022  tings:.        "
+0002bd00: 2222 4765 7420 7468 6520 6375 7272 656e  ""Get the curren
+0002bd10: 7420 6265 616d 2073 6574 7469 6e67 7320  t beam settings 
+0002bd20: 666f 7220 7468 6520 6d69 6372 6f73 636f  for the microsco
+0002bd30: 7065 2e0a 0a20 2020 2020 2020 2022 2222  pe...        """
+0002bd40: 0a20 2020 2020 2020 2062 6561 6d5f 7365  .        beam_se
+0002bd50: 7474 696e 6773 203d 2042 6561 6d53 6574  ttings = BeamSet
+0002bd60: 7469 6e67 7328 0a20 2020 2020 2020 2020  tings(.         
+0002bd70: 2020 2062 6561 6d5f 7479 7065 3d62 6561     beam_type=bea
+0002bd80: 6d5f 7479 7065 2c0a 2020 2020 2020 2020  m_type,.        
+0002bd90: 2020 2020 6265 616d 5f63 7572 7265 6e74      beam_current
+0002bda0: 3d73 656c 662e 6765 7428 2263 7572 7265  =self.get("curre
+0002bdb0: 6e74 222c 2062 6561 6d5f 7479 7065 292c  nt", beam_type),
+0002bdc0: 0a20 2020 2020 2020 2020 2020 2077 6f72  .            wor
+0002bdd0: 6b69 6e67 5f64 6973 7461 6e63 653d 7365  king_distance=se
+0002bde0: 6c66 2e67 6574 2822 776f 726b 696e 675f  lf.get("working_
+0002bdf0: 6469 7374 616e 6365 222c 2062 6561 6d5f  distance", beam_
+0002be00: 7479 7065 292c 0a20 2020 2020 2020 2020  type),.         
+0002be10: 2020 2068 6677 3d73 656c 662e 6765 7428     hfw=self.get(
+0002be20: 2268 6677 222c 2062 6561 6d5f 7479 7065  "hfw", beam_type
+0002be30: 292c 0a20 2020 2020 2020 2020 2020 2073  ),.            s
+0002be40: 7469 676d 6174 696f 6e3d 7365 6c66 2e67  tigmation=self.g
+0002be50: 6574 2822 7374 6967 6d61 7469 6f6e 222c  et("stigmation",
+0002be60: 2062 6561 6d5f 7479 7065 292c 0a20 2020   beam_type),.   
+0002be70: 2020 2020 2020 2020 2073 6869 6674 3d73           shift=s
+0002be80: 656c 662e 6765 7428 2273 6869 6674 222c  elf.get("shift",
+0002be90: 2062 6561 6d5f 7479 7065 292c 0a20 2020   beam_type),.   
+0002bea0: 2020 2020 2020 2020 2072 6573 6f6c 7574           resolut
+0002beb0: 696f 6e3d 7365 6c66 2e6c 6173 745f 696d  ion=self.last_im
+0002bec0: 6167 6528 6265 616d 5f74 7970 6529 2e6d  age(beam_type).m
+0002bed0: 6574 6164 6174 612e 696d 6167 655f 7365  etadata.image_se
+0002bee0: 7474 696e 6773 2e72 6573 6f6c 7574 696f  ttings.resolutio
+0002bef0: 6e2c 0a20 2020 2020 2020 2020 2020 2076  n,.            v
+0002bf00: 6f6c 7461 6765 3d73 656c 662e 6765 7428  oltage=self.get(
+0002bf10: 2276 6f6c 7461 6765 222c 2062 6561 6d5f  "voltage", beam_
+0002bf20: 7479 7065 292c 0a20 2020 2020 2020 2020  type),.         
+0002bf30: 2020 2064 7765 6c6c 5f74 696d 653d 7365     dwell_time=se
+0002bf40: 6c66 2e6c 6173 745f 696d 6167 6528 6265  lf.last_image(be
+0002bf50: 616d 5f74 7970 6529 2e6d 6574 6164 6174  am_type).metadat
+0002bf60: 612e 696d 6167 655f 7365 7474 696e 6773  a.image_settings
+0002bf70: 2e64 7765 6c6c 5f74 696d 652c 0a20 2020  .dwell_time,.   
+0002bf80: 2020 2020 2020 2020 2073 6361 6e5f 726f           scan_ro
+0002bf90: 7461 7469 6f6e 3d73 656c 662e 6765 7428  tation=self.get(
+0002bfa0: 2273 6361 6e5f 726f 7461 7469 6f6e 222c  "scan_rotation",
+0002bfb0: 2062 6561 6d5f 7479 7065 292c 200a 2020   beam_type), .  
+0002bfc0: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
+0002bfd0: 2072 6574 7572 6e20 6265 616d 5f73 6574   return beam_set
+0002bfe0: 7469 6e67 730a 2020 2020 0a20 2020 2064  tings.    .    d
+0002bff0: 6566 2073 6574 5f62 6561 6d5f 7365 7474  ef set_beam_sett
+0002c000: 696e 6773 2873 656c 662c 2062 6561 6d5f  ings(self, beam_
+0002c010: 7365 7474 696e 6773 3a20 4265 616d 5379  settings: BeamSy
+0002c020: 7374 656d 5365 7474 696e 6773 2920 2d3e  stemSettings) ->
+0002c030: 204e 6f6e 653a 0a20 2020 2020 2020 2022   None:.        "
+0002c040: 2222 5365 7420 7468 6520 6265 616d 2073  ""Set the beam s
+0002c050: 6574 7469 6e67 7320 666f 7220 7468 6520  ettings for the 
+0002c060: 7370 6563 6966 6965 6420 6265 616d 2074  specified beam t
+0002c070: 7970 652e 0a0a 2020 2020 2020 2020 4172  ype...        Ar
+0002c080: 6773 3a0a 2020 2020 2020 2020 2020 2020  gs:.            
+0002c090: 6265 616d 5f73 6574 7469 6e67 7320 2842  beam_settings (B
+0002c0a0: 6561 6d53 6574 7469 6e67 7329 3a20 4120  eamSettings): A 
+0002c0b0: 6042 6561 6d53 6574 7469 6e67 7360 206f  `BeamSettings` o
+0002c0c0: 626a 6563 7420 636f 6e74 6169 6e69 6e67  bject containing
+0002c0d0: 2074 6865 2062 6561 6d20 7365 7474 696e   the beam settin
+0002c0e0: 6773 2074 6f20 7365 742e 0a0a 2020 2020  gs to set...    
+0002c0f0: 2020 2020 5265 7475 726e 733a 0a20 2020      Returns:.   
+0002c100: 2020 2020 2020 2020 204e 6f6e 652e 0a0a           None...
+0002c110: 2020 2020 2020 2020 5261 6973 6573 3a0a          Raises:.
+0002c120: 2020 2020 2020 2020 2020 2020 4e6f 6e65              None
+0002c130: 2e0a 2020 2020 2020 2020 2222 220a 2020  ..        """.  
+0002c140: 2020 2020 2020 6c6f 6767 696e 672e 696e        logging.in
+0002c150: 666f 2866 2253 6574 7469 6e67 207b 6265  fo(f"Setting {be
+0002c160: 616d 5f73 6574 7469 6e67 732e 6265 616d  am_settings.beam
+0002c170: 5f74 7970 652e 6e61 6d65 7d20 6265 616d  _type.name} beam
+0002c180: 2073 6574 7469 6e67 732e 2e2e 2229 0a20   settings..."). 
+0002c190: 2020 2020 2020 2073 656c 662e 7365 7428         self.set(
+0002c1a0: 2277 6f72 6b69 6e67 5f64 6973 7461 6e63  "working_distanc
+0002c1b0: 6522 2c20 6265 616d 5f73 6574 7469 6e67  e", beam_setting
+0002c1c0: 732e 6575 6365 6e74 7269 635f 6865 6967  s.eucentric_heig
+0002c1d0: 6874 2c20 6265 616d 5f73 6574 7469 6e67  ht, beam_setting
+0002c1e0: 732e 6265 616d 5f74 7970 6529 0a20 2020  s.beam_type).   
+0002c1f0: 2020 2020 2073 656c 662e 7365 7428 2263       self.set("c
+0002c200: 7572 7265 6e74 222c 2062 6561 6d5f 7365  urrent", beam_se
+0002c210: 7474 696e 6773 2e63 7572 7265 6e74 2c20  ttings.current, 
+0002c220: 6265 616d 5f73 6574 7469 6e67 732e 6265  beam_settings.be
+0002c230: 616d 5f74 7970 6529 0a20 2020 2020 2020  am_type).       
+0002c240: 2073 656c 662e 7365 7428 2276 6f6c 7461   self.set("volta
+0002c250: 6765 222c 2062 6561 6d5f 7365 7474 696e  ge", beam_settin
+0002c260: 6773 2e76 6f6c 7461 6765 2c20 6265 616d  gs.voltage, beam
+0002c270: 5f73 6574 7469 6e67 732e 6265 616d 5f74  _settings.beam_t
+0002c280: 7970 6529 0a20 2020 2020 2020 2073 656c  ype).        sel
+0002c290: 662e 7365 7428 2264 6574 6563 746f 725f  f.set("detector_
+0002c2a0: 7479 7065 222c 2062 6561 6d5f 7365 7474  type", beam_sett
+0002c2b0: 696e 6773 2e64 6574 6563 746f 725f 7479  ings.detector_ty
+0002c2c0: 7065 2c20 6265 616d 5f73 6574 7469 6e67  pe, beam_setting
+0002c2d0: 732e 6265 616d 5f74 7970 6529 0a0a 2020  s.beam_type)..  
+0002c2e0: 2020 2020 2020 6966 2062 6561 6d5f 7365        if beam_se
+0002c2f0: 7474 696e 6773 2e62 6561 6d5f 7479 7065  ttings.beam_type
+0002c300: 203d 3d20 4265 616d 5479 7065 2e49 4f4e   == BeamType.ION
+0002c310: 2061 6e64 2073 656c 662e 6861 7264 7761   and self.hardwa
+0002c320: 7265 5f73 6574 7469 6e67 732e 6361 6e5f  re_settings.can_
+0002c330: 7365 6c65 6374 5f70 6c61 736d 615f 6761  select_plasma_ga
+0002c340: 733a 0a20 2020 2020 2020 2020 2020 2073  s:.            s
+0002c350: 656c 662e 7365 7428 2270 6c61 736d 615f  elf.set("plasma_
+0002c360: 6761 7322 2c20 6265 616d 5f73 6574 7469  gas", beam_setti
+0002c370: 6e67 732e 706c 6173 6d61 5f67 6173 2c20  ngs.plasma_gas, 
+0002c380: 6265 616d 5f73 6574 7469 6e67 732e 6265  beam_settings.be
+0002c390: 616d 5f74 7970 6529 0a0a 2020 2020 6465  am_type)..    de
+0002c3a0: 6620 6765 745f 6465 7465 6374 6f72 5f73  f get_detector_s
+0002c3b0: 6574 7469 6e67 7328 7365 6c66 2c20 6265  ettings(self, be
+0002c3c0: 616d 5f74 7970 653a 2042 6561 6d54 7970  am_type: BeamTyp
+0002c3d0: 6520 3d20 4265 616d 5479 7065 2e45 4c45  e = BeamType.ELE
+0002c3e0: 4354 524f 4e29 202d 3e20 4669 6273 656d  CTRON) -> Fibsem
+0002c3f0: 4465 7465 6374 6f72 5365 7474 696e 6773  DetectorSettings
+0002c400: 3a0a 2020 2020 2020 2020 2222 2247 6574  :.        """Get
+0002c410: 2074 6865 2063 7572 7265 6e74 2064 6574   the current det
+0002c420: 6563 746f 7220 7365 7474 696e 6773 2066  ector settings f
+0002c430: 6f72 2074 6865 206d 6963 726f 7363 6f70  or the microscop
+0002c440: 652e 0a0a 2020 2020 2020 2020 2222 220a  e...        """.
+0002c450: 2020 2020 2020 2020 6465 7465 6374 6f72          detector
+0002c460: 5f73 6574 7469 6e67 7320 3d20 4669 6273  _settings = Fibs
+0002c470: 656d 4465 7465 6374 6f72 5365 7474 696e  emDetectorSettin
+0002c480: 6773 280a 2020 2020 2020 2020 2020 2020  gs(.            
+0002c490: 7479 7065 203d 2073 656c 662e 6765 7428  type = self.get(
+0002c4a0: 2264 6574 6563 746f 725f 7479 7065 222c  "detector_type",
+0002c4b0: 2062 6561 6d5f 7479 7065 292c 0a20 2020   beam_type),.   
+0002c4c0: 2020 2020 2020 2020 206d 6f64 6520 3d20           mode = 
+0002c4d0: 7365 6c66 2e67 6574 2822 6465 7465 6374  self.get("detect
+0002c4e0: 6f72 5f6d 6f64 6522 2c20 6265 616d 5f74  or_mode", beam_t
+0002c4f0: 7970 6529 2c0a 2020 2020 2020 2020 2020  ype),.          
+0002c500: 2020 6272 6967 6874 6e65 7373 3d20 7365    brightness= se
+0002c510: 6c66 2e67 6574 2822 6465 7465 6374 6f72  lf.get("detector
+0002c520: 5f62 7269 6768 746e 6573 7322 2c20 6265  _brightness", be
+0002c530: 616d 5f74 7970 6529 2c0a 2020 2020 2020  am_type),.      
+0002c540: 2020 2020 2020 636f 6e74 7261 7374 3d20        contrast= 
+0002c550: 7365 6c66 2e67 6574 2822 6465 7465 6374  self.get("detect
+0002c560: 6f72 5f63 6f6e 7472 6173 7422 2c20 6265  or_contrast", be
+0002c570: 616d 5f74 7970 6529 2c0a 2020 2020 2020  am_type),.      
+0002c580: 2020 290a 0a20 2020 2020 2020 2072 6574    )..        ret
+0002c590: 7572 6e20 6465 7465 6374 6f72 5f73 6574  urn detector_set
+0002c5a0: 7469 6e67 730a 2020 2020 0a20 2020 2064  tings.    .    d
+0002c5b0: 6566 2067 6574 2873 656c 662c 206b 6579  ef get(self, key
+0002c5c0: 3a20 7374 722c 2062 6561 6d5f 7479 7065  : str, beam_type
+0002c5d0: 3a20 4265 616d 5479 7065 203d 2042 6561  : BeamType = Bea
+0002c5e0: 6d54 7970 652e 454c 4543 5452 4f4e 2920  mType.ELECTRON) 
+0002c5f0: 2d3e 2055 6e69 6f6e 5b66 6c6f 6174 2c20  -> Union[float, 
+0002c600: 7374 722c 204e 6f6e 655d 3a0a 0a20 2020  str, None]:..   
+0002c610: 2020 2020 2062 6561 6d20 3d20 7365 6c66       beam = self
+0002c620: 2e63 6f6e 6e65 6374 696f 6e2e 5345 4d20  .connection.SEM 
+0002c630: 6966 2062 6561 6d5f 7479 7065 203d 3d20  if beam_type == 
+0002c640: 4265 616d 5479 7065 2e45 4c45 4354 524f  BeamType.ELECTRO
+0002c650: 4e20 656c 7365 2073 656c 662e 636f 6e6e  N else self.conn
+0002c660: 6563 7469 6f6e 2e46 4942 0a0a 2020 2020  ection.FIB..    
+0002c670: 2020 2020 2320 6265 616d 2070 726f 7065      # beam prope
+0002c680: 7274 6965 7320 0a20 2020 2020 2020 2069  rties .        i
+0002c690: 6620 6b65 7920 3d3d 2022 6f6e 223a 200a  f key == "on": .
+0002c6a0: 2020 2020 2020 2020 2020 2020 5f63 6865              _che
+0002c6b0: 636b 5f62 6561 6d28 6265 616d 5f74 7970  ck_beam(beam_typ
+0002c6c0: 652c 2073 656c 662e 6861 7264 7761 7265  e, self.hardware
+0002c6d0: 5f73 6574 7469 6e67 7329 0a20 2020 2020  _settings).     
+0002c6e0: 2020 2020 2020 2072 6574 7572 6e20 6265         return be
+0002c6f0: 616d 2e42 6561 6d2e 4765 7453 7461 7475  am.Beam.GetStatu
+0002c700: 7328 290a 2020 2020 2020 2020 6966 206b  s().        if k
+0002c710: 6579 203d 3d20 2277 6f72 6b69 6e67 5f64  ey == "working_d
+0002c720: 6973 7461 6e63 6522 2061 6e64 2062 6561  istance" and bea
+0002c730: 6d5f 7479 7065 203d 3d20 4265 616d 5479  m_type == BeamTy
+0002c740: 7065 2e45 4c45 4354 524f 4e3a 0a20 2020  pe.ELECTRON:.   
+0002c750: 2020 2020 2020 2020 205f 6368 6563 6b5f           _check_
+0002c760: 6265 616d 2862 6561 6d5f 7479 7065 2c20  beam(beam_type, 
+0002c770: 7365 6c66 2e68 6172 6477 6172 655f 7365  self.hardware_se
+0002c780: 7474 696e 6773 290a 2020 2020 2020 2020  ttings).        
+0002c790: 2020 2020 7265 7475 726e 2062 6561 6d2e      return beam.
+0002c7a0: 4f70 7469 6373 2e47 6574 5744 2829 202a  Optics.GetWD() *
+0002c7b0: 2063 6f6e 7374 616e 7473 2e4d 494c 4c49   constants.MILLI
+0002c7c0: 4d45 5452 455f 544f 5f4d 4554 5245 0a20  METRE_TO_METRE. 
+0002c7d0: 2020 2020 2020 2069 6620 6b65 7920 3d3d         if key ==
+0002c7e0: 2022 6375 7272 656e 7422 3a0a 2020 2020   "current":.    
+0002c7f0: 2020 2020 2020 2020 5f63 6865 636b 5f62          _check_b
+0002c800: 6561 6d28 6265 616d 5f74 7970 652c 2073  eam(beam_type, s
+0002c810: 656c 662e 6861 7264 7761 7265 5f73 6574  elf.hardware_set
+0002c820: 7469 6e67 7329 0a20 2020 2020 2020 2020  tings).         
+0002c830: 2020 2069 6620 6265 616d 5f74 7970 6520     if beam_type 
+0002c840: 3d3d 2042 6561 6d54 7970 652e 454c 4543  == BeamType.ELEC
+0002c850: 5452 4f4e 3a0a 2020 2020 2020 2020 2020  TRON:.          
+0002c860: 2020 2020 2020 7265 7475 726e 2062 6561        return bea
+0002c870: 6d2e 4265 616d 2e47 6574 4375 7272 656e  m.Beam.GetCurren
+0002c880: 7428 2920 2a20 636f 6e73 7461 6e74 732e  t() * constants.
+0002c890: 5049 434f 5f54 4f5f 5349 0a20 2020 2020  PICO_TO_SI.     
+0002c8a0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+0002c8b0: 2020 2020 2020 2020 2020 2020 2072 6574               ret
+0002c8c0: 7572 6e20 6265 616d 2e42 6561 6d2e 5265  urn beam.Beam.Re
+0002c8d0: 6164 5072 6f62 6543 7572 7265 6e74 2829  adProbeCurrent()
+0002c8e0: 202a 2063 6f6e 7374 616e 7473 2e50 4943   * constants.PIC
+0002c8f0: 4f5f 544f 5f53 490a 2020 2020 2020 2020  O_TO_SI.        
+0002c900: 6966 206b 6579 203d 3d20 2276 6f6c 7461  if key == "volta
+0002c910: 6765 223a 0a20 2020 2020 2020 2020 2020  ge":.           
+0002c920: 205f 6368 6563 6b5f 6265 616d 2862 6561   _check_beam(bea
+0002c930: 6d5f 7479 7065 2c20 7365 6c66 2e68 6172  m_type, self.har
+0002c940: 6477 6172 655f 7365 7474 696e 6773 290a  dware_settings).
+0002c950: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0002c960: 726e 2062 6561 6d2e 4265 616d 2e47 6574  rn beam.Beam.Get
+0002c970: 566f 6c74 6167 6528 2920 0a20 2020 2020  Voltage() .     
+0002c980: 2020 2069 6620 6b65 7920 3d3d 2022 6866     if key == "hf
+0002c990: 7722 3a0a 2020 2020 2020 2020 2020 2020  w":.            
+0002c9a0: 5f63 6865 636b 5f62 6561 6d28 6265 616d  _check_beam(beam
+0002c9b0: 5f74 7970 652c 2073 656c 662e 6861 7264  _type, self.hard
+0002c9c0: 7761 7265 5f73 6574 7469 6e67 7329 0a20  ware_settings). 
+0002c9d0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0002c9e0: 6e20 6265 616d 2e4f 7074 6963 732e 4765  n beam.Optics.Ge
+0002c9f0: 7456 6965 7766 6965 6c64 2829 202a 2063  tViewfield() * c
+0002ca00: 6f6e 7374 616e 7473 2e4d 494c 4c49 4d45  onstants.MILLIME
+0002ca10: 5452 455f 544f 5f4d 4554 5245 0a20 2020  TRE_TO_METRE.   
+0002ca20: 2020 2020 2069 6620 6b65 7920 3d3d 2022       if key == "
+0002ca30: 7265 736f 6c75 7469 6f6e 223a 0a20 2020  resolution":.   
+0002ca40: 2020 2020 2020 2020 205f 6368 6563 6b5f           _check_
+0002ca50: 6265 616d 2862 6561 6d5f 7479 7065 2c20  beam(beam_type, 
+0002ca60: 7365 6c66 2e68 6172 6477 6172 655f 7365  self.hardware_se
+0002ca70: 7474 696e 6773 290a 2020 2020 2020 2020  ttings).        
+0002ca80: 2020 2020 6966 2062 6561 6d5f 7479 7065      if beam_type
+0002ca90: 203d 3d20 4265 616d 5479 7065 2e45 4c45   == BeamType.ELE
+0002caa0: 4354 524f 4e20 616e 6420 7365 6c66 2e6c  CTRON and self.l
+0002cab0: 6173 745f 696d 6167 655f 6562 2069 7320  ast_image_eb is 
+0002cac0: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
+0002cad0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0002cae0: 2073 656c 662e 6c61 7374 5f69 6d61 6765   self.last_image
+0002caf0: 5f65 622e 6d65 7461 6461 7461 2e69 6d61  _eb.metadata.ima
+0002cb00: 6765 5f73 6574 7469 6e67 732e 7265 736f  ge_settings.reso
+0002cb10: 6c75 7469 6f6e 0a20 2020 2020 2020 2020  lution.         
+0002cb20: 2020 2065 6c69 6620 6265 616d 5f74 7970     elif beam_typ
+0002cb30: 6520 3d3d 2042 6561 6d54 7970 652e 494f  e == BeamType.IO
+0002cb40: 4e20 616e 6420 7365 6c66 2e6c 6173 745f  N and self.last_
+0002cb50: 696d 6167 655f 6962 2069 7320 6e6f 7420  image_ib is not 
+0002cb60: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+0002cb70: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
+0002cb80: 662e 6c61 7374 5f69 6d61 6765 5f69 622e  f.last_image_ib.
+0002cb90: 6d65 7461 6461 7461 2e69 6d61 6765 5f73  metadata.image_s
+0002cba0: 6574 7469 6e67 732e 7265 736f 6c75 7469  ettings.resoluti
+0002cbb0: 6f6e 0a20 2020 2020 2020 2069 6620 6b65  on.        if ke
+0002cbc0: 7920 3d3d 2022 6477 656c 6c5f 7469 6d65  y == "dwell_time
+0002cbd0: 223a 0a20 2020 2020 2020 2020 2020 205f  ":.            _
+0002cbe0: 6368 6563 6b5f 6265 616d 2862 6561 6d5f  check_beam(beam_
+0002cbf0: 7479 7065 2c20 7365 6c66 2e68 6172 6477  type, self.hardw
+0002cc00: 6172 655f 7365 7474 696e 6773 290a 2020  are_settings).  
+0002cc10: 2020 2020 2020 2020 2020 6966 2062 6561            if bea
+0002cc20: 6d5f 7479 7065 203d 3d20 4265 616d 5479  m_type == BeamTy
+0002cc30: 7065 2e45 4c45 4354 524f 4e20 616e 6420  pe.ELECTRON and 
+0002cc40: 7365 6c66 2e6c 6173 745f 696d 6167 655f  self.last_image_
+0002cc50: 6562 2069 7320 6e6f 7420 4e6f 6e65 3a0a  eb is not None:.
+0002cc60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002cc70: 7265 7475 726e 2073 656c 662e 6c61 7374  return self.last
+0002cc80: 5f69 6d61 6765 5f65 622e 6d65 7461 6461  _image_eb.metada
+0002cc90: 7461 2e69 6d61 6765 5f73 6574 7469 6e67  ta.image_setting
+0002cca0: 732e 6477 656c 6c5f 7469 6d65 0a20 2020  s.dwell_time.   
+0002ccb0: 2020 2020 2020 2020 2065 6c69 6620 6265           elif be
+0002ccc0: 616d 5f74 7970 6520 3d3d 2042 6561 6d54  am_type == BeamT
+0002ccd0: 7970 652e 494f 4e20 616e 6420 7365 6c66  ype.ION and self
+0002cce0: 2e6c 6173 745f 696d 6167 655f 6962 2069  .last_image_ib i
+0002ccf0: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
+0002cd00: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0002cd10: 726e 2073 656c 662e 6c61 7374 5f69 6d61  rn self.last_ima
+0002cd20: 6765 5f69 622e 6d65 7461 6461 7461 2e69  ge_ib.metadata.i
+0002cd30: 6d61 6765 5f73 6574 7469 6e67 732e 6477  mage_settings.dw
+0002cd40: 656c 6c5f 7469 6d65 2020 200a 2020 2020  ell_time   .    
+0002cd50: 2020 2020 6966 206b 6579 203d 3d22 7363      if key =="sc
+0002cd60: 616e 5f72 6f74 6174 696f 6e22 3a0a 2020  an_rotation":.  
+0002cd70: 2020 2020 2020 2020 2020 5f63 6865 636b            _check
+0002cd80: 5f62 6561 6d28 6265 616d 5f74 7970 652c  _beam(beam_type,
+0002cd90: 2073 656c 662e 6861 7264 7761 7265 5f73   self.hardware_s
+0002cda0: 6574 7469 6e67 7329 0a20 2020 2020 2020  ettings).       
+0002cdb0: 2020 2020 2072 6574 7572 6e20 6265 616d       return beam
+0002cdc0: 2e4f 7074 6963 732e 4765 7449 6d61 6765  .Optics.GetImage
+0002cdd0: 526f 7461 7469 6f6e 2829 2020 200a 2020  Rotation()   .  
+0002cde0: 2020 2020 2020 6966 206b 6579 203d 3d20        if key == 
+0002cdf0: 2273 6869 6674 223a 0a20 2020 2020 2020  "shift":.       
+0002ce00: 2020 2020 205f 6368 6563 6b5f 6265 616d       _check_beam
+0002ce10: 2862 6561 6d5f 7479 7065 2c20 7365 6c66  (beam_type, self
+0002ce20: 2e68 6172 6477 6172 655f 7365 7474 696e  .hardware_settin
+0002ce30: 6773 290a 2020 2020 2020 2020 2020 2020  gs).            
+0002ce40: 7661 6c75 6573 203d 2062 6561 6d2e 4f70  values = beam.Op
+0002ce50: 7469 6373 2e47 6574 496d 6167 6553 6869  tics.GetImageShi
+0002ce60: 6674 2829 0a20 2020 2020 2020 2020 2020  ft().           
+0002ce70: 2073 6869 6674 203d 2050 6f69 6e74 2876   shift = Point(v
+0002ce80: 616c 7565 735b 305d 2a63 6f6e 7374 616e  alues[0]*constan
+0002ce90: 7473 2e4d 494c 4c49 4d45 5452 455f 544f  ts.MILLIMETRE_TO
+0002cea0: 5f4d 4554 5245 2c20 7661 6c75 6573 5b31  _METRE, values[1
+0002ceb0: 5d2a 636f 6e73 7461 6e74 732e 4d49 4c4c  ]*constants.MILL
+0002cec0: 494d 4554 5245 5f54 4f5f 4d45 5452 4529  IMETRE_TO_METRE)
+0002ced0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+0002cee0: 7572 6e20 7368 6966 740a 2020 2020 2020  urn shift.      
+0002cef0: 2020 0a20 2020 2020 2020 2023 2073 7461    .        # sta
+0002cf00: 6765 2070 726f 7065 7274 6965 730a 2020  ge properties.  
+0002cf10: 2020 2020 2020 6966 206b 6579 203d 3d20        if key == 
+0002cf20: 2273 7461 6765 5f70 6f73 6974 696f 6e22  "stage_position"
+0002cf30: 3a0a 2020 2020 2020 2020 2020 2020 5f63  :.            _c
+0002cf40: 6865 636b 5f73 7461 6765 2873 656c 662e  heck_stage(self.
+0002cf50: 6861 7264 7761 7265 5f73 6574 7469 6e67  hardware_setting
+0002cf60: 7329 0a20 2020 2020 2020 2020 2020 2072  s).            r
+0002cf70: 6574 7572 6e20 7365 6c66 2e67 6574 5f73  eturn self.get_s
+0002cf80: 7461 6765 5f70 6f73 6974 696f 6e28 290a  tage_position().
+0002cf90: 2020 2020 2020 2020 6966 206b 6579 203d          if key =
+0002cfa0: 3d20 2273 7461 6765 5f63 616c 6962 7261  = "stage_calibra
+0002cfb0: 7465 6422 3a0a 2020 2020 2020 2020 2020  ted":.          
+0002cfc0: 2020 5f63 6865 636b 5f73 7461 6765 2873    _check_stage(s
+0002cfd0: 656c 662e 6861 7264 7761 7265 5f73 6574  elf.hardware_set
+0002cfe0: 7469 6e67 7329 0a20 2020 2020 2020 2020  tings).         
+0002cff0: 2020 2072 6574 7572 6e20 7365 6c66 2e63     return self.c
+0002d000: 6f6e 6e65 6374 696f 6e2e 5374 6167 652e  onnection.Stage.
+0002d010: 4973 4361 6c69 6272 6174 6564 2829 0a20  IsCalibrated(). 
+0002d020: 2020 2020 2020 200a 2020 2020 2020 2020         .        
+0002d030: 2320 6368 616d 6265 7220 7072 6f70 6572  # chamber proper
+0002d040: 7469 6573 0a20 2020 2020 2020 2069 6620  ties.        if 
+0002d050: 6b65 7920 3d3d 2022 6368 616d 6265 725f  key == "chamber_
+0002d060: 7374 6174 6522 3a0a 2020 2020 2020 2020  state":.        
+0002d070: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
+0002d080: 636f 6e6e 6563 7469 6f6e 2e43 6861 6d62  connection.Chamb
+0002d090: 6572 2e47 6574 5374 6174 7573 2829 0a20  er.GetStatus(). 
+0002d0a0: 2020 2020 2020 2069 6620 6b65 7920 3d3d         if key ==
+0002d0b0: 2022 6368 616d 6265 725f 7072 6573 7375   "chamber_pressu
+0002d0c0: 7265 223a 0a20 2020 2020 2020 2020 2020  re":.           
+0002d0d0: 2072 6574 7572 6e20 7365 6c66 2e63 6f6e   return self.con
+0002d0e0: 6e65 6374 696f 6e2e 4368 616d 6265 722e  nection.Chamber.
+0002d0f0: 4765 7450 7265 7373 7572 6528 3029 0a20  GetPressure(0). 
+0002d100: 2020 2020 2020 200a 2020 2020 2020 2020         .        
+0002d110: 2364 6574 6563 746f 7220 7072 6f70 6572  #detector proper
+0002d120: 7469 6573 0a20 2020 2020 2020 2069 6620  ties.        if 
+0002d130: 6b65 7920 3d3d 2022 6465 7465 6374 6f72  key == "detector
+0002d140: 5f74 7970 6522 3a0a 2020 2020 2020 2020  _type":.        
+0002d150: 2020 2020 6465 7465 6374 6f72 203d 2062      detector = b
+0002d160: 6561 6d2e 4465 7465 6374 6f72 2e47 6574  eam.Detector.Get
+0002d170: 2843 6861 6e6e 656c 203d 2030 2920 0a20  (Channel = 0) . 
+0002d180: 2020 2020 2020 2020 2020 2069 6620 6465             if de
+0002d190: 7465 6374 6f72 2069 7320 6e6f 7420 4e6f  tector is not No
+0002d1a0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+0002d1b0: 2020 2020 7265 7475 726e 2064 6574 6563      return detec
+0002d1c0: 746f 722e 6e61 6d65 0a20 2020 2020 2020  tor.name.       
+0002d1d0: 2020 2020 2065 6c73 653a 200a 2020 2020       else: .    
+0002d1e0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0002d1f0: 726e 204e 6f6e 650a 2020 2020 2020 2020  rn None.        
+0002d200: 6966 206b 6579 203d 3d20 2264 6574 6563  if key == "detec
+0002d210: 746f 725f 636f 6e74 7261 7374 223a 0a20  tor_contrast":. 
+0002d220: 2020 2020 2020 2020 2020 2069 6620 6265             if be
+0002d230: 616d 5f74 7970 6520 3d3d 2042 6561 6d54  am_type == BeamT
+0002d240: 7970 652e 454c 4543 5452 4f4e 3a0a 2020  ype.ELECTRON:.  
+0002d250: 2020 2020 2020 2020 2020 2020 2020 636f                co
+0002d260: 6e74 7261 7374 2c20 6272 6967 6874 6e65  ntrast, brightne
+0002d270: 7373 203d 2062 6561 6d2e 4465 7465 6374  ss = beam.Detect
+0002d280: 6f72 2e47 6574 4761 696e 426c 6163 6b28  or.GetGainBlack(
+0002d290: 4465 7465 6374 6f72 3d20 7365 6c66 2e65  Detector= self.e
+0002d2a0: 6c65 6374 726f 6e5f 6465 7465 6374 6f72  lectron_detector
+0002d2b0: 5f61 6374 6976 6529 0a20 2020 2020 2020  _active).       
+0002d2c0: 2020 2020 2065 6c69 6620 6265 616d 5f74       elif beam_t
+0002d2d0: 7970 6520 3d3d 2042 6561 6d54 7970 652e  ype == BeamType.
+0002d2e0: 494f 4e3a 0a20 2020 2020 2020 2020 2020  ION:.           
+0002d2f0: 2020 2020 2063 6f6e 7472 6173 742c 2062       contrast, b
+0002d300: 7269 6768 746e 6573 7320 3d20 6265 616d  rightness = beam
+0002d310: 2e44 6574 6563 746f 722e 4765 7447 6169  .Detector.GetGai
+0002d320: 6e42 6c61 636b 2844 6574 6563 746f 723d  nBlack(Detector=
+0002d330: 2073 656c 662e 696f 6e5f 6465 7465 6374   self.ion_detect
+0002d340: 6f72 5f61 6374 6976 6529 0a20 2020 2020  or_active).     
+0002d350: 2020 2020 2020 2072 6574 7572 6e20 636f         return co
+0002d360: 6e74 7261 7374 2f31 3030 0a20 2020 2020  ntrast/100.     
+0002d370: 2020 2069 6620 6b65 7920 3d3d 2022 6465     if key == "de
+0002d380: 7465 6374 6f72 5f62 7269 6768 746e 6573  tector_brightnes
+0002d390: 7322 3a0a 2020 2020 2020 2020 2020 2020  s":.            
+0002d3a0: 6966 2062 6561 6d5f 7479 7065 203d 3d20  if beam_type == 
+0002d3b0: 4265 616d 5479 7065 2e45 4c45 4354 524f  BeamType.ELECTRO
+0002d3c0: 4e3a 0a20 2020 2020 2020 2020 2020 2020  N:.             
+0002d3d0: 2020 2063 6f6e 7472 6173 742c 2062 7269     contrast, bri
+0002d3e0: 6768 746e 6573 7320 3d20 6265 616d 2e44  ghtness = beam.D
+0002d3f0: 6574 6563 746f 722e 4765 7447 6169 6e42  etector.GetGainB
+0002d400: 6c61 636b 2844 6574 6563 746f 723d 2073  lack(Detector= s
+0002d410: 656c 662e 656c 6563 7472 6f6e 5f64 6574  elf.electron_det
+0002d420: 6563 746f 725f 6163 7469 7665 290a 2020  ector_active).  
+0002d430: 2020 2020 2020 2020 2020 656c 6966 2062            elif b
+0002d440: 6561 6d5f 7479 7065 203d 3d20 4265 616d  eam_type == Beam
+0002d450: 5479 7065 2e49 4f4e 3a0a 2020 2020 2020  Type.ION:.      
+0002d460: 2020 2020 2020 2020 2020 636f 6e74 7261            contra
+0002d470: 7374 2c20 6272 6967 6874 6e65 7373 203d  st, brightness =
+0002d480: 2062 6561 6d2e 4465 7465 6374 6f72 2e47   beam.Detector.G
+0002d490: 6574 4761 696e 426c 6163 6b28 4465 7465  etGainBlack(Dete
+0002d4a0: 6374 6f72 3d20 7365 6c66 2e69 6f6e 5f64  ctor= self.ion_d
+0002d4b0: 6574 6563 746f 725f 6163 7469 7665 290a  etector_active).
+0002d4c0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0002d4d0: 726e 2062 7269 6768 746e 6573 732f 3130  rn brightness/10
+0002d4e0: 300a 2020 2020 2020 2020 0a20 2020 2020  0.        .     
+0002d4f0: 2020 2023 206d 616e 6970 756c 6174 6f72     # manipulator
+0002d500: 2070 726f 7065 7274 6965 730a 2020 2020   properties.    
+0002d510: 2020 2020 6966 206b 6579 203d 3d20 226d      if key == "m
+0002d520: 616e 6970 756c 6174 6f72 5f70 6f73 6974  anipulator_posit
+0002d530: 696f 6e22 3a0a 2020 2020 2020 2020 2020  ion":.          
+0002d540: 2020 5f63 6865 636b 5f6e 6565 646c 6528    _check_needle(
+0002d550: 7365 6c66 2e68 6172 6477 6172 655f 7365  self.hardware_se
+0002d560: 7474 696e 6773 290a 2020 2020 2020 2020  ttings).        
+0002d570: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
+0002d580: 636f 6e6e 6563 7469 6f6e 2e4e 616e 6f6d  connection.Nanom
+0002d590: 616e 6970 756c 6174 6f72 2e47 6574 506f  anipulator.GetPo
+0002d5a0: 7369 7469 6f6e 2830 290a 2020 2020 2020  sition(0).      
+0002d5b0: 2020 6966 206b 6579 203d 3d20 226d 616e    if key == "man
+0002d5c0: 6970 756c 6174 6f72 5f63 616c 6962 7261  ipulator_calibra
+0002d5d0: 7465 6422 3a0a 2020 2020 2020 2020 2020  ted":.          
+0002d5e0: 2020 5f63 6865 636b 5f6e 6565 646c 6528    _check_needle(
+0002d5f0: 7365 6c66 2e68 6172 6477 6172 655f 7365  self.hardware_se
+0002d600: 7474 696e 6773 290a 2020 2020 2020 2020  ttings).        
+0002d610: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
+0002d620: 636f 6e6e 6563 7469 6f6e 2e4e 616e 6f6d  connection.Nanom
+0002d630: 616e 6970 756c 6174 6f72 2e49 7343 616c  anipulator.IsCal
+0002d640: 6962 7261 7465 6428 3029 0a0a 2020 2020  ibrated(0)..    
+0002d650: 2020 2020 6966 206b 6579 203d 3d20 2270      if key == "p
+0002d660: 7265 7365 7473 223a 0a20 2020 2020 2020  resets":.       
+0002d670: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
+0002d680: 2e5f 6765 745f 7072 6573 6574 7328 290a  ._get_presets().
+0002d690: 0a20 2020 2020 2020 2023 206c 6f67 6769  .        # loggi
+0002d6a0: 6e67 2e77 6172 6e69 6e67 2866 2255 6e6b  ng.warning(f"Unk
+0002d6b0: 6e6f 776e 206b 6579 3a20 7b6b 6579 7d20  nown key: {key} 
+0002d6c0: 287b 6265 616d 5f74 7970 657d 2922 290a  ({beam_type})").
+0002d6d0: 2020 2020 2020 2020 7265 7475 726e 204e          return N
+0002d6e0: 6f6e 6520 2020 0a0a 2020 2020 6465 6620  one   ..    def 
+0002d6f0: 7365 7428 7365 6c66 2c20 6b65 793a 2073  set(self, key: s
+0002d700: 7472 2c20 7661 6c75 652c 2062 6561 6d5f  tr, value, beam_
+0002d710: 7479 7065 3a20 4265 616d 5479 7065 203d  type: BeamType =
+0002d720: 2042 6561 6d54 7970 652e 454c 4543 5452   BeamType.ELECTR
+0002d730: 4f4e 2920 2d3e 204e 6f6e 653a 0a0a 2020  ON) -> None:..  
+0002d740: 2020 2020 2020 6265 616d 203d 2073 656c        beam = sel
+0002d750: 662e 636f 6e6e 6563 7469 6f6e 2e53 454d  f.connection.SEM
+0002d760: 2069 6620 6265 616d 5f74 7970 6520 3d3d   if beam_type ==
+0002d770: 2042 6561 6d54 7970 652e 454c 4543 5452   BeamType.ELECTR
+0002d780: 4f4e 2065 6c73 6520 7365 6c66 2e63 6f6e  ON else self.con
+0002d790: 6e65 6374 696f 6e2e 4649 420a 0a20 2020  nection.FIB..   
+0002d7a0: 2020 2020 2069 6620 6b65 7920 3d3d 2022       if key == "
+0002d7b0: 776f 726b 696e 675f 6469 7374 616e 6365  working_distance
+0002d7c0: 223a 0a20 2020 2020 2020 2020 2020 205f  ":.            _
+0002d7d0: 6368 6563 6b5f 6265 616d 2862 6561 6d5f  check_beam(beam_
+0002d7e0: 7479 7065 2c20 7365 6c66 2e68 6172 6477  type, self.hardw
+0002d7f0: 6172 655f 7365 7474 696e 6773 290a 2020  are_settings).  
+0002d800: 2020 2020 2020 2020 2020 6966 2062 6561            if bea
+0002d810: 6d5f 7479 7065 203d 3d20 4265 616d 5479  m_type == BeamTy
+0002d820: 7065 2e45 4c45 4354 524f 4e3a 0a20 2020  pe.ELECTRON:.   
+0002d830: 2020 2020 2020 2020 2020 2020 2062 6561               bea
+0002d840: 6d2e 4f70 7469 6373 2e53 6574 5744 2876  m.Optics.SetWD(v
+0002d850: 616c 7565 202a 2063 6f6e 7374 616e 7473  alue * constants
+0002d860: 2e4d 4554 5245 5f54 4f5f 4d49 4c4c 494d  .METRE_TO_MILLIM
+0002d870: 4554 5245 290a 2020 2020 2020 2020 2020  ETRE).          
+0002d880: 2020 2020 2020 6c6f 6767 696e 672e 696e        logging.in
+0002d890: 666f 2866 2245 6c65 6374 726f 6e20 6265  fo(f"Electron be
+0002d8a0: 616d 2077 6f72 6b69 6e67 2064 6973 7461  am working dista
+0002d8b0: 6e63 6520 7365 7420 746f 207b 7661 6c75  nce set to {valu
+0002d8c0: 657d 206d 2e22 290a 2020 2020 2020 2020  e} m.").        
+0002d8d0: 2020 2020 656c 7365 3a20 0a20 2020 2020      else: .     
+0002d8e0: 2020 2020 2020 2020 2020 206c 6f67 6769             loggi
+0002d8f0: 6e67 2e69 6e66 6f28 6622 5365 7474 696e  ng.info(f"Settin
+0002d900: 6720 776f 726b 696e 6720 6469 7374 616e  g working distan
+0002d910: 6365 2066 6f72 2069 6f6e 2062 6561 6d20  ce for ion beam 
+0002d920: 6973 206e 6f74 2073 7570 706f 7274 6564  is not supported
+0002d930: 2062 7920 5465 7363 616e 2041 5049 2e22   by Tescan API."
+0002d940: 290a 2020 2020 2020 2020 2020 2020 7265  ).            re
+0002d950: 7475 726e 0a20 2020 2020 2020 2069 6620  turn.        if 
+0002d960: 6b65 7920 3d3d 2022 6375 7272 656e 7422  key == "current"
+0002d970: 3a0a 2020 2020 2020 2020 2020 2020 5f63  :.            _c
+0002d980: 6865 636b 5f62 6561 6d28 6265 616d 5f74  heck_beam(beam_t
+0002d990: 7970 652c 2073 656c 662e 6861 7264 7761  ype, self.hardwa
+0002d9a0: 7265 5f73 6574 7469 6e67 7329 0a20 2020  re_settings).   
+0002d9b0: 2020 2020 2020 2020 2069 6620 6265 616d           if beam
+0002d9c0: 5f74 7970 6520 3d3d 2042 6561 6d54 7970  _type == BeamTyp
+0002d9d0: 652e 454c 4543 5452 4f4e 3a0a 2020 2020  e.ELECTRON:.    
+0002d9e0: 2020 2020 2020 2020 2020 2020 6265 616d              beam
+0002d9f0: 2e42 6561 6d2e 5365 7443 7572 7265 6e74  .Beam.SetCurrent
+0002da00: 2876 616c 7565 202a 2063 6f6e 7374 616e  (value * constan
+0002da10: 7473 2e53 495f 544f 5f50 4943 4f29 0a20  ts.SI_TO_PICO). 
+0002da20: 2020 2020 2020 2020 2020 2020 2020 206c                 l
+0002da30: 6f67 6769 6e67 2e69 6e66 6f28 6622 456c  ogging.info(f"El
+0002da40: 6563 7472 6f6e 2062 6561 6d20 6375 7272  ectron beam curr
+0002da50: 656e 7420 7365 7420 746f 207b 7661 6c75  ent set to {valu
+0002da60: 657d 2041 2e22 290a 2020 2020 2020 2020  e} A.").        
+0002da70: 2020 2020 656c 7365 3a20 0a20 2020 2020      else: .     
+0002da80: 2020 2020 2020 2020 2020 206c 6f67 6769             loggi
+0002da90: 6e67 2e69 6e66 6f28 6622 5365 7474 696e  ng.info(f"Settin
+0002daa0: 6720 6375 7272 656e 7420 666f 7220 696f  g current for io
+0002dab0: 6e20 6265 616d 2069 7320 6e6f 7420 7375  n beam is not su
+0002dac0: 7070 6f72 7465 6420 6279 2054 6573 6361  pported by Tesca
+0002dad0: 6e20 4150 492c 2070 6c65 6173 6520 7573  n API, please us
+0002dae0: 6520 7468 6520 6e61 7469 7665 206d 6963  e the native mic
+0002daf0: 726f 7363 6f70 6520 696e 7465 7266 6163  roscope interfac
+0002db00: 652e 2229 0a20 2020 2020 2020 2020 2020  e.").           
+0002db10: 2072 6574 7572 6e0a 2020 2020 2020 2020   return.        
+0002db20: 6966 206b 6579 203d 3d20 2276 6f6c 7461  if key == "volta
+0002db30: 6765 223a 0a20 2020 2020 2020 2020 2020  ge":.           
+0002db40: 205f 6368 6563 6b5f 6265 616d 2862 6561   _check_beam(bea
+0002db50: 6d5f 7479 7065 2c20 7365 6c66 2e68 6172  m_type, self.har
+0002db60: 6477 6172 655f 7365 7474 696e 6773 290a  dware_settings).
+0002db70: 2020 2020 2020 2020 2020 2020 6966 2062              if b
+0002db80: 6561 6d5f 7479 7065 203d 3d20 4265 616d  eam_type == Beam
+0002db90: 5479 7065 2e45 4c45 4354 524f 4e3a 0a20  Type.ELECTRON:. 
+0002dba0: 2020 2020 2020 2020 2020 2020 2020 2062                 b
+0002dbb0: 6561 6d2e 4265 616d 2e53 6574 566f 6c74  eam.Beam.SetVolt
+0002dbc0: 6167 6528 7661 6c75 6529 0a20 2020 2020  age(value).     
+0002dbd0: 2020 2020 2020 2020 2020 206c 6f67 6769             loggi
+0002dbe0: 6e67 2e69 6e66 6f28 6622 456c 6563 7472  ng.info(f"Electr
+0002dbf0: 6f6e 2062 6561 6d20 766f 6c74 6167 6520  on beam voltage 
+0002dc00: 7365 7420 746f 207b 7661 6c75 657d 2056  set to {value} V
+0002dc10: 2e22 290a 2020 2020 2020 2020 2020 2020  .").            
+0002dc20: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+0002dc30: 2020 2020 2020 6c6f 6767 696e 672e 696e        logging.in
+0002dc40: 666f 2866 2253 6574 7469 6e67 2076 6f6c  fo(f"Setting vol
+0002dc50: 7461 6765 2066 6f72 2069 6f6e 2062 6561  tage for ion bea
+0002dc60: 6d20 6973 206e 6f74 2073 7570 706f 7274  m is not support
+0002dc70: 6564 2062 7920 5465 7363 616e 2041 5049  ed by Tescan API
+0002dc80: 2c20 706c 6561 7365 2075 7365 2074 6865  , please use the
+0002dc90: 206e 6174 6976 6520 6d69 6372 6f73 636f   native microsco
+0002dca0: 7065 2069 6e74 6572 6661 6365 2e22 290a  pe interface.").
+0002dcb0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0002dcc0: 726e 0a20 2020 2020 2020 2069 6620 6b65  rn.        if ke
+0002dcd0: 7920 3d3d 2022 6866 7722 3a0a 2020 2020  y == "hfw":.    
+0002dce0: 2020 2020 2020 2020 5f63 6865 636b 5f62          _check_b
+0002dcf0: 6561 6d28 6265 616d 5f74 7970 652c 2073  eam(beam_type, s
+0002dd00: 656c 662e 6861 7264 7761 7265 5f73 6574  elf.hardware_set
+0002dd10: 7469 6e67 7329 0a20 2020 2020 2020 2020  tings).         
+0002dd20: 2020 2062 6561 6d2e 4f70 7469 6373 2e53     beam.Optics.S
+0002dd30: 6574 5669 6577 6669 656c 6428 7661 6c75  etViewfield(valu
+0002dd40: 6520 2a20 636f 6e73 7461 6e74 732e 4d45  e * constants.ME
+0002dd50: 5452 455f 544f 5f4d 494c 4c49 4d45 5452  TRE_TO_MILLIMETR
+0002dd60: 4529 0a20 2020 2020 2020 2020 2020 206c  E).            l
+0002dd70: 6f67 6769 6e67 2e69 6e66 6f28 6622 7b62  ogging.info(f"{b
+0002dd80: 6561 6d5f 7479 7065 2e6e 616d 657d 2048  eam_type.name} H
+0002dd90: 4657 2073 6574 2074 6f20 7b76 616c 7565  FW set to {value
+0002dda0: 7d20 6d2e 2229 0a20 2020 2020 2020 2020  } m.").         
+0002ddb0: 2020 2072 6574 7572 6e0a 2020 2020 2020     return.      
+0002ddc0: 2020 6966 206b 6579 203d 3d20 2273 6361    if key == "sca
+0002ddd0: 6e5f 726f 7461 7469 6f6e 223a 0a20 2020  n_rotation":.   
+0002dde0: 2020 2020 2020 2020 205f 6368 6563 6b5f           _check_
+0002ddf0: 6265 616d 2862 6561 6d5f 7479 7065 2c20  beam(beam_type, 
+0002de00: 7365 6c66 2e68 6172 6477 6172 655f 7365  self.hardware_se
+0002de10: 7474 696e 6773 290a 2020 2020 2020 2020  ttings).        
+0002de20: 2020 2020 6265 616d 2e4f 7074 6963 732e      beam.Optics.
+0002de30: 5365 7449 6d61 6765 526f 7461 7469 6f6e  SetImageRotation
+0002de40: 2876 616c 7565 290a 2020 2020 2020 2020  (value).        
+0002de50: 2020 2020 6c6f 6767 696e 672e 696e 666f      logging.info
+0002de60: 2866 227b 6265 616d 5f74 7970 652e 6e61  (f"{beam_type.na
+0002de70: 6d65 7d20 7363 616e 2072 6f74 6174 696f  me} scan rotatio
+0002de80: 6e20 7365 7420 746f 207b 7661 6c75 657d  n set to {value}
+0002de90: 2064 6567 7265 6573 2e22 290a 2020 2020   degrees.").    
+0002dea0: 2020 2020 2020 2020 7265 7475 726e 0a20          return. 
+0002deb0: 2020 2020 2020 2023 2062 6561 6d20 636f         # beam co
+0002dec0: 6e74 726f 6c0a 2020 2020 2020 2020 6966  ntrol.        if
+0002ded0: 206b 6579 203d 3d20 226f 6e22 3a0a 2020   key == "on":.  
+0002dee0: 2020 2020 2020 2020 2020 5f63 6865 636b            _check
+0002def0: 5f62 6561 6d28 6265 616d 5f74 7970 652c  _beam(beam_type,
+0002df00: 2073 656c 662e 6861 7264 7761 7265 5f73   self.hardware_s
+0002df10: 6574 7469 6e67 7329 0a20 2020 2020 2020  ettings).       
+0002df20: 2020 2020 2062 6561 6d2e 4265 616d 2e4f       beam.Beam.O
+0002df30: 6e28 2920 6966 2076 616c 7565 2065 6c73  n() if value els
+0002df40: 6520 6265 616d 2e42 6561 6d2e 4f66 6628  e beam.Beam.Off(
+0002df50: 290a 2020 2020 2020 2020 2020 2020 6c6f  ).            lo
+0002df60: 6767 696e 672e 696e 666f 2866 227b 6265  gging.info(f"{be
+0002df70: 616d 5f74 7970 652e 6e61 6d65 7d20 6265  am_type.name} be
+0002df80: 616d 2074 7572 6e65 6420 7b27 6f6e 2720  am turned {'on' 
+0002df90: 6966 2076 616c 7565 2065 6c73 6520 276f  if value else 'o
+0002dfa0: 6666 277d 2e22 290a 2020 2020 2020 2020  ff'}.").        
+0002dfb0: 2020 2020 7265 7475 726e 0a20 2020 2020      return.     
+0002dfc0: 2020 2069 6620 6b65 7920 3d3d 2022 7368     if key == "sh
+0002dfd0: 6966 7422 3a0a 2020 2020 2020 2020 2020  ift":.          
+0002dfe0: 2020 5f63 6865 636b 5f62 6561 6d28 6265    _check_beam(be
+0002dff0: 616d 5f74 7970 652c 2073 656c 662e 6861  am_type, self.ha
+0002e000: 7264 7761 7265 5f73 6574 7469 6e67 7329  rdware_settings)
+0002e010: 0a20 2020 2020 2020 2020 2020 2070 6f69  .            poi
+0002e020: 6e74 203d 2050 6f69 6e74 2876 616c 7565  nt = Point(value
+0002e030: 2e78 2a63 6f6e 7374 616e 7473 2e4d 4554  .x*constants.MET
+0002e040: 5245 5f54 4f5f 4d49 4c4c 494d 4554 5245  RE_TO_MILLIMETRE
+0002e050: 2c20 7661 6c75 652e 792a 636f 6e73 7461  , value.y*consta
+0002e060: 6e74 732e 4d45 5452 455f 544f 5f4d 494c  nts.METRE_TO_MIL
+0002e070: 4c49 4d45 5452 4529 0a20 2020 2020 2020  LIMETRE).       
+0002e080: 2020 2020 2062 6561 6d2e 4f70 7469 6373       beam.Optics
+0002e090: 2e53 6574 496d 6167 6553 6869 6674 2870  .SetImageShift(p
+0002e0a0: 6f69 6e74 2e78 2c20 706f 696e 742e 7929  oint.x, point.y)
+0002e0b0: 0a20 2020 2020 2020 2020 2020 206c 6f67  .            log
+0002e0c0: 6769 6e67 2e69 6e66 6f28 6622 7b62 6561  ging.info(f"{bea
+0002e0d0: 6d5f 7479 7065 2e6e 616d 657d 2062 6561  m_type.name} bea
+0002e0e0: 6d20 7368 6966 7420 7365 7420 746f 207b  m shift set to {
+0002e0f0: 7661 6c75 657d 2e22 290a 2020 2020 2020  value}.").      
+0002e100: 2020 2020 2020 7265 7475 726e 0a20 2020        return.   
+0002e110: 2020 2020 2023 2064 6574 6563 746f 7220       # detector 
+0002e120: 636f 6e74 726f 6c0a 2020 2020 2020 2020  control.        
+0002e130: 6966 206b 6579 203d 3d20 2264 6574 6563  if key == "detec
+0002e140: 746f 725f 7479 7065 223a 0a20 2020 2020  tor_type":.     
+0002e150: 2020 2020 2020 205f 6368 6563 6b5f 6265         _check_be
+0002e160: 616d 2862 6561 6d5f 7479 7065 2c20 7365  am(beam_type, se
+0002e170: 6c66 2e68 6172 6477 6172 655f 7365 7474  lf.hardware_sett
+0002e180: 696e 6773 290a 2020 2020 2020 2020 2020  ings).          
+0002e190: 2020 6966 2062 6561 6d5f 7479 7065 203d    if beam_type =
+0002e1a0: 3d20 4265 616d 5479 7065 2e45 4c45 4354  = BeamType.ELECT
+0002e1b0: 524f 4e3a 0a20 2020 2020 2020 2020 2020  RON:.           
+0002e1c0: 2020 2020 2073 656c 662e 656c 6563 7472       self.electr
+0002e1d0: 6f6e 5f64 6574 6563 746f 725f 6163 7469  on_detector_acti
+0002e1e0: 7665 203d 2076 616c 7565 0a20 2020 2020  ve = value.     
+0002e1f0: 2020 2020 2020 2020 2020 2062 6561 6d2e             beam.
+0002e200: 4465 7465 6374 6f72 2e53 6574 2843 6861  Detector.Set(Cha
+0002e210: 6e6e 656c 203d 2030 2c20 4465 7465 6374  nnel = 0, Detect
+0002e220: 6f72 203d 2076 616c 7565 290a 2020 2020  or = value).    
+0002e230: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0002e240: 2e65 6c65 6374 726f 6e5f 6465 7465 6374  .electron_detect
+0002e250: 6f72 5f61 6374 6976 6520 3d20 6265 616d  or_active = beam
+0002e260: 2e44 6574 6563 746f 722e 4765 7428 4368  .Detector.Get(Ch
+0002e270: 616e 6e65 6c20 3d20 3029 0a20 2020 2020  annel = 0).     
+0002e280: 2020 2020 2020 2020 2020 206c 6f67 6769             loggi
+0002e290: 6e67 2e69 6e66 6f28 6622 7b62 6561 6d5f  ng.info(f"{beam_
+0002e2a0: 7479 7065 7d20 6465 7465 6374 6f72 2074  type} detector t
+0002e2b0: 7970 6520 7365 7420 746f 207b 7661 6c75  ype set to {valu
+0002e2c0: 657d 2e22 290a 2020 2020 2020 2020 2020  e}.").          
+0002e2d0: 2020 2020 2020 7265 7475 726e 0a20 2020        return.   
+0002e2e0: 2020 2020 2020 2020 2065 6c69 6620 6265           elif be
+0002e2f0: 616d 5f74 7970 6520 3d3d 2042 6561 6d54  am_type == BeamT
+0002e300: 7970 652e 494f 4e3a 0a20 2020 2020 2020  ype.ION:.       
+0002e310: 2020 2020 2020 2020 2073 656c 662e 696f           self.io
+0002e320: 6e5f 6465 7465 6374 6f72 5f61 6374 6976  n_detector_activ
+0002e330: 6520 3d20 7661 6c75 650a 2020 2020 2020  e = value.      
+0002e340: 2020 2020 2020 2020 2020 6265 616d 2e44            beam.D
+0002e350: 6574 6563 746f 722e 5365 7428 4368 616e  etector.Set(Chan
+0002e360: 6e65 6c20 3d20 302c 2044 6574 6563 746f  nel = 0, Detecto
+0002e370: 7220 3d20 7661 6c75 6529 0a20 2020 2020  r = value).     
+0002e380: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0002e390: 696f 6e5f 6465 7465 6374 6f72 5f61 6374  ion_detector_act
+0002e3a0: 6976 6520 3d20 6265 616d 2e44 6574 6563  ive = beam.Detec
+0002e3b0: 746f 722e 4765 7428 4368 616e 6e65 6c20  tor.Get(Channel 
+0002e3c0: 3d20 3029 0a20 2020 2020 2020 2020 2020  = 0).           
+0002e3d0: 2020 2020 206c 6f67 6769 6e67 2e69 6e66       logging.inf
+0002e3e0: 6f28 6622 7b62 6561 6d5f 7479 7065 7d20  o(f"{beam_type} 
+0002e3f0: 6465 7465 6374 6f72 2074 7970 6520 7365  detector type se
+0002e400: 7420 746f 207b 7661 6c75 657d 2e22 290a  t to {value}.").
+0002e410: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e420: 7265 7475 726e 0a20 2020 2020 2020 2069  return.        i
+0002e430: 6620 6b65 7920 696e 205b 2264 6574 6563  f key in ["detec
+0002e440: 746f 725f 6272 6967 6874 6e65 7373 222c  tor_brightness",
+0002e450: 2022 6465 7465 6374 6f72 5f63 6f6e 7472   "detector_contr
+0002e460: 6173 7422 5d3a 0a20 2020 2020 2020 2020  ast"]:.         
+0002e470: 2020 205f 6368 6563 6b5f 6265 616d 2862     _check_beam(b
+0002e480: 6561 6d5f 7479 7065 2c20 7365 6c66 2e68  eam_type, self.h
+0002e490: 6172 6477 6172 655f 7365 7474 696e 6773  ardware_settings
+0002e4a0: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
+0002e4b0: 206b 6579 203d 3d20 2264 6574 6563 746f   key == "detecto
+0002e4c0: 725f 6272 6967 6874 6e65 7373 223a 0a20  r_brightness":. 
+0002e4d0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0002e4e0: 6620 3020 3c3d 2076 616c 7565 203c 3d20  f 0 <= value <= 
+0002e4f0: 313a 0a20 2020 2020 2020 2020 2020 2020  1:.             
+0002e500: 2020 2020 2020 2069 6620 6265 616d 5f74         if beam_t
+0002e510: 7970 6520 3d3d 2042 6561 6d54 7970 652e  ype == BeamType.
+0002e520: 454c 4543 5452 4f4e 3a0a 2020 2020 2020  ELECTRON:.      
+0002e530: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e540: 2020 6f67 5f63 6f6e 7472 6173 742c 206f    og_contrast, o
+0002e550: 675f 6272 6967 6874 6e65 7373 203d 2062  g_brightness = b
+0002e560: 6561 6d2e 4465 7465 6374 6f72 2e47 6574  eam.Detector.Get
+0002e570: 4761 696e 426c 6163 6b28 4465 7465 6374  GainBlack(Detect
+0002e580: 6f72 3d20 7365 6c66 2e65 6c65 6374 726f  or= self.electro
+0002e590: 6e5f 6465 7465 6374 6f72 5f61 6374 6976  n_detector_activ
+0002e5a0: 6529 0a20 2020 2020 2020 2020 2020 2020  e).             
+0002e5b0: 2020 2020 2020 2020 2020 2062 6561 6d2e             beam.
+0002e5c0: 4465 7465 6374 6f72 2e53 6574 4761 696e  Detector.SetGain
+0002e5d0: 426c 6163 6b28 4465 7465 6374 6f72 3d20  Black(Detector= 
+0002e5e0: 7365 6c66 2e65 6c65 6374 726f 6e5f 6465  self.electron_de
+0002e5f0: 7465 6374 6f72 5f61 6374 6976 652c 2047  tector_active, G
+0002e600: 6169 6e20 3d20 6f67 5f63 6f6e 7472 6173  ain = og_contras
+0002e610: 742c 2042 6c61 636b 203d 2076 616c 7565  t, Black = value
+0002e620: 2a31 3030 290a 2020 2020 2020 2020 2020  *100).          
+0002e630: 2020 2020 2020 2020 2020 2020 2020 6c6f                lo
+0002e640: 6767 696e 672e 696e 666f 2866 227b 6265  gging.info(f"{be
+0002e650: 616d 5f74 7970 657d 2064 6574 6563 746f  am_type} detecto
+0002e660: 7220 6272 6967 6874 6e65 7373 2073 6574  r brightness set
+0002e670: 2074 6f20 7b76 616c 7565 7d2e 2229 0a20   to {value}."). 
+0002e680: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e690: 2020 2065 6c69 6620 6265 616d 5f74 7970     elif beam_typ
+0002e6a0: 6520 3d3d 2042 6561 6d54 7970 652e 494f  e == BeamType.IO
+0002e6b0: 4e3a 0a20 2020 2020 2020 2020 2020 2020  N:.             
+0002e6c0: 2020 2020 2020 2020 2020 206f 675f 636f             og_co
+0002e6d0: 6e74 7261 7374 2c20 6f67 5f62 7269 6768  ntrast, og_brigh
+0002e6e0: 746e 6573 7320 3d20 6265 616d 2e44 6574  tness = beam.Det
+0002e6f0: 6563 746f 722e 4765 7447 6169 6e42 6c61  ector.GetGainBla
+0002e700: 636b 2844 6574 6563 746f 723d 2073 656c  ck(Detector= sel
+0002e710: 662e 696f 6e5f 6465 7465 6374 6f72 5f61  f.ion_detector_a
+0002e720: 6374 6976 6529 0a20 2020 2020 2020 2020  ctive).         
+0002e730: 2020 2020 2020 2020 2020 2020 2020 2062                 b
+0002e740: 6561 6d2e 4465 7465 6374 6f72 2e53 6574  eam.Detector.Set
+0002e750: 4761 696e 426c 6163 6b28 4465 7465 6374  GainBlack(Detect
+0002e760: 6f72 3d20 7365 6c66 2e69 6f6e 5f64 6574  or= self.ion_det
+0002e770: 6563 746f 725f 6163 7469 7665 2c20 4761  ector_active, Ga
+0002e780: 696e 203d 206f 675f 636f 6e74 7261 7374  in = og_contrast
+0002e790: 2c20 426c 6163 6b20 3d20 7661 6c75 652a  , Black = value*
+0002e7a0: 3130 3029 0a20 2020 2020 2020 2020 2020  100).           
+0002e7b0: 2020 2020 2020 2020 2020 2020 206c 6f67               log
+0002e7c0: 6769 6e67 2e69 6e66 6f28 6622 7b62 6561  ging.info(f"{bea
+0002e7d0: 6d5f 7479 7065 7d20 6465 7465 6374 6f72  m_type} detector
+0002e7e0: 2062 7269 6768 746e 6573 7320 7365 7420   brightness set 
+0002e7f0: 746f 207b 7661 6c75 657d 2e22 290a 2020  to {value}.").  
+0002e800: 2020 2020 2020 2020 2020 2020 2020 656c                el
+0002e810: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+0002e820: 2020 2020 2020 2020 6c6f 6767 696e 672e          logging.
+0002e830: 7761 726e 696e 6728 6622 496e 7661 6c69  warning(f"Invali
+0002e840: 6420 6272 6967 6874 6e65 7373 2076 616c  d brightness val
+0002e850: 7565 3a20 7b76 616c 7565 7d2c 206d 7573  ue: {value}, mus
+0002e860: 7420 6265 2062 6574 7765 656e 2030 2061  t be between 0 a
+0002e870: 6e64 2031 2e22 290a 2020 2020 2020 2020  nd 1.").        
+0002e880: 2020 2020 2020 2020 7265 7475 726e 200a          return .
+0002e890: 2020 2020 2020 2020 2020 2020 6966 206b              if k
+0002e8a0: 6579 203d 3d20 2264 6574 6563 746f 725f  ey == "detector_
+0002e8b0: 636f 6e74 7261 7374 223a 0a20 2020 2020  contrast":.     
+0002e8c0: 2020 2020 2020 2020 2020 2069 6620 3020             if 0 
+0002e8d0: 3c3d 2076 616c 7565 203c 3d20 313a 0a20  <= value <= 1:. 
+0002e8e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e8f0: 2020 2069 6620 6265 616d 5f74 7970 6520     if beam_type 
+0002e900: 3d3d 2042 6561 6d54 7970 652e 454c 4543  == BeamType.ELEC
+0002e910: 5452 4f4e 3a0a 2020 2020 2020 2020 2020  TRON:.          
+0002e920: 2020 2020 2020 2020 2020 2020 2020 6f67                og
+0002e930: 5f63 6f6e 7472 6173 742c 206f 675f 6272  _contrast, og_br
+0002e940: 6967 6874 6e65 7373 203d 2062 6561 6d2e  ightness = beam.
+0002e950: 4465 7465 6374 6f72 2e47 6574 4761 696e  Detector.GetGain
+0002e960: 426c 6163 6b28 4465 7465 6374 6f72 3d20  Black(Detector= 
+0002e970: 7365 6c66 2e65 6c65 6374 726f 6e5f 6465  self.electron_de
+0002e980: 7465 6374 6f72 5f61 6374 6976 6529 0a20  tector_active). 
+0002e990: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e9a0: 2020 2020 2020 2062 6561 6d2e 4465 7465         beam.Dete
+0002e9b0: 6374 6f72 2e53 6574 4761 696e 426c 6163  ctor.SetGainBlac
+0002e9c0: 6b28 4465 7465 6374 6f72 3d20 7365 6c66  k(Detector= self
+0002e9d0: 2e65 6c65 6374 726f 6e5f 6465 7465 6374  .electron_detect
+0002e9e0: 6f72 5f61 6374 6976 652c 2047 6169 6e20  or_active, Gain 
+0002e9f0: 3d20 7661 6c75 652a 3130 302c 2042 6c61  = value*100, Bla
+0002ea00: 636b 203d 206f 675f 6272 6967 6874 6e65  ck = og_brightne
+0002ea10: 7373 290a 2020 2020 2020 2020 2020 2020  ss).            
+0002ea20: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
+0002ea30: 696e 672e 696e 666f 2866 227b 6265 616d  ing.info(f"{beam
+0002ea40: 5f74 7970 657d 2064 6574 6563 746f 7220  _type} detector 
+0002ea50: 636f 6e74 7261 7374 2073 6574 2074 6f20  contrast set to 
+0002ea60: 7b76 616c 7565 7d2e 2229 0a20 2020 2020  {value}.").     
+0002ea70: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+0002ea80: 6c69 6620 6265 616d 5f74 7970 6520 3d3d  lif beam_type ==
+0002ea90: 2042 6561 6d54 7970 652e 494f 4e3a 0a20   BeamType.ION:. 
+0002eaa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002eab0: 2020 2020 2020 206f 675f 636f 6e74 7261         og_contra
+0002eac0: 7374 2c20 6f67 5f62 7269 6768 746e 6573  st, og_brightnes
+0002ead0: 7320 3d20 6265 616d 2e44 6574 6563 746f  s = beam.Detecto
+0002eae0: 722e 4765 7447 6169 6e42 6c61 636b 2844  r.GetGainBlack(D
+0002eaf0: 6574 6563 746f 723d 2073 656c 662e 696f  etector= self.io
+0002eb00: 6e5f 6465 7465 6374 6f72 5f61 6374 6976  n_detector_activ
+0002eb10: 6529 0a20 2020 2020 2020 2020 2020 2020  e).             
+0002eb20: 2020 2020 2020 2020 2020 2062 6561 6d2e             beam.
+0002eb30: 4465 7465 6374 6f72 2e53 6574 4761 696e  Detector.SetGain
+0002eb40: 426c 6163 6b28 4465 7465 6374 6f72 3d20  Black(Detector= 
+0002eb50: 7365 6c66 2e69 6f6e 5f64 6574 6563 746f  self.ion_detecto
+0002eb60: 725f 6163 7469 7665 2c20 4761 696e 203d  r_active, Gain =
+0002eb70: 2076 616c 7565 2a31 3030 2c20 426c 6163   value*100, Blac
+0002eb80: 6b20 3d20 6f67 5f62 7269 6768 746e 6573  k = og_brightnes
+0002eb90: 7329 0a20 2020 2020 2020 2020 2020 2020  s).             
+0002eba0: 2020 2020 2020 2020 2020 206c 6f67 6769             loggi
+0002ebb0: 6e67 2e69 6e66 6f28 6622 7b62 6561 6d5f  ng.info(f"{beam_
+0002ebc0: 7479 7065 7d20 6465 7465 6374 6f72 2063  type} detector c
+0002ebd0: 6f6e 7472 6173 7420 7365 7420 746f 207b  ontrast set to {
+0002ebe0: 7661 6c75 657d 2e22 290a 2020 2020 2020  value}.").      
+0002ebf0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+0002ec00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ec10: 2020 2020 6c6f 6767 696e 672e 7761 726e      logging.warn
+0002ec20: 696e 6728 6622 496e 7661 6c69 6420 636f  ing(f"Invalid co
+0002ec30: 6e74 7261 7374 2076 616c 7565 3a20 7b76  ntrast value: {v
+0002ec40: 616c 7565 7d2c 206d 7573 7420 6265 2062  alue}, must be b
+0002ec50: 6574 7765 656e 2030 2061 6e64 2031 2e22  etween 0 and 1."
+0002ec60: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0002ec70: 2020 7265 7475 726e 200a 0a20 2020 2020    return ..     
+0002ec80: 2020 2069 6620 6b65 7920 3d3d 2022 7072     if key == "pr
+0002ec90: 6573 6574 223a 0a20 2020 2020 2020 2020  eset":.         
+0002eca0: 2020 2062 6561 6d2e 5072 6573 6574 2e41     beam.Preset.A
+0002ecb0: 6374 6976 6174 6528 7661 6c75 6529 0a20  ctivate(value). 
+0002ecc0: 2020 2020 2020 2020 2020 206c 6f67 6769             loggi
+0002ecd0: 6e67 2e69 6e66 6f28 6622 5072 6573 6574  ng.info(f"Preset
+0002ece0: 207b 7661 6c75 657d 2061 6374 6976 6174   {value} activat
+0002ecf0: 6564 2066 6f72 207b 6265 616d 5f74 7970  ed for {beam_typ
+0002ed00: 657d 2e22 290a 2020 2020 2020 2020 2020  e}.").          
+0002ed10: 2020 7265 7475 726e 0a20 2020 2020 2020    return.       
+0002ed20: 2020 2020 2020 2020 2020 2020 200a 0a20               .. 
+0002ed30: 2020 2020 2020 206c 6f67 6769 6e67 2e77         logging.w
+0002ed40: 6172 6e69 6e67 2866 2255 6e6b 6e6f 776e  arning(f"Unknown
+0002ed50: 206b 6579 3a20 7b6b 6579 7d20 287b 6265   key: {key} ({be
+0002ed60: 616d 5f74 7970 657d 2922 290a 2020 2020  am_type})").    
+0002ed70: 2020 2020 7265 7475 726e 0a0a 2020 2020      return..    
+0002ed80: 6465 6620 6368 6563 6b5f 6176 6169 6c61  def check_availa
+0002ed90: 626c 655f 7661 6c75 6573 2873 656c 662c  ble_values(self,
+0002eda0: 206b 6579 3a20 7374 722c 2062 6561 6d5f   key: str, beam_
+0002edb0: 7479 7065 3a20 4265 616d 5479 7065 203d  type: BeamType =
+0002edc0: 204e 6f6e 6529 202d 3e20 626f 6f6c 3a0a   None) -> bool:.
+0002edd0: 2020 2020 2020 2020 7265 7475 726e 2046          return F
+0002ede0: 616c 7365 0a20 2020 200a 2020 2020 6465  alse.    .    de
+0002edf0: 6620 686f 6d65 2873 656c 6629 202d 3e20  f home(self) -> 
+0002ee00: 4e6f 6e65 3a0a 2020 2020 2020 2020 2320  None:.        # 
+0002ee10: 686f 6d65 203d 2046 6962 7365 6d53 7461  home = FibsemSta
+0002ee20: 6765 506f 7369 7469 6f6e 2878 3d30 2c20  gePosition(x=0, 
+0002ee30: 793d 302c 207a 3d30 2e30 3831 2c20 723d  y=0, z=0.081, r=
+0002ee40: 302c 2074 3d30 290a 2020 2020 2020 2020  0, t=0).        
+0002ee50: 2320 7365 6c66 2e6d 6f76 655f 7374 6167  # self.move_stag
+0002ee60: 655f 6162 736f 6c75 7465 2868 6f6d 6529  e_absolute(home)
+0002ee70: 0a20 2020 2020 2020 206c 6f67 6769 6e67  .        logging
+0002ee80: 2e69 6e66 6f28 6622 4e6f 2068 6f6d 696e  .info(f"No homin
+0002ee90: 6720 6176 6169 6c61 626c 652c 2070 6c65  g available, ple
+0002eea0: 6173 6520 7573 6520 6e61 7469 7665 2055  ase use native U
+0002eeb0: 492e 2229 0a20 2020 2020 2020 2072 6574  I.").        ret
+0002eec0: 7572 6e0a 0a23 2323 2323 2323 2323 2323  urn..###########
+0002eed0: 2323 2323 2323 2323 2323 2323 230a 636c  #############.cl
+0002eee0: 6173 7320 4465 6d6f 4d69 6372 6f73 636f  ass DemoMicrosco
+0002eef0: 7065 2846 6962 7365 6d4d 6963 726f 7363  pe(FibsemMicrosc
+0002ef00: 6f70 6529 3a0a 0a20 2020 2064 6566 205f  ope):..    def _
+0002ef10: 5f69 6e69 745f 5f28 7365 6c66 2c20 6861  _init__(self, ha
+0002ef20: 7264 7761 7265 5f73 6574 7469 6e67 733a  rdware_settings:
+0002ef30: 2046 6962 7365 6d48 6172 6477 6172 6520   FibsemHardware 
+0002ef40: 3d20 4e6f 6e65 2c20 7374 6167 655f 7365  = None, stage_se
+0002ef50: 7474 696e 6773 3a20 5374 6167 6553 6574  ttings: StageSet
+0002ef60: 7469 6e67 7320 3d20 4e6f 6e65 293a 2020  tings = None):  
+0002ef70: 2020 2020 2020 2020 2020 0a20 2020 2020            .     
+0002ef80: 2020 2073 656c 662e 636f 6e6e 6563 7469     self.connecti
+0002ef90: 6f6e 203d 204e 6f6e 650a 2020 2020 2020  on = None.      
+0002efa0: 2020 7365 6c66 2e73 7461 6765 5f70 6f73    self.stage_pos
+0002efb0: 6974 696f 6e20 3d20 4669 6273 656d 5374  ition = FibsemSt
+0002efc0: 6167 6550 6f73 6974 696f 6e28 783d 302c  agePosition(x=0,
+0002efd0: 2079 3d30 2c20 7a3d 302c 2072 3d30 2c20   y=0, z=0, r=0, 
+0002efe0: 743d 3029 0a20 2020 2020 2020 2073 656c  t=0).        sel
+0002eff0: 662e 6d61 6e69 7075 6c61 746f 725f 706f  f.manipulator_po
+0002f000: 7369 7469 6f6e 203d 2046 6962 7365 6d4d  sition = FibsemM
+0002f010: 616e 6970 756c 6174 6f72 506f 7369 7469  anipulatorPositi
+0002f020: 6f6e 2829 0a20 2020 2020 2020 2073 656c  on().        sel
+0002f030: 662e 656c 6563 7472 6f6e 5f62 6561 6d20  f.electron_beam 
+0002f040: 3d20 4265 616d 5365 7474 696e 6773 280a  = BeamSettings(.
+0002f050: 2020 2020 2020 2020 2020 2020 6265 616d              beam
+0002f060: 5f74 7970 653d 4265 616d 5479 7065 2e45  _type=BeamType.E
+0002f070: 4c45 4354 524f 4e2c 0a20 2020 2020 2020  LECTRON,.       
+0002f080: 2020 2020 2077 6f72 6b69 6e67 5f64 6973       working_dis
+0002f090: 7461 6e63 653d 342e 3065 2d33 2c0a 2020  tance=4.0e-3,.  
+0002f0a0: 2020 2020 2020 2020 2020 6265 616d 5f63            beam_c
+0002f0b0: 7572 7265 6e74 3d31 652d 3132 2c0a 2020  urrent=1e-12,.  
+0002f0c0: 2020 2020 2020 2020 2020 766f 6c74 6167            voltag
+0002f0d0: 653d 3230 3030 2c0a 2020 2020 2020 2020  e=2000,.        
+0002f0e0: 2020 2020 6866 773d 3135 3065 2d36 2c0a      hfw=150e-6,.
+0002f0f0: 2020 2020 2020 2020 2020 2020 7265 736f              reso
+0002f100: 6c75 7469 6f6e 3d5b 3135 3336 2c20 3130  lution=[1536, 10
+0002f110: 3234 5d2c 0a20 2020 2020 2020 2020 2020  24],.           
+0002f120: 2064 7765 6c6c 5f74 696d 653d 3165 2d36   dwell_time=1e-6
+0002f130: 2c0a 2020 2020 2020 2020 2020 2020 7374  ,.            st
+0002f140: 6967 6d61 7469 6f6e 3d50 6f69 6e74 2830  igmation=Point(0
+0002f150: 2c20 3029 2c0a 2020 2020 2020 2020 2020  , 0),.          
+0002f160: 2020 7368 6966 743d 506f 696e 7428 302c    shift=Point(0,
+0002f170: 2030 292c 0a20 2020 2020 2020 2020 2020   0),.           
+0002f180: 2073 6361 6e5f 726f 7461 7469 6f6e 3d30   scan_rotation=0
+0002f190: 2c0a 2020 2020 2020 2020 290a 2020 2020  ,.        ).    
+0002f1a0: 2020 2020 7365 6c66 2e69 6f6e 5f62 6561      self.ion_bea
+0002f1b0: 6d20 3d20 4265 616d 5365 7474 696e 6773  m = BeamSettings
+0002f1c0: 280a 2020 2020 2020 2020 2020 2020 6265  (.            be
+0002f1d0: 616d 5f74 7970 653d 4265 616d 5479 7065  am_type=BeamType
+0002f1e0: 2e49 4f4e 2c0a 2020 2020 2020 2020 2020  .ION,.          
+0002f1f0: 2020 776f 726b 696e 675f 6469 7374 616e    working_distan
+0002f200: 6365 3d31 362e 3565 2d33 2c0a 2020 2020  ce=16.5e-3,.    
+0002f210: 2020 2020 2020 2020 6265 616d 5f63 7572          beam_cur
+0002f220: 7265 6e74 3d32 3065 2d31 322c 200a 2020  rent=20e-12, .  
+0002f230: 2020 2020 2020 2020 2020 766f 6c74 6167            voltag
+0002f240: 653d 3330 3030 302c 0a20 2020 2020 2020  e=30000,.       
+0002f250: 2020 2020 2068 6677 3d31 3530 652d 362c       hfw=150e-6,
+0002f260: 0a20 2020 2020 2020 2020 2020 2072 6573  .            res
+0002f270: 6f6c 7574 696f 6e3d 5b31 3533 362c 2031  olution=[1536, 1
+0002f280: 3032 345d 2c0a 2020 2020 2020 2020 2020  024],.          
+0002f290: 2020 6477 656c 6c5f 7469 6d65 3d31 652d    dwell_time=1e-
+0002f2a0: 362c 0a20 2020 2020 2020 2020 2020 2073  6,.            s
+0002f2b0: 7469 676d 6174 696f 6e3d 506f 696e 7428  tigmation=Point(
+0002f2c0: 302c 2030 292c 0a20 2020 2020 2020 2020  0, 0),.         
+0002f2d0: 2020 2073 6869 6674 3d50 6f69 6e74 2830     shift=Point(0
+0002f2e0: 2c20 3029 2c0a 2020 2020 2020 2020 2020  , 0),.          
+0002f2f0: 2020 7363 616e 5f72 6f74 6174 696f 6e3d    scan_rotation=
+0002f300: 302c 0a20 2020 2020 2020 2029 0a0a 2020  0,.        )..  
+0002f310: 2020 2020 2020 7365 6c66 2e65 6c65 6374        self.elect
+0002f320: 726f 6e5f 6465 7465 6374 6f72 5f73 6574  ron_detector_set
+0002f330: 7469 6e67 7320 3d20 4669 6273 656d 4465  tings = FibsemDe
+0002f340: 7465 6374 6f72 5365 7474 696e 6773 280a  tectorSettings(.
+0002f350: 2020 2020 2020 2020 2020 2020 7479 7065              type
+0002f360: 3d22 4554 4422 2c0a 2020 2020 2020 2020  ="ETD",.        
+0002f370: 2020 2020 6d6f 6465 3d22 5365 636f 6e64      mode="Second
+0002f380: 6172 7945 6c65 6374 726f 6e73 222c 0a20  aryElectrons",. 
+0002f390: 2020 2020 2020 2020 2020 2062 7269 6768             brigh
+0002f3a0: 746e 6573 733d 302e 352c 0a20 2020 2020  tness=0.5,.     
+0002f3b0: 2020 2020 2020 2063 6f6e 7472 6173 743d         contrast=
+0002f3c0: 302e 352c 0a20 2020 2020 2020 2029 0a20  0.5,.        ). 
+0002f3d0: 2020 2020 2020 2073 656c 662e 696f 6e5f         self.ion_
+0002f3e0: 6465 7465 6374 6f72 5f73 6574 7469 6e67  detector_setting
+0002f3f0: 7320 3d20 4669 6273 656d 4465 7465 6374  s = FibsemDetect
+0002f400: 6f72 5365 7474 696e 6773 280a 2020 2020  orSettings(.    
+0002f410: 2020 2020 2020 2020 7479 7065 3d22 4554          type="ET
+0002f420: 4422 2c0a 2020 2020 2020 2020 2020 2020  D",.            
+0002f430: 6d6f 6465 3d22 5365 636f 6e64 6172 7945  mode="SecondaryE
+0002f440: 6c65 6374 726f 6e73 222c 0a20 2020 2020  lectrons",.     
+0002f450: 2020 2020 2020 2062 7269 6768 746e 6573         brightnes
+0002f460: 733d 302e 352c 0a20 2020 2020 2020 2020  s=0.5,.         
+0002f470: 2020 2063 6f6e 7472 6173 743d 302e 352c     contrast=0.5,
+0002f480: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
+0002f490: 2020 2069 6d70 6f72 7420 6669 6273 656d     import fibsem
+0002f4a0: 2e63 6f6e 6669 6720 6173 2063 6667 0a20  .config as cfg. 
+0002f4b0: 2020 2020 2020 2066 726f 6d20 6669 6273         from fibs
+0002f4c0: 656d 2e75 7469 6c73 2069 6d70 6f72 7420  em.utils import 
+0002f4d0: 6c6f 6164 5f70 726f 746f 636f 6c0a 2020  load_protocol.  
+0002f4e0: 2020 2020 2020 696d 706f 7274 206f 730a        import os.
+0002f4f0: 2020 2020 2020 2020 6966 2068 6172 6477          if hardw
+0002f500: 6172 655f 7365 7474 696e 6773 2069 7320  are_settings is 
+0002f510: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+0002f520: 2020 6469 6374 5f73 7973 7465 6d20 3d20    dict_system = 
+0002f530: 6c6f 6164 5f70 726f 746f 636f 6c28 6f73  load_protocol(os
+0002f540: 2e70 6174 682e 6a6f 696e 2863 6667 2e43  .path.join(cfg.C
+0002f550: 4f4e 4649 475f 5041 5448 2c20 2273 7973  ONFIG_PATH, "sys
+0002f560: 7465 6d2e 7961 6d6c 2229 290a 2020 2020  tem.yaml")).    
+0002f570: 2020 2020 2020 2020 7365 6c66 2e68 6172          self.har
+0002f580: 6477 6172 655f 7365 7474 696e 6773 203d  dware_settings =
+0002f590: 2046 6962 7365 6d48 6172 6477 6172 652e   FibsemHardware.
+0002f5a0: 5f5f 6672 6f6d 5f64 6963 745f 5f28 6469  __from_dict__(di
+0002f5b0: 6374 5f73 7973 7465 6d5b 226d 6f64 656c  ct_system["model
+0002f5c0: 225d 290a 2020 2020 2020 2020 656c 7365  "]).        else
+0002f5d0: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
+0002f5e0: 6c66 2e68 6172 6477 6172 655f 7365 7474  lf.hardware_sett
+0002f5f0: 696e 6773 203d 2068 6172 6477 6172 655f  ings = hardware_
+0002f600: 7365 7474 696e 6773 0a20 2020 2020 2020  settings.       
+0002f610: 2069 6620 7374 6167 655f 7365 7474 696e   if stage_settin
+0002f620: 6773 2069 7320 4e6f 6e65 3a0a 2020 2020  gs is None:.    
+0002f630: 2020 2020 2020 2020 6469 6374 5f73 7461          dict_sta
+0002f640: 6765 203d 206c 6f61 645f 7072 6f74 6f63  ge = load_protoc
+0002f650: 6f6c 286f 732e 7061 7468 2e6a 6f69 6e28  ol(os.path.join(
+0002f660: 6366 672e 434f 4e46 4947 5f50 4154 482c  cfg.CONFIG_PATH,
+0002f670: 2022 7379 7374 656d 2e79 616d 6c22 2929   "system.yaml"))
+0002f680: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+0002f690: 662e 7374 6167 655f 7365 7474 696e 6773  f.stage_settings
+0002f6a0: 203d 2053 7461 6765 5365 7474 696e 6773   = StageSettings
+0002f6b0: 2e5f 5f66 726f 6d5f 6469 6374 5f5f 2864  .__from_dict__(d
+0002f6c0: 6963 745f 7374 6167 655b 2273 7973 7465  ict_stage["syste
+0002f6d0: 6d22 5d5b 2273 7461 6765 225d 290a 2020  m"]["stage"]).  
+0002f6e0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+0002f6f0: 2020 2020 2020 2020 7365 6c66 2e73 7461          self.sta
+0002f700: 6765 5f73 6574 7469 6e67 7320 3d20 7374  ge_settings = st
+0002f710: 6167 655f 7365 7474 696e 6773 0a0a 0a0a  age_settings....
+0002f720: 2020 2020 6465 6620 636f 6e6e 6563 745f      def connect_
+0002f730: 746f 5f6d 6963 726f 7363 6f70 6528 7365  to_microscope(se
+0002f740: 6c66 293a 0a20 2020 2020 2020 206c 6f67  lf):.        log
+0002f750: 6769 6e67 2e69 6e66 6f28 6622 436f 6e6e  ging.info(f"Conn
+0002f760: 6563 7465 6420 746f 2044 656d 6f20 4d69  ected to Demo Mi
+0002f770: 6372 6f73 636f 7065 2229 0a20 2020 2020  croscope").     
+0002f780: 2020 206c 6f67 6769 6e67 2e69 6e66 6f28     logging.info(
+0002f790: 6622 4d69 6372 6f73 636f 7065 2063 6c69  f"Microscope cli
+0002f7a0: 656e 7420 636f 6e6e 6563 7465 6420 746f  ent connected to
+0002f7b0: 206d 6f64 656c 2044 656d 6f20 7769 7468   model Demo with
+0002f7c0: 2073 6572 6961 6c20 6e75 6d62 6572 2031   serial number 1
+0002f7d0: 3233 3435 3620 616e 6420 736f 6674 7761  23456 and softwa
+0002f7e0: 7265 2076 6572 7369 6f6e 2030 2e31 2229  re version 0.1")
+0002f7f0: 0a20 2020 2020 2020 2072 6574 7572 6e0a  .        return.
+0002f800: 0a20 2020 2064 6566 2064 6973 636f 6e6e  .    def disconn
+0002f810: 6563 7428 7365 6c66 293a 0a20 2020 2020  ect(self):.     
+0002f820: 2020 206c 6f67 6769 6e67 2e69 6e66 6f28     logging.info(
+0002f830: 6622 4469 7363 6f6e 6e65 6374 6564 2066  f"Disconnected f
+0002f840: 726f 6d20 4465 6d6f 204d 6963 726f 7363  rom Demo Microsc
+0002f850: 6f70 6522 290a 0a20 2020 2064 6566 2061  ope")..    def a
+0002f860: 6371 7569 7265 5f69 6d61 6765 2873 656c  cquire_image(sel
+0002f870: 662c 2069 6d61 6765 5f73 6574 7469 6e67  f, image_setting
+0002f880: 733a 2049 6d61 6765 5365 7474 696e 6773  s: ImageSettings
+0002f890: 2920 2d3e 2046 6962 7365 6d49 6d61 6765  ) -> FibsemImage
+0002f8a0: 3a0a 2020 2020 2020 2020 5f63 6865 636b  :.        _check
+0002f8b0: 5f62 6561 6d28 696d 6167 655f 7365 7474  _beam(image_sett
+0002f8c0: 696e 6773 2e62 6561 6d5f 7479 7065 2c20  ings.beam_type, 
+0002f8d0: 7365 6c66 2e68 6172 6477 6172 655f 7365  self.hardware_se
+0002f8e0: 7474 696e 6773 290a 2020 2020 2020 2020  ttings).        
+0002f8f0: 7666 7720 3d20 696d 6167 655f 7365 7474  vfw = image_sett
+0002f900: 696e 6773 2e68 6677 202a 2069 6d61 6765  ings.hfw * image
+0002f910: 5f73 6574 7469 6e67 732e 7265 736f 6c75  _settings.resolu
+0002f920: 7469 6f6e 5b31 5d20 2f20 696d 6167 655f  tion[1] / image_
+0002f930: 7365 7474 696e 6773 2e72 6573 6f6c 7574  settings.resolut
+0002f940: 696f 6e5b 305d 0a20 2020 2020 2020 2070  ion[0].        p
+0002f950: 6978 656c 7369 7a65 203d 2050 6f69 6e74  ixelsize = Point
+0002f960: 2869 6d61 6765 5f73 6574 7469 6e67 732e  (image_settings.
+0002f970: 6866 7720 2f20 696d 6167 655f 7365 7474  hfw / image_sett
+0002f980: 696e 6773 2e72 6573 6f6c 7574 696f 6e5b  ings.resolution[
+0002f990: 305d 2c20 0a20 2020 2020 2020 2020 2020  0], .           
+0002f9a0: 2020 2020 2020 2020 2020 2020 2020 2076                 v
+0002f9b0: 6677 202f 2069 6d61 6765 5f73 6574 7469  fw / image_setti
+0002f9c0: 6e67 732e 7265 736f 6c75 7469 6f6e 5b31  ngs.resolution[1
+0002f9d0: 5d29 0a20 2020 2020 2020 200a 2020 2020  ]).        .    
+0002f9e0: 2020 2020 6c6f 6767 696e 672e 696e 666f      logging.info
+0002f9f0: 2866 2241 6371 7569 7269 6e67 2069 6d61  (f"Acquiring ima
+0002fa00: 6765 3a20 7b69 6d61 6765 5f73 6574 7469  ge: {image_setti
+0002fa10: 6e67 732e 6265 616d 5f74 7970 657d 2229  ngs.beam_type}")
+0002fa20: 0a20 2020 2020 2020 2069 6d61 6765 203d  .        image =
+0002fa30: 2046 6962 7365 6d49 6d61 6765 280a 2020   FibsemImage(.  
+0002fa40: 2020 2020 2020 2020 2020 6461 7461 3d6e            data=n
+0002fa50: 702e 7261 6e64 6f6d 2e72 616e 6469 6e74  p.random.randint
+0002fa60: 286c 6f77 3d30 2c20 6869 6768 3d32 3536  (low=0, high=256
+0002fa70: 2c20 0a20 2020 2020 2020 2020 2020 2020  , .             
+0002fa80: 2020 2073 697a 653d 2869 6d61 6765 5f73     size=(image_s
+0002fa90: 6574 7469 6e67 732e 7265 736f 6c75 7469  ettings.resoluti
+0002faa0: 6f6e 5b31 5d2c 696d 6167 655f 7365 7474  on[1],image_sett
+0002fab0: 696e 6773 2e72 6573 6f6c 7574 696f 6e5b  ings.resolution[
+0002fac0: 305d 292c 200a 2020 2020 2020 2020 2020  0]), .          
+0002fad0: 2020 2020 2020 6474 7970 653d 6e70 2e75        dtype=np.u
+0002fae0: 696e 7438 292c 0a20 2020 2020 2020 2020  int8),.         
+0002faf0: 2020 206d 6574 6164 6174 613d 4669 6273     metadata=Fibs
+0002fb00: 656d 496d 6167 654d 6574 6164 6174 6128  emImageMetadata(
+0002fb10: 696d 6167 655f 7365 7474 696e 6773 3d69  image_settings=i
+0002fb20: 6d61 6765 5f73 6574 7469 6e67 732c 2070  mage_settings, p
+0002fb30: 6978 656c 5f73 697a 653d 7069 7865 6c73  ixel_size=pixels
+0002fb40: 697a 652c 0a20 2020 2020 2020 2020 2020  ize,.           
+0002fb50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002fb60: 2020 2020 2020 2020 2020 2020 2020 6d69                mi
+0002fb70: 6372 6f73 636f 7065 5f73 7461 7465 3d4d  croscope_state=M
+0002fb80: 6963 726f 7363 6f70 6553 7461 7465 2829  icroscopeState()
+0002fb90: 2c64 6574 6563 746f 725f 7365 7474 696e  ,detector_settin
+0002fba0: 6773 3d46 6962 7365 6d44 6574 6563 746f  gs=FibsemDetecto
+0002fbb0: 7253 6574 7469 6e67 7328 2929 290a 0a20  rSettings())).. 
+0002fbc0: 2020 2020 2020 2069 6620 696d 6167 655f         if image_
+0002fbd0: 7365 7474 696e 6773 2e62 6561 6d5f 7479  settings.beam_ty
+0002fbe0: 7065 2069 7320 4265 616d 5479 7065 2e45  pe is BeamType.E
+0002fbf0: 4c45 4354 524f 4e3a 0a20 2020 2020 2020  LECTRON:.       
+0002fc00: 2020 2020 2073 656c 662e 5f65 625f 696d       self._eb_im
+0002fc10: 6167 6520 3d20 696d 6167 650a 2020 2020  age = image.    
+0002fc20: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0002fc30: 2020 2020 2020 7365 6c66 2e5f 6962 5f69        self._ib_i
+0002fc40: 6d61 6765 203d 2069 6d61 6765 0a0a 2020  mage = image..  
+0002fc50: 2020 2020 2020 7265 7475 726e 2069 6d61        return ima
+0002fc60: 6765 0a0a 2020 2020 6465 6620 6c61 7374  ge..    def last
+0002fc70: 5f69 6d61 6765 2873 656c 662c 2062 6561  _image(self, bea
+0002fc80: 6d5f 7479 7065 3a20 4265 616d 5479 7065  m_type: BeamType
+0002fc90: 2920 2d3e 2046 6962 7365 6d49 6d61 6765  ) -> FibsemImage
+0002fca0: 3a0a 2020 2020 2020 2020 5f63 6865 636b  :.        _check
+0002fcb0: 5f62 6561 6d28 6265 616d 5f74 7970 652c  _beam(beam_type,
+0002fcc0: 2073 656c 662e 6861 7264 7761 7265 5f73   self.hardware_s
+0002fcd0: 6574 7469 6e67 7329 0a20 2020 2020 2020  ettings).       
+0002fce0: 206c 6f67 6769 6e67 2e69 6e66 6f28 6622   logging.info(f"
+0002fcf0: 4765 7474 696e 6720 6c61 7374 2069 6d61  Getting last ima
+0002fd00: 6765 3a20 7b62 6561 6d5f 7479 7065 7d22  ge: {beam_type}"
+0002fd10: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
+0002fd20: 2073 656c 662e 5f65 625f 696d 6167 6520   self._eb_image 
+0002fd30: 6966 2062 6561 6d5f 7479 7065 2069 7320  if beam_type is 
+0002fd40: 4265 616d 5479 7065 2e45 4c45 4354 524f  BeamType.ELECTRO
+0002fd50: 4e20 656c 7365 2073 656c 662e 5f69 625f  N else self._ib_
+0002fd60: 696d 6167 650a 2020 2020 0a20 2020 2064  image.    .    d
+0002fd70: 6566 2061 7574 6f63 6f6e 7472 6173 7428  ef autocontrast(
+0002fd80: 7365 6c66 2c20 6265 616d 5f74 7970 653a  self, beam_type:
+0002fd90: 2042 6561 6d54 7970 6529 202d 3e20 4e6f   BeamType) -> No
+0002fda0: 6e65 3a0a 2020 2020 2020 2020 5f63 6865  ne:.        _che
+0002fdb0: 636b 5f62 6561 6d28 6265 616d 5f74 7970  ck_beam(beam_typ
+0002fdc0: 652c 2073 656c 662e 6861 7264 7761 7265  e, self.hardware
+0002fdd0: 5f73 6574 7469 6e67 7329 0a20 2020 2020  _settings).     
+0002fde0: 2020 206c 6f67 6769 6e67 2e69 6e66 6f28     logging.info(
+0002fdf0: 6622 4175 746f 636f 6e74 7261 7374 3a20  f"Autocontrast: 
+0002fe00: 7b62 6561 6d5f 7479 7065 7d22 290a 0a20  {beam_type}").. 
+0002fe10: 2020 2064 6566 2061 7574 6f5f 666f 6375     def auto_focu
+0002fe20: 7328 7365 6c66 2c20 6265 616d 5f74 7970  s(self, beam_typ
+0002fe30: 653a 2042 6561 6d54 7970 6529 202d 3e20  e: BeamType) -> 
+0002fe40: 4e6f 6e65 3a0a 2020 2020 2020 2020 5f63  None:.        _c
+0002fe50: 6865 636b 5f62 6561 6d28 6265 616d 5f74  heck_beam(beam_t
+0002fe60: 7970 652c 2073 656c 662e 6861 7264 7761  ype, self.hardwa
+0002fe70: 7265 5f73 6574 7469 6e67 7329 0a20 2020  re_settings).   
+0002fe80: 2020 2020 206c 6f67 6769 6e67 2e69 6e66       logging.inf
+0002fe90: 6f28 6622 4175 746f 2066 6f63 7573 3a20  o(f"Auto focus: 
+0002fea0: 7b62 6561 6d5f 7479 7065 7d22 290a 2020  {beam_type}").  
+0002feb0: 2020 2020 2020 6c6f 6767 696e 672e 696e        logging.in
+0002fec0: 666f 2866 2249 276d 2066 6f63 7573 696e  fo(f"I'm focusin
+0002fed0: 6720 6d79 206c 6173 6572 2e2e 2e22 290a  g my laser...").
+0002fee0: 0a20 2020 2064 6566 2072 6573 6574 5f62  .    def reset_b
+0002fef0: 6561 6d5f 7368 6966 7473 2873 656c 6629  eam_shifts(self)
+0002ff00: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
+0002ff10: 2020 6c6f 6767 696e 672e 696e 666f 2866    logging.info(f
+0002ff20: 2252 6573 6574 7469 6e67 2062 6561 6d20  "Resetting beam 
+0002ff30: 7368 6966 7473 2229 0a20 2020 2020 2020  shifts").       
+0002ff40: 2073 656c 662e 656c 6563 7472 6f6e 5f62   self.electron_b
+0002ff50: 6561 6d2e 7368 6966 7420 3d20 506f 696e  eam.shift = Poin
+0002ff60: 7428 302c 3029 0a20 2020 2020 2020 2073  t(0,0).        s
+0002ff70: 656c 662e 696f 6e5f 6265 616d 2e73 6869  elf.ion_beam.shi
+0002ff80: 6674 203d 2050 6f69 6e74 2830 2c30 290a  ft = Point(0,0).
+0002ff90: 0a20 2020 2064 6566 2062 6561 6d5f 7368  .    def beam_sh
+0002ffa0: 6966 7428 7365 6c66 2c20 6478 3a20 666c  ift(self, dx: fl
+0002ffb0: 6f61 742c 2064 793a 2066 6c6f 6174 2c20  oat, dy: float, 
+0002ffc0: 6265 616d 5f74 7970 653a 2042 6561 6d54  beam_type: BeamT
+0002ffd0: 7970 6529 202d 3e20 4e6f 6e65 3a0a 2020  ype) -> None:.  
+0002ffe0: 2020 2020 2020 6265 616d 5f74 7970 6520        beam_type 
+0002fff0: 3d20 4265 616d 5479 7065 2e49 4f4e 2023  = BeamType.ION #
+00030000: 2054 4f44 4f3a 2061 6464 2062 6561 6d5f   TODO: add beam_
+00030010: 7479 7065 2074 6f20 7061 7261 6d73 2066  type to params f
+00030020: 6f72 2041 4243 0a20 2020 2020 2020 205f  or ABC.        _
+00030030: 6368 6563 6b5f 6265 616d 2862 6561 6d5f  check_beam(beam_
+00030040: 7479 7065 2c20 7365 6c66 2e68 6172 6477  type, self.hardw
+00030050: 6172 655f 7365 7474 696e 6773 290a 2020  are_settings).  
+00030060: 2020 2020 2020 6c6f 6767 696e 672e 696e        logging.in
+00030070: 666f 2866 2242 6561 6d20 7368 6966 743a  fo(f"Beam shift:
+00030080: 2064 783d 7b64 783a 2e32 657d 2c20 6479   dx={dx:.2e}, dy
+00030090: 3d7b 6479 3a2e 3265 7d20 287b 6265 616d  ={dy:.2e} ({beam
+000300a0: 5f74 7970 657d 2922 290a 2020 2020 2020  _type})").      
+000300b0: 2020 6c6f 6767 696e 672e 6465 6275 6728    logging.debug(
+000300c0: 6622 7b62 6561 6d5f 7479 7065 2e6e 616d  f"{beam_type.nam
+000300d0: 657d 207c 207b 6478 7d7c 7b64 797d 2229  e} | {dx}|{dy}")
+000300e0: 200a 2020 2020 2020 2020 6966 2062 6561   .        if bea
+000300f0: 6d5f 7479 7065 203d 3d20 4265 616d 5479  m_type == BeamTy
+00030100: 7065 2e45 4c45 4354 524f 4e3a 0a20 2020  pe.ELECTRON:.   
+00030110: 2020 2020 2020 2020 2073 656c 662e 656c           self.el
+00030120: 6563 7472 6f6e 5f62 6561 6d2e 7368 6966  ectron_beam.shif
+00030130: 7420 2b3d 2050 6f69 6e74 2864 782c 2064  t += Point(dx, d
+00030140: 7929 0a20 2020 2020 2020 2065 6c69 6620  y).        elif 
+00030150: 6265 616d 5f74 7970 6520 3d3d 2042 6561  beam_type == Bea
+00030160: 6d54 7970 652e 494f 4e3a 0a20 2020 2020  mType.ION:.     
+00030170: 2020 2020 2020 2073 656c 662e 696f 6e5f         self.ion_
+00030180: 6265 616d 2e73 6869 6674 202b 3d20 506f  beam.shift += Po
+00030190: 696e 7428 6478 2c20 6479 290a 0a20 2020  int(dx, dy)..   
+000301a0: 2064 6566 2067 6574 5f73 7461 6765 5f70   def get_stage_p
+000301b0: 6f73 6974 696f 6e28 7365 6c66 2920 2d3e  osition(self) ->
+000301c0: 2046 6962 7365 6d53 7461 6765 506f 7369   FibsemStagePosi
+000301d0: 7469 6f6e 3a0a 2020 2020 2020 2020 5f63  tion:.        _c
+000301e0: 6865 636b 5f73 7461 6765 2873 656c 662e  heck_stage(self.
+000301f0: 6861 7264 7761 7265 5f73 6574 7469 6e67  hardware_setting
+00030200: 7329 0a20 2020 2020 2020 206c 6f67 6769  s).        loggi
+00030210: 6e67 2e69 6e66 6f28 6622 4765 7474 696e  ng.info(f"Gettin
+00030220: 6720 7374 6167 6520 706f 7369 7469 6f6e  g stage position
+00030230: 3a20 7b73 656c 662e 7374 6167 655f 706f  : {self.stage_po
+00030240: 7369 7469 6f6e 7d22 290a 2020 2020 2020  sition}").      
+00030250: 2020 7265 7475 726e 2073 656c 662e 7374    return self.st
+00030260: 6167 655f 706f 7369 7469 6f6e 0a20 2020  age_position.   
+00030270: 200a 2020 2020 6465 6620 6765 745f 6375   .    def get_cu
+00030280: 7272 656e 745f 6d69 6372 6f73 636f 7065  rrent_microscope
+00030290: 5f73 7461 7465 2873 656c 6629 202d 3e20  _state(self) -> 
+000302a0: 4d69 6372 6f73 636f 7065 5374 6174 653a  MicroscopeState:
+000302b0: 0a20 2020 2020 2020 205f 6368 6563 6b5f  .        _check_
+000302c0: 7374 6167 6528 7365 6c66 2e68 6172 6477  stage(self.hardw
+000302d0: 6172 655f 7365 7474 696e 6773 290a 2020  are_settings).  
+000302e0: 2020 2020 2020 6c6f 6767 696e 672e 696e        logging.in
+000302f0: 666f 2866 2247 6574 7469 6e67 206d 6963  fo(f"Getting mic
+00030300: 726f 7363 6f70 6520 7374 6174 6522 290a  roscope state").
+00030310: 2020 2020 2020 2020 7265 7475 726e 204d          return M
+00030320: 6963 726f 7363 6f70 6553 7461 7465 2861  icroscopeState(a
+00030330: 6273 6f6c 7574 655f 706f 7369 7469 6f6e  bsolute_position
+00030340: 3d73 656c 662e 7374 6167 655f 706f 7369  =self.stage_posi
+00030350: 7469 6f6e 290a 0a20 2020 2064 6566 205f  tion)..    def _
+00030360: 7361 6665 5f61 6273 6f6c 7574 655f 7374  safe_absolute_st
+00030370: 6167 655f 6d6f 7665 6d65 6e74 2873 656c  age_movement(sel
+00030380: 662c 2073 7461 6765 5f70 6f73 6974 696f  f, stage_positio
+00030390: 6e3a 2046 6962 7365 6d53 7461 6765 506f  n: FibsemStagePo
+000303a0: 7369 7469 6f6e 2920 2d3e 204e 6f6e 653a  sition) -> None:
+000303b0: 0a0a 2020 2020 2020 2020 7365 6c66 2e6d  ..        self.m
+000303c0: 6f76 655f 7374 6167 655f 6162 736f 6c75  ove_stage_absolu
+000303d0: 7465 2873 7461 6765 5f70 6f73 6974 696f  te(stage_positio
+000303e0: 6e29 0a0a 2020 2020 6465 6620 5f63 616c  n)..    def _cal
+000303f0: 6375 6c61 7465 5f6e 6577 5f70 6f73 6974  culate_new_posit
+00030400: 696f 6e28 7365 6c66 2c20 7365 7474 696e  ion(self, settin
+00030410: 6773 3a20 4d69 6372 6f73 636f 7065 5365  gs: MicroscopeSe
+00030420: 7474 696e 6773 2c20 6478 3a66 6c6f 6174  ttings, dx:float
+00030430: 2c20 6479 3a66 6c6f 6174 2c20 6265 616d  , dy:float, beam
+00030440: 5f74 7970 653a 4265 616d 5479 7065 2c20  _type:BeamType, 
+00030450: 6261 7365 5f70 6f73 6974 696f 6e3a 4669  base_position:Fi
+00030460: 6273 656d 5374 6167 6550 6f73 6974 696f  bsemStagePositio
+00030470: 6e29 202d 3e20 4669 6273 656d 5374 6167  n) -> FibsemStag
+00030480: 6550 6f73 6974 696f 6e3a 0a0a 2020 2020  ePosition:..    
+00030490: 2020 2020 7265 7475 726e 2062 6173 655f      return base_
+000304a0: 706f 7369 7469 6f6e 202b 2046 6962 7365  position + Fibse
+000304b0: 6d53 7461 6765 506f 7369 7469 6f6e 2878  mStagePosition(x
+000304c0: 3d64 782c 2079 3d64 7929 2023 2054 4f44  =dx, y=dy) # TOD
+000304d0: 4f3a 2069 6d70 6c65 6d65 6e74 0a0a 2020  O: implement..  
+000304e0: 2020 6465 6620 6d6f 7665 5f73 7461 6765    def move_stage
+000304f0: 5f61 6273 6f6c 7574 6528 7365 6c66 2c20  _absolute(self, 
+00030500: 706f 7369 7469 6f6e 3a20 4669 6273 656d  position: Fibsem
+00030510: 5374 6167 6550 6f73 6974 696f 6e29 202d  StagePosition) -
+00030520: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
+00030530: 6966 2070 6f73 6974 696f 6e2e 7220 6973  if position.r is
+00030540: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+00030550: 2020 2072 6f74 6174 696f 6e20 3d20 5472     rotation = Tr
+00030560: 7565 0a20 2020 2020 2020 2065 6c73 653a  ue.        else:
+00030570: 0a20 2020 2020 2020 2020 2020 2072 6f74  .            rot
+00030580: 6174 696f 6e20 3d20 4661 6c73 650a 2020  ation = False.  
+00030590: 2020 2020 2020 6966 2070 6f73 6974 696f        if positio
+000305a0: 6e2e 7420 6973 204e 6f6e 653a 0a20 2020  n.t is None:.   
+000305b0: 2020 2020 2020 2020 2074 696c 7420 3d20           tilt = 
+000305c0: 5472 7565 0a20 2020 2020 2020 2065 6c73  True.        els
+000305d0: 653a 0a20 2020 2020 2020 2020 2020 2074  e:.            t
+000305e0: 696c 7420 3d20 4661 6c73 650a 2020 2020  ilt = False.    
+000305f0: 2020 2020 5f63 6865 636b 5f73 7461 6765      _check_stage
+00030600: 2873 656c 662e 6861 7264 7761 7265 5f73  (self.hardware_s
+00030610: 6574 7469 6e67 732c 2072 6f74 6174 696f  ettings, rotatio
+00030620: 6e3d 726f 7461 7469 6f6e 2c20 7469 6c74  n=rotation, tilt
+00030630: 3d74 696c 7429 0a20 2020 2020 2020 206c  =tilt).        l
+00030640: 6f67 6769 6e67 2e69 6e66 6f28 6622 4d6f  ogging.info(f"Mo
+00030650: 7669 6e67 2073 7461 6765 3a20 7b70 6f73  ving stage: {pos
+00030660: 6974 696f 6e7d 2028 4162 736f 6c75 7465  ition} (Absolute
+00030670: 2922 290a 2020 2020 2020 2020 7365 6c66  )").        self
+00030680: 2e73 7461 6765 5f70 6f73 6974 696f 6e20  .stage_position 
+00030690: 3d20 706f 7369 7469 6f6e 0a0a 2020 2020  = position..    
+000306a0: 6465 6620 6d6f 7665 5f73 7461 6765 5f72  def move_stage_r
+000306b0: 656c 6174 6976 6528 7365 6c66 2c20 706f  elative(self, po
+000306c0: 7369 7469 6f6e 3a20 4669 6273 656d 5374  sition: FibsemSt
+000306d0: 6167 6550 6f73 6974 696f 6e29 202d 3e20  agePosition) -> 
+000306e0: 4e6f 6e65 3a0a 2020 2020 2020 2020 6966  None:.        if
+000306f0: 2070 6f73 6974 696f 6e2e 7220 6973 206e   position.r is n
+00030700: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
+00030710: 2020 2020 2072 6f74 6174 696f 6e20 3d20       rotation = 
+00030720: 5472 7565 0a20 2020 2020 2020 2065 6c73  True.        els
+00030730: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
+00030740: 6f74 6174 696f 6e20 3d20 4661 6c73 650a  otation = False.
+00030750: 2020 2020 2020 2020 6966 2070 6f73 6974          if posit
+00030760: 696f 6e2e 7420 6973 206e 6f74 204e 6f6e  ion.t is not Non
+00030770: 653a 0a20 2020 2020 2020 2020 2020 2074  e:.            t
+00030780: 696c 7420 3d20 5472 7565 0a20 2020 2020  ilt = True.     
+00030790: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+000307a0: 2020 2020 2074 696c 7420 3d20 4661 6c73       tilt = Fals
+000307b0: 650a 2020 2020 2020 2020 5f63 6865 636b  e.        _check
+000307c0: 5f73 7461 6765 2873 656c 662e 6861 7264  _stage(self.hard
+000307d0: 7761 7265 5f73 6574 7469 6e67 732c 2072  ware_settings, r
+000307e0: 6f74 6174 696f 6e3d 726f 7461 7469 6f6e  otation=rotation
+000307f0: 2c20 7469 6c74 3d74 696c 7429 0a20 2020  , tilt=tilt).   
+00030800: 2020 2020 206c 6f67 6769 6e67 2e69 6e66       logging.inf
+00030810: 6f28 6622 4d6f 7669 6e67 2073 7461 6765  o(f"Moving stage
+00030820: 3a20 7b70 6f73 6974 696f 6e7d 2028 5265  : {position} (Re
+00030830: 6c61 7469 7665 2922 290a 2020 2020 2020  lative)").      
+00030840: 2020 7365 6c66 2e73 7461 6765 5f70 6f73    self.stage_pos
+00030850: 6974 696f 6e20 2b3d 2070 6f73 6974 696f  ition += positio
+00030860: 6e0a 0a20 2020 2064 6566 2073 7461 626c  n..    def stabl
+00030870: 655f 6d6f 7665 2873 656c 662c 2073 6574  e_move(self, set
+00030880: 7469 6e67 733a 204d 6963 726f 7363 6f70  tings: Microscop
+00030890: 6553 6574 7469 6e67 732c 2064 783a 2066  eSettings, dx: f
+000308a0: 6c6f 6174 2c20 6479 3a66 6c6f 6174 2c20  loat, dy:float, 
+000308b0: 6265 616d 5f74 7970 653a 2042 6561 6d54  beam_type: BeamT
+000308c0: 7970 652c 205f 6669 7865 643a 2062 6f6f  ype, _fixed: boo
+000308d0: 6c3d 4661 6c73 6529 202d 3e20 4e6f 6e65  l=False) -> None
+000308e0: 3a0a 2020 2020 2020 2020 5f63 6865 636b  :.        _check
+000308f0: 5f73 7461 6765 2873 656c 662e 6861 7264  _stage(self.hard
+00030900: 7761 7265 5f73 6574 7469 6e67 7329 0a20  ware_settings). 
+00030910: 2020 2020 2020 2070 7265 5f74 696c 7420         pre_tilt 
+00030920: 3d20 6e70 2e64 6567 3272 6164 2873 656c  = np.deg2rad(sel
+00030930: 662e 7374 6167 655f 7365 7474 696e 6773  f.stage_settings
+00030940: 2e70 7265 5f74 696c 7429 0a20 2020 2020  .pre_tilt).     
+00030950: 2020 200a 2020 2020 2020 2020 7374 6167     .        stag
+00030960: 655f 706f 7369 7469 6f6e 203d 2046 6962  e_position = Fib
+00030970: 7365 6d53 7461 6765 506f 7369 7469 6f6e  semStagePosition
+00030980: 280a 2020 2020 2020 2020 2020 2020 783d  (.            x=
+00030990: 666c 6f61 7428 6478 292c 0a20 2020 2020  float(dx),.     
+000309a0: 2020 2020 2020 2079 3d66 6c6f 6174 2864         y=float(d
+000309b0: 792a 6e70 2e63 6f73 2870 7265 5f74 696c  y*np.cos(pre_til
+000309c0: 7429 292c 0a20 2020 2020 2020 2020 2020  t)),.           
+000309d0: 207a 3d66 6c6f 6174 2864 792a 6e70 2e73   z=float(dy*np.s
+000309e0: 696e 2870 7265 5f74 696c 7429 292c 0a20  in(pre_tilt)),. 
+000309f0: 2020 2020 2020 2020 2020 2072 3d30 2c0a             r=0,.
+00030a00: 2020 2020 2020 2020 2020 2020 743d 302c              t=0,
+00030a10: 0a20 2020 2020 2020 2020 2020 2063 6f6f  .            coo
+00030a20: 7264 696e 6174 655f 7379 7374 656d 3d22  rdinate_system="
+00030a30: 5241 5722 2c0a 2020 2020 2020 2020 290a  RAW",.        ).
+00030a40: 0a20 2020 2020 2020 206c 6f67 6769 6e67  .        logging
+00030a50: 2e69 6e66 6f28 6622 4d6f 7669 6e67 2073  .info(f"Moving s
+00030a60: 7461 6765 3a20 7b73 7461 6765 5f70 6f73  tage: {stage_pos
+00030a70: 6974 696f 6e7d 2c20 6265 616d 5f74 7970  ition}, beam_typ
+00030a80: 6520 3d20 7b62 6561 6d5f 7479 7065 2e6e  e = {beam_type.n
+00030a90: 616d 657d 2028 5374 6162 6c65 2922 290a  ame} (Stable)").
+00030aa0: 0a20 2020 2020 2020 2073 656c 662e 7374  .        self.st
+00030ab0: 6167 655f 706f 7369 7469 6f6e 202b 3d20  age_position += 
+00030ac0: 7374 6167 655f 706f 7369 7469 6f6e 0a20  stage_position. 
+00030ad0: 2020 2020 2020 2072 6574 7572 6e20 7374         return st
+00030ae0: 6167 655f 706f 7369 7469 6f6e 0a0a 0a20  age_position... 
+00030af0: 2020 2064 6566 2065 7563 656e 7472 6963     def eucentric
+00030b00: 5f6d 6f76 6528 7365 6c66 2c20 7365 7474  _move(self, sett
+00030b10: 696e 6773 3a4d 6963 726f 7363 6f70 6553  ings:MicroscopeS
+00030b20: 6574 7469 6e67 732c 2064 793a 2066 6c6f  ettings, dy: flo
+00030b30: 6174 2c20 7374 6174 6963 5f77 643a 2062  at, static_wd: b
+00030b40: 6f6f 6c3d 5472 7565 2920 2d3e 204e 6f6e  ool=True) -> Non
+00030b50: 653a 0a20 2020 2020 2020 205f 6368 6563  e:.        _chec
+00030b60: 6b5f 7374 6167 6528 7365 6c66 2e68 6172  k_stage(self.har
+00030b70: 6477 6172 655f 7365 7474 696e 6773 290a  dware_settings).
+00030b80: 2020 2020 2020 2020 6c6f 6767 696e 672e          logging.
+00030b90: 696e 666f 2866 224d 6f76 696e 6720 7374  info(f"Moving st
+00030ba0: 6167 653a 2064 793d 7b64 793a 2e32 657d  age: dy={dy:.2e}
+00030bb0: 2028 4575 6365 6e74 7269 6329 2229 0a20   (Eucentric)"). 
+00030bc0: 2020 2020 2020 2073 656c 662e 7374 6167         self.stag
+00030bd0: 655f 706f 7369 7469 6f6e 2e7a 202b 3d20  e_position.z += 
+00030be0: 6479 202f 206e 702e 636f 7328 6e70 2e64  dy / np.cos(np.d
+00030bf0: 6567 3272 6164 2839 302d 7365 6c66 2e73  eg2rad(90-self.s
+00030c00: 7461 6765 5f73 6574 7469 6e67 732e 7469  tage_settings.ti
+00030c10: 6c74 5f66 6c61 745f 746f 5f69 6f6e 2929  lt_flat_to_ion))
+00030c20: 0a0a 2020 2020 6465 6620 6d6f 7665 5f66  ..    def move_f
+00030c30: 6c61 745f 746f 5f62 6561 6d28 7365 6c66  lat_to_beam(self
+00030c40: 2c20 7365 7474 696e 6773 3a20 4d69 6372  , settings: Micr
+00030c50: 6f73 636f 7065 5365 7474 696e 6773 2c20  oscopeSettings, 
+00030c60: 6265 616d 5f74 7970 653a 2042 6561 6d54  beam_type: BeamT
+00030c70: 7970 6529 202d 3e20 4e6f 6e65 3a0a 2020  ype) -> None:.  
+00030c80: 2020 2020 2020 5f63 6865 636b 5f73 7461        _check_sta
+00030c90: 6765 2873 656c 662e 6861 7264 7761 7265  ge(self.hardware
+00030ca0: 5f73 6574 7469 6e67 732c 2074 696c 7420  _settings, tilt 
+00030cb0: 3d20 5472 7565 290a 2020 2020 2020 2020  = True).        
+00030cc0: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
+00030cd0: 2069 6620 6265 616d 5f74 7970 6520 6973   if beam_type is
+00030ce0: 2042 6561 6d54 7970 652e 454c 4543 5452   BeamType.ELECTR
+00030cf0: 4f4e 3a0a 2020 2020 2020 2020 2020 2020  ON:.            
+00030d00: 7220 3d20 7365 6c66 2e73 7461 6765 5f73  r = self.stage_s
+00030d10: 6574 7469 6e67 732e 7469 6c74 5f66 6c61  ettings.tilt_fla
+00030d20: 745f 746f 5f65 6c65 6374 726f 6e0a 2020  t_to_electron.  
+00030d30: 2020 2020 2020 2020 2020 7420 3d20 7365            t = se
+00030d40: 6c66 2e73 7461 6765 5f73 6574 7469 6e67  lf.stage_setting
+00030d50: 732e 7469 6c74 5f66 6c61 745f 746f 5f65  s.tilt_flat_to_e
+00030d60: 6c65 6374 726f 6e0a 2020 2020 2020 2020  lectron.        
+00030d70: 6966 2062 6561 6d5f 7479 7065 2069 7320  if beam_type is 
+00030d80: 4265 616d 5479 7065 2e49 4f4e 3a0a 2020  BeamType.ION:.  
+00030d90: 2020 2020 2020 2020 2020 7220 3d20 7365            r = se
+00030da0: 6c66 2e73 7461 6765 5f73 6574 7469 6e67  lf.stage_setting
+00030db0: 732e 7469 6c74 5f66 6c61 745f 746f 5f69  s.tilt_flat_to_i
+00030dc0: 6f6e 0a20 2020 2020 2020 2020 2020 2074  on.            t
+00030dd0: 203d 2073 656c 662e 7374 6167 655f 7365   = self.stage_se
+00030de0: 7474 696e 6773 2e74 696c 745f 666c 6174  ttings.tilt_flat
+00030df0: 5f74 6f5f 696f 6e0a 0a20 2020 2020 2020  _to_ion..       
+00030e00: 2023 2070 7265 2d74 696c 7420 6164 6a75   # pre-tilt adju
+00030e10: 7374 6d65 6e74 0a20 2020 2020 2020 2074  stment.        t
+00030e20: 2020 3d20 7420 2d20 7365 6c66 2e73 7461    = t - self.sta
+00030e30: 6765 5f73 6574 7469 6e67 732e 7072 655f  ge_settings.pre_
+00030e40: 7469 6c74 0a20 2020 2020 2020 200a 2020  tilt.        .  
+00030e50: 2020 2020 2020 6c6f 6767 696e 672e 696e        logging.in
+00030e60: 666f 2866 224d 6f76 696e 6720 7374 6167  fo(f"Moving stag
+00030e70: 653a 2046 6c61 7420 746f 207b 6265 616d  e: Flat to {beam
+00030e80: 5f74 7970 652e 6e61 6d65 7d20 6265 616d  _type.name} beam
+00030e90: 2c20 723d 7b72 3a2e 3266 7d2c 2074 3d7b  , r={r:.2f}, t={
+00030ea0: 743a 2e32 667d 2922 290a 0a20 2020 2020  t:.2f})")..     
+00030eb0: 2020 2073 656c 662e 7374 6167 655f 706f     self.stage_po
+00030ec0: 7369 7469 6f6e 2e72 203d 206e 702e 6465  sition.r = np.de
+00030ed0: 6732 7261 6428 7229 0a20 2020 2020 2020  g2rad(r).       
+00030ee0: 2073 656c 662e 7374 6167 655f 706f 7369   self.stage_posi
+00030ef0: 7469 6f6e 2e74 203d 206e 702e 6465 6732  tion.t = np.deg2
+00030f00: 7261 6428 7429 0a20 2020 200a 2020 2020  rad(t).    .    
+00030f10: 6465 6620 6765 745f 6d61 6e69 7075 6c61  def get_manipula
+00030f20: 746f 725f 706f 7369 7469 6f6e 2873 656c  tor_position(sel
+00030f30: 6629 202d 3e20 4669 6273 656d 4d61 6e69  f) -> FibsemMani
+00030f40: 7075 6c61 746f 7250 6f73 6974 696f 6e3a  pulatorPosition:
+00030f50: 0a20 2020 2020 2020 205f 6368 6563 6b5f  .        _check_
+00030f60: 6e65 6564 6c65 2873 656c 662e 6861 7264  needle(self.hard
+00030f70: 7761 7265 5f73 6574 7469 6e67 7329 0a20  ware_settings). 
+00030f80: 2020 2020 2020 206c 6f67 6769 6e67 2e69         logging.i
+00030f90: 6e66 6f28 6622 4765 7474 696e 6720 6d61  nfo(f"Getting ma
+00030fa0: 6e69 7075 6c61 746f 7220 706f 7369 7469  nipulator positi
+00030fb0: 6f6e 3a20 7b73 656c 662e 6d61 6e69 7075  on: {self.manipu
+00030fc0: 6c61 746f 725f 706f 7369 7469 6f6e 7d22  lator_position}"
+00030fd0: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
+00030fe0: 2073 656c 662e 6d61 6e69 7075 6c61 746f   self.manipulato
+00030ff0: 725f 706f 7369 7469 6f6e 0a0a 2020 2020  r_position..    
+00031000: 6465 6620 6765 745f 6d61 6e69 7075 6c61  def get_manipula
+00031010: 746f 725f 7374 6174 6528 7365 6c66 2c73  tor_state(self,s
+00031020: 6574 7469 6e67 733a 4d69 6372 6f73 636f  ettings:Microsco
+00031030: 7065 5365 7474 696e 6773 3d4e 6f6e 6529  peSettings=None)
+00031040: 202d 3e20 626f 6f6c 3a0a 2020 2020 2020   -> bool:.      
+00031050: 2020 5f63 6865 636b 5f6e 6565 646c 6528    _check_needle(
+00031060: 7365 6c66 2e68 6172 6477 6172 655f 7365  self.hardware_se
+00031070: 7474 696e 6773 290a 2020 2020 2020 2020  ttings).        
+00031080: 6966 2073 656c 662e 6d61 6e69 7075 6c61  if self.manipula
+00031090: 746f 725f 706f 7369 7469 6f6e 2e78 203d  tor_position.x =
+000310a0: 3d20 3020 616e 6420 7365 6c66 2e6d 616e  = 0 and self.man
+000310b0: 6970 756c 6174 6f72 5f70 6f73 6974 696f  ipulator_positio
+000310c0: 6e2e 7920 3d3d 2030 2061 6e64 2073 656c  n.y == 0 and sel
+000310d0: 662e 6d61 6e69 7075 6c61 746f 725f 706f  f.manipulator_po
+000310e0: 7369 7469 6f6e 2e7a 203d 3d20 303a 0a20  sition.z == 0:. 
+000310f0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00031100: 6d61 6e69 7075 6c61 746f 725f 7374 6174  manipulator_stat
+00031110: 6520 3d20 4661 6c73 650a 2020 2020 2020  e = False.      
+00031120: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00031130: 2020 2020 7365 6c66 2e6d 616e 6970 756c      self.manipul
+00031140: 6174 6f72 5f73 7461 7465 203d 2054 7275  ator_state = Tru
+00031150: 650a 2020 2020 2020 2020 0a20 2020 2020  e.        .     
+00031160: 2020 206c 6f67 6769 6e67 2e69 6e66 6f28     logging.info(
+00031170: 6622 4765 7474 696e 6720 6d61 6e69 7075  f"Getting manipu
+00031180: 6c61 746f 7220 7374 6174 653a 207b 7365  lator state: {se
+00031190: 6c66 2e6d 616e 6970 756c 6174 6f72 5f73  lf.manipulator_s
+000311a0: 7461 7465 7d22 290a 2020 2020 2020 2020  tate}").        
+000311b0: 7265 7475 726e 2073 656c 662e 6d61 6e69  return self.mani
+000311c0: 7075 6c61 746f 725f 7374 6174 650a 0a20  pulator_state.. 
+000311d0: 2020 2064 6566 2069 6e73 6572 745f 6d61     def insert_ma
+000311e0: 6e69 7075 6c61 746f 7228 7365 6c66 2c20  nipulator(self, 
+000311f0: 6e61 6d65 3a20 7374 7220 3d20 2250 4152  name: str = "PAR
+00031200: 4b22 293a 0a20 2020 2020 2020 205f 6368  K"):.        _ch
+00031210: 6563 6b5f 6e65 6564 6c65 2873 656c 662e  eck_needle(self.
+00031220: 6861 7264 7761 7265 5f73 6574 7469 6e67  hardware_setting
+00031230: 7329 0a20 2020 2020 2020 206c 6f67 6769  s).        loggi
+00031240: 6e67 2e69 6e66 6f28 6622 496e 7365 7274  ng.info(f"Insert
+00031250: 696e 6720 6d61 6e69 7075 6c61 746f 7220  ing manipulator 
+00031260: 746f 207b 6e61 6d65 7d22 290a 2020 2020  to {name}").    
+00031270: 0a20 2020 2064 6566 2072 6574 7261 6374  .    def retract
+00031280: 5f6d 616e 6970 756c 6174 6f72 2873 656c  _manipulator(sel
+00031290: 6629 3a0a 2020 2020 2020 2020 5f63 6865  f):.        _che
+000312a0: 636b 5f6e 6565 646c 6528 7365 6c66 2e68  ck_needle(self.h
+000312b0: 6172 6477 6172 655f 7365 7474 696e 6773  ardware_settings
+000312c0: 290a 2020 2020 2020 2020 6c6f 6767 696e  ).        loggin
+000312d0: 672e 696e 666f 2866 2252 6574 7261 6374  g.info(f"Retract
+000312e0: 696e 6720 6d61 6e69 7075 6c61 746f 7222  ing manipulator"
+000312f0: 290a 2020 2020 0a20 2020 2064 6566 206d  ).    .    def m
+00031300: 6f76 655f 6d61 6e69 7075 6c61 746f 725f  ove_manipulator_
+00031310: 7265 6c61 7469 7665 2873 656c 662c 2070  relative(self, p
+00031320: 6f73 6974 696f 6e3a 2046 6962 7365 6d4d  osition: FibsemM
+00031330: 616e 6970 756c 6174 6f72 506f 7369 7469  anipulatorPositi
+00031340: 6f6e 293a 0a20 2020 2020 2020 2069 6620  on):.        if 
+00031350: 6e6f 7420 6e70 2e69 7363 6c6f 7365 2870  not np.isclose(p
+00031360: 6f73 6974 696f 6e2e 722c 2030 2e30 293a  osition.r, 0.0):
+00031370: 0a20 2020 2020 2020 2020 2020 2072 6f74  .            rot
+00031380: 6174 696f 6e20 3d20 5472 7565 0a20 2020  ation = True.   
+00031390: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+000313a0: 2020 2020 2020 2072 6f74 6174 696f 6e20         rotation 
+000313b0: 3d20 4661 6c73 650a 2020 2020 2020 2020  = False.        
+000313c0: 6966 206e 6f74 206e 702e 6973 636c 6f73  if not np.isclos
+000313d0: 6528 706f 7369 7469 6f6e 2e74 2c20 302e  e(position.t, 0.
+000313e0: 3029 3a0a 2020 2020 2020 2020 2020 2020  0):.            
+000313f0: 7469 6c74 203d 2054 7275 650a 2020 2020  tilt = True.    
+00031400: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00031410: 2020 2020 2020 7469 6c74 203d 2046 616c        tilt = Fal
+00031420: 7365 0a20 2020 2020 2020 205f 6368 6563  se.        _chec
+00031430: 6b5f 6e65 6564 6c65 2873 656c 662e 6861  k_needle(self.ha
+00031440: 7264 7761 7265 5f73 6574 7469 6e67 732c  rdware_settings,
+00031450: 2072 6f74 6174 696f 6e2c 2074 696c 7429   rotation, tilt)
+00031460: 0a20 2020 2020 2020 206c 6f67 6769 6e67  .        logging
+00031470: 2e69 6e66 6f28 6622 4d6f 7669 6e67 206d  .info(f"Moving m
+00031480: 616e 6970 756c 6174 6f72 3a20 7b70 6f73  anipulator: {pos
+00031490: 6974 696f 6e7d 2028 5265 6c61 7469 7665  ition} (Relative
+000314a0: 2922 290a 2020 2020 2020 2020 7365 6c66  )").        self
+000314b0: 2e6d 616e 6970 756c 6174 6f72 5f70 6f73  .manipulator_pos
+000314c0: 6974 696f 6e20 2b3d 2070 6f73 6974 696f  ition += positio
+000314d0: 6e0a 2020 2020 0a20 2020 2064 6566 206d  n.    .    def m
+000314e0: 6f76 655f 6d61 6e69 7075 6c61 746f 725f  ove_manipulator_
+000314f0: 6162 736f 6c75 7465 2873 656c 662c 2070  absolute(self, p
+00031500: 6f73 6974 696f 6e3a 2046 6962 7365 6d4d  osition: FibsemM
+00031510: 616e 6970 756c 6174 6f72 506f 7369 7469  anipulatorPositi
+00031520: 6f6e 293a 0a20 2020 2020 2020 205f 6368  on):.        _ch
+00031530: 6563 6b5f 6e65 6564 6c65 2873 656c 662e  eck_needle(self.
+00031540: 6861 7264 7761 7265 5f73 6574 7469 6e67  hardware_setting
+00031550: 7329 0a20 2020 2020 2020 206c 6f67 6769  s).        loggi
+00031560: 6e67 2e69 6e66 6f28 6622 4d6f 7669 6e67  ng.info(f"Moving
+00031570: 206d 616e 6970 756c 6174 6f72 3a20 7b70   manipulator: {p
+00031580: 6f73 6974 696f 6e7d 2028 4162 736f 6c75  osition} (Absolu
+00031590: 7465 2922 290a 2020 2020 2020 2020 7365  te)").        se
+000315a0: 6c66 2e6d 616e 6970 756c 6174 6f72 5f70  lf.manipulator_p
+000315b0: 6f73 6974 696f 6e20 3d20 706f 7369 7469  osition = positi
+000315c0: 6f6e 0a20 2020 2020 2020 2020 2020 2020  on.             
+000315d0: 200a 2020 2020 6465 6620 6d6f 7665 5f6d   .    def move_m
+000315e0: 616e 6970 756c 6174 6f72 5f63 6f72 7265  anipulator_corre
+000315f0: 6374 6564 2873 656c 662c 2064 783a 2066  cted(self, dx: f
+00031600: 6c6f 6174 2c20 6479 3a20 666c 6f61 742c  loat, dy: float,
+00031610: 2062 6561 6d5f 7479 7065 3a20 4265 616d   beam_type: Beam
+00031620: 5479 7065 293a 0a20 2020 2020 2020 205f  Type):.        _
+00031630: 6368 6563 6b5f 6e65 6564 6c65 2873 656c  check_needle(sel
+00031640: 662e 6861 7264 7761 7265 5f73 6574 7469  f.hardware_setti
+00031650: 6e67 7329 0a20 2020 2020 2020 206c 6f67  ngs).        log
+00031660: 6769 6e67 2e69 6e66 6f28 6622 4d6f 7669  ging.info(f"Movi
+00031670: 6e67 206d 616e 6970 756c 6174 6f72 3a20  ng manipulator: 
+00031680: 6478 3d7b 6478 3a2e 3265 7d2c 2064 793d  dx={dx:.2e}, dy=
+00031690: 7b64 793a 2e32 657d 2c20 6265 616d 5f74  {dy:.2e}, beam_t
+000316a0: 7970 6520 3d20 7b62 6561 6d5f 7479 7065  ype = {beam_type
+000316b0: 2e6e 616d 657d 2028 436f 7272 6563 7465  .name} (Correcte
+000316c0: 6429 2229 0a20 2020 2020 2020 2073 656c  d)").        sel
+000316d0: 662e 6d61 6e69 7075 6c61 746f 725f 706f  f.manipulator_po
+000316e0: 7369 7469 6f6e 2e78 202b 3d20 6478 0a20  sition.x += dx. 
+000316f0: 2020 2020 2020 2073 656c 662e 6d61 6e69         self.mani
+00031700: 7075 6c61 746f 725f 706f 7369 7469 6f6e  pulator_position
+00031710: 2e79 202b 3d20 6479 0a20 2020 2020 2020  .y += dy.       
+00031720: 200a 0a20 2020 2064 6566 206d 6f76 655f   ..    def move_
+00031730: 6d61 6e69 7075 6c61 746f 725f 746f 5f70  manipulator_to_p
+00031740: 6f73 6974 696f 6e5f 6f66 6673 6574 2873  osition_offset(s
+00031750: 656c 662c 206f 6666 7365 743a 2046 6962  elf, offset: Fib
+00031760: 7365 6d4d 616e 6970 756c 6174 6f72 506f  semManipulatorPo
+00031770: 7369 7469 6f6e 2c20 6e61 6d65 3a20 7374  sition, name: st
+00031780: 7220 3d20 4e6f 6e65 2920 2d3e 204e 6f6e  r = None) -> Non
+00031790: 653a 0a20 2020 2020 2020 205f 6368 6563  e:.        _chec
+000317a0: 6b5f 6e65 6564 6c65 2873 656c 662e 6861  k_needle(self.ha
+000317b0: 7264 7761 7265 5f73 6574 7469 6e67 7329  rdware_settings)
+000317c0: 0a20 2020 2020 2020 2069 6620 6e61 6d65  .        if name
+000317d0: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
+000317e0: 2020 2020 2020 6e61 6d65 203d 2022 4555        name = "EU
+000317f0: 4345 4e54 5249 4322 0a0a 2020 2020 2020  CENTRIC"..      
+00031800: 2020 706f 7369 7469 6f6e 203d 2073 656c    position = sel
+00031810: 662e 5f67 6574 5f73 6176 6564 5f6d 616e  f._get_saved_man
+00031820: 6970 756c 6174 6f72 5f70 6f73 6974 696f  ipulator_positio
+00031830: 6e28 6e61 6d65 290a 2020 2020 2020 2020  n(name).        
+00031840: 0a20 2020 2020 2020 206c 6f67 6769 6e67  .        logging
+00031850: 2e69 6e66 6f28 6622 4d6f 7669 6e67 206d  .info(f"Moving m
+00031860: 616e 6970 756c 6174 6f72 3a20 7b6f 6666  anipulator: {off
+00031870: 7365 747d 2074 6f20 7b6e 616d 657d 2229  set} to {name}")
+00031880: 0a20 2020 2020 2020 2073 656c 662e 6d61  .        self.ma
+00031890: 6e69 7075 6c61 746f 725f 706f 7369 7469  nipulator_positi
+000318a0: 6f6e 203d 2070 6f73 6974 696f 6e20 2b20  on = position + 
+000318b0: 6f66 6673 6574 0a0a 2020 2020 6465 6620  offset..    def 
+000318c0: 5f67 6574 5f73 6176 6564 5f6d 616e 6970  _get_saved_manip
+000318d0: 756c 6174 6f72 5f70 6f73 6974 696f 6e28  ulator_position(
+000318e0: 7365 6c66 2c20 6e61 6d65 3a20 7374 7220  self, name: str 
+000318f0: 3d20 2250 4152 4b22 2920 2d3e 2046 6962  = "PARK") -> Fib
+00031900: 7365 6d4d 616e 6970 756c 6174 6f72 506f  semManipulatorPo
+00031910: 7369 7469 6f6e 3a0a 2020 2020 2020 2020  sition:.        
+00031920: 5f63 6865 636b 5f6e 6565 646c 6528 7365  _check_needle(se
+00031930: 6c66 2e68 6172 6477 6172 655f 7365 7474  lf.hardware_sett
+00031940: 696e 6773 290a 0a20 2020 2020 2020 2069  ings)..        i
+00031950: 6620 6e61 6d65 206e 6f74 2069 6e20 5b22  f name not in ["
+00031960: 5041 524b 222c 2022 4555 4345 4e54 5249  PARK", "EUCENTRI
+00031970: 4322 5d3a 0a20 2020 2020 2020 2020 2020  C"]:.           
+00031980: 2072 6169 7365 2056 616c 7565 4572 726f   raise ValueErro
+00031990: 7228 6622 556e 6b6e 6f77 6e20 6d61 6e69  r(f"Unknown mani
+000319a0: 7075 6c61 746f 7220 706f 7369 7469 6f6e  pulator position
+000319b0: 3a20 7b6e 616d 657d 2229 0a20 2020 2020  : {name}").     
+000319c0: 2020 2069 6620 6e61 6d65 203d 3d20 2250     if name == "P
+000319d0: 4152 4b22 3a0a 2020 2020 2020 2020 2020  ARK":.          
+000319e0: 2020 7265 7475 726e 2046 6962 7365 6d4d    return FibsemM
+000319f0: 616e 6970 756c 6174 6f72 506f 7369 7469  anipulatorPositi
+00031a00: 6f6e 2878 3d30 2c20 793d 302c 207a 3d30  on(x=0, y=0, z=0
+00031a10: 2c20 723d 302c 2074 3d30 290a 2020 2020  , r=0, t=0).    
+00031a20: 2020 2020 6966 206e 616d 6520 3d3d 2022      if name == "
+00031a30: 4555 4345 4e54 5249 4322 3a0a 2020 2020  EUCENTRIC":.    
+00031a40: 2020 2020 2020 2020 7265 7475 726e 2046          return F
+00031a50: 6962 7365 6d4d 616e 6970 756c 6174 6f72  ibsemManipulator
+00031a60: 506f 7369 7469 6f6e 2878 3d30 2c20 793d  Position(x=0, y=
+00031a70: 302c 207a 3d30 2c20 723d 302c 2074 3d30  0, z=0, r=0, t=0
+00031a80: 290a 0a20 2020 2064 6566 2073 6574 7570  )..    def setup
+00031a90: 5f6d 696c 6c69 6e67 2873 656c 662c 206d  _milling(self, m
+00031aa0: 696c 6c5f 7365 7474 696e 6773 3a20 4669  ill_settings: Fi
+00031ab0: 6273 656d 4d69 6c6c 696e 6753 6574 7469  bsemMillingSetti
+00031ac0: 6e67 7329 3a0a 2020 2020 2020 2020 5f63  ngs):.        _c
+00031ad0: 6865 636b 5f62 6561 6d28 4265 616d 5479  heck_beam(BeamTy
+00031ae0: 7065 2e49 4f4e 2c20 7365 6c66 2e68 6172  pe.ION, self.har
+00031af0: 6477 6172 655f 7365 7474 696e 6773 290a  dware_settings).
+00031b00: 2020 2020 2020 2020 6c6f 6767 696e 672e          logging.
+00031b10: 696e 666f 2866 2253 6574 7469 6e67 2075  info(f"Setting u
+00031b20: 7020 6d69 6c6c 696e 673a 207b 6d69 6c6c  p milling: {mill
+00031b30: 5f73 6574 7469 6e67 732e 7061 7474 6572  _settings.patter
+00031b40: 6e69 6e67 5f6d 6f64 657d 2c20 7b6d 696c  ning_mode}, {mil
+00031b50: 6c5f 7365 7474 696e 6773 7d22 290a 0a20  l_settings}").. 
+00031b60: 2020 2064 6566 2072 756e 5f6d 696c 6c69     def run_milli
+00031b70: 6e67 2873 656c 662c 206d 696c 6c69 6e67  ng(self, milling
+00031b80: 5f63 7572 7265 6e74 3a20 666c 6f61 742c  _current: float,
+00031b90: 2061 7379 6e63 683a 2062 6f6f 6c20 3d20   asynch: bool = 
+00031ba0: 4661 6c73 6529 202d 3e20 4e6f 6e65 3a0a  False) -> None:.
+00031bb0: 2020 2020 2020 2020 5f63 6865 636b 5f62          _check_b
+00031bc0: 6561 6d28 4265 616d 5479 7065 2e49 4f4e  eam(BeamType.ION
+00031bd0: 2c20 7365 6c66 2e68 6172 6477 6172 655f  , self.hardware_
+00031be0: 7365 7474 696e 6773 290a 2020 2020 2020  settings).      
+00031bf0: 2020 6c6f 6767 696e 672e 696e 666f 2866    logging.info(f
+00031c00: 2252 756e 6e69 6e67 206d 696c 6c69 6e67  "Running milling
+00031c10: 3a20 7b6d 696c 6c69 6e67 5f63 7572 7265  : {milling_curre
+00031c20: 6e74 3a2e 3265 7d2c 207b 6173 796e 6368  nt:.2e}, {asynch
+00031c30: 7d22 290a 2020 2020 2020 2020 696d 706f  }").        impo
+00031c40: 7274 2072 616e 646f 6d0a 2020 2020 2020  rt random.      
+00031c50: 2020 7469 6d65 2e73 6c65 6570 2872 616e    time.sleep(ran
+00031c60: 646f 6d2e 7261 6e64 696e 7428 312c 2035  dom.randint(1, 5
+00031c70: 2929 0a0a 2020 2020 6465 6620 6669 6e69  ))..    def fini
+00031c80: 7368 5f6d 696c 6c69 6e67 2873 656c 662c  sh_milling(self,
+00031c90: 2069 6d61 6769 6e67 5f63 7572 7265 6e74   imaging_current
+00031ca0: 3a20 666c 6f61 7429 202d 3e20 4e6f 6e65  : float) -> None
+00031cb0: 3a0a 2020 2020 2020 2020 5f63 6865 636b  :.        _check
+00031cc0: 5f62 6561 6d28 4265 616d 5479 7065 2e49  _beam(BeamType.I
+00031cd0: 4f4e 2c20 7365 6c66 2e68 6172 6477 6172  ON, self.hardwar
+00031ce0: 655f 7365 7474 696e 6773 290a 2020 2020  e_settings).    
+00031cf0: 2020 2020 6c6f 6767 696e 672e 696e 666f      logging.info
+00031d00: 2866 2246 696e 6973 6869 6e67 206d 696c  (f"Finishing mil
+00031d10: 6c69 6e67 3a20 7b69 6d61 6769 6e67 5f63  ling: {imaging_c
+00031d20: 7572 7265 6e74 3a2e 3265 7d22 290a 0a20  urrent:.2e}").. 
+00031d30: 2020 2064 6566 2064 7261 775f 7265 6374     def draw_rect
+00031d40: 616e 676c 6528 7365 6c66 2c20 7061 7474  angle(self, patt
+00031d50: 6572 6e5f 7365 7474 696e 6773 3a20 4669  ern_settings: Fi
+00031d60: 6273 656d 5061 7474 6572 6e53 6574 7469  bsemPatternSetti
+00031d70: 6e67 7329 202d 3e20 4e6f 6e65 3a0a 2020  ngs) -> None:.  
+00031d80: 2020 2020 2020 6c6f 6767 696e 672e 696e        logging.in
+00031d90: 666f 2866 2244 7261 7769 6e67 2072 6563  fo(f"Drawing rec
+00031da0: 7461 6e67 6c65 3a20 7b70 6174 7465 726e  tangle: {pattern
+00031db0: 5f73 6574 7469 6e67 737d 2229 0a0a 2020  _settings}")..  
+00031dc0: 2020 6465 6620 6472 6177 5f6c 696e 6528    def draw_line(
+00031dd0: 7365 6c66 2c20 7061 7474 6572 6e5f 7365  self, pattern_se
+00031de0: 7474 696e 6773 3a20 4669 6273 656d 5061  ttings: FibsemPa
+00031df0: 7474 6572 6e53 6574 7469 6e67 7329 202d  tternSettings) -
+00031e00: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
+00031e10: 6c6f 6767 696e 672e 696e 666f 2866 2244  logging.info(f"D
+00031e20: 7261 7769 6e67 206c 696e 653a 207b 7061  rawing line: {pa
+00031e30: 7474 6572 6e5f 7365 7474 696e 6773 7d22  ttern_settings}"
+00031e40: 290a 0a20 2020 2064 6566 2064 7261 775f  )..    def draw_
+00031e50: 6369 7263 6c65 2873 656c 662c 2070 6174  circle(self, pat
+00031e60: 7465 726e 5f73 6574 7469 6e67 733a 2046  tern_settings: F
+00031e70: 6962 7365 6d50 6174 7465 726e 5365 7474  ibsemPatternSett
+00031e80: 696e 6773 2920 2d3e 204e 6f6e 653a 0a20  ings) -> None:. 
+00031e90: 2020 2020 2020 206c 6f67 6769 6e67 2e69         logging.i
+00031ea0: 6e66 6f28 6622 4472 6177 696e 6720 6369  nfo(f"Drawing ci
+00031eb0: 7263 6c65 3a20 7b70 6174 7465 726e 5f73  rcle: {pattern_s
+00031ec0: 6574 7469 6e67 737d 2229 0a20 2020 200a  ettings}").    .
+00031ed0: 2020 2020 6465 6620 6472 6177 5f61 6e6e      def draw_ann
+00031ee0: 756c 7573 2873 656c 662c 2070 6174 7465  ulus(self, patte
+00031ef0: 726e 5f73 6574 7469 6e67 733a 2046 6962  rn_settings: Fib
+00031f00: 7365 6d50 6174 7465 726e 5365 7474 696e  semPatternSettin
+00031f10: 6773 2920 2d3e 204e 6f6e 653a 0a20 2020  gs) -> None:.   
+00031f20: 2020 2020 206c 6f67 6769 6e67 2e69 6e66       logging.inf
+00031f30: 6f28 6622 4472 6177 696e 6720 616e 6e75  o(f"Drawing annu
+00031f40: 6c75 733a 207b 7061 7474 6572 6e5f 7365  lus: {pattern_se
+00031f50: 7474 696e 6773 7d22 290a 0a20 2020 2064  ttings}")..    d
+00031f60: 6566 2067 6574 5f73 6361 6e5f 6469 7265  ef get_scan_dire
+00031f70: 6374 696f 6e73 2873 656c 6629 202d 3e20  ctions(self) -> 
+00031f80: 6c69 7374 3a0a 2020 2020 2020 2020 2222  list:.        ""
+00031f90: 220a 2020 2020 2020 2020 5265 7475 726e  ".        Return
+00031fa0: 7320 7468 6520 6176 6169 6c61 626c 6520  s the available 
+00031fb0: 7363 616e 2064 6972 6563 7469 6f6e 7320  scan directions 
+00031fc0: 6f66 2074 6865 206d 6963 726f 7363 6f70  of the microscop
+00031fd0: 652e 0a0a 2020 2020 2020 2020 5265 7475  e...        Retu
+00031fe0: 726e 733a 0a20 2020 2020 2020 2020 2020  rns:.           
+00031ff0: 206c 6973 743a 2054 6865 2073 6361 6e20   list: The scan 
+00032000: 6469 7265 6374 696f 6e20 6f66 2074 6865  direction of the
+00032010: 206d 6963 726f 7363 6f70 652e 0a0a 2020   microscope...  
+00032020: 2020 2020 2020 5261 6973 6573 3a0a 2020        Raises:.  
+00032030: 2020 2020 2020 2020 2020 4e6f 6e65 0a20            None. 
+00032040: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+00032050: 2020 206c 6973 7420 3d20 5b22 426f 7474     list = ["Bott
+00032060: 6f6d 546f 546f 7022 2c20 0a20 2020 2020  omToTop", .     
+00032070: 2020 2020 2020 2020 2020 2022 4c65 6674             "Left
+00032080: 546f 5269 6768 7422 2c20 090a 2020 2020  ToRight", ..    
+00032090: 2020 2020 2020 2020 2020 2020 2252 6967              "Rig
+000320a0: 6874 546f 4c65 6674 222c 2009 0a20 2020  htToLeft", ..   
+000320b0: 2020 2020 2020 2020 2020 2020 2022 546f               "To
+000320c0: 7054 6f42 6f74 746f 6d22 5d0a 2020 2020  pToBottom"].    
+000320d0: 2020 2020 7265 7475 726e 206c 6973 7420      return list 
+000320e0: 0a0a 2020 2020 6465 6620 6472 6177 5f62  ..    def draw_b
+000320f0: 6974 6d61 705f 7061 7474 6572 6e28 7365  itmap_pattern(se
+00032100: 6c66 2c20 7061 7474 6572 6e5f 7365 7474  lf, pattern_sett
+00032110: 696e 6773 3a20 4669 6273 656d 5061 7474  ings: FibsemPatt
+00032120: 6572 6e53 6574 7469 6e67 732c 0a20 2020  ernSettings,.   
+00032130: 2020 2020 2070 6174 683a 2073 7472 293a       path: str):
+00032140: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00032150: 0a20 2020 2064 6566 2072 756e 5f6d 696c  .    def run_mil
+00032160: 6c69 6e67 5f64 7269 6674 5f63 6f72 7265  ling_drift_corre
+00032170: 6374 6564 2873 656c 6629 3a0a 2020 2020  cted(self):.    
+00032180: 2020 2020 5f63 6865 636b 5f62 6561 6d28      _check_beam(
+00032190: 4265 616d 5479 7065 2e49 4f4e 2c20 7365  BeamType.ION, se
+000321a0: 6c66 2e68 6172 6477 6172 655f 7365 7474  lf.hardware_sett
+000321b0: 696e 6773 290a 2020 2020 2020 2020 7265  ings).        re
+000321c0: 7475 726e 0a0a 2020 2020 6465 6620 7365  turn..    def se
+000321d0: 7475 705f 7370 7574 7465 7228 7365 6c66  tup_sputter(self
+000321e0: 2c20 7072 6f74 6f63 6f6c 3a20 6469 6374  , protocol: dict
+000321f0: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
+00032200: 2020 205f 6368 6563 6b5f 7370 7574 7465     _check_sputte
+00032210: 7228 7365 6c66 2e68 6172 6477 6172 655f  r(self.hardware_
+00032220: 7365 7474 696e 6773 290a 2020 2020 2020  settings).      
+00032230: 2020 6c6f 6767 696e 672e 696e 666f 2866    logging.info(f
+00032240: 2253 6574 7469 6e67 2075 7020 7370 7574  "Setting up sput
+00032250: 7465 723a 207b 7072 6f74 6f63 6f6c 7d22  ter: {protocol}"
+00032260: 290a 0a20 2020 2064 6566 2064 7261 775f  )..    def draw_
+00032270: 7370 7574 7465 725f 7061 7474 6572 6e28  sputter_pattern(
+00032280: 7365 6c66 2c20 6866 773a 2066 6c6f 6174  self, hfw: float
+00032290: 2c20 6c69 6e65 5f70 6174 7465 726e 5f6c  , line_pattern_l
+000322a0: 656e 6774 683a 2066 6c6f 6174 2c20 7370  ength: float, sp
+000322b0: 7574 7465 725f 7469 6d65 3a20 666c 6f61  utter_time: floa
+000322c0: 7429 3a0a 2020 2020 2020 2020 6c6f 6767  t):.        logg
+000322d0: 696e 672e 696e 666f 2866 2244 7261 7769  ing.info(f"Drawi
+000322e0: 6e67 2073 7075 7474 6572 2070 6174 7465  ng sputter patte
+000322f0: 726e 3a20 6866 773d 7b68 6677 3a2e 3265  rn: hfw={hfw:.2e
+00032300: 7d2c 206c 696e 655f 7061 7474 6572 6e5f  }, line_pattern_
+00032310: 6c65 6e67 7468 3d7b 6c69 6e65 5f70 6174  length={line_pat
+00032320: 7465 726e 5f6c 656e 6774 683a 2e32 657d  tern_length:.2e}
+00032330: 2c20 7370 7574 7465 725f 7469 6d65 3d7b  , sputter_time={
+00032340: 7370 7574 7465 725f 7469 6d65 3a2e 3265  sputter_time:.2e
+00032350: 7d22 290a 0a20 2020 2064 6566 2072 756e  }")..    def run
+00032360: 5f73 7075 7474 6572 2873 656c 662c 202a  _sputter(self, *
+00032370: 2a6b 7761 7267 7329 3a0a 2020 2020 2020  *kwargs):.      
+00032380: 2020 5f63 6865 636b 5f73 7075 7474 6572    _check_sputter
+00032390: 2873 656c 662e 6861 7264 7761 7265 5f73  (self.hardware_s
+000323a0: 6574 7469 6e67 7329 0a20 2020 2020 2020  ettings).       
+000323b0: 206c 6f67 6769 6e67 2e69 6e66 6f28 6622   logging.info(f"
+000323c0: 5275 6e6e 696e 6720 7370 7574 7465 723a  Running sputter:
+000323d0: 207b 6b77 6172 6773 7d22 290a 0a20 2020   {kwargs}")..   
+000323e0: 2064 6566 2066 696e 6973 685f 7370 7574   def finish_sput
+000323f0: 7465 7228 7365 6c66 2c20 2a2a 6b77 6172  ter(self, **kwar
+00032400: 6773 293a 0a20 2020 2020 2020 205f 6368  gs):.        _ch
+00032410: 6563 6b5f 7370 7574 7465 7228 7365 6c66  eck_sputter(self
+00032420: 2e68 6172 6477 6172 655f 7365 7474 696e  .hardware_settin
+00032430: 6773 290a 2020 2020 2020 2020 6c6f 6767  gs).        logg
+00032440: 696e 672e 696e 666f 2866 2246 696e 6973  ing.info(f"Finis
+00032450: 6869 6e67 2073 7075 7474 6572 3a20 7b6b  hing sputter: {k
+00032460: 7761 7267 737d 2229 0a0a 2020 2020 6465  wargs}")..    de
+00032470: 6620 4749 535f 6176 6169 6c61 626c 655f  f GIS_available_
+00032480: 6c69 6e65 7328 7365 6c66 2920 2d3e 206c  lines(self) -> l
+00032490: 6973 745b 7374 725d 3a0a 0a20 2020 2020  ist[str]:..     
+000324a0: 2020 2073 656c 662e 6769 735f 6c69 6e65     self.gis_line
+000324b0: 7320 3d20 7b0a 2020 2020 2020 2020 2020  s = {.          
+000324c0: 2020 2257 6174 6572 223a 2054 6865 726d    "Water": Therm
+000324d0: 6f47 4953 4c69 6e65 284e 6f6e 652c 2257  oGISLine(None,"W
+000324e0: 6174 6572 2229 2c0a 2020 2020 2020 2020  ater"),.        
+000324f0: 2020 2020 2250 7422 3a20 5468 6572 6d6f      "Pt": Thermo
+00032500: 4749 534c 696e 6528 4e6f 6e65 2c22 5074  GISLine(None,"Pt
+00032510: 2229 2c0a 2020 2020 2020 2020 2020 2020  "),.            
+00032520: 2243 6172 626f 6e22 3a20 5468 6572 6d6f  "Carbon": Thermo
+00032530: 4749 534c 696e 6528 4e6f 6e65 2c22 4322  GISLine(None,"C"
+00032540: 290a 2020 2020 2020 2020 7d0a 0a20 2020  ).        }..   
+00032550: 2020 2020 2072 6574 7572 6e20 6c69 7374       return list
+00032560: 2873 656c 662e 6769 735f 6c69 6e65 732e  (self.gis_lines.
+00032570: 6b65 7973 2829 290a 0a20 2020 2064 6566  keys())..    def
+00032580: 2047 4953 5f61 7661 696c 6162 6c65 5f70   GIS_available_p
+00032590: 6f73 6974 696f 6e73 2873 656c 6629 202d  ositions(self) -
+000325a0: 3e20 6c69 7374 5b73 7472 5d3a 0a0a 2020  > list[str]:..  
+000325b0: 2020 2020 2020 706f 7369 7469 6f6e 7320        positions 
+000325c0: 3d20 5b22 496e 7365 7274 222c 2252 6574  = ["Insert","Ret
+000325d0: 7261 6374 225d 0a0a 2020 2020 2020 2020  ract"]..        
+000325e0: 7265 7475 726e 2070 6f73 6974 696f 6e73  return positions
+000325f0: 0a0a 2020 2020 6465 6620 4749 535f 6d6f  ..    def GIS_mo
+00032600: 7665 5f74 6f28 7365 6c66 2c6c 696e 655f  ve_to(self,line_
+00032610: 6e61 6d65 3a20 7374 722c 2070 6f73 6974  name: str, posit
+00032620: 696f 6e5f 6e61 6d65 3a20 7374 7229 202d  ion_name: str) -
+00032630: 3e20 4e6f 6e65 3a0a 0a0a 2020 2020 2020  > None:...      
+00032640: 2020 6c69 6e65 203d 2073 656c 662e 6769    line = self.gi
+00032650: 735f 6c69 6e65 735b 6c69 6e65 5f6e 616d  s_lines[line_nam
+00032660: 655d 0a0a 2020 2020 2020 2020 6966 2070  e]..        if p
+00032670: 6f73 6974 696f 6e5f 6e61 6d65 203d 3d20  osition_name == 
+00032680: 2249 6e73 6572 7422 3a0a 0a20 2020 2020  "Insert":..     
+00032690: 2020 2020 2020 206c 696e 652e 7374 6174         line.stat
+000326a0: 7573 203d 2022 496e 7365 7274 6564 220a  us = "Inserted".
+000326b0: 0a20 2020 2020 2020 2069 6620 706f 7369  .        if posi
+000326c0: 7469 6f6e 5f6e 616d 6520 3d3d 2022 5265  tion_name == "Re
+000326d0: 7472 6163 7422 3a0a 0a20 2020 2020 2020  tract":..       
+000326e0: 2020 2020 206c 696e 652e 7374 6174 7573       line.status
+000326f0: 203d 2022 5265 7472 6163 7465 6422 0a0a   = "Retracted"..
+00032700: 2020 2020 6465 6620 4749 535f 706f 7369      def GIS_posi
+00032710: 7469 6f6e 2873 656c 662c 6c69 6e65 5f6e  tion(self,line_n
+00032720: 616d 6529 3a0a 0a20 2020 2020 2020 206c  ame):..        l
+00032730: 696e 6520 3d20 7365 6c66 2e67 6973 5f6c  ine = self.gis_l
+00032740: 696e 6573 5b6c 696e 655f 6e61 6d65 5d0a  ines[line_name].
+00032750: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00032760: 6c69 6e65 2e73 7461 7475 730a 0a20 2020  line.status..   
+00032770: 2064 6566 2047 4953 5f68 6561 745f 7570   def GIS_heat_up
+00032780: 2873 656c 662c 6c69 6e65 5f6e 616d 6529  (self,line_name)
+00032790: 3a0a 0a0a 2020 2020 2020 2020 6c69 6e65  :...        line
+000327a0: 203d 2073 656c 662e 6769 735f 6c69 6e65   = self.gis_line
+000327b0: 735b 6c69 6e65 5f6e 616d 655d 0a20 2020  s[line_name].   
+000327c0: 2020 2020 2074 696d 652e 736c 6565 7028       time.sleep(
+000327d0: 3529 0a20 2020 2020 2020 206c 696e 652e  5).        line.
+000327e0: 7465 6d70 5f72 6561 6479 203d 2054 7275  temp_ready = Tru
+000327f0: 650a 0a20 2020 2064 6566 2047 4953 5f74  e..    def GIS_t
+00032800: 656d 705f 7265 6164 7928 7365 6c66 2c6c  emp_ready(self,l
+00032810: 696e 655f 6e61 6d65 293a 0a0a 2020 2020  ine_name):..    
+00032820: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
+00032830: 6769 735f 6c69 6e65 735b 6c69 6e65 5f6e  gis_lines[line_n
+00032840: 616d 655d 2e74 656d 705f 7265 6164 790a  ame].temp_ready.
+00032850: 0a20 2020 2064 6566 206d 756c 7469 6368  .    def multich
+00032860: 656d 5f61 7661 696c 6162 6c65 5f6c 696e  em_available_lin
+00032870: 6573 2873 656c 6629 3a0a 0a20 2020 2020  es(self):..     
+00032880: 2020 2073 656c 662e 6d75 6c74 6963 6865     self.multiche
+00032890: 6d20 3d20 5468 6572 6d6f 4d75 6c74 6943  m = ThermoMultiC
+000328a0: 6865 6d4c 696e 6528 290a 0a20 2020 2020  hemLine()..     
+000328b0: 2020 2073 656c 662e 6d63 5f6c 696e 6573     self.mc_lines
+000328c0: 203d 205b 226d 635f 5761 7465 7222 2c22   = ["mc_Water","
+000328d0: 6d63 5f50 7422 2c22 6d63 5f43 225d 0a0a  mc_Pt","mc_C"]..
+000328e0: 2020 2020 2020 2020 7365 6c66 2e6d 635f          self.mc_
+000328f0: 6c69 6e65 735f 7465 6d70 203d 7b7d 0a0a  lines_temp ={}..
+00032900: 2020 2020 2020 2020 666f 7220 6c69 6e65          for line
+00032910: 2069 6e20 7365 6c66 2e6d 635f 6c69 6e65   in self.mc_line
+00032920: 733a 0a0a 2020 2020 2020 2020 2020 2020  s:..            
+00032930: 7365 6c66 2e6d 635f 6c69 6e65 735f 7465  self.mc_lines_te
+00032940: 6d70 5b6c 696e 655d 203d 2046 616c 7365  mp[line] = False
+00032950: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
+00032960: 2073 656c 662e 6d63 5f6c 696e 6573 0a0a   self.mc_lines..
+00032970: 2020 2020 6465 6620 6d75 6c74 6963 6865      def multiche
+00032980: 6d5f 6176 6169 6c61 626c 655f 706f 7369  m_available_posi
+00032990: 7469 6f6e 7328 7365 6c66 293a 0a0a 2020  tions(self):..  
+000329a0: 2020 2020 2020 706f 7369 7469 6f6e 7320        positions 
+000329b0: 3d20 7365 6c66 2e6d 756c 7469 6368 656d  = self.multichem
+000329c0: 2e70 6f73 6974 696f 6e73 0a0a 2020 2020  .positions..    
+000329d0: 2020 2020 7265 7475 726e 2070 6f73 6974      return posit
+000329e0: 696f 6e73 0a0a 2020 2020 6465 6620 6d75  ions..    def mu
+000329f0: 6c74 6963 6865 6d5f 6d6f 7665 5f74 6f28  ltichem_move_to(
+00032a00: 7365 6c66 2c70 6f73 6974 696f 6e29 3a0a  self,position):.
+00032a10: 0a20 2020 2020 2020 2069 6620 706f 7369  .        if posi
+00032a20: 7469 6f6e 203d 3d20 2252 6574 7261 6374  tion == "Retract
+00032a30: 223a 0a20 2020 2020 2020 2020 2020 2073  ":.            s
+00032a40: 656c 662e 6d75 6c74 6963 6865 6d2e 7265  elf.multichem.re
+00032a50: 7472 6163 7428 290a 2020 2020 2020 2020  tract().        
+00032a60: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00032a70: 2020 7365 6c66 2e6d 756c 7469 6368 656d    self.multichem
+00032a80: 2e69 6e73 6572 7428 706f 7369 7469 6f6e  .insert(position
+00032a90: 290a 0a20 2020 2064 6566 206d 756c 7469  )..    def multi
+00032aa0: 6368 656d 5f70 6f73 6974 696f 6e28 7365  chem_position(se
+00032ab0: 6c66 293a 0a0a 2020 2020 2020 2020 7265  lf):..        re
+00032ac0: 7475 726e 2073 656c 662e 6d75 6c74 6963  turn self.multic
+00032ad0: 6865 6d2e 6375 7272 656e 745f 706f 7369  hem.current_posi
+00032ae0: 7469 6f6e 0a0a 2020 2020 6465 6620 6d75  tion..    def mu
+00032af0: 6c74 6963 6865 6d5f 6865 6174 5f75 7028  ltichem_heat_up(
+00032b00: 7365 6c66 2c6c 696e 653a 7374 7229 3a0a  self,line:str):.
+00032b10: 0a20 2020 2020 2020 205f 6368 6563 6b5f  .        _check_
+00032b20: 7370 7574 7465 7228 7365 6c66 2e68 6172  sputter(self.har
+00032b30: 6477 6172 655f 7365 7474 696e 6773 290a  dware_settings).
+00032b40: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
+00032b50: 6c69 6e65 2069 6e20 7365 6c66 2e6d 635f  line in self.mc_
+00032b60: 6c69 6e65 732c 2022 4c69 6e65 206e 6f74  lines, "Line not
+00032b70: 2061 7661 696c 6162 6c65 220a 0a20 2020   available"..   
+00032b80: 2020 2020 2074 696d 652e 736c 6565 7028       time.sleep(
+00032b90: 3329 0a0a 2020 2020 2020 2020 7365 6c66  3)..        self
+00032ba0: 2e6d 635f 6c69 6e65 735f 7465 6d70 5b6c  .mc_lines_temp[l
+00032bb0: 696e 655d 203d 2054 7275 650a 0a20 2020  ine] = True..   
+00032bc0: 2064 6566 206d 756c 7469 6368 656d 5f74   def multichem_t
+00032bd0: 656d 705f 7265 6164 7928 7365 6c66 2c6c  emp_ready(self,l
+00032be0: 696e 653a 7374 7229 202d 3e20 626f 6f6c  ine:str) -> bool
+00032bf0: 3a0a 0a20 2020 2020 2020 205f 6368 6563  :..        _chec
+00032c00: 6b5f 7370 7574 7465 7228 7365 6c66 2e68  k_sputter(self.h
+00032c10: 6172 6477 6172 655f 7365 7474 696e 6773  ardware_settings
+00032c20: 290a 0a20 2020 2020 2020 2061 7373 6572  )..        asser
+00032c30: 7420 6c69 6e65 2069 6e20 7365 6c66 2e6d  t line in self.m
+00032c40: 635f 6c69 6e65 732c 2022 4c69 6e65 206e  c_lines, "Line n
+00032c50: 6f74 2061 7661 696c 6162 6c65 220a 0a20  ot available".. 
+00032c60: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
+00032c70: 6c66 2e6d 635f 6c69 6e65 735f 7465 6d70  lf.mc_lines_temp
+00032c80: 5b6c 696e 655d 0a0a 2020 2020 6465 6620  [line]..    def 
+00032c90: 7365 745f 6d69 6372 6f73 636f 7065 5f73  set_microscope_s
+00032ca0: 7461 7465 2873 656c 662c 2073 7461 7465  tate(self, state
+00032cb0: 3a20 4d69 6372 6f73 636f 7065 5374 6174  : MicroscopeStat
+00032cc0: 6529 3a0a 0a20 2020 2020 2020 205f 6368  e):..        _ch
+00032cd0: 6563 6b5f 7370 7574 7465 7228 7365 6c66  eck_sputter(self
+00032ce0: 2e68 6172 6477 6172 655f 7365 7474 696e  .hardware_settin
+00032cf0: 6773 290a 2020 2020 2020 2020 5f63 6865  gs).        _che
+00032d00: 636b 5f6e 6565 646c 6528 7365 6c66 2e68  ck_needle(self.h
+00032d10: 6172 6477 6172 655f 7365 7474 696e 6773  ardware_settings
+00032d20: 290a 2020 2020 2020 2020 5f63 6865 636b  ).        _check
+00032d30: 5f62 6561 6d28 4265 616d 5479 7065 2e49  _beam(BeamType.I
+00032d40: 4f4e 2c20 7365 6c66 2e68 6172 6477 6172  ON, self.hardwar
+00032d50: 655f 7365 7474 696e 6773 290a 2020 2020  e_settings).    
+00032d60: 2020 2020 5f63 6865 636b 5f62 6561 6d28      _check_beam(
+00032d70: 4265 616d 5479 7065 2e45 4c45 4354 524f  BeamType.ELECTRO
+00032d80: 4e2c 2073 656c 662e 6861 7264 7761 7265  N, self.hardware
+00032d90: 5f73 6574 7469 6e67 7329 0a20 2020 2020  _settings).     
+00032da0: 2020 205f 6368 6563 6b5f 7374 6167 6528     _check_stage(
+00032db0: 7365 6c66 2e68 6172 6477 6172 655f 7365  self.hardware_se
+00032dc0: 7474 696e 6773 290a 2020 2020 2020 2020  ttings).        
+00032dd0: 7365 6c66 2e6d 6f76 655f 7374 6167 655f  self.move_stage_
+00032de0: 6162 736f 6c75 7465 2873 7461 7465 2e61  absolute(state.a
+00032df0: 6273 6f6c 7574 655f 706f 7369 7469 6f6e  bsolute_position
+00032e00: 290a 2020 2020 2020 2020 6c6f 6767 696e  ).        loggin
+00032e10: 672e 696e 666f 2866 2253 6574 7469 6e67  g.info(f"Setting
+00032e20: 206d 6963 726f 7363 6f70 6520 7374 6174   microscope stat
+00032e30: 6522 290a 2020 2020 2020 2020 0a0a 2020  e").        ..  
+00032e40: 2020 6465 6620 6765 745f 6176 6169 6c61    def get_availa
+00032e50: 626c 655f 7661 6c75 6573 2873 656c 662c  ble_values(self,
+00032e60: 206b 6579 3a20 7374 722c 2062 6561 6d5f   key: str, beam_
+00032e70: 7479 7065 3a20 4265 616d 5479 7065 203d  type: BeamType =
+00032e80: 204e 6f6e 6529 202d 3e20 6c69 7374 5b66   None) -> list[f
+00032e90: 6c6f 6174 5d3a 0a20 2020 2020 2020 200a  loat]:.        .
+00032ea0: 2020 2020 2020 2020 7661 6c75 6573 203d          values =
+00032eb0: 205b 5d0a 2020 2020 2020 2020 6966 206b   [].        if k
+00032ec0: 6579 203d 3d20 2263 7572 7265 6e74 223a  ey == "current":
+00032ed0: 0a20 2020 2020 2020 2020 2020 205f 6368  .            _ch
+00032ee0: 6563 6b5f 6265 616d 2862 6561 6d5f 7479  eck_beam(beam_ty
+00032ef0: 7065 2c20 7365 6c66 2e68 6172 6477 6172  pe, self.hardwar
+00032f00: 655f 7365 7474 696e 6773 290a 2020 2020  e_settings).    
+00032f10: 2020 2020 2020 2020 6966 2062 6561 6d5f          if beam_
+00032f20: 7479 7065 203d 3d20 4265 616d 5479 7065  type == BeamType
+00032f30: 2e45 4c45 4354 524f 4e3a 0a20 2020 2020  .ELECTRON:.     
+00032f40: 2020 2020 2020 2020 2020 2076 616c 7565             value
+00032f50: 7320 3d20 5b31 2e30 652d 3132 5d0a 2020  s = [1.0e-12].  
+00032f60: 2020 2020 2020 2020 2020 6966 2062 6561            if bea
+00032f70: 6d5f 7479 7065 203d 3d20 4265 616d 5479  m_type == BeamTy
+00032f80: 7065 2e49 4f4e 3a0a 2020 2020 2020 2020  pe.ION:.        
+00032f90: 2020 2020 2020 2020 7661 6c75 6573 203d          values =
+00032fa0: 205b 3230 652d 3132 2c20 3630 652d 3132   [20e-12, 60e-12
+00032fb0: 2c20 302e 3265 2d39 2c20 302e 3734 652d  , 0.2e-9, 0.74e-
+00032fc0: 392c 2032 2e30 652d 392c 2037 2e36 652d  9, 2.0e-9, 7.6e-
+00032fd0: 392c 2032 382e 3065 2d39 2c20 3132 3065  9, 28.0e-9, 120e
+00032fe0: 2d39 5d0a 2020 2020 2020 2020 0a0a 2020  -9].        ..  
+00032ff0: 2020 2020 2020 6966 206b 6579 203d 3d20        if key == 
+00033000: 2261 7070 6c69 6361 7469 6f6e 5f66 696c  "application_fil
+00033010: 6522 3a0a 2020 2020 2020 2020 2020 2020  e":.            
+00033020: 7661 6c75 6573 203d 205b 2253 6922 2c20  values = ["Si", 
+00033030: 2261 7574 6f6c 616d 656c 6c61 222c 2022  "autolamella", "
+00033040: 6372 796f 5f50 745f 6465 7022 5d0a 0a20  cryo_Pt_dep"].. 
+00033050: 2020 2020 2020 2069 6620 6b65 7920 3d3d         if key ==
+00033060: 2022 6465 7465 6374 6f72 5f74 7970 6522   "detector_type"
+00033070: 3a0a 2020 2020 2020 2020 2020 2020 7661  :.            va
+00033080: 6c75 6573 203d 205b 2245 5444 222c 2022  lues = ["ETD", "
+00033090: 544c 4422 2c20 2245 4453 225d 0a20 2020  TLD", "EDS"].   
+000330a0: 2020 2020 2069 6620 6b65 7920 3d3d 2022       if key == "
+000330b0: 6465 7465 6374 6f72 5f6d 6f64 6522 3a0a  detector_mode":.
+000330c0: 2020 2020 2020 2020 2020 2020 7661 6c75              valu
+000330d0: 6573 203d 205b 2253 6563 6f6e 6461 7279  es = ["Secondary
+000330e0: 456c 6563 7472 6f6e 7322 2c20 2242 6163  Electrons", "Bac
+000330f0: 6b73 6361 7474 6572 6564 456c 6563 7472  kscatteredElectr
+00033100: 6f6e 7322 2c20 2245 4453 225d 0a20 2020  ons", "EDS"].   
+00033110: 2020 2020 200a 2020 2020 2020 2020 6966       .        if
+00033120: 206b 6579 203d 3d20 2273 6361 6e5f 6469   key == "scan_di
+00033130: 7265 6374 696f 6e22 3a0a 2020 2020 2020  rection":.      
+00033140: 2020 2020 2020 7661 6c75 6573 203d 205b        values = [
+00033150: 2242 6f74 746f 6d54 6f54 6f70 222c 200a  "BottomToTop", .
+00033160: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033170: 224c 6566 7454 6f52 6967 6874 222c 2009  "LeftToRight", .
+00033180: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00033190: 2022 5269 6768 7454 6f4c 6566 7422 2c20   "RightToLeft", 
+000331a0: 090a 2020 2020 2020 2020 2020 2020 2020  ..              
+000331b0: 2020 2254 6f70 546f 426f 7474 6f6d 225d    "TopToBottom"]
+000331c0: 0a20 2020 2020 2020 2020 0a0a 2020 2020  .         ..    
+000331d0: 2020 2020 7265 7475 726e 2076 616c 7565      return value
+000331e0: 730a 0a20 2020 2064 6566 2067 6574 5f62  s..    def get_b
+000331f0: 6561 6d5f 7365 7474 696e 6773 2873 656c  eam_settings(sel
+00033200: 662c 2062 6561 6d5f 7479 7065 3a20 4265  f, beam_type: Be
+00033210: 616d 5479 7065 2920 2d3e 2042 6561 6d53  amType) -> BeamS
+00033220: 6574 7469 6e67 733a 0a20 2020 2020 2020  ettings:.       
+00033230: 2062 6561 6d5f 7365 7474 696e 6773 203d   beam_settings =
+00033240: 2042 6561 6d53 6574 7469 6e67 7328 0a20   BeamSettings(. 
+00033250: 2020 2020 2020 2020 2020 2062 6561 6d5f             beam_
+00033260: 7479 7065 3d62 6561 6d5f 7479 7065 2c0a  type=beam_type,.
+00033270: 2020 2020 2020 2020 2020 2020 766f 6c74              volt
+00033280: 6167 653d 7365 6c66 2e67 6574 2822 766f  age=self.get("vo
+00033290: 6c74 6167 6522 2c20 6265 616d 5f74 7970  ltage", beam_typ
+000332a0: 6529 2c0a 2020 2020 2020 2020 2020 2020  e),.            
+000332b0: 6265 616d 5f63 7572 7265 6e74 3d73 656c  beam_current=sel
+000332c0: 662e 6765 7428 2263 7572 7265 6e74 222c  f.get("current",
+000332d0: 2062 6561 6d5f 7479 7065 292c 0a20 2020   beam_type),.   
+000332e0: 2020 2020 2020 2020 2077 6f72 6b69 6e67           working
+000332f0: 5f64 6973 7461 6e63 653d 7365 6c66 2e67  _distance=self.g
+00033300: 6574 2822 776f 726b 696e 675f 6469 7374  et("working_dist
+00033310: 616e 6365 222c 2062 6561 6d5f 7479 7065  ance", beam_type
+00033320: 292c 0a20 2020 2020 2020 2020 2020 2068  ),.            h
+00033330: 6677 3d73 656c 662e 6765 7428 2268 6677  fw=self.get("hfw
+00033340: 222c 2062 6561 6d5f 7479 7065 292c 0a20  ", beam_type),. 
+00033350: 2020 2020 2020 2020 2020 2073 7469 676d             stigm
+00033360: 6174 696f 6e3d 7365 6c66 2e67 6574 2822  ation=self.get("
+00033370: 7374 6967 6d61 7469 6f6e 222c 2062 6561  stigmation", bea
+00033380: 6d5f 7479 7065 292c 0a20 2020 2020 2020  m_type),.       
+00033390: 2020 2020 2073 6869 6674 3d73 656c 662e       shift=self.
+000333a0: 6765 7428 2273 6869 6674 222c 2062 6561  get("shift", bea
+000333b0: 6d5f 7479 7065 292c 0a20 2020 2020 2020  m_type),.       
+000333c0: 2020 2020 2072 6573 6f6c 7574 696f 6e3d       resolution=
+000333d0: 7365 6c66 2e67 6574 2822 7265 736f 6c75  self.get("resolu
+000333e0: 7469 6f6e 222c 2062 6561 6d5f 7479 7065  tion", beam_type
+000333f0: 292c 0a20 2020 2020 2020 2020 2020 2064  ),.            d
+00033400: 7765 6c6c 5f74 696d 653d 7365 6c66 2e67  well_time=self.g
+00033410: 6574 2822 6477 656c 6c5f 7469 6d65 222c  et("dwell_time",
+00033420: 2062 6561 6d5f 7479 7065 292c 0a20 2020   beam_type),.   
+00033430: 2020 2020 2029 0a20 2020 2020 2020 2072       ).        r
+00033440: 6574 7572 6e20 6265 616d 5f73 6574 7469  eturn beam_setti
+00033450: 6e67 730a 2020 2020 0a20 2020 2064 6566  ngs.    .    def
+00033460: 2073 6574 5f62 6561 6d5f 7365 7474 696e   set_beam_settin
+00033470: 6773 2873 656c 662c 2062 6561 6d5f 7365  gs(self, beam_se
+00033480: 7474 696e 6773 3a20 4265 616d 5379 7374  ttings: BeamSyst
+00033490: 656d 5365 7474 696e 6773 2920 2d3e 204e  emSettings) -> N
+000334a0: 6f6e 653a 0a20 2020 2020 2020 2022 2222  one:.        """
+000334b0: 5365 7420 7468 6520 6265 616d 2073 6574  Set the beam set
+000334c0: 7469 6e67 7320 666f 7220 7468 6520 7370  tings for the sp
+000334d0: 6563 6966 6965 6420 6265 616d 2074 7970  ecified beam typ
+000334e0: 652e 0a0a 2020 2020 2020 2020 4172 6773  e...        Args
+000334f0: 3a0a 2020 2020 2020 2020 2020 2020 6265  :.            be
+00033500: 616d 5f73 6574 7469 6e67 7320 2842 6561  am_settings (Bea
+00033510: 6d53 6574 7469 6e67 7329 3a20 4120 6042  mSettings): A `B
+00033520: 6561 6d53 6574 7469 6e67 7360 206f 626a  eamSettings` obj
+00033530: 6563 7420 636f 6e74 6169 6e69 6e67 2074  ect containing t
+00033540: 6865 2062 6561 6d20 7365 7474 696e 6773  he beam settings
+00033550: 2074 6f20 7365 742e 0a0a 2020 2020 2020   to set...      
+00033560: 2020 5265 7475 726e 733a 0a20 2020 2020    Returns:.     
+00033570: 2020 2020 2020 204e 6f6e 652e 0a0a 2020         None...  
+00033580: 2020 2020 2020 5261 6973 6573 3a0a 2020        Raises:.  
+00033590: 2020 2020 2020 2020 2020 4e6f 6e65 2e0a            None..
+000335a0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+000335b0: 2020 2020 6c6f 6767 696e 672e 696e 666f      logging.info
+000335c0: 2866 2253 6574 7469 6e67 207b 6265 616d  (f"Setting {beam
+000335d0: 5f73 6574 7469 6e67 732e 6265 616d 5f74  _settings.beam_t
+000335e0: 7970 652e 6e61 6d65 7d20 6265 616d 2073  ype.name} beam s
+000335f0: 6574 7469 6e67 732e 2e2e 2229 0a20 2020  ettings...").   
+00033600: 2020 2020 2073 656c 662e 7365 7428 2277       self.set("w
+00033610: 6f72 6b69 6e67 5f64 6973 7461 6e63 6522  orking_distance"
+00033620: 2c20 6265 616d 5f73 6574 7469 6e67 732e  , beam_settings.
+00033630: 6575 6365 6e74 7269 635f 6865 6967 6874  eucentric_height
+00033640: 2c20 6265 616d 5f73 6574 7469 6e67 732e  , beam_settings.
+00033650: 6265 616d 5f74 7970 6529 0a20 2020 2020  beam_type).     
+00033660: 2020 2073 656c 662e 7365 7428 2263 7572     self.set("cur
+00033670: 7265 6e74 222c 2062 6561 6d5f 7365 7474  rent", beam_sett
+00033680: 696e 6773 2e63 7572 7265 6e74 2c20 6265  ings.current, be
+00033690: 616d 5f73 6574 7469 6e67 732e 6265 616d  am_settings.beam
+000336a0: 5f74 7970 6529 0a20 2020 2020 2020 2073  _type).        s
+000336b0: 656c 662e 7365 7428 2276 6f6c 7461 6765  elf.set("voltage
+000336c0: 222c 2062 6561 6d5f 7365 7474 696e 6773  ", beam_settings
+000336d0: 2e76 6f6c 7461 6765 2c20 6265 616d 5f73  .voltage, beam_s
+000336e0: 6574 7469 6e67 732e 6265 616d 5f74 7970  ettings.beam_typ
+000336f0: 6529 0a20 2020 2020 2020 2073 656c 662e  e).        self.
+00033700: 7365 7428 2264 6574 6563 746f 725f 7479  set("detector_ty
+00033710: 7065 222c 2062 6561 6d5f 7365 7474 696e  pe", beam_settin
+00033720: 6773 2e64 6574 6563 746f 725f 7479 7065  gs.detector_type
+00033730: 2c20 6265 616d 5f73 6574 7469 6e67 732e  , beam_settings.
+00033740: 6265 616d 5f74 7970 6529 0a20 2020 2020  beam_type).     
+00033750: 2020 200a 2020 2020 6465 6620 6765 745f     .    def get_
+00033760: 6465 7465 6374 6f72 5f73 6574 7469 6e67  detector_setting
+00033770: 7328 7365 6c66 2c20 6265 616d 5f74 7970  s(self, beam_typ
+00033780: 653a 2042 6561 6d54 7970 6529 202d 3e20  e: BeamType) -> 
+00033790: 4669 6273 656d 4465 7465 6374 6f72 5365  FibsemDetectorSe
+000337a0: 7474 696e 6773 3a0a 2020 2020 2020 2020  ttings:.        
+000337b0: 6465 7465 6374 6f72 5f73 6574 7469 6e67  detector_setting
+000337c0: 7320 3d20 4669 6273 656d 4465 7465 6374  s = FibsemDetect
+000337d0: 6f72 5365 7474 696e 6773 280a 2020 2020  orSettings(.    
+000337e0: 2020 2020 2020 2020 6474 7970 653d 7365          dtype=se
+000337f0: 6c66 2e67 6574 2822 6465 7465 6374 6f72  lf.get("detector
+00033800: 5f74 7970 6522 2c20 6265 616d 5f74 7970  _type", beam_typ
+00033810: 6529 2c0a 2020 2020 2020 2020 2020 2020  e),.            
+00033820: 6d6f 6465 3d73 656c 662e 6765 7428 2264  mode=self.get("d
+00033830: 6574 6563 746f 725f 6d6f 6465 222c 2062  etector_mode", b
+00033840: 6561 6d5f 7479 7065 292c 0a20 2020 2020  eam_type),.     
+00033850: 2020 2020 2020 2062 7269 6768 746e 6573         brightnes
+00033860: 733d 7365 6c66 2e67 6574 2822 6465 7465  s=self.get("dete
+00033870: 6374 6f72 5f62 7269 6768 746e 6573 7322  ctor_brightness"
+00033880: 2c20 6265 616d 5f74 7970 6529 2c0a 2020  , beam_type),.  
+00033890: 2020 2020 2020 2020 2020 636f 6e74 7261            contra
+000338a0: 7374 3d73 656c 662e 6765 7428 2264 6574  st=self.get("det
+000338b0: 6563 746f 725f 636f 6e74 7261 7374 222c  ector_contrast",
+000338c0: 2062 6561 6d5f 7479 7065 292c 0a20 2020   beam_type),.   
+000338d0: 2020 2020 2029 0a20 2020 2020 2020 2072       ).        r
+000338e0: 6574 7572 6e20 6465 7465 6374 6f72 5f73  eturn detector_s
+000338f0: 6574 7469 6e67 730a 0a20 2020 2064 6566  ettings..    def
+00033900: 2067 6574 2873 656c 662c 206b 6579 2c20   get(self, key, 
+00033910: 6265 616d 5f74 7970 653a 2042 6561 6d54  beam_type: BeamT
+00033920: 7970 6520 3d20 4e6f 6e65 2920 2d3e 2066  ype = None) -> f
+00033930: 6c6f 6174 3a0a 2020 2020 2020 2020 6c6f  loat:.        lo
+00033940: 6767 696e 672e 6465 6275 6728 6622 4765  gging.debug(f"Ge
+00033950: 7474 696e 6720 7b6b 6579 7d20 287b 6265  tting {key} ({be
+00033960: 616d 5f74 7970 657d 2922 290a 0a20 2020  am_type})")..   
+00033970: 2020 2020 2023 2067 6574 2062 6561 6d0a       # get beam.
+00033980: 2020 2020 2020 2020 6966 2062 6561 6d5f          if beam_
+00033990: 7479 7065 2069 7320 6e6f 7420 4e6f 6e65  type is not None
+000339a0: 3a0a 2020 2020 2020 2020 2020 2020 6265  :.            be
+000339b0: 616d 203d 2073 656c 662e 656c 6563 7472  am = self.electr
+000339c0: 6f6e 5f62 6561 6d20 6966 2062 6561 6d5f  on_beam if beam_
+000339d0: 7479 7065 2069 7320 4265 616d 5479 7065  type is BeamType
+000339e0: 2e45 4c45 4354 524f 4e20 656c 7365 2073  .ELECTRON else s
+000339f0: 656c 662e 696f 6e5f 6265 616d 0a20 2020  elf.ion_beam.   
+00033a00: 2020 2020 2020 2020 2064 6574 6563 746f           detecto
+00033a10: 7220 3d20 7365 6c66 2e65 6c65 6374 726f  r = self.electro
+00033a20: 6e5f 6465 7465 6374 6f72 5f73 6574 7469  n_detector_setti
+00033a30: 6e67 7320 6966 2062 6561 6d5f 7479 7065  ngs if beam_type
+00033a40: 2069 7320 4265 616d 5479 7065 2e45 4c45   is BeamType.ELE
+00033a50: 4354 524f 4e20 656c 7365 2073 656c 662e  CTRON else self.
+00033a60: 696f 6e5f 6465 7465 6374 6f72 5f73 6574  ion_detector_set
+00033a70: 7469 6e67 730a 2020 2020 2020 2020 2320  tings.        # 
+00033a80: 766f 6c74 6167 650a 2020 2020 2020 2020  voltage.        
+00033a90: 6966 206b 6579 203d 3d20 2276 6f6c 7461  if key == "volta
+00033aa0: 6765 223a 0a20 2020 2020 2020 2020 2020  ge":.           
+00033ab0: 205f 6368 6563 6b5f 6265 616d 2862 6561   _check_beam(bea
+00033ac0: 6d5f 7479 7065 2c20 7365 6c66 2e68 6172  m_type, self.har
+00033ad0: 6477 6172 655f 7365 7474 696e 6773 290a  dware_settings).
+00033ae0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00033af0: 726e 2062 6561 6d2e 766f 6c74 6167 650a  rn beam.voltage.
+00033b00: 2020 2020 2020 2020 2020 2020 0a20 2020              .   
+00033b10: 2020 2020 2023 2063 7572 7265 6e74 0a20       # current. 
+00033b20: 2020 2020 2020 2069 6620 6b65 7920 3d3d         if key ==
+00033b30: 2022 6375 7272 656e 7422 3a0a 2020 2020   "current":.    
+00033b40: 2020 2020 2020 2020 5f63 6865 636b 5f62          _check_b
+00033b50: 6561 6d28 6265 616d 5f74 7970 652c 2073  eam(beam_type, s
+00033b60: 656c 662e 6861 7264 7761 7265 5f73 6574  elf.hardware_set
+00033b70: 7469 6e67 7329 0a20 2020 2020 2020 2020  tings).         
+00033b80: 2020 2072 6574 7572 6e20 6265 616d 2e62     return beam.b
+00033b90: 6561 6d5f 6375 7272 656e 740a 0a20 2020  eam_current..   
+00033ba0: 2020 2020 2023 2077 6f72 6b69 6e67 2064       # working d
+00033bb0: 6973 7461 6e63 650a 2020 2020 2020 2020  istance.        
+00033bc0: 6966 206b 6579 203d 3d20 2277 6f72 6b69  if key == "worki
+00033bd0: 6e67 5f64 6973 7461 6e63 6522 3a0a 2020  ng_distance":.  
+00033be0: 2020 2020 2020 2020 2020 5f63 6865 636b            _check
+00033bf0: 5f62 6561 6d28 6265 616d 5f74 7970 652c  _beam(beam_type,
+00033c00: 2073 656c 662e 6861 7264 7761 7265 5f73   self.hardware_s
+00033c10: 6574 7469 6e67 7329 0a20 2020 2020 2020  ettings).       
+00033c20: 2020 2020 2072 6574 7572 6e20 6265 616d       return beam
+00033c30: 2e77 6f72 6b69 6e67 5f64 6973 7461 6e63  .working_distanc
+00033c40: 650a 2020 2020 2020 2020 0a20 2020 2020  e.        .     
+00033c50: 2020 2069 6620 6b65 7920 3d3d 2022 7374     if key == "st
+00033c60: 6967 6d61 7469 6f6e 223a 0a20 2020 2020  igmation":.     
+00033c70: 2020 2020 2020 205f 6368 6563 6b5f 6265         _check_be
+00033c80: 616d 2862 6561 6d5f 7479 7065 2c20 7365  am(beam_type, se
+00033c90: 6c66 2e68 6172 6477 6172 655f 7365 7474  lf.hardware_sett
+00033ca0: 696e 6773 290a 2020 2020 2020 2020 2020  ings).          
+00033cb0: 2020 7265 7475 726e 2050 6f69 6e74 2862    return Point(b
+00033cc0: 6561 6d2e 7374 6967 6d61 7469 6f6e 2e78  eam.stigmation.x
+00033cd0: 2c20 6265 616d 2e73 7469 676d 6174 696f  , beam.stigmatio
+00033ce0: 6e2e 7929 0a20 2020 2020 2020 2069 6620  n.y).        if 
+00033cf0: 6b65 7920 3d3d 2022 7368 6966 7422 3a0a  key == "shift":.
+00033d00: 2020 2020 2020 2020 2020 2020 5f63 6865              _che
+00033d10: 636b 5f62 6561 6d28 6265 616d 5f74 7970  ck_beam(beam_typ
+00033d20: 652c 2073 656c 662e 6861 7264 7761 7265  e, self.hardware
+00033d30: 5f73 6574 7469 6e67 7329 0a20 2020 2020  _settings).     
+00033d40: 2020 2020 2020 2072 6574 7572 6e20 506f         return Po
+00033d50: 696e 7428 6265 616d 2e73 6869 6674 2e78  int(beam.shift.x
+00033d60: 2c20 6265 616d 2e73 6869 6674 2e79 290a  , beam.shift.y).
+00033d70: 0a20 2020 2020 2020 2069 6620 6b65 7920  .        if key 
+00033d80: 3d3d 2022 7363 616e 5f72 6f74 6174 696f  == "scan_rotatio
+00033d90: 6e22 3a0a 2020 2020 2020 2020 2020 2020  n":.            
+00033da0: 5f63 6865 636b 5f62 6561 6d28 6265 616d  _check_beam(beam
+00033db0: 5f74 7970 652c 2073 656c 662e 6861 7264  _type, self.hard
+00033dc0: 7761 7265 5f73 6574 7469 6e67 7329 0a20  ware_settings). 
+00033dd0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00033de0: 6e20 6265 616d 2e73 6361 6e5f 726f 7461  n beam.scan_rota
+00033df0: 7469 6f6e 0a0a 2020 2020 2020 2020 6966  tion..        if
+00033e00: 206b 6579 203d 3d20 2264 6574 6563 746f   key == "detecto
+00033e10: 725f 7479 7065 223a 0a20 2020 2020 2020  r_type":.       
+00033e20: 2020 2020 2072 6574 7572 6e20 6465 7465       return dete
+00033e30: 6374 6f72 2e74 7970 650a 2020 2020 2020  ctor.type.      
+00033e40: 2020 6966 206b 6579 203d 3d20 2264 6574    if key == "det
+00033e50: 6563 746f 725f 6d6f 6465 223a 0a20 2020  ector_mode":.   
+00033e60: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+00033e70: 6465 7465 6374 6f72 2e6d 6f64 650a 2020  detector.mode.  
+00033e80: 2020 2020 2020 6966 206b 6579 203d 3d20        if key == 
+00033e90: 2264 6574 6563 746f 725f 6272 6967 6874  "detector_bright
+00033ea0: 6e65 7373 223a 0a20 2020 2020 2020 2020  ness":.         
+00033eb0: 2020 2072 6574 7572 6e20 6465 7465 6374     return detect
+00033ec0: 6f72 2e62 7269 6768 746e 6573 730a 2020  or.brightness.  
+00033ed0: 2020 2020 2020 6966 206b 6579 203d 3d20        if key == 
+00033ee0: 2264 6574 6563 746f 725f 636f 6e74 7261  "detector_contra
+00033ef0: 7374 223a 0a20 2020 2020 2020 2020 2020  st":.           
+00033f00: 2072 6574 7572 6e20 6465 7465 6374 6f72   return detector
+00033f10: 2e63 6f6e 7472 6173 740a 0a20 2020 2020  .contrast..     
+00033f20: 2020 206c 6f67 6769 6e67 2e77 6172 6e69     logging.warni
+00033f30: 6e67 2866 2255 6e6b 6e6f 776e 206b 6579  ng(f"Unknown key
+00033f40: 3a20 7b6b 6579 7d20 287b 6265 616d 5f74  : {key} ({beam_t
+00033f50: 7970 657d 2922 290a 2020 2020 2020 2020  ype})").        
+00033f60: 7265 7475 726e 204e 6f74 496d 706c 656d  return NotImplem
+00033f70: 656e 7465 640a 0a20 2020 2064 6566 2073  ented..    def s
+00033f80: 6574 2873 656c 662c 206b 6579 3a20 7374  et(self, key: st
+00033f90: 722c 2076 616c 7565 2c20 6265 616d 5f74  r, value, beam_t
+00033fa0: 7970 653a 2042 6561 6d54 7970 6520 3d20  ype: BeamType = 
+00033fb0: 4e6f 6e65 2920 2d3e 204e 6f6e 653a 0a20  None) -> None:. 
+00033fc0: 2020 2020 2020 206c 6f67 6769 6e67 2e69         logging.i
+00033fd0: 6e66 6f28 6622 5365 7474 696e 6720 7b6b  nfo(f"Setting {k
+00033fe0: 6579 7d20 746f 207b 7661 6c75 657d 2028  ey} to {value} (
+00033ff0: 7b62 6561 6d5f 7479 7065 7d29 2229 0a20  {beam_type})"). 
+00034000: 2020 2020 2020 200a 2020 2020 2020 2020         .        
+00034010: 2320 6765 7420 6265 616d 0a20 2020 2020  # get beam.     
+00034020: 2020 2069 6620 6265 616d 5f74 7970 6520     if beam_type 
+00034030: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
+00034040: 2020 2020 2020 2020 2062 6561 6d20 3d20           beam = 
+00034050: 7365 6c66 2e65 6c65 6374 726f 6e5f 6265  self.electron_be
+00034060: 616d 2069 6620 6265 616d 5f74 7970 6520  am if beam_type 
+00034070: 6973 2042 6561 6d54 7970 652e 454c 4543  is BeamType.ELEC
+00034080: 5452 4f4e 2065 6c73 6520 7365 6c66 2e69  TRON else self.i
+00034090: 6f6e 5f62 6561 6d0a 2020 2020 2020 2020  on_beam.        
+000340a0: 2020 2020 6465 7465 6374 6f72 203d 2073      detector = s
+000340b0: 656c 662e 656c 6563 7472 6f6e 5f64 6574  elf.electron_det
+000340c0: 6563 746f 725f 7365 7474 696e 6773 2069  ector_settings i
+000340d0: 6620 6265 616d 5f74 7970 6520 6973 2042  f beam_type is B
+000340e0: 6561 6d54 7970 652e 454c 4543 5452 4f4e  eamType.ELECTRON
+000340f0: 2065 6c73 6520 7365 6c66 2e69 6f6e 5f64   else self.ion_d
+00034100: 6574 6563 746f 725f 7365 7474 696e 6773  etector_settings
+00034110: 0a0a 2020 2020 2020 2020 2320 766f 6c74  ..        # volt
+00034120: 6167 650a 2020 2020 2020 2020 6966 206b  age.        if k
+00034130: 6579 203d 3d20 2276 6f6c 7461 6765 223a  ey == "voltage":
+00034140: 0a20 2020 2020 2020 2020 2020 205f 6368  .            _ch
+00034150: 6563 6b5f 6265 616d 2862 6561 6d5f 7479  eck_beam(beam_ty
+00034160: 7065 2c20 7365 6c66 2e68 6172 6477 6172  pe, self.hardwar
+00034170: 655f 7365 7474 696e 6773 290a 2020 2020  e_settings).    
+00034180: 2020 2020 2020 2020 6265 616d 2e76 6f6c          beam.vol
+00034190: 7461 6765 203d 2076 616c 7565 0a20 2020  tage = value.   
+000341a0: 2020 2020 2020 2020 2072 6574 7572 6e0a           return.
+000341b0: 2020 2020 2020 2020 2320 6375 7272 656e          # curren
+000341c0: 740a 2020 2020 2020 2020 6966 206b 6579  t.        if key
+000341d0: 203d 3d20 2263 7572 7265 6e74 223a 0a20   == "current":. 
+000341e0: 2020 2020 2020 2020 2020 205f 6368 6563             _chec
+000341f0: 6b5f 6265 616d 2862 6561 6d5f 7479 7065  k_beam(beam_type
+00034200: 2c20 7365 6c66 2e68 6172 6477 6172 655f  , self.hardware_
+00034210: 7365 7474 696e 6773 290a 2020 2020 2020  settings).      
+00034220: 2020 2020 2020 6265 616d 2e62 6561 6d5f        beam.beam_
+00034230: 6375 7272 656e 7420 3d20 7661 6c75 650a  current = value.
+00034240: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00034250: 726e 2020 2020 2020 2020 0a20 2020 2020  rn        .     
+00034260: 2020 200a 2020 2020 2020 2020 6966 206b     .        if k
+00034270: 6579 203d 3d20 2277 6f72 6b69 6e67 5f64  ey == "working_d
+00034280: 6973 7461 6e63 6522 3a0a 2020 2020 2020  istance":.      
+00034290: 2020 2020 2020 5f63 6865 636b 5f62 6561        _check_bea
+000342a0: 6d28 6265 616d 5f74 7970 652c 2073 656c  m(beam_type, sel
+000342b0: 662e 6861 7264 7761 7265 5f73 6574 7469  f.hardware_setti
+000342c0: 6e67 7329 0a20 2020 2020 2020 2020 2020  ngs).           
+000342d0: 2062 6561 6d2e 776f 726b 696e 675f 6469   beam.working_di
+000342e0: 7374 616e 6365 203d 2076 616c 7565 0a20  stance = value. 
+000342f0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00034300: 6e0a 2020 2020 2020 2020 0a20 2020 2020  n.        .     
+00034310: 2020 2069 6620 6b65 7920 3d3d 2022 7374     if key == "st
+00034320: 6967 6d61 7469 6f6e 223a 0a20 2020 2020  igmation":.     
+00034330: 2020 2020 2020 205f 6368 6563 6b5f 6265         _check_be
+00034340: 616d 2862 6561 6d5f 7479 7065 2c20 7365  am(beam_type, se
+00034350: 6c66 2e68 6172 6477 6172 655f 7365 7474  lf.hardware_sett
+00034360: 696e 6773 290a 2020 2020 2020 2020 2020  ings).          
+00034370: 2020 6265 616d 2e73 7469 676d 6174 696f    beam.stigmatio
+00034380: 6e20 3d20 7661 6c75 650a 2020 2020 2020  n = value.      
+00034390: 2020 2020 2020 7265 7475 726e 0a20 2020        return.   
+000343a0: 2020 2020 2069 6620 6b65 7920 3d3d 2022       if key == "
+000343b0: 7368 6966 7422 3a0a 2020 2020 2020 2020  shift":.        
+000343c0: 2020 2020 5f63 6865 636b 5f62 6561 6d28      _check_beam(
+000343d0: 6265 616d 5f74 7970 652c 2073 656c 662e  beam_type, self.
+000343e0: 6861 7264 7761 7265 5f73 6574 7469 6e67  hardware_setting
+000343f0: 7329 0a20 2020 2020 2020 2020 2020 2062  s).            b
+00034400: 6561 6d2e 7368 6966 7420 3d20 7661 6c75  eam.shift = valu
+00034410: 650a 2020 2020 2020 2020 2020 2020 7265  e.            re
+00034420: 7475 726e 0a0a 2020 2020 2020 2020 6966  turn..        if
+00034430: 206b 6579 203d 3d20 2264 6574 6563 746f   key == "detecto
+00034440: 725f 7479 7065 223a 0a20 2020 2020 2020  r_type":.       
+00034450: 2020 2020 2064 6574 6563 746f 722e 7479       detector.ty
+00034460: 7065 203d 2076 616c 7565 0a20 2020 2020  pe = value.     
+00034470: 2020 2020 2020 2072 6574 7572 6e0a 2020         return.  
+00034480: 2020 2020 2020 6966 206b 6579 203d 3d20        if key == 
+00034490: 2264 6574 6563 746f 725f 6d6f 6465 223a  "detector_mode":
+000344a0: 0a20 2020 2020 2020 2020 2020 2064 6574  .            det
+000344b0: 6563 746f 722e 6d6f 6465 203d 2076 616c  ector.mode = val
+000344c0: 7565 0a20 2020 2020 2020 2020 2020 2072  ue.            r
+000344d0: 6574 7572 6e20 0a20 2020 2020 2020 2069  eturn .        i
+000344e0: 6620 6b65 7920 3d3d 2022 6465 7465 6374  f key == "detect
+000344f0: 6f72 5f63 6f6e 7472 6173 7422 3a0a 2020  or_contrast":.  
+00034500: 2020 2020 2020 2020 2020 6465 7465 6374            detect
+00034510: 6f72 2e63 6f6e 7472 6173 7420 3d20 7661  or.contrast = va
+00034520: 6c75 650a 2020 2020 2020 2020 2020 2020  lue.            
+00034530: 7265 7475 726e 0a20 2020 2020 2020 2069  return.        i
+00034540: 6620 6b65 7920 3d3d 2022 6465 7465 6374  f key == "detect
+00034550: 6f72 5f62 7269 6768 746e 6573 7322 3a0a  or_brightness":.
+00034560: 2020 2020 2020 2020 2020 2020 6465 7465              dete
+00034570: 6374 6f72 2e62 7269 6768 746e 6573 7320  ctor.brightness 
+00034580: 3d20 7661 6c75 650a 2020 2020 2020 2020  = value.        
+00034590: 2020 2020 7265 7475 726e 0a0a 2020 2020      return..    
+000345a0: 2020 2020 6c6f 6767 696e 672e 7761 726e      logging.warn
+000345b0: 696e 6728 6622 556e 6b6e 6f77 6e20 6b65  ing(f"Unknown ke
+000345c0: 793a 207b 6b65 797d 2028 7b62 6561 6d5f  y: {key} ({beam_
+000345d0: 7479 7065 7d29 2229 0a20 2020 2020 2020  type})").       
+000345e0: 2072 6574 7572 6e20 4e6f 7449 6d70 6c65   return NotImple
+000345f0: 6d65 6e74 6564 0a0a 2020 2020 6465 6620  mented..    def 
+00034600: 6765 745f 6265 616d 5f73 7973 7465 6d5f  get_beam_system_
+00034610: 7374 6174 6528 7365 6c66 2c20 6265 616d  state(self, beam
+00034620: 5f74 7970 653a 2042 6561 6d54 7970 6529  _type: BeamType)
+00034630: 202d 3e20 4265 616d 5379 7374 656d 5365   -> BeamSystemSe
+00034640: 7474 696e 6773 3a0a 2020 2020 2020 2020  ttings:.        
+00034650: 5f63 6865 636b 5f62 6561 6d28 6265 616d  _check_beam(beam
+00034660: 5f74 7970 652c 2073 656c 662e 6861 7264  _type, self.hard
+00034670: 7761 7265 5f73 6574 7469 6e67 7329 0a20  ware_settings). 
+00034680: 2020 2020 2020 2023 2067 6574 2063 7572         # get cur
+00034690: 7265 6e74 2062 6561 6d20 7365 7474 696e  rent beam settin
+000346a0: 6773 0a20 2020 2020 2020 2076 6f6c 7461  gs.        volta
+000346b0: 6765 203d 2033 3030 3030 0a20 2020 2020  ge = 30000.     
+000346c0: 2020 2063 7572 7265 6e74 203d 2032 3065     current = 20e
+000346d0: 2d31 3220 0a20 2020 2020 2020 2064 6574  -12 .        det
+000346e0: 6563 746f 725f 7479 7065 203d 2022 4554  ector_type = "ET
+000346f0: 4422 0a20 2020 2020 2020 2064 6574 6563  D".        detec
+00034700: 746f 725f 6d6f 6465 203d 2022 5365 636f  tor_mode = "Seco
+00034710: 6e64 6172 7945 6c65 6374 726f 6e73 220a  ndaryElectrons".
+00034720: 2020 2020 2020 2020 7368 6966 7420 3d20          shift = 
+00034730: 506f 696e 7428 302c 2030 290a 0a20 2020  Point(0, 0)..   
+00034740: 2020 2020 2069 6620 6265 616d 5f74 7970       if beam_typ
+00034750: 6520 6973 2042 6561 6d54 7970 652e 494f  e is BeamType.IO
+00034760: 4e3a 0a20 2020 2020 2020 2020 2020 2065  N:.            e
+00034770: 7563 656e 7472 6963 5f68 6569 6768 7420  ucentric_height 
+00034780: 3d20 3136 2e35 652d 330a 2020 2020 2020  = 16.5e-3.      
+00034790: 2020 2020 2020 706c 6173 6d61 5f67 6173        plasma_gas
+000347a0: 203d 2022 4172 676f 6e22 0a20 2020 2020   = "Argon".     
+000347b0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+000347c0: 2020 2020 2065 7563 656e 7472 6963 5f68       eucentric_h
+000347d0: 6569 6768 7420 3d20 342e 3065 2d33 0a20  eight = 4.0e-3. 
+000347e0: 2020 2020 2020 2020 2020 2070 6c61 736d             plasm
+000347f0: 615f 6761 7320 3d20 4e6f 6e65 0a0a 2020  a_gas = None..  
+00034800: 2020 2020 2020 7265 7475 726e 2042 6561        return Bea
+00034810: 6d53 7973 7465 6d53 6574 7469 6e67 7328  mSystemSettings(
+00034820: 0a20 2020 2020 2020 2020 2020 2062 6561  .            bea
+00034830: 6d5f 7479 7065 3d62 6561 6d5f 7479 7065  m_type=beam_type
+00034840: 2c0a 2020 2020 2020 2020 2020 2020 766f  ,.            vo
+00034850: 6c74 6167 653d 766f 6c74 6167 652c 0a20  ltage=voltage,. 
+00034860: 2020 2020 2020 2020 2020 2063 7572 7265             curre
+00034870: 6e74 3d63 7572 7265 6e74 2c0a 2020 2020  nt=current,.    
+00034880: 2020 2020 2020 2020 6465 7465 6374 6f72          detector
+00034890: 5f74 7970 653d 6465 7465 6374 6f72 5f74  _type=detector_t
+000348a0: 7970 652c 0a20 2020 2020 2020 2020 2020  ype,.           
+000348b0: 2064 6574 6563 746f 725f 6d6f 6465 3d64   detector_mode=d
+000348c0: 6574 6563 746f 725f 6d6f 6465 2c0a 2020  etector_mode,.  
+000348d0: 2020 2020 2020 2020 2020 6575 6365 6e74            eucent
+000348e0: 7269 635f 6865 6967 6874 3d65 7563 656e  ric_height=eucen
+000348f0: 7472 6963 5f68 6569 6768 742c 0a20 2020  tric_height,.   
+00034900: 2020 2020 2020 2020 2070 6c61 736d 615f           plasma_
+00034910: 6761 733d 706c 6173 6d61 5f67 6173 2c0a  gas=plasma_gas,.
+00034920: 2020 2020 2020 2020 290a 2020 2020 0a20          ).    . 
+00034930: 2020 2064 6566 2063 6865 636b 5f61 7661     def check_ava
+00034940: 696c 6162 6c65 5f76 616c 7565 7328 7365  ilable_values(se
+00034950: 6c66 2c20 6b65 793a 2073 7472 2c20 7661  lf, key: str, va
+00034960: 6c75 652c 2062 6561 6d5f 7479 7065 3a20  lue, beam_type: 
+00034970: 4265 616d 5479 7065 203d 204e 6f6e 6529  BeamType = None)
+00034980: 202d 3e20 626f 6f6c 3a0a 2020 2020 2020   -> bool:.      
+00034990: 2020 6c6f 6767 696e 672e 696e 666f 2866    logging.info(f
+000349a0: 2243 6865 636b 696e 6720 6966 207b 6b65  "Checking if {ke
+000349b0: 797d 3d7b 7661 6c75 657d 2069 7320 6176  y}={value} is av
+000349c0: 6169 6c61 626c 6520 287b 6265 616d 5f74  ailable ({beam_t
+000349d0: 7970 657d 2922 290a 2020 2020 2020 2020  ype})").        
+000349e0: 7265 7475 726e 2054 7275 650a 2020 2020  return True.    
+000349f0: 0a20 2020 2064 6566 2068 6f6d 6528 7365  .    def home(se
+00034a00: 6c66 293a 0a20 2020 2020 2020 205f 6368  lf):.        _ch
+00034a10: 6563 6b5f 7374 6167 6528 7365 6c66 2e68  eck_stage(self.h
+00034a20: 6172 6477 6172 655f 7365 7474 696e 6773  ardware_settings
+00034a30: 290a 2020 2020 2020 2020 6c6f 6767 696e  ).        loggin
+00034a40: 672e 696e 666f 2822 486f 6d69 6e67 2053  g.info("Homing S
+00034a50: 7461 6765 2229 0a20 2020 2020 2020 2072  tage").        r
+00034a60: 6574 7572 6e0a 0a0a 2323 2323 2323 2323  eturn...########
+00034a70: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00034a80: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00034a90: 2048 656c 7065 7220 6675 6e63 7469 6f6e   Helper function
+00034aa0: 7320 2323 2323 2323 2323 2323 2323 2323  s ##############
+00034ab0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00034ac0: 2323 2323 2323 2323 2323 0a0a 0a0a 6465  ##########....de
+00034ad0: 6620 7072 696e 7450 726f 6772 6573 7342  f printProgressB
+00034ae0: 6172 280a 2020 2020 7661 6c75 652c 2074  ar(.    value, t
+00034af0: 6f74 616c 2c20 7072 6566 6978 3d22 222c  otal, prefix="",
+00034b00: 2073 7566 6669 783d 2222 2c20 6465 6369   suffix="", deci
+00034b10: 6d61 6c73 3d30 2c20 6c65 6e67 7468 3d31  mals=0, length=1
+00034b20: 3030 2c20 6669 6c6c 3d22 e296 8822 0a29  00, fill="...".)
+00034b30: 3a0a 2020 2020 2222 220a 2020 2020 7465  :.    """.    te
+00034b40: 726d 696e 616c 2070 726f 6772 6573 7320  rminal progress 
+00034b50: 6261 720a 2020 2020 2222 220a 2020 2020  bar.    """.    
+00034b60: 7065 7263 656e 7420 3d20 2822 7b30 3a2e  percent = ("{0:.
+00034b70: 2220 2b20 7374 7228 6465 6369 6d61 6c73  " + str(decimals
+00034b80: 2920 2b20 2266 7d22 292e 666f 726d 6174  ) + "f}").format
+00034b90: 2831 3030 202a 2028 7661 6c75 6520 2f20  (100 * (value / 
+00034ba0: 666c 6f61 7428 746f 7461 6c29 2929 0a20  float(total))). 
+00034bb0: 2020 2066 696c 6c65 645f 6c65 6e67 7468     filled_length
+00034bc0: 203d 2069 6e74 286c 656e 6774 6820 2a20   = int(length * 
+00034bd0: 7661 6c75 6520 2f2f 2074 6f74 616c 290a  value // total).
+00034be0: 2020 2020 6261 7220 3d20 6669 6c6c 202a      bar = fill *
+00034bf0: 2066 696c 6c65 645f 6c65 6e67 7468 202b   filled_length +
+00034c00: 2022 2d22 202a 2028 6c65 6e67 7468 202d   "-" * (length -
+00034c10: 2066 696c 6c65 645f 6c65 6e67 7468 290a   filled_length).
+00034c20: 2020 2020 7072 696e 7428 6622 5c72 7b70      print(f"\r{p
+00034c30: 7265 6669 787d 207c 7b62 6172 7d7c 207b  refix} |{bar}| {
+00034c40: 7065 7263 656e 747d 2520 7b73 7566 6669  percent}% {suffi
+00034c50: 787d 222c 2065 6e64 3d22 5c72 2229 0a0a  x}", end="\r")..
+00034c60: 696d 706f 7274 2077 6172 6e69 6e67 730a  import warnings.
+00034c70: 0a64 6566 205f 6368 6563 6b5f 6265 616d  .def _check_beam
+00034c80: 2862 6561 6d5f 7479 7065 3a20 4265 616d  (beam_type: Beam
+00034c90: 5479 7065 2c20 6861 7264 7761 7265 5f73  Type, hardware_s
+00034ca0: 6574 7469 6e67 733a 2046 6962 7365 6d48  ettings: FibsemH
+00034cb0: 6172 6477 6172 6529 3a0a 2020 2020 2222  ardware):.    ""
+00034cc0: 220a 2020 2020 4368 6563 6b73 2069 6620  ".    Checks if 
+00034cd0: 6265 616d 2069 7320 6176 6169 6c61 626c  beam is availabl
+00034ce0: 652e 0a20 2020 2022 2222 0a20 2020 2069  e..    """.    i
+00034cf0: 6620 6265 616d 5f74 7970 6520 3d3d 2042  f beam_type == B
+00034d00: 6561 6d54 7970 652e 454c 4543 5452 4f4e  eamType.ELECTRON
+00034d10: 2061 6e64 2068 6172 6477 6172 655f 7365   and hardware_se
+00034d20: 7474 696e 6773 2e65 6c65 6374 726f 6e5f  ttings.electron_
+00034d30: 6265 616d 203d 3d20 4661 6c73 653a 0a20  beam == False:. 
+00034d40: 2020 2020 2020 2077 6172 6e69 6e67 732e         warnings.
+00034d50: 7761 726e 2822 5468 6520 6d69 6372 6f73  warn("The micros
+00034d60: 636f 7065 2064 6f65 7320 6e6f 7420 6861  cope does not ha
+00034d70: 7665 2061 6e20 656c 6563 7472 6f6e 2062  ve an electron b
+00034d80: 6561 6d2e 2229 0a20 2020 2069 6620 6265  eam.").    if be
+00034d90: 616d 5f74 7970 6520 3d3d 2042 6561 6d54  am_type == BeamT
+00034da0: 7970 652e 494f 4e20 616e 6420 6861 7264  ype.ION and hard
+00034db0: 7761 7265 5f73 6574 7469 6e67 732e 696f  ware_settings.io
+00034dc0: 6e5f 6265 616d 203d 3d20 4661 6c73 653a  n_beam == False:
+00034dd0: 0a20 2020 2020 2020 2077 6172 6e69 6e67  .        warning
+00034de0: 732e 7761 726e 2822 5468 6520 6d69 6372  s.warn("The micr
+00034df0: 6f73 636f 7065 2064 6f65 7320 6e6f 7420  oscope does not 
+00034e00: 6861 7665 2061 6e20 696f 6e20 6265 616d  have an ion beam
+00034e10: 2e22 290a 0a64 6566 205f 6368 6563 6b5f  .")..def _check_
+00034e20: 7374 6167 6528 6861 7264 7761 7265 5f73  stage(hardware_s
+00034e30: 6574 7469 6e67 733a 2046 6962 7365 6d48  ettings: FibsemH
+00034e40: 6172 6477 6172 652c 2072 6f74 6174 696f  ardware, rotatio
+00034e50: 6e3a 2062 6f6f 6c20 3d20 4661 6c73 652c  n: bool = False,
+00034e60: 2074 696c 743a 2062 6f6f 6c20 3d20 4661   tilt: bool = Fa
+00034e70: 6c73 6529 3a0a 2020 2020 2222 220a 2020  lse):.    """.  
+00034e80: 2020 4368 6563 6b73 2069 6620 7468 6520    Checks if the 
+00034e90: 7374 6167 6520 6973 2066 756c 6c79 206d  stage is fully m
+00034ea0: 6f76 6162 6c65 2e0a 2020 2020 2222 220a  ovable..    """.
+00034eb0: 2020 2020 6966 2068 6172 6477 6172 655f      if hardware_
+00034ec0: 7365 7474 696e 6773 2e73 7461 6765 5f65  settings.stage_e
+00034ed0: 6e61 626c 6564 203d 3d20 4661 6c73 653a  nabled == False:
+00034ee0: 0a20 2020 2020 2020 2077 6172 6e69 6e67  .        warning
+00034ef0: 732e 7761 726e 2822 5468 6520 6d69 6372  s.warn("The micr
+00034f00: 6f73 636f 7065 2064 6f65 7320 6e6f 7420  oscope does not 
+00034f10: 6861 7665 2061 206d 6f76 696e 6720 7374  have a moving st
+00034f20: 6167 652e 2229 0a20 2020 2069 6620 6861  age.").    if ha
+00034f30: 7264 7761 7265 5f73 6574 7469 6e67 732e  rdware_settings.
+00034f40: 7374 6167 655f 726f 7461 7469 6f6e 203d  stage_rotation =
+00034f50: 3d20 4661 6c73 6520 616e 6420 726f 7461  = False and rota
+00034f60: 7469 6f6e 203d 3d20 5472 7565 3a0a 2020  tion == True:.  
+00034f70: 2020 2020 2020 7761 726e 696e 6773 2e77        warnings.w
+00034f80: 6172 6e28 2254 6865 206d 6963 726f 7363  arn("The microsc
+00034f90: 6f70 6520 7374 6167 6520 646f 6573 206e  ope stage does n
+00034fa0: 6f74 2072 6f74 6174 652e 2229 0a20 2020  ot rotate.").   
+00034fb0: 2069 6620 6861 7264 7761 7265 5f73 6574   if hardware_set
+00034fc0: 7469 6e67 732e 7374 6167 655f 7469 6c74  tings.stage_tilt
+00034fd0: 203d 3d20 4661 6c73 6520 616e 6420 7469   == False and ti
+00034fe0: 6c74 203d 3d20 5472 7565 3a0a 2020 2020  lt == True:.    
+00034ff0: 2020 2020 7761 726e 696e 6773 2e77 6172      warnings.war
+00035000: 6e28 2254 6865 206d 6963 726f 7363 6f70  n("The microscop
+00035010: 6520 7374 6167 6520 646f 6573 206e 6f74  e stage does not
+00035020: 2074 696c 742e 2229 0a0a 6465 6620 5f63   tilt.")..def _c
+00035030: 6865 636b 5f6e 6565 646c 6528 6861 7264  heck_needle(hard
+00035040: 7761 7265 5f73 6574 7469 6e67 733a 2046  ware_settings: F
+00035050: 6962 7365 6d48 6172 6477 6172 652c 2072  ibsemHardware, r
+00035060: 6f74 6174 696f 6e3a 2062 6f6f 6c20 3d20  otation: bool = 
+00035070: 4661 6c73 652c 2074 696c 743a 2062 6f6f  False, tilt: boo
+00035080: 6c20 3d20 4661 6c73 6529 3a0a 2020 2020  l = False):.    
+00035090: 2222 220a 2020 2020 4368 6563 6b73 2069  """.    Checks i
+000350a0: 6620 7468 6520 6e65 6564 6c65 2069 7320  f the needle is 
+000350b0: 6176 6169 6c61 626c 652e 0a20 2020 2022  available..    "
+000350c0: 2222 0a20 2020 2069 6620 6861 7264 7761  "".    if hardwa
+000350d0: 7265 5f73 6574 7469 6e67 732e 6d61 6e69  re_settings.mani
+000350e0: 7075 6c61 746f 725f 656e 6162 6c65 6420  pulator_enabled 
+000350f0: 3d3d 2046 616c 7365 3a0a 2020 2020 2020  == False:.      
+00035100: 2020 7761 726e 696e 6773 2e77 6172 6e28    warnings.warn(
+00035110: 2254 6865 206d 6963 726f 7363 6f70 6520  "The microscope 
+00035120: 646f 6573 206e 6f74 2068 6176 6520 6120  does not have a 
+00035130: 6e65 6564 6c65 2e22 290a 2020 2020 6966  needle.").    if
+00035140: 2068 6172 6477 6172 655f 7365 7474 696e   hardware_settin
+00035150: 6773 2e6d 616e 6970 756c 6174 6f72 5f72  gs.manipulator_r
+00035160: 6f74 6174 696f 6e20 3d3d 2046 616c 7365  otation == False
+00035170: 2061 6e64 2072 6f74 6174 696f 6e20 3d3d   and rotation ==
+00035180: 2054 7275 653a 0a20 2020 2020 2020 2077   True:.        w
+00035190: 6172 6e69 6e67 732e 7761 726e 2822 5468  arnings.warn("Th
+000351a0: 6520 6d69 6372 6f73 636f 7065 206e 6565  e microscope nee
+000351b0: 646c 6520 646f 6573 206e 6f74 2072 6f74  dle does not rot
+000351c0: 6174 652e 2229 0a20 2020 2069 6620 6861  ate.").    if ha
+000351d0: 7264 7761 7265 5f73 6574 7469 6e67 732e  rdware_settings.
+000351e0: 6d61 6e69 7075 6c61 746f 725f 7469 6c74  manipulator_tilt
+000351f0: 203d 3d20 4661 6c73 6520 616e 6420 7469   == False and ti
+00035200: 6c74 203d 3d20 5472 7565 3a0a 2020 2020  lt == True:.    
+00035210: 2020 2020 7761 726e 696e 6773 2e77 6172      warnings.war
+00035220: 6e28 2254 6865 206d 6963 726f 7363 6f70  n("The microscop
+00035230: 6520 6e65 6564 6c65 2064 6f65 7320 6e6f  e needle does no
+00035240: 7420 7469 6c74 2e22 290a 0a64 6566 205f  t tilt.")..def _
+00035250: 6368 6563 6b5f 7370 7574 7465 7228 6861  check_sputter(ha
+00035260: 7264 7761 7265 5f73 6574 7469 6e67 733a  rdware_settings:
+00035270: 2046 6962 7365 6d48 6172 6477 6172 6529   FibsemHardware)
+00035280: 3a0a 2020 2020 2222 220a 2020 2020 4368  :.    """.    Ch
+00035290: 6563 6b73 2069 6620 7468 6520 7370 7574  ecks if the sput
+000352a0: 7465 7220 6973 2061 7661 696c 6162 6c65  ter is available
+000352b0: 2e0a 2020 2020 2222 220a 2020 2020 6966  ..    """.    if
+000352c0: 2068 6172 6477 6172 655f 7365 7474 696e   hardware_settin
+000352d0: 6773 2e67 6973 5f65 6e61 626c 6564 203d  gs.gis_enabled =
+000352e0: 3d20 4661 6c73 653a 0a20 2020 2020 2020  = False:.       
+000352f0: 2077 6172 6e69 6e67 732e 7761 726e 2822   warnings.warn("
+00035300: 5468 6520 6d69 6372 6f73 636f 7065 2064  The microscope d
+00035310: 6f65 7320 6e6f 7420 6861 7665 2061 2047  oes not have a G
+00035320: 4953 2073 7973 7465 6d2e 2229 0a20 2020  IS system.").   
+00035330: 2069 6620 6861 7264 7761 7265 5f73 6574   if hardware_set
+00035340: 7469 6e67 732e 6769 735f 6d75 6c74 6963  tings.gis_multic
+00035350: 6865 6d20 3d3d 2046 616c 7365 3a0a 2020  hem == False:.  
+00035360: 2020 2020 2020 7761 726e 696e 6773 2e77        warnings.w
+00035370: 6172 6e28 2254 6865 206d 6963 726f 7363  arn("The microsc
+00035380: 6f70 6520 646f 6573 206e 6f74 2068 6176  ope does not hav
+00035390: 6520 6120 6d75 6c74 6963 6865 6d20 7379  e a multichem sy
+000353a0: 7374 656d 2e22 29                        stem.")
```

## fibsem/movement.py

```diff
@@ -32,134 +32,14 @@
         logging.info(f"retracting multichem")
         multichem = microscope.gas.get_multichem()
         multichem.retract()
         logging.info(f"retract multichem complete")
 
         return
 
-    # # TODO: make these consistenly use degrees or radians...
-    # def rotation_angle_is_larger(angle1: float, angle2: float, atol: float = 90) -> bool:
-    #     """Check the rotation angles are large
-
-    #     Args:
-    #         angle1 (float): angle1 (radians)
-    #         angle2 (float): angle2 (radians)
-    #         atol : tolerance (degrees)
-
-    #     Returns:
-    #         bool: rotation angle is larger than atol
-    #     """
-
-    #     return angle_difference(angle1, angle2) > (np.deg2rad(atol))
-
-
-    # def rotation_angle_is_smaller(angle1: float, angle2: float, atol: float = 5) -> bool:
-    #     """Check the rotation angles are large
-
-    #     Args:
-    #         angle1 (float): angle1 (radians)
-    #         angle2 (float): angle2 (radians)
-    #         atol : tolerance (degrees)
-
-    #     Returns:
-    #         bool: rotation angle is smaller than atol
-    #     """
-
-    #     return angle_difference(angle1, angle2) < (np.deg2rad(atol))
-
-
-    # def angle_difference(angle1: float, angle2: float) -> float:
-    #     """Return the difference between two angles, accounting for greater than 360, less than 0 angles
-
-    #     Args:
-    #         angle1 (float): angle1 (radians)
-    #         angle2 (float): angle2 (radians)
-
-    #     Returns:
-    #         float: _description_
-    #     """
-    #     angle1 %= 2 * np.pi
-    #     angle2 %= 2 * np.pi
-
-    #     large_angle = np.max([angle1, angle2])
-    #     small_angle = np.min([angle1, angle2])
-
-    #     return min((large_angle - small_angle), ((2 * np.pi + small_angle - large_angle)))
-
-
-    def safe_rotation_movement(
-        microscope: SdbMicroscopeClient, stage_position: StagePosition
-    ):
-        """Tilt the stage flat when performing a large rotation to prevent collision.
-
-        Args:
-            microscope (SdbMicroscopeClient): autoscript microscope instance
-            stage_position (StagePosition): desired stage position.
-        """
-        stage = microscope.specimen.stage
-        stage_settings = MoveSettings(rotate_compucentric=True)
-
-        # tilt flat for large rotations to prevent collisions
-        if rotation_angle_is_larger(stage_position.r, stage.current_position.r):
-
-            stage.absolute_move(
-                StagePosition(
-                    t=np.deg2rad(0), coordinate_system=stage_position.coordinate_system
-                ),
-                stage_settings,
-            )
-            logging.info(f"tilting to flat for large rotation.")
-
-        return
-
-
-    def safe_absolute_stage_movement(
-        microscope: SdbMicroscopeClient, stage_position: StagePosition
-    ) -> None:
-        """Move the stage to the desired position in a safe manner, using compucentric rotation.
-        Supports movements in the stage_position coordinate system
-
-        Args:
-            microscope (SdbMicroscopeClient): autoscript microscope instance
-            stage_position (StagePosition): desired stage position
-
-        Returns:
-            StagePosition: _description_
-        """
-
-        # tilt flat for large rotations to prevent collisions
-        safe_rotation_movement(microscope, stage_position)
-
-        stage = microscope.specimen.stage
-        stage_settings = MoveSettings(rotate_compucentric=True)
-
-        stage.absolute_move(
-            StagePosition(
-                r=stage_position.r, coordinate_system=stage_position.coordinate_system
-            ),
-            stage_settings,
-        )
-        logging.info(f"safe moving to {stage_position}")
-        stage.absolute_move(stage_position, stage_settings)
-
-        # # rotation check
-        # while rotation_angle_is_larger(stage_position.r, stage.current_position.r, 0.5):
-
-        #     # rotate the difference
-        #     diff = stage_position.r - stage.current_position.r
-        #     logging.info(f"rotation angle is larger ({np.rad2deg(diff):.2f} deg) than desired, moving again.")
-        #     stage.relative_move(StagePosition(r=diff), stage_settings)
-
-        logging.info(f"safe movement complete.")
-
-        return
-
-
-
-
 def rotation_angle_is_larger(angle1: float, angle2: float, atol: float = 90) -> bool:
     """Check the rotation angles are large
 
     Args:
         angle1 (float): angle1 (radians)
         angle2 (float): angle2 (radians)
         atol : tolerance (degrees)
```

## fibsem/patterning.py

```diff
@@ -1,59 +1,62 @@
 import json
 from abc import ABC, abstractmethod
 from dataclasses import dataclass
 
 import yaml
 import numpy as np
 from fibsem.structures import FibsemPattern, FibsemPatternSettings, Point
+from fibsem import constants 
 
 
 def check_keys(protocol: dict, required_keys: list[str]) -> bool:
     return all([k in protocol.keys() for k in required_keys])
 
 
 REQUIRED_KEYS = {
-    "Rectangle": ("width", "height", "depth", "rotation"),
+    "Rectangle": ("width", "height", "depth", "rotation","passes", "cleaning_cross_section","scan_direction"),
     "Line": ("start_x", "end_x", "start_y", "end_y", "depth"),
-    "Circle": ("radius", "depth"),
+    "Circle": ("radius", "depth","cleaning_cross_section"),
     "Trench": (
         "lamella_width",
         "lamella_height",
         "trench_height",
         "size_ratio",
         "offset",
         "depth",
+        "cleaning_cross_section",
     ),
     "Horseshoe": (
         "lamella_width",
         "lamella_height",
         "trench_height",
         "size_ratio",
         "offset",
         "side_offset",
         "side_width",
         "depth",
     ),
-    "Fiducial": ("height", "width", "depth", "rotation"),
+    "Fiducial": ("height", "width", "depth", "rotation","cleaning_cross_section"),
     "Undercut": (
         "height",
         "width",
         "depth",
         "trench_width",
         "rhs_height",
         "h_offset",
+        "cleaning_cross_section",
     ),
     "MicroExpansion": (
         "height",
         "width",
         "depth",
         "distance",
         "lamella_width",
     ),
-    "SpotWeld": ("height", "width", "depth", "distance", "number", "rotation"),
+    "SpotWeld": ("height", "width", "depth", "distance", "number", "rotation", "passes","scan_direction"),
     "WaffleNotch": (
         "vheight",
         "vwidth",
         "hheight",
         "hwidth",
         "depth",
         "distance",
@@ -152,19 +155,20 @@
 
     def define(
         self, protocol: dict, point: Point = Point()
     ) -> list[FibsemPatternSettings]:
         protocol["centre_x"] = point.x
         protocol["centre_y"] = point.y
         protocol["pattern"] = "Rectangle"  # redundant now
-        protocol["rotation"] = protocol.get("rotation", 0)
+        protocol["rotation"] = protocol.get("rotation", 0) * constants.DEGREES_TO_RADIANS
         protocol["cleaning_cross_section"] = protocol.get(
             "cleaning_cross_section", False
         )
         protocol["scan_direction"] = protocol.get("scan_direction", "TopToBottom")
+        protocol["passes"] = protocol.get("passes", None)
         self.patterns = [FibsemPatternSettings.__from_dict__(protocol)]
         self.protocol = protocol
         self.point = point
         return self.patterns
 
 
 @dataclass
@@ -333,39 +337,39 @@
         lower_pattern = FibsemPatternSettings(
             pattern=FibsemPattern.Rectangle,
             width=lamella_width,
             height=trench_height,
             depth=depth,
             centre_x=point.x,
             centre_y=centre_lower_y,
-            cleaning_cross_section=True,
+            cleaning_cross_section=False,
             scan_direction="BottomToTop",
         )
 
         upper_pattern = FibsemPatternSettings(
             pattern=FibsemPattern.Rectangle,
             width=lamella_width,
             height=upper_trench_height,
             depth=depth,
             centre_x=point.x,
             centre_y=centre_upper_y,
-            cleaning_cross_section=True,
+            cleaning_cross_section=False,
             scan_direction="TopToBottom",
         )
 
         side_pattern = FibsemPatternSettings(
             pattern=FibsemPattern.Rectangle,
             width=protocol["side_width"],
             height=lamella_height + offset,
             depth=depth,
             centre_x=point.x
             - protocol["side_offset"]
             + (lamella_width / 2 - protocol["side_width"] / 2),
             centre_y=point.y,
-            cleaning_cross_section=True,
+            cleaning_cross_section=False,
             scan_direction="TopToBottom",
         )
 
         self.patterns = [lower_pattern, upper_pattern, side_pattern]
         self.protocol = protocol
         self.point = point
         return self.patterns
@@ -391,15 +395,15 @@
         protocol["cleaning_cross_section"] = protocol.get(
             "cleaning_cross_section", False
         )
         protocol["scan_direction"] = protocol.get("scan_direction", "TopToBottom")
 
         left_pattern = FibsemPatternSettings.__from_dict__(protocol)
         from fibsem import constants 
-        left_pattern.rotation = protocol["rotation"]*constants.DEGREES_TO_RADIANS
+        left_pattern.rotation = protocol["rotation"] * constants.DEGREES_TO_RADIANS
         right_pattern = FibsemPatternSettings.__from_dict__(protocol)
         right_pattern.rotation = left_pattern.rotation + np.deg2rad(90)
 
         self.patterns = [left_pattern, right_pattern]
         self.protocol = protocol
         self.point = point
         return self.patterns
@@ -427,15 +431,15 @@
         # jcut_lhs_offset = protocol["lhs_offset"]
         jcut_depth = protocol["depth"]
         jcut_h_offset = protocol["h_offset"]
 
         jcut_half_width = jcut_width - jcut_trench_thickness / 2
         jcut_half_height = jcut_lamella_height / 2
 
-        use_cleaning_cross_section = protocol.get("cleaning_cross_section", True)
+        use_cleaning_cross_section = protocol.get("cleaning_cross_section", False)
 
         # top_jcut
         jcut_top_centre_x = point.x + jcut_width / 2 - jcut_h_offset
         jcut_top_centre_y = point.y + jcut_lamella_height
         jcut_top_width = jcut_width
         jcut_top_height = jcut_trench_thickness
         jcut_top_depth = jcut_depth
@@ -562,28 +566,34 @@
     ) -> list[FibsemPatternSettings]:
         check_keys(protocol, self.required_keys)
         width = protocol["width"]
         height = protocol["height"]
         depth = protocol["depth"]
         distance = protocol["distance"]
         n_patterns = int(protocol["number"])
-        rotation = protocol["rotation"]
+        rotation = protocol.get("rotation", 0)
+        passes = protocol.get("passes", 1)
+        scan_direction = protocol.get("scan_direction", "LeftToRight")
+        passes = int(passes) if passes is not None else None
+
 
         patterns = []
         for i in range(n_patterns):
             pattern_settings = FibsemPatternSettings(
                 pattern=FibsemPattern.Rectangle,
                 width=width,
                 height=height,
                 depth=depth,
                 centre_x=point.x,
                 centre_y=point.y + (i - (n_patterns - 1) / 2) * distance,
-                cleaning_cross_section=True,
-                scan_direction="LeftToRight",
+                cleaning_cross_section=False,
+                scan_direction=scan_direction,
+
                 rotation=rotation,
+                passes=passes,
             )
             patterns.append(pattern_settings)
 
         self.patterns = patterns
         self.protocol = protocol
         self.point = point
         return self.patterns
@@ -912,15 +922,15 @@
     "fiducial": FiducialPattern,
     "flatten": RectanglePattern,
     "undercut": UndercutPattern,
     "horseshoe": HorseshoePattern,
     "lamella": TrenchPattern,
     "polish_lamella": TrenchPattern,
     "thin_lamella": TrenchPattern,
-    "weld": RectanglePattern,
+    "weld": SpotWeldPattern,
     "sever": RectanglePattern,
     "sharpen": RectanglePattern,
     "needle": RectanglePattern,
     "copper_weld": SpotWeldPattern,
     "copper_release": HorseshoePattern,
     "serial_trench": HorseshoePattern,
     "serial_undercut": RectanglePattern,
@@ -930,38 +940,60 @@
     "lamella_sever": RectanglePattern,
     "lamella_polish": TrenchPattern,
     "trench": TrenchPattern,
     "notch": WaffleNotchPattern,
     "microexpansion": MicroExpansionPattern,
     "clover": CloverPattern,
     "autolamella": TrenchPattern,
+    "autolamella_undercut": RectanglePattern,
+    "rectangle": RectanglePattern,
 }
 
 
 def _get_pattern(key: str, protocol: dict, point: Point = Point()) -> BasePattern:
     pattern = PROTOCOL_MILL_MAP[key]()
     pattern.define(protocol, point=point)
     return pattern
 
 
 def _get_stage(key, protocol: dict, point: Point = Point(), i: int = 0) -> FibsemMillingStage:
     pattern = _get_pattern(key, protocol, point=point)
-    mill_settings = FibsemMillingSettings(milling_current=protocol["milling_current"], hfw=float(protocol["hfw"]))
+    mill_settings = FibsemMillingSettings(
+        milling_current=protocol["milling_current"], 
+        hfw=float(protocol["hfw"]),
+        application_file=protocol.get("application_file", "Si"),
+        preset=protocol.get("preset", "no preset"))
 
     stage = FibsemMillingStage(
         name=f"{key.title()} {i+1:02d}", num=i, milling=mill_settings, pattern=pattern
     )
     return stage
 
 
 def _get_milling_stages(key, protocol, point: Point = Point()):
     
     # TODO: maybe add support for defining point per stages?
-    
+
     if "stages" in protocol[key]:
         stages = [
             _get_stage(key, pstage, point=point, i=i)
             for i, pstage in enumerate(protocol[key]["stages"])
         ]
     else:
         stages = [_get_stage(key, protocol[key], point=point)]
     return stages
+
+
+from copy import deepcopy
+def _get_protocol_from_stages(stages: list):
+    protocol = {}  
+    protocol["stages"] = []
+
+    if not isinstance(stages, list):
+        stages = [stages]
+
+    for stage in stages:
+        # join two dicts union
+        ddict = {**stage.__to_dict__()["milling"], **stage.__to_dict__()["pattern"]["protocol"]}
+        protocol["stages"].append(deepcopy(ddict))
+
+    return protocol
```

## fibsem/structures.py

```diff
@@ -150,15 +150,14 @@
     #         assert isinstance(attribute,float) or isinstance(attribute,int)
         
     #     assert isinstance(self.coordinate_system,str) or self.coordinate_system is None
 
     def __to_dict__(self) -> dict:
         position_dict = {}
 
-        position_dict["name"] = self.name
         position_dict["name"] = self.name if self.name is not None else None
         position_dict["x"] = float(self.x) if self.x is not None else None
         position_dict["y"] = float(self.y) if self.y is not None else None
         position_dict["z"] = float(self.z) if self.z is not None else None
         position_dict["r"] = float(self.r) if self.r is not None else None
         position_dict["t"] = float(self.t) if self.t is not None else None
         position_dict["coordinate_system"] = self.coordinate_system
@@ -248,53 +247,54 @@
 class FibsemHardware:
     """Data class for storing hardware information.
 Attributes:
 
     """
     electron_beam: bool = True
     ion_beam: bool = True
+    can_select_plasma_gas: bool = True
     stage_enabled: bool = True
     stage_rotation: bool = True
     stage_tilt: bool = True
     manipulator_enabled: bool = True
     manipulator_rotation: bool = True
     manipulator_tilt: bool = True
     gis_enabled: bool = True
     gis_multichem: bool = True
     manipulator_positions: dict = None
-    system: dict = None
 
     def __post_init__(self):
         attributes = [
             "electron_beam",
             "ion_beam",
+            "can_select_plasma_gas",
             "stage_enabled",
             "stage_rotation",
             "stage_tilt",
             "manipulator_enabled",
             "manipulator_rotation",
             "manipulator_tilt",
             "gis_enabled",
             "gis_multichem",
             "manipulator_positions",
-            "system"
         ]
 
         for attribute in attributes:
             object_attribute = getattr(self,attribute)
-            if attribute in ["manipulator_positions","system"]:
+            if attribute in ["manipulator_positions"]:
                 continue
             assert isinstance(object_attribute,bool)
 
     @classmethod
     def __from_dict__(cls, hardware_dict: dict) -> "FibsemHardware":
 
         return cls(
             electron_beam=bool(hardware_dict["electron"]["enabled"]),
             ion_beam=bool(hardware_dict["ion"]["enabled"]),
+            can_select_plasma_gas=bool(hardware_dict["ion"]["can_select_plasma_gas"]),
             stage_enabled=bool(hardware_dict["stage"]["enabled"]),
             stage_rotation=bool(hardware_dict["stage"]["rotation"]),
             stage_tilt=bool(hardware_dict["stage"]["tilt"]),
             manipulator_enabled=bool(hardware_dict["manipulator"]["enabled"]),
             manipulator_rotation=bool(hardware_dict["manipulator"]["rotation"]),
             manipulator_tilt=bool(hardware_dict["manipulator"]["tilt"]),
             gis_enabled=bool(hardware_dict["gis"]["enabled"]),
@@ -309,40 +309,26 @@
                             "z":hardware_dict["manipulator"]["positions"]["standby"]["z"],
                 },
                 "working":{ "x":hardware_dict["manipulator"]["positions"]["working"]["x"],
                             "y":hardware_dict["manipulator"]["positions"]["working"]["y"],
                             "z":hardware_dict["manipulator"]["positions"]["working"]["z"],
                 },
                 "calibrated":hardware_dict["manipulator"]["positions"]["calibrated"]}, 
-            system = {
-                "name":hardware_dict["system"]["name"],
-                "manufacturer":hardware_dict["system"]["manufacturer"],
-                "description":hardware_dict["system"]["description"],
-                "version":hardware_dict["system"]["version"],
-                "id":hardware_dict["system"]["id"],
-            }
         )
 
     def __to_dict__(self) -> dict:
             
             hardware_dict = {}
-
-            hardware_dict["system"] = {}
-            hardware_dict["system"]["name"] = self.system["name"]
-            hardware_dict["system"]["manufacturer"] = self.system["manufacturer"]
-            hardware_dict["system"]["description"] = self.system["description"]
-            hardware_dict["system"]["version"] = self.system["version"]
-            hardware_dict["system"]["id"] = self.system["id"]
-
     
             hardware_dict["electron"] = {}
             hardware_dict["electron"]["enabled"] = self.electron_beam
     
             hardware_dict["ion"] = {}
             hardware_dict["ion"]["enabled"] = self.ion_beam
+            hardware_dict["ion"]["can_select_plasma_gas"] = self.can_select_plasma_gas
     
             hardware_dict["stage"] = {}
             hardware_dict["stage"]["enabled"] = self.stage_enabled
             hardware_dict["stage"]["rotation"] = self.stage_rotation
             hardware_dict["stage"]["tilt"] = self.stage_tilt
     
             hardware_dict["manipulator"] = {}
@@ -405,18 +391,18 @@
     z: float = 0.0
     r: float = 0.0
     t: float = 0.0
     coordinate_system: str = "RAW"
 
     def __post_init__(self):
 
-        attributes = ["x","y","z","r","t"]
-        for attribute in attributes:
-            output = getattr(self,attribute)
-            assert isinstance(output,float) or isinstance(output,int), f"Unsupported type {type(output)} for coordinate {attribute}"
+        # attributes = ["x","y","z","r","t"]
+        # for attribute in attributes:
+            # output = getattr(self,attribute)
+            # assert isinstance(output,float) or isinstance(output,int), f"Unsupported type {type(output)} for coordinate {attribute}"
         assert isinstance(self.coordinate_system,str) or self.coordinate_system is None, f"unsupported type {type(self.coordinate_system)} for coorindate system"
         assert self.coordinate_system in SUPPORTED_COORDINATE_SYSTEMS or self.coordinate_system is None, f"coordinate system value {self.coordinate_system} is unsupported or invalid syntax. Must be RAW or SPECIMEN"
 
     def __to_dict__(self) -> dict:
         position_dict = {}
         position_dict["x"] = self.x
         position_dict["y"] = self.y
@@ -455,14 +441,16 @@
                     coordinate_system = "Raw"
                 elif self.coordinate_system == "STAGE":
                     coordinate_system = "Stage"
                 return ManipulatorPosition(
                     x=self.x,
                     y=self.y,
                     z=self.z,
+                    # r=0.0 if self.r is None else self.r,
+                    r=None,
                     coordinate_system=coordinate_system,
                 )
     
             @classmethod
             def from_autoscript_position(cls, position: ManipulatorPosition) -> None:
                 return cls(
                     x=position.x,
@@ -507,15 +495,16 @@
 
         assert isinstance(self.left,float) or isinstance(self.left,int), f"type {type(self.left)} is unsupported for left, must be int or floar"
         assert isinstance(self.top,float) or isinstance(self.top,int), f"type {type(self.top)} is unsupported for top, must be int or floar"
         assert isinstance(self.width,float) or isinstance(self.width,int), f"type {type(self.width)} is unsupported for width, must be int or floar"
         assert isinstance(self.height,float) or isinstance(self.height,int), f"type {type(self.height)} is unsupported for height, must be int or floar"
 
     def __from_dict__(settings: dict) -> "FibsemRectangle":
-
+        if settings is None:
+            return None
         points = ["left","top","width","height"]
 
         for point in points:
 
             value = settings[point]
 
             assert isinstance(value,float) or isinstance(value,int) or value is None
@@ -822,14 +811,15 @@
         **kwargs: If FibsemPattern.Rectangle
                     width: float (m),
                     height: float (m), 
                     depth: float (m),
                     rotation: float = 0.0 (m), 
                     centre_x: float = 0.0 (m), 
                     centre_y: float = 0.0 (m),
+                    passes: float = 1.0,
 
                 If FibsemPattern.Line
                     start_x: float (m), 
                     start_y: float (m), 
                     end_x: float (m), 
                     end_y: float (m), 
                     depth: float (m),
@@ -858,14 +848,15 @@
             self.height = kwargs["height"]
             self.depth = kwargs["depth"]
             self.rotation = kwargs["rotation"] if "rotation" in kwargs else 0.0
             self.centre_x = kwargs["centre_x"] if "centre_x" in kwargs else 0.0
             self.centre_y = kwargs["centre_y"] if "centre_y" in kwargs else 0.0
             self.scan_direction= kwargs["scan_direction"] if "scan_direction" in kwargs else "TopToBottom"
             self.cleaning_cross_section= kwargs["cleaning_cross_section"] if "cleaning_cross_section" in kwargs else False
+            self.passes = kwargs["passes"] if "passes" in kwargs else None
         elif pattern == FibsemPattern.Line:
             self.start_x = kwargs["start_x"]
             self.start_y = kwargs["start_y"]
             self.end_x = kwargs["end_x"]
             self.end_y = kwargs["end_y"]
             self.depth = kwargs["depth"]
             self.rotation = kwargs["rotation"] if "rotation" in kwargs else 0.0
@@ -900,15 +891,15 @@
             self.start_angle = kwargs["start_angle"] if "start_angle" in kwargs else 0.0
             self.end_angle = kwargs["end_angle"] if "end_angle" in kwargs else 360.0
             self.scan_direction= kwargs["scan_direction"] if "scan_direction" in kwargs else "TopToBottom"
             self.cleaning_cross_section= kwargs["cleaning_cross_section"] if "cleaning_cross_section" in kwargs else False
         
     def __repr__(self) -> str:
         if self.pattern == FibsemPattern.Rectangle:
-            return f"FibsemPatternSettings(pattern={self.pattern}, width={self.width}, height={self.height}, depth={self.depth}, rotation={self.rotation}, centre_x={self.centre_x}, centre_y={self.centre_y}, scan_direction={self.scan_direction}, cleaning_cross_section={self.cleaning_cross_section})"
+            return f"FibsemPatternSettings(pattern={self.pattern}, width={self.width}, height={self.height}, depth={self.depth}, rotation={self.rotation}, centre_x={self.centre_x}, centre_y={self.centre_y}, scan_direction={self.scan_direction}, cleaning_cross_section={self.cleaning_cross_section}, passes={self.passes})"
         if self.pattern == FibsemPattern.Line:
             return f"FibsemPatternSettings(pattern={self.pattern}, start_x={self.start_x}, start_y={self.start_y}, end_x={self.end_x}, end_y={self.end_y}, depth={self.depth}, rotation={self.rotation}, scan_direction={self.scan_direction}, cleaning_cross_section={self.cleaning_cross_section})"
         if self.pattern is FibsemPattern.Circle:
             return f"FibsemPatternSettings(pattern={self.pattern}, centre_x={self.centre_x}, centre_y={self.centre_y}, radius={self.radius}, depth={self.depth}, start_angle={self.start_angle}, end_angle={self.end_angle}, rotation={self.rotation}, scan_direction={self.scan_direction}, cleaning_cross_section={self.cleaning_cross_section})"
         if self.pattern is FibsemPattern.Bitmap:
             return f"FibsemPatternSettings(pattern={self.pattern}, centre_x={self.centre_x}, centre_y={self.centre_y}, width={self.width}, height={self.height}, depth={self.depth}, path={self.path})"
         if self.pattern is FibsemPattern.Annulus:
@@ -924,14 +915,15 @@
                 height=state_dict["height"],
                 depth=state_dict["depth"],
                 rotation=state_dict["rotation"],
                 centre_x=state_dict["centre_x"],
                 centre_y=state_dict["centre_y"],
                 scan_direction=state_dict["scan_direction"],
                 cleaning_cross_section=state_dict["cleaning_cross_section"],
+                passes=int(state_dict["passes"]) if state_dict.get("passes", None) is not None else None,# TODO: this line is crazy
             )
         elif state_dict["pattern"] == "Line":
             return FibsemPatternSettings(
                 pattern=FibsemPattern.Line,
                 start_x=state_dict["start_x"],
                 start_y=state_dict["start_y"],
                 end_x=state_dict["end_x"],
@@ -987,14 +979,15 @@
                 "height": self.height,
                 "depth": self.depth,
                 "rotation": self.rotation,
                 "centre_x": self.centre_x,
                 "centre_y": self.centre_y,
                 "scan_direction": self.scan_direction,
                 "cleaning_cross_section": self.cleaning_cross_section,
+                "passes": self.passes,
             }
         elif self.pattern == FibsemPattern.Line:
             return {
                 "pattern": "Line",
                 "start_x": self.start_x,
                 "start_y": self.start_y,
                 "end_x": self.end_x,
@@ -1064,15 +1057,15 @@
     Methods:
     to_dict(): Converts the object attributes into a dictionary.
     from_dict(settings: dict) -> "FibsemMillingSettings": Creates a FibsemMillingSettings object from a dictionary of settings.
     """
 
     milling_current: float = 20.0e-12
     spot_size: float = 5.0e-8
-    rate: float = 3.0e-3 # m3/A/s
+    rate: float = 3.0e-11 # m3/A/s
     dwell_time: float = 1.0e-6 # s
     hfw: float = 150e-6
     patterning_mode: str = "Serial" 
     application_file: str = "Si"
     preset: str = "30 keV; UHR imaging"
     spacing: float = 1.0
 
@@ -1105,15 +1098,15 @@
 
     @staticmethod
     def __from_dict__(settings: dict) -> "FibsemMillingSettings":
 
         milling_settings = FibsemMillingSettings(
             milling_current=settings.get("milling_current", 20.0e-12),
             spot_size=settings.get("spot_size", 5.0e-8),
-            rate=settings.get("rate", 3.0e-3),
+            rate=settings.get("rate", 3.0e-11),
             dwell_time=settings.get("dwell_time", 1.0e-6),
             hfw=settings.get("hfw", 150e-6),
             patterning_mode=settings.get("patterning_mode", "Serial"),
             application_file=settings.get("application_file", "Si"),
             preset=settings.get("preset", "30 keV; UHR imaging"),
             spacing=settings.get("spacing", 1.0),
         )
@@ -1333,38 +1326,51 @@
     """
 
     ip_address: str = "10.0.0.1"
     stage: StageSettings = None
     ion: BeamSystemSettings = None
     electron: BeamSystemSettings = None
     manufacturer: str = None
+    system_info: dict = None
 
     def __to_dict__(self) -> dict:
 
         settings_dict = {
             "ip_address": self.ip_address,
             "stage": self.stage.__to_dict__(),
             "ion": self.ion.__to_dict__(),
             "electron": self.electron.__to_dict__(),
             "manufacturer": self.manufacturer,
         }
+        settings_dict["name"] = self.system_info["name"]
+        settings_dict["manufacturer"] = self.system_info["manufacturer"]
+        settings_dict["description"] = self.system_info["description"]
+        settings_dict["version"] = self.system_info["version"]
+        settings_dict["id"] = self.system_info["id"]
 
         return settings_dict
 
     @staticmethod
     def __from_dict__(settings: dict) -> "SystemSettings":
 
         system_settings = SystemSettings(
             ip_address=settings["ip_address"],
             stage=StageSettings.__from_dict__(settings["stage"]),
             ion=BeamSystemSettings.__from_dict__(settings["ion"], BeamType.ION),
             electron=BeamSystemSettings.__from_dict__(
                 settings["electron"], BeamType.ELECTRON
             ),
             manufacturer=settings["manufacturer"],
+            system_info = {
+                "name":settings["name"],
+                "manufacturer":settings["manufacturer"],
+                "description":settings["description"],
+                "version":settings["version"],
+                "id":settings["id"],
+            }
         )
 
         return system_settings
 
 @dataclass
 class MicroscopeSettings:
 
@@ -1546,24 +1552,15 @@
 
         image_settings = ImageSettings.__from_dict__(settings)
         if settings["version"] is not None:
             version = settings["version"]
         if settings["pixel_size"] is not None:
             pixel_size = Point.__from_dict__(settings["pixel_size"])
         if settings["microscope_state"] is not None:
-            microscope_state = MicroscopeState(
-                timestamp=settings["microscope_state"]["timestamp"],
-                absolute_position=FibsemStagePosition(),
-                eb_settings=BeamSettings.__from_dict__(
-                    settings["microscope_state"]["eb_settings"]
-                ),
-                ib_settings=BeamSettings.__from_dict__(
-                    settings["microscope_state"]["ib_settings"]
-                ),
-            )
+            microscope_state = MicroscopeState.__from_dict__(settings["microscope_state"])
         
         detector_dict = settings.get("detector_settings", {"type": "Unknown", "mode": "Unknown", "brightness": 0.0, "contrast": 0.0})
         detector_settings = FibsemDetectorSettings.__from_dict__(detector_dict)
         
         metadata = FibsemImageMetadata(
             image_settings=image_settings,
             version=version,
@@ -1664,14 +1661,16 @@
             Inputs:
                 save_path (path): path to save directory and filename
     """
 
     def __init__(self, data: np.ndarray, metadata: FibsemImageMetadata = None):
 
         if check_data_format(data):
+            if data.ndim == 3 and data.shape[2] == 1:
+                data = data[:, :, 0]
             self.data = data
         else:
             raise Exception("Invalid Data format for Fibsem Image")
         if metadata is not None:
             self.metadata = metadata
         else:
             self.metadata = None
@@ -1700,15 +1699,14 @@
 
     def save(self, save_path: Path = None) -> None:
         """Saves a FibsemImage to a tiff file.
 
         Inputs:
             save_path (path): path to save directory and filename
         """
-        # self.metadata.image_settings.save_path = str(self.metadata.image_settings.save_path)
         if save_path is None:
             save_path = os.path.join(self.metadata.image_settings.save_path, self.metadata.image_settings.label)
         os.makedirs(os.path.dirname(save_path), exist_ok=True)
         save_path = Path(save_path).with_suffix(".tif")
 
         if self.metadata is not None:
             metadata_dict = self.metadata.__to_dict__()
@@ -1974,12 +1972,12 @@
             
         
 
 def check_data_format(data: np.ndarray) -> bool:
     """Checks that data is in the correct format."""
     # assert data.ndim == 2  # or data.ndim == 3
     # assert data.dtype in [np.uint8, np.uint16]
-    # if data.ndim == 3 and data.shape[2] == 1:
-    #     data = data[:, :, 0]
+    if data.ndim == 3 and data.shape[2] == 1:
+        data = data[:, :, 0]
     return data.ndim == 2 and data.dtype in [np.uint8, np.uint16]
```

## fibsem/testing.ipynb

### Pretty-printed

 * *Similarity: 0.9273313492063492%*

 * *Differences: {"'cells'": "{0: {'source': {insert: [(4, 'from fibsem.structures import FibsemPatternSettings, "*

 * *            'FibsemPattern, FibsemStagePosition, BeamType, MicroscopeState, BeamSettings, '*

 * *            "Point\\n')], delete: [4]}}, 6: {'source': ['return_state = "*

 * *            "microscope.get_current_microscope_state()\\n', 'print(return_state)']}, insert: [(1, "*

 * *            "OrderedDict([('cell_type', 'code'), ('execution_count', None), ('metadata', "*

 * *            "OrderedDict()), ('outputs', []), ('source',  []*

```diff
@@ -6,26 +6,127 @@
             "metadata": {},
             "outputs": [],
             "source": [
                 "%load_ext autoreload\n",
                 "%autoreload 2 \n",
                 "from fibsem import utils, milling, acquire\n",
                 "from fibsem.microscope import FibsemMicroscope\n",
-                "from fibsem.structures import FibsemPatternSettings, FibsemPattern, FibsemImage, BeamType\n",
+                "from fibsem.structures import FibsemPatternSettings, FibsemPattern, FibsemStagePosition, BeamType, MicroscopeState, BeamSettings, Point\n",
                 "import matplotlib\n",
                 "import matplotlib.pyplot as plt"
             ]
         },
         {
             "cell_type": "code",
             "execution_count": null,
             "metadata": {},
             "outputs": [],
             "source": [
-                "microscope, settings = utils.setup_session(config_path= r\"C:\\Users\\lnae0002\\Desktop\\fibsem\\fibsem\\config\")\n"
+                "from fibsem import utils\n",
+                "microscope, settings = utils.setup_session()\n"
+            ]
+        },
+        {
+            "cell_type": "code",
+            "execution_count": null,
+            "metadata": {},
+            "outputs": [],
+            "source": [
+                "# test_state = MicroscopeState(\n",
+                "#     absolute_position=FibsemStagePosition(x=0, y=0, z=0.006, t=0, r=0),\n",
+                "#     eb_settings=BeamSettings(\n",
+                "#         beam_type=BeamType.ELECTRON,\n",
+                "#         working_distance=0.06,\n",
+                "#         beam_current=2.0e-11,\n",
+                "#         voltage=3000,\n",
+                "#         hfw=0.00015,\n",
+                "#         dwell_time=1.0e-06,\n",
+                "#         resolution=[1536, 1024],\n",
+                "#         stigmation=Point(x=0.1, y=0.1),\n",
+                "#         shift=Point(x=1e-6, y=1e-6),\n",
+                "#         scan_rotation=0.0,\n",
+                "#     ),\n",
+                "#     ib_settings=BeamSettings(\n",
+                "#         beam_type=BeamType.ION,\n",
+                "#         working_distance=0.06,\n",
+                "#         beam_current=2.0e-11,\n",
+                "#         voltage=30000,\n",
+                "#         hfw=0.00015,\n",
+                "#         dwell_time=1.0e-06,\n",
+                "#         resolution=[1536, 1024],\n",
+                "#         stigmation=Point(x=0.1, y=0.1),\n",
+                "#         shift=Point(x=1e-6, y=1e-6),\n",
+                "#         scan_rotation=0.0,\n",
+                "#     )\n",
+                "# )\n",
+                "\n",
+                "test_state = microscope.get_current_microscope_state()\n",
+                "\n",
+                "from pprint import pprint\n",
+                "pprint(test_state.__to_dict__())\n"
+            ]
+        },
+        {
+            "cell_type": "code",
+            "execution_count": null,
+            "metadata": {},
+            "outputs": [],
+            "source": [
+                "eb_image, ib_image = acquire.take_reference_images(microscope, settings.image)\n",
+                "\n",
+                "fig, ax = plt.subplots(1, 2, figsize=(10, 5))\n",
+                "ax[0].imshow(eb_image.data, cmap=\"gray\")\n",
+                "ax[1].imshow(ib_image.data, cmap=\"gray\")\n",
+                "plt.show()\n",
+                "\n",
+                "test_state = microscope.get_current_microscope_state()\n",
+                "pprint(test_state.__to_dict__())\n",
+                "\n",
+                "test_state.ib_settings.shift = Point(0e-6, 0e-6)\n",
+                "test_state.eb_settings.shift = Point(0e-6, 0e-6)\n",
+                "test_state.ib_settings.stigmation = Point(0e-6, 0e-6)\n",
+                "test_state.eb_settings.stigmation = Point(0e-6, 0e-6)\n",
+                "microscope.set_microscope_state(test_state)\n",
+                "\n",
+                "pprint(microscope.get_current_microscope_state().__to_dict__())\n",
+                "\n",
+                "eb_image, ib_image = acquire.take_reference_images(microscope, settings.image)\n",
+                "\n",
+                "fig, ax = plt.subplots(1, 2, figsize=(10, 5))\n",
+                "ax[0].imshow(eb_image.data, cmap=\"gray\")\n",
+                "ax[1].imshow(ib_image.data, cmap=\"gray\")\n",
+                "plt.show()"
+            ]
+        },
+        {
+            "cell_type": "code",
+            "execution_count": null,
+            "metadata": {},
+            "outputs": [],
+            "source": [
+                "microscope.set_microscope_state(test_state)"
+            ]
+        },
+        {
+            "cell_type": "code",
+            "execution_count": null,
+            "metadata": {},
+            "outputs": [],
+            "source": [
+                "acquire.take_reference_images(microscope, settings.image)"
+            ]
+        },
+        {
+            "cell_type": "code",
+            "execution_count": null,
+            "metadata": {},
+            "outputs": [],
+            "source": [
+                "return_state = microscope.get_current_microscope_state()\n",
+                "print(return_state)"
             ]
         },
         {
             "cell_type": "code",
             "execution_count": null,
             "metadata": {},
             "outputs": [],
@@ -74,14 +175,14 @@
                 "version": 3
             },
             "file_extension": ".py",
             "mimetype": "text/x-python",
             "name": "python",
             "nbconvert_exporter": "python",
             "pygments_lexer": "ipython3",
-            "version": "3.9.16"
+            "version": "3.9.12"
         },
         "orig_nbformat": 4
     },
     "nbformat": 4,
     "nbformat_minor": 2
 }
```

## fibsem/utils.py

```diff
@@ -17,45 +17,35 @@
     ImageSettings,
     SystemSettings,
     FibsemImage,
     FibsemMillingSettings,
     FibsemHardware,
     FibsemPatternSettings,
 )
-from fibsem.config import BASE_PATH
+from fibsem import config as cfg
 from fibsem.microscope import FibsemMicroscope
 
 
-def save_image(image: FibsemImage, save_path: Path, label: str = "image"):
-    """
-    Save the given FibsemImage object as a TIFF file with the specified label at the specified file path.
-
-        Args:
-        image (FibsemImage): The FibsemImage object to save.
-        save_path (Path): The file path to save the image at.
-        label (str, optional): The label to use for the saved image file. Default is "image".
-
-        Returns:
-        None
-   
-    """
-    os.makedirs(save_path, exist_ok=True)
-    path = os.path.join(save_path, f"{label}.tif")
-    image.save(path)
-
-
 def current_timestamp():
     """Returns current time in a specific string format
 
     Returns:
         String: Current time
     """
     return datetime.datetime.fromtimestamp(time.time()).strftime("%Y-%m-%d-%I-%M-%S%p") #PM/AM doesnt work?
 
 
+def current_timestamp_v2():
+    """Returns current time in a specific string format
+
+    Returns:
+        String: Current time
+    """
+    return str(time.time()).replace(".", "_")
+
 def _format_time_seconds(seconds: float) -> str:
     """Format a time delta in seconds to proper string format."""
     return str(datetime.timedelta(seconds=seconds)).split(".")[0]
 
 
 def make_logging_directory(path: Path = None, name="run"):
     """
@@ -67,15 +57,15 @@
         name (str, optional): The name of the logging directory to create. Default is "run".
 
     Returns:
         str: The file path to the created logging directory.
         """
     
     if path is None:
-        path = os.path.join(BASE_PATH, "log")
+        path = os.path.join(cfg.BASE_PATH, "log")
     directory = os.path.join(path, name)
     os.makedirs(directory, exist_ok=True)
     return directory
 
 # TODO: better logs: https://www.toptal.com/python/in-depth-python-logging
 # https://stackoverflow.com/questions/61483056/save-logging-debug-and-show-only-logging-info-python
 def configure_logging(path: Path = "", log_filename="logfile", log_level=logging.DEBUG, _DEBUG: bool = False):
@@ -116,33 +106,20 @@
 def save_yaml(path: Path, data: dict) -> None:
     """Saves a python dictionary object to a yaml file
 
     Args:
         path (Path): path location to save yaml file
         data (dict): dictionary object
     """
+    os.makedirs(os.path.dirname(path), exist_ok=True)
+    path = Path(path).with_suffix(".yaml")
     with open(path, "w") as f:
         yaml.dump(data, f, indent=4)
 
 
-from fibsem.structures import MicroscopeState
-
-
-def save_state_yaml(path: Path, state: MicroscopeState) -> None:
-    """Saves microscope state as a yaml file
-
-    Args:
-        path (Path): path location to save file
-        state (MicroscopeState): MicroscopeState
-    """
-    state_dict = state.__to_dict__()
-
-    save_yaml(path, state_dict)
-
-
 def create_gif(path: Path, search: str, gif_fname: str, loop: int = 0) -> None:
     """Creates a GIF from a set of images. Images must be in same folder
 
     Args:
         path (Path): Path to images folder
         search (str): search name
         gif_fname (str): name to save gif file
@@ -185,16 +162,16 @@
 
     # create session directories
     session = f'{settings.protocol["name"]}_{current_timestamp()}'
     if protocol_path is None:
         protocol_path = os.getcwd()
 
     # configure paths
-    if session_path is None:# change this to cfg.LOG_PATH
-        session_path = os.path.join(BASE_PATH, "fibsem", "log", session)
+    if session_path is None:
+        session_path = cfg.LOG_PATH
     os.makedirs(session_path, exist_ok=True)
 
     # configure logging
     if setup_logging:
         configure_logging(session_path)
 
     # connect to microscope
@@ -204,73 +181,69 @@
     if ip_address:
         settings.system.ip_address = ip_address
     
     if manufacturer:
         settings.system.manufacturer = manufacturer
 
     if settings.system.manufacturer == "Thermo":
-        microscope = FibSem.ThermoMicroscope()
+        microscope = FibSem.ThermoMicroscope(settings.hardware, settings.system.stage)
         microscope.connect_to_microscope(
             ip_address=settings.system.ip_address, port=7520
         )
 
     elif settings.system.manufacturer == "Tescan":
-        microscope = FibSem.TescanMicroscope(ip_address=settings.system.ip_address)
+        microscope = FibSem.TescanMicroscope(ip_address=settings.system.ip_address, hardware_settings=settings.hardware, stage_settings=settings.system.stage)
         microscope.connect_to_microscope(
             ip_address=settings.system.ip_address, port=8300
         )
     
     elif settings.system.manufacturer == "Demo":
-        microscope = FibSem.DemoMicroscope()
+        microscope = FibSem.DemoMicroscope(settings.hardware, settings.system.stage)
         microscope.connect_to_microscope()
 
     # image_settings
     settings.image.save_path = session_path
 
     logging.info(f"Finished setup for session: {session}")
 
     return microscope, settings
 
 
 def load_settings_from_config(
-    config_path: Path = None, protocol_path: Path = None, model_path: Path = None
+    config_path: Path = None, protocol_path: Path = None
 ) -> MicroscopeSettings:
     """Load microscope settings from configuration files
 
     Args:
         config_path (Path, optional): path to config directory. Defaults to None.
         protocol_path (Path, optional): path to protocol file. Defaults to None.
 
     Returns:
         MicroscopeSettings: microscope settings
     """
-    # print("HELLO")
     # TODO: this should just be system.yaml path, not directory
     if config_path is None:
         from fibsem.config import CONFIG_PATH
 
-        config_path = CONFIG_PATH
+        config_path = os.path.join(CONFIG_PATH, "system.yaml")
     
-    if model_path is None:
-        model_path = os.path.join(config_path, "model.yaml")
-
     # system settings
-    settings = load_yaml(os.path.join(config_path, "system.yaml"))
+    settings = load_yaml(os.path.join(config_path))
     system_settings = SystemSettings.__from_dict__(settings["system"])
 
     # user settings
     image_settings = ImageSettings.__from_dict__(settings["user"]["imaging"])
 
     milling_settings = FibsemMillingSettings.__from_dict__(settings["user"]["milling"])
 
     # protocol settings
     protocol = load_protocol(protocol_path)
 
     # hardware settings
-    hardware_settings = FibsemHardware.__from_dict__(load_protocol(model_path))
+    hardware_settings = FibsemHardware.__from_dict__(settings["model"])
 
     settings = MicroscopeSettings(
         system=system_settings,
         image=image_settings,
         protocol=protocol,
         milling=milling_settings,
         hardware=hardware_settings,
@@ -324,38 +297,14 @@
             if item is not None:
                 try:
                     dictionary[key] = float(dictionary[key])
                 except ValueError:
                     pass
     return dictionary
 
-
-def match_image_settings(
-    ref_image: FibsemImage,
-    image_settings: ImageSettings,
-    beam_type: BeamType = BeamType.ELECTRON,
-) -> ImageSettings:
-    
-    
-    """Generate matching image settings from an image."""
-
-
-    image_settings.resolution = (ref_image.data.shape[1], ref_image.data.shape[0])
-    # image_settings.dwell_time = ref_image.metadata.scan_settings.dwell_time
-    image_settings.hfw = ref_image.data.shape[1] * ref_image.metadata.pixel_size.x
-    image_settings.beam_type = beam_type
-    image_settings.save = True
-    image_settings.label = current_timestamp()
-
-    return image_settings
-
-
-
-
-
 def get_params(main_str: str) -> list:
     """Helper function to access relevant metadata parameters from sub field
 
     Args:
         main_str (str): Sub string of relevant metadata
 
     Returns:
@@ -373,7 +322,21 @@
             cat_str = ""
             i += main_str[i:].find("\n")
         else:
             cat_str += main_str[i]
 
         i += 1
     return cats
+
+
+def _get_position(name: str):
+    
+    from fibsem import config as cfg
+    from fibsem.structures import FibsemStagePosition
+    import os
+
+    ddict = load_yaml(fname=os.path.join(cfg.CONFIG_PATH, "positions.yaml"))
+    # get position from save positions?
+    for d in ddict:
+        if d["name"] == name:
+            return FibsemStagePosition.__from_dict__(d)
+    return None
```

## fibsem/config/model.yaml

```diff
@@ -17,16 +17,16 @@
             x: 0.0
             y: 0.0
             z: 0.00545
         working:
             x: 0.0
             y: 0.0
             z: 0.00585
-    rotation: true
-    tilt: true
+    rotation: false
+    tilt: false
 stage:
     enabled: true
     rotation: true
     tilt: true
 system:
     description: FIBSEM
     id: 0
```

## fibsem/config/protocol.yaml

```diff
@@ -16,30 +16,34 @@
 
 patterns:
   Rectangle:
     width: 10.0e-6
     height: 5.0e-6
     depth: 1.0e-6
     rotation: 0.0
+    cleaning_cross_section: False
+    scan_direction: "ToptoBottom"
   Line:
     start_x: 0.0
     start_y: 0.0
     end_x: 10.0e-6
     end_y: 0
     depth: 1.0e-6 
   Circle:
     radius: 5.0e-6
     depth: 1.0e-6
+    cleaning_cross_section: False
   Trench:
-    lamella_width: 40.0e-6
-    lamella_height: 10.0e-6
-    trench_height: 10.0e-6
+    lamella_width: 10.0e-6
+    lamella_height: 5.0e-6
+    trench_height: 5.0e-6
     offset: 1.0e-6
     size_ratio: 1.0
-    depth: 10.0e-6
+    depth: 2.0e-6
+    cleaning_cross_section: false
   Horseshoe:
     lamella_width: 40.0e-6
     lamella_height: 10.0e-6
     trench_height: 10.0e-6
     offset: 1.0e-6
     size_ratio: 1.0
     side_width: 5.0e-6
@@ -48,26 +52,30 @@
   Undercut: 
     height: 10.0e-6
     width: 10.0e-6
     depth: 5.0e-6
     trench_width: 2.0e-6
     rhs_height: 10.0e-6
     h_offset: 5.0e-6
+    cleaning_cross_section: false
   Fiducial:
     height: 10.0e-6
     width: 1.0e-6
     depth: 5.0e-6
-    rotation: 0.0
+    rotation: 45.0
+    cleaning_cross_section: false
   SpotWeld:
     height: 1.0e-6
     width: 5.0e-6
     depth: 5.0e-6
     distance: 2.0e-6
     number: 3
     rotation: 0.0
+    passes: 1.0
+    scan_direction: "ToptoBottom"
   MicroExpansion:
     height: 1.0e-6
     width: 5.0e-6
     depth: 5.0e-6
     distance: 2.0e-6
     lamella_width: 10.e-6
   WaffleNotch:
```

## fibsem/config/system.yaml

```diff
@@ -1,30 +1,67 @@
+apply_settings_on_startup: false
+connect_to_microscope_on_startup: true
+model:
+    electron:
+        enabled: true
+    gis:
+        enabled: true
+        multichem: true
+    ion:
+        enabled: true
+        can_select_plasma_gas: true 
+    manipulator:
+        enabled: true
+        positions:
+            calibrated: false
+            parking:
+                x: -0.008918395
+                y: 0.0006548000000000001
+                z: -0.004848865
+            standby:
+                x: 0.0
+                y: 0.0
+                z: 0.00545
+            working:
+                x: 0.0
+                y: 0.0
+                z: 0.00585
+        rotation: true
+        tilt: false
+    stage:
+        enabled: true
+        rotation: true
+        tilt: true
 system:
+    description: test
     electron:
-        current: 1.0000000000000002e-12
+        current: 50.0e-12
         detector_mode: SecondaryElectrons
         detector_type: ETD
         eucentric_height: 0.0039
         voltage: 2000
+    id: '123'
     ion:
         current: 2.0000000000000002e-11
         detector_mode: SecondaryElectrons
         detector_type: ETD
         eucentric_height: 0.0165
         plasma_gas: Argon
         voltage: 30000
-    ip_address: localhost
+    ip_address: 10.0.0.1
     manufacturer: Thermo
+    name: S8252G
     stage:
         needle_stage_height_limit: 0.0037
-        pre_tilt: 27
-        rotation_flat_to_electron: 49
-        rotation_flat_to_ion: 229
-        tilt_flat_to_electron: 0
-        tilt_flat_to_ion: 52
+        pre_tilt: 35.0
+        rotation_flat_to_electron: 49.0
+        rotation_flat_to_ion: 229.0
+        tilt_flat_to_electron: 0.0
+        tilt_flat_to_ion: 52.0
+    version: 0.2.1a1
 user:
     imaging:
         autocontrast: true
         beam_type: ELECTRON
         dwell_time: 1.0e-06
         gamma: false
         hfw: 0.00015
```

## fibsem/detection/detection.py

```diff
@@ -103,15 +103,28 @@
     name: str = "LandingPost"
 
     def detect(self, img: np.ndarray, mask: np.ndarray = None, point:Point=None) -> 'LandingPost':
         self.px = detect_landing_post_v3(img, point)
         return self.px
 
 
-__FEATURES__ = [ImageCentre, NeedleTip, LamellaCentre, LamellaLeftEdge, LamellaRightEdge, LandingPost]
+@dataclass
+class CoreFeature(Feature):
+    feature_m: Point = None
+    px: Point = None
+    _color_UINT8: tuple = (50, 205, 50)
+    color = "lime"
+    name: str = "CoreFeature"
+
+    def detect(self, img: np.ndarray, mask: np.ndarray = None, point:Point=None) -> 'CoreFature':
+        self.px = detect_core_feature(mask, self)
+        return self.px
+
+
+__FEATURES__ = [ImageCentre, NeedleTip, LamellaCentre, LamellaLeftEdge, LamellaRightEdge, LandingPost, CoreFeature]
  
 
 
 # Detection and Drawing Tools
 def extract_class_pixels(mask, color):
     """ Extract only the pixels that are classified as the desired class (color)
 
@@ -192,14 +205,23 @@
         # get the coordinates of the median vertical index
         py = int(np.median(coords[0]))
         edge_px = (py, px)
 
     return Point(x=int(edge_px[1]), y=int(edge_px[0]))
 
 
+def detect_core_feature(
+    mask: np.ndarray,
+    feature: Feature,
+    mask_radius: int = 512,
+    idx: int = 1,
+) -> Point:
+    px = detect_centre_point(mask == idx, threshold=500)
+    return px
+
 def detect_lamella(
     mask: np.ndarray,
     feature: Feature,
     mask_radius: int = 512,
     idx: int = 1,
 ) -> Point:
 
@@ -340,15 +362,15 @@
     img: np.ndarray, mask: np.ndarray, features: tuple[Feature], filter: bool = True, point: Point = None
 ) -> list[Feature]:
 
     detection_features = []
 
     for feature in features:
         
-        if isinstance(feature, (LamellaCentre, LamellaLeftEdge, LamellaRightEdge)):
+        if isinstance(feature, (LamellaCentre, LamellaLeftEdge, LamellaRightEdge, CoreFeature)):
             feature = detect_multi_features(img, mask, feature)
             if filter:
                 feature = filter_best_feature(mask, feature, 
                                               method="closest", 
                                               point=point)
         else:
             feature.detect(img=img,mask=mask) 
@@ -386,32 +408,40 @@
         features=features, # type: ignore
         image=image,
         mask=mask,
         rgb=rgb,
         pixelsize=pixelsize,
     )
 
+    # distance in metres (from centre)
+    for feature in det.features:
+        feature.feature_m = conversions.image_to_microscope_image_coordinates(
+            feature.px, det.image.data, det.pixelsize
+        )
+
     return det
 
 
 def take_image_and_detect_features(
     microscope: FibsemMicroscope,
     settings: MicroscopeSettings,
     features: tuple[Feature],
 ) -> DetectedFeatures:
     
-    from fibsem import acquire
+    from fibsem import acquire, utils
     from fibsem.segmentation.model import load_model
 
     if settings.image.reduced_area is not None:
         logging.info(
             f"Reduced area is not compatible with model detection, disabling..."
         )
         settings.image.reduced_area = None
     
+    settings.image.label = f"ml-{utils.current_timestamp_v2()}"
+    settings.image.save = True
 
     # take new image
     image = acquire.new_image(microscope, settings.image)
 
     # load model
     ml_protocol = settings.protocol.get("ml", {})
     checkpoint = ml_protocol.get("weights", None)
@@ -448,15 +478,16 @@
     ax.set_title(title)
     
     for f in det.features:
         ax.plot(f.px.x, f.px.y, 
                 "o",  color=f.color, 
                 markersize=5, markeredgecolor="w", 
                 label=f.name)
-    ax.legend(loc="best")
+    if len(det.features) < 10:
+        ax.legend(loc="best")
 
     if len(det.features) == 2:
         # plot white line between features
         ax.plot([det.features[0].px.x, det.features[1].px.x],
                 [det.features[0].px.y, det.features[1].px.y], 
                 color="w", linestyle="--")
 
@@ -512,15 +543,15 @@
     logging.debug(f"movement: x={det.distance.x:.2e}, y={det.distance.y:.2e}")
     logging.debug(f"features: {f1}, {f2}, beam_type: {beam_type}")
 
     # these movements move the needle...
     if isinstance(f1, NeedleTip) or isinstance(f1, LamellaRightEdge):
 
         # electron: neg = down, ion: neg = up
-        if beam_type is BeamType.ELECTRON:
+        if beam_type is BeamType.ION:
             det.distance.y *= -1
 
         microscope.move_manipulator_corrected(
             dx=det.distance.x,
             dy=det.distance.y,
             beam_type=beam_type,
         )
@@ -528,15 +559,15 @@
     if isinstance(f1, LamellaCentre) and isinstance(f2, ImageCentre):
 
 
             # need to reverse the direction to move correctly. investigate if this is to do with scan rotation?
             microscope.stable_move(
                 settings=settings,
                 dx=-det.distance.x,
-                dy=-det.distance.y,
+                dy=det.distance.y,
                 beam_type=beam_type,
             )
 
             # TODO: support other movements?
     return
 
 
@@ -545,15 +576,15 @@
 from pathlib import Path
 from typing import Optional
 
 import pandas as pd
 import tifffile as tff
 
 from fibsem.segmentation import utils as seg_utils
-from fibsem.structures import FibsemImage, Point
+from fibsem.structures import FibsemImage, Point, FibsemStagePosition
 
 
 def _det_from_df(df: pd.DataFrame, path: Path, fname: str) -> Optional[DetectedFeatures]:
         
     # glob for the image in the path
     img_fname = glob.glob(os.path.join(path, f"{fname}.*"))
     mask_fname = glob.glob(os.path.join(path, "mask", f"{fname}.*"))
@@ -668,7 +699,35 @@
 def get_feature(name: str) -> Feature:
 
     idx = [i for i, feat in enumerate(__FEATURES__) if feat.__name__ == name][0]
     feature = __FEATURES__[idx]()
 
     return feature
 
+
+
+# v4 intersection features
+from fibsem.microscope import FibsemMicroscope, MicroscopeSettings
+import numpy as np
+from fibsem.imaging import _tile
+
+def _detect_positions(microscope: FibsemMicroscope, settings: MicroscopeSettings, image: FibsemImage, mask:np.ndarray, features: list[Feature]) -> list[FibsemStagePosition]:
+
+    # detect features
+    features = detect_features_v2(img=image, 
+                                mask=mask, 
+                                features=features, 
+                                filter=False, point=None)
+
+    # convert image coordinates to microscope coordinates # TODO: check why we reverse the points axis?
+    positions = _tile._convert_image_coords_to_positions(microscope, settings, image, [Point(f.px.y, f.px.x) for f in features])
+
+    return positions, features
+
+def _calculate_intersection(masks: list[np.ndarray]) -> np.ndarray:
+
+    intersection = masks[0]
+    for mask in masks[1:]:
+        intersection = intersection + mask
+        intersection[intersection < 2] = 0
+        intersection[intersection == 2] = 1
+    return intersection
```

## fibsem/detection/utils.py

```diff
@@ -207,22 +207,28 @@
 def save_data(det: DetectedFeatures, corrected: bool = False, fname: str = None) -> None:
 
     image = det.image
     if not isinstance(image, FibsemImage):
         image = FibsemImage(image, None)
     
     if fname is None:
-        fname = f"{utils.current_timestamp()}"
-    fname = os.path.join(cfg.DATA_PATH, f"{fname}")
+        fname = f"{utils.current_timestamp_v2()}"
+    fname = os.path.join(cfg.DATA_ML_PATH, f"{fname}")
+
+    idx = 1
+    while os.path.exists(fname):
+        fname = f"{fname}_{idx}"
+        idx += 1
+
     image.save(fname) # type: ignore 
-    logging.info(f"Saved image to {fname}") # TODO: handle duplicate fname
+    logging.info(f"Saved image to {fname}")
 
     # save mask to disk
-    os.makedirs(os.path.join(cfg.DATA_PATH, "mask"), exist_ok=True)
-    mask_fname = os.path.join(cfg.DATA_PATH, "mask", os.path.basename(fname))
+    os.makedirs(os.path.join(cfg.DATA_ML_PATH, "mask"), exist_ok=True)
+    mask_fname = os.path.join(cfg.DATA_ML_PATH, "mask", os.path.basename(fname))
     mask_fname = Path(mask_fname).with_suffix(".tif")
     im = Image.fromarray(det.mask) 
     im.save(mask_fname)
 
 
     # save coordinates for testing    
     # save the feature_type, px coordinates for each feature into a pandas dataframe
@@ -237,14 +243,14 @@
                     "pixelsize": det.pixelsize,
                     "corrected": corrected} # TODO: beamtype
         feat_list.append(dat)
 
     df = pd.DataFrame(feat_list)
     
     # save the dataframe to a csv file, append if the file already exists
-    DATAFRAME_PATH = os.path.join(cfg.DATA_PATH, "data.csv")
+    DATAFRAME_PATH = os.path.join(cfg.DATA_ML_PATH, "data.csv")
     if os.path.exists(DATAFRAME_PATH):
         df_tmp = pd.read_csv(DATAFRAME_PATH)
         df = pd.concat([df_tmp, df], axis=0, ignore_index=True)
     
     # logging.info(f"{df.tail(10)}")
     df.to_csv(DATAFRAME_PATH, index=False)
```

## fibsem/imaging/masks.py

```diff
@@ -152,15 +152,15 @@
 
     # get the size of the lamella in pixels
     lamella_height_px, lamella_width_px = conversions.get_lamella_size_in_pixels(
         img, protocol, use_trench_height
     )
 
     if circ:
-        mask = circ_mask(
+        mask = create_circle_mask(
             size=(img.data.shape[1], img.data.shape[0]),
             radius=max(lamella_height_px, lamella_width_px) * scale,
             sigma=12,
         )
     else:
         mask = create_rect_mask(
             img=img.data,
@@ -221,7 +221,29 @@
 
 
 def create_vertical_mask(arr, width=128):
     mask = np.zeros_like(arr)
     mid = arr.shape[1] // 2
     mask[:, mid - width : mid + width] = 1
     return mask
+
+
+
+def create_mask(arr: np.ndarray, mask_info: dict) -> np.ndarray:
+
+    # mask_info = {
+    #     "type": "circle",
+    #     "radius": 500,
+    #     "sigma": 0,
+    #     "invert": False
+    # }
+
+    if mask_info["type"] == "circle":
+        mask = create_circle_mask(arr.shape, radius=mask_info["radius"], sigma=mask_info["sigma"])
+
+    if mask_info["type"] == "rect":
+        mask = create_rect_mask(arr, pt=mask_info["pt"], w=mask_info["w"], h=mask_info["h"], sigma=mask_info["sigma"])
+
+    if mask_info["invert"]:
+        mask = np.logical_not(mask)
+
+    return mask
```

## fibsem/segmentation/model.py

```diff
@@ -4,14 +4,16 @@
 import torch
 import torch.nn.functional as F
 
 import segmentation_models_pytorch as smp
 from fibsem.segmentation.utils import decode_segmap
 
 from pathlib import Path
+from fibsem import config as cfg
+import os
 
 
 class SegmentationModel:
     def __init__(
         self,
         checkpoint: str = None,
         encoder: str = "resnet18",
@@ -42,14 +44,16 @@
             classes=self.num_classes,
         )
         model.to(self.device)
         return model
 
     def load_weights(self, checkpoint: Optional[str]):
         if checkpoint:
+            
+            checkpoint = os.path.join(cfg.MODELS_PATH, checkpoint)
             self.checkpoint = checkpoint
             checkpoint_state = torch.load(checkpoint, map_location=self.device)
             self.model.load_state_dict(checkpoint_state)
 
     def pre_process(self, img: np.ndarray) -> torch.Tensor:
         """Pre-process the image for inference"""
```

## fibsem/ui/FibsemEmbeddedDetectionWidget.py

```diff
@@ -159,15 +159,15 @@
         self.viewer.camera.center = [
             0.0,
             self._image_layer.data.shape[0] / 2,
             self._image_layer.data.shape[1] / 2,
         ]
         self.viewer.camera.zoom = 0.7
 
-        napari.utils.notifications.show_info(f"Features Detected")
+        napari.utils.notifications.show_info(f"Features ({', '.join([f.name for f in self.det.features])}) Detected")
 
     def update_info(self):
         
         if len(self.det.features) > 2:
             self.label_info.setText("Info not available.")
             return
         
@@ -273,26 +273,8 @@
     )
     napari.run()
 
     det = det_widget_ui.det
 
 
 if __name__ == "__main__":
-    main()
-
-
-# DONE
-# - convert to use binary masks instead of rgb - DOne
-# - add mask, rgb to detected features + save to file  # DONE
-# - convert mask layer to label not image # DONE
-# - save detected features to file on prev / save image # DONE
-# - add n detections, not just two.. if no features are passed... use all?
-# - add toggles for seg / feature detection / eval
-# - maybe integrate as labelling ui? -> assisted labelling
-# - toggle show info checkbox
-
-# TODO:
-# - convert detected features / detection to take in Union[FibsemImage, np.ndarray]
-# - edittable mask -> rerun detection 
-# - abstract segmentation model widget
-# - need to ensure feature det is only enabled if seg is enabled
-# - need seg to be enabled if feature det is enabled same for eval
+    main()
```

## fibsem/ui/FibsemImageSettingsWidget.py

```diff
@@ -67,15 +67,15 @@
 
         self.selected_beam.addItems([beam.name for beam in BeamType])
 
         self.pushButton_take_image.clicked.connect(lambda: self.take_image(None))
         self.pushButton_take_all_images.clicked.connect(self.take_reference_images)
         self.checkBox_image_save_image.toggled.connect(self.update_ui_saving_settings)
         self.set_detector_button.clicked.connect(self.apply_detector_settings)
-        self.selected_beam.currentTextChanged.connect(self.update_detector_ui)
+        self.selected_beam.currentIndexChanged.connect(self.update_detector_ui)
         self.button_set_beam_settings.clicked.connect(self.apply_beam_settings)
         self.detector_contrast_slider.valueChanged.connect(self.update_labels)
         self.detector_brightness_slider.valueChanged.connect(self.update_labels)
         self.ion_ruler_checkBox.toggled.connect(self.update_ruler)
         self.scalebar_checkbox.toggled.connect(self.update_ui_tools)
         self.crosshair_checkbox.toggled.connect(self.update_ui_tools)
 
@@ -271,14 +271,19 @@
             stigmation = Point(self.stigmation_x.value(), self.stigmation_y.value()),
             shift = Point(self.shift_x.value() * constants.MICRO_TO_SI, self.shift_y.value()*constants.MICRO_TO_SI),
         )
         return self.image_settings, self.detector_settings, self.beam_settings
 
     def set_ui_from_settings(self, image_settings: ImageSettings, beam_type: BeamType):
 
+        # disconnect beam type combobox
+        self.selected_beam.currentIndexChanged.disconnect()
+        self.selected_beam.setCurrentText(beam_type.name)
+        self.selected_beam.currentIndexChanged.connect(self.update_detector_ui)
+        
         beam_settings = self.get_beam_settings(beam_type)
         detector_settings = self.get_detector_settings(beam_type)
 
         self.spinBox_resolution_x.setValue(image_settings.resolution[0])
         self.spinBox_resolution_y.setValue(image_settings.resolution[1])
 
         self.doubleSpinBox_image_dwell_time.setValue(image_settings.dwell_time * constants.SI_TO_MICRO)
@@ -300,32 +305,41 @@
             self.working_distance.setValue(beam_settings.working_distance*constants.METRE_TO_MILLIMETRE)
         if beam_settings.shift is not None:
             self.shift_x.setValue(beam_settings.shift.x * constants.SI_TO_MICRO)
             self.shift_y.setValue(beam_settings.shift.y * constants.SI_TO_MICRO)
         if beam_settings.stigmation is not None:
             self.stigmation_x.setValue(beam_settings.stigmation.x)
             self.stigmation_y.setValue(beam_settings.stigmation.y)
+        
+        self.update_ui_saving_settings()
 
     def update_ui_saving_settings(self):
 
         self.label_image_save_path.setVisible(self.checkBox_image_save_image.isChecked())
         self.lineEdit_image_path.setVisible(self.checkBox_image_save_image.isChecked())
         self.label_image_label.setVisible(self.checkBox_image_save_image.isChecked())
         self.lineEdit_image_label.setVisible(self.checkBox_image_save_image.isChecked())
         
   
     def update_detector_ui(self):
         beam_type = BeamType[self.selected_beam.currentText()]
-        if beam_type == BeamType.ELECTRON:
-            self.comboBox_presets.hide()
-            self.label_presets.hide()
-        else:
-            self.comboBox_presets.show()
-            self.label_presets.show()
+        # if beam_type is BeamType.ELECTRON:
+        #     self.comboBox_presets.hide()
+        #     self.label_presets.hide()
+        # else:
+        #     self.comboBox_presets.show()
+        #     self.label_presets.show()
+
+        _is_ion = bool(beam_type is BeamType.ION)
+        _is_tescan = isinstance(self.microscope, TescanMicroscope)
         
+        self.comboBox_presets.setVisible(_is_ion and _is_tescan)
+        self.label_presets.setVisible(_is_ion and _is_tescan)
+
+
         self.detector_type = self.microscope.get_available_values("detector_type", beam_type=beam_type)
         self.detector_type_combobox.clear()
         self.detector_type_combobox.addItems(self.detector_type)
         self.detector_type_combobox.setCurrentText(self.microscope.get("detector_type", beam_type=beam_type))
         
         self.detector_mode = self.microscope.get_available_values("detector_mode", beam_type=beam_type)
         self.detector_mode_combobox.clear()
@@ -433,33 +447,21 @@
                 size=20,
                 edge_width=7,
                 edge_width_is_relative=False,
                 edge_color='transparent',
                 face_color='transparent',
                 )   
 
-        if self.scalebar_checkbox.isChecked():
-            sc_is_checked = True
-            ui_utils._draw_scalebar(viewer=self.viewer,eb_image= self.eb_image,ib_image= self.ib_image,is_checked=sc_is_checked)
-        else:
-            sc_is_checked = False
-            ui_utils._draw_scalebar(viewer=self.viewer,eb_image= self.eb_image,ib_image= self.ib_image,is_checked=sc_is_checked)
 
-        if self.crosshair_checkbox.isChecked():
-            is_checked = True
-            ui_utils._draw_crosshair(viewer=self.viewer,eb_image= self.eb_image,ib_image= self.ib_image,is_checked=is_checked)
-            
-        else:
-            is_checked = False
-            ui_utils._draw_crosshair(viewer=self.viewer,eb_image= self.eb_image,ib_image= self.ib_image,is_checked=is_checked)
+        # draw scalebar and crosshair
+        if self.eb_image is not None and self.ib_image is not None:
+            ui_utils._draw_scalebar(viewer=self.viewer,eb_image= self.eb_image,ib_image= self.ib_image,is_checked=self.scalebar_checkbox.isChecked())
+            ui_utils._draw_crosshair(viewer=self.viewer,eb_image= self.eb_image,ib_image= self.ib_image,is_checked=self.crosshair_checkbox.isChecked()) 
             
-
-        self.set_ui_from_settings(image_settings = self.image_settings, beam_type= BeamType[self.selected_beam.currentText()])
-
-        
+        self.set_ui_from_settings(image_settings = self.image_settings, beam_type= BeamType[self.selected_beam.currentText()])      
         
         # set the active layer to the electron beam (for movement)
         if self.eb_layer:
             self.viewer.layers.selection.active = self.eb_layer
 
         self.viewer_update_signal.emit()
```

## fibsem/ui/FibsemManipulatorWidget.py

```diff
@@ -11,16 +11,15 @@
 from fibsem.microscope import (DemoMicroscope, FibsemMicroscope,
                                TescanMicroscope, ThermoMicroscope)
 from fibsem.structures import (BeamType, FibsemManipulatorPosition,
                                MicroscopeSettings)
 from fibsem.ui.FibsemImageSettingsWidget import FibsemImageSettingsWidget
 from fibsem.ui.qtdesigner_files import FibsemManipulatorWidget
 from fibsem.ui.utils import message_box_ui
-from fibsem.utils import save_yaml
-
+\
 
 class FibsemManipulatorWidget(FibsemManipulatorWidget.Ui_Form, QtWidgets.QWidget):
     def __init__(
         self,
         microscope: FibsemMicroscope = None,
         settings: MicroscopeSettings = None,
         viewer: napari.Viewer = None,
@@ -114,66 +113,14 @@
             response = not response
         else:
             response = False
 
         return response
         
 
-    def manipulator_position_calibration(self,config_path):
-
-        if not isinstance(self.microscope,TescanMicroscope):
-
-            message_box_ui(title="Not Available", text="Manipulator Position Calibration is only available for Tescan Microscopes", buttons=QMessageBox.Ok)
-
-            return
-
-        
-        response = self._check_manipulator_positions_setup()
-
-        if not response:
-            
-            ok_to_cal =message_box_ui(title="Manipulator Position calibration",text="This tool calibrates the positions of the manipulator, it will switch between the parking, standby and working positions rapidly, please ensure it is safe to do so. If not please click no, otherwise press yes to continue")
-                                      
-            if ok_to_cal:
-
-                positions = self.settings.hardware.manipulator_positions
-
-                for position in positions:
-                    if position == "calibrated":
-                        continue
-                    logging.info(f"Calibrating Manipulator {position} position")
-                    self.microscope.insert_manipulator(position)
-                    manipulator_loc = self.microscope.get_manipulator_position()
-                    positions[position]["x"] = manipulator_loc.x
-                    positions[position]["y"] = manipulator_loc.y
-                    positions[position]["z"] = manipulator_loc.z
-                
-                positions["calibrated"] = True
-                self.settings.hardware.manipulator_positions = positions
-                hardware_dict = self.settings.hardware.__to_dict__()
-
-                save_yaml(os.path.join(config_path,"model.yaml"), hardware_dict)
-
-                message_box_ui(title="Manipulator Position calibration",text="Manipulator Positions calibrated successfully", buttons=QMessageBox.Ok)
-
-                
-                self.insertManipulator_button.setEnabled(True)
-                self.moveRelative_button.setEnabled(True)
-                self.addSavedPosition_button.setEnabled(True)
-                self.goToPosition_button.setEnabled(True)
-                self.manipulator_inserted = self.microscope.get_manipulator_state(settings=self.settings)
-                self._hide_show_buttons(show=self.manipulator_inserted)
-                self.manipulatorStatus_label.setText("Manipulator Status: Inserted" if self.manipulator_inserted else "Manipulator Status: Retracted")
-                self.insertManipulator_button.setText("Insert" if not self.manipulator_inserted else "Retract")
-                self.calibrated_status_label.setText("Calibrated")
-
-
-
-
-
     def change_move_type(self):
 
         if self.move_type_comboBox.currentText() == "Relative Move":
             self.dZ_spinbox.setEnabled(True)
             self.dZ_spinbox.show()
             self.dz_label.show()
             self.beam_type_label.hide()
```

## fibsem/ui/FibsemMillingWidget.py

```diff
@@ -1,9 +1,10 @@
 
 import logging
+import time
 from PIL import Image
 import numpy as np
 from copy import deepcopy
 import napari
 import napari.utils.notifications
 from PyQt5 import QtWidgets, QtCore
 
@@ -13,31 +14,33 @@
                                TescanMicroscope, ThermoMicroscope)
 from fibsem.patterning import FibsemMillingStage
 from fibsem.structures import (BeamType, FibsemMillingSettings,
                                FibsemPatternSettings, MicroscopeSettings,
                                Point, FibsemPattern)
 from fibsem.ui.FibsemImageSettingsWidget import FibsemImageSettingsWidget
 from fibsem.ui.qtdesigner_files import FibsemMillingWidget
-from fibsem.ui.utils import _draw_patterns_in_napari, _remove_all_layers, convert_pattern_to_napari_circle,convert_pattern_to_napari_rect, validate_pattern_placement,_get_directory_ui,_get_file_ui
+from fibsem.ui.utils import _draw_patterns_in_napari, _remove_all_layers, convert_pattern_to_napari_circle, convert_pattern_to_napari_rect, validate_pattern_placement,_get_directory_ui,_get_file_ui
 from napari.qt.threading import thread_worker
 
-_UNSCALED_VALUES  = ["rotation", "size_ratio", "scan_direction", "cleaning_cross_section", "number"]
+_UNSCALED_VALUES  = ["rotation", "size_ratio", "scan_direction", "cleaning_cross_section", "number", "passes"]
 _ANGLE_KEYS = ["rotation"]
+
 def _scale_value(key, value, scale):
     if key not in _UNSCALED_VALUES:
         return value * scale    
     return value
 
 def log_status_message(stage: FibsemMillingStage, step: str):
     logging.debug(
         f"STATUS | Milling Widget | {stage.name} | {step}"
     )
 
 class FibsemMillingWidget(FibsemMillingWidget.Ui_Form, QtWidgets.QWidget):
     milling_position_changed = QtCore.pyqtSignal()
+    _milling_finished = QtCore.pyqtSignal()
 
     def __init__(
         self,
         microscope: FibsemMicroscope = None,
         settings: MicroscopeSettings = None,
         viewer: napari.Viewer = None,
         image_widget: FibsemImageSettingsWidget = None,
@@ -61,27 +64,30 @@
 
         self.setup_connections()
 
         self.update_pattern_ui()
 
         self.good_copy_pattern = None
 
+        self._UPDATING_PATTERN:bool = False
+        self._PATTERN_IS_MOVEABLE: bool = True
+
     def setup_connections(self):
 
-        self.image_widget.viewer_update_signal.connect(self.update_pattern_ui)
+        self.image_widget.viewer_update_signal.connect(self.update_ui) # this happens after every time the viewer is updated
 
         # milling
         available_currents = self.microscope.get_available_values("current", BeamType.ION)
         self.comboBox_milling_current.addItems([str(current) for current in available_currents])
 
         _THERMO = isinstance(self.microscope, ThermoMicroscope)
         _TESCAN = isinstance(self.microscope, TescanMicroscope)
 
         if isinstance(self.microscope, DemoMicroscope):
-            _THERMO, _TESCAN = True, True
+            _THERMO, _TESCAN = True, False
         
         # THERMO 
         self.label_application_file.setVisible(_THERMO)
         self.comboBox_application_file.setVisible(_THERMO)
         available_application_files = self.microscope.get_available_values("application_file")
         self.comboBox_application_file.addItems(available_application_files)
         self.comboBox_preset.setVisible(_THERMO)
@@ -121,15 +127,15 @@
         self.image_widget.ib_layer.mouse_drag_callbacks.append(self._single_click)
 
         # new patterns
         self.comboBox_patterns.addItems([pattern.name for pattern in patterning.__PATTERNS__])
         if _TESCAN and not _THERMO:
             index = self.comboBox_patterns.findText("BitmapPattern")
             self.comboBox_patterns.removeItem(index)
-        self.comboBox_patterns.currentIndexChanged.connect(self.update_pattern_ui)
+        self.comboBox_patterns.currentIndexChanged.connect(lambda: self.update_pattern_ui(None))
     
         # milling stages
         self.pushButton_add_milling_stage.clicked.connect(self.add_milling_stage)
         self.pushButton_add_milling_stage.setStyleSheet("background-color: green; color: white;")
         self.pushButton_remove_milling_stage.clicked.connect(self.remove_milling_stage)
         self.pushButton_remove_milling_stage.setStyleSheet("background-color: red; color: white;")
         
@@ -139,23 +145,26 @@
 
         # run milling
         self.pushButton_run_milling.clicked.connect(self.run_milling)
 
         if self.milling_stages:
             self.comboBox_milling_stage.addItems([stage.name for stage in self.milling_stages])
             self.update_milling_stage_ui()
-        self.comboBox_milling_stage.currentIndexChanged.connect(lambda: self.update_protocol_ui())
+        self.comboBox_milling_stage.currentIndexChanged.connect(lambda: self.update_milling_stage_ui())
 
         # last
         self.doubleSpinBox_centre_x.setKeyboardTracking(False)
         self.doubleSpinBox_centre_y.setKeyboardTracking(False)
         self.doubleSpinBox_centre_x.valueChanged.connect(self.update_ui_pattern)
         self.doubleSpinBox_centre_y.valueChanged.connect(self.update_ui_pattern)
         self.checkBox_live_update.setChecked(True)
 
+
+        self._AVAILABLE_SCAN_DIRECTIONS = self.microscope.get_available_values(key="scan_direction")
+
     def update_settings(self):
         settings = self.get_milling_settings_from_ui()
         index = self.comboBox_milling_stage.currentIndex()
         if index != -1:
             self.milling_stages[index].milling = settings
 
     def add_milling_stage(self):
@@ -175,35 +184,40 @@
     def remove_milling_stage(self):
         logging.info("Removing milling stage")
 
         current_index = self.comboBox_milling_stage.currentIndex()
         log_status_message(self.milling_stages[current_index], "REMOVED_STAGE")
         self.milling_stages.pop(current_index)
         self.comboBox_milling_stage.removeItem(current_index)
-        napari.utils.notifications.show_info(f"Removed milling stage.")
-        self.comboBox_milling_stage.clear()
-        # index = self.comboBox_milling_stage.currentIndex()
-        # if index != -1:
-        if len(self.milling_stages)>0:
-            for i, stage in enumerate(self.milling_stages):
-                stage.name = f"Milling Stage {i + 1}"
-                self.comboBox_milling_stage.addItem(stage.name)
-            
+        napari.utils.notifications.show_info(f"Removed milling stage.")            
 
     def _remove_all_stages(self):
 
-        while len(self.milling_stages) > 0:
-            self.remove_milling_stage()
+        self.milling_stages = []
+        self.comboBox_milling_stage.currentIndexChanged.disconnect()
+        self.comboBox_milling_stage.clear()
+        self.comboBox_milling_stage.addItems([stage.name for stage in self.milling_stages])
+        self.comboBox_milling_stage.currentIndexChanged.connect(lambda: self.update_milling_stage_ui())
+
         _remove_all_layers(self.viewer) # remove all shape layers
 
     def set_milling_stages(self, milling_stages: list[FibsemMillingStage]) -> None:
         logging.info(f"Setting milling stages: {len(milling_stages)}")
         self.milling_stages = milling_stages
+        
+        # very explicitly set what is happening
+        self.comboBox_milling_stage.currentIndexChanged.disconnect()
         self.comboBox_milling_stage.clear()
         self.comboBox_milling_stage.addItems([stage.name for stage in self.milling_stages])
+        self.comboBox_milling_stage.currentIndexChanged.connect(lambda: self.update_milling_stage_ui())
+        
+        self.comboBox_patterns.currentIndexChanged.disconnect()
+        self.comboBox_patterns.setCurrentText(self.milling_stages[0].pattern.name)
+        self.comboBox_patterns.currentIndexChanged.connect(lambda: self.update_pattern_ui(None))
+        
         logging.info(f"Set milling stages: {len(milling_stages)}")
         self.update_milling_stage_ui()
         # self.update_ui()
 
     def get_milling_stages(self):
         return self.milling_stages
 
@@ -222,19 +236,23 @@
             return
 
         milling_stage: FibsemMillingStage = self.milling_stages[current_index]
 
         # set the milling settings
         self.set_milling_settings_ui(milling_stage.milling)
 
-        # set the pattern (and triggers the pattern settings)
-        self.comboBox_patterns.setCurrentText(milling_stage.pattern.name)
+        # set the pattern protcol
+        self.update_pattern_ui(milling_stage)
+
 
     def update_ui_pattern(self):
 
+        if self._UPDATING_PATTERN:
+            return
+
         if self.checkBox_live_update.isChecked():
             self.update_ui()
 
     def update_milling_stage_from_ui(self):
                 
         # get current milling stage
         current_index = self.comboBox_milling_stage.currentIndex()
@@ -249,65 +267,96 @@
 
         # update milling settings
         milling_stage.milling = self.get_milling_settings_from_ui()
 
         # update pattern and define
         milling_stage.pattern = self.get_pattern_from_ui_v2()
 
-
         napari.utils.notifications.show_info(f"Updated {milling_stage.name}.")
         return 
 
     def open_path_dialog(self):
 
         file_path = _get_file_ui(msg="Select Bitmap File",_filter= "*bmp")
         
         self.path_edit.setText(file_path)
 
-    def update_pattern_ui(self,pattern_protocol=None, point=None):
-
-        # get current pattern
-
-        current_pattern_text = self.comboBox_patterns.currentText()
-        patterns_available = [pattern.name for pattern in patterning.__PATTERNS__]
-
-        pattern_available_index = patterns_available.index(current_pattern_text)
+    def update_pattern_ui(self,milling_stage: FibsemMillingStage = None):
 
-        pattern = patterning.__PATTERNS__[pattern_available_index]
+        self._UPDATING_PATTERN = True
 
-        logging.info(f"Selected pattern: {pattern.name}")
-        logging.info(f"Required parameters: {pattern.required_keys}")
+        # get current pattern
+        if milling_stage is None:
+            current_pattern_text = self.comboBox_patterns.currentText()
+            patterns_available = [pattern.name for pattern in patterning.__PATTERNS__]
+            pattern_available_index = patterns_available.index(current_pattern_text)
+            pattern = patterning.__PATTERNS__[pattern_available_index]
+            pattern_protocol = self.protocol["patterns"][pattern.name]
+            point = None
+        else:
+            pattern = milling_stage.pattern
+            pattern_protocol = milling_stage.pattern.protocol
+            point = milling_stage.pattern.point
+            self.comboBox_patterns.currentIndexChanged.disconnect()
+            self.comboBox_patterns.setCurrentText(milling_stage.pattern.name)
+            self.comboBox_patterns.currentIndexChanged.connect(lambda: self.update_pattern_ui(None))
 
-        # create a label and double spinbox for each required keys and add it to the layout
+        logging.info(f"PATTERN: {pattern.name}")
+        logging.info(f"PROTOCOL: {pattern_protocol}")
 
         # clear layout
         for i in reversed(range(self.gridLayout_patterns.count())):
             self.gridLayout_patterns.itemAt(i).widget().setParent(None)
 
-        
-        # TODO: this doesnt update when setting from milling_stage
-        if pattern_protocol is None or not isinstance(pattern_protocol, dict):
-            pattern_protocol = self.protocol["patterns"][pattern.name]
-
-        # we want to set the protocol, not the milling stage...
-        # add new widgets
-        # TODO: smarter logic for which kinds of widgets to add
+        # set widgets for each required key / value
         for i, key in enumerate(pattern.required_keys):
             if key == "path":
                 label = QtWidgets.QLabel(key)
                 self.path_edit = QtWidgets.QLineEdit()
                 self.gridLayout_patterns.addWidget(label, i, 0)
                 self.gridLayout_patterns.addWidget(self.path_edit, i, 1)
                 self.path_edit.setText(pattern_protocol[key])
                 path_explorer = QtWidgets.QPushButton("...")
                 self.gridLayout_patterns.addWidget(path_explorer, i, 2)
                 path_explorer.clicked.connect(self.open_path_dialog)
-                self.path_edit.textChanged.connect(self.update_ui_pattern)
+                self.path_edit.editingFinished.connect(self.update_ui_pattern)
+                continue
+            
+            if key == "scan_direction":
+                label = QtWidgets.QLabel(key)
+                self.comboBox_scan_direction = QtWidgets.QComboBox()
+                self.gridLayout_patterns.addWidget(label, i, 0)
+                self.gridLayout_patterns.addWidget(self.comboBox_scan_direction, i, 1)
+                self.comboBox_scan_direction.addItems(self._AVAILABLE_SCAN_DIRECTIONS)
+                scan_direction_to_use = pattern_protocol[key] if pattern_protocol[key] in self._AVAILABLE_SCAN_DIRECTIONS else self._AVAILABLE_SCAN_DIRECTIONS[0]
+                # logging.info(f'Scan direction to use: {scan_direction_to_use}, available: {self._AVAILABLE_SCAN_DIRECTIONS}')
+                self.comboBox_scan_direction.setCurrentText(scan_direction_to_use)
+                self.comboBox_scan_direction.currentIndexChanged.connect(self.update_ui_pattern)
                 continue
 
+            if key == "cleaning_cross_section":
+                if isinstance(self.microscope, ThermoMicroscope) and pattern.name == "Circle":
+                    continue
+                label = QtWidgets.QLabel(key)
+                self.checkbox_cleaning_cross_section = QtWidgets.QCheckBox()
+                self.gridLayout_patterns.addWidget(label, i, 0)
+                self.gridLayout_patterns.addWidget(self.checkbox_cleaning_cross_section, i, 1)
+                self.checkbox_cleaning_cross_section.setChecked(pattern_protocol[key])
+                self.checkbox_cleaning_cross_section.stateChanged.connect(self.update_ui_pattern)
+                continue
+
+            if key == "passes":
+                label = QtWidgets.QLabel(key)
+                self.passes_comboBox = QtWidgets.QLineEdit()
+                self.passes_comboBox.setSizePolicy(QtWidgets.QSizePolicy.Minimum, QtWidgets.QSizePolicy.Minimum)
+                self.gridLayout_patterns.addWidget(label, i, 0)
+                self.gridLayout_patterns.addWidget(self.passes_comboBox, i, 1)
+                self.passes_comboBox.setText("N/A")
+                self.passes_comboBox.editingFinished.connect(self.update_ui_pattern)
+                continue
             label = QtWidgets.QLabel(key)
             spinbox = QtWidgets.QDoubleSpinBox()
             spinbox.setDecimals(3)
             spinbox.setSingleStep(0.001)
             spinbox.setRange(0, 1000)
             spinbox.setValue(0)
             self.gridLayout_patterns.addWidget(label, i, 0)
@@ -320,35 +369,44 @@
                 spinbox.setValue(value)
             
             spinbox.valueChanged.connect(self.update_ui_pattern)
 
         if point is not None:
             self.doubleSpinBox_centre_x.setValue(point.x * constants.SI_TO_MICRO)
             self.doubleSpinBox_centre_y.setValue(point.y * constants.SI_TO_MICRO)
-        index = self.comboBox_milling_stage.currentIndex()
-        if index != -1:
-            point = self.milling_stages[index].pattern.point
-            self.doubleSpinBox_centre_x.setValue(point.x * constants.SI_TO_MICRO)
-            self.doubleSpinBox_centre_y.setValue(point.y * constants.SI_TO_MICRO)
 
         if self.milling_stages:
             self.update_ui()
+
+        self._UPDATING_PATTERN = False
     
     def get_pattern_settings_from_ui(self, pattern: patterning.BasePattern):
         # get pattern protocol from ui
         pattern_dict = {}
         for i, key in enumerate(pattern.required_keys):
             if key == "path":
                 # add path in ui and get from there
                 path = self.path_edit.text()
                 pattern_dict[key] = path
                 continue
+            if key == "scan_direction":
+                pattern_dict[key] = self.comboBox_scan_direction.currentText()
+                continue
+            if key == "cleaning_cross_section":
+                if isinstance(self.microscope, ThermoMicroscope) and pattern.name == "Circle":
+                    continue
+                pattern_dict[key] = self.checkbox_cleaning_cross_section.isChecked()
+                continue
+            if key == "passes":
+                pattern_dict[key] = self.passes_comboBox.text() if self.passes_comboBox.text() != "N/A" else None
+                continue
+
             spinbox = self.gridLayout_patterns.itemAtPosition(i, 1).widget()
             value = _scale_value(key, spinbox.value(), constants.MICRO_TO_SI)
-            value = value * constants.DEGREES_TO_RADIANS if key in _ANGLE_KEYS else value
+            # value = value * constants.DEGREES_TO_RADIANS if key in _ANGLE_KEYS else value
             pattern_dict[key] = value # TODO: not everythign is in microns
         return pattern_dict
 
     def get_pattern_from_ui_v2(self):
 
         # get current pattern
         pattern = patterning.get_pattern(self.comboBox_patterns.currentText())
@@ -358,17 +416,25 @@
         point = Point(x=self.doubleSpinBox_centre_x.value() * constants.MICRO_TO_SI, y=self.doubleSpinBox_centre_y.value() * constants.MICRO_TO_SI)
         pattern.define(protocol=pattern_dict, point=point)
         
         return pattern
 
     def _single_click(self, layer, event):
         """Callback for single click on image layer."""
-        if event.button != 2:
+        if event.button != 1 or 'Shift' not in event.modifiers or self.milling_stages == []:
+            return
+
+        if not self._PATTERN_IS_MOVEABLE:
+            msg = f"Pattern is not moveable."
+            logging.info(msg)
+            napari.utils.notifications.show_info(msg)
             return
 
+        self._UPDATING_PATTERN = True
+
         # get coords
         coords = layer.world_to_data(event.position)
 
         # TODO: dimensions are mixed which makes this confusing to interpret... resolve
         coords, beam_type, image = self.image_widget.get_data_from_coord(coords)
         
         if beam_type is not BeamType.ION:
@@ -403,41 +469,42 @@
             if len(renewed_patterns) == len(self.milling_stages):
                 for milling_stage, pattern_renew in zip(self.milling_stages, renewed_patterns):
 
                     milling_stage.pattern = pattern_renew
                     milling_stage.pattern.point = point
 
                 self.doubleSpinBox_centre_x.setValue(point.x * constants.SI_TO_MICRO)
-                self.doubleSpinBox_centre_y.setValue(point.y * constants.SI_TO_MICRO)
+                self.doubleSpinBox_centre_y.setValue(point.y * constants.SI_TO_MICRO) # THIS TRIGGERS AN UPDATE
                 logging.info(f"Moved patterns to {point} ")
                 self.update_ui(milling_stages=self.milling_stages)
                 self.milling_position_changed.emit()
 
                 
         else:
-        # update pattern
+            # update pattern
             current_stage_index = self.comboBox_milling_stage.currentIndex()
             pattern = patterning.get_pattern(self.comboBox_patterns.currentText())
             pattern_dict = self.milling_stages[current_stage_index].pattern.protocol
             pattern.define(protocol=pattern_dict, point=point)
             is_valid = self.valid_pattern_location(pattern)
-
             if is_valid:
                 # update ui
                 self.doubleSpinBox_centre_x.setValue(point.x * constants.SI_TO_MICRO)
                 self.doubleSpinBox_centre_y.setValue(point.y * constants.SI_TO_MICRO)
                 logging.info(f"Moved pattern to {point}")
                 log_status_message(self.milling_stages[current_stage_index], f"MOVED_PATTERN_TO_{point}")
                 self.good_copy_pattern = deepcopy(pattern)
                 self.update_ui()
                 self.milling_position_changed.emit()
+
             else:
                 napari.utils.notifications.show_warning("Pattern is not within the image.")
                 self.milling_stages[current_stage_index].pattern = self.good_copy_pattern
         
+        self._UPDATING_PATTERN = False
 
     def valid_pattern_location(self,stage_pattern):
         
         for pattern_settings in stage_pattern.patterns:
             if pattern_settings.pattern is FibsemPattern.Circle:
                 shape = convert_pattern_to_napari_circle(pattern_settings=pattern_settings, image=self.image_widget.ib_image)
             else:
@@ -447,17 +514,20 @@
             if not output:
                 return False
         
         return True
    
     def set_milling_settings_ui(self, milling: FibsemMillingSettings) -> None:
 
-        self.comboBox_milling_current.setCurrentText(str(milling.milling_current))
+        if self.comboBox_milling_current.findText(str(milling.milling_current)) == -1:
+            napari.utils.notifications.show_warning(f"Could not find milling current {milling.milling_current} in list of available currents.")
+        else:
+            self.comboBox_milling_current.setCurrentText(str(milling.milling_current))
         self.comboBox_application_file.setCurrentText(milling.application_file)
-        self.doubleSpinBox_rate.setValue(milling.rate)
+        self.doubleSpinBox_rate.setValue(milling.rate*constants.SI_TO_NANO)
         self.doubleSpinBox_dwell_time.setValue(milling.dwell_time * constants.SI_TO_MICRO)
         self.doubleSpinBox_spot_size.setValue(milling.spot_size * constants.SI_TO_MICRO)
         self.doubleSpinBox_hfw.setValue(milling.hfw * constants.SI_TO_MICRO)
         self.comboBox_preset.setCurrentText(str(milling.preset))
 
     def get_milling_settings_from_ui(self):
 
@@ -471,77 +541,55 @@
             preset= self.comboBox_preset.currentText(),
             spacing=self.doubleSpinBox_spacing.value(),
 
         )
 
         return milling_settings
 
-    def update_protocol_ui(self):
-        index = self.comboBox_milling_stage.currentIndex()
-        if index != -1:
-            settings = self.milling_stages[index].milling 
-            self.set_milling_settings_ui(settings)
-            self.comboBox_patterns.setCurrentText(self.milling_stages[index].pattern.name)
-            pattern_protocol = self.milling_stages[index].pattern.protocol
-            point = self.milling_stages[index].pattern.point
-            self.update_pattern_ui(pattern_protocol, point)
-        else:
-            layer_names_to_remove = ["Stage 1","annulus_Image","bmp_Image","pattern_crosshair"]
-            layers_to_remove = []
-            for layer in self.viewer.layers:
-                
-                if layer.name in layer_names_to_remove:
-                    layers_to_remove.append(layer)
-
-            for layer in layers_to_remove:
-                self.viewer.layers.remove(layer)
-            # self.viewer.layers.remove("Stage 1")
-
     def update_ui(self, milling_stages: list[FibsemMillingStage] = None):
+        self.doubleSpinBox_hfw.setValue(self.image_widget.doubleSpinBox_image_hfw.value())
+
+        if milling_stages is None and len(self.milling_stages) < 1:
+            return
         
+        t0 = time.time()
         if milling_stages is None:
             self.update_milling_stage_from_ui() # update milling stage from ui
             milling_stages = self.get_milling_stages() # get the latest milling stages from the ui
-            
+
+        t1 = time.time() 
 
         if not milling_stages:
-            msg = f"No milling stages defined, cannot draw patterns."
-            logging.warning(msg)
-            napari.utils.notifications.show_warning(msg)
             _remove_all_layers(self.viewer)
             return
 
         # make milling stage a list if it is not
         if not isinstance(milling_stages, list):
             milling_stages = [milling_stages]
 
-        # get all patterns (2D list, one list of pattern settings per stage)
-        patterns: list[list[FibsemPatternSettings]] = [stage.pattern.patterns for stage in milling_stages if stage.pattern is not None]
-        pattern_centres: list[Point] = [stage.pattern.point for stage in milling_stages if stage.pattern is not None]
-
+        t2 = time.time()
         try:
             
             from fibsem.structures import FibsemImage
             if not isinstance(self.image_widget.ib_image, FibsemImage):
                 raise Exception(f"No Ion Image, cannot draw patterns. Please take an image.")
             if not isinstance(self.image_widget.eb_image, FibsemImage):
                 raise Exception(f"No Electron Image, cannot draw patterns. Please take an image.") # TODO: this is unintuitive why this is required -> ui issue only
-
             # clear patterns then draw new ones
             _draw_patterns_in_napari(self.viewer, 
                 ib_image=self.image_widget.ib_image, 
                 eb_image=self.image_widget.eb_image, 
-                all_patterns=patterns,
-                stage_centres=pattern_centres) # TODO: add names and legend for this
-            
+                milling_stages = milling_stages) # TODO: add names and legend for this
+        
         except Exception as e:
             napari.utils.notifications.show_error(f"Error drawing patterns: {e}")
             logging.error(e)
             return
-        
+        t2 = time.time()
+        logging.warning(f"UPDATE_UI: GET: {t1-t0}, DRAW: {t2-t1}")
         self.viewer.layers.selection.active = self.image_widget.eb_layer
 
     def _toggle_interaction(self, enabled: bool = True):
 
         """Toggle microscope and pattern interactions."""
 
         self.pushButton.setEnabled(enabled)
@@ -564,16 +612,17 @@
         worker.finished.connect(self.run_milling_finished)
         worker.yielded.connect(self.update_milling_ui)
         worker.start()
 
     @thread_worker
     def run_milling_step(self):
 
+        milling_stages = self.get_milling_stages()
         self._toggle_interaction(enabled=False)
-        for stage in self.milling_stages:
+        for stage in milling_stages:
             yield f"Preparing: {stage.name}"
             if stage.pattern is not None:
                 log_status_message(stage, f"RUNNING_MILLING_STAGE_{stage.name}")
                 log_status_message(stage, f"MILLING_PATTERN_{stage.pattern.name}: {stage.pattern.patterns}")
                 log_status_message(stage, f"MILLING_SETTINGS_{stage.milling}")
                 milling.setup_milling(self.microscope, mill_settings=stage.milling)
 
@@ -597,14 +646,15 @@
 
     def run_milling_finished(self):
 
         # take new images and update ui
         self._toggle_interaction(enabled=True)
         self.image_widget.take_reference_images()
         self.update_ui()
+        self._milling_finished.emit()
 
 
 def main():
     millings_stages = [
     FibsemMillingStage(
         name="Milling Stage X",
         num = 1,
```

## fibsem/ui/FibsemMovementWidget.py

```diff
@@ -47,25 +47,26 @@
         self.image_widget = image_widget
 
         self.setup_connections()
         self.image_widget.picture_signal.connect(self.update_ui)
         self.positions = []
    
         self.update_ui()
-        # self.minimap()
 
     def setup_connections(self):
 
         # set ui elements
         self.comboBox_movement_mode.addItems([mode.name for mode in MovementMode])
         self.comboBox_movement_stage_coordinate_system.addItems(["SPECIMEN", "RAW"])
 
         # buttons
         self.pushButton_move.clicked.connect(self.move_to_position)
         self.pushButton_continue.clicked.connect(self.continue_pressed)
+        self.pushButton_move_flat_ion.clicked.connect(self.move_flat_to_beam)
+        self.pushButton_move_flat_electron.clicked.connect(self.move_flat_to_beam)
 
         # register mouse callbacks
         self.image_widget.eb_layer.mouse_double_click_callbacks.append(self._double_click)
         self.image_widget.ib_layer.mouse_double_click_callbacks.append(self._double_click)
 
         # disable ui elements
         self.label_movement_instructions.setText("Double click to move.")
@@ -77,29 +78,27 @@
         self.comboBox_positions.currentIndexChanged.connect(self.select_position)
         self.pushButton_save_position.clicked.connect(self.add_position)
         self.pushButton_remove_position.clicked.connect(self.delete_position)
         self.pushButton_go_to.clicked.connect(self.go_to_saved_position)
         self.pushButton_export.clicked.connect(self.export_positions)
         self.pushButton_import.clicked.connect(self.import_positions)
         self.pushButton_update_position.clicked.connect(self.update_saved_position)
-        self.checkBox_auto_scaling.stateChanged.connect(self.minimap)
-        self.spinBox_grid_radius.valueChanged.connect(self.minimap)
+
     def auto_eucentric_correction(self):
 
         print("auto eucentric")
 
     def continue_pressed(self):
         print("continue pressed")
 
     def move_to_position(self):
         stage_position = self.get_position_from_ui()
         self.microscope.move_stage_absolute(stage_position)
         log_status_message(f"MOVED_TO_{stage_position}")
         self.update_ui_after_movement()
-        self.minimap()
     
     def update_ui(self):
 
         stage_position: FibsemStagePosition = self.microscope.get_stage_position()
 
         self.doubleSpinBox_movement_stage_x.setValue(stage_position.x * constants.SI_TO_MILLI)
         self.doubleSpinBox_movement_stage_y.setValue(stage_position.y * constants.SI_TO_MILLI)
@@ -140,15 +139,18 @@
             return
 
         point = conversions.image_to_microscope_image_coordinates(
             Point(x=coords[1], y=coords[0]), image.data, image.metadata.pixel_size.x,
         )
 
         # move
-        self.movement_mode = MovementMode[self.comboBox_movement_mode.currentText()]
+        if "Alt" in event.modifiers:
+            self.movement_mode = MovementMode.Eucentric
+        else:
+            self.movement_mode = MovementMode[self.comboBox_movement_mode.currentText()]
 
         logging.debug(
             f"Movement: {self.movement_mode.name} | COORD {coords} | SHIFT {point.x:.2e}, {point.y:.2e} | {beam_type}"
         )
         log_status_message(f"MOVING_{self.movement_mode.name}_BY_{point.x:.2e}, {point.y:.2e} | {beam_type}")
         # eucentric is only supported for ION beam
         if beam_type is BeamType.ION and self.movement_mode is MovementMode.Eucentric:
@@ -162,21 +164,19 @@
                 settings=self.settings,
                 dx=point.x,
                 dy=point.y,
                 beam_type=beam_type,
             )
         
         self.update_ui_after_movement()
-        self.minimap()
 
     def select_position(self):
         if self.comboBox_positions.currentIndex() != -1:
             position = self.positions[self.comboBox_positions.currentIndex()]
             self.label_current_position.setText(f"x={position.x*constants.METRE_TO_MILLIMETRE:.3f}, y={position.y*constants.METRE_TO_MILLIMETRE:.3f}, z={position.z*constants.METRE_TO_MILLIMETRE:.3f}, r={position.r*constants.RADIANS_TO_DEGREES:.1f}, t={position.t*constants.RADIANS_TO_DEGREES:.1f}")
-            self.minimap()
 
     def add_position(self):
         position = self.microscope.get_stage_position()
         name = self.lineEdit_position_name.text()
         if name == "":
             napari.utils.notifications.show_warning("Please enter a name for the position")
             return
@@ -198,16 +198,15 @@
         position.name = self.comboBox_positions.currentText()
         self.positions[self.comboBox_positions.currentIndex()] = position
         self.select_position()
         logging.info(f"Updated position {self.comboBox_positions.currentText()}")
 
     def go_to_saved_position(self):
         self.microscope.move_stage_absolute(self.positions[self.comboBox_positions.currentIndex()])
-        self.movement_widget.update_ui()
-        self.image_widget.take_reference_images()
+        self.update_ui_after_movement()
         logging.info(f"Moved to position {self.comboBox_positions.currentIndex()}")
 
     def export_positions(self):
         protocol_path = _get_save_file_ui(msg="Select or create file")
         if protocol_path == '':
             return
         dict_position = []
@@ -227,86 +226,102 @@
         with open(protocol_path, "r") as f:
             dict_positions = yaml.safe_load(f)
         for dict_position in dict_positions:
             position = FibsemStagePosition.__from_dict__(dict_position)
             self.positions.append(position)
             self.comboBox_positions.addItem(position.name)
 
-    def minimap(self):
-        x = []
-        y = []
-        labels = []
-        pil_image = None
-        current_position = self.microscope.get_stage_position()
-        x.append(deepcopy(current_position.x)*constants.SI_TO_MICRO)
-        y.append(deepcopy(current_position.y)*constants.SI_TO_MICRO)
-        labels.append("Current Position")
-        for position in self.positions:
-            x.append(deepcopy(position.x)*constants.SI_TO_MICRO)
-            y.append(deepcopy(position.y)*constants.SI_TO_MICRO)
-            labels.append(deepcopy(position.name))
-        import pandas as pd
-        df = pd.DataFrame({'x': x, 'y': y, 'labels': labels})
-        import plotly.express as px
-        import plotly.io as pio
-        fig = px.scatter(df, color="labels", labels={'color': 'Position'}, x = 'x', y = 'y', width=400, height=400)
-        fig.update_traces(
-                marker=dict(size=8, symbol="cross"),
-                selector=dict(mode="markers"),
-            )
+    # def minimap(self):
+    #     x = []
+    #     y = []
+    #     labels = []
+    #     pil_image = None
+    #     current_position = self.microscope.get_stage_position()
+    #     x.append(deepcopy(current_position.x)*constants.SI_TO_MICRO)
+    #     y.append(deepcopy(current_position.y)*constants.SI_TO_MICRO)
+    #     labels.append("Current Position")
+    #     for position in self.positions:
+    #         x.append(deepcopy(position.x)*constants.SI_TO_MICRO)
+    #         y.append(deepcopy(position.y)*constants.SI_TO_MICRO)
+    #         labels.append(deepcopy(position.name))
+    #     import pandas as pd
+    #     df = pd.DataFrame({'x': x, 'y': y, 'labels': labels})
+    #     import plotly.express as px
+    #     import plotly.io as pio
+    #     fig = px.scatter(df, color="labels", labels={'color': 'Position'}, x = 'x', y = 'y', width=400, height=400)
+    #     fig.update_traces(
+    #             marker=dict(size=8, symbol="cross"),
+    #             selector=dict(mode="markers"),
+    #         )
         
-        if self.checkBox_auto_scaling.isChecked():
-            fig.update_layout(legend=dict(
-                orientation="h",
-                yanchor="bottom",
-                y=1.02,
-                xanchor="right",
-                x=1
-            ),
-            margin=dict(l=5, r=5, t=5, b=5),
-            legend_title_text=None,
-            xaxis_title=None,
-                yaxis_title=None,
-            )
+    #     if self.checkBox_auto_scaling.isChecked():
+    #         fig.update_layout(legend=dict(
+    #             orientation="h",
+    #             yanchor="bottom",
+    #             y=1.02,
+    #             xanchor="right",
+    #             x=1
+    #         ),
+    #         margin=dict(l=5, r=5, t=5, b=5),
+    #         legend_title_text=None,
+    #         xaxis_title=None,
+    #             yaxis_title=None,
+    #         )
             
-        else:
-            range = [-self.spinBox_grid_radius.value(), self.spinBox_grid_radius.value()]
-            fig.update_layout(legend=dict(
-                orientation="h",
-                yanchor="bottom",
-                y=1.02,
-                xanchor="right",
-                x=1
-            ),
-            margin=dict(l=5, r=5, t=5, b=5),
-            legend_title_text=None,
-            xaxis_title=None,
-            yaxis_title=None,
-            xaxis=dict(range=range),
-            yaxis=dict(range=range)
-            )
-
-        image_from_plot = fig.to_image(format="png", engine="kaleido")
-
-
-        pil_image = Image.open(io.BytesIO(image_from_plot))
-        # Convert the PIL image to a QImage
-        image_qt = QImage(pil_image.tobytes(), pil_image.width, pil_image.height, QImage.Format_RGBA8888)
-        # Convert the QImage to a QPixmap 
-        qpixmap = QPixmap.fromImage(image_qt)
-        self.label_minimap.setPixmap(qpixmap)
+    #     else:
+    #         range = [-self.spinBox_grid_radius.value(), self.spinBox_grid_radius.value()]
+    #         fig.update_layout(legend=dict(
+    #             orientation="h",
+    #             yanchor="bottom",
+    #             y=1.02,
+    #             xanchor="right",
+    #             x=1
+    #         ),
+    #         margin=dict(l=5, r=5, t=5, b=5),
+    #         legend_title_text=None,
+    #         xaxis_title=None,
+    #         yaxis_title=None,
+    #         xaxis=dict(range=range),
+    #         yaxis=dict(range=range)
+    #         )
+
+    #     image_from_plot = fig.to_image(format="png", engine="kaleido")
+
+
+    #     pil_image = Image.open(io.BytesIO(image_from_plot))
+    #     # Convert the PIL image to a QImage
+    #     image_qt = QImage(pil_image.tobytes(), pil_image.width, pil_image.height, QImage.Format_RGBA8888)
+    #     # Convert the QImage to a QPixmap 
+    #     qpixmap = QPixmap.fromImage(image_qt)
+    #     self.label_minimap.setPixmap(qpixmap)
 
 
     def update_ui_after_movement(self):
         # disable taking images after movement here
         if self.checkBox_movement_acquire_electron.isChecked():
             self.image_widget.take_image(BeamType.ELECTRON)
         if self.checkBox_movement_acquire_ion.isChecked():
             self.image_widget.take_image(BeamType.ION)
         self.update_ui()
+    
+    def _stage_position_moved(self, pos: FibsemStagePosition):
+        self.update_ui_after_movement()
+
+
+
+
+    def move_flat_to_beam(self):
+
+        beam_type = BeamType.ION if self.sender() == self.pushButton_move_flat_ion else BeamType.ELECTRON
+
+        self.microscope.move_flat_to_beam(settings=self.settings, beam_type=beam_type)
+
+        self.update_ui_after_movement()
+
+
 
 def main():
 
     viewer = napari.Viewer(ndisplay=2)
     movement_widget = FibsemMovementWidget()
     viewer.window.add_dock_widget(
         movement_widget, area="right", add_vertical_stretch=False
```

## fibsem/ui/FibsemPositionsWidget.py

```diff
@@ -2,15 +2,14 @@
 import os
 import yaml
 from pathlib import Path
 import napari
 import napari.utils.notifications
 import numpy as np
 from PyQt5 import QtWidgets
-from PyQt5.QtCore import QTimer
 from PyQt5.QtGui import QPixmap, QImage
 from copy import deepcopy
 from fibsem import constants, conversions
 from fibsem.microscope import FibsemMicroscope
 from fibsem.structures import (BeamType, FibsemStagePosition,
                                MicroscopeSettings, MovementMode, Point)
 from fibsem.ui.FibsemImageSettingsWidget import FibsemImageSettingsWidget
```

## fibsem/ui/FibsemSystemSetupWidget.py

```diff
@@ -7,18 +7,17 @@
 from PyQt5 import QtWidgets
 from PyQt5.QtCore import pyqtSignal
 
 import fibsem
 from fibsem import config as cfg
 from fibsem import constants, utils
 from fibsem.microscope import FibsemMicroscope
-from fibsem.structures import MicroscopeSettings, StageSettings, FibsemHardware
+from fibsem.structures import MicroscopeSettings, StageSettings, FibsemHardware, BeamSystemSettings, BeamType, ImageSettings, FibsemMillingSettings, SystemSettings
 from fibsem.ui.qtdesigner_files import FibsemSystemSetupWidget
-from fibsem.ui.utils import _get_file_ui
-
+from fibsem.ui.utils import _get_file_ui, _get_save_file_ui
 
 def log_status_message(step: str):
     logging.debug(
         f"STATUS | System Widget | {step}"
     )
 
 
@@ -28,52 +27,139 @@
     disconnected_signal = pyqtSignal()
 
     def __init__(
         self,
         microscope: FibsemMicroscope = None,
         settings: MicroscopeSettings = None,
         viewer: napari.Viewer = None,
+        image_widget: QtWidgets.QWidget = None,
+        milling_widget: QtWidgets.QWidget = None,
         parent=None,
         config_path: str = None,
     ):
         super(FibsemSystemSetupWidget, self).__init__(parent=parent)
         self.setupUi(self)
 
         self.microscope = microscope
         self.settings = settings
         self.viewer = viewer
         self.config_path = config_path  # TODO: allow user to set this
 
-        self.setup_connections()
+        settings_dict = utils.load_yaml(os.path.join(self.config_path))
+        
+        self.auto_connect = False
+        self.apply_settings = False
+        if bool(settings_dict["connect_to_microscope_on_startup"]):
+            self.auto_connect = True
+            self.connect_to_microscope(ip_address=settings_dict["system"]["ip_address"], manufacturer=settings_dict["system"]["manufacturer"])
+
+        self.setup_connections(ip_address=settings_dict["system"]["ip_address"], manufacturer=settings_dict["system"]["manufacturer"])
         self.update_ui()
+        
 
-    def setup_connections(self):
+    def setup_connections(self, ip_address: str, manufacturer: str):
         #
-        self.lineEdit_ipadress.setText(cfg.__DEFAULT_IP_ADDRESS__)
+        self.lineEdit_ipadress.setText(ip_address)
         self.comboBox_manufacturer.addItems(cfg.__SUPPORTED_MANUFACTURERS__)
+        self.comboBox_manufacturer.setCurrentText(manufacturer)
 
         # buttons
         self.microscope_button.clicked.connect(self.connect_to_microscope)
         self.setStage_button.clicked.connect(self.get_stage_settings_from_ui)
-        self.pushButton_save_defaults.clicked.connect(self.save_defaults)
-        self.pushButton_save_model.clicked.connect(self.save_model)
+        self.pushButton_save_yaml.clicked.connect(lambda: self.save_defaults(path=None))
+        self.pushButton_apply_settings.clicked.connect(self.apply_defaults_settings)
+        self.pushButton_import_yaml.clicked.connect(self.import_yaml)
 
         #checkboxes
         self.checkBox_eb.stateChanged.connect(self.get_model_from_ui)
         self.checkBox_ib.stateChanged.connect(self.get_model_from_ui)
+        self.checkBox_select_plasma_gas.stateChanged.connect(self.get_model_from_ui)
         self.checkBox_stage_enabled.stateChanged.connect(self.get_model_from_ui)
         self.checkBox_stage_rotation.stateChanged.connect(self.get_model_from_ui)
         self.checkBox_stage_tilt.stateChanged.connect(self.get_model_from_ui)
         self.checkBox_needle_enabled.stateChanged.connect(self.get_model_from_ui)
         self.checkBox_needle_rotation.stateChanged.connect(self.get_model_from_ui)
         self.checkBox_needle_tilt.stateChanged.connect(self.get_model_from_ui)
         self.checkBox_gis_enabled.stateChanged.connect(self.get_model_from_ui)
         self.checkBox_multichem.stateChanged.connect(self.get_model_from_ui)
 
-    def save_defaults(self):
+    def import_yaml(self):
+        path = _get_file_ui(msg="Select system file", path=cfg.CONFIG_PATH)
+        if path == "":
+            return
+        self.settings = utils.load_settings_from_config(path)
+        self.set_defaults_to_ui()
+        self.set_stage_settings_to_ui(self.settings.system.stage)
+        self.set_model_to_ui(self.settings.hardware)
+
+    def get_default_settings_from_ui(self):
+        microscope_settings = MicroscopeSettings(
+            system=SystemSettings(
+                ip_address=self.lineEdit_ipadress.text(),
+                manufacturer=self.comboBox_manufacturer.currentText(),
+                stage=StageSettings(
+                    rotation_flat_to_electron=self.rotationFlatToElectronSpinBox.value(),
+                    rotation_flat_to_ion=self.rotationFlatToIonSpinBox.value(),
+                    tilt_flat_to_electron=self.tiltFlatToElectronSpinBox.value(),
+                    tilt_flat_to_ion=self.tiltFlatToIonSpinBox.value(),
+                    pre_tilt=self.preTiltSpinBox.value(),
+                    needle_stage_height_limit=self.needleStageHeightLimitnMmDoubleSpinBox.value(),                    
+                ),
+                ion=BeamSystemSettings(
+                    beam_type=BeamType.ION,
+                    voltage=self.spinBox_ion_voltage.value(),
+                    current=self.doubleSpinBox_ion_current.value() * constants.NANO_TO_SI,
+                    plasma_gas=self.lineEdit_plasma_gas.text().capitalize(),
+                    eucentric_height=self.doubleSpinBox_height_ion.value(),
+                    detector_type=self.lineEdit_detector_type_ion.text(),
+                    detector_mode=self.lineEdit_detector_mode_ion.text(),
+                ),
+                electron=BeamSystemSettings(
+                    beam_type=BeamType.ELECTRON,
+                    voltage=self.spinBox_voltage_eb.value(),
+                    current=self.doubleSpinBox_current_eb.value() * constants.NANO_TO_SI,
+                    eucentric_height=self.doubleSpinBox_height_eb.value(),
+                    detector_type=self.lineEdit_detector_type_eb.text(),
+                    detector_mode=self.lineEdit_detector_mode_eb.text(),
+                ),
+            ),
+            image=ImageSettings(
+                resolution=[self.spinBox_res_width.value(), self.spinBox_res_height.value()],
+                dwell_time=self.doubleSpinBox_dwell_time_imaging.value()*constants.MICRO_TO_SI,
+                hfw=self.spinBox_hfw.value()*constants.MICRO_TO_SI,
+                beam_type = BeamType[self.lineEdit_beam_type.text().upper()],
+                autocontrast=self.checkBox_autocontrast.isChecked(),
+                save=self.checkBox_save.isChecked(),
+                gamma_enabled=self.checkBox_gamma.isChecked(),
+            ),
+            milling=FibsemMillingSettings(
+                dwell_time=self.doubleSpinBox_dwell_time_milling.value()*constants.MICRO_TO_SI,
+                rate=self.doubleSpinBox_rate.value()*constants.NANO_TO_SI,
+                spot_size=self.doubleSpinBox_spotsize.value()*constants.MICRO_TO_SI,
+                milling_current=self.doubleSpinBox_milling_current.value()*constants.NANO_TO_SI,
+            ),
+            hardware=self.get_model_from_ui(),
+        )
+
+        return microscope_settings
+
+    def apply_defaults_settings(self):
+        microscope_settings = self.get_default_settings_from_ui()
+
+        self.microscope.set_beam_settings(microscope_settings.system.ion)
+        self.microscope.set_beam_settings(microscope_settings.system.electron)
+        
+        self.image_widget.set_ui_from_settings(microscope_settings.image, beam_type=microscope_settings.image.beam_type)
+
+        self.get_stage_settings_from_ui()
+        self.get_model_from_ui()
+        self.milling_widget.set_milling_settings_ui(microscope_settings.milling)
+
+
+    def save_defaults(self, path: str = None):
         system_dict = {}
         system_dict["system"] = {}
         system_dict["user"] = {}
         system_dict["system"]["ion"] = {}
         system_dict["system"]["electron"] = {}
         system_dict["system"]["stage"] = {}
         system_dict["user"]["milling"] = {}
@@ -89,42 +175,59 @@
         system_dict["system"]["ion"]["detector_mode"] = self.lineEdit_detector_mode_ion.text()
         system_dict["system"]["electron"]["voltage"] = self.spinBox_voltage_eb.value()
         system_dict["system"]["electron"]["current"] = self.doubleSpinBox_current_eb.value() * constants.NANO_TO_SI
         system_dict["system"]["electron"]["eucentric_height"] = self.doubleSpinBox_height_eb.value()
         system_dict["system"]["electron"]["detector_type"] = self.lineEdit_detector_type_eb.text()
         system_dict["system"]["electron"]["detector_mode"] = self.lineEdit_detector_mode_eb.text()
 
-        system_dict["system"]["stage"]["rotation_flat_to_electron"] = self.spinBox_rotation_eb.value()
-        system_dict["system"]["stage"]["rotation_flat_to_ion"] = self.spinBox_rotation_ib.value()
-        system_dict["system"]["stage"]["tilt_flat_to_electron"] = self.spinBox_tilt_eb.value()
-        system_dict["system"]["stage"]["tilt_flat_to_ion"] = self.spinBox_tilt_ib.value()
-        system_dict["system"]["stage"]["pre_tilt"] = self.spinBox_pretilt.value()
-        system_dict["system"]["stage"]["needle_stage_height_limit"] = self.doubleSpinBox_needle_height.value()
+        system_dict["system"]["stage"]["rotation_flat_to_electron"] = self.rotationFlatToElectronSpinBox.value()
+        system_dict["system"]["stage"]["rotation_flat_to_ion"] = self.rotationFlatToIonSpinBox.value()
+        system_dict["system"]["stage"]["tilt_flat_to_electron"] = self.tiltFlatToElectronSpinBox.value()
+        system_dict["system"]["stage"]["tilt_flat_to_ion"] = self.tiltFlatToIonSpinBox.value()
+        system_dict["system"]["stage"]["pre_tilt"] = self.preTiltSpinBox.value()
+        system_dict["system"]["stage"]["needle_stage_height_limit"] = self.needleStageHeightLimitnMmDoubleSpinBox.value()*constants.MILLIMETRE_TO_METRE
 
         system_dict["user"]["milling"]["milling_current"] = self.doubleSpinBox_milling_current.value()*constants.NANO_TO_SI
         system_dict["user"]["milling"]["spot_size"] = self.doubleSpinBox_spotsize.value()*constants.NANO_TO_SI
         system_dict["user"]["milling"]["rate"] = self.doubleSpinBox_rate.value()*constants.NANO_TO_SI
         system_dict["user"]["milling"]["dwell_time"] = self.doubleSpinBox_dwell_time_milling.value()*constants.MICRO_TO_SI
     
         system_dict["user"]["imaging"]["imaging_current"] = self.doubleSpinBox_imaging_current.value()*constants.NANO_TO_SI
         system_dict["user"]["imaging"]["resolution"] = [self.spinBox_res_width.value(), self.spinBox_res_height.value()]
         system_dict["user"]["imaging"]["hfw"] = self.spinBox_hfw.value()*constants.MICRO_TO_SI
         system_dict["user"]["imaging"]["beam_type"] = self.lineEdit_beam_type.text()
         system_dict["user"]["imaging"]["autocontrast"] = self.checkBox_autocontrast.isChecked()
         system_dict["user"]["imaging"]["dwell_time"] = self.doubleSpinBox_dwell_time_imaging.value()*constants.MICRO_TO_SI
         system_dict["user"]["imaging"]["save"] = self.checkBox_save.isChecked()
         system_dict["user"]["imaging"]["gamma"] = self.checkBox_gamma.isChecked()
+
+        hardware_settings = self.get_model_from_ui()
+        system_dict["model"] = hardware_settings.__to_dict__()
+ 
+        system_dict["system"]["name"] = self.microscope.model
+        system_dict["system"]["manufacturer"] = self.comboBox_manufacturer.currentText()
+        system_dict["system"]["version"] = fibsem.__version__
+        from PyQt5.QtWidgets import QInputDialog
+        system_dict["system"]["id"] = QInputDialog.getText(self, "Microscope ID", "Please enter ID of microscope")[0]
+        system_dict["system"]["description"] = QInputDialog.getText(self, "Description", "Please enter system description")[0]
     
-        protocol_path = _get_file_ui(msg="Select protocol file")
-        if protocol_path == '':
-            return
-        with open(os.path.join(protocol_path), "w") as f:
-            yaml.safe_dump(system_dict, f, indent=4)
+        system_dict["connect_to_microscope_on_startup"] = bool(self.checkBox_connect_automatically.isChecked())
+        system_dict["apply_settings_on_startup"] = bool(self.checkBox_apply_settings.isChecked())
 
-        logging.info("Protocol saved to file")
+        if path is None:
+            path = _get_save_file_ui(msg="Save system file", path=cfg.CONFIG_PATH)
+        
+        if path == '':
+            napari.utils.notifications.show_info(f"No file selected. System configuration not saved.")
+            return
+        
+        utils.save_yaml(path=path, data=system_dict)
+        
+        napari.utils.notifications.show_info(f"System configuration saved to {os.path.basename(path)}")
+        logging.info(f"System configuration saved to {os.path.basename(path)}")
 
     def set_defaults_to_ui(self):
         self.lineEdit_ipadress.setText(self.settings.system.ip_address)
         self.comboBox_manufacturer.setCurrentText( self.settings.system.manufacturer )
         self.spinBox_ion_voltage.setValue( self.settings.system.ion.voltage )
         self.doubleSpinBox_ion_current.setValue( self.settings.system.ion.current * constants.SI_TO_NANO )
         self.lineEdit_plasma_gas.setText( self.settings.system.ion.plasma_gas )
@@ -133,20 +236,20 @@
         self.lineEdit_detector_mode_ion.setText( self.settings.system.ion.detector_mode )
         self.spinBox_voltage_eb.setValue( self.settings.system.electron.voltage )
         self.doubleSpinBox_current_eb.setValue( self.settings.system.electron.current * constants.SI_TO_NANO)
         self.doubleSpinBox_height_eb.setValue( self.settings.system.electron.eucentric_height )
         self.lineEdit_detector_type_eb.setText( self.settings.system.electron.detector_type )
         self.lineEdit_detector_mode_eb.setText( self.settings.system.electron.detector_mode )
 
-        self.spinBox_rotation_eb.setValue( self.settings.system.stage.rotation_flat_to_electron )
-        self.spinBox_rotation_ib.setValue( self.settings.system.stage.rotation_flat_to_ion )
-        self.spinBox_tilt_eb.setValue( self.settings.system.stage.tilt_flat_to_electron )
-        self.spinBox_tilt_ib.setValue( self.settings.system.stage.tilt_flat_to_ion )
-        self.spinBox_pretilt.setValue( self.settings.system.stage.pre_tilt )
-        self.doubleSpinBox_needle_height.setValue( self.settings.system.stage.needle_stage_height_limit )
+        self.rotationFlatToElectronSpinBox.setValue( self.settings.system.stage.rotation_flat_to_electron )
+        self.rotationFlatToIonSpinBox.setValue( self.settings.system.stage.rotation_flat_to_ion )
+        self.tiltFlatToElectronSpinBox.setValue( self.settings.system.stage.tilt_flat_to_electron )
+        self.tiltFlatToIonSpinBox.setValue( self.settings.system.stage.tilt_flat_to_ion )
+        self.preTiltSpinBox.setValue( self.settings.system.stage.pre_tilt )
+        self.needleStageHeightLimitnMmDoubleSpinBox.setValue( self.settings.system.stage.needle_stage_height_limit * constants.METRE_TO_MILLIMETRE )
 
         self.doubleSpinBox_milling_current.setValue( self.settings.milling.milling_current *constants.SI_TO_NANO )
         self.doubleSpinBox_spotsize.setValue( self.settings.milling.spot_size *constants.SI_TO_NANO )
         self.doubleSpinBox_rate.setValue( self.settings.milling.rate *constants.SI_TO_NANO )
         self.doubleSpinBox_dwell_time_milling.setValue( self.settings.milling.dwell_time *constants.SI_TO_MICRO )
     
         self.doubleSpinBox_imaging_current.setValue( 20.e-12 * constants.SI_TO_NANO )
@@ -155,14 +258,17 @@
         self.spinBox_hfw.setValue( int(self.settings.image.hfw *constants.SI_TO_MICRO) )
         self.lineEdit_beam_type.setText( self.settings.image.beam_type.name )
         self.checkBox_autocontrast.setCheckState( self.settings.image.autocontrast )
         self.doubleSpinBox_dwell_time_imaging.setValue( self.settings.image.dwell_time *constants.SI_TO_MICRO )
         self.checkBox_save.setCheckState( self.settings.image.save )
         self.checkBox_gamma.setCheckState( self.settings.image.gamma_enabled )
 
+        self.checkBox_connect_automatically.setCheckState( self.auto_connect)
+        self.checkBox_apply_settings.setCheckState( self.apply_settings)
+
     def get_stage_settings_from_ui(self):
         if self.microscope is None:
             return
         self.settings.system.stage.needle_stage_height_limit = (
             self.needleStageHeightLimitnMmDoubleSpinBox.value()
             * constants.MILLIMETRE_TO_METRE
         )
@@ -190,120 +296,107 @@
         )
         self.rotationFlatToIonSpinBox.setValue(stage_settings.rotation_flat_to_ion)
         self.preTiltSpinBox.setValue(stage_settings.pre_tilt)
 
     def set_model_to_ui(self, hardware_settings: FibsemHardware) -> None:
         self.checkBox_eb.setChecked(hardware_settings.electron_beam)
         self.checkBox_ib.setChecked(hardware_settings.ion_beam)
+        self.checkBox_select_plasma_gas.setChecked(hardware_settings.can_select_plasma_gas)
         self.checkBox_stage_enabled.setChecked(hardware_settings.stage_enabled)
         self.checkBox_stage_rotation.setChecked(hardware_settings.stage_rotation)
         self.checkBox_stage_tilt.setChecked(hardware_settings.stage_tilt)
         self.checkBox_needle_enabled.setChecked(hardware_settings.manipulator_enabled)
         self.checkBox_needle_rotation.setChecked(hardware_settings.manipulator_rotation)
         self.checkBox_needle_tilt.setChecked(hardware_settings.manipulator_tilt)
         self.checkBox_gis_enabled.setChecked(hardware_settings.gis_enabled)
         self.checkBox_multichem.setChecked(hardware_settings.gis_multichem)
 
     def get_model_from_ui(self) -> FibsemHardware:
         hardware_settings = FibsemHardware()
         hardware_settings.electron_beam = self.checkBox_eb.isChecked()
         hardware_settings.ion_beam = self.checkBox_ib.isChecked()
+        hardware_settings.can_select_plasma_gas = self.checkBox_select_plasma_gas.isChecked()
         hardware_settings.stage_rotation = self.checkBox_stage_rotation.isChecked()
         hardware_settings.stage_tilt = self.checkBox_stage_tilt.isChecked()
         hardware_settings.manipulator_enabled = self.checkBox_needle_enabled.isChecked()
         hardware_settings.manipulator_rotation = self.checkBox_needle_rotation.isChecked()
         hardware_settings.manipulator_tilt = self.checkBox_needle_tilt.isChecked()
         hardware_settings.gis_enabled = self.checkBox_gis_enabled.isChecked()
         hardware_settings.gis_multichem = self.checkBox_multichem.isChecked()
         hardware_settings.manipulator_positions = self.settings.hardware.manipulator_positions
-        hardware_settings.system = self.settings.hardware.system
 
         self.settings.hardware = hardware_settings
         self.microscope.hardware_settings = hardware_settings
-        logging.info(f"Updated hardware settings: {hardware_settings}")
+        logging.debug(f"Updated hardware settings: {hardware_settings}")
         return hardware_settings
 
-    def save_model(self) -> None:
-        hardware_settings = self.get_model_from_ui()
-
-        hardware_dict = hardware_settings.__to_dict__()
-        hardware_dict["system"] = {}
-        hardware_dict["system"]["name"] = self.microscope.model
-        hardware_dict["system"]["manufacturer"] = self.comboBox_manufacturer.currentText()
-        hardware_dict["system"]["version"] = fibsem.__version__
-        from PyQt5.QtWidgets import QInputDialog
-        hardware_dict["system"]["id"] = QInputDialog.getText(self, "Microscope ID", "Please enter ID of microscope")[0]
-        hardware_dict["system"]["description"] = QInputDialog.getText(self, "Description", "Please enter system description")[0]
-        from fibsem import config as cfg
-        protocol_path = os.path.join(cfg.BASE_PATH, "fibsem", "config", "model.yaml")
-        with open(os.path.join(protocol_path), "w") as f:
-            yaml.safe_dump(hardware_dict, f, indent=4)
-
-        logging.info("Model saved to file")
 
+    def connect(self, ip_address: str = None, manufacturer: str = None) -> None:
 
-    def connect(self):
-        if self.lineEdit_ipadress.text() == "":
-            napari.utils.notifications.show_error(
-                f"IP address not set. Please enter an IP address before connecting to microscope."
-            )
-            return
+        if not isinstance(ip_address, str):
+            if self.lineEdit_ipadress.text() == "":
+                napari.utils.notifications.show_error(
+                    f"IP address not set. Please enter an IP address before connecting to microscope."
+                )
+                return
+            else:
+                ip_address = self.lineEdit_ipadress.text() 
 
         try:
             log_status_message("CONNECTING")
-            ip_address = self.lineEdit_ipadress.text()
-            manufacturer = self.comboBox_manufacturer.currentText()
+            
+            manufacturer = self.comboBox_manufacturer.currentText() if manufacturer is None else manufacturer
             # user notification
             msg = f"Connecting to microscope at {ip_address}"
             logging.info(msg)
             napari.utils.notifications.show_info(msg)
 
             # connect
             self.microscope, self.settings = utils.setup_session(
                 ip_address=ip_address,
                 manufacturer=manufacturer,
                 config_path=self.config_path,
             )
 
             # user notification
             msg = f"Connected to microscope at {ip_address}"
-            log_status_message("CONNECTED_AT_" + ip_address)
+            log_status_message(f"CONNECTED_AT_{ip_address}")
             logging.info(msg)
             napari.utils.notifications.show_info(msg)
             # self.connected_signal.emit()
             self.set_defaults_to_ui()
 
         except Exception as e:
             msg = f"Unable to connect to the microscope: {traceback.format_exc()}"
             logging.error(msg)
             log_status_message(F"CONNECTION_FAILED_{traceback.format_exc()}")
             napari.utils.notifications.show_error(msg)
 
-    def connect_to_microscope(self):
+    def connect_to_microscope(self, ip_address: str = None, manufacturer: str = None):
 
         _microscope_connected = bool(self.microscope)
 
         if _microscope_connected:
             self.microscope.disconnect()
             self.microscope, self.settings = None, None
         else:
-            self.connect()
+            self.connect(ip_address, manufacturer )
 
         self.update_ui()
 
     def update_ui(self):
 
         _microscope_connected = bool(self.microscope)
 
         self.setStage_button.setEnabled(_microscope_connected)
 
         if _microscope_connected:
             self.microscope_button.setText("Microscope Connected")
             self.microscope_button.setStyleSheet("background-color: green")
-            self.set_stage_settings_to_ui(self.settings.system.stage)
+            self.set_stage_settings_to_ui(self.microscope.stage_settings)
             self.set_model_to_ui(self.settings.hardware)
             self.connected_signal.emit()
 
         else:
             self.microscope_button.setText("Connect To Microscope")
             self.microscope_button.setStyleSheet("background-color: gray")
             self.disconnected_signal.emit()
```

## fibsem/ui/FibsemUI.py

```diff
@@ -4,35 +4,32 @@
 import fibsem
 import napari.utils.notifications
 from fibsem import utils
 from fibsem.ui.FibsemImageSettingsWidget import FibsemImageSettingsWidget
 from fibsem.ui.FibsemAlignmentWidget import FibsemAlignmentWidget
 from fibsem.ui.FibsemMillingWidget import FibsemMillingWidget
 from fibsem.ui.FibsemMovementWidget import FibsemMovementWidget
-
 from fibsem.ui.FibsemManipulatorWidget import FibsemManipulatorWidget
 from fibsem.ui.FibsemGISWidget import FibsemGISWidget
-
 from fibsem.ui.FibsemSystemSetupWidget import FibsemSystemSetupWidget
 
-from fibsem.ui.FibsemPositionsWidget import FibsemPositionsWidget
-
 from napari.qt.threading import thread_worker
 from PyQt5 import QtWidgets
-from PyQt5 import QtCore
-from PyQt5.QtWidgets import QMessageBox
 from fibsem import config as cfg
 
-
+from PyQt5.QtWidgets import QMessageBox
 from fibsem.microscope import FibsemMicroscope, MicroscopeSettings, ThermoMicroscope, DemoMicroscope, TescanMicroscope
 from fibsem.ui.qtdesigner_files import FibsemUI
 from fibsem.structures import BeamType
-
+from fibsem.ui.FibsemMinimapWidget import FibsemMinimapWidget
+from fibsem.utils import load_yaml
+from fibsem.ui.utils import message_box_ui
 
 class FibsemUI(FibsemUI.Ui_MainWindow, QtWidgets.QMainWindow):
+
     def __init__(self, viewer: napari.Viewer):
         super(FibsemUI, self).__init__()
         self.setupUi(self)
 
         self.viewer = viewer
         self.viewer.window._qt_viewer.dockLayerList.setVisible(False)
         self.viewer.window._qt_viewer.dockLayerControls.setVisible(False)
@@ -42,40 +39,105 @@
 
         self.image_widget: FibsemImageSettingsWidget = None
         self.movement_widget: FibsemMovementWidget = None
         self.milling_widget: FibsemMillingWidget = None
         self.alignment_widget: FibsemAlignmentWidget = None
         self.manipulator_widget: FibsemManipulatorWidget = None
 
-
-        CONFIG_PATH = os.path.join(cfg.CONFIG_PATH)
         self.system_widget = FibsemSystemSetupWidget(
                 microscope=self.microscope,
                 settings=self.settings,
                 viewer=self.viewer,
-                config_path = CONFIG_PATH,
+                config_path = cfg.SYSTEM_PATH,
             )
         
-        self.setup_connections()
         self.tabWidget.addTab(self.system_widget, "System")
+        self.setup_connections()
         self.ref_current = None
         self.update_ui()
 
 
     def setup_connections(self):
 
         self.system_widget.set_stage_signal.connect(self.set_stage_parameters)
         self.system_widget.connected_signal.connect(self.connect_to_microscope)
         self.system_widget.disconnected_signal.connect(self.disconnect_from_microscope)
         self.actionCurrent_alignment.triggered.connect(self.align_currents)
         self.actionManipulator_Positions_Calibration.triggered.connect(self.calibrate_manipulator_positions)
+        if self.system_widget.microscope is not None:
+            self.connect_to_microscope()
+            settings_dict = utils.load_yaml(cfg.SYSTEM_PATH)
+            if bool(settings_dict["apply_settings_on_startup"]):
+                self.system_widget.apply_settings = True
+                self.system_widget.apply_defaults_settings() 
+        self.actionOpen_Minimap.triggered.connect(self._open_minimap)
+
+    def _open_minimap(self):
+        if self.microscope is None:
+            napari.utils.notifications.show_warning(f"Please connect to a microscope first... [No Microscope Connected]")
+            return
+
+        if self.movement_widget is None:
+            napari.utils.notifications.show_warning(f"Please connect to a microscope first... [No Movement Widget]")
+            return
+
+        # TODO: need to register this with the main ui somehow
+        self.viewer2 = napari.Viewer(ndisplay=2)
+        self.minimap_widget = FibsemMinimapWidget(self.microscope, self.settings, viewer=self.viewer2, parent=self)
+        self.viewer2.window.add_dock_widget(
+            self.minimap_widget, area="right", add_vertical_stretch=False, name="OpenFIBSEM Minimap"
+        )
+        self.minimap_widget._stage_position_moved.connect(self.movement_widget._stage_position_moved)
+        napari.run(max_loop_level=2)
+
 
     def calibrate_manipulator_positions(self):
 
-        self.manipulator_widget.manipulator_position_calibration(config_path =os.path.join(cfg.CONFIG_PATH) )
+        if not isinstance(self.microscope,TescanMicroscope):
+            message_box_ui(title="Not Available", text="Manipulator Position Calibration is only available for Tescan Microscopes", buttons=QMessageBox.Ok)
+            return
+
+        response = self.manipulator_widget._check_manipulator_positions_setup()
+
+        if not response:
+            
+            ok_to_cal =message_box_ui(title="Manipulator Position calibration",text="This tool calibrates the positions of the manipulator, it will switch between the parking, standby and working positions rapidly, please ensure it is safe to do so. If not please click no, otherwise press yes to continue")
+                                      
+            if ok_to_cal:
+
+                positions = self.settings.hardware.manipulator_positions
+
+                for position in positions:
+                    if position == "calibrated":
+                        continue
+                    logging.info(f"Calibrating Manipulator {position} position")
+                    self.microscope.insert_manipulator(position)
+                    manipulator_loc = self.microscope.get_manipulator_position()
+                    positions[position]["x"] = manipulator_loc.x
+                    positions[position]["y"] = manipulator_loc.y
+                    positions[position]["z"] = manipulator_loc.z
+                
+                positions["calibrated"] = True
+                self.settings.hardware.manipulator_positions = positions
+                self.system_widget.settings = self.settings
+                self.system_widget.save_defaults(path = cfg.SYSTEM_PATH)
+
+                message_box_ui(title="Manipulator Position calibration",text="Manipulator Positions calibrated successfully", buttons=QMessageBox.Ok)
+
+                
+                self.manipulator_widget.insertManipulator_button.setEnabled(True)
+                self.manipulator_widget.moveRelative_button.setEnabled(True)
+                self.manipulator_widget.addSavedPosition_button.setEnabled(True)
+                self.manipulator_widget.goToPosition_button.setEnabled(True)
+                self.manipulator_widget.manipulator_inserted = self.manipulator_widget.microscope.get_manipulator_state(settings=self.manipulator_widget.settings)
+                self.manipulator_widget._hide_show_buttons(show=self.manipulator_widget.manipulator_inserted)
+                self.manipulator_widget.manipulatorStatus_label.setText("Manipulator Status: Inserted" if self.manipulator_widget.manipulator_inserted else "Manipulator Status: Retracted")
+                self.manipulator_widget.insertManipulator_button.setText("Insert" if not self.manipulator_widget.manipulator_inserted else "Retract")
+                self.manipulator_widget.calibrated_status_label.setText("Calibrated")
+                self.manipulator_widget.settings = self.settings
 
     def align_currents(self):
         second_viewer = napari.Viewer()
         self.alignment_widget = FibsemAlignmentWidget(settings=self.settings, microscope=self.microscope, viewer=second_viewer, parent = self)
         second_viewer.window.add_dock_widget(self.alignment_widget, name='Beam Alignment', area='right')
         self.alignment_widget.destroyed.connect(self.reset_currents)
 
@@ -86,24 +148,28 @@
             self.microscope.set("preset", self.ref_current, BeamType.ION)
 
     def set_stage_parameters(self):
         if self.microscope is None:
             return
         self.settings.system.stage = self.system_widget.settings.system.stage  
         self.movement_widget.settings = self.settings
+        self.microscope.stage_settings = self.settings.system.stage
         logging.debug(f"Stage parameters set to {self.settings.system.stage}")
         logging.info("Stage parameters set")  
 
     def update_ui(self):
 
         _microscope_connected = bool(self.microscope is not None)
         self.tabWidget.setTabVisible(1, _microscope_connected)
         self.tabWidget.setTabVisible(2, _microscope_connected)
         self.tabWidget.setTabVisible(3, _microscope_connected)
         self.tabWidget.setTabVisible(4, _microscope_connected)
+        self.actionOpen_Minimap.setVisible(_microscope_connected)
+        self.actionCurrent_alignment.setVisible(_microscope_connected)
+        self.actionManipulator_Positions_Calibration.setVisible(_microscope_connected)
 
 
     def connect_to_microscope(self):
         self.microscope = self.system_widget.microscope
         self.settings = self.system_widget.settings
         self.update_microscope_ui()
         self.update_ui()
@@ -135,34 +201,45 @@
             )
             self.milling_widget = FibsemMillingWidget(
                 microscope=self.microscope,
                 settings=self.settings,
                 viewer=self.viewer,
                 image_widget=self.image_widget,
             )
-            self.manipulator_widget = FibsemManipulatorWidget(
-                microscope=self.microscope,
-                settings=self.settings,
-                viewer=self.viewer,
-                image_widget=self.image_widget,
-            )
-            self.GIS_widget = FibsemGISWidget(
-                microscope=self.microscope,
-                settings=self.settings,
-                viewer=self.viewer,
-                image_widget=self.image_widget,
-            )
+            if self.microscope.hardware_settings.manipulator_enabled:
+                self.manipulator_widget = FibsemManipulatorWidget(
+                    microscope=self.microscope,
+                    settings=self.settings,
+                    viewer=self.viewer,
+                    image_widget=self.image_widget,
+                )
+            else:
+                self.manipulator_widget = None
+            if self.microscope.hardware_settings.gis_enabled:
+                self.GIS_widget = FibsemGISWidget(
+                    microscope=self.microscope,
+                    settings=self.settings,
+                    viewer=self.viewer,
+                    image_widget=self.image_widget,
+                )
+            else:
+                self.GIS_widget = None
 
 
             # add widgets to tabs
             self.tabWidget.addTab(self.image_widget, "Image")
             self.tabWidget.addTab(self.movement_widget, "Movement")
             self.tabWidget.addTab(self.milling_widget, "Milling")
-            self.tabWidget.addTab(self.manipulator_widget, "Manipulator")
-            self.tabWidget.addTab(self.GIS_widget, "GIS")
+
+            if self.microscope.hardware_settings.manipulator_enabled:
+                self.tabWidget.addTab(self.manipulator_widget, "Manipulator")
+            if self.microscope.hardware_settings.gis_enabled:
+                self.tabWidget.addTab(self.GIS_widget, "GIS")
+            self.system_widget.image_widget = self.image_widget
+            self.system_widget.milling_widget = self.milling_widget
 
 
 
         else:
             if self.image_widget is None:
                 return
             
@@ -172,16 +249,18 @@
             self.tabWidget.removeTab(3)
             self.tabWidget.removeTab(2)
             self.tabWidget.removeTab(1)
             self.image_widget.clear_viewer()
             self.image_widget.deleteLater()
             self.movement_widget.deleteLater()
             self.milling_widget.deleteLater()
-            self.manipulator_widget.deleteLater()
-            self.GIS_widget.deleteLater()
+            if self.manipulator_widget is not None:
+                self.manipulator_widget.deleteLater() 
+            if self.GIS_widget is not None:
+                self.GIS_widget.deleteLater()
 
 
 def main():
 
     viewer = napari.Viewer(ndisplay=2)
     fibsem_ui = FibsemUI(viewer=viewer)
     viewer.window.add_dock_widget(fibsem_ui,
```

## fibsem/ui/utils.py

```diff
@@ -10,15 +10,15 @@
 from fibsem.config import load_microscope_manufacturer
 from fibsem import constants
 from fibsem.structures import Point, FibsemImage, FibsemPatternSettings, FibsemPattern
 from matplotlib.backends.backend_qt5agg import FigureCanvasQTAgg
 from matplotlib.figure import Figure
 from matplotlib.patches import Rectangle
 from PyQt5.QtWidgets import QMessageBox, QSizePolicy, QVBoxLayout, QWidget
-
+from fibsem.patterning import FibsemMillingStage
 import napari
 
 # # TODO: clean up and refactor these (_WidgetPlot and _PlotCanvas)
 # class _WidgetPlot(QWidget):
 #     def __init__(self, *args, display_image, **kwargs):
 #         QWidget.__init__(self, *args, **kwargs)
 #         self.setLayout(QVBoxLayout())
@@ -273,15 +273,15 @@
     pattern_centre_y = centre_point.y
 
     cx = int(icx + (pattern_centre_x / pixelsize_y))
     cy = int(icy - (pattern_centre_y / pixelsize_y))
 
     r_angles = [0,np.deg2rad(90)] #
     w = 40
-    h = 5
+    h = 3
     crosshair_shapes = []
 
     for r in r_angles:
         xmin, xmax = -w / 2, w / 2
         ymin, ymax = -h / 2, h / 2
         px0 = cx + (xmin * np.cos(r) - ymin * np.sin(r))
         py0 = cy + (xmin * np.sin(r) + ymin * np.cos(r))
@@ -366,60 +366,65 @@
     X, Y = np.meshgrid(x, y)
     distance = np.sqrt(X**2 + Y**2)
     # Generate the donut shape
     donut = np.logical_and(distance < outer_radius, distance > inner_radius).astype(int)
     return donut
 
 
-def _remove_all_layers(viewer: napari.Viewer, layer_type = napari.layers.shapes.shapes.Shapes):
+def _remove_all_layers(viewer: napari.Viewer, layer_type = napari.layers.shapes.shapes.Shapes, _ignore: list[str] = []):
 
     # remove all shapes layers
     layers_to_remove = []
-    layers_to_ignore = ["ruler_line","crosshair","scalebar","scalebar_value"]
+    layers_to_ignore = ["ruler_line","crosshair","scalebar","scalebar_value"] + _ignore
     for layer in viewer.layers:
 
         if layer.name in layers_to_ignore:
             continue
         if isinstance(layer, layer_type) or layer.name in ["bmp_Image","annulus_Image"]:
             layers_to_remove.append(layer)
     for layer in layers_to_remove:
         viewer.layers.remove(layer)  # Not removing the second layer?
 
 
 def _draw_patterns_in_napari(
     viewer: napari.Viewer,
     ib_image: FibsemImage,
     eb_image: FibsemImage,
-    all_patterns: list[FibsemPatternSettings],
-    stage_centres: list[Point] = None,
+    milling_stages: list[FibsemMillingStage],
 ):
-    _remove_all_layers(viewer=viewer, layer_type=napari.layers.shapes.shapes.Shapes)
 
     # colour wheel
-    # colour = ["orange", "yellow", "red", "green", "purple"]
-    colour = ["yellow", "cyan", "magenta", "lime", "orange"]
+    COLOURS = ["yellow", "cyan", "magenta", "lime", "orange", "hotpink", "green", "blue", "red", "purple"]
     from fibsem.structures import FibsemPattern
 
     # convert fibsem patterns to napari shapes
+    import time
 
-    for i, stage in enumerate(all_patterns):
+    t_1 = time.time()
+    for i, stage in enumerate(milling_stages):
         shape_patterns = []
         shape_types = []
-        for pattern_settings in stage:
+        t0 = time.time()
+
+        patterns = stage.pattern.patterns
+        point = stage.pattern.point
+        name = stage.name
+
+        for pattern_settings in patterns:
             if pattern_settings.pattern is FibsemPattern.Bitmap:
                 if pattern_settings.path == None or pattern_settings.path == '':
                     continue
 
                 bmp_Image, translate_position = convert_bitmap_pattern_to_napari_image(pattern_settings=pattern_settings, image=ib_image)
                 viewer.add_image(bmp_Image,translate=translate_position,name="bmp_Image")
                 shape_patterns = []
                 continue
             elif pattern_settings.pattern is FibsemPattern.Annulus:
                 annulus_image, translate_position = convert_pattern_to_napari_image(pattern_settings=pattern_settings, image=ib_image)
-                viewer.add_image(annulus_image,translate=translate_position,name="annulus_Image",blending="additive",colormap=colour[i % 5],opacity=0.4)
+                viewer.add_image(annulus_image,translate=translate_position,name="annulus_Image",blending="additive",colormap=COLOURS[i % len(COLOURS)],opacity=0.4)
                 shape_patterns = []
                 continue
 
             elif pattern_settings.pattern is FibsemPattern.Circle:
                 shape = convert_pattern_to_napari_circle(pattern_settings=pattern_settings, image=ib_image)
 
                 shape_types.append("ellipse")
@@ -430,43 +435,50 @@
                 shape_types.append("rectangle")
 
             # offset the x coord by image width
             if eb_image is not None:
                 for c in shape:
                     c[1] += eb_image.data.shape[1]
             shape_patterns.append(shape)
-
-
-        if len(shape_patterns) > 0:    
-            viewer.add_shapes(
-                shape_patterns,
-                name=f"Stage {i+1}",
-                shape_type=shape_types,
-                edge_width=0.5,
-                edge_color=colour[i % 5],
-                face_color=colour[i % 5],
-                opacity=0.5,
-                blending="translucent",
-            )
         
-        if stage_centres is not None:
-            crosshair_point = stage_centres[i]
+        t1 = time.time()
 
-            crosshair_shapes = create_crosshair_shape(centre_point=crosshair_point, image=ib_image, eb_image=eb_image)
-            viewer.add_shapes(
-                crosshair_shapes,
-                name="pattern_crosshair",
-                shape_type=["rectangle","rectangle"],
-                edge_width=0.5,
-                edge_color=colour[i % 5],
-                face_color=colour[i % 5],
-                opacity=0.5,
-                blending="translucent",
-            )
+        if len(shape_patterns) > 0:
+            
+            crosshair_shapes = create_crosshair_shape(centre_point=point, image=ib_image, eb_image=eb_image)
+            crosshair_shape_types = ["rectangle","rectangle"]
+            shape_patterns += crosshair_shapes
+            shape_types += crosshair_shape_types
+
+
+            # _name = f"Stage {i+1:02d}"
+            if name in viewer.layers:
+                viewer.layers[name].data = shape_patterns
+                viewer.layers[name].shape_type = shape_types
+                viewer.layers[name].edge_color = COLOURS[i % len(COLOURS)]
+                viewer.layers[name].face_color=COLOURS[i % len(COLOURS)]
+            else:
+                viewer.add_shapes(
+                    shape_patterns,
+                    name=name,
+                    shape_type=shape_types,
+                    edge_width=0.5,
+                    edge_color=COLOURS[i % len(COLOURS)],
+                    face_color=COLOURS[i % len(COLOURS)],
+                    opacity=0.5,
+                    blending="translucent",
+                )
 
+        t2 = time.time()
+        # remove all un-updated layers (assume they have been deleted)        
+        _remove_all_layers(viewer=viewer, layer_type=napari.layers.shapes.shapes.Shapes, _ignore=[stage.name for stage in milling_stages])
+        t3 = time.time()
+        logging.warning(f"_DRAW_SHAPES: CONVERT: {t1-t0}, ADD/UPDATE: {t2-t1}, REMOVE: {t3-t2}")
+    t_2 = time.time()
+    logging.warning(f"_DRAW_SHAPES: total time: {t_2-t_1}")
 
 def message_box_ui(title: str, text: str, buttons=QMessageBox.Yes | QMessageBox.No):
     msg = QMessageBox()
     msg.setWindowTitle(title)
     msg.setText(text)
     msg.setStandardButtons(buttons)
     msg.exec_()
```

## fibsem/ui/qtdesigner_files/FibsemMillingWidget.py

```diff
@@ -1,10 +1,10 @@
 # -*- coding: utf-8 -*-
 
-# Form implementation generated from reading ui file 'FibsemMillingWidgetui.ui'
+# Form implementation generated from reading ui file 'FibsemMillingWidget.ui'
 #
 # Created by: PyQt5 UI code generator 5.15.9
 #
 # WARNING: Any manual changes made to this file will be lost when pyuic5 is
 # run again.  Do not edit this file unless you know what you are doing.
 
 
@@ -95,15 +95,17 @@
         self.doubleSpinBox_spot_size.setSingleStep(0.01)
         self.doubleSpinBox_spot_size.setObjectName("doubleSpinBox_spot_size")
         self.gridLayout_4.addWidget(self.doubleSpinBox_spot_size, 10, 1, 1, 1)
         self.label_spot_size = QtWidgets.QLabel(self.tab_patterns)
         self.label_spot_size.setObjectName("label_spot_size")
         self.gridLayout_4.addWidget(self.label_spot_size, 10, 0, 1, 1)
         self.doubleSpinBox_rate = QtWidgets.QDoubleSpinBox(self.tab_patterns)
-        self.doubleSpinBox_rate.setMinimum(0.01)
+        self.doubleSpinBox_rate.setDecimals(4)
+        self.doubleSpinBox_rate.setMinimum(0.0)
+        self.doubleSpinBox_rate.setMaximum(100000.0)
         self.doubleSpinBox_rate.setSingleStep(0.01)
         self.doubleSpinBox_rate.setObjectName("doubleSpinBox_rate")
         self.gridLayout_4.addWidget(self.doubleSpinBox_rate, 8, 1, 1, 1)
         self.label_centre_y = QtWidgets.QLabel(self.tab_patterns)
         self.label_centre_y.setObjectName("label_centre_y")
         self.gridLayout_4.addWidget(self.label_centre_y, 19, 0, 1, 1)
         self.label_milling_stage = QtWidgets.QLabel(self.tab_patterns)
@@ -119,16 +121,18 @@
         self.pushButton_remove_milling_stage.setObjectName("pushButton_remove_milling_stage")
         self.gridLayout_4.addWidget(self.pushButton_remove_milling_stage, 2, 1, 1, 1)
         self.doubleSpinBox_spacing = QtWidgets.QDoubleSpinBox(self.tab_patterns)
         self.doubleSpinBox_spacing.setProperty("value", 1.0)
         self.doubleSpinBox_spacing.setObjectName("doubleSpinBox_spacing")
         self.gridLayout_4.addWidget(self.doubleSpinBox_spacing, 11, 1, 1, 1)
         self.doubleSpinBox_hfw = QtWidgets.QDoubleSpinBox(self.tab_patterns)
+        self.doubleSpinBox_hfw.setEnabled(True)
+        self.doubleSpinBox_hfw.setReadOnly(True)
         self.doubleSpinBox_hfw.setMinimum(10.0)
-        self.doubleSpinBox_hfw.setMaximum(2700.0)
+        self.doubleSpinBox_hfw.setMaximum(1000000000.0)
         self.doubleSpinBox_hfw.setProperty("value", 150.0)
         self.doubleSpinBox_hfw.setObjectName("doubleSpinBox_hfw")
         self.gridLayout_4.addWidget(self.doubleSpinBox_hfw, 6, 1, 1, 1)
         self.doubleSpinBox_dwell_time = QtWidgets.QDoubleSpinBox(self.tab_patterns)
         self.doubleSpinBox_dwell_time.setMinimum(0.01)
         self.doubleSpinBox_dwell_time.setSingleStep(0.01)
         self.doubleSpinBox_dwell_time.setObjectName("doubleSpinBox_dwell_time")
@@ -183,15 +187,15 @@
         Form.setWindowTitle(_translate("Form", "Form"))
         self.label_milling_header.setText(_translate("Form", "Milling"))
         self.label_preset.setText(_translate("Form", "Preset"))
         self.label_spacing.setText(_translate("Form", "Spacing"))
         self.label_hfw.setText(_translate("Form", "Horizontal Field Width (um)"))
         self.label_rate.setText(_translate("Form", "Rate (mm3/A/s)"))
         self.checkBox_live_update.setText(_translate("Form", "Live Update"))
-        self.label_milling_current.setText(_translate("Form", "Current (nA)"))
+        self.label_milling_current.setText(_translate("Form", "Current (A)"))
         self.label_dwell_time.setText(_translate("Form", "Dwell Time (us)"))
         self.pushButton_add_milling_stage.setText(_translate("Form", "Add"))
         self.label_centre_x.setText(_translate("Form", "Centre X (um)"))
         self.label_application_file.setText(_translate("Form", "Application File"))
         self.label_spot_size.setText(_translate("Form", "Spot Size (um)"))
         self.label_centre_y.setText(_translate("Form", "Centre Y (um)"))
         self.label_milling_stage.setText(_translate("Form", "Milling Stage"))
```

## fibsem/ui/qtdesigner_files/FibsemMillingWidgetui.ui

### fibsem/ui/qtdesigner_files/FibsemMillingWidgetui.ui

```diff
@@ -123,15 +123,15 @@
                     <string>Live Update</string>
                   </property>
                 </widget>
               </item>
               <item row="5" column="0">
                 <widget class="QLabel" name="label_milling_current">
                   <property name="text">
-                    <string>Current (nA)</string>
+                    <string>Current (A)</string>
                   </property>
                 </widget>
               </item>
               <item row="9" column="0">
                 <widget class="QLabel" name="label_dwell_time">
                   <property name="text">
                     <string>Dwell Time (us)</string>
@@ -167,37 +167,55 @@
                   <property name="text">
                     <string>Application File</string>
                   </property>
                 </widget>
               </item>
               <item row="10" column="1">
                 <widget class="QDoubleSpinBox" name="doubleSpinBox_spot_size">
+                  <property name="decimals">
+                    <number>4</number>
+                  </property>
                   <property name="minimum">
-                    <double>0.010000000000000</double>
+                    <double>0.000000000000000</double>
+                  </property>
+                  <property name="maximum">
+                    <double>100000.000000000000000</double>
                   </property>
                   <property name="singleStep">
                     <double>0.010000000000000</double>
                   </property>
+                  <property name="value">
+                    <double>0.000000000000000</double>
+                  </property>
                 </widget>
               </item>
               <item row="10" column="0">
                 <widget class="QLabel" name="label_spot_size">
                   <property name="text">
                     <string>Spot Size (um)</string>
                   </property>
                 </widget>
               </item>
               <item row="8" column="1">
                 <widget class="QDoubleSpinBox" name="doubleSpinBox_rate">
+                  <property name="decimals">
+                    <number>4</number>
+                  </property>
                   <property name="minimum">
-                    <double>0.010000000000000</double>
+                    <double>0.000000000000000</double>
+                  </property>
+                  <property name="maximum">
+                    <double>100000.000000000000000</double>
                   </property>
                   <property name="singleStep">
                     <double>0.010000000000000</double>
                   </property>
+                  <property name="value">
+                    <double>0.000000000000000</double>
+                  </property>
                 </widget>
               </item>
               <item row="19" column="0">
                 <widget class="QLabel" name="label_centre_y">
                   <property name="text">
                     <string>Centre Y (um)</string>
                   </property>
@@ -228,33 +246,48 @@
                   <property name="value">
                     <double>1.000000000000000</double>
                   </property>
                 </widget>
               </item>
               <item row="6" column="1">
                 <widget class="QDoubleSpinBox" name="doubleSpinBox_hfw">
+                  <property name="enabled">
+                    <bool>true</bool>
+                  </property>
+                  <property name="readOnly">
+                    <bool>true</bool>
+                  </property>
                   <property name="minimum">
                     <double>10.000000000000000</double>
                   </property>
                   <property name="maximum">
-                    <double>2700.000000000000000</double>
+                    <double>1000000000.000000000000000</double>
                   </property>
                   <property name="value">
                     <double>150.000000000000000</double>
                   </property>
                 </widget>
               </item>
               <item row="9" column="1">
                 <widget class="QDoubleSpinBox" name="doubleSpinBox_dwell_time">
+                  <property name="decimals">
+                    <number>4</number>
+                  </property>
                   <property name="minimum">
-                    <double>0.010000000000000</double>
+                    <double>0.000000000000000</double>
+                  </property>
+                  <property name="maximum">
+                    <double>4000000.000000000000000</double>
                   </property>
                   <property name="singleStep">
                     <double>0.010000000000000</double>
                   </property>
+                  <property name="value">
+                    <double>0.000000000000000</double>
+                  </property>
                 </widget>
               </item>
               <item row="7" column="1">
                 <widget class="QComboBox" name="comboBox_application_file"/>
               </item>
               <item row="26" column="0" colspan="2">
                 <widget class="QPushButton" name="pushButton">
```

## fibsem/ui/qtdesigner_files/FibsemMovementWidget.py

```diff
@@ -19,203 +19,194 @@
         self.gridLayout.setObjectName("gridLayout")
         self.tabWidget = QtWidgets.QTabWidget(Form)
         self.tabWidget.setObjectName("tabWidget")
         self.tab_movement = QtWidgets.QWidget()
         self.tab_movement.setObjectName("tab_movement")
         self.gridLayout_2 = QtWidgets.QGridLayout(self.tab_movement)
         self.gridLayout_2.setObjectName("gridLayout_2")
-        self.doubleSpinBox_movement_stage_x = QtWidgets.QDoubleSpinBox(self.tab_movement)
-        self.doubleSpinBox_movement_stage_x.setDecimals(5)
-        self.doubleSpinBox_movement_stage_x.setMinimum(-10000000000.0)
-        self.doubleSpinBox_movement_stage_x.setMaximum(1e+17)
-        self.doubleSpinBox_movement_stage_x.setObjectName("doubleSpinBox_movement_stage_x")
-        self.gridLayout_2.addWidget(self.doubleSpinBox_movement_stage_x, 2, 1, 1, 1)
-        self.label_movement_instructions = QtWidgets.QLabel(self.tab_movement)
-        self.label_movement_instructions.setMinimumSize(QtCore.QSize(0, 50))
-        self.label_movement_instructions.setWordWrap(True)
-        self.label_movement_instructions.setObjectName("label_movement_instructions")
-        self.gridLayout_2.addWidget(self.label_movement_instructions, 11, 0, 1, 2)
+        self.doubleSpinBox_movement_stage_tilt = QtWidgets.QDoubleSpinBox(self.tab_movement)
+        self.doubleSpinBox_movement_stage_tilt.setObjectName("doubleSpinBox_movement_stage_tilt")
+        self.gridLayout_2.addWidget(self.doubleSpinBox_movement_stage_tilt, 6, 1, 1, 1)
+        self.checkBox_movement_acquire_electron = QtWidgets.QCheckBox(self.tab_movement)
+        self.checkBox_movement_acquire_electron.setChecked(True)
+        self.checkBox_movement_acquire_electron.setObjectName("checkBox_movement_acquire_electron")
+        self.gridLayout_2.addWidget(self.checkBox_movement_acquire_electron, 11, 0, 1, 1)
         self.doubleSpinBox_movement_stage_y = QtWidgets.QDoubleSpinBox(self.tab_movement)
         self.doubleSpinBox_movement_stage_y.setDecimals(5)
         self.doubleSpinBox_movement_stage_y.setMinimum(-1e+20)
         self.doubleSpinBox_movement_stage_y.setMaximum(1e+25)
         self.doubleSpinBox_movement_stage_y.setObjectName("doubleSpinBox_movement_stage_y")
         self.gridLayout_2.addWidget(self.doubleSpinBox_movement_stage_y, 3, 1, 1, 1)
-        self.comboBox_movement_stage_coordinate_system = QtWidgets.QComboBox(self.tab_movement)
-        self.comboBox_movement_stage_coordinate_system.setObjectName("comboBox_movement_stage_coordinate_system")
-        self.gridLayout_2.addWidget(self.comboBox_movement_stage_coordinate_system, 7, 1, 1, 1)
-        self.label_movement_stage_x = QtWidgets.QLabel(self.tab_movement)
-        self.label_movement_stage_x.setObjectName("label_movement_stage_x")
-        self.gridLayout_2.addWidget(self.label_movement_stage_x, 2, 0, 1, 1)
+        self.pushButton_continue = QtWidgets.QPushButton(self.tab_movement)
+        self.pushButton_continue.setObjectName("pushButton_continue")
+        self.gridLayout_2.addWidget(self.pushButton_continue, 13, 0, 1, 2)
+        self.label_movement_images = QtWidgets.QLabel(self.tab_movement)
+        self.label_movement_images.setObjectName("label_movement_images")
+        self.gridLayout_2.addWidget(self.label_movement_images, 10, 0, 1, 2)
         self.doubleSpinBox_movement_stage_z = QtWidgets.QDoubleSpinBox(self.tab_movement)
         self.doubleSpinBox_movement_stage_z.setDecimals(5)
         self.doubleSpinBox_movement_stage_z.setMinimum(-1e+17)
         self.doubleSpinBox_movement_stage_z.setMaximum(1e+23)
         self.doubleSpinBox_movement_stage_z.setObjectName("doubleSpinBox_movement_stage_z")
         self.gridLayout_2.addWidget(self.doubleSpinBox_movement_stage_z, 4, 1, 1, 1)
-        spacerItem = QtWidgets.QSpacerItem(20, 40, QtWidgets.QSizePolicy.Minimum, QtWidgets.QSizePolicy.Expanding)
-        self.gridLayout_2.addItem(spacerItem, 13, 0, 1, 2)
-        self.checkBox_movement_acquire_electron = QtWidgets.QCheckBox(self.tab_movement)
-        self.checkBox_movement_acquire_electron.setChecked(True)
-        self.checkBox_movement_acquire_electron.setObjectName("checkBox_movement_acquire_electron")
-        self.gridLayout_2.addWidget(self.checkBox_movement_acquire_electron, 10, 0, 1, 1)
-        self.label_movement_stage_tilt = QtWidgets.QLabel(self.tab_movement)
-        self.label_movement_stage_tilt.setObjectName("label_movement_stage_tilt")
-        self.gridLayout_2.addWidget(self.label_movement_stage_tilt, 6, 0, 1, 1)
-        self.pushButton_continue = QtWidgets.QPushButton(self.tab_movement)
-        self.pushButton_continue.setObjectName("pushButton_continue")
-        self.gridLayout_2.addWidget(self.pushButton_continue, 12, 0, 1, 2)
-        self.comboBox_movement_mode = QtWidgets.QComboBox(self.tab_movement)
-        self.comboBox_movement_mode.setObjectName("comboBox_movement_mode")
-        self.gridLayout_2.addWidget(self.comboBox_movement_mode, 1, 1, 1, 1)
-        self.label_movement_mode = QtWidgets.QLabel(self.tab_movement)
-        self.label_movement_mode.setObjectName("label_movement_mode")
-        self.gridLayout_2.addWidget(self.label_movement_mode, 1, 0, 1, 1)
-        self.label_title = QtWidgets.QLabel(self.tab_movement)
-        font = QtGui.QFont()
-        font.setPointSize(12)
-        font.setBold(True)
-        font.setWeight(75)
-        self.label_title.setFont(font)
-        self.label_title.setObjectName("label_title")
-        self.gridLayout_2.addWidget(self.label_title, 0, 0, 1, 1)
+        self.label_movement_stage_coordinate_system = QtWidgets.QLabel(self.tab_movement)
+        self.label_movement_stage_coordinate_system.setObjectName("label_movement_stage_coordinate_system")
+        self.gridLayout_2.addWidget(self.label_movement_stage_coordinate_system, 7, 0, 1, 1)
+        self.label_movement_stage_x = QtWidgets.QLabel(self.tab_movement)
+        self.label_movement_stage_x.setObjectName("label_movement_stage_x")
+        self.gridLayout_2.addWidget(self.label_movement_stage_x, 2, 0, 1, 1)
         self.doubleSpinBox_movement_stage_rotation = QtWidgets.QDoubleSpinBox(self.tab_movement)
         self.doubleSpinBox_movement_stage_rotation.setMinimum(-360.0)
         self.doubleSpinBox_movement_stage_rotation.setMaximum(360.0)
         self.doubleSpinBox_movement_stage_rotation.setObjectName("doubleSpinBox_movement_stage_rotation")
         self.gridLayout_2.addWidget(self.doubleSpinBox_movement_stage_rotation, 5, 1, 1, 1)
+        self.pushButton_move = QtWidgets.QPushButton(self.tab_movement)
+        self.pushButton_move.setObjectName("pushButton_move")
+        self.gridLayout_2.addWidget(self.pushButton_move, 9, 0, 1, 2)
+        self.comboBox_movement_stage_coordinate_system = QtWidgets.QComboBox(self.tab_movement)
+        self.comboBox_movement_stage_coordinate_system.setObjectName("comboBox_movement_stage_coordinate_system")
+        self.gridLayout_2.addWidget(self.comboBox_movement_stage_coordinate_system, 7, 1, 1, 1)
         self.label_movement_stage_rotation = QtWidgets.QLabel(self.tab_movement)
         self.label_movement_stage_rotation.setObjectName("label_movement_stage_rotation")
         self.gridLayout_2.addWidget(self.label_movement_stage_rotation, 5, 0, 1, 1)
-        self.label_movement_stage_coordinate_system = QtWidgets.QLabel(self.tab_movement)
-        self.label_movement_stage_coordinate_system.setObjectName("label_movement_stage_coordinate_system")
-        self.gridLayout_2.addWidget(self.label_movement_stage_coordinate_system, 7, 0, 1, 1)
-        self.doubleSpinBox_movement_stage_tilt = QtWidgets.QDoubleSpinBox(self.tab_movement)
-        self.doubleSpinBox_movement_stage_tilt.setObjectName("doubleSpinBox_movement_stage_tilt")
-        self.gridLayout_2.addWidget(self.doubleSpinBox_movement_stage_tilt, 6, 1, 1, 1)
         self.label_movement_stage_z = QtWidgets.QLabel(self.tab_movement)
         self.label_movement_stage_z.setObjectName("label_movement_stage_z")
         self.gridLayout_2.addWidget(self.label_movement_stage_z, 4, 0, 1, 1)
-        self.pushButton_move = QtWidgets.QPushButton(self.tab_movement)
-        self.pushButton_move.setObjectName("pushButton_move")
-        self.gridLayout_2.addWidget(self.pushButton_move, 8, 0, 1, 2)
-        self.checkBox_movement_acquire_ion = QtWidgets.QCheckBox(self.tab_movement)
-        self.checkBox_movement_acquire_ion.setChecked(True)
-        self.checkBox_movement_acquire_ion.setObjectName("checkBox_movement_acquire_ion")
-        self.gridLayout_2.addWidget(self.checkBox_movement_acquire_ion, 10, 1, 1, 1)
+        self.doubleSpinBox_movement_stage_x = QtWidgets.QDoubleSpinBox(self.tab_movement)
+        self.doubleSpinBox_movement_stage_x.setDecimals(5)
+        self.doubleSpinBox_movement_stage_x.setMinimum(-10000000000.0)
+        self.doubleSpinBox_movement_stage_x.setMaximum(1e+17)
+        self.doubleSpinBox_movement_stage_x.setObjectName("doubleSpinBox_movement_stage_x")
+        self.gridLayout_2.addWidget(self.doubleSpinBox_movement_stage_x, 2, 1, 1, 1)
+        self.comboBox_movement_mode = QtWidgets.QComboBox(self.tab_movement)
+        self.comboBox_movement_mode.setObjectName("comboBox_movement_mode")
+        self.gridLayout_2.addWidget(self.comboBox_movement_mode, 1, 1, 1, 1)
+        self.label_movement_mode = QtWidgets.QLabel(self.tab_movement)
+        self.label_movement_mode.setObjectName("label_movement_mode")
+        self.gridLayout_2.addWidget(self.label_movement_mode, 1, 0, 1, 1)
+        self.label_movement_instructions = QtWidgets.QLabel(self.tab_movement)
+        self.label_movement_instructions.setMinimumSize(QtCore.QSize(0, 50))
+        self.label_movement_instructions.setWordWrap(True)
+        self.label_movement_instructions.setObjectName("label_movement_instructions")
+        self.gridLayout_2.addWidget(self.label_movement_instructions, 12, 0, 1, 2)
         self.label_movement_stage_y = QtWidgets.QLabel(self.tab_movement)
         self.label_movement_stage_y.setObjectName("label_movement_stage_y")
         self.gridLayout_2.addWidget(self.label_movement_stage_y, 3, 0, 1, 1)
-        self.label_movement_images = QtWidgets.QLabel(self.tab_movement)
-        self.label_movement_images.setObjectName("label_movement_images")
-        self.gridLayout_2.addWidget(self.label_movement_images, 9, 0, 1, 2)
+        spacerItem = QtWidgets.QSpacerItem(20, 40, QtWidgets.QSizePolicy.Minimum, QtWidgets.QSizePolicy.Expanding)
+        self.gridLayout_2.addItem(spacerItem, 14, 0, 1, 2)
+        self.label_movement_stage_tilt = QtWidgets.QLabel(self.tab_movement)
+        self.label_movement_stage_tilt.setObjectName("label_movement_stage_tilt")
+        self.gridLayout_2.addWidget(self.label_movement_stage_tilt, 6, 0, 1, 1)
+        self.checkBox_movement_acquire_ion = QtWidgets.QCheckBox(self.tab_movement)
+        self.checkBox_movement_acquire_ion.setChecked(True)
+        self.checkBox_movement_acquire_ion.setObjectName("checkBox_movement_acquire_ion")
+        self.gridLayout_2.addWidget(self.checkBox_movement_acquire_ion, 11, 1, 1, 1)
+        self.label_title = QtWidgets.QLabel(self.tab_movement)
+        font = QtGui.QFont()
+        font.setPointSize(12)
+        font.setBold(True)
+        font.setWeight(75)
+        self.label_title.setFont(font)
+        self.label_title.setObjectName("label_title")
+        self.gridLayout_2.addWidget(self.label_title, 0, 0, 1, 1)
+        self.pushButton_move_flat_ion = QtWidgets.QPushButton(self.tab_movement)
+        self.pushButton_move_flat_ion.setObjectName("pushButton_move_flat_ion")
+        self.gridLayout_2.addWidget(self.pushButton_move_flat_ion, 8, 0, 1, 1)
+        self.pushButton_move_flat_electron = QtWidgets.QPushButton(self.tab_movement)
+        self.pushButton_move_flat_electron.setObjectName("pushButton_move_flat_electron")
+        self.gridLayout_2.addWidget(self.pushButton_move_flat_electron, 8, 1, 1, 1)
         self.tabWidget.addTab(self.tab_movement, "")
         self.tab_positions = QtWidgets.QWidget()
         self.tab_positions.setObjectName("tab_positions")
         self.gridLayout_3 = QtWidgets.QGridLayout(self.tab_positions)
         self.gridLayout_3.setObjectName("gridLayout_3")
-        self.label_2 = QtWidgets.QLabel(self.tab_positions)
+        self.label = QtWidgets.QLabel(self.tab_positions)
         font = QtGui.QFont()
+        font.setPointSize(12)
         font.setBold(True)
         font.setWeight(75)
-        self.label_2.setFont(font)
-        self.label_2.setObjectName("label_2")
-        self.gridLayout_3.addWidget(self.label_2, 2, 1, 1, 1)
-        self.pushButton_go_to = QtWidgets.QPushButton(self.tab_positions)
-        self.pushButton_go_to.setObjectName("pushButton_go_to")
-        self.gridLayout_3.addWidget(self.pushButton_go_to, 3, 1, 1, 1)
-        self.pushButton_import = QtWidgets.QPushButton(self.tab_positions)
-        self.pushButton_import.setObjectName("pushButton_import")
-        self.gridLayout_3.addWidget(self.pushButton_import, 6, 2, 1, 1)
+        self.label.setFont(font)
+        self.label.setObjectName("label")
+        self.gridLayout_3.addWidget(self.label, 0, 1, 1, 1)
         self.lineEdit_position_name = QtWidgets.QLineEdit(self.tab_positions)
         self.lineEdit_position_name.setObjectName("lineEdit_position_name")
         self.gridLayout_3.addWidget(self.lineEdit_position_name, 4, 2, 1, 2)
+        self.label_3 = QtWidgets.QLabel(self.tab_positions)
+        self.label_3.setObjectName("label_3")
+        self.gridLayout_3.addWidget(self.label_3, 1, 1, 1, 1)
+        self.pushButton_import = QtWidgets.QPushButton(self.tab_positions)
+        self.pushButton_import.setObjectName("pushButton_import")
+        self.gridLayout_3.addWidget(self.pushButton_import, 6, 2, 1, 1)
+        self.comboBox_positions = QtWidgets.QComboBox(self.tab_positions)
+        self.comboBox_positions.setObjectName("comboBox_positions")
+        self.gridLayout_3.addWidget(self.comboBox_positions, 2, 2, 1, 2)
         self.pushButton_save_position = QtWidgets.QPushButton(self.tab_positions)
         self.pushButton_save_position.setStyleSheet("color: white; background-color: rgb(85, 170, 0)")
         self.pushButton_save_position.setObjectName("pushButton_save_position")
         self.gridLayout_3.addWidget(self.pushButton_save_position, 4, 1, 1, 1)
-        self.comboBox_positions = QtWidgets.QComboBox(self.tab_positions)
-        self.comboBox_positions.setObjectName("comboBox_positions")
-        self.gridLayout_3.addWidget(self.comboBox_positions, 2, 2, 1, 2)
-        spacerItem1 = QtWidgets.QSpacerItem(20, 40, QtWidgets.QSizePolicy.Minimum, QtWidgets.QSizePolicy.Expanding)
-        self.gridLayout_3.addItem(spacerItem1, 9, 1, 1, 3)
-        self.label_5 = QtWidgets.QLabel(self.tab_positions)
-        font = QtGui.QFont()
-        font.setBold(True)
-        font.setWeight(75)
-        self.label_5.setFont(font)
-        self.label_5.setObjectName("label_5")
-        self.gridLayout_3.addWidget(self.label_5, 7, 1, 1, 1)
-        self.label_3 = QtWidgets.QLabel(self.tab_positions)
-        self.label_3.setObjectName("label_3")
-        self.gridLayout_3.addWidget(self.label_3, 1, 1, 1, 1)
-        self.label = QtWidgets.QLabel(self.tab_positions)
-        font = QtGui.QFont()
-        font.setPointSize(12)
-        font.setBold(True)
-        font.setWeight(75)
-        self.label.setFont(font)
-        self.label.setObjectName("label")
-        self.gridLayout_3.addWidget(self.label, 0, 1, 1, 1)
-        self.label_minimap = QtWidgets.QLabel(self.tab_positions)
-        self.label_minimap.setText("")
-        self.label_minimap.setObjectName("label_minimap")
-        self.gridLayout_3.addWidget(self.label_minimap, 8, 1, 1, 3)
-        self.label_current_position = QtWidgets.QLabel(self.tab_positions)
-        self.label_current_position.setText("")
-        self.label_current_position.setObjectName("label_current_position")
-        self.gridLayout_3.addWidget(self.label_current_position, 3, 2, 1, 2)
         self.pushButton_update_position = QtWidgets.QPushButton(self.tab_positions)
         self.pushButton_update_position.setObjectName("pushButton_update_position")
         self.gridLayout_3.addWidget(self.pushButton_update_position, 5, 2, 1, 1)
-        self.spinBox_grid_radius = QtWidgets.QSpinBox(self.tab_positions)
-        self.spinBox_grid_radius.setMaximum(10000)
-        self.spinBox_grid_radius.setProperty("value", 500)
-        self.spinBox_grid_radius.setObjectName("spinBox_grid_radius")
-        self.gridLayout_3.addWidget(self.spinBox_grid_radius, 7, 2, 1, 1)
+        self.label_2 = QtWidgets.QLabel(self.tab_positions)
+        font = QtGui.QFont()
+        font.setBold(True)
+        font.setWeight(75)
+        self.label_2.setFont(font)
+        self.label_2.setObjectName("label_2")
+        self.gridLayout_3.addWidget(self.label_2, 2, 1, 1, 1)
         self.pushButton_remove_position = QtWidgets.QPushButton(self.tab_positions)
         self.pushButton_remove_position.setStyleSheet("color: white; background-color: rgb(170, 0, 0)")
         self.pushButton_remove_position.setObjectName("pushButton_remove_position")
         self.gridLayout_3.addWidget(self.pushButton_remove_position, 5, 3, 1, 1)
-        self.checkBox_auto_scaling = QtWidgets.QCheckBox(self.tab_positions)
-        self.checkBox_auto_scaling.setObjectName("checkBox_auto_scaling")
-        self.gridLayout_3.addWidget(self.checkBox_auto_scaling, 7, 3, 1, 1)
+        self.label_current_position = QtWidgets.QLabel(self.tab_positions)
+        self.label_current_position.setText("")
+        self.label_current_position.setObjectName("label_current_position")
+        self.gridLayout_3.addWidget(self.label_current_position, 3, 2, 1, 2)
+        spacerItem1 = QtWidgets.QSpacerItem(20, 40, QtWidgets.QSizePolicy.Minimum, QtWidgets.QSizePolicy.Expanding)
+        self.gridLayout_3.addItem(spacerItem1, 8, 1, 1, 3)
         self.pushButton_export = QtWidgets.QPushButton(self.tab_positions)
         self.pushButton_export.setObjectName("pushButton_export")
         self.gridLayout_3.addWidget(self.pushButton_export, 6, 3, 1, 1)
+        self.pushButton_go_to = QtWidgets.QPushButton(self.tab_positions)
+        self.pushButton_go_to.setObjectName("pushButton_go_to")
+        self.gridLayout_3.addWidget(self.pushButton_go_to, 3, 1, 1, 1)
+        self.label_minimap = QtWidgets.QLabel(self.tab_positions)
+        self.label_minimap.setText("")
+        self.label_minimap.setObjectName("label_minimap")
+        self.gridLayout_3.addWidget(self.label_minimap, 7, 1, 1, 3)
         self.tabWidget.addTab(self.tab_positions, "")
         self.gridLayout.addWidget(self.tabWidget, 4, 0, 1, 1)
 
         self.retranslateUi(Form)
         self.tabWidget.setCurrentIndex(0)
         QtCore.QMetaObject.connectSlotsByName(Form)
 
     def retranslateUi(self, Form):
         _translate = QtCore.QCoreApplication.translate
         Form.setWindowTitle(_translate("Form", "Form"))
-        self.label_movement_instructions.setText(_translate("Form", "Double click to move. Press continue when complete."))
-        self.label_movement_stage_x.setText(_translate("Form", "X Coordinate (mm)"))
         self.checkBox_movement_acquire_electron.setText(_translate("Form", "Electron Beam"))
-        self.label_movement_stage_tilt.setText(_translate("Form", "Tilt (deg)"))
         self.pushButton_continue.setText(_translate("Form", "Continue"))
-        self.label_movement_mode.setText(_translate("Form", "Mode"))
-        self.label_title.setText(_translate("Form", "Movement"))
-        self.label_movement_stage_rotation.setText(_translate("Form", "Rotation (deg)"))
+        self.label_movement_images.setText(_translate("Form", "Acquire images after moving:"))
         self.label_movement_stage_coordinate_system.setText(_translate("Form", "Coordinate System"))
-        self.label_movement_stage_z.setText(_translate("Form", "Z Coordinate (mm)"))
+        self.label_movement_stage_x.setText(_translate("Form", "X Coordinate (mm)"))
         self.pushButton_move.setText(_translate("Form", "Move to Position"))
-        self.checkBox_movement_acquire_ion.setText(_translate("Form", "Ion Beam"))
+        self.label_movement_stage_rotation.setText(_translate("Form", "Rotation (deg)"))
+        self.label_movement_stage_z.setText(_translate("Form", "Z Coordinate (mm)"))
+        self.label_movement_mode.setText(_translate("Form", "Mode"))
+        self.label_movement_instructions.setText(_translate("Form", "Double click to move. Press continue when complete."))
         self.label_movement_stage_y.setText(_translate("Form", "Y Coordinate (mm)"))
-        self.label_movement_images.setText(_translate("Form", "Acquire images after moving:"))
+        self.label_movement_stage_tilt.setText(_translate("Form", "Tilt (deg)"))
+        self.checkBox_movement_acquire_ion.setText(_translate("Form", "Ion Beam"))
+        self.label_title.setText(_translate("Form", "Movement"))
+        self.pushButton_move_flat_ion.setText(_translate("Form", "Move Flat to ION Beam"))
+        self.pushButton_move_flat_electron.setText(_translate("Form", "Move Flat to ELECTRON Beam"))
         self.tabWidget.setTabText(self.tabWidget.indexOf(self.tab_movement), _translate("Form", "Movement"))
-        self.label_2.setText(_translate("Form", "Saved positions"))
-        self.pushButton_go_to.setText(_translate("Form", "Go To"))
+        self.label.setText(_translate("Form", "Positions "))
+        self.label_3.setText(_translate("Form", "All positions in mm and degrees"))
         self.pushButton_import.setText(_translate("Form", "Import Positions"))
         self.pushButton_save_position.setText(_translate("Form", "Save position"))
-        self.label_5.setText(_translate("Form", "Grid radius (um)"))
-        self.label_3.setText(_translate("Form", "All positions in mm and degrees"))
-        self.label.setText(_translate("Form", "Positions "))
         self.pushButton_update_position.setText(_translate("Form", "Update position"))
+        self.label_2.setText(_translate("Form", "Saved positions"))
         self.pushButton_remove_position.setText(_translate("Form", "Remove Position"))
-        self.checkBox_auto_scaling.setText(_translate("Form", "Auto scaling"))
         self.pushButton_export.setText(_translate("Form", "Export positions"))
+        self.pushButton_go_to.setText(_translate("Form", "Go To"))
         self.tabWidget.setTabText(self.tabWidget.indexOf(self.tab_positions), _translate("Form", "Positions"))
```

## fibsem/ui/qtdesigner_files/FibsemMovementWidget.ui

### fibsem/ui/qtdesigner_files/FibsemMovementWidget.ui

```diff
@@ -20,39 +20,23 @@
             <number>0</number>
           </property>
           <widget class="QWidget" name="tab_movement">
             <attribute name="title">
               <string>Movement</string>
             </attribute>
             <layout class="QGridLayout" name="gridLayout_2">
-              <item row="2" column="1">
-                <widget class="QDoubleSpinBox" name="doubleSpinBox_movement_stage_x">
-                  <property name="decimals">
-                    <number>5</number>
-                  </property>
-                  <property name="minimum">
-                    <double>-10000000000.000000000000000</double>
-                  </property>
-                  <property name="maximum">
-                    <double>100000000000000000.000000000000000</double>
-                  </property>
-                </widget>
+              <item row="6" column="1">
+                <widget class="QDoubleSpinBox" name="doubleSpinBox_movement_stage_tilt"/>
               </item>
-              <item row="11" column="0" colspan="2">
-                <widget class="QLabel" name="label_movement_instructions">
-                  <property name="minimumSize">
-                    <size>
-                      <width>0</width>
-                      <height>50</height>
-                    </size>
-                  </property>
+              <item row="11" column="0">
+                <widget class="QCheckBox" name="checkBox_movement_acquire_electron">
                   <property name="text">
-                    <string>Double click to move. Press continue when complete.</string>
+                    <string>Electron Beam</string>
                   </property>
-                  <property name="wordWrap">
+                  <property name="checked">
                     <bool>true</bool>
                   </property>
                 </widget>
               </item>
               <item row="3" column="1">
                 <widget class="QDoubleSpinBox" name="doubleSpinBox_movement_stage_y">
                   <property name="decimals">
@@ -62,21 +46,25 @@
                     <double>-100000000000000000000.000000000000000</double>
                   </property>
                   <property name="maximum">
                     <double>10000000000000000905969664.000000000000000</double>
                   </property>
                 </widget>
               </item>
-              <item row="7" column="1">
-                <widget class="QComboBox" name="comboBox_movement_stage_coordinate_system"/>
+              <item row="13" column="0" colspan="2">
+                <widget class="QPushButton" name="pushButton_continue">
+                  <property name="text">
+                    <string>Continue</string>
+                  </property>
+                </widget>
               </item>
-              <item row="2" column="0">
-                <widget class="QLabel" name="label_movement_stage_x">
+              <item row="10" column="0" colspan="2">
+                <widget class="QLabel" name="label_movement_images">
                   <property name="text">
-                    <string>X Coordinate (mm)</string>
+                    <string>Acquire images after moving:</string>
                   </property>
                 </widget>
               </item>
               <item row="4" column="1">
                 <widget class="QDoubleSpinBox" name="doubleSpinBox_movement_stage_z">
                   <property name="decimals">
                     <number>5</number>
@@ -85,289 +73,285 @@
                     <double>-100000000000000000.000000000000000</double>
                   </property>
                   <property name="maximum">
                     <double>99999999999999991611392.000000000000000</double>
                   </property>
                 </widget>
               </item>
-              <item row="13" column="0" colspan="2">
-                <spacer name="verticalSpacer">
-                  <property name="orientation">
-                    <enum>Qt::Vertical</enum>
-                  </property>
-                  <property name="sizeHint" stdset="0">
-                    <size>
-                      <width>20</width>
-                      <height>40</height>
-                    </size>
+              <item row="7" column="0">
+                <widget class="QLabel" name="label_movement_stage_coordinate_system">
+                  <property name="text">
+                    <string>Coordinate System</string>
                   </property>
-                </spacer>
+                </widget>
               </item>
-              <item row="10" column="0">
-                <widget class="QCheckBox" name="checkBox_movement_acquire_electron">
+              <item row="2" column="0">
+                <widget class="QLabel" name="label_movement_stage_x">
                   <property name="text">
-                    <string>Electron Beam</string>
-                  </property>
-                  <property name="checked">
-                    <bool>true</bool>
+                    <string>X Coordinate (mm)</string>
                   </property>
                 </widget>
               </item>
-              <item row="6" column="0">
-                <widget class="QLabel" name="label_movement_stage_tilt">
-                  <property name="text">
-                    <string>Tilt (deg)</string>
+              <item row="5" column="1">
+                <widget class="QDoubleSpinBox" name="doubleSpinBox_movement_stage_rotation">
+                  <property name="minimum">
+                    <double>-360.000000000000000</double>
+                  </property>
+                  <property name="maximum">
+                    <double>360.000000000000000</double>
                   </property>
                 </widget>
               </item>
-              <item row="12" column="0" colspan="2">
-                <widget class="QPushButton" name="pushButton_continue">
+              <item row="9" column="0" colspan="2">
+                <widget class="QPushButton" name="pushButton_move">
                   <property name="text">
-                    <string>Continue</string>
+                    <string>Move to Position</string>
                   </property>
                 </widget>
               </item>
-              <item row="1" column="1">
-                <widget class="QComboBox" name="comboBox_movement_mode"/>
+              <item row="7" column="1">
+                <widget class="QComboBox" name="comboBox_movement_stage_coordinate_system"/>
               </item>
-              <item row="1" column="0">
-                <widget class="QLabel" name="label_movement_mode">
+              <item row="5" column="0">
+                <widget class="QLabel" name="label_movement_stage_rotation">
                   <property name="text">
-                    <string>Mode</string>
+                    <string>Rotation (deg)</string>
                   </property>
                 </widget>
               </item>
-              <item row="0" column="0">
-                <widget class="QLabel" name="label_title">
-                  <property name="font">
-                    <font>
-                      <pointsize>12</pointsize>
-                      <weight>75</weight>
-                      <bold>true</bold>
-                    </font>
-                  </property>
+              <item row="4" column="0">
+                <widget class="QLabel" name="label_movement_stage_z">
                   <property name="text">
-                    <string>Movement</string>
+                    <string>Z Coordinate (mm)</string>
                   </property>
                 </widget>
               </item>
-              <item row="5" column="1">
-                <widget class="QDoubleSpinBox" name="doubleSpinBox_movement_stage_rotation">
+              <item row="2" column="1">
+                <widget class="QDoubleSpinBox" name="doubleSpinBox_movement_stage_x">
+                  <property name="decimals">
+                    <number>5</number>
+                  </property>
                   <property name="minimum">
-                    <double>-360.000000000000000</double>
+                    <double>-10000000000.000000000000000</double>
                   </property>
                   <property name="maximum">
-                    <double>360.000000000000000</double>
+                    <double>100000000000000000.000000000000000</double>
                   </property>
                 </widget>
               </item>
-              <item row="5" column="0">
-                <widget class="QLabel" name="label_movement_stage_rotation">
+              <item row="1" column="1">
+                <widget class="QComboBox" name="comboBox_movement_mode"/>
+              </item>
+              <item row="1" column="0">
+                <widget class="QLabel" name="label_movement_mode">
                   <property name="text">
-                    <string>Rotation (deg)</string>
+                    <string>Mode</string>
                   </property>
                 </widget>
               </item>
-              <item row="7" column="0">
-                <widget class="QLabel" name="label_movement_stage_coordinate_system">
+              <item row="12" column="0" colspan="2">
+                <widget class="QLabel" name="label_movement_instructions">
+                  <property name="minimumSize">
+                    <size>
+                      <width>0</width>
+                      <height>50</height>
+                    </size>
+                  </property>
                   <property name="text">
-                    <string>Coordinate System</string>
+                    <string>Double click to move. Press continue when complete.</string>
+                  </property>
+                  <property name="wordWrap">
+                    <bool>true</bool>
                   </property>
                 </widget>
               </item>
-              <item row="6" column="1">
-                <widget class="QDoubleSpinBox" name="doubleSpinBox_movement_stage_tilt"/>
-              </item>
-              <item row="4" column="0">
-                <widget class="QLabel" name="label_movement_stage_z">
+              <item row="3" column="0">
+                <widget class="QLabel" name="label_movement_stage_y">
                   <property name="text">
-                    <string>Z Coordinate (mm)</string>
+                    <string>Y Coordinate (mm)</string>
                   </property>
                 </widget>
               </item>
-              <item row="8" column="0" colspan="2">
-                <widget class="QPushButton" name="pushButton_move">
+              <item row="14" column="0" colspan="2">
+                <spacer name="verticalSpacer">
+                  <property name="orientation">
+                    <enum>Qt::Vertical</enum>
+                  </property>
+                  <property name="sizeHint" stdset="0">
+                    <size>
+                      <width>20</width>
+                      <height>40</height>
+                    </size>
+                  </property>
+                </spacer>
+              </item>
+              <item row="6" column="0">
+                <widget class="QLabel" name="label_movement_stage_tilt">
                   <property name="text">
-                    <string>Move to Position</string>
+                    <string>Tilt (deg)</string>
                   </property>
                 </widget>
               </item>
-              <item row="10" column="1">
+              <item row="11" column="1">
                 <widget class="QCheckBox" name="checkBox_movement_acquire_ion">
                   <property name="text">
                     <string>Ion Beam</string>
                   </property>
                   <property name="checked">
                     <bool>true</bool>
                   </property>
                 </widget>
               </item>
-              <item row="3" column="0">
-                <widget class="QLabel" name="label_movement_stage_y">
+              <item row="0" column="0">
+                <widget class="QLabel" name="label_title">
+                  <property name="font">
+                    <font>
+                      <pointsize>12</pointsize>
+                      <weight>75</weight>
+                      <bold>true</bold>
+                    </font>
+                  </property>
                   <property name="text">
-                    <string>Y Coordinate (mm)</string>
+                    <string>Movement</string>
                   </property>
                 </widget>
               </item>
-              <item row="9" column="0" colspan="2">
-                <widget class="QLabel" name="label_movement_images">
+              <item row="8" column="0">
+                <widget class="QPushButton" name="pushButton_move_flat_ion">
                   <property name="text">
-                    <string>Acquire images after moving:</string>
+                    <string>Move Flat to ION Beam</string>
+                  </property>
+                </widget>
+              </item>
+              <item row="8" column="1">
+                <widget class="QPushButton" name="pushButton_move_flat_electron">
+                  <property name="text">
+                    <string>Move Flat to ELECTRON Beam</string>
                   </property>
                 </widget>
               </item>
             </layout>
           </widget>
           <widget class="QWidget" name="tab_positions">
             <attribute name="title">
               <string>Positions</string>
             </attribute>
             <layout class="QGridLayout" name="gridLayout_3">
-              <item row="2" column="1">
-                <widget class="QLabel" name="label_2">
+              <item row="0" column="1">
+                <widget class="QLabel" name="label">
                   <property name="font">
                     <font>
+                      <pointsize>12</pointsize>
                       <weight>75</weight>
                       <bold>true</bold>
                     </font>
                   </property>
                   <property name="text">
-                    <string>Saved positions</string>
+                    <string>Positions</string>
                   </property>
                 </widget>
               </item>
-              <item row="3" column="1">
-                <widget class="QPushButton" name="pushButton_go_to">
+              <item row="4" column="2" colspan="2">
+                <widget class="QLineEdit" name="lineEdit_position_name"/>
+              </item>
+              <item row="1" column="1">
+                <widget class="QLabel" name="label_3">
                   <property name="text">
-                    <string>Go To</string>
+                    <string>All positions in mm and degrees</string>
                   </property>
                 </widget>
               </item>
               <item row="6" column="2">
                 <widget class="QPushButton" name="pushButton_import">
                   <property name="text">
                     <string>Import Positions</string>
                   </property>
                 </widget>
               </item>
-              <item row="4" column="2" colspan="2">
-                <widget class="QLineEdit" name="lineEdit_position_name"/>
+              <item row="2" column="2" colspan="2">
+                <widget class="QComboBox" name="comboBox_positions"/>
               </item>
               <item row="4" column="1">
                 <widget class="QPushButton" name="pushButton_save_position">
                   <property name="styleSheet">
                     <string notr="true">color: white; background-color: rgb(85, 170, 0)</string>
                   </property>
                   <property name="text">
                     <string>Save position</string>
                   </property>
                 </widget>
               </item>
-              <item row="2" column="2" colspan="2">
-                <widget class="QComboBox" name="comboBox_positions"/>
-              </item>
-              <item row="9" column="1" colspan="3">
-                <spacer name="verticalSpacer_2">
-                  <property name="orientation">
-                    <enum>Qt::Vertical</enum>
-                  </property>
-                  <property name="sizeHint" stdset="0">
-                    <size>
-                      <width>20</width>
-                      <height>40</height>
-                    </size>
-                  </property>
-                </spacer>
-              </item>
-              <item row="7" column="1">
-                <widget class="QLabel" name="label_5">
-                  <property name="font">
-                    <font>
-                      <weight>75</weight>
-                      <bold>true</bold>
-                    </font>
-                  </property>
-                  <property name="text">
-                    <string>Grid radius (um)</string>
-                  </property>
-                </widget>
-              </item>
-              <item row="1" column="1">
-                <widget class="QLabel" name="label_3">
+              <item row="5" column="2">
+                <widget class="QPushButton" name="pushButton_update_position">
                   <property name="text">
-                    <string>All positions in mm and degrees</string>
+                    <string>Update position</string>
                   </property>
                 </widget>
               </item>
-              <item row="0" column="1">
-                <widget class="QLabel" name="label">
+              <item row="2" column="1">
+                <widget class="QLabel" name="label_2">
                   <property name="font">
                     <font>
-                      <pointsize>12</pointsize>
                       <weight>75</weight>
                       <bold>true</bold>
                     </font>
                   </property>
                   <property name="text">
-                    <string>Positions</string>
+                    <string>Saved positions</string>
                   </property>
                 </widget>
               </item>
-              <item row="8" column="1" colspan="3">
-                <widget class="QLabel" name="label_minimap">
+              <item row="5" column="3">
+                <widget class="QPushButton" name="pushButton_remove_position">
+                  <property name="styleSheet">
+                    <string notr="true">color: white; background-color: rgb(170, 0, 0)</string>
+                  </property>
                   <property name="text">
-                    <string/>
+                    <string>Remove Position</string>
                   </property>
                 </widget>
               </item>
               <item row="3" column="2" colspan="2">
                 <widget class="QLabel" name="label_current_position">
                   <property name="text">
                     <string/>
                   </property>
                 </widget>
               </item>
-              <item row="5" column="2">
-                <widget class="QPushButton" name="pushButton_update_position">
-                  <property name="text">
-                    <string>Update position</string>
-                  </property>
-                </widget>
-              </item>
-              <item row="7" column="2">
-                <widget class="QSpinBox" name="spinBox_grid_radius">
-                  <property name="maximum">
-                    <number>10000</number>
+              <item row="8" column="1" colspan="3">
+                <spacer name="verticalSpacer_2">
+                  <property name="orientation">
+                    <enum>Qt::Vertical</enum>
                   </property>
-                  <property name="value">
-                    <number>500</number>
+                  <property name="sizeHint" stdset="0">
+                    <size>
+                      <width>20</width>
+                      <height>40</height>
+                    </size>
                   </property>
-                </widget>
+                </spacer>
               </item>
-              <item row="5" column="3">
-                <widget class="QPushButton" name="pushButton_remove_position">
-                  <property name="styleSheet">
-                    <string notr="true">color: white; background-color: rgb(170, 0, 0)</string>
-                  </property>
+              <item row="6" column="3">
+                <widget class="QPushButton" name="pushButton_export">
                   <property name="text">
-                    <string>Remove Position</string>
+                    <string>Export positions</string>
                   </property>
                 </widget>
               </item>
-              <item row="7" column="3">
-                <widget class="QCheckBox" name="checkBox_auto_scaling">
+              <item row="3" column="1">
+                <widget class="QPushButton" name="pushButton_go_to">
                   <property name="text">
-                    <string>Auto scaling</string>
+                    <string>Go To</string>
                   </property>
                 </widget>
               </item>
-              <item row="6" column="3">
-                <widget class="QPushButton" name="pushButton_export">
+              <item row="7" column="1" colspan="3">
+                <widget class="QLabel" name="label_minimap">
                   <property name="text">
-                    <string>Export positions</string>
+                    <string/>
                   </property>
                 </widget>
               </item>
             </layout>
           </widget>
         </widget>
       </item>
```

## fibsem/ui/qtdesigner_files/FibsemSystemSetupWidget.py

```diff
@@ -10,15 +10,15 @@
 
 from PyQt5 import QtCore, QtGui, QtWidgets
 
 
 class Ui_Form(object):
     def setupUi(self, Form):
         Form.setObjectName("Form")
-        Form.resize(543, 753)
+        Form.resize(686, 883)
         font = QtGui.QFont()
         font.setPointSize(10)
         Form.setFont(font)
         self.gridLayout = QtWidgets.QGridLayout(Form)
         self.gridLayout.setObjectName("gridLayout")
         self.tabWidget = QtWidgets.QTabWidget(Form)
         font = QtGui.QFont()
@@ -26,382 +26,337 @@
         self.tabWidget.setFont(font)
         self.tabWidget.setTabBarAutoHide(False)
         self.tabWidget.setObjectName("tabWidget")
         self.tab_4 = QtWidgets.QWidget()
         self.tab_4.setObjectName("tab_4")
         self.gridLayout_7 = QtWidgets.QGridLayout(self.tab_4)
         self.gridLayout_7.setObjectName("gridLayout_7")
-        self.microscope_button = QtWidgets.QPushButton(self.tab_4)
-        font = QtGui.QFont()
-        font.setPointSize(8)
-        self.microscope_button.setFont(font)
-        self.microscope_button.setObjectName("microscope_button")
-        self.gridLayout_7.addWidget(self.microscope_button, 4, 0, 1, 2)
-        self.label_ip_address = QtWidgets.QLabel(self.tab_4)
-        font = QtGui.QFont()
-        font.setPointSize(8)
-        self.label_ip_address.setFont(font)
-        self.label_ip_address.setObjectName("label_ip_address")
-        self.gridLayout_7.addWidget(self.label_ip_address, 1, 0, 1, 1)
-        self.label_manufacturer = QtWidgets.QLabel(self.tab_4)
-        font = QtGui.QFont()
-        font.setPointSize(8)
-        self.label_manufacturer.setFont(font)
-        self.label_manufacturer.setObjectName("label_manufacturer")
-        self.gridLayout_7.addWidget(self.label_manufacturer, 3, 0, 1, 1)
         self.label_title = QtWidgets.QLabel(self.tab_4)
         font = QtGui.QFont()
         font.setPointSize(12)
         font.setBold(True)
         font.setWeight(75)
         self.label_title.setFont(font)
         self.label_title.setObjectName("label_title")
         self.gridLayout_7.addWidget(self.label_title, 0, 1, 1, 1)
+        self.label_ip_address = QtWidgets.QLabel(self.tab_4)
+        font = QtGui.QFont()
+        font.setPointSize(8)
+        self.label_ip_address.setFont(font)
+        self.label_ip_address.setObjectName("label_ip_address")
+        self.gridLayout_7.addWidget(self.label_ip_address, 1, 0, 1, 1)
         self.comboBox_manufacturer = QtWidgets.QComboBox(self.tab_4)
         font = QtGui.QFont()
         font.setPointSize(8)
         self.comboBox_manufacturer.setFont(font)
         self.comboBox_manufacturer.setObjectName("comboBox_manufacturer")
         self.gridLayout_7.addWidget(self.comboBox_manufacturer, 3, 1, 1, 1)
         self.lineEdit_ipadress = QtWidgets.QLineEdit(self.tab_4)
         self.lineEdit_ipadress.setObjectName("lineEdit_ipadress")
         self.gridLayout_7.addWidget(self.lineEdit_ipadress, 1, 1, 1, 1)
+        self.microscope_button = QtWidgets.QPushButton(self.tab_4)
+        font = QtGui.QFont()
+        font.setPointSize(8)
+        self.microscope_button.setFont(font)
+        self.microscope_button.setObjectName("microscope_button")
+        self.gridLayout_7.addWidget(self.microscope_button, 4, 0, 1, 2)
+        self.label_manufacturer = QtWidgets.QLabel(self.tab_4)
+        font = QtGui.QFont()
+        font.setPointSize(8)
+        self.label_manufacturer.setFont(font)
+        self.label_manufacturer.setObjectName("label_manufacturer")
+        self.gridLayout_7.addWidget(self.label_manufacturer, 3, 0, 1, 1)
         spacerItem = QtWidgets.QSpacerItem(20, 40, QtWidgets.QSizePolicy.Minimum, QtWidgets.QSizePolicy.Expanding)
         self.gridLayout_7.addItem(spacerItem, 5, 0, 1, 1)
         self.tabWidget.addTab(self.tab_4, "")
         self.stage_tab = QtWidgets.QWidget()
         self.stage_tab.setObjectName("stage_tab")
         self.gridLayout_2 = QtWidgets.QGridLayout(self.stage_tab)
         self.gridLayout_2.setObjectName("gridLayout_2")
-        self.needleStageHeightLimitnMmDoubleSpinBox = QtWidgets.QDoubleSpinBox(self.stage_tab)
-        self.needleStageHeightLimitnMmDoubleSpinBox.setMinimum(-99.0)
-        self.needleStageHeightLimitnMmDoubleSpinBox.setObjectName("needleStageHeightLimitnMmDoubleSpinBox")
-        self.gridLayout_2.addWidget(self.needleStageHeightLimitnMmDoubleSpinBox, 6, 1, 1, 1)
-        self.rotationFlatToIonLabel = QtWidgets.QLabel(self.stage_tab)
-        self.rotationFlatToIonLabel.setObjectName("rotationFlatToIonLabel")
-        self.gridLayout_2.addWidget(self.rotationFlatToIonLabel, 2, 0, 1, 1)
-        self.label_header_stage = QtWidgets.QLabel(self.stage_tab)
-        font = QtGui.QFont()
-        font.setPointSize(10)
-        font.setBold(True)
-        font.setWeight(75)
-        self.label_header_stage.setFont(font)
-        self.label_header_stage.setObjectName("label_header_stage")
-        self.gridLayout_2.addWidget(self.label_header_stage, 0, 0, 1, 1)
-        self.needleStageHeightLimitnMmLabel = QtWidgets.QLabel(self.stage_tab)
-        self.needleStageHeightLimitnMmLabel.setObjectName("needleStageHeightLimitnMmLabel")
-        self.gridLayout_2.addWidget(self.needleStageHeightLimitnMmLabel, 6, 0, 1, 1)
+        self.preTiltLabel = QtWidgets.QLabel(self.stage_tab)
+        self.preTiltLabel.setObjectName("preTiltLabel")
+        self.gridLayout_2.addWidget(self.preTiltLabel, 5, 0, 1, 1)
+        self.tiltFlatToIonLabel = QtWidgets.QLabel(self.stage_tab)
+        self.tiltFlatToIonLabel.setObjectName("tiltFlatToIonLabel")
+        self.gridLayout_2.addWidget(self.tiltFlatToIonLabel, 4, 0, 1, 1)
         self.tiltFlatToElectronLabel = QtWidgets.QLabel(self.stage_tab)
         self.tiltFlatToElectronLabel.setObjectName("tiltFlatToElectronLabel")
         self.gridLayout_2.addWidget(self.tiltFlatToElectronLabel, 3, 0, 1, 1)
-        self.rotationFlatToIonSpinBox = QtWidgets.QDoubleSpinBox(self.stage_tab)
-        self.rotationFlatToIonSpinBox.setMinimum(-360.0)
-        self.rotationFlatToIonSpinBox.setMaximum(360.0)
-        self.rotationFlatToIonSpinBox.setObjectName("rotationFlatToIonSpinBox")
-        self.gridLayout_2.addWidget(self.rotationFlatToIonSpinBox, 2, 1, 1, 1)
         self.rotationFlatToElectronSpinBox = QtWidgets.QDoubleSpinBox(self.stage_tab)
         self.rotationFlatToElectronSpinBox.setMinimum(-360.0)
         self.rotationFlatToElectronSpinBox.setMaximum(360.0)
         self.rotationFlatToElectronSpinBox.setObjectName("rotationFlatToElectronSpinBox")
         self.gridLayout_2.addWidget(self.rotationFlatToElectronSpinBox, 1, 1, 1, 1)
-        self.tiltFlatToIonLabel = QtWidgets.QLabel(self.stage_tab)
-        self.tiltFlatToIonLabel.setObjectName("tiltFlatToIonLabel")
-        self.gridLayout_2.addWidget(self.tiltFlatToIonLabel, 4, 0, 1, 1)
+        self.rotationFlatToElectronLabel = QtWidgets.QLabel(self.stage_tab)
+        self.rotationFlatToElectronLabel.setObjectName("rotationFlatToElectronLabel")
+        self.gridLayout_2.addWidget(self.rotationFlatToElectronLabel, 1, 0, 1, 1)
+        self.tiltFlatToElectronSpinBox = QtWidgets.QDoubleSpinBox(self.stage_tab)
+        self.tiltFlatToElectronSpinBox.setMinimum(-360.0)
+        self.tiltFlatToElectronSpinBox.setMaximum(360.0)
+        self.tiltFlatToElectronSpinBox.setObjectName("tiltFlatToElectronSpinBox")
+        self.gridLayout_2.addWidget(self.tiltFlatToElectronSpinBox, 3, 1, 1, 1)
+        self.rotationFlatToIonLabel = QtWidgets.QLabel(self.stage_tab)
+        self.rotationFlatToIonLabel.setObjectName("rotationFlatToIonLabel")
+        self.gridLayout_2.addWidget(self.rotationFlatToIonLabel, 2, 0, 1, 1)
         self.tiltFlatToIonSpinBox = QtWidgets.QDoubleSpinBox(self.stage_tab)
         self.tiltFlatToIonSpinBox.setMinimum(-360.0)
         self.tiltFlatToIonSpinBox.setMaximum(360.0)
         self.tiltFlatToIonSpinBox.setObjectName("tiltFlatToIonSpinBox")
         self.gridLayout_2.addWidget(self.tiltFlatToIonSpinBox, 4, 1, 1, 1)
-        self.preTiltLabel = QtWidgets.QLabel(self.stage_tab)
-        self.preTiltLabel.setObjectName("preTiltLabel")
-        self.gridLayout_2.addWidget(self.preTiltLabel, 5, 0, 1, 1)
+        self.needleStageHeightLimitnMmDoubleSpinBox = QtWidgets.QDoubleSpinBox(self.stage_tab)
+        self.needleStageHeightLimitnMmDoubleSpinBox.setMinimum(-99.0)
+        self.needleStageHeightLimitnMmDoubleSpinBox.setObjectName("needleStageHeightLimitnMmDoubleSpinBox")
+        self.gridLayout_2.addWidget(self.needleStageHeightLimitnMmDoubleSpinBox, 6, 1, 1, 1)
         self.preTiltSpinBox = QtWidgets.QDoubleSpinBox(self.stage_tab)
         self.preTiltSpinBox.setObjectName("preTiltSpinBox")
         self.gridLayout_2.addWidget(self.preTiltSpinBox, 5, 1, 1, 1)
+        self.rotationFlatToIonSpinBox = QtWidgets.QDoubleSpinBox(self.stage_tab)
+        self.rotationFlatToIonSpinBox.setMinimum(-360.0)
+        self.rotationFlatToIonSpinBox.setMaximum(360.0)
+        self.rotationFlatToIonSpinBox.setObjectName("rotationFlatToIonSpinBox")
+        self.gridLayout_2.addWidget(self.rotationFlatToIonSpinBox, 2, 1, 1, 1)
+        self.needleStageHeightLimitnMmLabel = QtWidgets.QLabel(self.stage_tab)
+        self.needleStageHeightLimitnMmLabel.setObjectName("needleStageHeightLimitnMmLabel")
+        self.gridLayout_2.addWidget(self.needleStageHeightLimitnMmLabel, 6, 0, 1, 1)
+        self.label_header_stage = QtWidgets.QLabel(self.stage_tab)
+        font = QtGui.QFont()
+        font.setPointSize(10)
+        font.setBold(True)
+        font.setWeight(75)
+        self.label_header_stage.setFont(font)
+        self.label_header_stage.setObjectName("label_header_stage")
+        self.gridLayout_2.addWidget(self.label_header_stage, 0, 0, 1, 1)
+        spacerItem1 = QtWidgets.QSpacerItem(20, 40, QtWidgets.QSizePolicy.Minimum, QtWidgets.QSizePolicy.Expanding)
+        self.gridLayout_2.addItem(spacerItem1, 7, 0, 1, 2)
         self.setStage_button = QtWidgets.QPushButton(self.stage_tab)
         self.setStage_button.setObjectName("setStage_button")
         self.gridLayout_2.addWidget(self.setStage_button, 0, 1, 1, 1)
-        self.rotationFlatToElectronLabel = QtWidgets.QLabel(self.stage_tab)
-        self.rotationFlatToElectronLabel.setObjectName("rotationFlatToElectronLabel")
-        self.gridLayout_2.addWidget(self.rotationFlatToElectronLabel, 1, 0, 1, 1)
-        self.tiltFlatToElectronSpinBox = QtWidgets.QDoubleSpinBox(self.stage_tab)
-        self.tiltFlatToElectronSpinBox.setMinimum(-360.0)
-        self.tiltFlatToElectronSpinBox.setMaximum(360.0)
-        self.tiltFlatToElectronSpinBox.setObjectName("tiltFlatToElectronSpinBox")
-        self.gridLayout_2.addWidget(self.tiltFlatToElectronSpinBox, 3, 1, 1, 1)
-        spacerItem1 = QtWidgets.QSpacerItem(20, 40, QtWidgets.QSizePolicy.Minimum, QtWidgets.QSizePolicy.Expanding)
-        self.gridLayout_2.addItem(spacerItem1, 7, 0, 1, 1)
         self.tabWidget.addTab(self.stage_tab, "")
         self.tab_microscope = QtWidgets.QWidget()
         self.tab_microscope.setObjectName("tab_microscope")
         self.gridLayout_3 = QtWidgets.QGridLayout(self.tab_microscope)
         self.gridLayout_3.setObjectName("gridLayout_3")
-        self.checkBox_stage_tilt = QtWidgets.QCheckBox(self.tab_microscope)
-        self.checkBox_stage_tilt.setChecked(True)
-        self.checkBox_stage_tilt.setObjectName("checkBox_stage_tilt")
-        self.gridLayout_3.addWidget(self.checkBox_stage_tilt, 7, 1, 1, 1)
+        self.checkBox_eb = QtWidgets.QCheckBox(self.tab_microscope)
+        self.checkBox_eb.setChecked(True)
+        self.checkBox_eb.setObjectName("checkBox_eb")
+        self.gridLayout_3.addWidget(self.checkBox_eb, 1, 1, 1, 1)
+        spacerItem2 = QtWidgets.QSpacerItem(20, 40, QtWidgets.QSizePolicy.Minimum, QtWidgets.QSizePolicy.Expanding)
+        self.gridLayout_3.addItem(spacerItem2, 17, 0, 1, 2)
+        self.line_3 = QtWidgets.QFrame(self.tab_microscope)
+        self.line_3.setFrameShape(QtWidgets.QFrame.HLine)
+        self.line_3.setFrameShadow(QtWidgets.QFrame.Sunken)
+        self.line_3.setObjectName("line_3")
+        self.gridLayout_3.addWidget(self.line_3, 10, 0, 1, 2)
+        self.checkBox_gis_enabled = QtWidgets.QCheckBox(self.tab_microscope)
+        self.checkBox_gis_enabled.setChecked(True)
+        self.checkBox_gis_enabled.setObjectName("checkBox_gis_enabled")
+        self.gridLayout_3.addWidget(self.checkBox_gis_enabled, 15, 1, 1, 1)
+        self.checkBox_needle_enabled = QtWidgets.QCheckBox(self.tab_microscope)
+        self.checkBox_needle_enabled.setChecked(True)
+        self.checkBox_needle_enabled.setObjectName("checkBox_needle_enabled")
+        self.gridLayout_3.addWidget(self.checkBox_needle_enabled, 11, 1, 1, 1)
         self.label_5 = QtWidgets.QLabel(self.tab_microscope)
         font = QtGui.QFont()
         font.setPointSize(8)
         font.setUnderline(True)
         self.label_5.setFont(font)
         self.label_5.setObjectName("label_5")
-        self.gridLayout_3.addWidget(self.label_5, 9, 0, 1, 1)
-        self.line_2 = QtWidgets.QFrame(self.tab_microscope)
-        self.line_2.setFrameShape(QtWidgets.QFrame.HLine)
-        self.line_2.setFrameShadow(QtWidgets.QFrame.Sunken)
-        self.line_2.setObjectName("line_2")
-        self.gridLayout_3.addWidget(self.line_2, 4, 0, 1, 2)
-        self.checkBox_stage_enabled = QtWidgets.QCheckBox(self.tab_microscope)
-        self.checkBox_stage_enabled.setChecked(True)
-        self.checkBox_stage_enabled.setObjectName("checkBox_stage_enabled")
-        self.gridLayout_3.addWidget(self.checkBox_stage_enabled, 5, 1, 1, 1)
-        self.label_3 = QtWidgets.QLabel(self.tab_microscope)
-        font = QtGui.QFont()
-        font.setPointSize(8)
-        font.setUnderline(True)
-        self.label_3.setFont(font)
-        self.label_3.setObjectName("label_3")
-        self.gridLayout_3.addWidget(self.label_3, 3, 0, 1, 1)
+        self.gridLayout_3.addWidget(self.label_5, 11, 0, 1, 1)
         self.checkBox_stage_rotation = QtWidgets.QCheckBox(self.tab_microscope)
         self.checkBox_stage_rotation.setChecked(True)
         self.checkBox_stage_rotation.setObjectName("checkBox_stage_rotation")
-        self.gridLayout_3.addWidget(self.checkBox_stage_rotation, 6, 1, 1, 1)
-        spacerItem2 = QtWidgets.QSpacerItem(40, 20, QtWidgets.QSizePolicy.Expanding, QtWidgets.QSizePolicy.Minimum)
-        self.gridLayout_3.addItem(spacerItem2, 5, 2, 1, 1)
-        self.checkBox_ib = QtWidgets.QCheckBox(self.tab_microscope)
-        self.checkBox_ib.setChecked(True)
-        self.checkBox_ib.setObjectName("checkBox_ib")
-        self.gridLayout_3.addWidget(self.checkBox_ib, 3, 1, 1, 1)
-        self.checkBox_eb = QtWidgets.QCheckBox(self.tab_microscope)
-        self.checkBox_eb.setChecked(True)
-        self.checkBox_eb.setObjectName("checkBox_eb")
-        self.gridLayout_3.addWidget(self.checkBox_eb, 1, 1, 1, 1)
-        self.checkBox_needle_rotation = QtWidgets.QCheckBox(self.tab_microscope)
-        self.checkBox_needle_rotation.setChecked(True)
-        self.checkBox_needle_rotation.setObjectName("checkBox_needle_rotation")
-        self.gridLayout_3.addWidget(self.checkBox_needle_rotation, 10, 1, 1, 1)
+        self.gridLayout_3.addWidget(self.checkBox_stage_rotation, 8, 1, 1, 1)
+        self.label_4 = QtWidgets.QLabel(self.tab_microscope)
+        font = QtGui.QFont()
+        font.setPointSize(8)
+        font.setUnderline(True)
+        self.label_4.setFont(font)
+        self.label_4.setObjectName("label_4")
+        self.gridLayout_3.addWidget(self.label_4, 7, 0, 1, 1)
         self.label = QtWidgets.QLabel(self.tab_microscope)
         font = QtGui.QFont()
         font.setPointSize(10)
         font.setBold(True)
         font.setWeight(75)
         self.label.setFont(font)
         self.label.setObjectName("label")
         self.gridLayout_3.addWidget(self.label, 0, 0, 1, 1)
-        self.line_3 = QtWidgets.QFrame(self.tab_microscope)
-        self.line_3.setFrameShape(QtWidgets.QFrame.HLine)
-        self.line_3.setFrameShadow(QtWidgets.QFrame.Sunken)
-        self.line_3.setObjectName("line_3")
-        self.gridLayout_3.addWidget(self.line_3, 8, 0, 1, 2)
+        self.checkBox_ib = QtWidgets.QCheckBox(self.tab_microscope)
+        self.checkBox_ib.setChecked(True)
+        self.checkBox_ib.setObjectName("checkBox_ib")
+        self.gridLayout_3.addWidget(self.checkBox_ib, 3, 1, 1, 1)
         self.line_4 = QtWidgets.QFrame(self.tab_microscope)
         self.line_4.setFrameShape(QtWidgets.QFrame.HLine)
         self.line_4.setFrameShadow(QtWidgets.QFrame.Sunken)
         self.line_4.setObjectName("line_4")
-        self.gridLayout_3.addWidget(self.line_4, 12, 0, 1, 2)
-        self.line = QtWidgets.QFrame(self.tab_microscope)
-        self.line.setFrameShape(QtWidgets.QFrame.HLine)
-        self.line.setFrameShadow(QtWidgets.QFrame.Sunken)
-        self.line.setObjectName("line")
-        self.gridLayout_3.addWidget(self.line, 2, 0, 1, 2)
-        self.checkBox_gis_enabled = QtWidgets.QCheckBox(self.tab_microscope)
-        self.checkBox_gis_enabled.setChecked(True)
-        self.checkBox_gis_enabled.setObjectName("checkBox_gis_enabled")
-        self.gridLayout_3.addWidget(self.checkBox_gis_enabled, 13, 1, 1, 1)
+        self.gridLayout_3.addWidget(self.line_4, 14, 0, 1, 2)
+        self.checkBox_needle_rotation = QtWidgets.QCheckBox(self.tab_microscope)
+        self.checkBox_needle_rotation.setChecked(True)
+        self.checkBox_needle_rotation.setObjectName("checkBox_needle_rotation")
+        self.gridLayout_3.addWidget(self.checkBox_needle_rotation, 12, 1, 1, 1)
+        self.checkBox_stage_enabled = QtWidgets.QCheckBox(self.tab_microscope)
+        self.checkBox_stage_enabled.setChecked(True)
+        self.checkBox_stage_enabled.setObjectName("checkBox_stage_enabled")
+        self.gridLayout_3.addWidget(self.checkBox_stage_enabled, 7, 1, 1, 1)
+        self.checkBox_multichem = QtWidgets.QCheckBox(self.tab_microscope)
+        self.checkBox_multichem.setChecked(True)
+        self.checkBox_multichem.setObjectName("checkBox_multichem")
+        self.gridLayout_3.addWidget(self.checkBox_multichem, 16, 1, 1, 1)
+        self.label_6 = QtWidgets.QLabel(self.tab_microscope)
+        font = QtGui.QFont()
+        font.setPointSize(8)
+        font.setUnderline(True)
+        self.label_6.setFont(font)
+        self.label_6.setObjectName("label_6")
+        self.gridLayout_3.addWidget(self.label_6, 15, 0, 1, 1)
         self.checkBox_needle_tilt = QtWidgets.QCheckBox(self.tab_microscope)
         self.checkBox_needle_tilt.setChecked(True)
         self.checkBox_needle_tilt.setObjectName("checkBox_needle_tilt")
-        self.gridLayout_3.addWidget(self.checkBox_needle_tilt, 11, 1, 1, 1)
-        self.label_4 = QtWidgets.QLabel(self.tab_microscope)
+        self.gridLayout_3.addWidget(self.checkBox_needle_tilt, 13, 1, 1, 1)
+        self.label_3 = QtWidgets.QLabel(self.tab_microscope)
         font = QtGui.QFont()
         font.setPointSize(8)
         font.setUnderline(True)
-        self.label_4.setFont(font)
-        self.label_4.setObjectName("label_4")
-        self.gridLayout_3.addWidget(self.label_4, 5, 0, 1, 1)
+        self.label_3.setFont(font)
+        self.label_3.setObjectName("label_3")
+        self.gridLayout_3.addWidget(self.label_3, 3, 0, 1, 1)
+        self.line_2 = QtWidgets.QFrame(self.tab_microscope)
+        self.line_2.setFrameShape(QtWidgets.QFrame.HLine)
+        self.line_2.setFrameShadow(QtWidgets.QFrame.Sunken)
+        self.line_2.setObjectName("line_2")
+        self.gridLayout_3.addWidget(self.line_2, 6, 0, 1, 2)
         self.label_2 = QtWidgets.QLabel(self.tab_microscope)
         font = QtGui.QFont()
         font.setPointSize(8)
         font.setUnderline(True)
         self.label_2.setFont(font)
         self.label_2.setObjectName("label_2")
         self.gridLayout_3.addWidget(self.label_2, 1, 0, 1, 1)
-        self.label_6 = QtWidgets.QLabel(self.tab_microscope)
-        font = QtGui.QFont()
-        font.setPointSize(8)
-        font.setUnderline(True)
-        self.label_6.setFont(font)
-        self.label_6.setObjectName("label_6")
-        self.gridLayout_3.addWidget(self.label_6, 13, 0, 1, 1)
-        self.checkBox_needle_enabled = QtWidgets.QCheckBox(self.tab_microscope)
-        self.checkBox_needle_enabled.setChecked(True)
-        self.checkBox_needle_enabled.setObjectName("checkBox_needle_enabled")
-        self.gridLayout_3.addWidget(self.checkBox_needle_enabled, 9, 1, 1, 1)
-        self.checkBox_multichem = QtWidgets.QCheckBox(self.tab_microscope)
-        self.checkBox_multichem.setChecked(True)
-        self.checkBox_multichem.setObjectName("checkBox_multichem")
-        self.gridLayout_3.addWidget(self.checkBox_multichem, 14, 1, 1, 1)
-        spacerItem3 = QtWidgets.QSpacerItem(20, 40, QtWidgets.QSizePolicy.Minimum, QtWidgets.QSizePolicy.Expanding)
-        self.gridLayout_3.addItem(spacerItem3, 15, 1, 1, 1)
-        self.pushButton_save_model = QtWidgets.QPushButton(self.tab_microscope)
-        self.pushButton_save_model.setObjectName("pushButton_save_model")
-        self.gridLayout_3.addWidget(self.pushButton_save_model, 0, 2, 1, 1)
+        self.line = QtWidgets.QFrame(self.tab_microscope)
+        self.line.setFrameShape(QtWidgets.QFrame.HLine)
+        self.line.setFrameShadow(QtWidgets.QFrame.Sunken)
+        self.line.setObjectName("line")
+        self.gridLayout_3.addWidget(self.line, 2, 0, 1, 2)
+        self.checkBox_stage_tilt = QtWidgets.QCheckBox(self.tab_microscope)
+        self.checkBox_stage_tilt.setChecked(True)
+        self.checkBox_stage_tilt.setObjectName("checkBox_stage_tilt")
+        self.gridLayout_3.addWidget(self.checkBox_stage_tilt, 9, 1, 1, 1)
+        self.checkBox_select_plasma_gas = QtWidgets.QCheckBox(self.tab_microscope)
+        self.checkBox_select_plasma_gas.setObjectName("checkBox_select_plasma_gas")
+        self.gridLayout_3.addWidget(self.checkBox_select_plasma_gas, 4, 1, 1, 1)
         self.tabWidget.addTab(self.tab_microscope, "")
         self.tab = QtWidgets.QWidget()
         self.tab.setObjectName("tab")
         self.gridLayout_4 = QtWidgets.QGridLayout(self.tab)
         self.gridLayout_4.setObjectName("gridLayout_4")
         self.tabWidget_2 = QtWidgets.QTabWidget(self.tab)
         font = QtGui.QFont()
         font.setPointSize(8)
         self.tabWidget_2.setFont(font)
         self.tabWidget_2.setObjectName("tabWidget_2")
         self.tab_2 = QtWidgets.QWidget()
         self.tab_2.setObjectName("tab_2")
         self.gridLayout_5 = QtWidgets.QGridLayout(self.tab_2)
         self.gridLayout_5.setObjectName("gridLayout_5")
-        self.spinBox_ion_voltage = QtWidgets.QSpinBox(self.tab_2)
-        self.spinBox_ion_voltage.setMaximum(100000)
-        self.spinBox_ion_voltage.setObjectName("spinBox_ion_voltage")
-        self.gridLayout_5.addWidget(self.spinBox_ion_voltage, 1, 1, 1, 1)
-        self.label_21 = QtWidgets.QLabel(self.tab_2)
-        self.label_21.setObjectName("label_21")
-        self.gridLayout_5.addWidget(self.label_21, 14, 0, 1, 1)
-        self.label_23 = QtWidgets.QLabel(self.tab_2)
-        self.label_23.setObjectName("label_23")
-        self.gridLayout_5.addWidget(self.label_23, 16, 0, 1, 1)
-        self.lineEdit_detector_type_eb = QtWidgets.QLineEdit(self.tab_2)
-        self.lineEdit_detector_type_eb.setObjectName("lineEdit_detector_type_eb")
-        self.gridLayout_5.addWidget(self.lineEdit_detector_type_eb, 11, 1, 1, 1)
-        self.spinBox_voltage_eb = QtWidgets.QSpinBox(self.tab_2)
-        self.spinBox_voltage_eb.setMaximum(1000000)
-        self.spinBox_voltage_eb.setObjectName("spinBox_voltage_eb")
-        self.gridLayout_5.addWidget(self.spinBox_voltage_eb, 8, 1, 1, 1)
+        self.label_19 = QtWidgets.QLabel(self.tab_2)
+        self.label_19.setObjectName("label_19")
+        self.gridLayout_5.addWidget(self.label_19, 12, 0, 1, 1)
         self.lineEdit_detector_mode_eb = QtWidgets.QLineEdit(self.tab_2)
         self.lineEdit_detector_mode_eb.setObjectName("lineEdit_detector_mode_eb")
         self.gridLayout_5.addWidget(self.lineEdit_detector_mode_eb, 12, 1, 1, 1)
+        self.label_13 = QtWidgets.QLabel(self.tab_2)
+        self.label_13.setObjectName("label_13")
+        self.gridLayout_5.addWidget(self.label_13, 6, 0, 1, 1)
         self.doubleSpinBox_height_ion = QtWidgets.QDoubleSpinBox(self.tab_2)
         self.doubleSpinBox_height_ion.setDecimals(4)
         self.doubleSpinBox_height_ion.setObjectName("doubleSpinBox_height_ion")
         self.gridLayout_5.addWidget(self.doubleSpinBox_height_ion, 4, 1, 1, 1)
-        self.label_16 = QtWidgets.QLabel(self.tab_2)
-        self.label_16.setObjectName("label_16")
-        self.gridLayout_5.addWidget(self.label_16, 9, 0, 1, 1)
-        self.label_20 = QtWidgets.QLabel(self.tab_2)
-        font = QtGui.QFont()
-        font.setPointSize(10)
-        font.setUnderline(True)
-        self.label_20.setFont(font)
-        self.label_20.setObjectName("label_20")
-        self.gridLayout_5.addWidget(self.label_20, 13, 0, 1, 2)
         self.doubleSpinBox_height_eb = QtWidgets.QDoubleSpinBox(self.tab_2)
         self.doubleSpinBox_height_eb.setDecimals(4)
         self.doubleSpinBox_height_eb.setObjectName("doubleSpinBox_height_eb")
         self.gridLayout_5.addWidget(self.doubleSpinBox_height_eb, 10, 1, 1, 1)
-        self.label_19 = QtWidgets.QLabel(self.tab_2)
-        self.label_19.setObjectName("label_19")
-        self.gridLayout_5.addWidget(self.label_19, 12, 0, 1, 1)
-        self.label_25 = QtWidgets.QLabel(self.tab_2)
-        self.label_25.setObjectName("label_25")
-        self.gridLayout_5.addWidget(self.label_25, 18, 0, 1, 1)
-        self.lineEdit_plasma_gas = QtWidgets.QLineEdit(self.tab_2)
-        self.lineEdit_plasma_gas.setObjectName("lineEdit_plasma_gas")
-        self.gridLayout_5.addWidget(self.lineEdit_plasma_gas, 3, 1, 1, 1)
-        self.label_7 = QtWidgets.QLabel(self.tab_2)
-        font = QtGui.QFont()
-        font.setPointSize(10)
-        font.setUnderline(True)
-        self.label_7.setFont(font)
-        self.label_7.setObjectName("label_7")
-        self.gridLayout_5.addWidget(self.label_7, 0, 0, 1, 2)
-        spacerItem4 = QtWidgets.QSpacerItem(20, 40, QtWidgets.QSizePolicy.Minimum, QtWidgets.QSizePolicy.Expanding)
-        self.gridLayout_5.addItem(spacerItem4, 20, 1, 1, 1)
+        self.label_8 = QtWidgets.QLabel(self.tab_2)
+        self.label_8.setObjectName("label_8")
+        self.gridLayout_5.addWidget(self.label_8, 1, 0, 1, 1)
+        self.label_12 = QtWidgets.QLabel(self.tab_2)
+        self.label_12.setObjectName("label_12")
+        self.gridLayout_5.addWidget(self.label_12, 5, 0, 1, 1)
         self.label_14 = QtWidgets.QLabel(self.tab_2)
         font = QtGui.QFont()
         font.setPointSize(10)
         font.setUnderline(True)
         self.label_14.setFont(font)
         self.label_14.setObjectName("label_14")
         self.gridLayout_5.addWidget(self.label_14, 7, 0, 1, 2)
-        self.label_12 = QtWidgets.QLabel(self.tab_2)
-        self.label_12.setObjectName("label_12")
-        self.gridLayout_5.addWidget(self.label_12, 5, 0, 1, 1)
-        self.label_24 = QtWidgets.QLabel(self.tab_2)
-        self.label_24.setObjectName("label_24")
-        self.gridLayout_5.addWidget(self.label_24, 17, 0, 1, 1)
-        self.label_17 = QtWidgets.QLabel(self.tab_2)
-        self.label_17.setObjectName("label_17")
-        self.gridLayout_5.addWidget(self.label_17, 10, 0, 1, 1)
+        self.label_7 = QtWidgets.QLabel(self.tab_2)
+        font = QtGui.QFont()
+        font.setPointSize(10)
+        font.setUnderline(True)
+        self.label_7.setFont(font)
+        self.label_7.setObjectName("label_7")
+        self.gridLayout_5.addWidget(self.label_7, 0, 0, 1, 2)
+        self.lineEdit_detector_type_eb = QtWidgets.QLineEdit(self.tab_2)
+        self.lineEdit_detector_type_eb.setObjectName("lineEdit_detector_type_eb")
+        self.gridLayout_5.addWidget(self.lineEdit_detector_type_eb, 11, 1, 1, 1)
+        self.lineEdit_plasma_gas = QtWidgets.QLineEdit(self.tab_2)
+        self.lineEdit_plasma_gas.setObjectName("lineEdit_plasma_gas")
+        self.gridLayout_5.addWidget(self.lineEdit_plasma_gas, 3, 1, 1, 1)
+        self.doubleSpinBox_current_eb = QtWidgets.QDoubleSpinBox(self.tab_2)
+        self.doubleSpinBox_current_eb.setDecimals(4)
+        self.doubleSpinBox_current_eb.setMaximum(100000.0)
+        self.doubleSpinBox_current_eb.setObjectName("doubleSpinBox_current_eb")
+        self.gridLayout_5.addWidget(self.doubleSpinBox_current_eb, 9, 1, 1, 1)
         self.label_15 = QtWidgets.QLabel(self.tab_2)
         self.label_15.setObjectName("label_15")
         self.gridLayout_5.addWidget(self.label_15, 8, 0, 1, 1)
         self.lineEdit_detector_type_ion = QtWidgets.QLineEdit(self.tab_2)
         self.lineEdit_detector_type_ion.setObjectName("lineEdit_detector_type_ion")
         self.gridLayout_5.addWidget(self.lineEdit_detector_type_ion, 5, 1, 1, 1)
+        self.label_17 = QtWidgets.QLabel(self.tab_2)
+        self.label_17.setObjectName("label_17")
+        self.gridLayout_5.addWidget(self.label_17, 10, 0, 1, 1)
+        self.doubleSpinBox_ion_current = QtWidgets.QDoubleSpinBox(self.tab_2)
+        self.doubleSpinBox_ion_current.setDecimals(4)
+        self.doubleSpinBox_ion_current.setMaximum(1000000.0)
+        self.doubleSpinBox_ion_current.setObjectName("doubleSpinBox_ion_current")
+        self.gridLayout_5.addWidget(self.doubleSpinBox_ion_current, 2, 1, 1, 1)
+        self.spinBox_voltage_eb = QtWidgets.QSpinBox(self.tab_2)
+        self.spinBox_voltage_eb.setMaximum(1000000)
+        self.spinBox_voltage_eb.setObjectName("spinBox_voltage_eb")
+        self.gridLayout_5.addWidget(self.spinBox_voltage_eb, 8, 1, 1, 1)
+        self.label_9 = QtWidgets.QLabel(self.tab_2)
+        self.label_9.setObjectName("label_9")
+        self.gridLayout_5.addWidget(self.label_9, 2, 0, 1, 1)
         self.label_18 = QtWidgets.QLabel(self.tab_2)
         self.label_18.setObjectName("label_18")
         self.gridLayout_5.addWidget(self.label_18, 11, 0, 1, 1)
-        self.doubleSpinBox_current_eb = QtWidgets.QDoubleSpinBox(self.tab_2)
-        self.doubleSpinBox_current_eb.setDecimals(4)
-        self.doubleSpinBox_current_eb.setMaximum(100000.0)
-        self.doubleSpinBox_current_eb.setObjectName("doubleSpinBox_current_eb")
-        self.gridLayout_5.addWidget(self.doubleSpinBox_current_eb, 9, 1, 1, 1)
-        self.label_22 = QtWidgets.QLabel(self.tab_2)
-        self.label_22.setObjectName("label_22")
-        self.gridLayout_5.addWidget(self.label_22, 15, 0, 1, 1)
-        self.label_11 = QtWidgets.QLabel(self.tab_2)
-        self.label_11.setObjectName("label_11")
-        self.gridLayout_5.addWidget(self.label_11, 4, 0, 1, 1)
-        self.label_13 = QtWidgets.QLabel(self.tab_2)
-        self.label_13.setObjectName("label_13")
-        self.gridLayout_5.addWidget(self.label_13, 6, 0, 1, 1)
         self.label_10 = QtWidgets.QLabel(self.tab_2)
         self.label_10.setObjectName("label_10")
         self.gridLayout_5.addWidget(self.label_10, 3, 0, 1, 1)
-        self.label_9 = QtWidgets.QLabel(self.tab_2)
-        self.label_9.setObjectName("label_9")
-        self.gridLayout_5.addWidget(self.label_9, 2, 0, 1, 1)
-        self.doubleSpinBox_ion_current = QtWidgets.QDoubleSpinBox(self.tab_2)
-        self.doubleSpinBox_ion_current.setDecimals(4)
-        self.doubleSpinBox_ion_current.setMaximum(1000000.0)
-        self.doubleSpinBox_ion_current.setObjectName("doubleSpinBox_ion_current")
-        self.gridLayout_5.addWidget(self.doubleSpinBox_ion_current, 2, 1, 1, 1)
         self.lineEdit_detector_mode_ion = QtWidgets.QLineEdit(self.tab_2)
         self.lineEdit_detector_mode_ion.setObjectName("lineEdit_detector_mode_ion")
         self.gridLayout_5.addWidget(self.lineEdit_detector_mode_ion, 6, 1, 1, 1)
-        self.label_8 = QtWidgets.QLabel(self.tab_2)
-        self.label_8.setObjectName("label_8")
-        self.gridLayout_5.addWidget(self.label_8, 1, 0, 1, 1)
-        self.label_26 = QtWidgets.QLabel(self.tab_2)
-        self.label_26.setObjectName("label_26")
-        self.gridLayout_5.addWidget(self.label_26, 19, 0, 1, 1)
-        self.spinBox_rotation_eb = QtWidgets.QSpinBox(self.tab_2)
-        self.spinBox_rotation_eb.setMaximum(360)
-        self.spinBox_rotation_eb.setObjectName("spinBox_rotation_eb")
-        self.gridLayout_5.addWidget(self.spinBox_rotation_eb, 14, 1, 1, 1)
-        self.spinBox_rotation_ib = QtWidgets.QSpinBox(self.tab_2)
-        self.spinBox_rotation_ib.setMaximum(360)
-        self.spinBox_rotation_ib.setObjectName("spinBox_rotation_ib")
-        self.gridLayout_5.addWidget(self.spinBox_rotation_ib, 15, 1, 1, 1)
-        self.spinBox_tilt_eb = QtWidgets.QSpinBox(self.tab_2)
-        self.spinBox_tilt_eb.setMaximum(360)
-        self.spinBox_tilt_eb.setObjectName("spinBox_tilt_eb")
-        self.gridLayout_5.addWidget(self.spinBox_tilt_eb, 16, 1, 1, 1)
-        self.spinBox_tilt_ib = QtWidgets.QSpinBox(self.tab_2)
-        self.spinBox_tilt_ib.setMaximum(360)
-        self.spinBox_tilt_ib.setObjectName("spinBox_tilt_ib")
-        self.gridLayout_5.addWidget(self.spinBox_tilt_ib, 17, 1, 1, 1)
-        self.spinBox_pretilt = QtWidgets.QSpinBox(self.tab_2)
-        self.spinBox_pretilt.setMaximum(360)
-        self.spinBox_pretilt.setObjectName("spinBox_pretilt")
-        self.gridLayout_5.addWidget(self.spinBox_pretilt, 18, 1, 1, 1)
-        self.doubleSpinBox_needle_height = QtWidgets.QDoubleSpinBox(self.tab_2)
-        self.doubleSpinBox_needle_height.setDecimals(4)
-        self.doubleSpinBox_needle_height.setObjectName("doubleSpinBox_needle_height")
-        self.gridLayout_5.addWidget(self.doubleSpinBox_needle_height, 19, 1, 1, 1)
+        self.label_16 = QtWidgets.QLabel(self.tab_2)
+        self.label_16.setObjectName("label_16")
+        self.gridLayout_5.addWidget(self.label_16, 9, 0, 1, 1)
+        self.label_11 = QtWidgets.QLabel(self.tab_2)
+        self.label_11.setObjectName("label_11")
+        self.gridLayout_5.addWidget(self.label_11, 4, 0, 1, 1)
+        self.spinBox_ion_voltage = QtWidgets.QSpinBox(self.tab_2)
+        self.spinBox_ion_voltage.setMaximum(100000)
+        self.spinBox_ion_voltage.setObjectName("spinBox_ion_voltage")
+        self.gridLayout_5.addWidget(self.spinBox_ion_voltage, 1, 1, 1, 1)
+        spacerItem3 = QtWidgets.QSpacerItem(20, 40, QtWidgets.QSizePolicy.Minimum, QtWidgets.QSizePolicy.Expanding)
+        self.gridLayout_5.addItem(spacerItem3, 15, 1, 1, 1)
+        self.checkBox_apply_settings = QtWidgets.QCheckBox(self.tab_2)
+        self.checkBox_apply_settings.setObjectName("checkBox_apply_settings")
+        self.gridLayout_5.addWidget(self.checkBox_apply_settings, 13, 1, 1, 1)
+        self.checkBox_connect_automatically = QtWidgets.QCheckBox(self.tab_2)
+        self.checkBox_connect_automatically.setObjectName("checkBox_connect_automatically")
+        self.gridLayout_5.addWidget(self.checkBox_connect_automatically, 14, 1, 1, 1)
         self.tabWidget_2.addTab(self.tab_2, "")
         self.tab_3 = QtWidgets.QWidget()
         self.tab_3.setObjectName("tab_3")
         self.gridLayout_6 = QtWidgets.QGridLayout(self.tab_3)
         self.gridLayout_6.setObjectName("gridLayout_6")
         self.label_33 = QtWidgets.QLabel(self.tab_3)
         font = QtGui.QFont()
@@ -435,16 +390,16 @@
         self.gridLayout_6.addWidget(self.label_34, 7, 0, 1, 1)
         self.label_29 = QtWidgets.QLabel(self.tab_3)
         font = QtGui.QFont()
         font.setPointSize(8)
         self.label_29.setFont(font)
         self.label_29.setObjectName("label_29")
         self.gridLayout_6.addWidget(self.label_29, 2, 0, 1, 1)
-        spacerItem5 = QtWidgets.QSpacerItem(20, 40, QtWidgets.QSizePolicy.Minimum, QtWidgets.QSizePolicy.Expanding)
-        self.gridLayout_6.addItem(spacerItem5, 14, 0, 1, 2)
+        spacerItem4 = QtWidgets.QSpacerItem(20, 40, QtWidgets.QSizePolicy.Minimum, QtWidgets.QSizePolicy.Expanding)
+        self.gridLayout_6.addItem(spacerItem4, 14, 0, 1, 2)
         self.label_39 = QtWidgets.QLabel(self.tab_3)
         font = QtGui.QFont()
         font.setPointSize(8)
         self.label_39.setFont(font)
         self.label_39.setObjectName("label_39")
         self.gridLayout_6.addWidget(self.label_39, 12, 0, 1, 1)
         self.label_27 = QtWidgets.QLabel(self.tab_3)
@@ -529,94 +484,98 @@
         self.doubleSpinBox_dwell_time_milling = QtWidgets.QDoubleSpinBox(self.tab_3)
         self.doubleSpinBox_dwell_time_milling.setDecimals(4)
         self.doubleSpinBox_dwell_time_milling.setMaximum(100000.0)
         self.doubleSpinBox_dwell_time_milling.setObjectName("doubleSpinBox_dwell_time_milling")
         self.gridLayout_6.addWidget(self.doubleSpinBox_dwell_time_milling, 4, 1, 1, 2)
         self.doubleSpinBox_rate = QtWidgets.QDoubleSpinBox(self.tab_3)
         self.doubleSpinBox_rate.setDecimals(4)
+        self.doubleSpinBox_rate.setMaximum(1000000.0)
         self.doubleSpinBox_rate.setObjectName("doubleSpinBox_rate")
         self.gridLayout_6.addWidget(self.doubleSpinBox_rate, 3, 1, 1, 2)
         self.doubleSpinBox_spotsize = QtWidgets.QDoubleSpinBox(self.tab_3)
         self.doubleSpinBox_spotsize.setDecimals(4)
         self.doubleSpinBox_spotsize.setMaximum(100000.0)
         self.doubleSpinBox_spotsize.setObjectName("doubleSpinBox_spotsize")
         self.gridLayout_6.addWidget(self.doubleSpinBox_spotsize, 2, 1, 1, 2)
         self.doubleSpinBox_milling_current = QtWidgets.QDoubleSpinBox(self.tab_3)
         self.doubleSpinBox_milling_current.setDecimals(4)
         self.doubleSpinBox_milling_current.setMaximum(100000.0)
         self.doubleSpinBox_milling_current.setObjectName("doubleSpinBox_milling_current")
         self.gridLayout_6.addWidget(self.doubleSpinBox_milling_current, 1, 1, 1, 2)
         self.tabWidget_2.addTab(self.tab_3, "")
-        self.gridLayout_4.addWidget(self.tabWidget_2, 1, 0, 1, 1)
-        self.pushButton_save_defaults = QtWidgets.QPushButton(self.tab)
-        self.pushButton_save_defaults.setObjectName("pushButton_save_defaults")
-        self.gridLayout_4.addWidget(self.pushButton_save_defaults, 0, 0, 1, 1)
+        self.gridLayout_4.addWidget(self.tabWidget_2, 0, 0, 1, 1)
         self.tabWidget.addTab(self.tab, "")
         self.gridLayout.addWidget(self.tabWidget, 13, 0, 1, 2)
+        spacerItem5 = QtWidgets.QSpacerItem(20, 40, QtWidgets.QSizePolicy.Minimum, QtWidgets.QSizePolicy.Expanding)
+        self.gridLayout.addItem(spacerItem5, 16, 0, 1, 2)
+        self.pushButton_save_yaml = QtWidgets.QPushButton(Form)
+        self.pushButton_save_yaml.setObjectName("pushButton_save_yaml")
+        self.gridLayout.addWidget(self.pushButton_save_yaml, 14, 0, 1, 1)
+        self.pushButton_import_yaml = QtWidgets.QPushButton(Form)
+        self.pushButton_import_yaml.setObjectName("pushButton_import_yaml")
+        self.gridLayout.addWidget(self.pushButton_import_yaml, 14, 1, 1, 1)
+        self.pushButton_apply_settings = QtWidgets.QPushButton(Form)
+        self.pushButton_apply_settings.setObjectName("pushButton_apply_settings")
+        self.gridLayout.addWidget(self.pushButton_apply_settings, 15, 0, 1, 2)
 
         self.retranslateUi(Form)
         self.tabWidget.setCurrentIndex(0)
         self.tabWidget_2.setCurrentIndex(0)
         QtCore.QMetaObject.connectSlotsByName(Form)
 
     def retranslateUi(self, Form):
         _translate = QtCore.QCoreApplication.translate
         Form.setWindowTitle(_translate("Form", "Form"))
-        self.microscope_button.setText(_translate("Form", "Connect to Microscope"))
+        self.label_title.setText(_translate("Form", "System"))
         self.label_ip_address.setText(_translate("Form", "IP address"))
+        self.microscope_button.setText(_translate("Form", "Connect to Microscope"))
         self.label_manufacturer.setText(_translate("Form", "Manufacturer "))
-        self.label_title.setText(_translate("Form", "System"))
         self.tabWidget.setTabText(self.tabWidget.indexOf(self.tab_4), _translate("Form", "Connect"))
+        self.preTiltLabel.setText(_translate("Form", "Shuttle Pre Tilt (deg)"))
+        self.tiltFlatToIonLabel.setText(_translate("Form", "Tilt Flat To Ion (deg)"))
+        self.tiltFlatToElectronLabel.setText(_translate("Form", "Tilt Flat To Electron (deg)"))
+        self.rotationFlatToElectronLabel.setText(_translate("Form", "Rotation Flat To Electron (deg)"))
         self.rotationFlatToIonLabel.setText(_translate("Form", "Rotation Flat To Ion (deg)"))
-        self.label_header_stage.setText(_translate("Form", "Stage "))
         self.needleStageHeightLimitnMmLabel.setText(_translate("Form", "Needle Stage Height Limit (mm)"))
-        self.tiltFlatToElectronLabel.setText(_translate("Form", "Tilt Flat To Electron (deg)"))
-        self.tiltFlatToIonLabel.setText(_translate("Form", "Tilt Flat To Ion (deg)"))
-        self.preTiltLabel.setText(_translate("Form", "Shuttle Pre Tilt (deg)"))
+        self.label_header_stage.setText(_translate("Form", "Stage "))
         self.setStage_button.setText(_translate("Form", "Set Stage Parameters"))
-        self.rotationFlatToElectronLabel.setText(_translate("Form", "Rotation Flat To Electron (deg)"))
         self.tabWidget.setTabText(self.tabWidget.indexOf(self.stage_tab), _translate("Form", "Stage"))
-        self.checkBox_stage_tilt.setText(_translate("Form", "Tilt"))
+        self.checkBox_eb.setText(_translate("Form", "Enabled"))
+        self.checkBox_gis_enabled.setText(_translate("Form", "Enabled"))
+        self.checkBox_needle_enabled.setText(_translate("Form", "Enabled"))
         self.label_5.setText(_translate("Form", "Manipulator"))
-        self.checkBox_stage_enabled.setText(_translate("Form", "Enabled"))
-        self.label_3.setText(_translate("Form", "Ion Beam"))
         self.checkBox_stage_rotation.setText(_translate("Form", "Rotation"))
+        self.label_4.setText(_translate("Form", "Stage"))
+        self.label.setText(_translate("Form", "Model parameters"))
         self.checkBox_ib.setText(_translate("Form", "Enabled"))
-        self.checkBox_eb.setText(_translate("Form", "Enabled"))
         self.checkBox_needle_rotation.setText(_translate("Form", "Rotation"))
-        self.label.setText(_translate("Form", "Model parameters"))
-        self.checkBox_gis_enabled.setText(_translate("Form", "Enabled"))
+        self.checkBox_stage_enabled.setText(_translate("Form", "Enabled"))
+        self.checkBox_multichem.setText(_translate("Form", "MultiChem"))
+        self.label_6.setText(_translate("Form", "GIS"))
         self.checkBox_needle_tilt.setText(_translate("Form", "Tilt"))
-        self.label_4.setText(_translate("Form", "Stage"))
+        self.label_3.setText(_translate("Form", "Ion Beam"))
         self.label_2.setText(_translate("Form", "Electron Beam"))
-        self.label_6.setText(_translate("Form", "GIS"))
-        self.checkBox_needle_enabled.setText(_translate("Form", "Enabled"))
-        self.checkBox_multichem.setText(_translate("Form", "MultiChem"))
-        self.pushButton_save_model.setText(_translate("Form", "Save Model"))
+        self.checkBox_stage_tilt.setText(_translate("Form", "Tilt"))
+        self.checkBox_select_plasma_gas.setText(_translate("Form", "Can Select Plasma Gas"))
         self.tabWidget.setTabText(self.tabWidget.indexOf(self.tab_microscope), _translate("Form", "Microscope Model"))
-        self.label_21.setText(_translate("Form", "Rotation Flat To Electron ()"))
-        self.label_23.setText(_translate("Form", "Tilt Flat To Electron ()"))
-        self.label_16.setText(_translate("Form", "Current (nA)"))
-        self.label_20.setText(_translate("Form", "Stage"))
         self.label_19.setText(_translate("Form", "Detector Mode"))
-        self.label_25.setText(_translate("Form", "Shuttle  Pretilt ()"))
-        self.label_7.setText(_translate("Form", "Ion Beam"))
-        self.label_14.setText(_translate("Form", "Electron Beam"))
+        self.label_13.setText(_translate("Form", "Detector Mode"))
+        self.label_8.setText(_translate("Form", "Voltage (V)"))
         self.label_12.setText(_translate("Form", "Detector Type"))
-        self.label_24.setText(_translate("Form", "Tilt Flat To Ion ()"))
-        self.label_17.setText(_translate("Form", "Eucentric Height  (m)"))
+        self.label_14.setText(_translate("Form", "Electron Beam"))
+        self.label_7.setText(_translate("Form", "Ion Beam"))
         self.label_15.setText(_translate("Form", "Voltage (V)"))
+        self.label_17.setText(_translate("Form", "Eucentric Height  (m)"))
+        self.label_9.setText(_translate("Form", "Current (nA)"))
         self.label_18.setText(_translate("Form", "Detector Type"))
-        self.label_22.setText(_translate("Form", "Rotation Flat To Ion ()"))
-        self.label_11.setText(_translate("Form", "Eucentric Height (m)"))
-        self.label_13.setText(_translate("Form", "Detector Mode"))
         self.label_10.setText(_translate("Form", "Plasma Gas"))
-        self.label_9.setText(_translate("Form", "Current (nA)"))
-        self.label_8.setText(_translate("Form", "Voltage (V)"))
-        self.label_26.setText(_translate("Form", "Needle Stage Hieght Limit (m)"))
+        self.label_16.setText(_translate("Form", "Current (nA)"))
+        self.label_11.setText(_translate("Form", "Eucentric Height (m)"))
+        self.checkBox_apply_settings.setText(_translate("Form", "Apply Settings On Start-up"))
+        self.checkBox_connect_automatically.setText(_translate("Form", "Connect To Microscope Automatically"))
         self.tabWidget_2.setTabText(self.tabWidget_2.indexOf(self.tab_2), _translate("Form", "System"))
         self.label_33.setText(_translate("Form", "Imaging Current (nA)"))
         self.label_30.setText(_translate("Form", "Rate (mm3/A/s)"))
         self.label_38.setText(_translate("Form", "Dwell Time (s)"))
         self.label_37.setText(_translate("Form", "Autocontrast"))
         self.label_34.setText(_translate("Form", "Resolution"))
         self.label_29.setText(_translate("Form", "Spot Size (nm)"))
@@ -628,9 +587,11 @@
         self.label_36.setText(_translate("Form", "Beam"))
         self.label_40.setText(_translate("Form", "Gamma "))
         self.checkBox_save.setText(_translate("Form", "Enabled"))
         self.label_32.setText(_translate("Form", "imaging"))
         self.label_31.setText(_translate("Form", "Dwell time (s)"))
         self.label_28.setText(_translate("Form", "Milling Current (nA)"))
         self.tabWidget_2.setTabText(self.tabWidget_2.indexOf(self.tab_3), _translate("Form", "User"))
-        self.pushButton_save_defaults.setText(_translate("Form", "Save Defaults To Yaml"))
-        self.tabWidget.setTabText(self.tabWidget.indexOf(self.tab), _translate("Form", "Defaults"))
+        self.tabWidget.setTabText(self.tabWidget.indexOf(self.tab), _translate("Form", "Settings"))
+        self.pushButton_save_yaml.setText(_translate("Form", "Save Configuration To File"))
+        self.pushButton_import_yaml.setText(_translate("Form", "Import Settings"))
+        self.pushButton_apply_settings.setText(_translate("Form", "Apply All Settings"))
```

## fibsem/ui/qtdesigner_files/FibsemSystemSetupWidget.ui

### fibsem/ui/qtdesigner_files/FibsemSystemSetupWidget.ui

```diff
@@ -2,16 +2,16 @@
 <ui version="4.0">
   <class>Form</class>
   <widget class="QWidget" name="Form">
     <property name="geometry">
       <rect>
         <x>0</x>
         <y>0</y>
-        <width>543</width>
-        <height>753</height>
+        <width>686</width>
+        <height>883</height>
       </rect>
     </property>
     <property name="font">
       <font>
         <pointsize>10</pointsize>
       </font>
     </property>
@@ -33,23 +33,25 @@
             <bool>false</bool>
           </property>
           <widget class="QWidget" name="tab_4">
             <attribute name="title">
               <string>Connect</string>
             </attribute>
             <layout class="QGridLayout" name="gridLayout_7">
-              <item row="4" column="0" colspan="2">
-                <widget class="QPushButton" name="microscope_button">
+              <item row="0" column="1">
+                <widget class="QLabel" name="label_title">
                   <property name="font">
                     <font>
-                      <pointsize>8</pointsize>
+                      <pointsize>12</pointsize>
+                      <weight>75</weight>
+                      <bold>true</bold>
                     </font>
                   </property>
                   <property name="text">
-                    <string>Connect to Microscope</string>
+                    <string>System</string>
                   </property>
                 </widget>
               </item>
               <item row="1" column="0">
                 <widget class="QLabel" name="label_ip_address">
                   <property name="font">
                     <font>
@@ -57,52 +59,50 @@
                     </font>
                   </property>
                   <property name="text">
                     <string>IP address</string>
                   </property>
                 </widget>
               </item>
-              <item row="3" column="0">
-                <widget class="QLabel" name="label_manufacturer">
+              <item row="3" column="1">
+                <widget class="QComboBox" name="comboBox_manufacturer">
                   <property name="font">
                     <font>
                       <pointsize>8</pointsize>
                     </font>
                   </property>
-                  <property name="text">
-                    <string>Manufacturer</string>
-                  </property>
                 </widget>
               </item>
-              <item row="0" column="1">
-                <widget class="QLabel" name="label_title">
+              <item row="1" column="1">
+                <widget class="QLineEdit" name="lineEdit_ipadress"/>
+              </item>
+              <item row="4" column="0" colspan="2">
+                <widget class="QPushButton" name="microscope_button">
                   <property name="font">
                     <font>
-                      <pointsize>12</pointsize>
-                      <weight>75</weight>
-                      <bold>true</bold>
+                      <pointsize>8</pointsize>
                     </font>
                   </property>
                   <property name="text">
-                    <string>System</string>
+                    <string>Connect to Microscope</string>
                   </property>
                 </widget>
               </item>
-              <item row="3" column="1">
-                <widget class="QComboBox" name="comboBox_manufacturer">
+              <item row="3" column="0">
+                <widget class="QLabel" name="label_manufacturer">
                   <property name="font">
                     <font>
                       <pointsize>8</pointsize>
                     </font>
                   </property>
+                  <property name="text">
+                    <string>Manufacturer</string>
+                  </property>
                 </widget>
               </item>
-              <item row="1" column="1">
-                <widget class="QLineEdit" name="lineEdit_ipadress"/>
-              </item>
               <item row="5" column="0">
                 <spacer name="verticalSpacer_5">
                   <property name="orientation">
                     <enum>Qt::Vertical</enum>
                   </property>
                   <property name="sizeHint" stdset="0">
                     <size>
@@ -115,250 +115,230 @@
             </layout>
           </widget>
           <widget class="QWidget" name="stage_tab">
             <attribute name="title">
               <string>Stage</string>
             </attribute>
             <layout class="QGridLayout" name="gridLayout_2">
-              <item row="6" column="1">
-                <widget class="QDoubleSpinBox" name="needleStageHeightLimitnMmDoubleSpinBox">
-                  <property name="minimum">
-                    <double>-99.000000000000000</double>
-                  </property>
-                </widget>
-              </item>
-              <item row="2" column="0">
-                <widget class="QLabel" name="rotationFlatToIonLabel">
-                  <property name="text">
-                    <string>Rotation Flat To Ion (deg)</string>
-                  </property>
-                </widget>
-              </item>
-              <item row="0" column="0">
-                <widget class="QLabel" name="label_header_stage">
-                  <property name="font">
-                    <font>
-                      <pointsize>10</pointsize>
-                      <weight>75</weight>
-                      <bold>true</bold>
-                    </font>
-                  </property>
+              <item row="5" column="0">
+                <widget class="QLabel" name="preTiltLabel">
                   <property name="text">
-                    <string>Stage</string>
+                    <string>Shuttle Pre Tilt (deg)</string>
                   </property>
                 </widget>
               </item>
-              <item row="6" column="0">
-                <widget class="QLabel" name="needleStageHeightLimitnMmLabel">
+              <item row="4" column="0">
+                <widget class="QLabel" name="tiltFlatToIonLabel">
                   <property name="text">
-                    <string>Needle Stage Height Limit (mm)</string>
+                    <string>Tilt Flat To Ion (deg)</string>
                   </property>
                 </widget>
               </item>
               <item row="3" column="0">
                 <widget class="QLabel" name="tiltFlatToElectronLabel">
                   <property name="text">
                     <string>Tilt Flat To Electron (deg)</string>
                   </property>
                 </widget>
               </item>
-              <item row="2" column="1">
-                <widget class="QDoubleSpinBox" name="rotationFlatToIonSpinBox">
+              <item row="1" column="1">
+                <widget class="QDoubleSpinBox" name="rotationFlatToElectronSpinBox">
                   <property name="minimum">
                     <double>-360.000000000000000</double>
                   </property>
                   <property name="maximum">
                     <double>360.000000000000000</double>
                   </property>
                 </widget>
               </item>
-              <item row="1" column="1">
-                <widget class="QDoubleSpinBox" name="rotationFlatToElectronSpinBox">
+              <item row="1" column="0">
+                <widget class="QLabel" name="rotationFlatToElectronLabel">
+                  <property name="text">
+                    <string>Rotation Flat To Electron (deg)</string>
+                  </property>
+                </widget>
+              </item>
+              <item row="3" column="1">
+                <widget class="QDoubleSpinBox" name="tiltFlatToElectronSpinBox">
                   <property name="minimum">
                     <double>-360.000000000000000</double>
                   </property>
                   <property name="maximum">
                     <double>360.000000000000000</double>
                   </property>
                 </widget>
               </item>
-              <item row="4" column="0">
-                <widget class="QLabel" name="tiltFlatToIonLabel">
+              <item row="2" column="0">
+                <widget class="QLabel" name="rotationFlatToIonLabel">
                   <property name="text">
-                    <string>Tilt Flat To Ion (deg)</string>
+                    <string>Rotation Flat To Ion (deg)</string>
                   </property>
                 </widget>
               </item>
               <item row="4" column="1">
                 <widget class="QDoubleSpinBox" name="tiltFlatToIonSpinBox">
                   <property name="minimum">
                     <double>-360.000000000000000</double>
                   </property>
                   <property name="maximum">
                     <double>360.000000000000000</double>
                   </property>
                 </widget>
               </item>
-              <item row="5" column="0">
-                <widget class="QLabel" name="preTiltLabel">
-                  <property name="text">
-                    <string>Shuttle Pre Tilt (deg)</string>
+              <item row="6" column="1">
+                <widget class="QDoubleSpinBox" name="needleStageHeightLimitnMmDoubleSpinBox">
+                  <property name="minimum">
+                    <double>-99.000000000000000</double>
                   </property>
                 </widget>
               </item>
               <item row="5" column="1">
                 <widget class="QDoubleSpinBox" name="preTiltSpinBox"/>
               </item>
-              <item row="0" column="1">
-                <widget class="QPushButton" name="setStage_button">
-                  <property name="text">
-                    <string>Set Stage Parameters</string>
+              <item row="2" column="1">
+                <widget class="QDoubleSpinBox" name="rotationFlatToIonSpinBox">
+                  <property name="minimum">
+                    <double>-360.000000000000000</double>
+                  </property>
+                  <property name="maximum">
+                    <double>360.000000000000000</double>
                   </property>
                 </widget>
               </item>
-              <item row="1" column="0">
-                <widget class="QLabel" name="rotationFlatToElectronLabel">
+              <item row="6" column="0">
+                <widget class="QLabel" name="needleStageHeightLimitnMmLabel">
                   <property name="text">
-                    <string>Rotation Flat To Electron (deg)</string>
+                    <string>Needle Stage Height Limit (mm)</string>
                   </property>
                 </widget>
               </item>
-              <item row="3" column="1">
-                <widget class="QDoubleSpinBox" name="tiltFlatToElectronSpinBox">
-                  <property name="minimum">
-                    <double>-360.000000000000000</double>
+              <item row="0" column="0">
+                <widget class="QLabel" name="label_header_stage">
+                  <property name="font">
+                    <font>
+                      <pointsize>10</pointsize>
+                      <weight>75</weight>
+                      <bold>true</bold>
+                    </font>
                   </property>
-                  <property name="maximum">
-                    <double>360.000000000000000</double>
+                  <property name="text">
+                    <string>Stage</string>
                   </property>
                 </widget>
               </item>
-              <item row="7" column="0">
-                <spacer name="verticalSpacer">
+              <item row="7" column="0" colspan="2">
+                <spacer name="verticalSpacer_3">
                   <property name="orientation">
                     <enum>Qt::Vertical</enum>
                   </property>
                   <property name="sizeHint" stdset="0">
                     <size>
                       <width>20</width>
                       <height>40</height>
                     </size>
                   </property>
                 </spacer>
               </item>
+              <item row="0" column="1">
+                <widget class="QPushButton" name="setStage_button">
+                  <property name="text">
+                    <string>Set Stage Parameters</string>
+                  </property>
+                </widget>
+              </item>
             </layout>
           </widget>
           <widget class="QWidget" name="tab_microscope">
             <attribute name="title">
               <string>Microscope Model</string>
             </attribute>
             <layout class="QGridLayout" name="gridLayout_3">
-              <item row="7" column="1">
-                <widget class="QCheckBox" name="checkBox_stage_tilt">
+              <item row="1" column="1">
+                <widget class="QCheckBox" name="checkBox_eb">
                   <property name="text">
-                    <string>Tilt</string>
+                    <string>Enabled</string>
                   </property>
                   <property name="checked">
                     <bool>true</bool>
                   </property>
                 </widget>
               </item>
-              <item row="9" column="0">
-                <widget class="QLabel" name="label_5">
-                  <property name="font">
-                    <font>
-                      <pointsize>8</pointsize>
-                      <underline>true</underline>
-                    </font>
+              <item row="17" column="0" colspan="2">
+                <spacer name="verticalSpacer_2">
+                  <property name="orientation">
+                    <enum>Qt::Vertical</enum>
                   </property>
-                  <property name="text">
-                    <string>Manipulator</string>
+                  <property name="sizeHint" stdset="0">
+                    <size>
+                      <width>20</width>
+                      <height>40</height>
+                    </size>
                   </property>
-                </widget>
+                </spacer>
               </item>
-              <item row="4" column="0" colspan="2">
-                <widget class="Line" name="line_2">
+              <item row="10" column="0" colspan="2">
+                <widget class="Line" name="line_3">
                   <property name="orientation">
                     <enum>Qt::Horizontal</enum>
                   </property>
                 </widget>
               </item>
-              <item row="5" column="1">
-                <widget class="QCheckBox" name="checkBox_stage_enabled">
+              <item row="15" column="1">
+                <widget class="QCheckBox" name="checkBox_gis_enabled">
                   <property name="text">
                     <string>Enabled</string>
                   </property>
                   <property name="checked">
                     <bool>true</bool>
                   </property>
                 </widget>
               </item>
-              <item row="3" column="0">
-                <widget class="QLabel" name="label_3">
+              <item row="11" column="1">
+                <widget class="QCheckBox" name="checkBox_needle_enabled">
+                  <property name="text">
+                    <string>Enabled</string>
+                  </property>
+                  <property name="checked">
+                    <bool>true</bool>
+                  </property>
+                </widget>
+              </item>
+              <item row="11" column="0">
+                <widget class="QLabel" name="label_5">
                   <property name="font">
                     <font>
                       <pointsize>8</pointsize>
                       <underline>true</underline>
                     </font>
                   </property>
                   <property name="text">
-                    <string>Ion Beam</string>
+                    <string>Manipulator</string>
                   </property>
                 </widget>
               </item>
-              <item row="6" column="1">
+              <item row="8" column="1">
                 <widget class="QCheckBox" name="checkBox_stage_rotation">
                   <property name="text">
                     <string>Rotation</string>
                   </property>
                   <property name="checked">
                     <bool>true</bool>
                   </property>
                 </widget>
               </item>
-              <item row="5" column="2">
-                <spacer name="horizontalSpacer">
-                  <property name="orientation">
-                    <enum>Qt::Horizontal</enum>
-                  </property>
-                  <property name="sizeHint" stdset="0">
-                    <size>
-                      <width>40</width>
-                      <height>20</height>
-                    </size>
-                  </property>
-                </spacer>
-              </item>
-              <item row="3" column="1">
-                <widget class="QCheckBox" name="checkBox_ib">
-                  <property name="text">
-                    <string>Enabled</string>
-                  </property>
-                  <property name="checked">
-                    <bool>true</bool>
-                  </property>
-                </widget>
-              </item>
-              <item row="1" column="1">
-                <widget class="QCheckBox" name="checkBox_eb">
-                  <property name="text">
-                    <string>Enabled</string>
-                  </property>
-                  <property name="checked">
-                    <bool>true</bool>
+              <item row="7" column="0">
+                <widget class="QLabel" name="label_4">
+                  <property name="font">
+                    <font>
+                      <pointsize>8</pointsize>
+                      <underline>true</underline>
+                    </font>
                   </property>
-                </widget>
-              </item>
-              <item row="10" column="1">
-                <widget class="QCheckBox" name="checkBox_needle_rotation">
                   <property name="text">
-                    <string>Rotation</string>
-                  </property>
-                  <property name="checked">
-                    <bool>true</bool>
+                    <string>Stage</string>
                   </property>
                 </widget>
               </item>
               <item row="0" column="0">
                 <widget class="QLabel" name="label">
                   <property name="font">
                     <font>
@@ -368,429 +348,353 @@
                     </font>
                   </property>
                   <property name="text">
                     <string>Model parameters</string>
                   </property>
                 </widget>
               </item>
-              <item row="8" column="0" colspan="2">
-                <widget class="Line" name="line_3">
-                  <property name="orientation">
-                    <enum>Qt::Horizontal</enum>
+              <item row="3" column="1">
+                <widget class="QCheckBox" name="checkBox_ib">
+                  <property name="text">
+                    <string>Enabled</string>
+                  </property>
+                  <property name="checked">
+                    <bool>true</bool>
                   </property>
                 </widget>
               </item>
-              <item row="12" column="0" colspan="2">
+              <item row="14" column="0" colspan="2">
                 <widget class="Line" name="line_4">
                   <property name="orientation">
                     <enum>Qt::Horizontal</enum>
                   </property>
                 </widget>
               </item>
-              <item row="2" column="0" colspan="2">
-                <widget class="Line" name="line">
-                  <property name="orientation">
-                    <enum>Qt::Horizontal</enum>
+              <item row="12" column="1">
+                <widget class="QCheckBox" name="checkBox_needle_rotation">
+                  <property name="text">
+                    <string>Rotation</string>
+                  </property>
+                  <property name="checked">
+                    <bool>true</bool>
                   </property>
                 </widget>
               </item>
-              <item row="13" column="1">
-                <widget class="QCheckBox" name="checkBox_gis_enabled">
+              <item row="7" column="1">
+                <widget class="QCheckBox" name="checkBox_stage_enabled">
                   <property name="text">
                     <string>Enabled</string>
                   </property>
                   <property name="checked">
                     <bool>true</bool>
                   </property>
                 </widget>
               </item>
-              <item row="11" column="1">
-                <widget class="QCheckBox" name="checkBox_needle_tilt">
+              <item row="16" column="1">
+                <widget class="QCheckBox" name="checkBox_multichem">
                   <property name="text">
-                    <string>Tilt</string>
+                    <string>MultiChem</string>
                   </property>
                   <property name="checked">
                     <bool>true</bool>
                   </property>
                 </widget>
               </item>
-              <item row="5" column="0">
-                <widget class="QLabel" name="label_4">
+              <item row="15" column="0">
+                <widget class="QLabel" name="label_6">
                   <property name="font">
                     <font>
                       <pointsize>8</pointsize>
                       <underline>true</underline>
                     </font>
                   </property>
                   <property name="text">
-                    <string>Stage</string>
+                    <string>GIS</string>
                   </property>
                 </widget>
               </item>
-              <item row="1" column="0">
-                <widget class="QLabel" name="label_2">
+              <item row="13" column="1">
+                <widget class="QCheckBox" name="checkBox_needle_tilt">
+                  <property name="text">
+                    <string>Tilt</string>
+                  </property>
+                  <property name="checked">
+                    <bool>true</bool>
+                  </property>
+                </widget>
+              </item>
+              <item row="3" column="0">
+                <widget class="QLabel" name="label_3">
                   <property name="font">
                     <font>
                       <pointsize>8</pointsize>
                       <underline>true</underline>
                     </font>
                   </property>
                   <property name="text">
-                    <string>Electron Beam</string>
+                    <string>Ion Beam</string>
                   </property>
                 </widget>
               </item>
-              <item row="13" column="0">
-                <widget class="QLabel" name="label_6">
+              <item row="6" column="0" colspan="2">
+                <widget class="Line" name="line_2">
+                  <property name="orientation">
+                    <enum>Qt::Horizontal</enum>
+                  </property>
+                </widget>
+              </item>
+              <item row="1" column="0">
+                <widget class="QLabel" name="label_2">
                   <property name="font">
                     <font>
                       <pointsize>8</pointsize>
                       <underline>true</underline>
                     </font>
                   </property>
                   <property name="text">
-                    <string>GIS</string>
+                    <string>Electron Beam</string>
                   </property>
                 </widget>
               </item>
-              <item row="9" column="1">
-                <widget class="QCheckBox" name="checkBox_needle_enabled">
-                  <property name="text">
-                    <string>Enabled</string>
-                  </property>
-                  <property name="checked">
-                    <bool>true</bool>
+              <item row="2" column="0" colspan="2">
+                <widget class="Line" name="line">
+                  <property name="orientation">
+                    <enum>Qt::Horizontal</enum>
                   </property>
                 </widget>
               </item>
-              <item row="14" column="1">
-                <widget class="QCheckBox" name="checkBox_multichem">
+              <item row="9" column="1">
+                <widget class="QCheckBox" name="checkBox_stage_tilt">
                   <property name="text">
-                    <string>MultiChem</string>
+                    <string>Tilt</string>
                   </property>
                   <property name="checked">
                     <bool>true</bool>
                   </property>
                 </widget>
               </item>
-              <item row="15" column="1">
-                <spacer name="verticalSpacer_2">
-                  <property name="orientation">
-                    <enum>Qt::Vertical</enum>
-                  </property>
-                  <property name="sizeHint" stdset="0">
-                    <size>
-                      <width>20</width>
-                      <height>40</height>
-                    </size>
-                  </property>
-                </spacer>
-              </item>
-              <item row="0" column="2">
-                <widget class="QPushButton" name="pushButton_save_model">
+              <item row="4" column="1">
+                <widget class="QCheckBox" name="checkBox_select_plasma_gas">
                   <property name="text">
-                    <string>Save Model</string>
+                    <string>Can Select Plasma Gas</string>
                   </property>
                 </widget>
               </item>
             </layout>
           </widget>
           <widget class="QWidget" name="tab">
             <attribute name="title">
-              <string>Defaults</string>
+              <string>Settings</string>
             </attribute>
             <layout class="QGridLayout" name="gridLayout_4">
-              <item row="1" column="0">
+              <item row="0" column="0">
                 <widget class="QTabWidget" name="tabWidget_2">
                   <property name="font">
                     <font>
                       <pointsize>8</pointsize>
                     </font>
                   </property>
                   <property name="currentIndex">
                     <number>0</number>
                   </property>
                   <widget class="QWidget" name="tab_2">
                     <attribute name="title">
                       <string>System</string>
                     </attribute>
                     <layout class="QGridLayout" name="gridLayout_5">
-                      <item row="1" column="1">
-                        <widget class="QSpinBox" name="spinBox_ion_voltage">
-                          <property name="maximum">
-                            <number>100000</number>
-                          </property>
-                        </widget>
-                      </item>
-                      <item row="14" column="0">
-                        <widget class="QLabel" name="label_21">
-                          <property name="text">
-                            <string>Rotation Flat To Electron ()</string>
-                          </property>
-                        </widget>
-                      </item>
-                      <item row="16" column="0">
-                        <widget class="QLabel" name="label_23">
+                      <item row="12" column="0">
+                        <widget class="QLabel" name="label_19">
                           <property name="text">
-                            <string>Tilt Flat To Electron ()</string>
+                            <string>Detector Mode</string>
                           </property>
                         </widget>
                       </item>
-                      <item row="11" column="1">
-                        <widget class="QLineEdit" name="lineEdit_detector_type_eb"/>
+                      <item row="12" column="1">
+                        <widget class="QLineEdit" name="lineEdit_detector_mode_eb"/>
                       </item>
-                      <item row="8" column="1">
-                        <widget class="QSpinBox" name="spinBox_voltage_eb">
-                          <property name="maximum">
-                            <number>1000000</number>
+                      <item row="6" column="0">
+                        <widget class="QLabel" name="label_13">
+                          <property name="text">
+                            <string>Detector Mode</string>
                           </property>
                         </widget>
                       </item>
-                      <item row="12" column="1">
-                        <widget class="QLineEdit" name="lineEdit_detector_mode_eb"/>
-                      </item>
                       <item row="4" column="1">
                         <widget class="QDoubleSpinBox" name="doubleSpinBox_height_ion">
                           <property name="decimals">
                             <number>4</number>
                           </property>
                         </widget>
                       </item>
-                      <item row="9" column="0">
-                        <widget class="QLabel" name="label_16">
-                          <property name="text">
-                            <string>Current (nA)</string>
-                          </property>
-                        </widget>
-                      </item>
-                      <item row="13" column="0" colspan="2">
-                        <widget class="QLabel" name="label_20">
-                          <property name="font">
-                            <font>
-                              <pointsize>10</pointsize>
-                              <underline>true</underline>
-                            </font>
-                          </property>
-                          <property name="text">
-                            <string>Stage</string>
-                          </property>
-                        </widget>
-                      </item>
                       <item row="10" column="1">
                         <widget class="QDoubleSpinBox" name="doubleSpinBox_height_eb">
                           <property name="decimals">
                             <number>4</number>
                           </property>
                         </widget>
                       </item>
-                      <item row="12" column="0">
-                        <widget class="QLabel" name="label_19">
+                      <item row="1" column="0">
+                        <widget class="QLabel" name="label_8">
                           <property name="text">
-                            <string>Detector Mode</string>
+                            <string>Voltage (V)</string>
                           </property>
                         </widget>
                       </item>
-                      <item row="18" column="0">
-                        <widget class="QLabel" name="label_25">
+                      <item row="5" column="0">
+                        <widget class="QLabel" name="label_12">
                           <property name="text">
-                            <string>Shuttle  Pretilt ()</string>
+                            <string>Detector Type</string>
                           </property>
                         </widget>
                       </item>
-                      <item row="3" column="1">
-                        <widget class="QLineEdit" name="lineEdit_plasma_gas"/>
-                      </item>
-                      <item row="0" column="0" colspan="2">
-                        <widget class="QLabel" name="label_7">
+                      <item row="7" column="0" colspan="2">
+                        <widget class="QLabel" name="label_14">
                           <property name="font">
                             <font>
                               <pointsize>10</pointsize>
                               <underline>true</underline>
                             </font>
                           </property>
                           <property name="text">
-                            <string>Ion Beam</string>
+                            <string>Electron Beam</string>
                           </property>
                         </widget>
                       </item>
-                      <item row="20" column="1">
-                        <spacer name="verticalSpacer_3">
-                          <property name="orientation">
-                            <enum>Qt::Vertical</enum>
-                          </property>
-                          <property name="sizeHint" stdset="0">
-                            <size>
-                              <width>20</width>
-                              <height>40</height>
-                            </size>
-                          </property>
-                        </spacer>
-                      </item>
-                      <item row="7" column="0" colspan="2">
-                        <widget class="QLabel" name="label_14">
+                      <item row="0" column="0" colspan="2">
+                        <widget class="QLabel" name="label_7">
                           <property name="font">
                             <font>
                               <pointsize>10</pointsize>
                               <underline>true</underline>
                             </font>
                           </property>
                           <property name="text">
-                            <string>Electron Beam</string>
+                            <string>Ion Beam</string>
                           </property>
                         </widget>
                       </item>
-                      <item row="5" column="0">
-                        <widget class="QLabel" name="label_12">
-                          <property name="text">
-                            <string>Detector Type</string>
-                          </property>
-                        </widget>
+                      <item row="11" column="1">
+                        <widget class="QLineEdit" name="lineEdit_detector_type_eb"/>
                       </item>
-                      <item row="17" column="0">
-                        <widget class="QLabel" name="label_24">
-                          <property name="text">
-                            <string>Tilt Flat To Ion ()</string>
-                          </property>
-                        </widget>
+                      <item row="3" column="1">
+                        <widget class="QLineEdit" name="lineEdit_plasma_gas"/>
                       </item>
-                      <item row="10" column="0">
-                        <widget class="QLabel" name="label_17">
-                          <property name="text">
-                            <string>Eucentric Height  (m)</string>
+                      <item row="9" column="1">
+                        <widget class="QDoubleSpinBox" name="doubleSpinBox_current_eb">
+                          <property name="decimals">
+                            <number>4</number>
+                          </property>
+                          <property name="maximum">
+                            <double>100000.000000000000000</double>
                           </property>
                         </widget>
                       </item>
                       <item row="8" column="0">
                         <widget class="QLabel" name="label_15">
                           <property name="text">
                             <string>Voltage (V)</string>
                           </property>
                         </widget>
                       </item>
                       <item row="5" column="1">
                         <widget class="QLineEdit" name="lineEdit_detector_type_ion"/>
                       </item>
-                      <item row="11" column="0">
-                        <widget class="QLabel" name="label_18">
+                      <item row="10" column="0">
+                        <widget class="QLabel" name="label_17">
                           <property name="text">
-                            <string>Detector Type</string>
+                            <string>Eucentric Height  (m)</string>
                           </property>
                         </widget>
                       </item>
-                      <item row="9" column="1">
-                        <widget class="QDoubleSpinBox" name="doubleSpinBox_current_eb">
+                      <item row="2" column="1">
+                        <widget class="QDoubleSpinBox" name="doubleSpinBox_ion_current">
                           <property name="decimals">
                             <number>4</number>
                           </property>
                           <property name="maximum">
-                            <double>100000.000000000000000</double>
+                            <double>1000000.000000000000000</double>
                           </property>
                         </widget>
                       </item>
-                      <item row="15" column="0">
-                        <widget class="QLabel" name="label_22">
-                          <property name="text">
-                            <string>Rotation Flat To Ion ()</string>
+                      <item row="8" column="1">
+                        <widget class="QSpinBox" name="spinBox_voltage_eb">
+                          <property name="maximum">
+                            <number>1000000</number>
                           </property>
                         </widget>
                       </item>
-                      <item row="4" column="0">
-                        <widget class="QLabel" name="label_11">
+                      <item row="2" column="0">
+                        <widget class="QLabel" name="label_9">
                           <property name="text">
-                            <string>Eucentric Height (m)</string>
+                            <string>Current (nA)</string>
                           </property>
                         </widget>
                       </item>
-                      <item row="6" column="0">
-                        <widget class="QLabel" name="label_13">
+                      <item row="11" column="0">
+                        <widget class="QLabel" name="label_18">
                           <property name="text">
-                            <string>Detector Mode</string>
+                            <string>Detector Type</string>
                           </property>
                         </widget>
                       </item>
                       <item row="3" column="0">
                         <widget class="QLabel" name="label_10">
                           <property name="text">
                             <string>Plasma Gas</string>
                           </property>
                         </widget>
                       </item>
-                      <item row="2" column="0">
-                        <widget class="QLabel" name="label_9">
-                          <property name="text">
-                            <string>Current (nA)</string>
-                          </property>
-                        </widget>
-                      </item>
-                      <item row="2" column="1">
-                        <widget class="QDoubleSpinBox" name="doubleSpinBox_ion_current">
-                          <property name="decimals">
-                            <number>4</number>
-                          </property>
-                          <property name="maximum">
-                            <double>1000000.000000000000000</double>
-                          </property>
-                        </widget>
-                      </item>
                       <item row="6" column="1">
                         <widget class="QLineEdit" name="lineEdit_detector_mode_ion"/>
                       </item>
-                      <item row="1" column="0">
-                        <widget class="QLabel" name="label_8">
+                      <item row="9" column="0">
+                        <widget class="QLabel" name="label_16">
                           <property name="text">
-                            <string>Voltage (V)</string>
+                            <string>Current (nA)</string>
                           </property>
                         </widget>
                       </item>
-                      <item row="19" column="0">
-                        <widget class="QLabel" name="label_26">
+                      <item row="4" column="0">
+                        <widget class="QLabel" name="label_11">
                           <property name="text">
-                            <string>Needle Stage Hieght Limit (m)</string>
+                            <string>Eucentric Height (m)</string>
                           </property>
                         </widget>
                       </item>
-                      <item row="14" column="1">
-                        <widget class="QSpinBox" name="spinBox_rotation_eb">
+                      <item row="1" column="1">
+                        <widget class="QSpinBox" name="spinBox_ion_voltage">
                           <property name="maximum">
-                            <number>360</number>
+                            <number>100000</number>
                           </property>
                         </widget>
                       </item>
                       <item row="15" column="1">
-                        <widget class="QSpinBox" name="spinBox_rotation_ib">
-                          <property name="maximum">
-                            <number>360</number>
-                          </property>
-                        </widget>
-                      </item>
-                      <item row="16" column="1">
-                        <widget class="QSpinBox" name="spinBox_tilt_eb">
-                          <property name="maximum">
-                            <number>360</number>
+                        <spacer name="verticalSpacer_6">
+                          <property name="orientation">
+                            <enum>Qt::Vertical</enum>
                           </property>
-                        </widget>
-                      </item>
-                      <item row="17" column="1">
-                        <widget class="QSpinBox" name="spinBox_tilt_ib">
-                          <property name="maximum">
-                            <number>360</number>
+                          <property name="sizeHint" stdset="0">
+                            <size>
+                              <width>20</width>
+                              <height>40</height>
+                            </size>
                           </property>
-                        </widget>
+                        </spacer>
                       </item>
-                      <item row="18" column="1">
-                        <widget class="QSpinBox" name="spinBox_pretilt">
-                          <property name="maximum">
-                            <number>360</number>
+                      <item row="13" column="1">
+                        <widget class="QCheckBox" name="checkBox_apply_settings">
+                          <property name="text">
+                            <string>Apply Settings On Start-up</string>
                           </property>
                         </widget>
                       </item>
-                      <item row="19" column="1">
-                        <widget class="QDoubleSpinBox" name="doubleSpinBox_needle_height">
-                          <property name="decimals">
-                            <number>4</number>
+                      <item row="14" column="1">
+                        <widget class="QCheckBox" name="checkBox_connect_automatically">
+                          <property name="text">
+                            <string>Connect To Microscope Automatically</string>
                           </property>
                         </widget>
                       </item>
                     </layout>
                   </widget>
                   <widget class="QWidget" name="tab_3">
                     <attribute name="title">
@@ -1059,14 +963,17 @@
                         </widget>
                       </item>
                       <item row="3" column="1" colspan="2">
                         <widget class="QDoubleSpinBox" name="doubleSpinBox_rate">
                           <property name="decimals">
                             <number>4</number>
                           </property>
+                          <property name="maximum">
+                            <double>1000000.000000000000000</double>
+                          </property>
                         </widget>
                       </item>
                       <item row="2" column="1" colspan="2">
                         <widget class="QDoubleSpinBox" name="doubleSpinBox_spotsize">
                           <property name="decimals">
                             <number>4</number>
                           </property>
@@ -1085,23 +992,50 @@
                           </property>
                         </widget>
                       </item>
                     </layout>
                   </widget>
                 </widget>
               </item>
-              <item row="0" column="0">
-                <widget class="QPushButton" name="pushButton_save_defaults">
-                  <property name="text">
-                    <string>Save Defaults To Yaml</string>
-                  </property>
-                </widget>
-              </item>
             </layout>
           </widget>
         </widget>
       </item>
+      <item row="16" column="0" colspan="2">
+        <spacer name="verticalSpacer">
+          <property name="orientation">
+            <enum>Qt::Vertical</enum>
+          </property>
+          <property name="sizeHint" stdset="0">
+            <size>
+              <width>20</width>
+              <height>40</height>
+            </size>
+          </property>
+        </spacer>
+      </item>
+      <item row="14" column="0">
+        <widget class="QPushButton" name="pushButton_save_yaml">
+          <property name="text">
+            <string>Save Configuration To File</string>
+          </property>
+        </widget>
+      </item>
+      <item row="14" column="1">
+        <widget class="QPushButton" name="pushButton_import_yaml">
+          <property name="text">
+            <string>Import Settings</string>
+          </property>
+        </widget>
+      </item>
+      <item row="15" column="0" colspan="2">
+        <widget class="QPushButton" name="pushButton_apply_settings">
+          <property name="text">
+            <string>Apply All Settings</string>
+          </property>
+        </widget>
+      </item>
     </layout>
   </widget>
   <resources/>
   <connections/>
 </ui>
```

## fibsem/ui/qtdesigner_files/FibsemUI.py

```diff
@@ -1,12 +1,12 @@
 # -*- coding: utf-8 -*-
 
 # Form implementation generated from reading ui file 'FibsemUI.ui'
 #
-# Created by: PyQt5 UI code generator 5.15.7
+# Created by: PyQt5 UI code generator 5.15.9
 #
 # WARNING: Any manual changes made to this file will be lost when pyuic5 is
 # run again.  Do not edit this file unless you know what you are doing.
 
 
 from PyQt5 import QtCore, QtGui, QtWidgets
 
@@ -45,22 +45,29 @@
         self.statusbar = QtWidgets.QStatusBar(MainWindow)
         self.statusbar.setObjectName("statusbar")
         MainWindow.setStatusBar(self.statusbar)
         self.actionCurrent_alignment = QtWidgets.QAction(MainWindow)
         self.actionCurrent_alignment.setObjectName("actionCurrent_alignment")
         self.actionManipulator_Positions_Calibration = QtWidgets.QAction(MainWindow)
         self.actionManipulator_Positions_Calibration.setObjectName("actionManipulator_Positions_Calibration")
+        self.actionMinimap = QtWidgets.QAction(MainWindow)
+        self.actionMinimap.setObjectName("actionMinimap")
+        self.actionOpen_Minimap = QtWidgets.QAction(MainWindow)
+        self.actionOpen_Minimap.setObjectName("actionOpen_Minimap")
         self.menuTools.addAction(self.actionCurrent_alignment)
         self.menuTools.addAction(self.actionManipulator_Positions_Calibration)
+        self.menuTools.addAction(self.actionOpen_Minimap)
         self.menubar.addAction(self.menuTools.menuAction())
 
         self.retranslateUi(MainWindow)
         self.tabWidget.setCurrentIndex(-1)
         QtCore.QMetaObject.connectSlotsByName(MainWindow)
 
     def retranslateUi(self, MainWindow):
         _translate = QtCore.QCoreApplication.translate
         MainWindow.setWindowTitle(_translate("MainWindow", "MainWindow"))
         self.label_title.setText(_translate("MainWindow", "OpenFIBSEM"))
         self.menuTools.setTitle(_translate("MainWindow", "Tools"))
-        self.actionCurrent_alignment.setText(_translate("MainWindow", "Current alignment"))
-        self.actionManipulator_Positions_Calibration.setText(_translate("MainWindow", "Manipulator Positions Calibration"))
+        self.actionCurrent_alignment.setText(_translate("MainWindow", "Beam Current Alignment"))
+        self.actionManipulator_Positions_Calibration.setText(_translate("MainWindow", "Manipulator Callibration"))
+        self.actionMinimap.setText(_translate("MainWindow", "Minimap"))
+        self.actionOpen_Minimap.setText(_translate("MainWindow", "Open Minimap"))
```

## fibsem/ui/qtdesigner_files/FibsemUI.ui

### fibsem/ui/qtdesigner_files/FibsemUI.ui

```diff
@@ -71,25 +71,36 @@
       </property>
       <widget class="QMenu" name="menuTools">
         <property name="title">
           <string>Tools</string>
         </property>
         <addaction name="actionCurrent_alignment"/>
         <addaction name="actionManipulator_Positions_Calibration"/>
+        <addaction name="actionOpen_Minimap"/>
       </widget>
       <addaction name="menuTools"/>
     </widget>
     <widget class="QStatusBar" name="statusbar"/>
     <action name="actionCurrent_alignment">
       <property name="text">
-        <string>Current alignment</string>
+        <string>Beam Current Alignment</string>
       </property>
     </action>
     <action name="actionManipulator_Positions_Calibration">
       <property name="text">
-        <string>Manipulator Positions Calibration</string>
+        <string>Manipulator Callibration</string>
+      </property>
+    </action>
+    <action name="actionMinimap">
+      <property name="text">
+        <string>Minimap</string>
+      </property>
+    </action>
+    <action name="actionOpen_Minimap">
+      <property name="text">
+        <string>Open Minimap</string>
       </property>
     </action>
   </widget>
   <resources/>
   <connections/>
 </ui>
```

## fibsem/ui/qtdesigner_files/ImageSettingsWidget.py

```diff
@@ -10,252 +10,253 @@
 
 from PyQt5 import QtCore, QtGui, QtWidgets
 
 
 class Ui_Form(object):
     def setupUi(self, Form):
         Form.setObjectName("Form")
-        Form.resize(369, 765)
+        Form.resize(444, 765)
         self.gridLayout = QtWidgets.QGridLayout(Form)
         self.gridLayout.setObjectName("gridLayout")
-        self.label_image_save_path = QtWidgets.QLabel(Form)
-        self.label_image_save_path.setObjectName("label_image_save_path")
-        self.gridLayout.addWidget(self.label_image_save_path, 10, 0, 1, 1)
-        self.label_12 = QtWidgets.QLabel(Form)
-        self.label_12.setObjectName("label_12")
-        self.gridLayout.addWidget(self.label_12, 22, 0, 1, 1)
-        self.set_detector_button = QtWidgets.QPushButton(Form)
-        self.set_detector_button.setObjectName("set_detector_button")
-        self.gridLayout.addWidget(self.set_detector_button, 12, 1, 1, 2)
-        self.label_image_hfw = QtWidgets.QLabel(Form)
-        self.label_image_hfw.setObjectName("label_image_hfw")
-        self.gridLayout.addWidget(self.label_image_hfw, 6, 0, 1, 1)
-        self.working_distance = QtWidgets.QDoubleSpinBox(Form)
-        self.working_distance.setMaximum(1000.0)
-        self.working_distance.setObjectName("working_distance")
-        self.gridLayout.addWidget(self.working_distance, 18, 1, 1, 1)
-        self.label_4 = QtWidgets.QLabel(Form)
-        self.label_4.setObjectName("label_4")
-        self.gridLayout.addWidget(self.label_4, 15, 0, 1, 1)
+        self.pushButton_take_all_images = QtWidgets.QPushButton(Form)
+        self.pushButton_take_all_images.setObjectName("pushButton_take_all_images")
+        self.gridLayout.addWidget(self.pushButton_take_all_images, 27, 0, 1, 3)
+        self.detector_brightness_slider = QtWidgets.QSlider(Form)
+        self.detector_brightness_slider.setMaximum(100)
+        self.detector_brightness_slider.setSliderPosition(50)
+        self.detector_brightness_slider.setOrientation(QtCore.Qt.Horizontal)
+        self.detector_brightness_slider.setInvertedAppearance(False)
+        self.detector_brightness_slider.setTickPosition(QtWidgets.QSlider.TicksAbove)
+        self.detector_brightness_slider.setTickInterval(10)
+        self.detector_brightness_slider.setObjectName("detector_brightness_slider")
+        self.gridLayout.addWidget(self.detector_brightness_slider, 15, 1, 1, 1)
+        self.label_5 = QtWidgets.QLabel(Form)
+        self.label_5.setObjectName("label_5")
+        self.gridLayout.addWidget(self.label_5, 16, 0, 1, 1)
         self.beam_current = QtWidgets.QDoubleSpinBox(Form)
         self.beam_current.setMaximum(1000.0)
         self.beam_current.setObjectName("beam_current")
         self.gridLayout.addWidget(self.beam_current, 19, 1, 1, 1)
         self.label_7 = QtWidgets.QLabel(Form)
         self.label_7.setObjectName("label_7")
         self.gridLayout.addWidget(self.label_7, 18, 0, 1, 1)
-        self.label_5 = QtWidgets.QLabel(Form)
-        self.label_5.setObjectName("label_5")
-        self.gridLayout.addWidget(self.label_5, 16, 0, 1, 1)
-        self.lineEdit_image_label = QtWidgets.QLineEdit(Form)
-        self.lineEdit_image_label.setObjectName("lineEdit_image_label")
-        self.gridLayout.addWidget(self.lineEdit_image_label, 11, 1, 1, 2)
-        self.spinBox_resolution_x = QtWidgets.QSpinBox(Form)
-        self.spinBox_resolution_x.setMinimum(1)
-        self.spinBox_resolution_x.setMaximum(999999999)
-        self.spinBox_resolution_x.setProperty("value", 1536)
-        self.spinBox_resolution_x.setObjectName("spinBox_resolution_x")
-        self.gridLayout.addWidget(self.spinBox_resolution_x, 4, 1, 1, 1)
-        self.label = QtWidgets.QLabel(Form)
-        font = QtGui.QFont()
-        font.setPointSize(12)
-        font.setBold(True)
-        font.setWeight(75)
-        self.label.setFont(font)
-        self.label.setObjectName("label")
-        self.gridLayout.addWidget(self.label, 12, 0, 1, 1)
         self.button_set_beam_settings = QtWidgets.QPushButton(Form)
         self.button_set_beam_settings.setObjectName("button_set_beam_settings")
         self.gridLayout.addWidget(self.button_set_beam_settings, 17, 1, 1, 2)
-        self.detector_contrast_label = QtWidgets.QLabel(Form)
-        self.detector_contrast_label.setObjectName("detector_contrast_label")
-        self.gridLayout.addWidget(self.detector_contrast_label, 16, 2, 1, 1)
         self.label_image_label = QtWidgets.QLabel(Form)
         self.label_image_label.setObjectName("label_image_label")
         self.gridLayout.addWidget(self.label_image_label, 11, 0, 1, 1)
-        self.stigmation_y = QtWidgets.QDoubleSpinBox(Form)
-        self.stigmation_y.setMaximum(1000.0)
-        self.stigmation_y.setObjectName("stigmation_y")
-        self.gridLayout.addWidget(self.stigmation_y, 21, 2, 1, 1)
+        self.detector_brightness_label = QtWidgets.QLabel(Form)
+        self.detector_brightness_label.setObjectName("detector_brightness_label")
+        self.gridLayout.addWidget(self.detector_brightness_label, 15, 2, 1, 1)
+        self.ion_ruler_label = QtWidgets.QLabel(Form)
+        self.ion_ruler_label.setText("")
+        self.ion_ruler_label.setObjectName("ion_ruler_label")
+        self.gridLayout.addWidget(self.ion_ruler_label, 23, 1, 1, 2)
+        self.label_4 = QtWidgets.QLabel(Form)
+        self.label_4.setObjectName("label_4")
+        self.gridLayout.addWidget(self.label_4, 15, 0, 1, 1)
+        self.label_image_save_path = QtWidgets.QLabel(Form)
+        self.label_image_save_path.setObjectName("label_image_save_path")
+        self.gridLayout.addWidget(self.label_image_save_path, 10, 0, 1, 1)
+        self.label_image_resolution = QtWidgets.QLabel(Form)
+        self.label_image_resolution.setObjectName("label_image_resolution")
+        self.gridLayout.addWidget(self.label_image_resolution, 4, 0, 1, 1)
         self.pushButton_take_image = QtWidgets.QPushButton(Form)
         self.pushButton_take_image.setObjectName("pushButton_take_image")
         self.gridLayout.addWidget(self.pushButton_take_image, 26, 0, 1, 3)
-        self.label_image_dwell_time = QtWidgets.QLabel(Form)
-        self.label_image_dwell_time.setObjectName("label_image_dwell_time")
-        self.gridLayout.addWidget(self.label_image_dwell_time, 5, 0, 1, 1)
-        self.selected_beam = QtWidgets.QComboBox(Form)
-        self.selected_beam.setObjectName("selected_beam")
-        self.gridLayout.addWidget(self.selected_beam, 1, 1, 1, 2)
-        self.label_8 = QtWidgets.QLabel(Form)
-        self.label_8.setObjectName("label_8")
-        self.gridLayout.addWidget(self.label_8, 1, 0, 1, 1)
-        self.doubleSpinBox_image_dwell_time = QtWidgets.QDoubleSpinBox(Form)
-        self.doubleSpinBox_image_dwell_time.setMaximum(10000000000000.0)
-        self.doubleSpinBox_image_dwell_time.setSingleStep(0.01)
-        self.doubleSpinBox_image_dwell_time.setProperty("value", 1.0)
-        self.doubleSpinBox_image_dwell_time.setObjectName("doubleSpinBox_image_dwell_time")
-        self.gridLayout.addWidget(self.doubleSpinBox_image_dwell_time, 5, 1, 1, 1)
-        self.label_6 = QtWidgets.QLabel(Form)
-        font = QtGui.QFont()
-        font.setPointSize(12)
-        font.setBold(True)
-        font.setWeight(75)
-        self.label_6.setFont(font)
-        self.label_6.setObjectName("label_6")
-        self.gridLayout.addWidget(self.label_6, 17, 0, 1, 1)
+        self.label_presets = QtWidgets.QLabel(Form)
+        self.label_presets.setObjectName("label_presets")
+        self.gridLayout.addWidget(self.label_presets, 7, 0, 1, 1)
+        self.beam_voltage = QtWidgets.QDoubleSpinBox(Form)
+        self.beam_voltage.setMaximum(100000.0)
+        self.beam_voltage.setObjectName("beam_voltage")
+        self.gridLayout.addWidget(self.beam_voltage, 20, 1, 1, 1)
+        self.label_12 = QtWidgets.QLabel(Form)
+        self.label_12.setObjectName("label_12")
+        self.gridLayout.addWidget(self.label_12, 22, 0, 1, 1)
+        self.spinBox_resolution_x = QtWidgets.QSpinBox(Form)
+        self.spinBox_resolution_x.setMinimum(1)
+        self.spinBox_resolution_x.setMaximum(999999999)
+        self.spinBox_resolution_x.setProperty("value", 1536)
+        self.spinBox_resolution_x.setObjectName("spinBox_resolution_x")
+        self.gridLayout.addWidget(self.spinBox_resolution_x, 4, 1, 1, 1)
         spacerItem = QtWidgets.QSpacerItem(20, 40, QtWidgets.QSizePolicy.Minimum, QtWidgets.QSizePolicy.Expanding)
         self.gridLayout.addItem(spacerItem, 28, 0, 1, 3)
+        self.stigmation_y = QtWidgets.QDoubleSpinBox(Form)
+        self.stigmation_y.setMaximum(1000.0)
+        self.stigmation_y.setObjectName("stigmation_y")
+        self.gridLayout.addWidget(self.stigmation_y, 21, 2, 1, 1)
         self.shift_x = QtWidgets.QDoubleSpinBox(Form)
         self.shift_x.setMaximum(1000.0)
         self.shift_x.setObjectName("shift_x")
         self.gridLayout.addWidget(self.shift_x, 22, 1, 1, 1)
-        self.detector_type_combobox = QtWidgets.QComboBox(Form)
-        self.detector_type_combobox.setObjectName("detector_type_combobox")
-        self.gridLayout.addWidget(self.detector_type_combobox, 13, 1, 1, 2)
-        self.stigmation_x = QtWidgets.QDoubleSpinBox(Form)
-        self.stigmation_x.setMaximum(1000.0)
-        self.stigmation_x.setObjectName("stigmation_x")
-        self.gridLayout.addWidget(self.stigmation_x, 21, 1, 1, 1)
-        self.shift_y = QtWidgets.QDoubleSpinBox(Form)
-        self.shift_y.setMaximum(1000.0)
-        self.shift_y.setObjectName("shift_y")
-        self.gridLayout.addWidget(self.shift_y, 22, 2, 1, 1)
-        self.checkBox_image_save_image = QtWidgets.QCheckBox(Form)
-        self.checkBox_image_save_image.setObjectName("checkBox_image_save_image")
-        self.gridLayout.addWidget(self.checkBox_image_save_image, 9, 0, 1, 1)
-        self.detector_brightness_slider = QtWidgets.QSlider(Form)
-        self.detector_brightness_slider.setMaximum(100)
-        self.detector_brightness_slider.setSliderPosition(50)
-        self.detector_brightness_slider.setOrientation(QtCore.Qt.Horizontal)
-        self.detector_brightness_slider.setInvertedAppearance(False)
-        self.detector_brightness_slider.setTickPosition(QtWidgets.QSlider.TicksAbove)
-        self.detector_brightness_slider.setTickInterval(10)
-        self.detector_brightness_slider.setObjectName("detector_brightness_slider")
-        self.gridLayout.addWidget(self.detector_brightness_slider, 15, 1, 1, 1)
-        self.beam_voltage = QtWidgets.QDoubleSpinBox(Form)
-        self.beam_voltage.setMaximum(100000.0)
-        self.beam_voltage.setObjectName("beam_voltage")
-        self.gridLayout.addWidget(self.beam_voltage, 20, 1, 1, 1)
-        spacerItem1 = QtWidgets.QSpacerItem(20, 40, QtWidgets.QSizePolicy.Minimum, QtWidgets.QSizePolicy.Expanding)
-        self.gridLayout.addItem(spacerItem1, 25, 0, 1, 3)
-        self.lineEdit_image_path = QtWidgets.QLineEdit(Form)
-        self.lineEdit_image_path.setObjectName("lineEdit_image_path")
-        self.gridLayout.addWidget(self.lineEdit_image_path, 10, 1, 1, 2)
-        self.doubleSpinBox_image_hfw = QtWidgets.QDoubleSpinBox(Form)
-        self.doubleSpinBox_image_hfw.setMaximum(2700.0)
-        self.doubleSpinBox_image_hfw.setSingleStep(0.1)
-        self.doubleSpinBox_image_hfw.setProperty("value", 150.0)
-        self.doubleSpinBox_image_hfw.setObjectName("doubleSpinBox_image_hfw")
-        self.gridLayout.addWidget(self.doubleSpinBox_image_hfw, 6, 1, 1, 1)
-        self.label_3 = QtWidgets.QLabel(Form)
-        self.label_3.setObjectName("label_3")
-        self.gridLayout.addWidget(self.label_3, 14, 0, 1, 1)
-        self.detector_brightness_label = QtWidgets.QLabel(Form)
-        self.detector_brightness_label.setObjectName("detector_brightness_label")
-        self.gridLayout.addWidget(self.detector_brightness_label, 15, 2, 1, 1)
-        self.checkBox_image_use_autocontrast = QtWidgets.QCheckBox(Form)
-        self.checkBox_image_use_autocontrast.setChecked(True)
-        self.checkBox_image_use_autocontrast.setObjectName("checkBox_image_use_autocontrast")
-        self.gridLayout.addWidget(self.checkBox_image_use_autocontrast, 8, 0, 1, 1)
         self.label_title = QtWidgets.QLabel(Form)
         font = QtGui.QFont()
         font.setPointSize(12)
         font.setBold(True)
         font.setWeight(75)
         self.label_title.setFont(font)
         self.label_title.setObjectName("label_title")
         self.gridLayout.addWidget(self.label_title, 2, 0, 1, 1)
+        self.ion_ruler_checkBox = QtWidgets.QCheckBox(Form)
+        self.ion_ruler_checkBox.setObjectName("ion_ruler_checkBox")
+        self.gridLayout.addWidget(self.ion_ruler_checkBox, 23, 0, 1, 1)
         self.crosshair_checkbox = QtWidgets.QCheckBox(Form)
+        self.crosshair_checkbox.setChecked(True)
         self.crosshair_checkbox.setObjectName("crosshair_checkbox")
         self.gridLayout.addWidget(self.crosshair_checkbox, 24, 1, 1, 1)
+        spacerItem1 = QtWidgets.QSpacerItem(20, 40, QtWidgets.QSizePolicy.Minimum, QtWidgets.QSizePolicy.Expanding)
+        self.gridLayout.addItem(spacerItem1, 25, 0, 1, 3)
         self.spinBox_resolution_y = QtWidgets.QSpinBox(Form)
         self.spinBox_resolution_y.setMinimum(1)
         self.spinBox_resolution_y.setMaximum(999999999)
         self.spinBox_resolution_y.setProperty("value", 1024)
         self.spinBox_resolution_y.setObjectName("spinBox_resolution_y")
         self.gridLayout.addWidget(self.spinBox_resolution_y, 4, 2, 1, 1)
-        self.ion_ruler_label = QtWidgets.QLabel(Form)
-        self.ion_ruler_label.setText("")
-        self.ion_ruler_label.setObjectName("ion_ruler_label")
-        self.gridLayout.addWidget(self.ion_ruler_label, 23, 1, 1, 2)
+        self.set_detector_button = QtWidgets.QPushButton(Form)
+        self.set_detector_button.setObjectName("set_detector_button")
+        self.gridLayout.addWidget(self.set_detector_button, 12, 1, 1, 2)
+        self.checkBox_image_use_autocontrast = QtWidgets.QCheckBox(Form)
+        self.checkBox_image_use_autocontrast.setChecked(True)
+        self.checkBox_image_use_autocontrast.setObjectName("checkBox_image_use_autocontrast")
+        self.gridLayout.addWidget(self.checkBox_image_use_autocontrast, 8, 0, 1, 1)
         self.label_11 = QtWidgets.QLabel(Form)
         self.label_11.setObjectName("label_11")
         self.gridLayout.addWidget(self.label_11, 21, 0, 1, 1)
-        self.label_10 = QtWidgets.QLabel(Form)
-        self.label_10.setObjectName("label_10")
-        self.gridLayout.addWidget(self.label_10, 20, 0, 1, 1)
+        self.comboBox_presets = QtWidgets.QComboBox(Form)
+        self.comboBox_presets.setObjectName("comboBox_presets")
+        self.gridLayout.addWidget(self.comboBox_presets, 7, 1, 1, 2)
+        self.lineEdit_image_path = QtWidgets.QLineEdit(Form)
+        self.lineEdit_image_path.setObjectName("lineEdit_image_path")
+        self.gridLayout.addWidget(self.lineEdit_image_path, 10, 1, 1, 2)
+        self.shift_y = QtWidgets.QDoubleSpinBox(Form)
+        self.shift_y.setMaximum(1000.0)
+        self.shift_y.setObjectName("shift_y")
+        self.gridLayout.addWidget(self.shift_y, 22, 2, 1, 1)
+        self.detector_contrast_label = QtWidgets.QLabel(Form)
+        self.detector_contrast_label.setObjectName("detector_contrast_label")
+        self.gridLayout.addWidget(self.detector_contrast_label, 16, 2, 1, 1)
+        self.doubleSpinBox_image_dwell_time = QtWidgets.QDoubleSpinBox(Form)
+        self.doubleSpinBox_image_dwell_time.setMaximum(10000000000000.0)
+        self.doubleSpinBox_image_dwell_time.setSingleStep(0.01)
+        self.doubleSpinBox_image_dwell_time.setProperty("value", 1.0)
+        self.doubleSpinBox_image_dwell_time.setObjectName("doubleSpinBox_image_dwell_time")
+        self.gridLayout.addWidget(self.doubleSpinBox_image_dwell_time, 5, 1, 1, 1)
+        self.label_8 = QtWidgets.QLabel(Form)
+        self.label_8.setObjectName("label_8")
+        self.gridLayout.addWidget(self.label_8, 1, 0, 1, 1)
+        self.checkBox_image_use_autogamma = QtWidgets.QCheckBox(Form)
+        self.checkBox_image_use_autogamma.setObjectName("checkBox_image_use_autogamma")
+        self.gridLayout.addWidget(self.checkBox_image_use_autogamma, 8, 1, 1, 1)
+        self.label_9 = QtWidgets.QLabel(Form)
+        self.label_9.setObjectName("label_9")
+        self.gridLayout.addWidget(self.label_9, 19, 0, 1, 1)
+        self.detector_type_combobox = QtWidgets.QComboBox(Form)
+        self.detector_type_combobox.setObjectName("detector_type_combobox")
+        self.gridLayout.addWidget(self.detector_type_combobox, 13, 1, 1, 2)
+        self.label_image_dwell_time = QtWidgets.QLabel(Form)
+        self.label_image_dwell_time.setObjectName("label_image_dwell_time")
+        self.gridLayout.addWidget(self.label_image_dwell_time, 5, 0, 1, 1)
+        self.label_3 = QtWidgets.QLabel(Form)
+        self.label_3.setObjectName("label_3")
+        self.gridLayout.addWidget(self.label_3, 14, 0, 1, 1)
+        self.checkBox_image_save_image = QtWidgets.QCheckBox(Form)
+        self.checkBox_image_save_image.setObjectName("checkBox_image_save_image")
+        self.gridLayout.addWidget(self.checkBox_image_save_image, 9, 0, 1, 1)
         self.detector_contrast_slider = QtWidgets.QSlider(Form)
         self.detector_contrast_slider.setMaximum(100)
         self.detector_contrast_slider.setSliderPosition(50)
         self.detector_contrast_slider.setOrientation(QtCore.Qt.Horizontal)
         self.detector_contrast_slider.setTickPosition(QtWidgets.QSlider.TicksAbove)
         self.detector_contrast_slider.setTickInterval(10)
         self.detector_contrast_slider.setObjectName("detector_contrast_slider")
         self.gridLayout.addWidget(self.detector_contrast_slider, 16, 1, 1, 1)
-        self.ion_ruler_checkBox = QtWidgets.QCheckBox(Form)
-        self.ion_ruler_checkBox.setObjectName("ion_ruler_checkBox")
-        self.gridLayout.addWidget(self.ion_ruler_checkBox, 23, 0, 1, 1)
-        self.pushButton_take_all_images = QtWidgets.QPushButton(Form)
-        self.pushButton_take_all_images.setObjectName("pushButton_take_all_images")
-        self.gridLayout.addWidget(self.pushButton_take_all_images, 27, 0, 1, 3)
-        self.label_image_resolution = QtWidgets.QLabel(Form)
-        self.label_image_resolution.setObjectName("label_image_resolution")
-        self.gridLayout.addWidget(self.label_image_resolution, 4, 0, 1, 1)
-        self.checkBox_image_use_autogamma = QtWidgets.QCheckBox(Form)
-        self.checkBox_image_use_autogamma.setObjectName("checkBox_image_use_autogamma")
-        self.gridLayout.addWidget(self.checkBox_image_use_autogamma, 8, 1, 1, 1)
-        self.label_9 = QtWidgets.QLabel(Form)
-        self.label_9.setObjectName("label_9")
-        self.gridLayout.addWidget(self.label_9, 19, 0, 1, 1)
+        self.label_2 = QtWidgets.QLabel(Form)
+        self.label_2.setObjectName("label_2")
+        self.gridLayout.addWidget(self.label_2, 13, 0, 1, 1)
+        self.working_distance = QtWidgets.QDoubleSpinBox(Form)
+        self.working_distance.setMaximum(1000.0)
+        self.working_distance.setObjectName("working_distance")
+        self.gridLayout.addWidget(self.working_distance, 18, 1, 1, 1)
+        self.label = QtWidgets.QLabel(Form)
+        font = QtGui.QFont()
+        font.setPointSize(12)
+        font.setBold(True)
+        font.setWeight(75)
+        self.label.setFont(font)
+        self.label.setObjectName("label")
+        self.gridLayout.addWidget(self.label, 12, 0, 1, 1)
+        self.doubleSpinBox_image_hfw = QtWidgets.QDoubleSpinBox(Form)
+        self.doubleSpinBox_image_hfw.setMaximum(100000000.0)
+        self.doubleSpinBox_image_hfw.setSingleStep(0.1)
+        self.doubleSpinBox_image_hfw.setProperty("value", 150.0)
+        self.doubleSpinBox_image_hfw.setObjectName("doubleSpinBox_image_hfw")
+        self.gridLayout.addWidget(self.doubleSpinBox_image_hfw, 6, 1, 1, 1)
+        self.selected_beam = QtWidgets.QComboBox(Form)
+        self.selected_beam.setObjectName("selected_beam")
+        self.gridLayout.addWidget(self.selected_beam, 1, 1, 1, 2)
+        self.label_6 = QtWidgets.QLabel(Form)
+        font = QtGui.QFont()
+        font.setPointSize(12)
+        font.setBold(True)
+        font.setWeight(75)
+        self.label_6.setFont(font)
+        self.label_6.setObjectName("label_6")
+        self.gridLayout.addWidget(self.label_6, 17, 0, 1, 1)
+        self.lineEdit_image_label = QtWidgets.QLineEdit(Form)
+        self.lineEdit_image_label.setObjectName("lineEdit_image_label")
+        self.gridLayout.addWidget(self.lineEdit_image_label, 11, 1, 1, 2)
         self.detector_mode_combobox = QtWidgets.QComboBox(Form)
         self.detector_mode_combobox.setObjectName("detector_mode_combobox")
         self.gridLayout.addWidget(self.detector_mode_combobox, 14, 1, 1, 2)
+        self.stigmation_x = QtWidgets.QDoubleSpinBox(Form)
+        self.stigmation_x.setMaximum(1000.0)
+        self.stigmation_x.setObjectName("stigmation_x")
+        self.gridLayout.addWidget(self.stigmation_x, 21, 1, 1, 1)
+        self.label_image_hfw = QtWidgets.QLabel(Form)
+        self.label_image_hfw.setObjectName("label_image_hfw")
+        self.gridLayout.addWidget(self.label_image_hfw, 6, 0, 1, 1)
+        self.label_10 = QtWidgets.QLabel(Form)
+        self.label_10.setObjectName("label_10")
+        self.gridLayout.addWidget(self.label_10, 20, 0, 1, 1)
         self.scalebar_checkbox = QtWidgets.QCheckBox(Form)
         self.scalebar_checkbox.setObjectName("scalebar_checkbox")
         self.gridLayout.addWidget(self.scalebar_checkbox, 24, 0, 1, 1)
-        self.label_2 = QtWidgets.QLabel(Form)
-        self.label_2.setObjectName("label_2")
-        self.gridLayout.addWidget(self.label_2, 13, 0, 1, 1)
-        self.label_presets = QtWidgets.QLabel(Form)
-        self.label_presets.setObjectName("label_presets")
-        self.gridLayout.addWidget(self.label_presets, 7, 0, 1, 1)
-        self.comboBox_presets = QtWidgets.QComboBox(Form)
-        self.comboBox_presets.setObjectName("comboBox_presets")
-        self.gridLayout.addWidget(self.comboBox_presets, 7, 1, 1, 2)
 
         self.retranslateUi(Form)
         QtCore.QMetaObject.connectSlotsByName(Form)
 
     def retranslateUi(self, Form):
         _translate = QtCore.QCoreApplication.translate
         Form.setWindowTitle(_translate("Form", "Form"))
-        self.label_image_save_path.setText(_translate("Form", "Path"))
-        self.label_12.setText(_translate("Form", "Shift (x,y) (um)"))
-        self.set_detector_button.setText(_translate("Form", "Set Detector Settings"))
-        self.label_image_hfw.setText(_translate("Form", "Horizontal Field Width (um)"))
-        self.label_4.setText(_translate("Form", "Brightness (%)"))
-        self.label_7.setText(_translate("Form", "Working Distance (mm)"))
+        self.pushButton_take_all_images.setText(_translate("Form", "Acquire All Images"))
         self.label_5.setText(_translate("Form", "Contrast (%)"))
-        self.label.setText(_translate("Form", "Detector Settings"))
+        self.label_7.setText(_translate("Form", "Working Distance (mm)"))
         self.button_set_beam_settings.setText(_translate("Form", "Set Beam Settings"))
-        self.detector_contrast_label.setText(_translate("Form", "50%"))
         self.label_image_label.setText(_translate("Form", "Label"))
-        self.pushButton_take_image.setText(_translate("Form", "Acquire Image"))
-        self.label_image_dwell_time.setText(_translate("Form", "Dwell Time (us)"))
-        self.label_8.setText(_translate("Form", "Beam"))
-        self.label_6.setText(_translate("Form", "Beam Settings"))
-        self.checkBox_image_save_image.setText(_translate("Form", "Save Image"))
-        self.label_3.setText(_translate("Form", "Mode"))
         self.detector_brightness_label.setText(_translate("Form", "50%"))
-        self.checkBox_image_use_autocontrast.setText(_translate("Form", "AutoContrast"))
+        self.label_4.setText(_translate("Form", "Brightness (%)"))
+        self.label_image_save_path.setText(_translate("Form", "Path"))
+        self.label_image_resolution.setText(_translate("Form", "Resolution (px)"))
+        self.pushButton_take_image.setText(_translate("Form", "Acquire Image"))
+        self.label_presets.setText(_translate("Form", "Preset"))
+        self.label_12.setText(_translate("Form", "Shift (x,y) (um)"))
         self.label_title.setText(_translate("Form", "Image Settings"))
+        self.ion_ruler_checkBox.setText(_translate("Form", "Ruler "))
         self.crosshair_checkbox.setText(_translate("Form", "Cross Hair"))
+        self.set_detector_button.setText(_translate("Form", "Set Detector Settings"))
+        self.checkBox_image_use_autocontrast.setText(_translate("Form", "AutoContrast"))
         self.label_11.setText(_translate("Form", "Stigmation (x,y)"))
-        self.label_10.setText(_translate("Form", "Voltage (kV)"))
-        self.ion_ruler_checkBox.setText(_translate("Form", "Ruler "))
-        self.pushButton_take_all_images.setText(_translate("Form", "Acquire All Images"))
-        self.label_image_resolution.setText(_translate("Form", "Resolution (px)"))
+        self.detector_contrast_label.setText(_translate("Form", "50%"))
+        self.label_8.setText(_translate("Form", "Beam"))
         self.checkBox_image_use_autogamma.setText(_translate("Form", "AutoGamma"))
         self.label_9.setText(_translate("Form", "Beam Current (pA)"))
-        self.scalebar_checkbox.setText(_translate("Form", "Scale Bar"))
+        self.label_image_dwell_time.setText(_translate("Form", "Dwell Time (us)"))
+        self.label_3.setText(_translate("Form", "Mode"))
+        self.checkBox_image_save_image.setText(_translate("Form", "Save Image"))
         self.label_2.setText(_translate("Form", "Type"))
-        self.label_presets.setText(_translate("Form", "Preset"))
+        self.label.setText(_translate("Form", "Detector Settings"))
+        self.label_6.setText(_translate("Form", "Beam Settings"))
+        self.label_image_hfw.setText(_translate("Form", "Horizontal Field Width (um)"))
+        self.label_10.setText(_translate("Form", "Voltage (kV)"))
+        self.scalebar_checkbox.setText(_translate("Form", "Scale Bar"))
```

## fibsem/ui/qtdesigner_files/ImageSettingsWidget.ui

### fibsem/ui/qtdesigner_files/ImageSettingsWidget.ui

```diff
@@ -2,61 +2,55 @@
 <ui version="4.0">
   <class>Form</class>
   <widget class="QWidget" name="Form">
     <property name="geometry">
       <rect>
         <x>0</x>
         <y>0</y>
-        <width>369</width>
+        <width>444</width>
         <height>765</height>
       </rect>
     </property>
     <property name="windowTitle">
       <string>Form</string>
     </property>
     <layout class="QGridLayout" name="gridLayout">
-      <item row="10" column="0">
-        <widget class="QLabel" name="label_image_save_path">
+      <item row="27" column="0" colspan="3">
+        <widget class="QPushButton" name="pushButton_take_all_images">
           <property name="text">
-            <string>Path</string>
+            <string>Acquire All Images</string>
           </property>
         </widget>
       </item>
-      <item row="22" column="0">
-        <widget class="QLabel" name="label_12">
-          <property name="text">
-            <string>Shift (x,y) (um)</string>
+      <item row="15" column="1">
+        <widget class="QSlider" name="detector_brightness_slider">
+          <property name="maximum">
+            <number>100</number>
           </property>
-        </widget>
-      </item>
-      <item row="12" column="1" colspan="2">
-        <widget class="QPushButton" name="set_detector_button">
-          <property name="text">
-            <string>Set Detector Settings</string>
+          <property name="sliderPosition">
+            <number>50</number>
           </property>
-        </widget>
-      </item>
-      <item row="6" column="0">
-        <widget class="QLabel" name="label_image_hfw">
-          <property name="text">
-            <string>Horizontal Field Width (um)</string>
+          <property name="orientation">
+            <enum>Qt::Horizontal</enum>
           </property>
-        </widget>
-      </item>
-      <item row="18" column="1">
-        <widget class="QDoubleSpinBox" name="working_distance">
-          <property name="maximum">
-            <double>1000.000000000000000</double>
+          <property name="invertedAppearance">
+            <bool>false</bool>
+          </property>
+          <property name="tickPosition">
+            <enum>QSlider::TicksAbove</enum>
+          </property>
+          <property name="tickInterval">
+            <number>10</number>
           </property>
         </widget>
       </item>
-      <item row="15" column="0">
-        <widget class="QLabel" name="label_4">
+      <item row="16" column="0">
+        <widget class="QLabel" name="label_5">
           <property name="text">
-            <string>Brightness (%)</string>
+            <string>Contrast (%)</string>
           </property>
         </widget>
       </item>
       <item row="19" column="1">
         <widget class="QDoubleSpinBox" name="beam_current">
           <property name="maximum">
             <double>1000.000000000000000</double>
@@ -66,127 +60,101 @@
       <item row="18" column="0">
         <widget class="QLabel" name="label_7">
           <property name="text">
             <string>Working Distance (mm)</string>
           </property>
         </widget>
       </item>
-      <item row="16" column="0">
-        <widget class="QLabel" name="label_5">
+      <item row="17" column="1" colspan="2">
+        <widget class="QPushButton" name="button_set_beam_settings">
           <property name="text">
-            <string>Contrast (%)</string>
+            <string>Set Beam Settings</string>
           </property>
         </widget>
       </item>
-      <item row="11" column="1" colspan="2">
-        <widget class="QLineEdit" name="lineEdit_image_label"/>
-      </item>
-      <item row="4" column="1">
-        <widget class="QSpinBox" name="spinBox_resolution_x">
-          <property name="minimum">
-            <number>1</number>
-          </property>
-          <property name="maximum">
-            <number>999999999</number>
-          </property>
-          <property name="value">
-            <number>1536</number>
+      <item row="11" column="0">
+        <widget class="QLabel" name="label_image_label">
+          <property name="text">
+            <string>Label</string>
           </property>
         </widget>
       </item>
-      <item row="12" column="0">
-        <widget class="QLabel" name="label">
-          <property name="font">
-            <font>
-              <pointsize>12</pointsize>
-              <weight>75</weight>
-              <bold>true</bold>
-            </font>
-          </property>
+      <item row="15" column="2">
+        <widget class="QLabel" name="detector_brightness_label">
           <property name="text">
-            <string>Detector Settings</string>
+            <string>50%</string>
           </property>
         </widget>
       </item>
-      <item row="17" column="1" colspan="2">
-        <widget class="QPushButton" name="button_set_beam_settings">
+      <item row="23" column="1" colspan="2">
+        <widget class="QLabel" name="ion_ruler_label">
           <property name="text">
-            <string>Set Beam Settings</string>
+            <string/>
           </property>
         </widget>
       </item>
-      <item row="16" column="2">
-        <widget class="QLabel" name="detector_contrast_label">
+      <item row="15" column="0">
+        <widget class="QLabel" name="label_4">
           <property name="text">
-            <string>50%</string>
+            <string>Brightness (%)</string>
           </property>
         </widget>
       </item>
-      <item row="11" column="0">
-        <widget class="QLabel" name="label_image_label">
+      <item row="10" column="0">
+        <widget class="QLabel" name="label_image_save_path">
           <property name="text">
-            <string>Label</string>
+            <string>Path</string>
           </property>
         </widget>
       </item>
-      <item row="21" column="2">
-        <widget class="QDoubleSpinBox" name="stigmation_y">
-          <property name="maximum">
-            <double>1000.000000000000000</double>
+      <item row="4" column="0">
+        <widget class="QLabel" name="label_image_resolution">
+          <property name="text">
+            <string>Resolution (px)</string>
           </property>
         </widget>
       </item>
       <item row="26" column="0" colspan="3">
         <widget class="QPushButton" name="pushButton_take_image">
           <property name="text">
             <string>Acquire Image</string>
           </property>
         </widget>
       </item>
-      <item row="5" column="0">
-        <widget class="QLabel" name="label_image_dwell_time">
+      <item row="7" column="0">
+        <widget class="QLabel" name="label_presets">
           <property name="text">
-            <string>Dwell Time (us)</string>
+            <string>Preset</string>
           </property>
         </widget>
       </item>
-      <item row="1" column="1" colspan="2">
-        <widget class="QComboBox" name="selected_beam"/>
+      <item row="20" column="1">
+        <widget class="QDoubleSpinBox" name="beam_voltage">
+          <property name="maximum">
+            <double>100000.000000000000000</double>
+          </property>
+        </widget>
       </item>
-      <item row="1" column="0">
-        <widget class="QLabel" name="label_8">
+      <item row="22" column="0">
+        <widget class="QLabel" name="label_12">
           <property name="text">
-            <string>Beam</string>
+            <string>Shift (x,y) (um)</string>
           </property>
         </widget>
       </item>
-      <item row="5" column="1">
-        <widget class="QDoubleSpinBox" name="doubleSpinBox_image_dwell_time">
-          <property name="maximum">
-            <double>10000000000000.000000000000000</double>
+      <item row="4" column="1">
+        <widget class="QSpinBox" name="spinBox_resolution_x">
+          <property name="minimum">
+            <number>1</number>
           </property>
-          <property name="singleStep">
-            <double>0.010000000000000</double>
+          <property name="maximum">
+            <number>999999999</number>
           </property>
           <property name="value">
-            <double>1.000000000000000</double>
-          </property>
-        </widget>
-      </item>
-      <item row="17" column="0">
-        <widget class="QLabel" name="label_6">
-          <property name="font">
-            <font>
-              <pointsize>12</pointsize>
-              <weight>75</weight>
-              <bold>true</bold>
-            </font>
-          </property>
-          <property name="text">
-            <string>Beam Settings</string>
+            <number>1536</number>
           </property>
         </widget>
       </item>
       <item row="28" column="0" colspan="3">
         <spacer name="verticalSpacer">
           <property name="orientation">
             <enum>Qt::Vertical</enum>
@@ -195,71 +163,56 @@
             <size>
               <width>20</width>
               <height>40</height>
             </size>
           </property>
         </spacer>
       </item>
-      <item row="22" column="1">
-        <widget class="QDoubleSpinBox" name="shift_x">
+      <item row="21" column="2">
+        <widget class="QDoubleSpinBox" name="stigmation_y">
           <property name="maximum">
             <double>1000.000000000000000</double>
           </property>
         </widget>
       </item>
-      <item row="13" column="1" colspan="2">
-        <widget class="QComboBox" name="detector_type_combobox"/>
-      </item>
-      <item row="21" column="1">
-        <widget class="QDoubleSpinBox" name="stigmation_x">
+      <item row="22" column="1">
+        <widget class="QDoubleSpinBox" name="shift_x">
           <property name="maximum">
             <double>1000.000000000000000</double>
           </property>
         </widget>
       </item>
-      <item row="22" column="2">
-        <widget class="QDoubleSpinBox" name="shift_y">
-          <property name="maximum">
-            <double>1000.000000000000000</double>
+      <item row="2" column="0">
+        <widget class="QLabel" name="label_title">
+          <property name="font">
+            <font>
+              <pointsize>12</pointsize>
+              <weight>75</weight>
+              <bold>true</bold>
+            </font>
           </property>
-        </widget>
-      </item>
-      <item row="9" column="0">
-        <widget class="QCheckBox" name="checkBox_image_save_image">
           <property name="text">
-            <string>Save Image</string>
+            <string>Image Settings</string>
           </property>
         </widget>
       </item>
-      <item row="15" column="1">
-        <widget class="QSlider" name="detector_brightness_slider">
-          <property name="maximum">
-            <number>100</number>
-          </property>
-          <property name="sliderPosition">
-            <number>50</number>
-          </property>
-          <property name="orientation">
-            <enum>Qt::Horizontal</enum>
-          </property>
-          <property name="invertedAppearance">
-            <bool>false</bool>
-          </property>
-          <property name="tickPosition">
-            <enum>QSlider::TicksAbove</enum>
-          </property>
-          <property name="tickInterval">
-            <number>10</number>
+      <item row="23" column="0">
+        <widget class="QCheckBox" name="ion_ruler_checkBox">
+          <property name="text">
+            <string>Ruler</string>
           </property>
         </widget>
       </item>
-      <item row="20" column="1">
-        <widget class="QDoubleSpinBox" name="beam_voltage">
-          <property name="maximum">
-            <double>100000.000000000000000</double>
+      <item row="24" column="1">
+        <widget class="QCheckBox" name="crosshair_checkbox">
+          <property name="text">
+            <string>Cross Hair</string>
+          </property>
+          <property name="checked">
+            <bool>true</bool>
           </property>
         </widget>
       </item>
       <item row="25" column="0" colspan="3">
         <spacer name="verticalSpacer_2">
           <property name="orientation">
             <enum>Qt::Vertical</enum>
@@ -268,106 +221,126 @@
             <size>
               <width>20</width>
               <height>40</height>
             </size>
           </property>
         </spacer>
       </item>
-      <item row="10" column="1" colspan="2">
-        <widget class="QLineEdit" name="lineEdit_image_path"/>
-      </item>
-      <item row="6" column="1">
-        <widget class="QDoubleSpinBox" name="doubleSpinBox_image_hfw">
-          <property name="maximum">
-            <double>2700.000000000000000</double>
+      <item row="4" column="2">
+        <widget class="QSpinBox" name="spinBox_resolution_y">
+          <property name="minimum">
+            <number>1</number>
           </property>
-          <property name="singleStep">
-            <double>0.100000000000000</double>
+          <property name="maximum">
+            <number>999999999</number>
           </property>
           <property name="value">
-            <double>150.000000000000000</double>
-          </property>
-        </widget>
-      </item>
-      <item row="14" column="0">
-        <widget class="QLabel" name="label_3">
-          <property name="text">
-            <string>Mode</string>
+            <number>1024</number>
           </property>
         </widget>
       </item>
-      <item row="15" column="2">
-        <widget class="QLabel" name="detector_brightness_label">
+      <item row="12" column="1" colspan="2">
+        <widget class="QPushButton" name="set_detector_button">
           <property name="text">
-            <string>50%</string>
+            <string>Set Detector Settings</string>
           </property>
         </widget>
       </item>
       <item row="8" column="0">
         <widget class="QCheckBox" name="checkBox_image_use_autocontrast">
           <property name="text">
             <string>AutoContrast</string>
           </property>
           <property name="checked">
             <bool>true</bool>
           </property>
         </widget>
       </item>
-      <item row="2" column="0">
-        <widget class="QLabel" name="label_title">
-          <property name="font">
-            <font>
-              <pointsize>12</pointsize>
-              <weight>75</weight>
-              <bold>true</bold>
-            </font>
-          </property>
+      <item row="21" column="0">
+        <widget class="QLabel" name="label_11">
           <property name="text">
-            <string>Image Settings</string>
+            <string>Stigmation (x,y)</string>
           </property>
         </widget>
       </item>
-      <item row="24" column="1">
-        <widget class="QCheckBox" name="crosshair_checkbox">
-          <property name="text">
-            <string>Cross Hair</string>
+      <item row="7" column="1" colspan="2">
+        <widget class="QComboBox" name="comboBox_presets"/>
+      </item>
+      <item row="10" column="1" colspan="2">
+        <widget class="QLineEdit" name="lineEdit_image_path"/>
+      </item>
+      <item row="22" column="2">
+        <widget class="QDoubleSpinBox" name="shift_y">
+          <property name="maximum">
+            <double>1000.000000000000000</double>
           </property>
         </widget>
       </item>
-      <item row="4" column="2">
-        <widget class="QSpinBox" name="spinBox_resolution_y">
-          <property name="minimum">
-            <number>1</number>
+      <item row="16" column="2">
+        <widget class="QLabel" name="detector_contrast_label">
+          <property name="text">
+            <string>50%</string>
           </property>
+        </widget>
+      </item>
+      <item row="5" column="1">
+        <widget class="QDoubleSpinBox" name="doubleSpinBox_image_dwell_time">
           <property name="maximum">
-            <number>999999999</number>
+            <double>10000000000000.000000000000000</double>
+          </property>
+          <property name="singleStep">
+            <double>0.010000000000000</double>
           </property>
           <property name="value">
-            <number>1024</number>
+            <double>1.000000000000000</double>
           </property>
         </widget>
       </item>
-      <item row="23" column="1" colspan="2">
-        <widget class="QLabel" name="ion_ruler_label">
+      <item row="1" column="0">
+        <widget class="QLabel" name="label_8">
           <property name="text">
-            <string/>
+            <string>Beam</string>
           </property>
         </widget>
       </item>
-      <item row="21" column="0">
-        <widget class="QLabel" name="label_11">
+      <item row="8" column="1">
+        <widget class="QCheckBox" name="checkBox_image_use_autogamma">
           <property name="text">
-            <string>Stigmation (x,y)</string>
+            <string>AutoGamma</string>
           </property>
         </widget>
       </item>
-      <item row="20" column="0">
-        <widget class="QLabel" name="label_10">
+      <item row="19" column="0">
+        <widget class="QLabel" name="label_9">
           <property name="text">
-            <string>Voltage (kV)</string>
+            <string>Beam Current (pA)</string>
+          </property>
+        </widget>
+      </item>
+      <item row="13" column="1" colspan="2">
+        <widget class="QComboBox" name="detector_type_combobox"/>
+      </item>
+      <item row="5" column="0">
+        <widget class="QLabel" name="label_image_dwell_time">
+          <property name="text">
+            <string>Dwell Time (us)</string>
+          </property>
+        </widget>
+      </item>
+      <item row="14" column="0">
+        <widget class="QLabel" name="label_3">
+          <property name="text">
+            <string>Mode</string>
+          </property>
+        </widget>
+      </item>
+      <item row="9" column="0">
+        <widget class="QCheckBox" name="checkBox_image_save_image">
+          <property name="text">
+            <string>Save Image</string>
           </property>
         </widget>
       </item>
       <item row="16" column="1">
         <widget class="QSlider" name="detector_contrast_slider">
           <property name="maximum">
             <number>100</number>
@@ -382,74 +355,104 @@
             <enum>QSlider::TicksAbove</enum>
           </property>
           <property name="tickInterval">
             <number>10</number>
           </property>
         </widget>
       </item>
-      <item row="23" column="0">
-        <widget class="QCheckBox" name="ion_ruler_checkBox">
+      <item row="13" column="0">
+        <widget class="QLabel" name="label_2">
           <property name="text">
-            <string>Ruler</string>
+            <string>Type</string>
           </property>
         </widget>
       </item>
-      <item row="27" column="0" colspan="3">
-        <widget class="QPushButton" name="pushButton_take_all_images">
-          <property name="text">
-            <string>Acquire All Images</string>
+      <item row="18" column="1">
+        <widget class="QDoubleSpinBox" name="working_distance">
+          <property name="maximum">
+            <double>1000.000000000000000</double>
           </property>
         </widget>
       </item>
-      <item row="4" column="0">
-        <widget class="QLabel" name="label_image_resolution">
+      <item row="12" column="0">
+        <widget class="QLabel" name="label">
+          <property name="font">
+            <font>
+              <pointsize>12</pointsize>
+              <weight>75</weight>
+              <bold>true</bold>
+            </font>
+          </property>
           <property name="text">
-            <string>Resolution (px)</string>
+            <string>Detector Settings</string>
           </property>
         </widget>
       </item>
-      <item row="8" column="1">
-        <widget class="QCheckBox" name="checkBox_image_use_autogamma">
-          <property name="text">
-            <string>AutoGamma</string>
+      <item row="6" column="1">
+        <widget class="QDoubleSpinBox" name="doubleSpinBox_image_hfw">
+          <property name="maximum">
+            <double>100000000.000000000000000</double>
+          </property>
+          <property name="singleStep">
+            <double>0.100000000000000</double>
+          </property>
+          <property name="value">
+            <double>150.000000000000000</double>
           </property>
         </widget>
       </item>
-      <item row="19" column="0">
-        <widget class="QLabel" name="label_9">
+      <item row="1" column="1" colspan="2">
+        <widget class="QComboBox" name="selected_beam"/>
+      </item>
+      <item row="17" column="0">
+        <widget class="QLabel" name="label_6">
+          <property name="font">
+            <font>
+              <pointsize>12</pointsize>
+              <weight>75</weight>
+              <bold>true</bold>
+            </font>
+          </property>
           <property name="text">
-            <string>Beam Current (pA)</string>
+            <string>Beam Settings</string>
           </property>
         </widget>
       </item>
+      <item row="11" column="1" colspan="2">
+        <widget class="QLineEdit" name="lineEdit_image_label"/>
+      </item>
       <item row="14" column="1" colspan="2">
         <widget class="QComboBox" name="detector_mode_combobox"/>
       </item>
-      <item row="24" column="0">
-        <widget class="QCheckBox" name="scalebar_checkbox">
-          <property name="text">
-            <string>Scale Bar</string>
+      <item row="21" column="1">
+        <widget class="QDoubleSpinBox" name="stigmation_x">
+          <property name="maximum">
+            <double>1000.000000000000000</double>
           </property>
         </widget>
       </item>
-      <item row="13" column="0">
-        <widget class="QLabel" name="label_2">
+      <item row="6" column="0">
+        <widget class="QLabel" name="label_image_hfw">
           <property name="text">
-            <string>Type</string>
+            <string>Horizontal Field Width (um)</string>
           </property>
         </widget>
       </item>
-      <item row="7" column="0">
-        <widget class="QLabel" name="label_presets">
+      <item row="20" column="0">
+        <widget class="QLabel" name="label_10">
           <property name="text">
-            <string>Preset</string>
+            <string>Voltage (kV)</string>
           </property>
         </widget>
       </item>
-      <item row="7" column="1" colspan="2">
-        <widget class="QComboBox" name="comboBox_presets"/>
+      <item row="24" column="0">
+        <widget class="QCheckBox" name="scalebar_checkbox">
+          <property name="text">
+            <string>Scale Bar</string>
+          </property>
+        </widget>
       </item>
     </layout>
   </widget>
   <resources/>
   <connections/>
 </ui>
```

## Comparing `fibsem-0.2.1a1.dist-info/LICENSE` & `fibsem-0.2.2a0.dist-info/LICENSE`

 * *Files identical despite different names*

## Comparing `fibsem-0.2.1a1.dist-info/METADATA` & `fibsem-0.2.2a0.dist-info/METADATA`

 * *Files 0% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: fibsem
-Version: 0.2.1a1
+Version: 0.2.2a0
 Summary: a universal api for fibsem control
 Home-page: https://github.com/DeMarcoLab/fibsem
 Author: Patrick Cleeve
 Author-email: Patrick Cleeve <Patrick.Cleeve@monash.edu>
 Project-URL: Bug Tracker, https://github.com/DeMarcoLab/fibsem/issues
 Classifier: Programming Language :: Python :: 3
 Classifier: License :: OSI Approved :: MIT License
```

## Comparing `fibsem-0.2.1a1.dist-info/RECORD` & `fibsem-0.2.2a0.dist-info/RECORD`

 * *Files 10% similar despite different names*

```diff
@@ -1,123 +1,135 @@
 fibsem/__init__.py,sha256=MNTJ0oJ3wIpJge309InPWVgGR3oqixRPDKKkO9X4oKE,152
 fibsem/_version.py,sha256=BFJqhYE8NvU2Ilxv1WLKbG6TGbfS1z3lzUdhDpy4SEM,215
-fibsem/acquire.py,sha256=Xw8Xi-_eqM08UW1UMtIwc_nFuK-wUeQsqh47AXPMpYE,10798
-fibsem/alignment.py,sha256=6FTU1qxndIJEmy46oIe75O-ZwZaqv32ERaFVlnNBsU8,14403
+fibsem/acquire.py,sha256=fmgRvIS0t4VOk1UF-LJ6m9dpR2KfKakCx0KCjEoVzV8,11260
+fibsem/alignment.py,sha256=lDm7m2STqc3hv5OJZ09BLmrl5DLX0M1mphF7RB_je6A,16474
+fibsem/alignment2.py,sha256=r0-LZxWdyc_FhyXguLYGM7zxw0zHq5gFWhLL5jB8KU4,15034
 fibsem/calibration.py,sha256=mdbYU0RmphrC_v0HtV5BWpCJv6CbduZ5L6kvq_jFvzM,8460
-fibsem/config.py,sha256=iD-zFhT6gUW2QWrh1zqBltl5gQjZ_joT5BME02gMFkU,2499
+fibsem/config.py,sha256=NkqdK5TcivMODCfUjbNY9jSMP4XmTLCLO2Vykzk4F64,3102
 fibsem/constants.py,sha256=drvnQ_glkfWL3Stp-nIkJ9GjDru5LnwxS91JEzDAsds,532
 fibsem/conversions.py,sha256=41F_7Rq_nu-uhCv1g6x84R3WPipvl_B8EOHkuKcJXf8,4745
-fibsem/gis.py,sha256=ZgM7_pd2g08DwSkxvkf31PB4PFduUvA5nqzYc8nD6BM,1758
-fibsem/microscope.py,sha256=7chH_bd3ZJTICw-aCS-UGqtaBaMBOT6S3cUZHvb4EUU,206417
+fibsem/funky tescan error when reading beam current.txt,sha256=neBV3qHfhobIJBLyVyiYOBf9S0_s0uIsWgkJOl-JxFA,7376
+fibsem/gis.py,sha256=cUUh2rLkSLLuQT1-sJF50BBgIDcLhoRjoM5KVY0xqtM,2303
+fibsem/microscope.py,sha256=OEnagGcemrHw0d2fFwPcMvAKzjHkqH1Uj-a0-dwCW5M,218023
 fibsem/milling.py,sha256=so5lPp-WB0ZFbISuvL_PEnwkr40hbg8oWgSAHR3znf8,20788
-fibsem/movement.py,sha256=wepjFUeoaBepTnn3fwnS_Wev0GQkYI522MijToJ1uTw,6371
+fibsem/movement.py,sha256=IpjPwEyfEp4J9hFs4bb0BgZc241odrmTmF-u2wcDhmY,2327
 fibsem/napari.yaml,sha256=MuUxXwkbInlLLwM6O-rxx3ejq4G3YFQ_ijmsOwweLeg,251
-fibsem/patterning.py,sha256=Bccbo3WrD3ushL0dJzfl1Dp2bUfEVVKk_RIJbjl_FtQ,30440
-fibsem/structures.py,sha256=xNaX7ejCtCcr-QnzcHfVDThFd9CNWE4SrduRpKH1qXI,81645
-fibsem/testing.ipynb,sha256=lkGC0gGSFvY5PPwhHJ4FssH-FYx2OQ6Z7vMz5ucvwvo,2165
-fibsem/utils.py,sha256=P60oY6KavHfpbywZU6JelS5K3-_rDGuPV1kp9M4obDI,10790
+fibsem/patterning.py,sha256=aTNP8S9F3QO7B__JtHHvfCRCaIaCBIb5pcehLOzxucA,31600
+fibsem/structures.py,sha256=RY-g3oalfytfiOKp-3DAqAndnLErD7VIxcgxLOBwHOk,81745
+fibsem/testing.ipynb,sha256=TUa04yoNoebOhVFfB4lzuO-yywhf-zS3GsX_t-nifkw,5278
+fibsem/utils.py,sha256=E3lEuYVxhxw_skaHIgCZQScy7wLnqz3Or5MBR2iEjlA,9865
 fibsem/validation.py,sha256=hqguKnrelGWPLR0BhI5aka1gyWE8o14HV4cjQP70oMs,10545
 fibsem/chat/.gitignore,sha256=YxCu3KYQWuoI-10Ugd1y3Hc1iMLt5SSTyQ0uvZHJy14,51
 fibsem/chat/main.py,sha256=J_s9edPQUkrIr1AKEfWrDxIJHTfbjN2LVxXPxSm1h7c,1498
 fibsem/chat/requirements.txt,sha256=w4j_YMfb_0rCOrJI6kyHMc4gb8t5G4LCj9PqvLEnBvg,75
 fibsem/config/deposition.dbp,sha256=FifU2vApFJRQMIgV-ODcOFDorxdcl9nTAqo8q9SAhLM,693
-fibsem/config/model.yaml,sha256=URsu3bjMnqi_e3F5o64OhvqlPaqBVUY-r-3F__t0g5E,625
-fibsem/config/protocol.yaml,sha256=hxtWhXxSSIGwNclSaJTiYkwI025FT_ogPv3pvXDBs5M,1759
-fibsem/config/system.yaml,sha256=SbBYYwPggdFdlAEGbPCOS2rtKfdmDag70ulOlyUK_d8,1060
+fibsem/config/model.yaml,sha256=3V1aoR4Kd_J5kJ7mj5Y4YxOhXkzJtMNtJHECgh4I8-Y,627
+fibsem/config/positions.yaml,sha256=8j2iIipVzKhjbPKaLcm0AGjc8cGn_8MZBJxunYnz77M,768
+fibsem/config/protocol.yaml,sha256=_-a3zzI3cDN-d7uxl8cFplG7eDn1MwRfIuZ6YExdJb8,2011
+fibsem/config/system.yaml,sha256=tcw_OkygwipGccifSw_n9bafKKYsdZeCDnuKjIBBgDs,1887
 fibsem/detection/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
 fibsem/detection/app.py,sha256=1bmj8qtVkpzDoog4DQd947-Ba25Zp0TOSu7x-BWfMoU,3466
 fibsem/detection/app2.py,sha256=lBi__zXiWQYnz1e7I16B_cMGxV1nSyD-v3eoiOI13gQ,3599
-fibsem/detection/detection.py,sha256=VzyY61VY8lgnLoIwaXlRA0CRYCFRn9WcRSJWoEeg6KM,19410
+fibsem/detection/detection.py,sha256=wZDAhUz_I80Qk6ruf1AN3QvEMCueHzTSweXpo9XOiFQ,21444
 fibsem/detection/evaluation.py,sha256=SxbatO1knbjjeKP3Y1K0MuGBPMQyCBq1JI8WZpdCBYc,2842
 fibsem/detection/evalulation.ipynb,sha256=vL7QHpapGlapSVsx1m2d22-_JH3ciVD1Q_ZIqNKwfwU,32318
 fibsem/detection/grid_plot_summary.py,sha256=zj2xRm1V5uIzcXFdLLHskfN0ZzSsA55z5bmb-nsjZt4,2811
 fibsem/detection/model_evaluation.py,sha256=iOvxahfUsLicUg4tMtMKiNTxfJ0pd5BrXAPhi3pdIhI,6846
 fibsem/detection/notebook.ipynb,sha256=c5I_hGxoq88RSPX66kdKf6cCMl0oCAvx8c73EkuROmM,9103
 fibsem/detection/test_image.tif,sha256=dkF0fNJTMRJC00C9vDrQ1NAx_5kx-hbw_T0VUsJJex4,1573120
-fibsem/detection/utils.py,sha256=DHzr3vZSVYmIcQDIt23TASMUZi1qzQYIk157SJ23tWo,7934
+fibsem/detection/utils.py,sha256=6Esd8NfDaXACxpz4XXMgJy5T0noC3R8rNJ-3DRDVQLM,8015
 fibsem/imaging/.gitkeep,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
 fibsem/imaging/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
-fibsem/imaging/masks.py,sha256=r49iIjpR0G7WjEajkgTEstLc2WPbytLUjCGQr9DttuA,6409
+fibsem/imaging/_tile.py,sha256=5vU9xvaEcoxjPEBvJQ6Fqi-Kkt1XRY6VPUC6rLxjJp4,8890
+fibsem/imaging/masks.py,sha256=sNUj6yVlcMxqaSISxTXvXPcC8ychw9g-ytOQYF99evM,6991
 fibsem/imaging/utils.py,sha256=37056SttRmzdIqyQFC607CCMO8COvyHhgqsuSHhjTrQ,1865
 fibsem/log/positions.yaml,sha256=ESS7JLZWXxHhiowpKMhXWp9ZktEqxwV0jRn6juMLFvA,242
 fibsem/segmentation/README.md,sha256=3w2T6TP_u7EL2ShN0OKajVxd2T0GQpLzOQo_JIH0Dng,7471
 fibsem/segmentation/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
 fibsem/segmentation/config.py,sha256=LUum8ZMBhhmLSPOM6fjsYaJtGvxNg9LWzA1ETMJZ2pQ,739
 fibsem/segmentation/config.yml,sha256=Ujjid2r1ojUOpSmmPx4W8E_S22KSCQkS2UGrPPL92og,827
 fibsem/segmentation/dataset.py,sha256=4IMEc3LSFqCt0hn-0Zqij7X0rXPAtctiWEfoRM0Ci5s,5149
 fibsem/segmentation/example.ipynb,sha256=eRhBHkofmFBmfYsZ21wZOyxkZuwyfGvI5Z2Hw6WgnYI,80125
 fibsem/segmentation/inference.py,sha256=VmwRVrRvF7HVb9W_a3ymhrtbLlOne7opMArkHJhq_3Y,3499
-fibsem/segmentation/model.py,sha256=QHDdBvhXyT-_uZ1NxHwOxAIvDEM5D_QYkUyvG7EJLNo,3342
+fibsem/segmentation/model.py,sha256=c4apqqhJnSkkS3RzIDkz1oDFKDV4TJvrWimfZxjxnnE,3465
+fibsem/segmentation/requirements.txt,sha256=24AXZ6B3zGEk7SmEHX_zNkAnr0eJlcKtzJ2RzlRaB6Y,137
 fibsem/segmentation/test_image.tif,sha256=f22o6t7X6vnzZLUTng0erujSMj81Km2NODJwTY8BK6s,1407827
 fibsem/segmentation/train.py,sha256=OzVxLHrATSrKhtLYU6UNseUrjkEUnnZJSYOLX91Y_tU,8647
 fibsem/segmentation/utils.py,sha256=CpddE_jYB5S0Q5dMEnVHCY3kH-jCxQV-rv_4quR8kqA,12984
 fibsem/segmentation/docs/example_napari.png,sha256=6-jPqYxTyJH3wC6Hwv4nFF6DghzoI0kennxHciGittU,2954372
 fibsem/segmentation/docs/imgs/combined/combined.jpg,sha256=uLUta4le06xOlPerA9hiMgzU_HVhr6v0fAOZP9VpnUU,1270161
 fibsem/segmentation/docs/imgs/labelled/label.tif,sha256=T1-rZxpnC1VQRD1bul73kttwYGXD5ec0lpRkNkQJogU,1572986
 fibsem/segmentation/docs/imgs/raw/image.tif,sha256=wn2-Mu2q28-YFqYIK-QEyMTO8W5mbmLVlnjsbIH7gKo,1393274
 fibsem/segmentation/models/.gitkeep,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
 fibsem/ui/.gitkeep,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
 fibsem/ui/FibsemAlignmentWidget.py,sha256=06tlOKJxopDuU30ALVrZMaIjgwl4yFqqmIA9RiIEHLM,7668
+fibsem/ui/FibsemCryoSputterWidget.py,sha256=WVBcpNQm2uyXP1Vi_X83ZlB_sYdiJOdOjHque4gNf0U,2393
 fibsem/ui/FibsemDetectionUI.py,sha256=-ZemXjKocLbxOCOzEME8KLOe2bFf7Il3VbnihFkHRkg,8935
 fibsem/ui/FibsemDetectionWidget.py,sha256=bZupoZaIlulswAqIPvLDbN0CYR6Tj9ddihEl_uCNgf8,18869
-fibsem/ui/FibsemEmbeddedDetectionWidget.py,sha256=ycM37wEGWjcrclsb-LzJf9N-RWP-oKsrc56CSQX0JKU,9723
+fibsem/ui/FibsemEmbeddedDetectionWidget.py,sha256=ogcs6B_PJEWj8m9DbmC_BBPvSDSqpnaqL9nw0OxB920,9019
 fibsem/ui/FibsemGISWidget.py,sha256=NkVG5Ydf_djio2i3WPLW02kG7NGkrxf8FqbiaVny_PA,11085
-fibsem/ui/FibsemImageSettingsWidget.py,sha256=7D7PHgK-eziOvkX2oVsSHTLA6ox1gaJGEcK3aq-7fyA,22194
+fibsem/ui/FibsemImageSettingsWidget.py,sha256=th5bHqZ1cCECBsdL7BCSo3P_PUdHbSA77hULuxOQ4Ew,22379
 fibsem/ui/FibsemLabellingUI.py,sha256=ruq4Z_0Ed1J0zlaIftfnzif7MsZ3BAT4Zq2LRswN6D4,16723
-fibsem/ui/FibsemManipulatorWidget.py,sha256=sty0mjkes_q0iQo_zdHJfHduNFzhpwaYmzmaAZBa46Q,12661
-fibsem/ui/FibsemMillingWidget.py,sha256=B7iFpvtBZ2epq0d8tplyCK7WCr7ixc2Ery-6cQNBhOg,27469
+fibsem/ui/FibsemManipulatorWidget.py,sha256=UPGA7KTjZCfWj3uQGPhot7eIx8_4auQeh1u-b9Yzv-Y,10012
+fibsem/ui/FibsemMillingWidget.py,sha256=mlxLmQS6rSJdo0HEbwovoj8GznwjSGUFL1e9PB7Yw-g,30352
+fibsem/ui/FibsemMinimapWidget.py,sha256=K-aJD-h4smi8XI51ZJ-rhueBQq0yux6eJaikiFp3tCk,18658
 fibsem/ui/FibsemModelTrainingWidget.py,sha256=7B2SfeYV3Zw2UHatBMTXWkwVdZgS4-clnm8KJWnd1Wg,6498
-fibsem/ui/FibsemMovementWidget.py,sha256=8kJF3xXoimmWBpnaQYUOyrkjbUUrlR3vf86hmJ3z3Cg,12456
+fibsem/ui/FibsemMovementWidget.py,sha256=PLGlXJqh7szvoMrYGu4HdCWL5gShMcfHT7HyEi-hEkE,12941
 fibsem/ui/FibsemMultiChemWidget.py,sha256=9rV0A2AngjXk79CY5G1VYqhEIf5NOJKz2vUmS8vPEIE,2966
-fibsem/ui/FibsemPositionsWidget.py,sha256=jJZxqYymd3AoZvh6KNoFtuP-q0A3TZr7MlsQPeek730,6687
+fibsem/ui/FibsemPositionsWidget.py,sha256=4hfs8HUWG3B9sB2WPHE-tvvxNSUVStrEZK11FkBrLzA,6655
 fibsem/ui/FibsemSegmentationModelWidget.py,sha256=8ThfsWctcG9AD1_nHsAWXqZDRJkpxOBynFEqlCtb0BA,4740
-fibsem/ui/FibsemSystemSetupWidget.py,sha256=8NO_QfA0_QvfKaDNJ3tait-m6Ukrh1us00W0x4BRct8,16538
-fibsem/ui/FibsemUI.py,sha256=NWSpb_-IU3Ku-Izyluxb6vNLDY0353uevo2Lmi2o_1o,7354
+fibsem/ui/FibsemSystemSetupWidget.py,sha256=4nbzryAgYlXc3Oj90jdXYZ_sWI-zrqyFZ4tIjHzqn80,22184
+fibsem/ui/FibsemUI.py,sha256=RxbDlFXLUZDJ_0mqd4Oec7ekt5BoLaxMcrn-34lHMOU,12402
 fibsem/ui/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
-fibsem/ui/utils.py,sha256=jdTHnjN_Bn2eGYi8zcONcYLU7Q1XI4IaDpm36YDOD1o,23860
+fibsem/ui/utils.py,sha256=la7_dE8FxtTRAoGcS7Vp2u6qjjsGqPpSBVf_BNe3IzQ,24590
 fibsem/ui/windows.py,sha256=GqWCt5Ve1IFMee3tq-Omb1X8NLNi8mZP2R5uiSI1HSI,5557
 fibsem/ui/qtdesigner_files/CurrentAlignmentWidget.py,sha256=zxqLjjMUNf1gRA6WkBQW6JvnxcuiiDfHKV0994Y5frg,3662
 fibsem/ui/qtdesigner_files/CurrentAlignmentWidget.ui,sha256=ZJi1FT_YJ2goS6yW8FVvF6hq6Rkovz7QIELmQ6CFH-w,2754
+fibsem/ui/qtdesigner_files/FibsemCryoSputterWidget.py,sha256=Izy-ZY4PfaynUvMRsc_QDGpFyBhZUFtfNp-XiwmkE1s,6533
+fibsem/ui/qtdesigner_files/FibsemCryoSputterWidget.ui,sha256=B8UtEcxfprff7CiMH0ccgdhxN-wGeaC26y30IFdP8dI,4445
 fibsem/ui/qtdesigner_files/FibsemDetectionWidget.py,sha256=e6dVjTNSJk7mwlio7Dzhlv-YCJIrDnaE4eMwG99h3xI,9828
 fibsem/ui/qtdesigner_files/FibsemDetectionWidget.ui,sha256=SQmxLiGoxnBg1B02dVSzy8i5mmFbqALfGZiDGVDrxqQ,7395
 fibsem/ui/qtdesigner_files/FibsemEmbeddedDetectionWidget.py,sha256=Wz864BlhIdgIi2BexKrt_EJCTzGkDzBBx5bCQz3GRgQ,2456
 fibsem/ui/qtdesigner_files/FibsemEmbeddedDetectionWidget.ui,sha256=yl6e06uXGBujm9SK-18nwU-qs0EGp9iMMZauysq2xr4,2059
 fibsem/ui/qtdesigner_files/FibsemGISWidget.py,sha256=hzJ42uHqFisz9YLpQlU5bV0kJSBDfGbSBVQz5sC_W5U,6894
 fibsem/ui/qtdesigner_files/FibsemGISWidget.ui,sha256=XeLOEM04BykKw6mHXfDcYUZ_nbwmkbJR474SWmAj3Ic,4994
 fibsem/ui/qtdesigner_files/FibsemLabellingUI.py,sha256=5mIzR2Sp2wO7eq2duiO-eEzPKVTqRjGI3ksT8CNuHMA,7609
 fibsem/ui/qtdesigner_files/FibsemLabellingUI.ui,sha256=qkkCqgRfCMXV1kKruz_5DgX4ixTAeriDvac8NyfBAfM,6324
 fibsem/ui/qtdesigner_files/FibsemManipulatorWidget.py,sha256=X6nRzw1NAeFUEB92IpLJjBU5F8Cb08MV3Pw-fM7ksms,6614
 fibsem/ui/qtdesigner_files/FibsemManipulatorWidget.ui,sha256=yvbp6PQiwQVQckeeoLLRRhGadwRcK-Zhd6Tw6jIXep0,5199
-fibsem/ui/qtdesigner_files/FibsemMillingWidget.py,sha256=FepXDa-z4lBEE427PsEz-1Qq-Hh_3Z-uZh6OAxBv964,12839
-fibsem/ui/qtdesigner_files/FibsemMillingWidgetui.ui,sha256=megEahBWui8NnQ1nswwZb7OkFTKwCT2FyMdHm9OO3N8,10675
+fibsem/ui/qtdesigner_files/FibsemMillingWidget.py,sha256=gwD_CEWHakLg2nZPxRdruFuJN1vLfRg29lwhr0OP8CA,13038
+fibsem/ui/qtdesigner_files/FibsemMillingWidget.ui,sha256=DVAnNeLEOVcxYrThthK8v03eit_yHG5YklYMygXIMWg,11041
+fibsem/ui/qtdesigner_files/FibsemMillingWidgetui.ui,sha256=5ar-yqwy1tejz5d3uMrKhsVpVvsD7CfYCO1yTWj9T1Q,11723
+fibsem/ui/qtdesigner_files/FibsemMinimapWidget.py,sha256=iHNhyxEbsSzr_LMmQa2FHIkgF1f50vXK-r1NNSxHiZ0,17053
+fibsem/ui/qtdesigner_files/FibsemMinimapWidget.ui,sha256=ipcsnP6kTTTTKR-2NCgHMKjb6_Xd_XRJQ-pN2mxN7WY,13488
 fibsem/ui/qtdesigner_files/FibsemModelTrainingWidge.ui,sha256=K0FbXtE6DxBf6jVuHCXCmUBYEoG5q8fI9xjSpoOxbzM,2735
 fibsem/ui/qtdesigner_files/FibsemModelTrainingWidget.py,sha256=ePQWb4HK1x4ePZ-nYui2nXhKsBEtkMBSemHYWaPexds,10117
 fibsem/ui/qtdesigner_files/FibsemModelTrainingWidget.ui,sha256=KmogSw9aqp4nsjY2YcZwGaKoZVFNQ_lyTUsdtk4giyk,7724
-fibsem/ui/qtdesigner_files/FibsemMovementWidget.py,sha256=DGU9BHSlO7iL-fUAV9XNER1_-LWI22J-tFYyShvl29I,14652
-fibsem/ui/qtdesigner_files/FibsemMovementWidget.ui,sha256=8_1ZUWY5BMqzXUj_Gn2aTwFvZZgA4AR6SKGfqvoT9rw,11959
+fibsem/ui/qtdesigner_files/FibsemMovementWidget.py,sha256=E0uVrvzHWN9PkrEz9zDfLcD6QpUniR6TzAX_HYNCHG8,14356
+fibsem/ui/qtdesigner_files/FibsemMovementWidget.ui,sha256=xAEyUc7VU8w3BKHa0G_fVfOYnz5Za51kenEGqYBv1PY,11562
 fibsem/ui/qtdesigner_files/FibsemMultiChemWidget.py,sha256=F0l9h-rbdLs4dyb3Vihll9T7DZb1QP73PKV-Et3Cgrc,4643
 fibsem/ui/qtdesigner_files/FibsemMultiChemWidget.ui,sha256=3ezdy_UzhLYcEE9VSwVaFdpWEM12NVgg5z_SZpoa-Q8,3106
 fibsem/ui/qtdesigner_files/FibsemPositionsWidget.py,sha256=vva07MobpUwZIVm9-S4xhKFvfxw86Zp9nwCBCrNEKWM,4112
 fibsem/ui/qtdesigner_files/FibsemPositionsWidget.ui,sha256=R_sr6IL0hzsFFvnCNeRUAAAJamKj93t6VoEBqBrqZLY,2864
 fibsem/ui/qtdesigner_files/FibsemSegmentationModelWidget.py,sha256=cYM-638gbimhBZhxy3N25cLO-jPLjITqSGUvwdFwPeg,3786
 fibsem/ui/qtdesigner_files/FibsemSegmentationModelWidget.ui,sha256=uoNcrRsYKb0f_76OjK01h_eHrhQN9bzW0Pr9s14r3Oc,2607
 fibsem/ui/qtdesigner_files/FibsemSettingUI.py,sha256=hFsNNu0FnAjZZZ24hC1aSkvt32hnv2OcrrgqJveBv4c,19849
 fibsem/ui/qtdesigner_files/FibsemSettings.py,sha256=-2_QI8quU_sSEh6mKOw1YqOfm4FPMjd25a0IKDnLZX4,20812
 fibsem/ui/qtdesigner_files/FibsemSettingsUI.ui,sha256=GrPW53o_4bD0-Z4FOq35bZxsvLbvvx248zNuMWkMK6g,14089
-fibsem/ui/qtdesigner_files/FibsemSystemSetupWidget.py,sha256=idCCP_UT7CnjII6YrEAd1rcJmwJJ-siFHxD_04dKsMU,36924
-fibsem/ui/qtdesigner_files/FibsemSystemSetupWidget.ui,sha256=mKuL0V3DwGAwLPRvJEvVO-y5Gx-PX6FbSPKtlbt2IQQ,35560
-fibsem/ui/qtdesigner_files/FibsemUI.py,sha256=Ckbon3f7QDw7BTO1zVu4AHC0S3_c0BKy5d9Pyv7mBZg,3278
-fibsem/ui/qtdesigner_files/FibsemUI.ui,sha256=03QfSAP-S68QVHJi36rNXpqvoSmty-1fiFq6b0qUOak,2449
-fibsem/ui/qtdesigner_files/ImageSettingsWidget.py,sha256=iZ-3NV15XEKALAiQ-zLBoWoto1qoRb-mgYsZM_zxlQo,15548
-fibsem/ui/qtdesigner_files/ImageSettingsWidget.ui,sha256=Nx4E82zQRftlMvHGSkDg9T2SkQ_0yOrcM13xDJCN01s,12405
+fibsem/ui/qtdesigner_files/FibsemSystemSetupWidget.py,sha256=jFmCuKaykWTAzmrzH1bauAEpJxqUEKKujxHxKB-efdQ,34942
+fibsem/ui/qtdesigner_files/FibsemSystemSetupWidget.ui,sha256=DigPxkxCncqF3ytUGzD6U2-RTshIrZ-3dAWVWt7SdOU,33243
+fibsem/ui/qtdesigner_files/FibsemUI.py,sha256=rgqL4bS-Eco565Uxa0JLBNgIQQZBB83oa_-7J2LrARw,3735
+fibsem/ui/qtdesigner_files/FibsemUI.ui,sha256=FiA_QJDt6vGMzdjnBe979NEULY1bywy22CU5Q8snNzw,2726
+fibsem/ui/qtdesigner_files/ImageSettingsWidget.py,sha256=KnJm4hyaJsiXOD4JOsN1he6WVyJ1ous7GIrQyNwXo2g,15602
+fibsem/ui/qtdesigner_files/ImageSettingsWidget.ui,sha256=mmWbOM-WgfPQsHbEuydzu36tG2dt7N9Iyi2-lpaKOJQ,12482
 fibsem/ui/qtdesigner_files/detection_dialog.py,sha256=RY_icuVTKkeEFzK2BwaDN6fJZ3rq_g3nJ6BCWYWzWbQ,5162
 fibsem/ui/qtdesigner_files/detection_dialog.ui,sha256=QS_ILLoAxhk7TWBhc5tzztq-b7Fyau8gnaJ4u694KGM,5386
 fibsem/ui/qtdesigner_files/needle_popup.py,sha256=0u910hPO3ZL7mJuq6d-DU1QgYOcaffHWWyUGdFelxRU,1059
 fibsem/ui/qtdesigner_files/needle_popup.ui,sha256=DiVaiBbjYpGs36j7SguRYBOZJqpt21A6OMJHkAaPTRM,615
 fibsem/ui/qtdesigner_files/user_dialog.py,sha256=-rl1CN3frBQFMPKvgueepFYXk9wAR3qhprMkQDKCvs8,2058
 fibsem/ui/qtdesigner_files/user_dialog.ui,sha256=5iIRe5VAojv9bOs0C-v_RB5IpBP4pB6AGII2aRaqYfY,2173
-fibsem-0.2.1a1.dist-info/LICENSE,sha256=0fesuamjslN-bg6wme-6y_lRUX3i-uLOHpjAf-eWWeQ,1067
-fibsem-0.2.1a1.dist-info/METADATA,sha256=vQdze84qwj90jqMl6pn9PmJl8WOPkJudwYYJ-zf_cKA,8537
-fibsem-0.2.1a1.dist-info/WHEEL,sha256=pkctZYzUS4AYVn6dJ-7367OJZivF2e8RA9b_ZBjif18,92
-fibsem-0.2.1a1.dist-info/entry_points.txt,sha256=FXqvgIpgWOZnIQl68B6q-5iod0RebQYhsL1OqGbdwHI,156
-fibsem-0.2.1a1.dist-info/top_level.txt,sha256=mxe-wwMvRmjcDcTxFRvZxgEFqqwIJUrd6OtmtWACN2g,7
-fibsem-0.2.1a1.dist-info/RECORD,,
+fibsem-0.2.2a0.dist-info/LICENSE,sha256=0fesuamjslN-bg6wme-6y_lRUX3i-uLOHpjAf-eWWeQ,1067
+fibsem-0.2.2a0.dist-info/METADATA,sha256=_idFvv8xdkOjK59fDkGSals0eU47bQNubmid4Hy3DK0,8537
+fibsem-0.2.2a0.dist-info/WHEEL,sha256=AtBG6SXL3KF_v0NxLf0ehyVOh0cold-JbJYXNGorC6Q,92
+fibsem-0.2.2a0.dist-info/entry_points.txt,sha256=FXqvgIpgWOZnIQl68B6q-5iod0RebQYhsL1OqGbdwHI,156
+fibsem-0.2.2a0.dist-info/top_level.txt,sha256=mxe-wwMvRmjcDcTxFRvZxgEFqqwIJUrd6OtmtWACN2g,7
+fibsem-0.2.2a0.dist-info/RECORD,,
```

